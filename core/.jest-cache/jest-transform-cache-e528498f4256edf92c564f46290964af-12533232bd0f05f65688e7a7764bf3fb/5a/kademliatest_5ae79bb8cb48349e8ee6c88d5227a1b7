0adba578ab8f062ef454a870732dbd69
"use strict";
/**
 * Kademlia Routing Table Tests
 */
Object.defineProperty(exports, "__esModule", { value: true });
const kademlia_1 = require("./kademlia");
const node_id_1 = require("./node-id");
describe('KademliaRoutingTable', () => {
    let routingTable;
    let localNodeId;
    beforeEach(() => {
        localNodeId = (0, node_id_1.generateNodeId)();
        routingTable = new kademlia_1.KademliaRoutingTable(localNodeId, {
            k: 20,
            alpha: 3,
            pingTimeout: 1000,
        });
    });
    afterEach(() => {
        routingTable.stop();
    });
    function createContact(nodeId) {
        const id = nodeId || (0, node_id_1.generateNodeId)();
        return {
            nodeId: id,
            peerId: (0, node_id_1.nodeIdToHex)(id),
            lastSeen: Date.now(),
            failureCount: 0,
        };
    }
    describe('Contact Management', () => {
        it('should add contacts', () => {
            const contact = createContact();
            const result = routingTable.addContact(contact);
            expect(result.added).toBe(true);
            expect(routingTable.getContact(contact.nodeId)).toBeDefined();
        });
        it('should not add self', () => {
            const selfContact = createContact(localNodeId);
            const result = routingTable.addContact(selfContact);
            expect(result.added).toBe(false);
        });
        it('should remove contacts', () => {
            const contact = createContact();
            routingTable.addContact(contact);
            const removed = routingTable.removeContact(contact.nodeId);
            expect(removed).toBe(true);
            expect(routingTable.getContact(contact.nodeId)).toBeUndefined();
        });
        it('should get closest contacts', () => {
            // Add several contacts
            for (let i = 0; i < 10; i++) {
                routingTable.addContact(createContact());
            }
            const target = (0, node_id_1.generateNodeId)();
            const closest = routingTable.getClosestContacts(target, 5);
            expect(closest.length).toBeLessThanOrEqual(5);
        });
        it('should get all contacts', () => {
            const contacts = [createContact(), createContact(), createContact()];
            contacts.forEach(c => routingTable.addContact(c));
            const all = routingTable.getAllContacts();
            expect(all.length).toBe(3);
        });
    });
    describe('Local Storage', () => {
        it('should store values locally', () => {
            const key = (0, node_id_1.generateDHTKey)('test-key');
            const value = {
                data: new Uint8Array([1, 2, 3]),
                storedAt: Date.now(),
                ttl: 3600000,
                publisherId: localNodeId,
            };
            routingTable.storeLocal(key, value);
            const retrieved = routingTable.getLocal(key);
            expect(retrieved).toBeDefined();
            expect(retrieved.data).toEqual(value.data);
        });
        it('should return undefined for non-existent keys', () => {
            const key = (0, node_id_1.generateDHTKey)('non-existent');
            expect(routingTable.getLocal(key)).toBeUndefined();
        });
    });
    describe('Request Handlers', () => {
        describe('handleFindNode', () => {
            it('should return closest nodes', () => {
                // Add some contacts
                for (let i = 0; i < 5; i++) {
                    routingTable.addContact(createContact());
                }
                const targetId = (0, node_id_1.generateNodeId)();
                const request = {
                    type: 'FIND_NODE',
                    senderId: (0, node_id_1.generateNodeId)(),
                    messageId: 'test-1',
                    timestamp: Date.now(),
                    targetId,
                };
                const response = routingTable.handleFindNode(request);
                expect(response.type).toBe('FIND_NODE_RESPONSE');
                expect(response.messageId).toBe('test-1');
                expect(Array.isArray(response.nodes)).toBe(true);
            });
            it('should update sender contact info', () => {
                const senderId = (0, node_id_1.generateNodeId)();
                const request = {
                    type: 'FIND_NODE',
                    senderId,
                    messageId: 'test-1',
                    timestamp: Date.now(),
                    targetId: (0, node_id_1.generateNodeId)(),
                };
                routingTable.handleFindNode(request);
                const contact = routingTable.getContact(senderId);
                expect(contact).toBeDefined();
            });
        });
        describe('handleFindValue', () => {
            it('should return value if found', () => {
                const key = (0, node_id_1.generateDHTKey)('test-key');
                const value = {
                    data: new Uint8Array([1, 2, 3]),
                    storedAt: Date.now(),
                    ttl: 3600000,
                    publisherId: localNodeId,
                };
                routingTable.storeLocal(key, value);
                const request = {
                    type: 'FIND_VALUE',
                    senderId: (0, node_id_1.generateNodeId)(),
                    messageId: 'test-1',
                    timestamp: Date.now(),
                    key,
                };
                const response = routingTable.handleFindValue(request);
                expect(response.type).toBe('FIND_VALUE_RESPONSE');
                expect(response.value.data).toEqual(value.data);
            });
            it('should return nodes if value not found', () => {
                // Add some contacts
                routingTable.addContact(createContact());
                const request = {
                    type: 'FIND_VALUE',
                    senderId: (0, node_id_1.generateNodeId)(),
                    messageId: 'test-1',
                    timestamp: Date.now(),
                    key: (0, node_id_1.generateDHTKey)('non-existent'),
                };
                const response = routingTable.handleFindValue(request);
                expect(response.type).toBe('FIND_VALUE_NODES');
                expect(response.nodes).toBeDefined();
            });
        });
        describe('handleStore', () => {
            it('should store value and return success', () => {
                const key = (0, node_id_1.generateDHTKey)('test-key');
                const value = {
                    data: new Uint8Array([1, 2, 3]),
                    storedAt: Date.now(),
                    ttl: 3600000,
                    publisherId: (0, node_id_1.generateNodeId)(),
                };
                const request = {
                    type: 'STORE',
                    senderId: (0, node_id_1.generateNodeId)(),
                    messageId: 'test-1',
                    timestamp: Date.now(),
                    key,
                    value,
                };
                const response = routingTable.handleStore(request);
                expect(response.type).toBe('STORE_RESPONSE');
                expect(response.success).toBe(true);
                // Verify stored
                const stored = routingTable.getLocal(key);
                expect(stored).toBeDefined();
            });
        });
        describe('handlePing', () => {
            it('should return pong', () => {
                const request = {
                    type: 'PING',
                    senderId: (0, node_id_1.generateNodeId)(),
                    messageId: 'test-1',
                    timestamp: Date.now(),
                };
                const response = routingTable.handlePing(request);
                expect(response.type).toBe('PONG');
                expect(response.messageId).toBe('test-1');
            });
        });
    });
    describe('Statistics', () => {
        it('should return correct stats', () => {
            // Add contacts
            for (let i = 0; i < 5; i++) {
                routingTable.addContact(createContact());
            }
            // Store value
            const key = (0, node_id_1.generateDHTKey)('test');
            routingTable.storeLocal(key, {
                data: new Uint8Array([1]),
                storedAt: Date.now(),
                ttl: 3600000,
                publisherId: localNodeId,
            });
            const stats = routingTable.getStats();
            expect(stats.nodeCount).toBe(5);
            expect(stats.valueCount).toBe(1);
            expect(stats.activeBuckets).toBeGreaterThan(0);
            expect(stats.memoryUsage).toBeGreaterThan(0);
        });
    });
    describe('Clear', () => {
        it('should clear all data', () => {
            // Add data
            routingTable.addContact(createContact());
            routingTable.storeLocal((0, node_id_1.generateDHTKey)('test'), {
                data: new Uint8Array([1]),
                storedAt: Date.now(),
                ttl: 3600000,
                publisherId: localNodeId,
            });
            routingTable.clear();
            const stats = routingTable.getStats();
            expect(stats.nodeCount).toBe(0);
            expect(stats.valueCount).toBe(0);
        });
    });
    describe('Bucket Distribution', () => {
        it('should return bucket distribution', () => {
            // Add contacts
            for (let i = 0; i < 10; i++) {
                routingTable.addContact(createContact());
            }
            const distribution = routingTable.getBucketDistribution();
            expect(distribution.length).toBe(160);
            expect(distribution.reduce((a, b) => a + b, 0)).toBe(10);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvbWVzaC9kaHQva2FkZW1saWEudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgseUNBQWtEO0FBRWxELHVDQUF3RTtBQUV4RSxRQUFRLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFO0lBQ3BDLElBQUksWUFBa0MsQ0FBQztJQUN2QyxJQUFJLFdBQXVCLENBQUM7SUFFNUIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLFdBQVcsR0FBRyxJQUFBLHdCQUFjLEdBQUUsQ0FBQztRQUMvQixZQUFZLEdBQUcsSUFBSSwrQkFBb0IsQ0FBQyxXQUFXLEVBQUU7WUFDbkQsQ0FBQyxFQUFFLEVBQUU7WUFDTCxLQUFLLEVBQUUsQ0FBQztZQUNSLFdBQVcsRUFBRSxJQUFJO1NBQ2xCLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN0QixDQUFDLENBQUMsQ0FBQztJQUVILFNBQVMsYUFBYSxDQUFDLE1BQW1CO1FBQ3hDLE1BQU0sRUFBRSxHQUFHLE1BQU0sSUFBSSxJQUFBLHdCQUFjLEdBQUUsQ0FBQztRQUN0QyxPQUFPO1lBQ0wsTUFBTSxFQUFFLEVBQUU7WUFDVixNQUFNLEVBQUUsSUFBQSxxQkFBVyxFQUFDLEVBQUUsQ0FBQztZQUN2QixRQUFRLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNwQixZQUFZLEVBQUUsQ0FBQztTQUNoQixDQUFDO0lBQ0osQ0FBQztJQUVELFFBQVEsQ0FBQyxvQkFBb0IsRUFBRSxHQUFHLEVBQUU7UUFDbEMsRUFBRSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtZQUM3QixNQUFNLE9BQU8sR0FBRyxhQUFhLEVBQUUsQ0FBQztZQUNoQyxNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFD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TUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3RDLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25DLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO1FBQ25DLEVBQUUsQ0FBQyxtQ0FBbUMsRUFBRSxHQUFHLEVBQUU7WUFDM0MsZUFBZTtZQUNmLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDNUIsWUFBWSxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDO1lBQzNDLENBQUM7WUFFRCxNQUFNLFlBQVksR0FBRyxZQUFZLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUUxRCxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDM0QsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jaHJpc3R5bWF4d2VsbC9EZXNrdG9wL0x1a2VfU3R1ZmYvR2l0SHViL1NDL2NvcmUvc3JjL21lc2gvZGh0L2thZGVtbGlhLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBLYWRlbWxpYSBSb3V0aW5nIFRhYmxlIFRlc3RzXG4gKi9cblxuaW1wb3J0IHsgS2FkZW1saWFSb3V0aW5nVGFibGUgfSBmcm9tICcuL2thZGVtbGlhJztcbmltcG9ydCB0eXBlIHsgREhUQ29udGFjdCwgREhUVmFsdWUsIEZpbmROb2RlUmVxdWVzdCwgUGluZ1JlcXVlc3QsIFN0b3JlUmVxdWVzdCwgRmluZFZhbHVlUmVxdWVzdCwgREhUTWVzc2FnZVR5cGUgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IGdlbmVyYXRlTm9kZUlkLCBub2RlSWRUb0hleCwgZ2VuZXJhdGVESFRLZXkgfSBmcm9tICcuL25vZGUtaWQnO1xuXG5kZXNjcmliZSgnS2FkZW1saWFSb3V0aW5nVGFibGUnLCAoKSA9PiB7XG4gIGxldCByb3V0aW5nVGFibGU6IEthZGVtbGlhUm91dGluZ1RhYmxlO1xuICBsZXQgbG9jYWxOb2RlSWQ6IFVpbnQ4QXJyYXk7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbG9jYWxOb2RlSWQgPSBnZW5lcmF0ZU5vZGVJZCgpO1xuICAgIHJvdXRpbmdUYWJsZSA9IG5ldyBLYWRlbWxpYVJvdXRpbmdUYWJsZShsb2NhbE5vZGVJZCwge1xuICAgICAgazogMjAsXG4gICAgICBhbHBoYTogMyxcbiAgICAgIHBpbmdUaW1lb3V0OiAxMDAwLFxuICAgIH0pO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIHJvdXRpbmdUYWJsZS5zdG9wKCk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIGNyZWF0ZUNvbnRhY3Qobm9kZUlkPzogVWludDhBcnJheSk6IERIVENvbnRhY3Qge1xuICAgIGNvbnN0IGlkID0gbm9kZUlkIHx8IGdlbmVyYXRlTm9kZUlkKCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5vZGVJZDogaWQsXG4gICAgICBwZWVySWQ6IG5vZGVJZFRvSGV4KGlkKSxcbiAgICAgIGxhc3RTZWVuOiBEYXRlLm5vdygpLFxuICAgICAgZmFpbHVyZUNvdW50OiAwLFxuICAgIH07XG4gIH1cblxuICBkZXNjcmliZSgnQ29udGFjdCBNYW5hZ2VtZW50JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYWRkIGNvbnRhY3RzJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29udGFjdCA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHJvdXRpbmdUYWJsZS5hZGRDb250YWN0KGNvbnRhY3QpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmFkZGVkKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJvdXRpbmdUYWJsZS5nZXRDb250YWN0KGNvbnRhY3Qubm9kZUlkKSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbm90IGFkZCBzZWxmJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VsZkNvbnRhY3QgPSBjcmVhdGVDb250YWN0KGxvY2FsTm9kZUlkKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHJvdXRpbmdUYWJsZS5hZGRDb250YWN0KHNlbGZDb250YWN0KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5hZGRlZCkudG9CZShmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlbW92ZSBjb250YWN0cycsICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbnRhY3QgPSBjcmVhdGVDb250YWN0KCk7XG4gICAgICByb3V0aW5nVGFibGUuYWRkQ29udGFjdChjb250YWN0KTtcblxuICAgICAgY29uc3QgcmVtb3ZlZCA9IHJvdXRpbmdUYWJsZS5yZW1vdmVDb250YWN0KGNvbnRhY3Qubm9kZUlkKTtcbiAgICAgIGV4cGVjdChyZW1vdmVkKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJvdXRpbmdUYWJsZS5nZXRDb250YWN0KGNvbnRhY3Qubm9kZUlkKSkudG9CZVVuZGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBnZXQgY2xvc2VzdCBjb250YWN0cycsICgpID0+IHtcbiAgICAgIC8vIEFkZCBzZXZlcmFsIGNvbnRhY3RzXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwOyBpKyspIHtcbiAgICAgICAgcm91dGluZ1RhYmxlLmFkZENvbnRhY3QoY3JlYXRlQ29udGFjdCgpKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdGFyZ2V0ID0gZ2VuZXJhdGVOb2RlSWQoKTtcbiAgICAgIGNvbnN0IGNsb3Nlc3QgPSByb3V0aW5nVGFibGUuZ2V0Q2xvc2VzdENvbnRhY3RzKHRhcmdldCwgNSk7XG5cbiAgICAgIGV4cGVjdChjbG9zZXN0Lmxlbmd0aCkudG9CZUxlc3NUaGFuT3JFcXVhbCg1KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZ2V0IGFsbCBjb250YWN0cycsICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbnRhY3RzID0gW2NyZWF0ZUNvbnRhY3QoKSwgY3JlYXRlQ29udGFjdCgpLCBjcmVhdGVDb250YWN0KCldO1xuICAgICAgY29udGFjdHMuZm9yRWFjaChjID0+IHJvdXRpbmdUYWJsZS5hZGRDb250YWN0KGMpKTtcblxuICAgICAgY29uc3QgYWxsID0gcm91dGluZ1RhYmxlLmdldEFsbENvbnRhY3RzKCk7XG4gICAgICBleHBlY3QoYWxsLmxlbmd0aCkudG9CZSgzKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0xvY2FsIFN0b3JhZ2UnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzdG9yZSB2YWx1ZXMgbG9jYWxseScsICgpID0+IHtcbiAgICAgIGNvbnN0IGtleSA9IGdlbmVyYXRlREhUS2V5KCd0ZXN0LWtleScpO1xuICAgICAgY29uc3QgdmFsdWU6IERIVFZhbHVlID0ge1xuICAgICAgICBkYXRhOiBuZXcgVWludDhBcnJheShbMSwgMiwgM10pLFxuICAgICAgICBzdG9yZWRBdDogRGF0ZS5ub3coKSxcbiAgICAgICAgdHRsOiAzNjAwMDAwLFxuICAgICAgICBwdWJsaXNoZXJJZDogbG9jYWxOb2RlSWQsXG4gICAgICB9O1xuXG4gICAgICByb3V0aW5nVGFibGUuc3RvcmVMb2NhbChrZXksIHZhbHVlKTtcbiAgICAgIGNvbnN0IHJldHJpZXZlZCA9IHJvdXRpbmdUYWJsZS5nZXRMb2NhbChrZXkpO1xuXG4gICAgICBleHBlY3QocmV0cmlldmVkKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHJldHJpZXZlZCEuZGF0YSkudG9FcXVhbCh2YWx1ZS5kYXRhKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHVuZGVmaW5lZCBmb3Igbm9uLWV4aXN0ZW50IGtleXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBnZW5lcmF0ZURIVEtleSgnbm9uLWV4aXN0ZW50Jyk7XG4gICAgICBleHBlY3Qocm91dGluZ1RhYmxlLmdldExvY2FsKGtleSkpLnRvQmVVbmRlZmluZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1JlcXVlc3QgSGFuZGxlcnMnLCAoKSA9PiB7XG4gICAgZGVzY3JpYmUoJ2hhbmRsZUZpbmROb2RlJywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gY2xvc2VzdCBub2RlcycsICgpID0+IHtcbiAgICAgICAgLy8gQWRkIHNvbWUgY29udGFjdHNcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHtcbiAgICAgICAgICByb3V0aW5nVGFibGUuYWRkQ29udGFjdChjcmVhdGVDb250YWN0KCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdGFyZ2V0SWQgPSBnZW5lcmF0ZU5vZGVJZCgpO1xuICAgICAgICBjb25zdCByZXF1ZXN0OiBGaW5kTm9kZVJlcXVlc3QgPSB7XG4gICAgICAgICAgdHlwZTogJ0ZJTkRfTk9ERScgYXMgREhUTWVzc2FnZVR5cGUuRklORF9OT0RFLFxuICAgICAgICAgIHNlbmRlcklkOiBnZW5lcmF0ZU5vZGVJZCgpLFxuICAgICAgICAgIG1lc3NhZ2VJZDogJ3Rlc3QtMScsXG4gICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICAgIHRhcmdldElkLFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gcm91dGluZ1RhYmxlLmhhbmRsZUZpbmROb2RlKHJlcXVlc3QpO1xuXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS50eXBlKS50b0JlKCdGSU5EX05PREVfUkVTUE9OU0UnKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLm1lc3NhZ2VJZCkudG9CZSgndGVzdC0xJyk7XG4gICAgICAgIGV4cGVjdChBcnJheS5pc0FycmF5KHJlc3BvbnNlLm5vZGVzKSkudG9CZSh0cnVlKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdCgnc2hvdWxkIHVwZGF0ZSBzZW5kZXIgY29udGFjdCBpbmZvJywgKCkgPT4ge1xuICAgICAgICBjb25zdCBzZW5kZXJJZCA9IGdlbmVyYXRlTm9kZUlkKCk7XG4gICAgICAgIGNvbnN0IHJlcXVlc3Q6IEZpbmROb2RlUmVxdWVzdCA9IHtcbiAgICAgICAgICB0eXBlOiAnRklORF9OT0RFJyBhcyBESFRNZXNzYWdlVHlwZS5GSU5EX05PREUsXG4gICAgICAgICAgc2VuZGVySWQsXG4gICAgICAgICAgbWVzc2FnZUlkOiAndGVzdC0xJyxcbiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgdGFyZ2V0SWQ6IGdlbmVyYXRlTm9kZUlkKCksXG4gICAgICAgIH07XG5cbiAgICAgICAgcm91dGluZ1RhYmxlLmhhbmRsZUZpbmROb2RlKHJlcXVlc3QpO1xuXG4gICAgICAgIGNvbnN0IGNvbnRhY3QgPSByb3V0aW5nVGFibGUuZ2V0Q29udGFjdChzZW5kZXJJZCk7XG4gICAgICAgIGV4cGVjdChjb250YWN0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnaGFuZGxlRmluZFZhbHVlJywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gdmFsdWUgaWYgZm91bmQnLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGtleSA9IGdlbmVyYXRlREhUS2V5KCd0ZXN0LWtleScpO1xuICAgICAgICBjb25zdCB2YWx1ZTogREhUVmFsdWUgPSB7XG4gICAgICAgICAgZGF0YTogbmV3IFVpbnQ4QXJyYXkoWzEsIDIsIDNdKSxcbiAgICAgICAgICBzdG9yZWRBdDogRGF0ZS5ub3coKSxcbiAgICAgICAgICB0dGw6IDM2MDAwMDAsXG4gICAgICAgICAgcHVibGlzaGVySWQ6IGxvY2FsTm9kZUlkLFxuICAgICAgICB9O1xuICAgICAgICByb3V0aW5nVGFibGUuc3RvcmVMb2NhbChrZXksIHZhbHVlKTtcblxuICAgICAgICBjb25zdCByZXF1ZXN0OiBGaW5kVmFsdWVSZXF1ZXN0ID0ge1xuICAgICAgICAgIHR5cGU6ICdGSU5EX1ZBTFVFJyBhcyBESFRNZXNzYWdlVHlwZS5GSU5EX1ZBTFVFLFxuICAgICAgICAgIHNlbmRlcklkOiBnZW5lcmF0ZU5vZGVJZCgpLFxuICAgICAgICAgIG1lc3NhZ2VJZDogJ3Rlc3QtMScsXG4gICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICAgIGtleSxcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IHJvdXRpbmdUYWJsZS5oYW5kbGVGaW5kVmFsdWUocmVxdWVzdCk7XG5cbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnR5cGUpLnRvQmUoJ0ZJTkRfVkFMVUVfUkVTUE9OU0UnKTtcbiAgICAgICAgZXhwZWN0KChyZXNwb25zZSBhcyBhbnkpLnZhbHVlLmRhdGEpLnRvRXF1YWwodmFsdWUuZGF0YSk7XG4gICAgICB9KTtcblxuICAgICAgaXQoJ3Nob3VsZCByZXR1cm4gbm9kZXMgaWYgdmFsdWUgbm90IGZvdW5kJywgKCkgPT4ge1xuICAgICAgICAvLyBBZGQgc29tZSBjb250YWN0c1xuICAgICAgICByb3V0aW5nVGFibGUuYWRkQ29udGFjdChjcmVhdGVDb250YWN0KCkpO1xuXG4gICAgICAgIGNvbnN0IHJlcXVlc3Q6IEZpbmRWYWx1ZVJlcXVlc3QgPSB7XG4gICAgICAgICAgdHlwZTogJ0ZJTkRfVkFMVUUnIGFzIERIVE1lc3NhZ2VUeXBlLkZJTkRfVkFMVUUsXG4gICAgICAgICAgc2VuZGVySWQ6IGdlbmVyYXRlTm9kZUlkKCksXG4gICAgICAgICAgbWVzc2FnZUlkOiAndGVzdC0xJyxcbiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAga2V5OiBnZW5lcmF0ZURIVEtleSgnbm9uLWV4aXN0ZW50JyksXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSByb3V0aW5nVGFibGUuaGFuZGxlRmluZFZhbHVlKHJlcXVlc3QpO1xuXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS50eXBlKS50b0JlKCdGSU5EX1ZBTFVFX05PREVTJyk7XG4gICAgICAgIGV4cGVjdCgocmVzcG9uc2UgYXMgYW55KS5ub2RlcykudG9CZURlZmluZWQoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2hhbmRsZVN0b3JlJywgKCkgPT4ge1xuICAgICAgaXQoJ3Nob3VsZCBzdG9yZSB2YWx1ZSBhbmQgcmV0dXJuIHN1Y2Nlc3MnLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGtleSA9IGdlbmVyYXRlREhUS2V5KCd0ZXN0LWtleScpO1xuICAgICAgICBjb25zdCB2YWx1ZTogREhUVmFsdWUgPSB7XG4gICAgICAgICAgZGF0YTogbmV3IFVpbnQ4QXJyYXkoWzEsIDIsIDNdKSxcbiAgICAgICAgICBzdG9yZWRBdDogRGF0ZS5ub3coKSxcbiAgICAgICAgICB0dGw6IDM2MDAwMDAsXG4gICAgICAgICAgcHVibGlzaGVySWQ6IGdlbmVyYXRlTm9kZUlkKCksXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgcmVxdWVzdDogU3RvcmVSZXF1ZXN0ID0ge1xuICAgICAgICAgIHR5cGU6ICdTVE9SRScgYXMgREhUTWVzc2FnZVR5cGUuU1RPUkUsXG4gICAgICAgICAgc2VuZGVySWQ6IGdlbmVyYXRlTm9kZUlkKCksXG4gICAgICAgICAgbWVzc2FnZUlkOiAndGVzdC0xJyxcbiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAga2V5LFxuICAgICAgICAgIHZhbHVlLFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gcm91dGluZ1RhYmxlLmhhbmRsZVN0b3JlKHJlcXVlc3QpO1xuXG4gICAgICAgIGV4cGVjdChyZXNwb25zZS50eXBlKS50b0JlKCdTVE9SRV9SRVNQT05TRScpO1xuICAgICAgICBleHBlY3QocmVzcG9uc2Uuc3VjY2VzcykudG9CZSh0cnVlKTtcblxuICAgICAgICAvLyBWZXJpZnkgc3RvcmVkXG4gICAgICAgIGNvbnN0IHN0b3JlZCA9IHJvdXRpbmdUYWJsZS5nZXRMb2NhbChrZXkpO1xuICAgICAgICBleHBlY3Qoc3RvcmVkKS50b0JlRGVmaW5lZCgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnaGFuZGxlUGluZycsICgpID0+IHtcbiAgICAgIGl0KCdzaG91bGQgcmV0dXJuIHBvbmcnLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3Q6IFBpbmdSZXF1ZXN0ID0ge1xuICAgICAgICAgIHR5cGU6ICdQSU5HJyBhcyBESFRNZXNzYWdlVHlwZS5QSU5HLFxuICAgICAgICAgIHNlbmRlcklkOiBnZW5lcmF0ZU5vZGVJZCgpLFxuICAgICAgICAgIG1lc3NhZ2VJZDogJ3Rlc3QtMScsXG4gICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gcm91dGluZ1RhYmxlLmhhbmRsZVBpbmcocmVxdWVzdCk7XG5cbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnR5cGUpLnRvQmUoJ1BPTkcnKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLm1lc3NhZ2VJZCkudG9CZSgndGVzdC0xJyk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1N0YXRpc3RpY3MnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gY29ycmVjdCBzdGF0cycsICgpID0+IHtcbiAgICAgIC8vIEFkZCBjb250YWN0c1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHtcbiAgICAgICAgcm91dGluZ1RhYmxlLmFkZENvbnRhY3QoY3JlYXRlQ29udGFjdCgpKTtcbiAgICAgIH1cblxuICAgICAgLy8gU3RvcmUgdmFsdWVcbiAgICAgIGNvbnN0IGtleSA9IGdlbmVyYXRlREhUS2V5KCd0ZXN0Jyk7XG4gICAgICByb3V0aW5nVGFibGUuc3RvcmVMb2NhbChrZXksIHtcbiAgICAgICAgZGF0YTogbmV3IFVpbnQ4QXJyYXkoWzFdKSxcbiAgICAgICAgc3RvcmVkQXQ6IERhdGUubm93KCksXG4gICAgICAgIHR0bDogMzYwMDAwMCxcbiAgICAgICAgcHVibGlzaGVySWQ6IGxvY2FsTm9kZUlkLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHN0YXRzID0gcm91dGluZ1RhYmxlLmdldFN0YXRzKCk7XG5cbiAgICAgIGV4cGVjdChzdGF0cy5ub2RlQ291bnQpLnRvQmUoNSk7XG4gICAgICBleHBlY3Qoc3RhdHMudmFsdWVDb3VudCkudG9CZSgxKTtcbiAgICAgIGV4cGVjdChzdGF0cy5hY3RpdmVCdWNrZXRzKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICBleHBlY3Qoc3RhdHMubWVtb3J5VXNhZ2UpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0NsZWFyJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2xlYXIgYWxsIGRhdGEnLCAoKSA9PiB7XG4gICAgICAvLyBBZGQgZGF0YVxuICAgICAgcm91dGluZ1RhYmxlLmFkZENvbnRhY3QoY3JlYXRlQ29udGFjdCgpKTtcbiAgICAgIHJvdXRpbmdUYWJsZS5zdG9yZUxvY2FsKGdlbmVyYXRlREhUS2V5KCd0ZXN0JyksIHtcbiAgICAgICAgZGF0YTogbmV3IFVpbnQ4QXJyYXkoWzFdKSxcbiAgICAgICAgc3RvcmVkQXQ6IERhdGUubm93KCksXG4gICAgICAgIHR0bDogMzYwMDAwMCxcbiAgICAgICAgcHVibGlzaGVySWQ6IGxvY2FsTm9kZUlkLFxuICAgICAgfSk7XG5cbiAgICAgIHJvdXRpbmdUYWJsZS5jbGVhcigpO1xuXG4gICAgICBjb25zdCBzdGF0cyA9IHJvdXRpbmdUYWJsZS5nZXRTdGF0cygpO1xuICAgICAgZXhwZWN0KHN0YXRzLm5vZGVDb3VudCkudG9CZSgwKTtcbiAgICAgIGV4cGVjdChzdGF0cy52YWx1ZUNvdW50KS50b0JlKDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQnVja2V0IERpc3RyaWJ1dGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBidWNrZXQgZGlzdHJpYnV0aW9uJywgKCkgPT4ge1xuICAgICAgLy8gQWRkIGNvbnRhY3RzXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwOyBpKyspIHtcbiAgICAgICAgcm91dGluZ1RhYmxlLmFkZENvbnRhY3QoY3JlYXRlQ29udGFjdCgpKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGlzdHJpYnV0aW9uID0gcm91dGluZ1RhYmxlLmdldEJ1Y2tldERpc3RyaWJ1dGlvbigpO1xuXG4gICAgICBleHBlY3QoZGlzdHJpYnV0aW9uLmxlbmd0aCkudG9CZSgxNjApO1xuICAgICAgZXhwZWN0KGRpc3RyaWJ1dGlvbi5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSkudG9CZSgxMCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=