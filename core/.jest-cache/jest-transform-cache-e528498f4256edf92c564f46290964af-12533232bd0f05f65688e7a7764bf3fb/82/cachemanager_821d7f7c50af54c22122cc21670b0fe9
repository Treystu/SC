67456956506b417f1d4255e520e98d68
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MediaCache = exports.CacheManager = void 0;
class CacheManager {
    constructor(maxSize = 50 * 1024 * 1024, // 50MB default
    defaultTtl = 3600000 // 1 hour default
    ) {
        this.maxSize = maxSize;
        this.defaultTtl = defaultTtl;
        this.cache = new Map();
        this.stats = {
            hits: 0,
            misses: 0,
            evictions: 0,
            size: 0,
            count: 0
        };
        // Periodic cleanup
        setInterval(() => this.cleanup(), 60000); // Every minute
    }
    // Get item from cache
    get(key) {
        const entry = this.cache.get(key);
        if (!entry) {
            this.stats.misses++;
            return null;
        }
        // Check if expired
        if (Date.now() - entry.timestamp > entry.ttl) {
            this.delete(key);
            this.stats.misses++;
            return null;
        }
        this.stats.hits++;
        return entry.value;
    }
    // Set item in cache
    set(key, value, ttl = this.defaultTtl) {
        const size = this.estimateSize(value);
        // Check if we need to evict
        while (this.stats.size + size > this.maxSize && this.cache.size > 0) {
            this.evictOldest();
        }
        const entry = {
            key,
            value,
            timestamp: Date.now(),
            ttl,
            size
        };
        // Remove old entry if exists
        const existing = this.cache.get(key);
        if (existing) {
            this.stats.size -= existing.size;
            this.stats.count--;
        }
        this.cache.set(key, entry);
        this.stats.size += size;
        this.stats.count++;
    }
    // Check if key exists
    has(key) {
        return this.get(key) !== null;
    }
    // Delete item
    delete(key) {
        const entry = this.cache.get(key);
        if (!entry)
            return false;
        this.cache.delete(key);
        this.stats.size -= entry.size;
        this.stats.count--;
        return true;
    }
    // Clear all cache
    clear() {
        this.cache.clear();
        this.stats.size = 0;
        this.stats.count = 0;
    }
    // Get or fetch (with callback)
    async getOrFetch(key, fetcher, ttl) {
        const cached = this.get(key);
        if (cached !== null) {
            return cached;
        }
        const value = await fetcher();
        this.set(key, value, ttl);
        return value;
    }
    // Evict oldest entry
    evictOldest() {
        let oldest = null;
        let oldestKey = null;
        for (const [key, entry] of this.cache.entries()) {
            if (!oldest || entry.timestamp < oldest.timestamp) {
                oldest = entry;
                oldestKey = key;
            }
        }
        if (oldestKey) {
            this.delete(oldestKey);
            this.stats.evictions++;
        }
    }
    // Clean up expired entries
    cleanup() {
        const now = Date.now();
        const toDelete = [];
        for (const [key, entry] of this.cache.entries()) {
            if (now - entry.timestamp > entry.ttl) {
                toDelete.push(key);
            }
        }
        for (const key of toDelete) {
            this.delete(key);
        }
    }
    // Estimate size of value in bytes
    estimateSize(value) {
        try {
            return new Blob([JSON.stringify(value)]).size;
        }
        catch {
            return 1000; // Default estimate
        }
    }
    // Get cache statistics
    getStats() {
        return { ...this.stats };
    }
    // Get cache hit rate
    getHitRate() {
        const total = this.stats.hits + this.stats.misses;
        return total === 0 ? 0 : this.stats.hits / total;
    }
    // Prewarm cache with data
    async prewarm(entries) {
        await Promise.all(entries.map(({ key, fetcher, ttl }) => this.getOrFetch(key, fetcher, ttl)));
    }
}
exports.CacheManager = CacheManager;
// Specialized cache for images/media
class MediaCache extends CacheManager {
    constructor(maxSize = 100 * 1024 * 1024) {
        super(maxSize, 86400000); // 24 hour TTL
    }
    // Create object URL from cached blob
    getObjectURL(key) {
        const blob = this.get(key);
        return blob ? URL.createObjectURL(blob) : null;
    }
    // Cache image from URL
    async cacheFromURL(key, url) {
        return this.getOrFetch(key, async () => {
            const response = await fetch(url);
            if (!response.ok)
                throw new Error('Failed to fetch image');
            return await response.blob();
        });
    }
}
exports.MediaCache = MediaCache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvY2FjaGUtbWFuYWdlci50cyIsIm1hcHBpbmdzIjoiOzs7QUFpQkEsTUFBYSxZQUFZO0lBVXZCLFlBQ1UsVUFBa0IsRUFBRSxHQUFHLElBQUksR0FBRyxJQUFJLEVBQUUsZUFBZTtJQUNuRCxhQUFxQixPQUFPLENBQUMsaUJBQWlCOztRQUQ5QyxZQUFPLEdBQVAsT0FBTyxDQUEyQjtRQUNsQyxlQUFVLEdBQVYsVUFBVSxDQUFrQjtRQVg5QixVQUFLLEdBQStCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDOUMsVUFBSyxHQUFlO1lBQzFCLElBQUksRUFBRSxDQUFDO1lBQ1AsTUFBTSxFQUFFLENBQUM7WUFDVCxTQUFTLEVBQUUsQ0FBQztZQUNaLElBQUksRUFBRSxDQUFDO1lBQ1AsS0FBSyxFQUFFLENBQUM7U0FDVCxDQUFDO1FBTUEsbUJBQW1CO1FBQ25CLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxlQUFlO0lBQzNELENBQUM7SUFFRCxzQkFBc0I7SUFDdEIsR0FBRyxDQUFDLEdBQVc7UUFDYixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVsQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDWCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3BCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELG1CQUFtQjtRQUNuQixJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxLQUFLLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUM3QyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2pCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7WUFD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QyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDM0IsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNqRCxDQUFDO0lBRUQsdUJBQXVCO0lBQ3ZCLEtBQUssQ0FBQyxZQUFZLENBQUMsR0FBVyxFQUFFLEdBQVc7UUFDekMsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNyQyxNQUFNLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1lBQzNELE9BQU8sTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFuQkQsZ0NBbUJDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jaHJpc3R5bWF4d2VsbC9EZXNrdG9wL0x1a2VfU3R1ZmYvR2l0SHViL1NDL2NvcmUvc3JjL2NhY2hlLW1hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ2FjaGUgbWFuYWdlbWVudCBmb3IgaW1wcm92ZWQgcGVyZm9ybWFuY2VcbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVFbnRyeTxUPiB7XG4gIGtleTogc3RyaW5nO1xuICB2YWx1ZTogVDtcbiAgdGltZXN0YW1wOiBudW1iZXI7XG4gIHR0bDogbnVtYmVyOyAvLyBUaW1lIHRvIGxpdmUgaW4gbWlsbGlzZWNvbmRzXG4gIHNpemU6IG51bWJlcjsgLy8gU2l6ZSBpbiBieXRlc1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENhY2hlU3RhdHMge1xuICBoaXRzOiBudW1iZXI7XG4gIG1pc3NlczogbnVtYmVyO1xuICBldmljdGlvbnM6IG51bWJlcjtcbiAgc2l6ZTogbnVtYmVyO1xuICBjb3VudDogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgQ2FjaGVNYW5hZ2VyPFQgPSBhbnk+IHtcbiAgcHJpdmF0ZSBjYWNoZTogTWFwPHN0cmluZywgQ2FjaGVFbnRyeTxUPj4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgc3RhdHM6IENhY2hlU3RhdHMgPSB7XG4gICAgaGl0czogMCxcbiAgICBtaXNzZXM6IDAsXG4gICAgZXZpY3Rpb25zOiAwLFxuICAgIHNpemU6IDAsXG4gICAgY291bnQ6IDBcbiAgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG1heFNpemU6IG51bWJlciA9IDUwICogMTAyNCAqIDEwMjQsIC8vIDUwTUIgZGVmYXVsdFxuICAgIHByaXZhdGUgZGVmYXVsdFR0bDogbnVtYmVyID0gMzYwMDAwMCAvLyAxIGhvdXIgZGVmYXVsdFxuICApIHtcbiAgICAvLyBQZXJpb2RpYyBjbGVhbnVwXG4gICAgc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5jbGVhbnVwKCksIDYwMDAwKTsgLy8gRXZlcnkgbWludXRlXG4gIH1cblxuICAvLyBHZXQgaXRlbSBmcm9tIGNhY2hlXG4gIGdldChrZXk6IHN0cmluZyk6IFQgfCBudWxsIHtcbiAgICBjb25zdCBlbnRyeSA9IHRoaXMuY2FjaGUuZ2V0KGtleSk7XG5cbiAgICBpZiAoIWVudHJ5KSB7XG4gICAgICB0aGlzLnN0YXRzLm1pc3NlcysrO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgZXhwaXJlZFxuICAgIGlmIChEYXRlLm5vdygpIC0gZW50cnkudGltZXN0YW1wID4gZW50cnkudHRsKSB7XG4gICAgICB0aGlzLmRlbGV0ZShrZXkpO1xuICAgICAgdGhpcy5zdGF0cy5taXNzZXMrKztcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHRoaXMuc3RhdHMuaGl0cysrO1xuICAgIHJldHVybiBlbnRyeS52YWx1ZTtcbiAgfVxuXG4gIC8vIFNldCBpdGVtIGluIGNhY2hlXG4gIHNldChrZXk6IHN0cmluZywgdmFsdWU6IFQsIHR0bDogbnVtYmVyID0gdGhpcy5kZWZhdWx0VHRsKTogdm9pZCB7XG4gICAgY29uc3Qgc2l6ZSA9IHRoaXMuZXN0aW1hdGVTaXplKHZhbHVlKTtcblxuICAgIC8vIENoZWNrIGlmIHdlIG5lZWQgdG8gZXZpY3RcbiAgICB3aGlsZSAodGhpcy5zdGF0cy5zaXplICsgc2l6ZSA+IHRoaXMubWF4U2l6ZSAmJiB0aGlzLmNhY2hlLnNpemUgPiAwKSB7XG4gICAgICB0aGlzLmV2aWN0T2xkZXN0KCk7XG4gICAgfVxuXG4gICAgY29uc3QgZW50cnk6IENhY2hlRW50cnk8VD4gPSB7XG4gICAgICBrZXksXG4gICAgICB2YWx1ZSxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHR0bCxcbiAgICAgIHNpemVcbiAgICB9O1xuXG4gICAgLy8gUmVtb3ZlIG9sZCBlbnRyeSBpZiBleGlzdHNcbiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuY2FjaGUuZ2V0KGtleSk7XG4gICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICB0aGlzLnN0YXRzLnNpemUgLT0gZXhpc3Rpbmcuc2l6ZTtcbiAgICAgIHRoaXMuc3RhdHMuY291bnQtLTtcbiAgICB9XG5cbiAgICB0aGlzLmNhY2hlLnNldChrZXksIGVudHJ5KTtcbiAgICB0aGlzLnN0YXRzLnNpemUgKz0gc2l6ZTtcbiAgICB0aGlzLnN0YXRzLmNvdW50Kys7XG4gIH1cblxuICAvLyBDaGVjayBpZiBrZXkgZXhpc3RzXG4gIGhhcyhrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmdldChrZXkpICE9PSBudWxsO1xuICB9XG5cbiAgLy8gRGVsZXRlIGl0ZW1cbiAgZGVsZXRlKGtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmNhY2hlLmdldChrZXkpO1xuICAgIGlmICghZW50cnkpIHJldHVybiBmYWxzZTtcblxuICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7XG4gICAgdGhpcy5zdGF0cy5zaXplIC09IGVudHJ5LnNpemU7XG4gICAgdGhpcy5zdGF0cy5jb3VudC0tO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLy8gQ2xlYXIgYWxsIGNhY2hlXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIHRoaXMuY2FjaGUuY2xlYXIoKTtcbiAgICB0aGlzLnN0YXRzLnNpemUgPSAwO1xuICAgIHRoaXMuc3RhdHMuY291bnQgPSAwO1xuICB9XG5cbiAgLy8gR2V0IG9yIGZldGNoICh3aXRoIGNhbGxiYWNrKVxuICBhc3luYyBnZXRPckZldGNoKGtleTogc3RyaW5nLCBmZXRjaGVyOiAoKSA9PiBQcm9taXNlPFQ+LCB0dGw/OiBudW1iZXIpOiBQcm9taXNlPFQ+IHtcbiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmdldChrZXkpO1xuICAgIGlmIChjYWNoZWQgIT09IG51bGwpIHtcbiAgICAgIHJldHVybiBjYWNoZWQ7XG4gICAgfVxuXG4gICAgY29uc3QgdmFsdWUgPSBhd2FpdCBmZXRjaGVyKCk7XG4gICAgdGhpcy5zZXQoa2V5LCB2YWx1ZSwgdHRsKTtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICAvLyBFdmljdCBvbGRlc3QgZW50cnlcbiAgcHJpdmF0ZSBldmljdE9sZGVzdCgpOiB2b2lkIHtcbiAgICBsZXQgb2xkZXN0OiBDYWNoZUVudHJ5PFQ+IHwgbnVsbCA9IG51bGw7XG4gICAgbGV0IG9sZGVzdEtleTogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIGVudHJ5XSBvZiB0aGlzLmNhY2hlLmVudHJpZXMoKSkge1xuICAgICAgaWYgKCFvbGRlc3QgfHwgZW50cnkudGltZXN0YW1wIDwgb2xkZXN0LnRpbWVzdGFtcCkge1xuICAgICAgICBvbGRlc3QgPSBlbnRyeTtcbiAgICAgICAgb2xkZXN0S2V5ID0ga2V5O1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChvbGRlc3RLZXkpIHtcbiAgICAgIHRoaXMuZGVsZXRlKG9sZGVzdEtleSk7XG4gICAgICB0aGlzLnN0YXRzLmV2aWN0aW9ucysrO1xuICAgIH1cbiAgfVxuXG4gIC8vIENsZWFuIHVwIGV4cGlyZWQgZW50cmllc1xuICBwcml2YXRlIGNsZWFudXAoKTogdm9pZCB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCB0b0RlbGV0ZTogc3RyaW5nW10gPSBbXTtcblxuICAgIGZvciAoY29uc3QgW2tleSwgZW50cnldIG9mIHRoaXMuY2FjaGUuZW50cmllcygpKSB7XG4gICAgICBpZiAobm93IC0gZW50cnkudGltZXN0YW1wID4gZW50cnkudHRsKSB7XG4gICAgICAgIHRvRGVsZXRlLnB1c2goa2V5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGtleSBvZiB0b0RlbGV0ZSkge1xuICAgICAgdGhpcy5kZWxldGUoa2V5KTtcbiAgICB9XG4gIH1cblxuICAvLyBFc3RpbWF0ZSBzaXplIG9mIHZhbHVlIGluIGJ5dGVzXG4gIHByaXZhdGUgZXN0aW1hdGVTaXplKHZhbHVlOiBUKTogbnVtYmVyIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIG5ldyBCbG9iKFtKU09OLnN0cmluZ2lmeSh2YWx1ZSldKS5zaXplO1xuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIDEwMDA7IC8vIERlZmF1bHQgZXN0aW1hdGVcbiAgICB9XG4gIH1cblxuICAvLyBHZXQgY2FjaGUgc3RhdGlzdGljc1xuICBnZXRTdGF0cygpOiBDYWNoZVN0YXRzIHtcbiAgICByZXR1cm4geyAuLi50aGlzLnN0YXRzIH07XG4gIH1cblxuICAvLyBHZXQgY2FjaGUgaGl0IHJhdGVcbiAgZ2V0SGl0UmF0ZSgpOiBudW1iZXIge1xuICAgIGNvbnN0IHRvdGFsID0gdGhpcy5zdGF0cy5oaXRzICsgdGhpcy5zdGF0cy5taXNzZXM7XG4gICAgcmV0dXJuIHRvdGFsID09PSAwID8gMCA6IHRoaXMuc3RhdHMuaGl0cyAvIHRvdGFsO1xuICB9XG5cbiAgLy8gUHJld2FybSBjYWNoZSB3aXRoIGRhdGFcbiAgYXN5bmMgcHJld2FybShlbnRyaWVzOiBBcnJheTx7IGtleTogc3RyaW5nOyBmZXRjaGVyOiAoKSA9PiBQcm9taXNlPFQ+OyB0dGw/OiBudW1iZXIgfT4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIGVudHJpZXMubWFwKCh7IGtleSwgZmV0Y2hlciwgdHRsIH0pID0+IFxuICAgICAgICB0aGlzLmdldE9yRmV0Y2goa2V5LCBmZXRjaGVyLCB0dGwpXG4gICAgICApXG4gICAgKTtcbiAgfVxufVxuXG4vLyBTcGVjaWFsaXplZCBjYWNoZSBmb3IgaW1hZ2VzL21lZGlhXG5leHBvcnQgY2xhc3MgTWVkaWFDYWNoZSBleHRlbmRzIENhY2hlTWFuYWdlcjxCbG9iPiB7XG4gIGNvbnN0cnVjdG9yKG1heFNpemU6IG51bWJlciA9IDEwMCAqIDEwMjQgKiAxMDI0KSB7IC8vIDEwME1CIGZvciBtZWRpYVxuICAgIHN1cGVyKG1heFNpemUsIDg2NDAwMDAwKTsgLy8gMjQgaG91ciBUVExcbiAgfVxuXG4gIC8vIENyZWF0ZSBvYmplY3QgVVJMIGZyb20gY2FjaGVkIGJsb2JcbiAgZ2V0T2JqZWN0VVJMKGtleTogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgY29uc3QgYmxvYiA9IHRoaXMuZ2V0KGtleSk7XG4gICAgcmV0dXJuIGJsb2IgPyBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpIDogbnVsbDtcbiAgfVxuXG4gIC8vIENhY2hlIGltYWdlIGZyb20gVVJMXG4gIGFzeW5jIGNhY2hlRnJvbVVSTChrZXk6IHN0cmluZywgdXJsOiBzdHJpbmcpOiBQcm9taXNlPEJsb2I+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRPckZldGNoKGtleSwgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwpO1xuICAgICAgaWYgKCFyZXNwb25zZS5vaykgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gZmV0Y2ggaW1hZ2UnKTtcbiAgICAgIHJldHVybiBhd2FpdCByZXNwb25zZS5ibG9iKCk7XG4gICAgfSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==