3ee069873480275df4f4eb0821a33957
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.IndexedDBBlobAdapter = exports.BlobStore = void 0;
const sha2_js_1 = require("@noble/hashes/sha2.js");
function hashData(data) {
    const hash = (0, sha2_js_1.sha256)(data);
    return Array.from(hash)
        .map((b) => b.toString(16).padStart(2, "0"))
        .join("");
}
/**
 * BlobStore - Persistent Blob Storage with IndexedDB
 *
 * FEATURES:
 * - Persistent storage via IndexedDB (web) or FileSystem (mobile)
 * - Memory cache for fast access
 * - Automatic size tracking and quota management
 * - Recommended maximum file size: 10MB per blob
 * - Total storage limit: 100MB (configurable via maxTotalSize)
 *
 * SNEAKERNET RELAY SUPPORT:
 * - Messages and attachments persist across app restarts
 * - Critical for offline mesh relay nodes that store-and-forward
 * - Data survives phone reboots, enabling reliable sneakernet proxying
 *
 * For future enhancements, consider:
 *   - Adding blob expiration/garbage collection
 *   - Using external blob storage (CDN, S3, IPFS) for large files
 */
class BlobStore {
    constructor(persistence) {
        this.memoryStore = new Map();
        // Size limits for memory safety
        this.MAX_BLOB_SIZE = 10 * 1024 * 1024; // 10MB per blob
        this.MAX_TOTAL_SIZE = 100 * 1024 * 1024; // 100MB total
        this.currentTotalSize = 0;
        this.initialized = false;
        this.persistence = persistence;
    }
    /**
     * Initialize persistent storage and load size metrics
     * Must be called before using the store
     */
    async init() {
        if (this.initialized)
            return;
        if (this.persistence) {
            // Load all blobs from persistent storage into memory cache
            const allBlobs = await this.persistence.getAll();
            this.memoryStore = allBlobs;
            // Calculate current total size from persistent storage
            this.currentTotalSize = 0;
            for (const blob of allBlobs.values()) {
                this.currentTotalSize += blob.length;
            }
        }
        this.initialized = true;
    }
    /**
     * Store data and return its hash
     * @throws Error if blob exceeds size limits
     */
    async put(data) {
        const blobSize = data.length;
        // Validate blob size
        if (blobSize > this.MAX_BLOB_SIZE) {
            throw new Error(`Blob size (${(blobSize / 1024 / 1024).toFixed(2)}MB) exceeds maximum allowed size (${this.MAX_BLOB_SIZE / 1024 / 1024}MB). ` +
                `Consider compressing the file or using external storage for large files.`);
        }
        // Check total storage limit
        if (this.currentTotalSize + blobSize > this.MAX_TOTAL_SIZE) {
            throw new Error(`Total storage limit exceeded. Current: ${(this.currentTotalSize / 1024 / 1024).toFixed(2)}MB, ` +
                `Attempting to add: ${(blobSize / 1024 / 1024).toFixed(2)}MB, ` +
                `Max: ${this.MAX_TOTAL_SIZE / 1024 / 1024}MB. ` +
                `Consider clearing old blobs or implementing persistent storage.`);
        }
        const hash = hashData(data);
        // Check if blob already exists (avoid double-counting size)
        const existingBlob = this.memoryStore.get(hash);
        if (existingBlob) {
            // Blob already exists with same content, no size change needed
            return hash;
        }
        // Add to total size since this is a new blob
        this.currentTotalSize += blobSize;
        // Store in memory first (for fast access)
        this.memoryStore.set(hash, data);
        // Store persistently if adapter is available
        if (this.persistence) {
            try {
                await this.persistence.put(hash, data);
            }
            catch (error) {
                // If persistent storage fails, remove from memory store to maintain consistency
                this.memoryStore.delete(hash);
                this.currentTotalSize -= blobSize;
                throw new Error(`Failed to persist blob: ${error}`);
            }
        }
        return hash;
    }
    /**
     * Retrieve data by hash
     */
    async get(hash) {
        const data = this.memoryStore.get(hash);
        if (data) {
            return data;
        }
        if (this.persistence) {
            const persistedData = await this.persistence.get(hash);
            if (persistedData) {
                this.memoryStore.set(hash, persistedData);
                return persistedData;
            }
        }
        return undefined;
    }
    /**
     * Check if we have the blob
     */
    async has(hash) {
        if (this.memoryStore.has(hash)) {
            return true;
        }
        if (this.persistence) {
            return await this.persistence.has(hash);
        }
        return false;
    }
    /**
     * Get storage statistics
     */
    getStats() {
        return {
            blobCount: this.memoryStore.size,
            totalSizeBytes: this.currentTotalSize,
            totalSizeMB: Number((this.currentTotalSize / 1024 / 1024).toFixed(2)),
            remainingBytes: this.MAX_TOTAL_SIZE - this.currentTotalSize,
            remainingMB: Number(((this.MAX_TOTAL_SIZE - this.currentTotalSize) / 1024 / 1024).toFixed(2)),
            utilizationPercent: Number(((this.currentTotalSize / this.MAX_TOTAL_SIZE) * 100).toFixed(2)),
        };
    }
    /**
     * Clear all blobs (useful for testing or cleanup)
     */
    clear() {
        this.memoryStore.clear();
        this.currentTotalSize = 0;
    }
}
exports.BlobStore = BlobStore;
/**
 * IndexedDB implementation of BlobPersistenceAdapter for web browsers
 */
class IndexedDBBlobAdapter {
    constructor() {
        this.dbName = 'BlobStorage';
        this.storeName = 'blobs';
        this.db = null;
        this.version = 1;
    }
    async init() {
        if (this.db)
            return;
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                resolve();
            };
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(this.storeName)) {
                    db.createObjectStore(this.storeName);
                }
            };
        });
    }
    async ensureInit() {
        if (!this.db) {
            await this.init();
        }
    }
    async put(hash, data) {
        await this.ensureInit();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.put(data, hash);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve();
        });
    }
    async get(hash) {
        await this.ensureInit();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.get(hash);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                const result = request.result;
                resolve(result ? new Uint8Array(result) : null);
            };
        });
    }
    async has(hash) {
        await this.ensureInit();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.count(hash);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result > 0);
        });
    }
    async delete(hash) {
        await this.ensureInit();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.delete(hash);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve();
        });
    }
    async clear() {
        await this.ensureInit();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.clear();
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve();
        });
    }
    async getAll() {
        await this.ensureInit();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const map = new Map();
            const request = store.openCursor();
            request.onerror = () => reject(request.error);
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const key = String(cursor.key);
                    const data = new Uint8Array(cursor.value);
                    map.set(key, data);
                    cursor.continue();
                }
                else {
                    resolve(map);
                }
            };
        });
    }
    async getSize() {
        await this.ensureInit();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.count();
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    }
}
exports.IndexedDBBlobAdapter = IndexedDBBlobAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvc3RvcmFnZS9ibG9iLXN0b3JlLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLG1EQUErQztBQVkvQyxTQUFTLFFBQVEsQ0FBQyxJQUFnQjtJQUNoQyxNQUFNLElBQUksR0FBRyxJQUFBLGdCQUFNLEVBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUIsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztTQUNwQixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUMzQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDZCxDQUFDO0FBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCRztBQUNILE1BQWEsU0FBUztJQVVwQixZQUFZLFdBQW9DO1FBUnhDLGdCQUFXLEdBQTRCLElBQUksR0FBRyxFQUFFLENBQUM7UUFFekQsZ0NBQWdDO1FBQ2Ysa0JBQWEsR0FBRyxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLGdCQUFnQjtRQUNsRCxtQkFBYyxHQUFHLEdBQUcsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsY0FBYztRQUMzRCxxQkFBZ0IsR0FBRyxDQUFDLENBQUM7UUFDckIsZ0JBQVcsR0FBRyxLQUFLLENBQUM7UUFHMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7SUFDakMsQ0FBQztJQUVEOzs7T0FHRztJQUNILEtBQUssQ0FBQyxJQUFJO1FBQ1IsSUFBSSxJQUFJLENBQUMsV0FBVztZQUFFLE9BQU87UUFFN0IsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDckIsMkRBQTJEO1lBQzNELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNq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LENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUMvQixNQUFNLElBQUksR0FBRyxJQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQzFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUNuQixNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ3BCLENBQUM7cUJBQU0sQ0FBQztvQkFDTixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2YsQ0FBQztZQUNILENBQUMsQ0FBQztRQUNSLENBQUMsQ0FBQyxDQUFDO0lBQ0EsQ0FBQztJQUVGLEtBQUssQ0FBQyxPQUFPO1FBQ1gsTUFBTSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFFeEIsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsRUFBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUN2RSxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN0RCxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7WUFFOUIsT0FBTyxDQUFDLE9BQU8sR0FBRyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzlDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNwRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQXpJRCxvREF5SUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvc3RvcmFnZS9ibG9iLXN0b3JlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNoYTI1NiB9IGZyb20gXCJAbm9ibGUvaGFzaGVzL3NoYTIuanNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBCbG9iUGVyc2lzdGVuY2VBZGFwdGVyIHtcbiAgcHV0KGhhc2g6IHN0cmluZywgZGF0YTogVWludDhBcnJheSk6IFByb21pc2U8dm9pZD47XG4gIGdldChoYXNoOiBzdHJpbmcpOiBQcm9taXNlPFVpbnQ4QXJyYXkgfCBudWxsPjtcbiAgaGFzKGhhc2g6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj47XG4gIGRlbGV0ZShoYXNoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+O1xuICBjbGVhcigpOiBQcm9taXNlPHZvaWQ+O1xuICBnZXRBbGwoKTogUHJvbWlzZTxNYXA8c3RyaW5nLCBVaW50OEFycmF5Pj47XG4gIGdldFNpemUoKTogUHJvbWlzZTxudW1iZXI+O1xufVxuXG5mdW5jdGlvbiBoYXNoRGF0YShkYXRhOiBVaW50OEFycmF5KTogc3RyaW5nIHtcbiAgY29uc3QgaGFzaCA9IHNoYTI1NihkYXRhKTtcbiAgcmV0dXJuIEFycmF5LmZyb20oaGFzaClcbiAgICAubWFwKChiKSA9PiBiLnRvU3RyaW5nKDE2KS5wYWRTdGFydCgyLCBcIjBcIikpXG4gICAgLmpvaW4oXCJcIik7XG59XG5cbi8qKlxuICogQmxvYlN0b3JlIC0gUGVyc2lzdGVudCBCbG9iIFN0b3JhZ2Ugd2l0aCBJbmRleGVkREJcbiAqXG4gKiBGRUFUVVJFUzpcbiAqIC0gUGVyc2lzdGVudCBzdG9yYWdlIHZpYSBJbmRleGVkREIgKHdlYikgb3IgRmlsZVN5c3RlbSAobW9iaWxlKVxuICogLSBNZW1vcnkgY2FjaGUgZm9yIGZhc3QgYWNjZXNzXG4gKiAtIEF1dG9tYXRpYyBzaXplIHRyYWNraW5nIGFuZCBxdW90YSBtYW5hZ2VtZW50XG4gKiAtIFJlY29tbWVuZGVkIG1heGltdW0gZmlsZSBzaXplOiAxME1CIHBlciBibG9iXG4gKiAtIFRvdGFsIHN0b3JhZ2UgbGltaXQ6IDEwME1CIChjb25maWd1cmFibGUgdmlhIG1heFRvdGFsU2l6ZSlcbiAqIFxuICogU05FQUtFUk5FVCBSRUxBWSBTVVBQT1JUOlxuICogLSBNZXNzYWdlcyBhbmQgYXR0YWNobWVudHMgcGVyc2lzdCBhY3Jvc3MgYXBwIHJlc3RhcnRzXG4gKiAtIENyaXRpY2FsIGZvciBvZmZsaW5lIG1lc2ggcmVsYXkgbm9kZXMgdGhhdCBzdG9yZS1hbmQtZm9yd2FyZFxuICogLSBEYXRhIHN1cnZpdmVzIHBob25lIHJlYm9vdHMsIGVuYWJsaW5nIHJlbGlhYmxlIHNuZWFrZXJuZXQgcHJveHlpbmdcbiAqXG4gKiBGb3IgZnV0dXJlIGVuaGFuY2VtZW50cywgY29uc2lkZXI6XG4gKiAgIC0gQWRkaW5nIGJsb2IgZXhwaXJhdGlvbi9nYXJiYWdlIGNvbGxlY3Rpb25cbiAqICAgLSBVc2luZyBleHRlcm5hbCBibG9iIHN0b3JhZ2UgKENETiwgUzMsIElQRlMpIGZvciBsYXJnZSBmaWxlc1xuICovXG5leHBvcnQgY2xhc3MgQmxvYlN0b3JlIHtcbiAgcHJpdmF0ZSBwZXJzaXN0ZW5jZT86IEJsb2JQZXJzaXN0ZW5jZUFkYXB0ZXI7XG4gIHByaXZhdGUgbWVtb3J5U3RvcmU6IE1hcDxzdHJpbmcsIFVpbnQ4QXJyYXk+ID0gbmV3IE1hcCgpO1xuXG4gIC8vIFNpemUgbGltaXRzIGZvciBtZW1vcnkgc2FmZXR5XG4gIHByaXZhdGUgcmVhZG9ubHkgTUFYX0JMT0JfU0laRSA9IDEwICogMTAyNCAqIDEwMjQ7IC8vIDEwTUIgcGVyIGJsb2JcbiAgcHJpdmF0ZSByZWFkb25seSBNQVhfVE9UQUxfU0laRSA9IDEwMCAqIDEwMjQgKiAxMDI0OyAvLyAxMDBNQiB0b3RhbFxuICBwcml2YXRlIGN1cnJlbnRUb3RhbFNpemUgPSAwO1xuICBwcml2YXRlIGluaXRpYWxpemVkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocGVyc2lzdGVuY2U/OiBCbG9iUGVyc2lzdGVuY2VBZGFwdGVyKSB7XG4gICAgdGhpcy5wZXJzaXN0ZW5jZSA9IHBlcnNpc3RlbmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgcGVyc2lzdGVudCBzdG9yYWdlIGFuZCBsb2FkIHNpemUgbWV0cmljc1xuICAgKiBNdXN0IGJlIGNhbGxlZCBiZWZvcmUgdXNpbmcgdGhlIHN0b3JlXG4gICAqL1xuICBhc3luYyBpbml0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLmluaXRpYWxpemVkKSByZXR1cm47XG4gICAgXG4gICAgaWYgKHRoaXMucGVyc2lzdGVuY2UpIHtcbiAgICAgIC8vIExvYWQgYWxsIGJsb2JzIGZyb20gcGVyc2lzdGVudCBzdG9yYWdlIGludG8gbWVtb3J5IGNhY2hlXG4gICAgICBjb25zdCBhbGxCbG9icyA9IGF3YWl0IHRoaXMucGVyc2lzdGVuY2UuZ2V0QWxsKCk7XG4gICAgICB0aGlzLm1lbW9yeVN0b3JlID0gYWxsQmxvYnM7XG4gICAgICBcbiAgICAgIC8vIENhbGN1bGF0ZSBjdXJyZW50IHRvdGFsIHNpemUgZnJvbSBwZXJzaXN0ZW50IHN0b3JhZ2VcbiAgICAgIHRoaXMuY3VycmVudFRvdGFsU2l6ZSA9IDA7XG4gICAgICBmb3IgKGNvbnN0IGJsb2Igb2YgYWxsQmxvYnMudmFsdWVzKCkpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50VG90YWxTaXplICs9IGJsb2IubGVuZ3RoO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9yZSBkYXRhIGFuZCByZXR1cm4gaXRzIGhhc2hcbiAgICogQHRocm93cyBFcnJvciBpZiBibG9iIGV4Y2VlZHMgc2l6ZSBsaW1pdHNcbiAgICovXG4gIGFzeW5jIHB1dChkYXRhOiBVaW50OEFycmF5KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBibG9iU2l6ZSA9IGRhdGEubGVuZ3RoO1xuXG4gICAgLy8gVmFsaWRhdGUgYmxvYiBzaXplXG4gICAgaWYgKGJsb2JTaXplID4gdGhpcy5NQVhfQkxPQl9TSVpFKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBCbG9iIHNpemUgKCR7KGJsb2JTaXplIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUIpIGV4Y2VlZHMgbWF4aW11bSBhbGxvd2VkIHNpemUgKCR7dGhpcy5NQVhfQkxPQl9TSVpFIC8gMTAyNCAvIDEwMjR9TUIpLiBgICtcbiAgICAgICAgYENvbnNpZGVyIGNvbXByZXNzaW5nIHRoZSBmaWxlIG9yIHVzaW5nIGV4dGVybmFsIHN0b3JhZ2UgZm9yIGxhcmdlIGZpbGVzLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgdG90YWwgc3RvcmFnZSBsaW1pdFxuICAgIGlmICh0aGlzLmN1cnJlbnRUb3RhbFNpemUgKyBibG9iU2l6ZSA+IHRoaXMuTUFYX1RPVEFMX1NJWkUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRvdGFsIHN0b3JhZ2UgbGltaXQgZXhjZWVkZWQuIEN1cnJlbnQ6ICR7KHRoaXMuY3VycmVudFRvdGFsU2l6ZSAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CLCBgICtcbiAgICAgICAgYEF0dGVtcHRpbmcgdG8gYWRkOiAkeyhibG9iU2l6ZSAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfU1CLCBgICtcbiAgICAgICAgYE1heDogJHt0aGlzLk1BWF9UT1RBTF9TSVpFIC8gMTAyNCAvIDEwMjR9TUIuIGAgK1xuICAgICAgICBgQ29uc2lkZXIgY2xlYXJpbmcgb2xkIGJsb2JzIG9yIGltcGxlbWVudGluZyBwZXJzaXN0ZW50IHN0b3JhZ2UuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBoYXNoID0gaGFzaERhdGEoZGF0YSk7XG5cbiAgICAvLyBDaGVjayBpZiBibG9iIGFscmVhZHkgZXhpc3RzIChhdm9pZCBkb3VibGUtY291bnRpbmcgc2l6ZSlcbiAgICBjb25zdCBleGlzdGluZ0Jsb2IgPSB0aGlzLm1lbW9yeVN0b3JlLmdldChoYXNoKTtcbiAgICBpZiAoZXhpc3RpbmdCbG9iKSB7XG4gICAgICAvLyBCbG9iIGFscmVhZHkgZXhpc3RzIHdpdGggc2FtZSBjb250ZW50LCBubyBzaXplIGNoYW5nZSBuZWVkZWRcbiAgICAgIHJldHVybiBoYXNoO1xuICAgIH1cblxuICAgIC8vIEFkZCB0byB0b3RhbCBzaXplIHNpbmNlIHRoaXMgaXMgYSBuZXcgYmxvYlxuICAgIHRoaXMuY3VycmVudFRvdGFsU2l6ZSArPSBibG9iU2l6ZTtcblxuICAgIC8vIFN0b3JlIGluIG1lbW9yeSBmaXJzdCAoZm9yIGZhc3QgYWNjZXNzKVxuICAgIHRoaXMubWVtb3J5U3RvcmUuc2V0KGhhc2gsIGRhdGEpO1xuXG4gICAgLy8gU3RvcmUgcGVyc2lzdGVudGx5IGlmIGFkYXB0ZXIgaXMgYXZhaWxhYmxlXG4gICAgaWYgKHRoaXMucGVyc2lzdGVuY2UpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucGVyc2lzdGVuY2UucHV0KGhhc2gsIGRhdGEpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgLy8gSWYgcGVyc2lzdGVudCBzdG9yYWdlIGZhaWxzLCByZW1vdmUgZnJvbSBtZW1vcnkgc3RvcmUgdG8gbWFpbnRhaW4gY29uc2lzdGVuY3lcbiAgICAgICAgdGhpcy5tZW1vcnlTdG9yZS5kZWxldGUoaGFzaCk7XG4gICAgICAgIHRoaXMuY3VycmVudFRvdGFsU2l6ZSAtPSBibG9iU2l6ZTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gcGVyc2lzdCBibG9iOiAke2Vycm9yfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBoYXNoO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlIGRhdGEgYnkgaGFzaFxuICAgKi9cbiAgYXN5bmMgZ2V0KGhhc2g6IHN0cmluZyk6IFByb21pc2U8VWludDhBcnJheSB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IGRhdGEgPSB0aGlzLm1lbW9yeVN0b3JlLmdldChoYXNoKTtcbiAgICBcbiAgICBpZiAoZGF0YSkge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucGVyc2lzdGVuY2UpIHtcbiAgICAgIGNvbnN0IHBlcnNpc3RlZERhdGEgPSBhd2FpdCB0aGlzLnBlcnNpc3RlbmNlLmdldChoYXNoKTtcbiAgICAgIGlmIChwZXJzaXN0ZWREYXRhKSB7XG4gICAgICAgIHRoaXMubWVtb3J5U3RvcmUuc2V0KGhhc2gsIHBlcnNpc3RlZERhdGEpO1xuICAgICAgICByZXR1cm4gcGVyc2lzdGVkRGF0YTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIHdlIGhhdmUgdGhlIGJsb2JcbiAgICovXG4gIGFzeW5jIGhhcyhoYXNoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBpZiAodGhpcy5tZW1vcnlTdG9yZS5oYXMoaGFzaCkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnBlcnNpc3RlbmNlKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wZXJzaXN0ZW5jZS5oYXMoaGFzaCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBzdG9yYWdlIHN0YXRpc3RpY3NcbiAgICovXG4gIGdldFN0YXRzKCk6IHtcbiAgICBibG9iQ291bnQ6IG51bWJlcjtcbiAgICB0b3RhbFNpemVCeXRlczogbnVtYmVyO1xuICAgIHRvdGFsU2l6ZU1COiBudW1iZXI7XG4gICAgcmVtYWluaW5nQnl0ZXM6IG51bWJlcjtcbiAgICByZW1haW5pbmdNQjogbnVtYmVyO1xuICAgIHV0aWxpemF0aW9uUGVyY2VudDogbnVtYmVyO1xuICB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgYmxvYkNvdW50OiB0aGlzLm1lbW9yeVN0b3JlLnNpemUsXG4gICAgICB0b3RhbFNpemVCeXRlczogdGhpcy5jdXJyZW50VG90YWxTaXplLFxuICAgICAgdG90YWxTaXplTUI6IE51bWJlcigodGhpcy5jdXJyZW50VG90YWxTaXplIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMikpLFxuICAgICAgcmVtYWluaW5nQnl0ZXM6IHRoaXMuTUFYX1RPVEFMX1NJWkUgLSB0aGlzLmN1cnJlbnRUb3RhbFNpemUsXG4gICAgICByZW1haW5pbmdNQjogTnVtYmVyKCgodGhpcy5NQVhfVE9UQUxfU0laRSAtIHRoaXMuY3VycmVudFRvdGFsU2l6ZSkgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKSksXG4gICAgICB1dGlsaXphdGlvblBlcmNlbnQ6IE51bWJlcigoKHRoaXMuY3VycmVudFRvdGFsU2l6ZSAvIHRoaXMuTUFYX1RPVEFMX1NJWkUpICogMTAwKS50b0ZpeGVkKDIpKSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIGFsbCBibG9icyAodXNlZnVsIGZvciB0ZXN0aW5nIG9yIGNsZWFudXApXG4gICAqL1xuICBjbGVhcigpOiB2b2lkIHtcbiAgICB0aGlzLm1lbW9yeVN0b3JlLmNsZWFyKCk7XG4gICAgdGhpcy5jdXJyZW50VG90YWxTaXplID0gMDtcbiAgfVxufVxuXG4vKipcbiAqIEluZGV4ZWREQiBpbXBsZW1lbnRhdGlvbiBvZiBCbG9iUGVyc2lzdGVuY2VBZGFwdGVyIGZvciB3ZWIgYnJvd3NlcnNcbiAqL1xuZXhwb3J0IGNsYXNzIEluZGV4ZWREQkJsb2JBZGFwdGVyIGltcGxlbWVudHMgQmxvYlBlcnNpc3RlbmNlQWRhcHRlciB7XG4gIHByaXZhdGUgZGJOYW1lID0gJ0Jsb2JTdG9yYWdlJztcbiAgcHJpdmF0ZSBzdG9yZU5hbWUgPSAnYmxvYnMnO1xuICBwcml2YXRlIGRiOiBJREJEYXRhYmFzZSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHZlcnNpb24gPSAxO1xuXG4gIGFzeW5jIGluaXQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMuZGIpIHJldHVybjtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCByZXF1ZXN0ID0gaW5kZXhlZERCLm9wZW4odGhpcy5kYk5hbWUsIHRoaXMudmVyc2lvbik7XG4gICAgICBcbiAgICAgIHJlcXVlc3Qub25lcnJvciA9ICgpID0+IHJlamVjdChyZXF1ZXN0LmVycm9yKTtcbiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmRiID0gcmVxdWVzdC5yZXN1bHQ7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH07XG4gICAgICBcbiAgICAgIHJlcXVlc3Qub251cGdyYWRlbmVlZGVkID0gKGV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IGRiID0gKGV2ZW50LnRhcmdldCBhcyBJREJPcGVuREJSZXF1ZXN0KS5yZXN1bHQ7XG4gICAgICAgIGlmICghZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyh0aGlzLnN0b3JlTmFtZSkpIHtcbiAgICAgICAgICBkYi5jcmVhdGVPYmplY3RTdG9yZSh0aGlzLnN0b3JlTmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGVuc3VyZUluaXQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmRiKSB7XG4gICAgICBhd2FpdCB0aGlzLmluaXQoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBwdXQoaGFzaDogc3RyaW5nLCBkYXRhOiBVaW50OEFycmF5KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5lbnN1cmVJbml0KCk7XG4gICAgXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy5kYiEudHJhbnNhY3Rpb24oW3RoaXMuc3RvcmVOYW1lXSwgJ3JlYWR3cml0ZScpO1xuICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZSh0aGlzLnN0b3JlTmFtZSk7XG4gICAgICBjb25zdCByZXF1ZXN0ID0gc3RvcmUucHV0KGRhdGEsIGhhc2gpO1xuICAgICAgXG4gICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiByZWplY3QocmVxdWVzdC5lcnJvcik7XG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHJlc29sdmUoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldChoYXNoOiBzdHJpbmcpOiBQcm9taXNlPFVpbnQ4QXJyYXkgfCBudWxsPiB7XG4gICAgYXdhaXQgdGhpcy5lbnN1cmVJbml0KCk7XG4gICAgXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy5kYiEudHJhbnNhY3Rpb24oW3RoaXMuc3RvcmVOYW1lXSwgJ3JlYWRvbmx5Jyk7XG4gICAgICBjb25zdCBzdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHRoaXMuc3RvcmVOYW1lKTtcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSBzdG9yZS5nZXQoaGFzaCk7XG4gICAgICBcbiAgICAgIHJlcXVlc3Qub25lcnJvciA9ICgpID0+IHJlamVjdChyZXF1ZXN0LmVycm9yKTtcbiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSByZXF1ZXN0LnJlc3VsdDtcbiAgICAgICAgcmVzb2x2ZShyZXN1bHQgPyBuZXcgVWludDhBcnJheShyZXN1bHQpIDogbnVsbCk7XG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgaGFzKGhhc2g6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGF3YWl0IHRoaXMuZW5zdXJlSW5pdCgpO1xuICAgIFxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHRoaXMuZGIhLnRyYW5zYWN0aW9uKFt0aGlzLnN0b3JlTmFtZV0sICdyZWFkb25seScpO1xuICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZSh0aGlzLnN0b3JlTmFtZSk7XG4gICAgICBjb25zdCByZXF1ZXN0ID0gc3RvcmUuY291bnQoaGFzaCk7XG4gICAgICBcbiAgICAgIHJlcXVlc3Qub25lcnJvciA9ICgpID0+IHJlamVjdChyZXF1ZXN0LmVycm9yKTtcbiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKCkgPT4gcmVzb2x2ZShyZXF1ZXN0LnJlc3VsdCA+IDApO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlKGhhc2g6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuZW5zdXJlSW5pdCgpO1xuICAgIFxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHRoaXMuZGIhLnRyYW5zYWN0aW9uKFt0aGlzLnN0b3JlTmFtZV0sICdyZWFkd3JpdGUnKTtcbiAgICAgIGNvbnN0IHN0b3JlID0gdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUodGhpcy5zdG9yZU5hbWUpO1xuICAgICAgY29uc3QgcmVxdWVzdCA9IHN0b3JlLmRlbGV0ZShoYXNoKTtcbiAgICAgIFxuICAgICAgcmVxdWVzdC5vbmVycm9yID0gKCkgPT4gcmVqZWN0KHJlcXVlc3QuZXJyb3IpO1xuICAgICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiByZXNvbHZlKCk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBjbGVhcigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmVuc3VyZUluaXQoKTtcbiAgICBcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSB0aGlzLmRiIS50cmFuc2FjdGlvbihbdGhpcy5zdG9yZU5hbWVdLCAncmVhZHdyaXRlJyk7XG4gICAgICBjb25zdCBzdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHRoaXMuc3RvcmVOYW1lKTtcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSBzdG9yZS5jbGVhcigpO1xuICAgICAgXG4gICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiByZWplY3QocmVxdWVzdC5lcnJvcik7XG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHJlc29sdmUoKTtcbiAgICB9KTtcbiAgfVxuXG5hc3luYyBnZXRBbGwoKTogUHJvbWlzZTxNYXA8c3RyaW5nLCBVaW50OEFycmF5Pj4ge1xuICAgIGF3YWl0IHRoaXMuZW5zdXJlSW5pdCgpO1xuICAgIFxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB0cmFuc2FjdGlvbiA9IHRoaXMuZGIhLnRyYW5zYWN0aW9uKFt0aGlzLnN0b3JlTmFtZV0sICdyZWFkb25seScpO1xuICAgICAgY29uc3Qgc3RvcmUgPSB0cmFuc2FjdGlvbi5vYmplY3RTdG9yZSh0aGlzLnN0b3JlTmFtZSk7XG4gICAgICBjb25zdCBtYXAgPSBuZXcgTWFwPHN0cmluZywgVWludDhBcnJheT4oKTtcbiAgICAgIFxuICAgICAgY29uc3QgcmVxdWVzdCA9IHN0b3JlLm9wZW5DdXJzb3IoKTtcbiAgICAgIHJlcXVlc3Qub25lcnJvciA9ICgpID0+IHJlamVjdChyZXF1ZXN0LmVycm9yKTtcbiAgICAgIHJlcXVlc3Qub25zdWNjZXNzID0gKGV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IGN1cnNvciA9IChldmVudC50YXJnZXQgYXMgSURCUmVxdWVzdCkucmVzdWx0O1xuICAgICAgICBpZiAoY3Vyc29yKSB7XG4gICAgICAgICAgY29uc3Qga2V5ID0gU3RyaW5nKGN1cnNvci5rZXkpO1xuICAgICAgICAgIGNvbnN0IGRhdGEgPSBuZXcgVWludDhBcnJheShjdXJzb3IudmFsdWUpO1xuICAgICAgICAgIG1hcC5zZXQoa2V5LCBkYXRhKTtcbiAgICAgICAgICBjdXJzb3IuY29udGludWUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXNvbHZlKG1hcCk7XG4gICAgICAgIH1cbiAgICAgIH07XG59KTtcbiAgIH1cblxuICBhc3luYyBnZXRTaXplKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgYXdhaXQgdGhpcy5lbnN1cmVJbml0KCk7XG4gICAgXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IHRyYW5zYWN0aW9uID0gdGhpcy5kYiEudHJhbnNhY3Rpb24oW3RoaXMuc3RvcmVOYW1lXSwgJ3JlYWRvbmx5Jyk7XG4gICAgICBjb25zdCBzdG9yZSA9IHRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKHRoaXMuc3RvcmVOYW1lKTtcbiAgICAgIGNvbnN0IHJlcXVlc3QgPSBzdG9yZS5jb3VudCgpO1xuICAgICAgXG4gICAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiByZWplY3QocmVxdWVzdC5lcnJvcik7XG4gICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9ICgpID0+IHJlc29sdmUocmVxdWVzdC5yZXN1bHQpO1xuICAgIH0pO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=