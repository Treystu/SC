{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/storage/blob-store.ts","mappings":"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","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/storage/blob-store.ts"],"sourcesContent":["import { sha256 } from \"@noble/hashes/sha2.js\";\n\nexport interface BlobPersistenceAdapter {\n  put(hash: string, data: Uint8Array): Promise<void>;\n  get(hash: string): Promise<Uint8Array | null>;\n  has(hash: string): Promise<boolean>;\n  delete(hash: string): Promise<void>;\n  clear(): Promise<void>;\n  getAll(): Promise<Map<string, Uint8Array>>;\n  getSize(): Promise<number>;\n}\n\nfunction hashData(data: Uint8Array): string {\n  const hash = sha256(data);\n  return Array.from(hash)\n    .map((b) => b.toString(16).padStart(2, \"0\"))\n    .join(\"\");\n}\n\n/**\n * BlobStore - Persistent Blob Storage with IndexedDB\n *\n * FEATURES:\n * - Persistent storage via IndexedDB (web) or FileSystem (mobile)\n * - Memory cache for fast access\n * - Automatic size tracking and quota management\n * - Recommended maximum file size: 10MB per blob\n * - Total storage limit: 100MB (configurable via maxTotalSize)\n * \n * SNEAKERNET RELAY SUPPORT:\n * - Messages and attachments persist across app restarts\n * - Critical for offline mesh relay nodes that store-and-forward\n * - Data survives phone reboots, enabling reliable sneakernet proxying\n *\n * For future enhancements, consider:\n *   - Adding blob expiration/garbage collection\n *   - Using external blob storage (CDN, S3, IPFS) for large files\n */\nexport class BlobStore {\n  private persistence?: BlobPersistenceAdapter;\n  private memoryStore: Map<string, Uint8Array> = new Map();\n\n  // Size limits for memory safety\n  private readonly MAX_BLOB_SIZE = 10 * 1024 * 1024; // 10MB per blob\n  private readonly MAX_TOTAL_SIZE = 100 * 1024 * 1024; // 100MB total\n  private currentTotalSize = 0;\n  private initialized = false;\n\n  constructor(persistence?: BlobPersistenceAdapter) {\n    this.persistence = persistence;\n  }\n\n  /**\n   * Initialize persistent storage and load size metrics\n   * Must be called before using the store\n   */\n  async init(): Promise<void> {\n    if (this.initialized) return;\n    \n    if (this.persistence) {\n      // Load all blobs from persistent storage into memory cache\n      const allBlobs = await this.persistence.getAll();\n      this.memoryStore = allBlobs;\n      \n      // Calculate current total size from persistent storage\n      this.currentTotalSize = 0;\n      for (const blob of allBlobs.values()) {\n        this.currentTotalSize += blob.length;\n      }\n    }\n    \n    this.initialized = true;\n  }\n\n  /**\n   * Store data and return its hash\n   * @throws Error if blob exceeds size limits\n   */\n  async put(data: Uint8Array): Promise<string> {\n    const blobSize = data.length;\n\n    // Validate blob size\n    if (blobSize > this.MAX_BLOB_SIZE) {\n      throw new Error(\n        `Blob size (${(blobSize / 1024 / 1024).toFixed(2)}MB) exceeds maximum allowed size (${this.MAX_BLOB_SIZE / 1024 / 1024}MB). ` +\n        `Consider compressing the file or using external storage for large files.`\n      );\n    }\n\n    // Check total storage limit\n    if (this.currentTotalSize + blobSize > this.MAX_TOTAL_SIZE) {\n      throw new Error(\n        `Total storage limit exceeded. Current: ${(this.currentTotalSize / 1024 / 1024).toFixed(2)}MB, ` +\n        `Attempting to add: ${(blobSize / 1024 / 1024).toFixed(2)}MB, ` +\n        `Max: ${this.MAX_TOTAL_SIZE / 1024 / 1024}MB. ` +\n        `Consider clearing old blobs or implementing persistent storage.`\n      );\n    }\n\n    const hash = hashData(data);\n\n    // Check if blob already exists (avoid double-counting size)\n    const existingBlob = this.memoryStore.get(hash);\n    if (existingBlob) {\n      // Blob already exists with same content, no size change needed\n      return hash;\n    }\n\n    // Add to total size since this is a new blob\n    this.currentTotalSize += blobSize;\n\n    // Store in memory first (for fast access)\n    this.memoryStore.set(hash, data);\n\n    // Store persistently if adapter is available\n    if (this.persistence) {\n      try {\n        await this.persistence.put(hash, data);\n      } catch (error) {\n        // If persistent storage fails, remove from memory store to maintain consistency\n        this.memoryStore.delete(hash);\n        this.currentTotalSize -= blobSize;\n        throw new Error(`Failed to persist blob: ${error}`);\n      }\n    }\n\n    return hash;\n  }\n\n  /**\n   * Retrieve data by hash\n   */\n  async get(hash: string): Promise<Uint8Array | undefined> {\n    const data = this.memoryStore.get(hash);\n    \n    if (data) {\n      return data;\n    }\n\n    if (this.persistence) {\n      const persistedData = await this.persistence.get(hash);\n      if (persistedData) {\n        this.memoryStore.set(hash, persistedData);\n        return persistedData;\n      }\n    }\n\n    return undefined;\n  }\n\n  /**\n   * Check if we have the blob\n   */\n  async has(hash: string): Promise<boolean> {\n    if (this.memoryStore.has(hash)) {\n      return true;\n    }\n\n    if (this.persistence) {\n      return await this.persistence.has(hash);\n    }\n\n    return false;\n  }\n\n  /**\n   * Get storage statistics\n   */\n  getStats(): {\n    blobCount: number;\n    totalSizeBytes: number;\n    totalSizeMB: number;\n    remainingBytes: number;\n    remainingMB: number;\n    utilizationPercent: number;\n  } {\n    return {\n      blobCount: this.memoryStore.size,\n      totalSizeBytes: this.currentTotalSize,\n      totalSizeMB: Number((this.currentTotalSize / 1024 / 1024).toFixed(2)),\n      remainingBytes: this.MAX_TOTAL_SIZE - this.currentTotalSize,\n      remainingMB: Number(((this.MAX_TOTAL_SIZE - this.currentTotalSize) / 1024 / 1024).toFixed(2)),\n      utilizationPercent: Number(((this.currentTotalSize / this.MAX_TOTAL_SIZE) * 100).toFixed(2)),\n    };\n  }\n\n  /**\n   * Clear all blobs (useful for testing or cleanup)\n   */\n  clear(): void {\n    this.memoryStore.clear();\n    this.currentTotalSize = 0;\n  }\n}\n\n/**\n * IndexedDB implementation of BlobPersistenceAdapter for web browsers\n */\nexport class IndexedDBBlobAdapter implements BlobPersistenceAdapter {\n  private dbName = 'BlobStorage';\n  private storeName = 'blobs';\n  private db: IDBDatabase | null = null;\n  private version = 1;\n\n  async init(): Promise<void> {\n    if (this.db) return;\n\n    return new Promise((resolve, reject) => {\n      const request = indexedDB.open(this.dbName, this.version);\n      \n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => {\n        this.db = request.result;\n        resolve();\n      };\n      \n      request.onupgradeneeded = (event) => {\n        const db = (event.target as IDBOpenDBRequest).result;\n        if (!db.objectStoreNames.contains(this.storeName)) {\n          db.createObjectStore(this.storeName);\n        }\n      };\n    });\n  }\n\n  private async ensureInit(): Promise<void> {\n    if (!this.db) {\n      await this.init();\n    }\n  }\n\n  async put(hash: string, data: Uint8Array): Promise<void> {\n    await this.ensureInit();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction([this.storeName], 'readwrite');\n      const store = transaction.objectStore(this.storeName);\n      const request = store.put(data, hash);\n      \n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve();\n    });\n  }\n\n  async get(hash: string): Promise<Uint8Array | null> {\n    await this.ensureInit();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction([this.storeName], 'readonly');\n      const store = transaction.objectStore(this.storeName);\n      const request = store.get(hash);\n      \n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => {\n        const result = request.result;\n        resolve(result ? new Uint8Array(result) : null);\n      };\n    });\n  }\n\n  async has(hash: string): Promise<boolean> {\n    await this.ensureInit();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction([this.storeName], 'readonly');\n      const store = transaction.objectStore(this.storeName);\n      const request = store.count(hash);\n      \n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve(request.result > 0);\n    });\n  }\n\n  async delete(hash: string): Promise<void> {\n    await this.ensureInit();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction([this.storeName], 'readwrite');\n      const store = transaction.objectStore(this.storeName);\n      const request = store.delete(hash);\n      \n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve();\n    });\n  }\n\n  async clear(): Promise<void> {\n    await this.ensureInit();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction([this.storeName], 'readwrite');\n      const store = transaction.objectStore(this.storeName);\n      const request = store.clear();\n      \n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve();\n    });\n  }\n\nasync getAll(): Promise<Map<string, Uint8Array>> {\n    await this.ensureInit();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction([this.storeName], 'readonly');\n      const store = transaction.objectStore(this.storeName);\n      const map = new Map<string, Uint8Array>();\n      \n      const request = store.openCursor();\n      request.onerror = () => reject(request.error);\n      request.onsuccess = (event) => {\n        const cursor = (event.target as IDBRequest).result;\n        if (cursor) {\n          const key = String(cursor.key);\n          const data = new Uint8Array(cursor.value);\n          map.set(key, data);\n          cursor.continue();\n        } else {\n          resolve(map);\n        }\n      };\n});\n   }\n\n  async getSize(): Promise<number> {\n    await this.ensureInit();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db!.transaction([this.storeName], 'readonly');\n      const store = transaction.objectStore(this.storeName);\n      const request = store.count();\n      \n      request.onerror = () => reject(request.error);\n      request.onsuccess = () => resolve(request.result);\n    });\n  }\n}\n"],"version":3}