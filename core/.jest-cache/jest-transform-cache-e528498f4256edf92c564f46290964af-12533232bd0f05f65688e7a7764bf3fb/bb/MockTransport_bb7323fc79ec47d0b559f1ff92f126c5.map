{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/transport/__mocks__/MockTransport.ts","mappings":";AAAA;;;;;;;;;;;GAWG;;;AA6VH,4CAEC;AAKD,kDAEC;AAzUD;;GAEG;AACH,MAAM,mBAAmB,GAAwC,IAAI,GAAG,EAAE,CAAC;AAE3E;;GAEG;AACH,MAAa,aAAa;IAexB,YAAY,WAA4B,EAAE,SAA8B,EAAE;QAbjE,SAAI,GAAG,MAAM,CAAC;QAGf,WAAM,GAA2B,IAAI,CAAC;QACtC,UAAK,GAA4C,IAAI,GAAG,EAAE,CAAC;QAC3D,cAAS,GAAG,KAAK,CAAC;QAE1B,+BAA+B;QACxB,iBAAY,GAAuB,EAAE,CAAC;QACtC,qBAAgB,GAAuB,EAAE,CAAC;QAC1C,uBAAkB,GAAsB,EAAE,CAAC;QAC3C,0BAAqB,GAAsB,EAAE,CAAC;QAGnD,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;QAC/B,IAAI,CAAC,MAAM,GAAG;YACZ,SAAS,EAAE,CAAC;YACZ,cAAc,EAAE,CAAC;YACjB,iBAAiB,EAAE,CAAC;YACpB,eAAe,EAAE,KAAK;YACtB,SAAS,EAAE,KAAK;YAChB,GAAG,MAAM;SACV,CAAC;IACJ,CAAC;IAED;;OAEG;IACK,iBAAiB;QACvB,mBAAmB,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;IAClD,CAAC;IAED;;OAEG;IACK,qBAAqB;QAC3B,mBAAmB,CAAC,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAC/C,CAAC;IAED;;OAEG;IACK,KAAK,CAAC,eAAe;QAC3B,IAAI,IAAI,CAAC,MAAM,CAAC,SAAS,IAAI,IAAI,CAAC,MAAM,CAAC,SAAS,GAAG,CAAC,EAAE,CAAC;YACvD,MAAM,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE,CAC5B,UAAU,CAAC,OAAO,EAAE,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,CAC3C,CAAC;QACJ,CAAC;IACH,CAAC;IAED;;OAEG;IACK,iBAAiB;QACvB,MAAM,QAAQ,GAAG,IAAI,CAAC,MAAM,CAAC,cAAc,IAAI,CAAC,CAAC;QACjD,OAAO,IAAI,CAAC,MAAM,EAAE,GAAG,QAAQ,CAAC;IAClC,CAAC;IAED,KAAK,CAAC,KAAK,CAAC,MAAuB;QACjC,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;QACtB,IAAI,CAAC,iBAAiB,EAAE,CAAC;IAC3B,CAAC;IAED,KAAK,CAAC,IAAI;QACR,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;QACvB,IAAI,CAAC,qBAAqB,EAAE,CAAC;QAE7B,qFAAqF;QACrF,MAAM,OAAO,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,CAAC,CAAC;QAC9C,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE,CAAC;YAC7B,MAAM,IAAI,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC;QAChC,CAAC;QAED,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;IACrB,CAAC;IAED,KAAK,CAAC,OAAO,CACX,MAAuB,EACvB,cAA8B;QAE9B,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAErC,IAAI,IAAI,CAAC,MAAM,CAAC,eAAe,EAAE,CAAC;YAChC,MAAM,KAAK,GAAG,IAAI,KAAK,CAAC,iBAAiB,MAAM,wBAAwB,CAAC,CAAC;YACzE,IAAI,CAAC,MAAM,EAAE,OAAO,EAAE,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;YACtC,MAAM,KAAK,CAAC;QACd,CAAC;QAED,4BAA4B;QAC5B,IAAI,IAAI,CAAC,MAAM,CAAC,iBAAiB,IAAI,IAAI,CAAC,MAAM,CAAC,iBAAiB,GAAG,CAAC,EAAE,CAAC;YACvE,MAAM,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE,CAC5B,UAAU,CAAC,OAAO,EAAE,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,CACnD,CAAC;QACJ,CAAC;QAED,6BAA6B;QAC7B,IAAI,CAAC,MAAM,EAAE,aAAa,EAAE,CAAC,MAAM,EAAE,YAAY,CAAC,CAAC;QAEnD,mBAAmB;QACnB,MAAM,QAAQ,GAAsB;YAClC,MAAM;YACN,KAAK,EAAE,WAAW;YAClB,aAAa,EAAE,MAAM;YACrB,iBAAiB,EAAE,GAAG;YACtB,SAAS,EAAE,CAAC;YACZ,aAAa,EAAE,CAAC;YAChB,QAAQ,EAAE,IAAI,CAAC,GAAG,EAAE;SACrB,CAAC;QAEF,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;QAEjC,yBAAyB;QACzB,IAAI,CAAC,MAAM,EAAE,eAAe,EAAE,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;QACjD,IAAI,CAAC,MAAM,EAAE,aAAa,EAAE,CAAC,MAAM,EAAE,WAAW,CAAC,CAAC;QAElD,+EAA+E;QAC/E,MAAM,UAAU,GAAG,mBAAmB,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACnD,IACE,UAAU;YACV,UAAU,KAAK,IAAI;YACnB,CAAC,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,EACvC,CAAC;YACD,MAAM,UAAU,CAAC,wBAAwB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QAC9D,CAAC;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,wBAAwB,CAAC,YAA6B;QAC1D,IAAI,IAAI,CAAC,MAAM,CAAC,eAAe,EAAE,CAAC;YAChC,OAAO;QACT,CAAC;QAED,MAAM,QAAQ,GAAsB;YAClC,MAAM,EAAE,YAAY;YACpB,KAAK,EAAE,WAAW;YAClB,aAAa,EAAE,MAAM;YACrB,iBAAiB,EAAE,GAAG;YACtB,SAAS,EAAE,CAAC;YACZ,aAAa,EAAE,CAAC;YAChB,QAAQ,EAAE,IAAI,CAAC,GAAG,EAAE;SACrB,CAAC;QAEF,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,YAAY,EAAE,QAAQ,CAAC,CAAC;QACvC,IAAI,CAAC,MAAM,EAAE,eAAe,EAAE,CAAC,YAAY,EAAE,QAAQ,CAAC,CAAC;QACvD,IAAI,CAAC,MAAM,EAAE,aAAa,EAAE,CAAC,YAAY,EAAE,WAAW,CAAC,CAAC;IAC1D,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,MAAuB;QACtC,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAExC,MAAM,QAAQ,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACxC,IAAI,QAAQ,EAAE,CAAC;YACb,QAAQ,CAAC,KAAK,GAAG,cAAc,CAAC;YAChC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;YAC1B,IAAI,CAAC,MAAM,EAAE,kBAAkB,EAAE,CAAC,MAAM,CAAC,CAAC;YAC1C,IAAI,CAAC,MAAM,EAAE,aAAa,EAAE,CAAC,MAAM,EAAE,cAAc,CAAC,CAAC;QACvD,CAAC;QAED,sCAAsC;QACtC,MAAM,UAAU,GAAG,mBAAmB,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACnD,IAAI,UAAU,IAAI,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,WAAW,CAAC,EAAE,CAAC;YACzD,UAAU,CAAC,yBAAyB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACzD,CAAC;IACH,CAAC;IAED;;OAEG;IACH,yBAAyB,CAAC,YAA6B;QACrD,MAAM,QAAQ,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;QAC9C,IAAI,QAAQ,EAAE,CAAC;YACb,QAAQ,CAAC,KAAK,GAAG,cAAc,CAAC;YAChC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;YAChC,IAAI,CAAC,MAAM,EAAE,kBAAkB,EAAE,CAAC,YAAY,CAAC,CAAC;YAChD,IAAI,CAAC,MAAM,EAAE,aAAa,EAAE,CAAC,YAAY,EAAE,cAAc,CAAC,CAAC;QAC7D,CAAC;IACH,CAAC;IAED,KAAK,CAAC,IAAI,CAAC,MAAuB,EAAE,OAAmB;QACrD,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC;YACpB,MAAM,IAAI,KAAK,CAAC,0BAA0B,CAAC,CAAC;QAC9C,CAAC;QAED,IAAI,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE,CAAC;YAC1B,MAAM,KAAK,GAAG,IAAI,KAAK,CAAC,WAAW,MAAM,wBAAwB,CAAC,CAAC;YACnE,IAAI,CAAC,MAAM,EAAE,OAAO,EAAE,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;YACtC,MAAM,KAAK,CAAC;QACd,CAAC;QAED,MAAM,QAAQ,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACxC,IAAI,CAAC,QAAQ,IAAI,QAAQ,CAAC,KAAK,KAAK,WAAW,EAAE,CAAC;YAChD,MAAM,IAAI,KAAK,CAAC,QAAQ,MAAM,mBAAmB,CAAC,CAAC;QACrD,CAAC;QAED,MAAM,OAAO,GAAqB;YAChC,IAAI,EAAE,IAAI,CAAC,WAAW;YACtB,EAAE,EAAE,MAAM;YACV,OAAO,EAAE,OAAO;YAChB,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;SACtB,CAAC;QAEF,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAEhC,oBAAoB;QACpB,QAAQ,CAAC,SAAS,GAAG,CAAC,QAAQ,CAAC,SAAS,IAAI,CAAC,CAAC,GAAG,OAAO,CAAC,MAAM,CAAC;QAEhE,uBAAuB;QACvB,IAAI,IAAI,CAAC,iBAAiB,EAAE,EAAE,CAAC;YAC7B,OAAO,CAAC,oBAAoB;QAC9B,CAAC;QAED,mBAAmB;QACnB,MAAM,IAAI,CAAC,eAAe,EAAE,CAAC;QAE7B,yBAAyB;QACzB,MAAM,UAAU,GAAG,mBAAmB,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACnD,IAAI,UAAU,EAAE,CAAC;YACf,UAAU,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC;QACrC,CAAC;IACH,CAAC;IAED;;OAEG;IACH,cAAc,CAAC,OAAyB;QACtC,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC;YACpB,OAAO;QACT,CAAC;QAED,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAEpC,wBAAwB;QACxB,MAAM,QAAQ,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;QAC9C,IAAI,QAAQ,EAAE,CAAC;YACb,QAAQ,CAAC,aAAa;gBACpB,CAAC,QAAQ,CAAC,aAAa,IAAI,CAAC,CAAC,GAAG,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC;YACzD,QAAQ,CAAC,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACjC,CAAC;QAED,mBAAmB;QACnB,IAAI,CAAC,MAAM,EAAE,SAAS,CAAC,OAAO,CAAC,CAAC;IAClC,CAAC;IAED,KAAK,CAAC,SAAS,CACb,OAAmB,EACnB,aAA+B;QAE/B,MAAM,QAAQ,GAAoB,EAAE,CAAC;QAErC,KAAK,MAAM,MAAM,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,EAAE,CAAC;YACvC,IAAI,MAAM,KAAK,aAAa,EAAE,CAAC;gBAC7B,QAAQ,CAAC,IAAI,CACX,IAAI,CAAC,IAAI,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC,KAAK,CAAC,GAAG,EAAE;oBACpC,mDAAmD;gBACrD,CAAC,CAAC,CACH,CAAC;YACJ,CAAC;QACH,CAAC;QAED,MAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;IAC9B,CAAC;IAED,iBAAiB;QACf,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;aACpC,MAAM,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,KAAK,KAAK,WAAW,CAAC;aACjD,GAAG,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,EAAE,CAAC,MAAM,CAAC,CAAC;IAC/B,CAAC;IAED,WAAW,CAAC,MAAuB;QACjC,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;IAChC,CAAC;IAED,kBAAkB,CAChB,MAAuB;QAEvB,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,KAAK,CAAC;IACvC,CAAC;IAED;;OAEG;IACH,aAAa;QACX,IAAI,CAAC,YAAY,GAAG,EAAE,CAAC;QACvB,IAAI,CAAC,gBAAgB,GAAG,EAAE,CAAC;QAC3B,IAAI,CAAC,kBAAkB,GAAG,EAAE,CAAC;QAC7B,IAAI,CAAC,qBAAqB,GAAG,EAAE,CAAC;IAClC,CAAC;IAED;;OAEG;IACH,YAAY,CAAC,MAAoC;QAC/C,IAAI,CAAC,MAAM,GAAG,EAAE,GAAG,IAAI,CAAC,MAAM,EAAE,GAAG,MAAM,EAAE,CAAC;IAC9C,CAAC;IAED;;OAEG;IACH,kBAAkB;QAChB,OAAO,IAAI,CAAC,SAAS,CAAC;IACxB,CAAC;CACF;AAlTD,sCAkTC;AAED;;;GAGG;AACH,SAAgB,gBAAgB;IAC9B,mBAAmB,CAAC,KAAK,EAAE,CAAC;AAC9B,CAAC;AAED;;GAEG;AACH,SAAgB,mBAAmB;IACjC,OAAO,KAAK,CAAC,IAAI,CAAC,mBAAmB,CAAC,IAAI,EAAE,CAAC,CAAC;AAChD,CAAC","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/transport/__mocks__/MockTransport.ts"],"sourcesContent":["/**\n * MockTransport - A mock implementation of the Transport interface for testing.\n *\n * This mock transport simulates peer-to-peer communication in memory,\n * allowing unit and integration tests to run without actual network connectivity.\n *\n * Features:\n * - Simulates latency and message delivery\n * - Tracks sent/received messages for test assertions\n * - Supports multiple mock transport instances connected together\n * - Configurable failure modes for testing error handling\n */\n\nimport {\n  Transport,\n  TransportPeerId,\n  TransportMessage,\n  TransportEvents,\n  TransportConfig,\n  TransportPeerInfo,\n  TransportConnectionState,\n  SignalingData,\n} from \"../Transport.js\";\n\n/**\n * Configuration options specific to MockTransport.\n */\nexport interface MockTransportConfig extends TransportConfig {\n  /** Simulated latency in milliseconds (default: 0) */\n  latencyMs?: number;\n  /** Probability of message loss (0-1, default: 0) */\n  packetLossRate?: number;\n  /** Simulated connection delay in milliseconds (default: 0) */\n  connectionDelayMs?: number;\n  /** If true, connections will fail */\n  failConnections?: boolean;\n  /** If true, message sends will fail */\n  failSends?: boolean;\n}\n\n/**\n * Shared registry of MockTransport instances for simulating a network.\n */\nconst mockNetworkRegistry: Map<TransportPeerId, MockTransport> = new Map();\n\n/**\n * MockTransport implementation for testing purposes.\n */\nexport class MockTransport implements Transport {\n  readonly localPeerId: TransportPeerId;\n  readonly name = \"mock\";\n\n  private config: MockTransportConfig;\n  private events: TransportEvents | null = null;\n  private peers: Map<TransportPeerId, TransportPeerInfo> = new Map();\n  private isRunning = false;\n\n  // Tracking for test assertions\n  public sentMessages: TransportMessage[] = [];\n  public receivedMessages: TransportMessage[] = [];\n  public connectionAttempts: TransportPeerId[] = [];\n  public disconnectionAttempts: TransportPeerId[] = [];\n\n  constructor(localPeerId: TransportPeerId, config: MockTransportConfig = {}) {\n    this.localPeerId = localPeerId;\n    this.config = {\n      latencyMs: 0,\n      packetLossRate: 0,\n      connectionDelayMs: 0,\n      failConnections: false,\n      failSends: false,\n      ...config,\n    };\n  }\n\n  /**\n   * Register this transport in the mock network for cross-instance communication.\n   */\n  private registerInNetwork(): void {\n    mockNetworkRegistry.set(this.localPeerId, this);\n  }\n\n  /**\n   * Unregister this transport from the mock network.\n   */\n  private unregisterFromNetwork(): void {\n    mockNetworkRegistry.delete(this.localPeerId);\n  }\n\n  /**\n   * Simulate message delivery with optional latency.\n   */\n  private async simulateLatency(): Promise<void> {\n    if (this.config.latencyMs && this.config.latencyMs > 0) {\n      await new Promise((resolve) =>\n        setTimeout(resolve, this.config.latencyMs),\n      );\n    }\n  }\n\n  /**\n   * Check if a message should be dropped due to simulated packet loss.\n   */\n  private shouldDropMessage(): boolean {\n    const lossRate = this.config.packetLossRate || 0;\n    return Math.random() < lossRate;\n  }\n\n  async start(events: TransportEvents): Promise<void> {\n    this.events = events;\n    this.isRunning = true;\n    this.registerInNetwork();\n  }\n\n  async stop(): Promise<void> {\n    this.isRunning = false;\n    this.unregisterFromNetwork();\n\n    // Disconnect all peers - create snapshot of keys to avoid modifying during iteration\n    const peerIds = Array.from(this.peers.keys());\n    for (const peerId of peerIds) {\n      await this.disconnect(peerId);\n    }\n\n    this.events = null;\n  }\n\n  async connect(\n    peerId: TransportPeerId,\n    _signalingData?: SignalingData,\n  ): Promise<void> {\n    this.connectionAttempts.push(peerId);\n\n    if (this.config.failConnections) {\n      const error = new Error(`Connection to ${peerId} failed (mock failure)`);\n      this.events?.onError?.(error, peerId);\n      throw error;\n    }\n\n    // Simulate connection delay\n    if (this.config.connectionDelayMs && this.config.connectionDelayMs > 0) {\n      await new Promise((resolve) =>\n        setTimeout(resolve, this.config.connectionDelayMs),\n      );\n    }\n\n    // Update state to connecting\n    this.events?.onStateChange?.(peerId, \"connecting\");\n\n    // Create peer info\n    const peerInfo: TransportPeerInfo = {\n      peerId,\n      state: \"connected\",\n      transportType: \"mock\",\n      connectionQuality: 100,\n      bytesSent: 0,\n      bytesReceived: 0,\n      lastSeen: Date.now(),\n    };\n\n    this.peers.set(peerId, peerInfo);\n\n    // Notify peer connection\n    this.events?.onPeerConnected?.(peerId, peerInfo);\n    this.events?.onStateChange?.(peerId, \"connected\");\n\n    // If the remote peer exists in the network, establish bidirectional connection\n    const remotePeer = mockNetworkRegistry.get(peerId);\n    if (\n      remotePeer &&\n      remotePeer !== this &&\n      !remotePeer.peers.has(this.localPeerId)\n    ) {\n      await remotePeer.handleIncomingConnection(this.localPeerId);\n    }\n  }\n\n  /**\n   * Handle an incoming connection from another MockTransport.\n   */\n  async handleIncomingConnection(remotePeerId: TransportPeerId): Promise<void> {\n    if (this.config.failConnections) {\n      return;\n    }\n\n    const peerInfo: TransportPeerInfo = {\n      peerId: remotePeerId,\n      state: \"connected\",\n      transportType: \"mock\",\n      connectionQuality: 100,\n      bytesSent: 0,\n      bytesReceived: 0,\n      lastSeen: Date.now(),\n    };\n\n    this.peers.set(remotePeerId, peerInfo);\n    this.events?.onPeerConnected?.(remotePeerId, peerInfo);\n    this.events?.onStateChange?.(remotePeerId, \"connected\");\n  }\n\n  async disconnect(peerId: TransportPeerId): Promise<void> {\n    this.disconnectionAttempts.push(peerId);\n\n    const peerInfo = this.peers.get(peerId);\n    if (peerInfo) {\n      peerInfo.state = \"disconnected\";\n      this.peers.delete(peerId);\n      this.events?.onPeerDisconnected?.(peerId);\n      this.events?.onStateChange?.(peerId, \"disconnected\");\n    }\n\n    // Notify the remote peer if it exists\n    const remotePeer = mockNetworkRegistry.get(peerId);\n    if (remotePeer && remotePeer.peers.has(this.localPeerId)) {\n      remotePeer.handleRemoteDisconnection(this.localPeerId);\n    }\n  }\n\n  /**\n   * Handle disconnection initiated by a remote peer.\n   */\n  handleRemoteDisconnection(remotePeerId: TransportPeerId): void {\n    const peerInfo = this.peers.get(remotePeerId);\n    if (peerInfo) {\n      peerInfo.state = \"disconnected\";\n      this.peers.delete(remotePeerId);\n      this.events?.onPeerDisconnected?.(remotePeerId);\n      this.events?.onStateChange?.(remotePeerId, \"disconnected\");\n    }\n  }\n\n  async send(peerId: TransportPeerId, payload: Uint8Array): Promise<void> {\n    if (!this.isRunning) {\n      throw new Error(\"Transport is not running\");\n    }\n\n    if (this.config.failSends) {\n      const error = new Error(`Send to ${peerId} failed (mock failure)`);\n      this.events?.onError?.(error, peerId);\n      throw error;\n    }\n\n    const peerInfo = this.peers.get(peerId);\n    if (!peerInfo || peerInfo.state !== \"connected\") {\n      throw new Error(`Peer ${peerId} is not connected`);\n    }\n\n    const message: TransportMessage = {\n      from: this.localPeerId,\n      to: peerId,\n      payload: payload,\n      timestamp: Date.now(),\n    };\n\n    this.sentMessages.push(message);\n\n    // Update bytes sent\n    peerInfo.bytesSent = (peerInfo.bytesSent || 0) + payload.length;\n\n    // Simulate packet loss\n    if (this.shouldDropMessage()) {\n      return; // Message is \"lost\"\n    }\n\n    // Simulate latency\n    await this.simulateLatency();\n\n    // Deliver to remote peer\n    const remotePeer = mockNetworkRegistry.get(peerId);\n    if (remotePeer) {\n      remotePeer.receiveMessage(message);\n    }\n  }\n\n  /**\n   * Handle receiving a message from another MockTransport.\n   */\n  receiveMessage(message: TransportMessage): void {\n    if (!this.isRunning) {\n      return;\n    }\n\n    this.receivedMessages.push(message);\n\n    // Update bytes received\n    const peerInfo = this.peers.get(message.from);\n    if (peerInfo) {\n      peerInfo.bytesReceived =\n        (peerInfo.bytesReceived || 0) + message.payload.length;\n      peerInfo.lastSeen = Date.now();\n    }\n\n    // Notify listeners\n    this.events?.onMessage(message);\n  }\n\n  async broadcast(\n    payload: Uint8Array,\n    excludePeerId?: TransportPeerId,\n  ): Promise<void> {\n    const promises: Promise<void>[] = [];\n\n    for (const peerId of this.peers.keys()) {\n      if (peerId !== excludePeerId) {\n        promises.push(\n          this.send(peerId, payload).catch(() => {\n            // Ignore individual send failures during broadcast\n          }),\n        );\n      }\n    }\n\n    await Promise.all(promises);\n  }\n\n  getConnectedPeers(): TransportPeerId[] {\n    return Array.from(this.peers.entries())\n      .filter(([_, info]) => info.state === \"connected\")\n      .map(([peerId]) => peerId);\n  }\n\n  getPeerInfo(peerId: TransportPeerId): TransportPeerInfo | undefined {\n    return this.peers.get(peerId);\n  }\n\n  getConnectionState(\n    peerId: TransportPeerId,\n  ): TransportConnectionState | undefined {\n    return this.peers.get(peerId)?.state;\n  }\n\n  /**\n   * Reset tracking data for test assertions.\n   */\n  resetTracking(): void {\n    this.sentMessages = [];\n    this.receivedMessages = [];\n    this.connectionAttempts = [];\n    this.disconnectionAttempts = [];\n  }\n\n  /**\n   * Update mock configuration at runtime (useful for testing error scenarios).\n   */\n  updateConfig(config: Partial<MockTransportConfig>): void {\n    this.config = { ...this.config, ...config };\n  }\n\n  /**\n   * Check if transport is currently running.\n   */\n  isTransportRunning(): boolean {\n    return this.isRunning;\n  }\n}\n\n/**\n * Clear the global mock network registry.\n * Call this in test teardown to ensure clean state between tests.\n */\nexport function clearMockNetwork(): void {\n  mockNetworkRegistry.clear();\n}\n\n/**\n * Get all registered mock transports (for debugging/testing).\n */\nexport function getMockNetworkPeers(): TransportPeerId[] {\n  return Array.from(mockNetworkRegistry.keys());\n}\n"],"version":3}