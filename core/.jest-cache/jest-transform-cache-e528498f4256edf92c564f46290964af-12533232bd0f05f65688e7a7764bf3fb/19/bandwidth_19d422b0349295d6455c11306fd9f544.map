{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/bandwidth.ts","mappings":"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","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/bandwidth.ts"],"sourcesContent":["/**\n * Bandwidth-Aware Message Scheduling (Task 22)\n * \n * Implements adaptive bandwidth management and message scheduling\n * based on available network capacity, message priority, and congestion control.\n */\n\nexport enum BandwidthPriority {\n  CRITICAL = 0,  // Control messages, heartbeats\n  HIGH = 1,      // Voice messages\n  MEDIUM = 2,    // Text messages\n  LOW = 3        // File transfers\n}\n\nexport interface BandwidthMetrics {\n  availableBandwidth: number; // bytes per second\n  utilizationPercent: number;\n  queuedMessages: number;\n  messagesPerSecond: number;\n  averageLatency: number;\n  packetLoss: number;\n}\n\nexport interface ScheduledMessage {\n  id: string;\n  payload: Uint8Array;\n  priority: BandwidthPriority;\n  timestamp: number;\n  retries: number;\n  deadline?: number; // Optional delivery deadline\n}\n\nexport class BandwidthScheduler {\n  private queue: ScheduledMessage[] = [];\n  private metrics: BandwidthMetrics = {\n    availableBandwidth: 1_000_000, // 1 Mbps default\n    utilizationPercent: 0,\n    queuedMessages: 0,\n    messagesPerSecond: 0,\n    averageLatency: 0,\n    packetLoss: 0\n  };\n\n  private readonly MAX_QUEUE_SIZE = 1000;\n  private readonly CONGESTION_THRESHOLD = 0.8; // 80% utilization\n  private readonly MAX_RETRY_ATTEMPTS = 5;\n  private sendingRate = 0;\n  private lastSendTime = Date.now();\n  private sendingWindow: number[] = [];\n\n  /**\n   * Schedule a message for transmission\n   */\n  scheduleMessage(message: Omit<ScheduledMessage, 'timestamp' | 'retries'>): boolean {\n    if (this.queue.length >= this.MAX_QUEUE_SIZE) {\n      // Queue full - drop lowest priority message if new message has higher priority\n      const lowestPriority = Math.max(...this.queue.map(m => m.priority));\n      if (message.priority < lowestPriority) {\n        const idx = this.queue.findIndex(m => m.priority === lowestPriority);\n        this.queue.splice(idx, 1);\n      } else {\n        return false; // Cannot schedule\n      }\n    }\n\n    const scheduledMessage: ScheduledMessage = {\n      ...message,\n      timestamp: Date.now(),\n      retries: 0\n    };\n\n    this.queue.push(scheduledMessage);\n    this.sortQueue();\n    this.metrics.queuedMessages = this.queue.length;\n\n    return true;\n  }\n\n  /**\n   * Get next message to send based on priority and bandwidth availability\n   */\n  getNextMessage(): ScheduledMessage | null {\n    if (this.queue.length === 0) {\n      return null;\n    }\n\n    // Check if we're under congestion\n    if (this.isCongested()) {\n      // Only send critical messages during congestion\n      const critical = this.queue.find(m => m.priority === BandwidthPriority.CRITICAL);\n      if (critical) {\n        this.removeMessage(critical.id);\n        return critical;\n      }\n      return null;\n    }\n\n    // Check bandwidth capacity\n    const bytesPerSecond = this.estimateSendingRate();\n    if (bytesPerSecond >= this.metrics.availableBandwidth) {\n      return null; // At capacity\n    }\n\n    // Get highest priority message that fits in remaining bandwidth\n    const remainingBandwidth = this.metrics.availableBandwidth - bytesPerSecond;\n    \n    for (const message of this.queue) {\n      if (message.payload.byteLength <= remainingBandwidth) {\n        this.removeMessage(message.id);\n        return message;\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Update bandwidth metrics based on network measurements\n   */\n  updateMetrics(metrics: Partial<BandwidthMetrics>): void {\n    this.metrics = {\n      ...this.metrics,\n      ...metrics\n    };\n\n    // Adjust scheduling strategy based on metrics\n    if (metrics.packetLoss && metrics.packetLoss > 0.05) {\n      // High packet loss - reduce sending rate\n      this.metrics.availableBandwidth *= 0.8;\n    } else if (metrics.utilizationPercent && metrics.utilizationPercent < 0.5) {\n      // Low utilization - can increase rate\n      this.metrics.availableBandwidth *= 1.1;\n    }\n  }\n\n  /**\n   * Record successful message transmission\n   */\n  recordSend(_messageSize: number): void {\n    const now = Date.now();\n    this.sendingWindow.push(now);\n    \n    // Keep only last 10 seconds of data\n    this.sendingWindow = this.sendingWindow.filter(t => now - t < 10000);\n    \n    this.lastSendTime = now;\n    this.updateSendingRate();\n  }\n\n  /**\n   * Get current bandwidth metrics\n   */\n  getMetrics(): BandwidthMetrics {\n    return { ...this.metrics };\n  }\n\n  /**\n   * Check if network is congested\n   */\n  private isCongested(): boolean {\n    return this.metrics.utilizationPercent > this.CONGESTION_THRESHOLD ||\n           this.metrics.packetLoss > 0.1 ||\n           this.queue.length > this.MAX_QUEUE_SIZE * 0.9;\n  }\n\n  /**\n   * Sort queue by priority and deadline\n   */\n  private sortQueue(): void {\n    this.queue.sort((a, b) => {\n      // First by priority\n      if (a.priority !== b.priority) {\n        return a.priority - b.priority;\n      }\n\n      // Then by deadline (if set)\n      if (a.deadline && b.deadline) {\n        return a.deadline - b.deadline;\n      }\n\n      // Finally by timestamp (FIFO within same priority)\n      return a.timestamp - b.timestamp;\n    });\n  }\n\n  /**\n   * Remove message from queue\n   */\n  private removeMessage(id: string): void {\n    const idx = this.queue.findIndex(m => m.id === id);\n    if (idx !== -1) {\n      this.queue.splice(idx, 1);\n      this.metrics.queuedMessages = this.queue.length;\n    }\n  }\n\n  /**\n   * Estimate current sending rate\n   */\n  private estimateSendingRate(): number {\n    if (this.sendingWindow.length < 2) {\n      return 0;\n    }\n\n    const now = Date.now();\n    const messagesInWindow = this.sendingWindow.filter(t => now - t < 1000);\n    return messagesInWindow.length;\n  }\n\n  /**\n   * Update internal sending rate metric\n   */\n  private updateSendingRate(): void {\n    this.sendingRate = this.estimateSendingRate();\n    this.metrics.messagesPerSecond = this.sendingRate;\n\n    const bytesPerMessage = this.queue.length > 0\n      ? this.queue.reduce((sum, m) => sum + m.payload.byteLength, 0) / this.queue.length\n      : 1000; // Assume 1KB average\n\n    const currentBytesPerSecond = this.sendingRate * bytesPerMessage;\n    this.metrics.utilizationPercent = currentBytesPerSecond / this.metrics.availableBandwidth;\n  }\n\n  /**\n   * Clean up expired messages\n   */\n  cleanupExpired(): number {\n    const now = Date.now();\n    const before = this.queue.length;\n\n    this.queue = this.queue.filter(m => {\n      if (!m.deadline) {\n        return true;\n      }\n      return m.deadline > now;\n    });\n\n    const removed = before - this.queue.length;\n    this.metrics.queuedMessages = this.queue.length;\n\n    return removed;\n  }\n\n  /**\n   * Update available bandwidth estimate\n   */\n  updateBandwidth(bandwidth: number): void {\n    this.metrics.availableBandwidth = bandwidth;\n  }\n\n  /**\n   * Schedule a message for retry\n   */\n  scheduleRetry(message: ScheduledMessage): boolean {\n    const retryMessage: ScheduledMessage = {\n      ...message,\n      retries: message.retries + 1,\n      timestamp: Date.now()\n    };\n\n    // Limit retry attempts\n    if (retryMessage.retries > this.MAX_RETRY_ATTEMPTS) {\n      return false;\n    }\n\n    return this.scheduleMessage(retryMessage);\n  }\n\n  /**\n   * Clear all messages from queue\n   */\n  clearQueue(): void {\n    this.queue = [];\n    this.metrics.queuedMessages = 0;\n  }\n\n  /**\n   * Get queue length\n   */\n  getQueueLength(): number {\n    return this.queue.length;\n  }\n\n  /**\n   * Check if queue is empty\n   */\n  isEmpty(): boolean {\n    return this.queue.length === 0;\n  }\n\n  /**\n   * Check if queue is full\n   */\n  isFull(): boolean {\n    return this.queue.length >= this.MAX_QUEUE_SIZE;\n  }\n}\n\n/**\n * Factory function for creating bandwidth scheduler\n */\nexport function createBandwidthScheduler(\n  initialBandwidth: number = 1_000_000\n): BandwidthScheduler {\n  const scheduler = new BandwidthScheduler();\n  scheduler.updateMetrics({ availableBandwidth: initialBandwidth });\n  return scheduler;\n}\n"],"version":3}