{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/protocol/message.ts","mappings":"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","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/protocol/message.ts"],"sourcesContent":["/**\n * Binary Message Format for Sovereign Communications\n *\n * Wire Protocol Documentation:\n * ===========================\n *\n * Endianness: All multi-byte integers use Big Endian (network byte order)\n *\n * Header Structure (fixed 108 bytes):\n * Offset | Size | Field      | Description\n * -------|------|------------|------------------------------------------\n * 0      | 1    | Version    | Protocol version (current: 0x01)\n * 1      | 1    | Type       | Message type (see MessageType enum)\n * 2      | 1    | TTL        | Time-to-live for mesh routing (max: 255)\n * 3      | 1    | Reserved   | Reserved for future use (must be 0x00)\n * 4      | 8    | Timestamp  | Unix timestamp in milliseconds (big-endian)\n * 12     | 32   | Sender ID  | Ed25519 public key of sender\n * 44     | 64   | Signature  | Compact Ed25519 signature of message\n *\n * Body:\n * - Encrypted payload (variable length, max: MAX_PAYLOAD_SIZE)\n *\n * Version Migration:\n * - v1 (0x01): Initial protocol version\n * - Future versions will maintain backward compatibility where possible\n */\n\nimport { sha256 } from \"@noble/hashes/sha2.js\";\n\nexport enum MessageType {\n  // Data messages\n  TEXT = 0x01,\n  FILE_METADATA = 0x02,\n  FILE_CHUNK = 0x03,\n  VOICE = 0x04,\n  MESSAGE_REACTION = 0x05,\n  // Control messages\n  CONTROL_ACK = 0x10,\n  CONTROL_PING = 0x11,\n  CONTROL_PONG = 0x12,\n  // Peer management\n  PEER_DISCOVERY = 0x20,\n  PEER_INTRODUCTION = 0x21,\n\n  // Batching\n  BATCH = 0x90,\n\n  // Cryptographic\n  KEY_EXCHANGE = 0x30,\n  SESSION_KEY = 0x31,\n  SESSION_PRESENCE = 0x32,  // Session presence broadcast for single-session enforcement\n  // DHT / Kademlia\n  DHT_FIND_NODE = 0x40,\n  DHT_FOUND_NODES = 0x41,\n  DHT_FIND_VALUE = 0x42,\n  DHT_STORE = 0x43,\n  DHT_STORE_ACK = 0x44,\n  DHT_FOUND_VALUE = 0x45,\n  // Self-update\n  UPDATE_MANIFEST = 0x50,\n  // Rendezvous\n  RENDEZVOUS_ANNOUNCE = 0x60,\n  RENDEZVOUS_QUERY = 0x61,\n  RENDEZVOUS_RESPONSE = 0x62,\n\n  // Content Addressing (Phase 4)\n  REQUEST_BLOB = 0x70,\n  RESPONSE_BLOB = 0x71,\n\n  // Social Recovery (Phase 4)\n  STORE_SHARE = 0x80,\n  REQUEST_SHARE = 0x81,\n  RESPONSE_SHARE = 0x82,\n}\n\n// Protocol constants\nexport const PROTOCOL_VERSION = 0x01;\nexport const MIN_SUPPORTED_VERSION = 0x01;\nexport const MAX_SUPPORTED_VERSION = 0x01;\nexport const HEADER_SIZE = 108; // 1 + 1 + 1 + 1 + 8 + 32 + 64 (compact signature)\nexport const MAX_PAYLOAD_SIZE = 1024 * 1024; // 1 MB max payload\nexport const MAX_TTL = 255;\n\nexport interface MessageHeader {\n  version: number;\n  type: MessageType;\n  ttl: number;\n  timestamp: number;\n  senderId: Uint8Array;\n  signature: Uint8Array;\n}\n\nexport interface Message {\n  header: MessageHeader;\n  payload: Uint8Array;\n}\n\n/**\n * Validation error with detailed context\n */\nexport class MessageValidationError extends Error {\n  constructor(\n    message: string,\n    public readonly field?: string,\n    public readonly value?: unknown,\n  ) {\n    super(message);\n    this.name = \"MessageValidationError\";\n  }\n}\n\n/**\n * Validate message header fields\n * @throws {MessageValidationError} if validation fails\n */\nexport function validateHeader(header: MessageHeader): void {\n  // Validate version\n  if (\n    header.version < MIN_SUPPORTED_VERSION ||\n    header.version > MAX_SUPPORTED_VERSION\n  ) {\n    throw new MessageValidationError(\n      `Unsupported protocol version: ${header.version}. Supported: ${MIN_SUPPORTED_VERSION}-${MAX_SUPPORTED_VERSION}`,\n      \"version\",\n      header.version,\n    );\n  }\n\n  // Validate message type\n  const validTypes = Object.values(MessageType).filter(\n    (v) => typeof v === \"number\",\n  );\n  if (!validTypes.includes(header.type)) {\n    throw new MessageValidationError(\n      `Invalid message type: 0x${header.type.toString(16).padStart(2, \"0\")}`,\n      \"type\",\n      header.type,\n    );\n  }\n\n  // Validate TTL\n  if (header.ttl < 0 || header.ttl > MAX_TTL) {\n    throw new MessageValidationError(\n      `Invalid TTL: ${header.ttl}. Must be 0-${MAX_TTL}`,\n      \"ttl\",\n      header.ttl,\n    );\n  }\n\n  // Validate timestamp\n  if (!Number.isSafeInteger(header.timestamp) || header.timestamp < 0) {\n    throw new MessageValidationError(\n      `Invalid timestamp: ${header.timestamp}`,\n      \"timestamp\",\n      header.timestamp,\n    );\n  }\n\n  // Validate sender ID size\n  if (header.senderId.length !== 32) {\n    throw new MessageValidationError(\n      `Invalid sender ID length: ${header.senderId.length}. Expected: 32`,\n      \"senderId\",\n      header.senderId.length,\n    );\n  }\n\n  // Validate signature size\n  // Ed25519 signatures can be 64 bytes (standard) or 65 bytes (compact with recovery byte)\n  if (header.signature.length !== 64 && header.signature.length !== 65) {\n    throw new MessageValidationError(\n      `Invalid signature length: ${header.signature.length}. Expected: 64 or 65`,\n      \"signature\",\n      header.signature.length,\n    );\n  }\n}\n\n/**\n * Validate complete message\n * @throws {MessageValidationError} if validation fails\n */\nexport function validateMessage(message: Message): void {\n  validateHeader(message.header);\n\n  // Validate payload size\n  if (message.payload.length > MAX_PAYLOAD_SIZE) {\n    throw new MessageValidationError(\n      `Payload too large: ${message.payload.length} bytes. Max: ${MAX_PAYLOAD_SIZE}`,\n      \"payload\",\n      message.payload.length,\n    );\n  }\n}\n\n/**\n * Encode a message header to binary format (Big Endian)\n * @throws {MessageValidationError} if header is invalid\n */\nexport function encodeHeader(header: MessageHeader): Uint8Array {\n  // Validate before encoding\n  validateHeader(header);\n\n  const buffer = new Uint8Array(HEADER_SIZE);\n  let offset = 0;\n\n  // Version (1 byte)\n  buffer[offset++] = header.version;\n\n  // Type (1 byte)\n  buffer[offset++] = header.type;\n\n  // TTL (1 byte)\n  buffer[offset++] = header.ttl;\n\n  // Reserved (1 byte)\n  buffer[offset++] = 0;\n\n  // Timestamp (8 bytes, big-endian)\n  const timestamp = BigInt(header.timestamp);\n  for (let i = 7; i >= 0; i--) {\n    buffer[offset++] = Number((timestamp >> BigInt(i * 8)) & BigInt(0xff));\n  }\n\n  // Sender ID (32 bytes)\n  buffer.set(header.senderId, offset);\n  offset += 32;\n\n  // Signature (64 bytes - Ed25519 signature)\n  buffer.set(header.signature, offset);\n\n  return buffer;\n}\n\n/**\n * Decode a message header from binary format (Big Endian)\n * @throws {MessageValidationError} if buffer is invalid or too small\n */\nexport function decodeHeader(buffer: Uint8Array): MessageHeader {\n  if (buffer.length < HEADER_SIZE) {\n    throw new MessageValidationError(\n      `Invalid header size: ${buffer.length} bytes. Expected: ${HEADER_SIZE} bytes`,\n      \"buffer\",\n      buffer.length,\n    );\n  }\n\n  let offset = 0;\n\n  const version = buffer[offset++];\n  const type = buffer[offset++] as MessageType;\n  const ttl = buffer[offset++];\n  offset++; // Skip reserved byte\n\n  // Timestamp (8 bytes, big-endian)\n  let timestamp = 0;\n  for (let i = 0; i < 8; i++) {\n    timestamp = timestamp * 256 + buffer[offset++];\n  }\n\n  // Sender ID (32 bytes)\n  const senderId = buffer.slice(offset, offset + 32);\n  offset += 32;\n\n  // Signature (64 bytes)\n  const signature = buffer.slice(offset, offset + 64);\n\n  const header: MessageHeader = {\n    version,\n    type,\n    ttl,\n    timestamp,\n    senderId,\n    signature,\n  };\n\n  // Validate decoded header\n  validateHeader(header);\n\n  return header;\n}\n\n/**\n * Encode a complete message (header + payload)\n * @throws {MessageValidationError} if message is invalid\n */\nexport function encodeMessage(message: Message): Uint8Array {\n  // Validate before encoding\n  validateMessage(message);\n\n  const headerBytes = encodeHeader(message.header);\n  const result = new Uint8Array(headerBytes.length + message.payload.length);\n  result.set(headerBytes, 0);\n  result.set(message.payload, headerBytes.length);\n  return result;\n}\n\n/**\n * Decode a complete message (header + payload)\n * @throws {MessageValidationError} if buffer is invalid\n */\nexport function decodeMessage(buffer: Uint8Array): Message {\n  if (buffer.length < HEADER_SIZE) {\n    throw new MessageValidationError(\n      `Buffer too small: ${buffer.length} bytes. Minimum: ${HEADER_SIZE} bytes`,\n      \"buffer\",\n      buffer.length,\n    );\n  }\n\n  const header = decodeHeader(buffer.slice(0, HEADER_SIZE));\n  const payload = buffer.slice(HEADER_SIZE);\n\n  const message: Message = { header, payload };\n\n  // Validate complete message\n  validateMessage(message);\n\n  return message;\n}\n\n/**\n * Create a cryptographically secure message hash for deduplication\n * Uses SHA-256 for collision resistance\n */\nexport function messageHash(message: Message): string {\n  const messageBytes = encodeMessage(message);\n  const hash = sha256(messageBytes);\n\n  // Convert to hex string\n  return Array.from(hash)\n    .map((b: number) => b.toString(16).padStart(2, \"0\"))\n    .join(\"\");\n}\n\n/**\n * Check if a version is supported\n */\nexport function isVersionSupported(version: number): boolean {\n  return version >= MIN_SUPPORTED_VERSION && version <= MAX_SUPPORTED_VERSION;\n}\n\n/**\n * Get human-readable message type name\n */\nexport function getMessageTypeName(type: number): string {\n  const typeNames: Record<number, string> = {\n    [MessageType.TEXT]: \"TEXT\",\n    [MessageType.FILE_METADATA]: \"FILE_METADATA\",\n    [MessageType.FILE_CHUNK]: \"FILE_CHUNK\",\n    [MessageType.VOICE]: \"VOICE\",\n    [MessageType.MESSAGE_REACTION]: \"MESSAGE_REACTION\",\n    [MessageType.CONTROL_ACK]: \"CONTROL_ACK\",\n    [MessageType.CONTROL_PING]: \"CONTROL_PING\",\n    [MessageType.CONTROL_PONG]: \"CONTROL_PONG\",\n    [MessageType.PEER_DISCOVERY]: \"PEER_DISCOVERY\",\n    [MessageType.PEER_INTRODUCTION]: \"PEER_INTRODUCTION\",\n    [MessageType.KEY_EXCHANGE]: \"KEY_EXCHANGE\",\n    [MessageType.SESSION_KEY]: \"SESSION_KEY\",\n    [MessageType.SESSION_PRESENCE]: \"SESSION_PRESENCE\",\n    [MessageType.DHT_FIND_NODE]: \"DHT_FIND_NODE\",\n    [MessageType.DHT_FOUND_NODES]: \"DHT_FOUND_NODES\",\n    [MessageType.DHT_FIND_VALUE]: \"DHT_FIND_VALUE\",\n    [MessageType.DHT_STORE]: \"DHT_STORE\",\n    [MessageType.DHT_STORE_ACK]: \"DHT_STORE_ACK\",\n    [MessageType.DHT_FOUND_VALUE]: \"DHT_FOUND_VALUE\",\n    [MessageType.UPDATE_MANIFEST]: \"UPDATE_MANIFEST\",\n    [MessageType.REQUEST_BLOB]: \"REQUEST_BLOB\",\n    [MessageType.RESPONSE_BLOB]: \"RESPONSE_BLOB\",\n    [MessageType.STORE_SHARE]: \"STORE_SHARE\",\n    [MessageType.REQUEST_SHARE]: \"REQUEST_SHARE\",\n    [MessageType.RESPONSE_SHARE]: \"RESPONSE_SHARE\",\n  };\n  return typeNames[type] || `UNKNOWN(0x${type.toString(16).padStart(2, \"0\")})`;\n}\n"],"version":3}