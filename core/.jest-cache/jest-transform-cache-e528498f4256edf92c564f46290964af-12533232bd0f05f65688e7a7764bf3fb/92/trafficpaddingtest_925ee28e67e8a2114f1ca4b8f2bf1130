4a6d5c2558d0dec710059736332a2ae1
"use strict";
/**
 * Tests for Traffic Padding implementation
 */
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const traffic_padding_1 = require("../mesh/traffic-padding");
(0, globals_1.describe)('TrafficPadding', () => {
    let padding;
    (0, globals_1.beforeEach)(() => {
        padding = new traffic_padding_1.TrafficPadding({ enabled: true });
    });
    (0, globals_1.it)('should pad message to bucket size', () => {
        const message = new Uint8Array(100);
        const padded = padding.pad(message);
        (0, globals_1.expect)(padded.bucketSize).toBeGreaterThanOrEqual(100);
        (0, globals_1.expect)(padded.originalSize).toBe(100);
        (0, globals_1.expect)(padded.overhead).toBeGreaterThan(0);
    });
    (0, globals_1.it)('should unpad message correctly', () => {
        const original = new Uint8Array([1, 2, 3, 4, 5]);
        const padded = padding.pad(original);
        const unpadded = padding.unpad(padded.data);
        (0, globals_1.expect)(unpadded).toEqual(original);
    });
    (0, globals_1.it)('should handle different padding strategies', () => {
        const message = new Uint8Array(100);
        // Random padding
        padding.updateConfig({ strategy: 'random' });
        const random = padding.pad(message);
        (0, globals_1.expect)(random.data.length).toBeGreaterThan(message.length);
        // Zero padding
        padding.updateConfig({ strategy: 'zero' });
        const zero = padding.pad(message);
        (0, globals_1.expect)(zero.data.length).toBeGreaterThan(message.length);
        // PKCS7 padding
        padding.updateConfig({ strategy: 'pkcs7' });
        const pkcs7 = padding.pad(message);
        (0, globals_1.expect)(pkcs7.data.length).toBeGreaterThan(message.length);
    });
    (0, globals_1.it)('should use correct bucket sizes', () => {
        const sizes = [50, 200, 500, 1500, 3000];
        for (const size of sizes) {
            const message = new Uint8Array(size);
            const padded = padding.pad(message);
            // Check bucket size is from standard buckets
            (0, globals_1.expect)(traffic_padding_1.MESSAGE_SIZE_BUCKETS).toContain(padded.bucketSize);
        }
    });
    (0, globals_1.it)('should calculate overhead correctly', () => {
        const messageSize = 100;
        const overhead = padding.calculateOverhead(messageSize);
        (0, globals_1.expect)(overhead.bytes).toBeGreaterThan(0);
        (0, globals_1.expect)(overhead.percentage).toBeGreaterThan(0);
    });
    (0, globals_1.it)('should handle disabled padding', () => {
        const disabled = new traffic_padding_1.TrafficPadding({ enabled: false });
        const message = new Uint8Array(100);
        const padded = disabled.pad(message);
        (0, globals_1.expect)(padded.data).toEqual(message);
        (0, globals_1.expect)(padded.overhead).toBe(0);
    });
    (0, globals_1.it)('should reject oversized messages', () => {
        const huge = new Uint8Array(20000);
        (0, globals_1.expect)(() => padding.pad(huge)).toThrow();
    });
    (0, globals_1.it)('should track statistics', () => {
        const message = new Uint8Array(100);
        padding.pad(message);
        const stats = padding.getStats();
        (0, globals_1.expect)(stats.messagesPadded).toBe(1);
        (0, globals_1.expect)(stats.averageOverhead).toBeGreaterThan(0);
    });
});
(0, globals_1.describe)('AdaptivePadding', () => {
    let adaptive;
    (0, globals_1.beforeEach)(() => {
        adaptive = new traffic_padding_1.AdaptivePadding({ enabled: true });
    });
    (0, globals_1.it)('should adapt to network conditions', () => {
        // Low bandwidth
        adaptive.updateNetworkConditions(100, 50000);
        const lowConfig = adaptive.getConfig();
        (0, globals_1.expect)(lowConfig.sizeBuckets.length).toBeLessThan(traffic_padding_1.MESSAGE_SIZE_BUCKETS.length);
        // High bandwidth
        adaptive.updateNetworkConditions(10, 2000000);
        const highConfig = adaptive.getConfig();
        (0, globals_1.expect)(highConfig.strategy).toBe('random');
    });
    (0, globals_1.it)('should decide when to pad', () => {
        adaptive.updateNetworkConditions(10, 2000000);
        (0, globals_1.expect)(adaptive.shouldPad(100)).toBe(true);
        adaptive.updateNetworkConditions(100, 50000);
        (0, globals_1.expect)(adaptive.shouldPad(50)).toBe(false);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvbWVzaC90cmFmZmljLXBhZGRpbmcudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsMkNBQWlFO0FBQ2pFLDZEQUFnRztBQUVoRyxJQUFBLGtCQUFRLEVBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQzlCLElBQUksT0FBdUIsQ0FBQztJQUU1QixJQUFBLG9CQUFVLEVBQUMsR0FBRyxFQUFFO1FBQ2QsT0FBTyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBQSxZQUFFLEVBQUMsbUNBQW1DLEVBQUUsR0FBRyxFQUFFO1FBQzNDLE1BQU0sT0FBTyxHQUFHLElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFcEMsSUFBQSxnQkFBTSxFQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0RCxJQUFBLGdCQUFNLEVBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0QyxJQUFBLGdCQUFNLEVBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM3QyxDQUFDLENBQUMsQ0FBQztJQUVILElBQUEsWUFBRSxFQUFDLGdDQUFnQyxFQUFFLEdBQUcsRUFBRTtRQUN4QyxNQUFNLFFBQVEsR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFH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LCJzb3VyY2VzIjpbIi9Vc2Vycy9jaHJpc3R5bWF4d2VsbC9EZXNrdG9wL0x1a2VfU3R1ZmYvR2l0SHViL1NDL2NvcmUvc3JjL21lc2gvdHJhZmZpYy1wYWRkaW5nLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUZXN0cyBmb3IgVHJhZmZpYyBQYWRkaW5nIGltcGxlbWVudGF0aW9uXG4gKi9cblxuaW1wb3J0IHsgZGVzY3JpYmUsIGl0LCBleHBlY3QsIGJlZm9yZUVhY2ggfSBmcm9tICdAamVzdC9nbG9iYWxzJztcbmltcG9ydCB7IFRyYWZmaWNQYWRkaW5nLCBNRVNTQUdFX1NJWkVfQlVDS0VUUywgQWRhcHRpdmVQYWRkaW5nIH0gZnJvbSAnLi4vbWVzaC90cmFmZmljLXBhZGRpbmcnO1xuXG5kZXNjcmliZSgnVHJhZmZpY1BhZGRpbmcnLCAoKSA9PiB7XG4gIGxldCBwYWRkaW5nOiBUcmFmZmljUGFkZGluZztcbiAgXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHBhZGRpbmcgPSBuZXcgVHJhZmZpY1BhZGRpbmcoeyBlbmFibGVkOiB0cnVlIH0pO1xuICB9KTtcbiAgXG4gIGl0KCdzaG91bGQgcGFkIG1lc3NhZ2UgdG8gYnVja2V0IHNpemUnLCAoKSA9PiB7XG4gICAgY29uc3QgbWVzc2FnZSA9IG5ldyBVaW50OEFycmF5KDEwMCk7XG4gICAgY29uc3QgcGFkZGVkID0gcGFkZGluZy5wYWQobWVzc2FnZSk7XG4gICAgXG4gICAgZXhwZWN0KHBhZGRlZC5idWNrZXRTaXplKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDEwMCk7XG4gICAgZXhwZWN0KHBhZGRlZC5vcmlnaW5hbFNpemUpLnRvQmUoMTAwKTtcbiAgICBleHBlY3QocGFkZGVkLm92ZXJoZWFkKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gIH0pO1xuICBcbiAgaXQoJ3Nob3VsZCB1bnBhZCBtZXNzYWdlIGNvcnJlY3RseScsICgpID0+IHtcbiAgICBjb25zdCBvcmlnaW5hbCA9IG5ldyBVaW50OEFycmF5KFsxLCAyLCAzLCA0LCA1XSk7XG4gICAgY29uc3QgcGFkZGVkID0gcGFkZGluZy5wYWQob3JpZ2luYWwpO1xuICAgIGNvbnN0IHVucGFkZGVkID0gcGFkZGluZy51bnBhZChwYWRkZWQuZGF0YSk7XG4gICAgXG4gICAgZXhwZWN0KHVucGFkZGVkKS50b0VxdWFsKG9yaWdpbmFsKTtcbiAgfSk7XG4gIFxuICBpdCgnc2hvdWxkIGhhbmRsZSBkaWZmZXJlbnQgcGFkZGluZyBzdHJhdGVnaWVzJywgKCkgPT4ge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBuZXcgVWludDhBcnJheSgxMDApO1xuICAgIFxuICAgIC8vIFJhbmRvbSBwYWRkaW5nXG4gICAgcGFkZGluZy51cGRhdGVDb25maWcoeyBzdHJhdGVneTogJ3JhbmRvbScgfSk7XG4gICAgY29uc3QgcmFuZG9tID0gcGFkZGluZy5wYWQobWVzc2FnZSk7XG4gICAgZXhwZWN0KHJhbmRvbS5kYXRhLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuKG1lc3NhZ2UubGVuZ3RoKTtcbiAgICBcbiAgICAvLyBaZXJvIHBhZGRpbmdcbiAgICBwYWRkaW5nLnVwZGF0ZUNvbmZpZyh7IHN0cmF0ZWd5OiAnemVybycgfSk7XG4gICAgY29uc3QgemVybyA9IHBhZGRpbmcucGFkKG1lc3NhZ2UpO1xuICAgIGV4cGVjdCh6ZXJvLmRhdGEubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4obWVzc2FnZS5sZW5ndGgpO1xuICAgIFxuICAgIC8vIFBLQ1M3IHBhZGRpbmdcbiAgICBwYWRkaW5nLnVwZGF0ZUNvbmZpZyh7IHN0cmF0ZWd5OiAncGtjczcnIH0pO1xuICAgIGNvbnN0IHBrY3M3ID0gcGFkZGluZy5wYWQobWVzc2FnZSk7XG4gICAgZXhwZWN0KHBrY3M3LmRhdGEubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4obWVzc2FnZS5sZW5ndGgpO1xuICB9KTtcbiAgXG4gIGl0KCdzaG91bGQgdXNlIGNvcnJlY3QgYnVja2V0IHNpemVzJywgKCkgPT4ge1xuICAgIGNvbnN0IHNpemVzID0gWzUwLCAyMDAsIDUwMCwgMTUwMCwgMzAwMF07XG4gICAgXG4gICAgZm9yIChjb25zdCBzaXplIG9mIHNpemVzKSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gbmV3IFVpbnQ4QXJyYXkoc2l6ZSk7XG4gICAgICBjb25zdCBwYWRkZWQgPSBwYWRkaW5nLnBhZChtZXNzYWdlKTtcbiAgICAgIFxuICAgICAgLy8gQ2hlY2sgYnVja2V0IHNpemUgaXMgZnJvbSBzdGFuZGFyZCBidWNrZXRzXG4gICAgICBleHBlY3QoTUVTU0FHRV9TSVpFX0JVQ0tFVFMpLnRvQ29udGFpbihwYWRkZWQuYnVja2V0U2l6ZSk7XG4gICAgfVxuICB9KTtcbiAgXG4gIGl0KCdzaG91bGQgY2FsY3VsYXRlIG92ZXJoZWFkIGNvcnJlY3RseScsICgpID0+IHtcbiAgICBjb25zdCBtZXNzYWdlU2l6ZSA9IDEwMDtcbiAgICBjb25zdCBvdmVyaGVhZCA9IHBhZGRpbmcuY2FsY3VsYXRlT3ZlcmhlYWQobWVzc2FnZVNpemUpO1xuICAgIFxuICAgIGV4cGVjdChvdmVyaGVhZC5ieXRlcykudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgIGV4cGVjdChvdmVyaGVhZC5wZXJjZW50YWdlKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gIH0pO1xuICBcbiAgaXQoJ3Nob3VsZCBoYW5kbGUgZGlzYWJsZWQgcGFkZGluZycsICgpID0+IHtcbiAgICBjb25zdCBkaXNhYmxlZCA9IG5ldyBUcmFmZmljUGFkZGluZyh7IGVuYWJsZWQ6IGZhbHNlIH0pO1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBuZXcgVWludDhBcnJheSgxMDApO1xuICAgIFxuICAgIGNvbnN0IHBhZGRlZCA9IGRpc2FibGVkLnBhZChtZXNzYWdlKTtcbiAgICBleHBlY3QocGFkZGVkLmRhdGEpLnRvRXF1YWwobWVzc2FnZSk7XG4gICAgZXhwZWN0KHBhZGRlZC5vdmVyaGVhZCkudG9CZSgwKTtcbiAgfSk7XG4gIFxuICBpdCgnc2hvdWxkIHJlamVjdCBvdmVyc2l6ZWQgbWVzc2FnZXMnLCAoKSA9PiB7XG4gICAgY29uc3QgaHVnZSA9IG5ldyBVaW50OEFycmF5KDIwMDAwKTtcbiAgICBcbiAgICBleHBlY3QoKCkgPT4gcGFkZGluZy5wYWQoaHVnZSkpLnRvVGhyb3coKTtcbiAgfSk7XG4gIFxuICBpdCgnc2hvdWxkIHRyYWNrIHN0YXRpc3RpY3MnLCAoKSA9PiB7XG4gICAgY29uc3QgbWVzc2FnZSA9IG5ldyBVaW50OEFycmF5KDEwMCk7XG4gICAgXG4gICAgcGFkZGluZy5wYWQobWVzc2FnZSk7XG4gICAgXG4gICAgY29uc3Qgc3RhdHMgPSBwYWRkaW5nLmdldFN0YXRzKCk7XG4gICAgZXhwZWN0KHN0YXRzLm1lc3NhZ2VzUGFkZGVkKS50b0JlKDEpO1xuICAgIGV4cGVjdChzdGF0cy5hdmVyYWdlT3ZlcmhlYWQpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ0FkYXB0aXZlUGFkZGluZycsICgpID0+IHtcbiAgbGV0IGFkYXB0aXZlOiBBZGFwdGl2ZVBhZGRpbmc7XG4gIFxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBhZGFwdGl2ZSA9IG5ldyBBZGFwdGl2ZVBhZGRpbmcoeyBlbmFibGVkOiB0cnVlIH0pO1xuICB9KTtcbiAgXG4gIGl0KCdzaG91bGQgYWRhcHQgdG8gbmV0d29yayBjb25kaXRpb25zJywgKCkgPT4ge1xuICAgIC8vIExvdyBiYW5kd2lkdGhcbiAgICBhZGFwdGl2ZS51cGRhdGVOZXR3b3JrQ29uZGl0aW9ucygxMDAsIDUwMDAwKTtcbiAgICBjb25zdCBsb3dDb25maWcgPSBhZGFwdGl2ZS5nZXRDb25maWcoKTtcbiAgICBleHBlY3QobG93Q29uZmlnLnNpemVCdWNrZXRzLmxlbmd0aCkudG9CZUxlc3NUaGFuKE1FU1NBR0VfU0laRV9CVUNLRVRTLmxlbmd0aCk7XG4gICAgXG4gICAgLy8gSGlnaCBiYW5kd2lkdGhcbiAgICBhZGFwdGl2ZS51cGRhdGVOZXR3b3JrQ29uZGl0aW9ucygxMCwgMjAwMDAwMCk7XG4gICAgY29uc3QgaGlnaENvbmZpZyA9IGFkYXB0aXZlLmdldENvbmZpZygpO1xuICAgIGV4cGVjdChoaWdoQ29uZmlnLnN0cmF0ZWd5KS50b0JlKCdyYW5kb20nKTtcbiAgfSk7XG4gIFxuICBpdCgnc2hvdWxkIGRlY2lkZSB3aGVuIHRvIHBhZCcsICgpID0+IHtcbiAgICBhZGFwdGl2ZS51cGRhdGVOZXR3b3JrQ29uZGl0aW9ucygxMCwgMjAwMDAwMCk7XG4gICAgZXhwZWN0KGFkYXB0aXZlLnNob3VsZFBhZCgxMDApKS50b0JlKHRydWUpO1xuICAgIFxuICAgIGFkYXB0aXZlLnVwZGF0ZU5ldHdvcmtDb25kaXRpb25zKDEwMCwgNTAwMDApO1xuICAgIGV4cGVjdChhZGFwdGl2ZS5zaG91bGRQYWQoNTApKS50b0JlKGZhbHNlKTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==