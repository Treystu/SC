{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/health.ts","mappings":"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","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/health.ts"],"sourcesContent":["/**\n * Peer Health Monitoring with Heartbeat\n */\n\nimport { RoutingTable } from './routing.js';\nimport { Message, MessageType, encodeMessage } from '../protocol/message.js';\nimport { signMessage } from '../crypto/primitives.js';\n\nexport interface HeartbeatConfig {\n  interval: number; // Base heartbeat interval in ms\n  timeout: number; // Peer timeout in ms\n  maxMissed: number; // Max missed heartbeats before removing peer\n  adaptiveInterval?: boolean; // Enable adaptive intervals\n  minInterval?: number; // Minimum interval for adaptive\n  maxInterval?: number; // Maximum interval for adaptive\n}\n\nexport interface PeerHealth {\n  peerId: string;\n  lastHeartbeat: number;\n  missedHeartbeats: number;\n  rtt: number; // Round-trip time in ms\n  isHealthy: boolean;\n  packetLoss: number; // 0-1, packet loss rate\n  latencyHistory: number[]; // Recent latency measurements\n  healthScore: number; // 0-100, computed health score\n  adaptiveInterval: number; // Current adaptive interval\n}\n\n/**\n * Peer Health Monitor\n * Implements heartbeat-based health monitoring\n */\nexport class PeerHealthMonitor {\n  private routingTable: RoutingTable;\n  private config: HeartbeatConfig;\n  private peerHealth: Map<string, PeerHealth> = new Map();\n  private heartbeatIntervals: Map<string, ReturnType<typeof setInterval>> = new Map();\n  private onPeerUnhealthyCallback?: (peerId: string) => void;\n  private onPeerHealthyCallback?: (peerId: string) => void;\n  private onSendMessageCallback?: (peerId: string, message: Uint8Array) => void;\n  private localPeerId: string;\n  private identityPrivateKey: Uint8Array;\n\n  constructor(\n    localPeerId: string,\n    identityPrivateKey: Uint8Array,\n    routingTable: RoutingTable,\n    config: Partial<HeartbeatConfig> = {}\n  ) {\n    this.localPeerId = localPeerId;\n    this.identityPrivateKey = identityPrivateKey;\n    this.routingTable = routingTable;\n    this.config = {\n      interval: config.interval || 30000, // 30 seconds\n      timeout: config.timeout || 90000, // 90 seconds\n      maxMissed: config.maxMissed || 3,\n      adaptiveInterval: config.adaptiveInterval !== false,\n      minInterval: config.minInterval || 10000, // 10 seconds\n      maxInterval: config.maxInterval || 60000, // 60 seconds\n    };\n  }\n\n  /**\n   * Start monitoring a peer\n   */\n  startMonitoring(peerId: string): void {\n    if (this.heartbeatIntervals.has(peerId)) {\n      return; // Already monitoring\n    }\n\n    // Initialize health tracking\n    this.peerHealth.set(peerId, {\n      peerId,\n      lastHeartbeat: Date.now(),\n      missedHeartbeats: 0,\n      rtt: 0,\n      isHealthy: true,\n      packetLoss: 0,\n      latencyHistory: [],\n      healthScore: 100,\n      adaptiveInterval: this.config.interval,\n    });\n\n    // Start sending heartbeats\n    this.scheduleNextHeartbeat(peerId);\n  }\n\n  /**\n   * Schedule next heartbeat with adaptive interval\n   */\n  private scheduleNextHeartbeat(peerId: string): void {\n    const health = this.peerHealth.get(peerId);\n    if (!health) return;\n\n    const interval = this.config.adaptiveInterval \n      ? health.adaptiveInterval \n      : this.config.interval;\n\n    const timeout = setTimeout(() => {\n      this.sendHeartbeat(peerId);\n      this.checkPeerHealth(peerId);\n      this.scheduleNextHeartbeat(peerId);\n    }, interval);\n\n    this.heartbeatIntervals.set(peerId, timeout as any);\n  }\n\n  /**\n   * Stop monitoring a peer\n   */\n  stopMonitoring(peerId: string): void {\n    const interval = this.heartbeatIntervals.get(peerId);\n    if (interval) {\n      clearInterval(interval);\n      this.heartbeatIntervals.delete(peerId);\n    }\n    this.peerHealth.delete(peerId);\n  }\n\n  /**\n   * Send heartbeat (PING) to peer\n   */\n  private sendHeartbeat(peerId: string): void {\n    const payload = new TextEncoder().encode(JSON.stringify({\n      timestamp: Date.now(),\n      peerId: this.localPeerId,\n    }));\n\n    const message: Message = {\n      header: {\n        version: 0x01,\n        type: MessageType.CONTROL_PING,\n        ttl: 1, // Direct message, no forwarding\n        timestamp: Date.now(),\n        senderId: new Uint8Array(32), // Will be filled with actual public key\n        signature: new Uint8Array(65),\n      },\n      payload,\n    };\n\n    // Create a temporary message for signing\n    const tempMessage = {\n      ...message,\n      header: {\n        ...message.header,\n        signature: new Uint8Array(65), // Placeholder for encoding\n      }\n    };\n\n    // Encode and sign\n    const messageBytes = encodeMessage(tempMessage);\n    const sig64 = signMessage(messageBytes, this.identityPrivateKey);\n    \n    // Pad signature to 65 bytes (compact signature with recovery byte)\n    const sig65 = new Uint8Array(65);\n    sig65.set(sig64, 0);\n    sig65[64] = 0; // Recovery byte placeholder\n    message.header.signature = sig65;\n\n    // Send to peer\n    const encodedMessage = encodeMessage(message);\n    this.onSendMessageCallback?.(peerId, encodedMessage);\n  }\n\n  /**\n   * Process received heartbeat response (PONG)\n   */\n  processHeartbeatResponse(peerId: string, timestamp: number): void {\n    const health = this.peerHealth.get(peerId);\n    if (!health) {\n      return;\n    }\n\n    // Calculate RTT\n    const rtt = Date.now() - timestamp;\n    health.rtt = rtt;\n    \n    // Update latency history (keep last 10)\n    health.latencyHistory.push(rtt);\n    if (health.latencyHistory.length > 10) {\n      health.latencyHistory.shift();\n    }\n    \n    health.lastHeartbeat = Date.now();\n    \n    // Update packet loss (exponential moving average)\n    const alpha = 0.3;\n    health.packetLoss = alpha * 0 + (1 - alpha) * health.packetLoss;\n    health.missedHeartbeats = 0;\n\n    // Calculate health score\n    this.updateHealthScore(peerId);\n\n    // Adapt heartbeat interval based on connection quality\n    if (this.config.adaptiveInterval) {\n      this.adaptHeartbeatInterval(peerId);\n    }\n\n    // Check if peer became healthy\n    if (!health.isHealthy) {\n      health.isHealthy = true;\n      this.onPeerHealthyCallback?.(peerId);\n    }\n\n    // Update peer last seen in routing table\n    this.routingTable.updatePeerLastSeen(peerId);\n  }\n\n  /**\n   * Calculate health score based on multiple metrics\n   */\n  private updateHealthScore(peerId: string): void {\n    const health = this.peerHealth.get(peerId);\n    if (!health) return;\n\n    // Base score\n    let score = 100;\n\n    // Penalty for high latency\n    const avgLatency = health.latencyHistory.length > 0\n      ? health.latencyHistory.reduce((a, b) => a + b, 0) / health.latencyHistory.length\n      : health.rtt;\n    \n    if (avgLatency > 1000) score -= 30;\n    else if (avgLatency > 500) score -= 20;\n    else if (avgLatency > 200) score -= 10;\n\n    // Penalty for packet loss\n    score -= health.packetLoss * 50;\n\n    // Penalty for missed heartbeats\n    score -= health.missedHeartbeats * 10;\n\n    health.healthScore = Math.max(0, Math.min(100, score));\n  }\n\n  /**\n   * Adapt heartbeat interval based on connection quality\n   */\n  private adaptHeartbeatInterval(peerId: string): void {\n    const health = this.peerHealth.get(peerId);\n    if (!health) return;\n\n    const { minInterval = 10000, maxInterval = 60000 } = this.config;\n\n    // Good connection (score > 80): less frequent heartbeats\n    if (health.healthScore > 80) {\n      health.adaptiveInterval = Math.min(maxInterval, health.adaptiveInterval * 1.2);\n    }\n    // Poor connection (score < 50): more frequent heartbeats\n    else if (health.healthScore < 50) {\n      health.adaptiveInterval = Math.max(minInterval, health.adaptiveInterval * 0.8);\n    }\n    // Moderate connection: reset to default\n    else {\n      health.adaptiveInterval = this.config.interval;\n    }\n\n    health.adaptiveInterval = Math.max(minInterval, Math.min(maxInterval, health.adaptiveInterval));\n  }\n\n  /**\n   * Check peer health based on missed heartbeats\n   */\n  private checkPeerHealth(peerId: string): void {\n    const health = this.peerHealth.get(peerId);\n    if (!health) {\n      return;\n    }\n\n    const now = Date.now();\n    const timeSinceLastHeartbeat = now - health.lastHeartbeat;\n\n    // Check if heartbeat is overdue\n    if (timeSinceLastHeartbeat > health.adaptiveInterval * 1.5) {\n      health.missedHeartbeats++;\n      \n      // Update packet loss\n      const alpha = 0.3;\n      health.packetLoss = alpha * 1 + (1 - alpha) * health.packetLoss;\n      \n      // Update health score\n      this.updateHealthScore(peerId);\n\n      // Check if peer is unhealthy\n      if (health.missedHeartbeats >= this.config.maxMissed) {\n        if (health.isHealthy) {\n          health.isHealthy = false;\n          this.onPeerUnhealthyCallback?.(peerId);\n        }\n\n        // Check if peer should be removed\n        if (timeSinceLastHeartbeat > this.config.timeout) {\n          this.stopMonitoring(peerId);\n          this.routingTable.removePeer(peerId);\n        }\n      }\n    }\n  }\n\n  /**\n   * Get health status for a peer\n   */\n  getPeerHealth(peerId: string): PeerHealth | undefined {\n    return this.peerHealth.get(peerId);\n  }\n\n  /**\n   * Get all peer health statuses\n   */\n  getAllPeerHealth(): PeerHealth[] {\n    return Array.from(this.peerHealth.values());\n  }\n\n  /**\n   * Register callback for peer becoming unhealthy\n   */\n  onPeerUnhealthy(callback: (peerId: string) => void): void {\n    this.onPeerUnhealthyCallback = callback;\n  }\n\n  /**\n   * Register callback for peer becoming healthy\n   */\n  onPeerHealthy(callback: (peerId: string) => void): void {\n    this.onPeerHealthyCallback = callback;\n  }\n\n  /**\n   * Register callback for sending messages\n   */\n  onSendMessage(callback: (peerId: string, message: Uint8Array) => void): void {\n    this.onSendMessageCallback = callback;\n  }\n\n  /**\n   * Get health statistics\n   */\n  getStats() {\n    const healthy = Array.from(this.peerHealth.values()).filter(h => h.isHealthy).length;\n    const unhealthy = this.peerHealth.size - healthy;\n\n    return {\n      totalPeers: this.peerHealth.size,\n      healthy,\n      unhealthy,\n      averageRtt: this.calculateAverageRtt(),\n    };\n  }\n\n  /**\n   * Calculate average RTT across all healthy peers\n   */\n  private calculateAverageRtt(): number {\n    const healthyPeers = Array.from(this.peerHealth.values()).filter(h => h.isHealthy);\n    if (healthyPeers.length === 0) {\n      return 0;\n    }\n\n    const totalRtt = healthyPeers.reduce((sum, h) => sum + h.rtt, 0);\n    return totalRtt / healthyPeers.length;\n  }\n\n  /**\n   * Shutdown health monitor\n   */\n  shutdown(): void {\n    // Clear all intervals\n    this.heartbeatIntervals.forEach(interval => clearInterval(interval));\n    this.heartbeatIntervals.clear();\n    this.peerHealth.clear();\n  }\n}\n"],"version":3}