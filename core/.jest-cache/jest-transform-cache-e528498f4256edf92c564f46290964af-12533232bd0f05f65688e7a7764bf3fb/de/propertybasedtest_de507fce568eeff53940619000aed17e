6e2cdb0b3b5ed14f2996eb4210fd0633
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Property-based tests for crypto primitives
 */
const fast_check_1 = __importDefault(require("fast-check"));
const primitives_1 = require("./primitives");
describe("Crypto Property-Based Tests", () => {
    describe("Identity generation", () => {
        it("should generate unique identities", async () => {
            await fast_check_1.default.assert(fast_check_1.default.asyncProperty(fast_check_1.default.nat(10), async () => {
                const identity1 = await (0, primitives_1.generateIdentity)();
                const identity2 = await (0, primitives_1.generateIdentity)();
                // Public keys should be different
                expect(Buffer.from(identity1.publicKey).equals(Buffer.from(identity2.publicKey))).toBe(false);
                // Private keys should be different
                expect(Buffer.from(identity1.privateKey).equals(Buffer.from(identity2.privateKey))).toBe(false);
            }), { numRuns: 10 });
        });
        it("should generate valid key pairs", async () => {
            await fast_check_1.default.assert(fast_check_1.default.asyncProperty(fast_check_1.default.nat(10), async () => {
                const identity = await (0, primitives_1.generateIdentity)();
                // Keys should have correct length
                expect(identity.publicKey.length).toBe(32);
                expect(identity.privateKey.length).toBe(32);
                // Keys should not be all zeros
                const pubKeySum = identity.publicKey.reduce((a, b) => a + b, 0);
                const privKeySum = identity.privateKey.reduce((a, b) => a + b, 0);
                expect(pubKeySum).toBeGreaterThan(0);
                expect(privKeySum).toBeGreaterThan(0);
            }), { numRuns: 10 });
        });
    });
    describe("Message signing", () => {
        it("should verify any message signed with the same key", async () => {
            await fast_check_1.default.assert(fast_check_1.default.asyncProperty(fast_check_1.default.uint8Array({ minLength: 1, maxLength: 1000 }), async (data) => {
                const identity = await (0, primitives_1.generateIdentity)();
                const signature = await (0, primitives_1.signMessage)(data, identity.privateKey);
                const isValid = await (0, primitives_1.verifySignature)(data, signature, identity.publicKey);
                expect(isValid).toBe(true);
            }), { numRuns: 50 });
        });
        it("should fail verification with wrong public key", async () => {
            await fast_check_1.default.assert(fast_check_1.default.asyncProperty(fast_check_1.default.uint8Array({ minLength: 1, maxLength: 1000 }), async (data) => {
                const identity1 = await (0, primitives_1.generateIdentity)();
                const identity2 = await (0, primitives_1.generateIdentity)();
                const signature = await (0, primitives_1.signMessage)(data, identity1.privateKey);
                const isValid = await (0, primitives_1.verifySignature)(data, signature, identity2.publicKey);
                // Should fail with different public key
                expect(isValid).toBe(false);
            }), { numRuns: 50 });
        });
        it("should fail verification with tampered data", async () => {
            await fast_check_1.default.assert(fast_check_1.default.asyncProperty(fast_check_1.default.uint8Array({ minLength: 2, maxLength: 1000 }), async (data) => {
                const identity = await (0, primitives_1.generateIdentity)();
                const signature = await (0, primitives_1.signMessage)(data, identity.privateKey);
                // Tamper with data
                const tamperedData = new Uint8Array(data);
                tamperedData[0] = (tamperedData[0] + 1) % 256;
                const isValid = await (0, primitives_1.verifySignature)(tamperedData, signature, identity.publicKey);
                expect(isValid).toBe(false);
            }), { numRuns: 50 });
        });
    });
    describe("Encryption/Decryption", () => {
        it("should decrypt any message encrypted with the same key", async () => {
            await fast_check_1.default.assert(fast_check_1.default.asyncProperty(fast_check_1.default.uint8Array({ minLength: 1, maxLength: 1000 }), async (plaintext) => {
                const sender = await (0, primitives_1.generateIdentity)();
                const receiver = await (0, primitives_1.generateIdentity)();
                // Derive shared secret
                const senderSecret = await (0, primitives_1.deriveSharedSecret)(sender.privateKey, receiver.publicKey);
                const receiverSecret = await (0, primitives_1.deriveSharedSecret)(receiver.privateKey, sender.publicKey);
                // Secrets should match
                expect(Buffer.from(senderSecret).equals(Buffer.from(receiverSecret))).toBe(true);
                // Encrypt and decrypt
                const nonce = (0, primitives_1.randomBytes)(24);
                const encrypted = await (0, primitives_1.encryptMessage)(plaintext, senderSecret, nonce);
                const decrypted = await (0, primitives_1.decryptMessage)(encrypted, receiverSecret, nonce);
                expect(Buffer.from(decrypted).equals(Buffer.from(plaintext))).toBe(true);
            }), { numRuns: 50 });
        });
        it("should fail decryption with wrong key", async () => {
            await fast_check_1.default.assert(fast_check_1.default.asyncProperty(fast_check_1.default.uint8Array({ minLength: 1, maxLength: 1000 }), async (plaintext) => {
                const sender = await (0, primitives_1.generateIdentity)();
                const receiver = await (0, primitives_1.generateIdentity)();
                const attacker = await (0, primitives_1.generateIdentity)();
                const senderSecret = await (0, primitives_1.performKeyExchange)(sender.privateKey, receiver.publicKey);
                const attackerSecret = await (0, primitives_1.performKeyExchange)(attacker.privateKey, sender.publicKey);
                const nonce = (0, primitives_1.randomBytes)(24);
                const encrypted = await (0, primitives_1.encryptMessage)(plaintext, senderSecret, nonce);
                // decryptMessage is synchronous and throws on auth failure.
                // Use a try/catch to assert it throws instead of using `rejects`.
                let threw = false;
                try {
                    (0, primitives_1.decryptMessage)(encrypted, attackerSecret, nonce);
                }
                catch (err) {
                    threw = true;
                }
                expect(threw).toBe(true);
            }), { numRuns: 30 });
        });
    });
    describe("Key exchange properties", () => {
        it("should produce symmetric shared secrets (commutative)", async () => {
            await fast_check_1.default.assert(fast_check_1.default.asyncProperty(fast_check_1.default.nat(10), async () => {
                const alice = await (0, primitives_1.generateIdentity)();
                const bob = await (0, primitives_1.generateIdentity)();
                const aliceShared = await (0, primitives_1.deriveSharedSecret)(alice.privateKey, bob.publicKey);
                const bobShared = await (0, primitives_1.deriveSharedSecret)(bob.privateKey, alice.publicKey);
                expect(Buffer.from(aliceShared).equals(Buffer.from(bobShared))).toBe(true);
            }), { numRuns: 20 });
        });
        it("should produce different secrets for different key pairs", async () => {
            await fast_check_1.default.assert(fast_check_1.default.asyncProperty(fast_check_1.default.nat(10), async () => {
                const alice = await (0, primitives_1.generateIdentity)();
                const bob = await (0, primitives_1.generateIdentity)();
                const charlie = await (0, primitives_1.generateIdentity)();
                const aliceBobSecret = await (0, primitives_1.performKeyExchange)(alice.privateKey, bob.publicKey);
                const aliceCharlieSecret = await (0, primitives_1.performKeyExchange)(alice.privateKey, charlie.publicKey);
                expect(Buffer.from(aliceBobSecret).equals(Buffer.from(aliceCharlieSecret))).toBe(false);
            }), { numRuns: 20 });
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvY3J5cHRvL3Byb3BlcnR5LWJhc2VkLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7R0FFRztBQUNILDREQUE0QjtBQUM1Qiw2Q0FTc0I7QUFFdEIsUUFBUSxDQUFDLDZCQUE2QixFQUFFLEdBQUcsRUFBRTtJQUMzQyxRQUFRLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO1FBQ25DLEVBQUUsQ0FBQyxtQ0FBbUMsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNqRCxNQUFNLG9CQUFFLENBQUMsTUFBTSxDQUNiLG9CQUFFLENBQUMsYUFBYSxDQUFDLG9CQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssSUFBSSxFQUFFO2dCQUN0QyxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUEsNkJBQWdCLEdBQUUsQ0FBQztnQkFDM0MsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFBLDZCQUFnQixHQUFFLENBQUM7Z0JBRTNDLGtDQUFrQztnQkFDbEMsTUFBTSxDQUNKLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FDckMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQ2pDLENBQ0YsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2QsbUNBQW1DO2dCQUNuQyxNQUFNLENBQ0osTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxDQUN0QyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FDbEMsQ0FDRixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQixDQUFDLENBQUMsRUFDRixFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsQ0FDaEIsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFD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L0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvY3J5cHRvL3Byb3BlcnR5LWJhc2VkLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBQcm9wZXJ0eS1iYXNlZCB0ZXN0cyBmb3IgY3J5cHRvIHByaW1pdGl2ZXNcbiAqL1xuaW1wb3J0IGZjIGZyb20gXCJmYXN0LWNoZWNrXCI7XG5pbXBvcnQge1xuICBnZW5lcmF0ZUlkZW50aXR5LFxuICBzaWduTWVzc2FnZSxcbiAgdmVyaWZ5U2lnbmF0dXJlLFxuICBwZXJmb3JtS2V5RXhjaGFuZ2UsXG4gIGRlcml2ZVNoYXJlZFNlY3JldCxcbiAgZW5jcnlwdE1lc3NhZ2UsXG4gIGRlY3J5cHRNZXNzYWdlLFxuICByYW5kb21CeXRlcyxcbn0gZnJvbSBcIi4vcHJpbWl0aXZlc1wiO1xuXG5kZXNjcmliZShcIkNyeXB0byBQcm9wZXJ0eS1CYXNlZCBUZXN0c1wiLCAoKSA9PiB7XG4gIGRlc2NyaWJlKFwiSWRlbnRpdHkgZ2VuZXJhdGlvblwiLCAoKSA9PiB7XG4gICAgaXQoXCJzaG91bGQgZ2VuZXJhdGUgdW5pcXVlIGlkZW50aXRpZXNcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgZmMuYXNzZXJ0KFxuICAgICAgICBmYy5hc3luY1Byb3BlcnR5KGZjLm5hdCgxMCksIGFzeW5jICgpID0+IHtcbiAgICAgICAgICBjb25zdCBpZGVudGl0eTEgPSBhd2FpdCBnZW5lcmF0ZUlkZW50aXR5KCk7XG4gICAgICAgICAgY29uc3QgaWRlbnRpdHkyID0gYXdhaXQgZ2VuZXJhdGVJZGVudGl0eSgpO1xuXG4gICAgICAgICAgLy8gUHVibGljIGtleXMgc2hvdWxkIGJlIGRpZmZlcmVudFxuICAgICAgICAgIGV4cGVjdChcbiAgICAgICAgICAgIEJ1ZmZlci5mcm9tKGlkZW50aXR5MS5wdWJsaWNLZXkpLmVxdWFscyhcbiAgICAgICAgICAgICAgQnVmZmVyLmZyb20oaWRlbnRpdHkyLnB1YmxpY0tleSksXG4gICAgICAgICAgICApLFxuICAgICAgICAgICkudG9CZShmYWxzZSk7XG4gICAgICAgICAgLy8gUHJpdmF0ZSBrZXlzIHNob3VsZCBiZSBkaWZmZXJlbnRcbiAgICAgICAgICBleHBlY3QoXG4gICAgICAgICAgICBCdWZmZXIuZnJvbShpZGVudGl0eTEucHJpdmF0ZUtleSkuZXF1YWxzKFxuICAgICAgICAgICAgICBCdWZmZXIuZnJvbShpZGVudGl0eTIucHJpdmF0ZUtleSksXG4gICAgICAgICAgICApLFxuICAgICAgICAgICkudG9CZShmYWxzZSk7XG4gICAgICAgIH0pLFxuICAgICAgICB7IG51bVJ1bnM6IDEwIH0sXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgZ2VuZXJhdGUgdmFsaWQga2V5IHBhaXJzXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZjLmFzc2VydChcbiAgICAgICAgZmMuYXN5bmNQcm9wZXJ0eShmYy5uYXQoMTApLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgaWRlbnRpdHkgPSBhd2FpdCBnZW5lcmF0ZUlkZW50aXR5KCk7XG5cbiAgICAgICAgICAvLyBLZXlzIHNob3VsZCBoYXZlIGNvcnJlY3QgbGVuZ3RoXG4gICAgICAgICAgZXhwZWN0KGlkZW50aXR5LnB1YmxpY0tleS5sZW5ndGgpLnRvQmUoMzIpO1xuICAgICAgICAgIGV4cGVjdChpZGVudGl0eS5wcml2YXRlS2V5Lmxlbmd0aCkudG9CZSgzMik7XG5cbiAgICAgICAgICAvLyBLZXlzIHNob3VsZCBub3QgYmUgYWxsIHplcm9zXG4gICAgICAgICAgY29uc3QgcHViS2V5U3VtID0gaWRlbnRpdHkucHVibGljS2V5LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApO1xuICAgICAgICAgIGNvbnN0IHByaXZLZXlTdW0gPSBpZGVudGl0eS5wcml2YXRlS2V5LnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApO1xuICAgICAgICAgIGV4cGVjdChwdWJLZXlTdW0pLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgICAgICBleHBlY3QocHJpdktleVN1bSkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgICAgICB9KSxcbiAgICAgICAgeyBudW1SdW5zOiAxMCB9LFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoXCJNZXNzYWdlIHNpZ25pbmdcIiwgKCkgPT4ge1xuICAgIGl0KFwic2hvdWxkIHZlcmlmeSBhbnkgbWVzc2FnZSBzaWduZWQgd2l0aCB0aGUgc2FtZSBrZXlcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgZmMuYXNzZXJ0KFxuICAgICAgICBmYy5hc3luY1Byb3BlcnR5KFxuICAgICAgICAgIGZjLnVpbnQ4QXJyYXkoeyBtaW5MZW5ndGg6IDEsIG1heExlbmd0aDogMTAwMCB9KSxcbiAgICAgICAgICBhc3luYyAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaWRlbnRpdHkgPSBhd2FpdCBnZW5lcmF0ZUlkZW50aXR5KCk7XG4gICAgICAgICAgICBjb25zdCBzaWduYXR1cmUgPSBhd2FpdCBzaWduTWVzc2FnZShkYXRhLCBpZGVudGl0eS5wcml2YXRlS2V5KTtcbiAgICAgICAgICAgIGNvbnN0IGlzVmFsaWQgPSBhd2FpdCB2ZXJpZnlTaWduYXR1cmUoXG4gICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgIHNpZ25hdHVyZSxcbiAgICAgICAgICAgICAgaWRlbnRpdHkucHVibGljS2V5LFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgZXhwZWN0KGlzVmFsaWQpLnRvQmUodHJ1ZSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgKSxcbiAgICAgICAgeyBudW1SdW5zOiA1MCB9LFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIGZhaWwgdmVyaWZpY2F0aW9uIHdpdGggd3JvbmcgcHVibGljIGtleVwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBmYy5hc3NlcnQoXG4gICAgICAgIGZjLmFzeW5jUHJvcGVydHkoXG4gICAgICAgICAgZmMudWludDhBcnJheSh7IG1pbkxlbmd0aDogMSwgbWF4TGVuZ3RoOiAxMDAwIH0pLFxuICAgICAgICAgIGFzeW5jIChkYXRhKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpZGVudGl0eTEgPSBhd2FpdCBnZW5lcmF0ZUlkZW50aXR5KCk7XG4gICAgICAgICAgICBjb25zdCBpZGVudGl0eTIgPSBhd2FpdCBnZW5lcmF0ZUlkZW50aXR5KCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IGF3YWl0IHNpZ25NZXNzYWdlKGRhdGEsIGlkZW50aXR5MS5wcml2YXRlS2V5KTtcbiAgICAgICAgICAgIGNvbnN0IGlzVmFsaWQgPSBhd2FpdCB2ZXJpZnlTaWduYXR1cmUoXG4gICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgIHNpZ25hdHVyZSxcbiAgICAgICAgICAgICAgaWRlbnRpdHkyLnB1YmxpY0tleSxcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIC8vIFNob3VsZCBmYWlsIHdpdGggZGlmZmVyZW50IHB1YmxpYyBrZXlcbiAgICAgICAgICAgIGV4cGVjdChpc1ZhbGlkKS50b0JlKGZhbHNlKTtcbiAgICAgICAgICB9LFxuICAgICAgICApLFxuICAgICAgICB7IG51bVJ1bnM6IDUwIH0sXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgZmFpbCB2ZXJpZmljYXRpb24gd2l0aCB0YW1wZXJlZCBkYXRhXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZjLmFzc2VydChcbiAgICAgICAgZmMuYXN5bmNQcm9wZXJ0eShcbiAgICAgICAgICBmYy51aW50OEFycmF5KHsgbWluTGVuZ3RoOiAyLCBtYXhMZW5ndGg6IDEwMDAgfSksXG4gICAgICAgICAgYXN5bmMgKGRhdGEpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGlkZW50aXR5ID0gYXdhaXQgZ2VuZXJhdGVJZGVudGl0eSgpO1xuICAgICAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gYXdhaXQgc2lnbk1lc3NhZ2UoZGF0YSwgaWRlbnRpdHkucHJpdmF0ZUtleSk7XG5cbiAgICAgICAgICAgIC8vIFRhbXBlciB3aXRoIGRhdGFcbiAgICAgICAgICAgIGNvbnN0IHRhbXBlcmVkRGF0YSA9IG5ldyBVaW50OEFycmF5KGRhdGEpO1xuICAgICAgICAgICAgdGFtcGVyZWREYXRhWzBdID0gKHRhbXBlcmVkRGF0YVswXSArIDEpICUgMjU2O1xuXG4gICAgICAgICAgICBjb25zdCBpc1ZhbGlkID0gYXdhaXQgdmVyaWZ5U2lnbmF0dXJlKFxuICAgICAgICAgICAgICB0YW1wZXJlZERhdGEsXG4gICAgICAgICAgICAgIHNpZ25hdHVyZSxcbiAgICAgICAgICAgICAgaWRlbnRpdHkucHVibGljS2V5LFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgZXhwZWN0KGlzVmFsaWQpLnRvQmUoZmFsc2UpO1xuICAgICAgICAgIH0sXG4gICAgICAgICksXG4gICAgICAgIHsgbnVtUnVuczogNTAgfSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwiRW5jcnlwdGlvbi9EZWNyeXB0aW9uXCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCBkZWNyeXB0IGFueSBtZXNzYWdlIGVuY3J5cHRlZCB3aXRoIHRoZSBzYW1lIGtleVwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBmYy5hc3NlcnQoXG4gICAgICAgIGZjLmFzeW5jUHJvcGVydHkoXG4gICAgICAgICAgZmMudWludDhBcnJheSh7IG1pbkxlbmd0aDogMSwgbWF4TGVuZ3RoOiAxMDAwIH0pLFxuICAgICAgICAgIGFzeW5jIChwbGFpbnRleHQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNlbmRlciA9IGF3YWl0IGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICAgICAgICAgIGNvbnN0IHJlY2VpdmVyID0gYXdhaXQgZ2VuZXJhdGVJZGVudGl0eSgpO1xuXG4gICAgICAgICAgICAvLyBEZXJpdmUgc2hhcmVkIHNlY3JldFxuICAgICAgICAgICAgY29uc3Qgc2VuZGVyU2VjcmV0ID0gYXdhaXQgZGVyaXZlU2hhcmVkU2VjcmV0KFxuICAgICAgICAgICAgICBzZW5kZXIucHJpdmF0ZUtleSxcbiAgICAgICAgICAgICAgcmVjZWl2ZXIucHVibGljS2V5LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnN0IHJlY2VpdmVyU2VjcmV0ID0gYXdhaXQgZGVyaXZlU2hhcmVkU2VjcmV0KFxuICAgICAgICAgICAgICByZWNlaXZlci5wcml2YXRlS2V5LFxuICAgICAgICAgICAgICBzZW5kZXIucHVibGljS2V5LFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgLy8gU2VjcmV0cyBzaG91bGQgbWF0Y2hcbiAgICAgICAgICAgIGV4cGVjdChcbiAgICAgICAgICAgICAgQnVmZmVyLmZyb20oc2VuZGVyU2VjcmV0KS5lcXVhbHMoQnVmZmVyLmZyb20ocmVjZWl2ZXJTZWNyZXQpKSxcbiAgICAgICAgICAgICkudG9CZSh0cnVlKTtcblxuICAgICAgICAgICAgLy8gRW5jcnlwdCBhbmQgZGVjcnlwdFxuICAgICAgICAgICAgY29uc3Qgbm9uY2UgPSByYW5kb21CeXRlcygyNCk7XG4gICAgICAgICAgICBjb25zdCBlbmNyeXB0ZWQgPSBhd2FpdCBlbmNyeXB0TWVzc2FnZShcbiAgICAgICAgICAgICAgcGxhaW50ZXh0LFxuICAgICAgICAgICAgICBzZW5kZXJTZWNyZXQsXG4gICAgICAgICAgICAgIG5vbmNlLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnN0IGRlY3J5cHRlZCA9IGF3YWl0IGRlY3J5cHRNZXNzYWdlKFxuICAgICAgICAgICAgICBlbmNyeXB0ZWQsXG4gICAgICAgICAgICAgIHJlY2VpdmVyU2VjcmV0LFxuICAgICAgICAgICAgICBub25jZSxcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGV4cGVjdChCdWZmZXIuZnJvbShkZWNyeXB0ZWQpLmVxdWFscyhCdWZmZXIuZnJvbShwbGFpbnRleHQpKSkudG9CZShcbiAgICAgICAgICAgICAgdHJ1ZSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSxcbiAgICAgICAgKSxcbiAgICAgICAgeyBudW1SdW5zOiA1MCB9LFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIGZhaWwgZGVjcnlwdGlvbiB3aXRoIHdyb25nIGtleVwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBmYy5hc3NlcnQoXG4gICAgICAgIGZjLmFzeW5jUHJvcGVydHkoXG4gICAgICAgICAgZmMudWludDhBcnJheSh7IG1pbkxlbmd0aDogMSwgbWF4TGVuZ3RoOiAxMDAwIH0pLFxuICAgICAgICAgIGFzeW5jIChwbGFpbnRleHQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHNlbmRlciA9IGF3YWl0IGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICAgICAgICAgIGNvbnN0IHJlY2VpdmVyID0gYXdhaXQgZ2VuZXJhdGVJZGVudGl0eSgpO1xuICAgICAgICAgICAgY29uc3QgYXR0YWNrZXIgPSBhd2FpdCBnZW5lcmF0ZUlkZW50aXR5KCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHNlbmRlclNlY3JldCA9IGF3YWl0IHBlcmZvcm1LZXlFeGNoYW5nZShcbiAgICAgICAgICAgICAgc2VuZGVyLnByaXZhdGVLZXksXG4gICAgICAgICAgICAgIHJlY2VpdmVyLnB1YmxpY0tleSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb25zdCBhdHRhY2tlclNlY3JldCA9IGF3YWl0IHBlcmZvcm1LZXlFeGNoYW5nZShcbiAgICAgICAgICAgICAgYXR0YWNrZXIucHJpdmF0ZUtleSxcbiAgICAgICAgICAgICAgc2VuZGVyLnB1YmxpY0tleSxcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGNvbnN0IG5vbmNlID0gcmFuZG9tQnl0ZXMoMjQpO1xuICAgICAgICAgICAgY29uc3QgZW5jcnlwdGVkID0gYXdhaXQgZW5jcnlwdE1lc3NhZ2UoXG4gICAgICAgICAgICAgIHBsYWludGV4dCxcbiAgICAgICAgICAgICAgc2VuZGVyU2VjcmV0LFxuICAgICAgICAgICAgICBub25jZSxcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIC8vIGRlY3J5cHRNZXNzYWdlIGlzIHN5bmNocm9ub3VzIGFuZCB0aHJvd3Mgb24gYXV0aCBmYWlsdXJlLlxuICAgICAgICAgICAgLy8gVXNlIGEgdHJ5L2NhdGNoIHRvIGFzc2VydCBpdCB0aHJvd3MgaW5zdGVhZCBvZiB1c2luZyBgcmVqZWN0c2AuXG4gICAgICAgICAgICBsZXQgdGhyZXcgPSBmYWxzZTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGRlY3J5cHRNZXNzYWdlKGVuY3J5cHRlZCwgYXR0YWNrZXJTZWNyZXQsIG5vbmNlKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICB0aHJldyA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGV4cGVjdCh0aHJldykudG9CZSh0cnVlKTtcbiAgICAgICAgICB9LFxuICAgICAgICApLFxuICAgICAgICB7IG51bVJ1bnM6IDMwIH0sXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZShcIktleSBleGNoYW5nZSBwcm9wZXJ0aWVzXCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCBwcm9kdWNlIHN5bW1ldHJpYyBzaGFyZWQgc2VjcmV0cyAoY29tbXV0YXRpdmUpXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZjLmFzc2VydChcbiAgICAgICAgZmMuYXN5bmNQcm9wZXJ0eShmYy5uYXQoMTApLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgYWxpY2UgPSBhd2FpdCBnZW5lcmF0ZUlkZW50aXR5KCk7XG4gICAgICAgICAgY29uc3QgYm9iID0gYXdhaXQgZ2VuZXJhdGVJZGVudGl0eSgpO1xuXG4gICAgICAgICAgY29uc3QgYWxpY2VTaGFyZWQgPSBhd2FpdCBkZXJpdmVTaGFyZWRTZWNyZXQoXG4gICAgICAgICAgICBhbGljZS5wcml2YXRlS2V5LFxuICAgICAgICAgICAgYm9iLnB1YmxpY0tleSxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IGJvYlNoYXJlZCA9IGF3YWl0IGRlcml2ZVNoYXJlZFNlY3JldChcbiAgICAgICAgICAgIGJvYi5wcml2YXRlS2V5LFxuICAgICAgICAgICAgYWxpY2UucHVibGljS2V5LFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBleHBlY3QoQnVmZmVyLmZyb20oYWxpY2VTaGFyZWQpLmVxdWFscyhCdWZmZXIuZnJvbShib2JTaGFyZWQpKSkudG9CZShcbiAgICAgICAgICAgIHRydWUsXG4gICAgICAgICAgKTtcbiAgICAgICAgfSksXG4gICAgICAgIHsgbnVtUnVuczogMjAgfSxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCBwcm9kdWNlIGRpZmZlcmVudCBzZWNyZXRzIGZvciBkaWZmZXJlbnQga2V5IHBhaXJzXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGZjLmFzc2VydChcbiAgICAgICAgZmMuYXN5bmNQcm9wZXJ0eShmYy5uYXQoMTApLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgY29uc3QgYWxpY2UgPSBhd2FpdCBnZW5lcmF0ZUlkZW50aXR5KCk7XG4gICAgICAgICAgY29uc3QgYm9iID0gYXdhaXQgZ2VuZXJhdGVJZGVudGl0eSgpO1xuICAgICAgICAgIGNvbnN0IGNoYXJsaWUgPSBhd2FpdCBnZW5lcmF0ZUlkZW50aXR5KCk7XG5cbiAgICAgICAgICBjb25zdCBhbGljZUJvYlNlY3JldCA9IGF3YWl0IHBlcmZvcm1LZXlFeGNoYW5nZShcbiAgICAgICAgICAgIGFsaWNlLnByaXZhdGVLZXksXG4gICAgICAgICAgICBib2IucHVibGljS2V5LFxuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3QgYWxpY2VDaGFybGllU2VjcmV0ID0gYXdhaXQgcGVyZm9ybUtleUV4Y2hhbmdlKFxuICAgICAgICAgICAgYWxpY2UucHJpdmF0ZUtleSxcbiAgICAgICAgICAgIGNoYXJsaWUucHVibGljS2V5LFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICBleHBlY3QoXG4gICAgICAgICAgICBCdWZmZXIuZnJvbShhbGljZUJvYlNlY3JldCkuZXF1YWxzKEJ1ZmZlci5mcm9tKGFsaWNlQ2hhcmxpZVNlY3JldCkpLFxuICAgICAgICAgICkudG9CZShmYWxzZSk7XG4gICAgICAgIH0pLFxuICAgICAgICB7IG51bVJ1bnM6IDIwIH0sXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9