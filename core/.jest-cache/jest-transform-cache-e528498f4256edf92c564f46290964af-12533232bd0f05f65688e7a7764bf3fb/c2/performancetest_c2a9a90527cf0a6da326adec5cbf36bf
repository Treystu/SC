e6b82f755a40b288524abfe3db5b66d9
"use strict";
/**
 * Performance Regression Tests
 *
 * Ensures cryptographic operations maintain acceptable performance
 */
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const primitives_1 = require("./primitives");
// Performance thresholds (in milliseconds)
const THRESHOLDS = {
    keyGeneration: 50,
    signing: 20,
    verification: 20,
    encryption: 40,
    decryption: 40,
    keyExchange: 40,
    bulkEncryption: 2000, // for 1MB
    bulkDecryption: 2000,
};
/**
 * Measures execution time of a function
 */
function measure(fn) {
    const start = performance.now();
    fn();
    const end = performance.now();
    return end - start;
}
/**
 * Runs a function multiple times and returns average time
 */
function measureAverage(fn, iterations) {
    const times = [];
    // Warmup
    for (let i = 0; i < 10; i++) {
        fn();
    }
    // Measure
    for (let i = 0; i < iterations; i++) {
        times.push(measure(fn));
    }
    return times.reduce((a, b) => a + b, 0) / times.length;
}
(0, globals_1.describe)('Crypto Performance Tests', () => {
    (0, globals_1.describe)('Key Generation Performance', () => {
        (0, globals_1.it)('should generate keypair within threshold', () => {
            const avgTime = measureAverage(() => {
                (0, primitives_1.generateIdentity)();
            }, 100);
            console.log(`Key generation average: ${avgTime.toFixed(2)}ms`);
            (0, globals_1.expect)(avgTime).toBeLessThan(THRESHOLDS.keyGeneration);
        });
        (0, globals_1.it)('should generate 100 keypairs in reasonable time', () => {
            const totalTime = measure(() => {
                for (let i = 0; i < 100; i++) {
                    (0, primitives_1.generateIdentity)();
                }
            });
            console.log(`100 keypairs: ${totalTime.toFixed(2)}ms`);
            (0, globals_1.expect)(totalTime).toBeLessThan(THRESHOLDS.keyGeneration * 100);
        });
    });
    (0, globals_1.describe)('Signature Performance', () => {
        const keypair = (0, primitives_1.generateIdentity)();
        const message = new Uint8Array(1024); // 1KB message
        (0, globals_1.it)('should sign message within threshold', () => {
            const avgTime = measureAverage(() => {
                (0, primitives_1.signMessage)(message, keypair.privateKey);
            }, 100);
            console.log(`Signing average: ${avgTime.toFixed(2)}ms`);
            (0, globals_1.expect)(avgTime).toBeLessThan(THRESHOLDS.signing);
        });
        (0, globals_1.it)('should verify signature within threshold', () => {
            const signature = (0, primitives_1.signMessage)(message, keypair.privateKey);
            const avgTime = measureAverage(() => {
                (0, primitives_1.verifySignature)(message, signature, keypair.publicKey);
            }, 100);
            console.log(`Verification average: ${avgTime.toFixed(2)}ms`);
            (0, globals_1.expect)(avgTime).toBeLessThan(THRESHOLDS.verification);
        });
        (0, globals_1.it)('should handle 1000 signatures/sec', () => {
            const totalTime = measure(() => {
                for (let i = 0; i < 1000; i++) {
                    (0, primitives_1.signMessage)(message, keypair.privateKey);
                }
            });
            console.log(`1000 signatures: ${totalTime.toFixed(2)}ms`);
            (0, globals_1.expect)(totalTime).toBeLessThan(1000 * THRESHOLDS.signing);
        });
    });
    (0, globals_1.describe)('Encryption Performance', () => {
        const keypair = (0, primitives_1.generateIdentity)();
        const sessionKey = (0, primitives_1.generateSessionKey)();
        const message = new Uint8Array(1024); // 1KB message
        (0, globals_1.it)('should encrypt message within threshold', () => {
            const avgTime = measureAverage(() => {
                (0, primitives_1.encryptMessage)(message, sessionKey.key, sessionKey.nonce);
            }, 100);
            console.log(`Encryption average: ${avgTime.toFixed(2)}ms`);
            (0, globals_1.expect)(avgTime).toBeLessThan(THRESHOLDS.encryption);
        });
        (0, globals_1.it)('should decrypt message within threshold', () => {
            const encrypted = (0, primitives_1.encryptMessage)(message, sessionKey.key, sessionKey.nonce);
            const avgTime = measureAverage(() => {
                (0, primitives_1.decryptMessage)(encrypted, sessionKey.key, sessionKey.nonce);
            }, 100);
            console.log(`Decryption average: ${avgTime.toFixed(2)}ms`);
            (0, globals_1.expect)(avgTime).toBeLessThan(THRESHOLDS.decryption);
        });
    });
    (0, globals_1.describe)('Bulk Encryption Performance', () => {
        const keypair = (0, primitives_1.generateIdentity)();
        const sessionKey = (0, primitives_1.generateSessionKey)();
        const largeMessage = new Uint8Array(1024 * 1024); // 1MB
        (0, globals_1.it)('should encrypt 1MB within threshold', () => {
            const time = measure(() => {
                (0, primitives_1.encryptMessage)(largeMessage, sessionKey.key, sessionKey.nonce);
            });
            console.log(`Encrypt 1MB: ${time.toFixed(2)}ms`);
            (0, globals_1.expect)(time).toBeLessThan(THRESHOLDS.bulkEncryption);
        });
        (0, globals_1.it)('should decrypt 1MB within threshold', () => {
            const encrypted = (0, primitives_1.encryptMessage)(largeMessage, sessionKey.key, sessionKey.nonce);
            const time = measure(() => {
                (0, primitives_1.decryptMessage)(encrypted, sessionKey.key, sessionKey.nonce);
            });
            console.log(`Decrypt 1MB: ${time.toFixed(2)}ms`);
            (0, globals_1.expect)(time).toBeLessThan(THRESHOLDS.bulkDecryption);
        });
        (0, globals_1.it)('should maintain performance for multiple large encryptions', () => {
            const times = [];
            for (let i = 0; i < 10; i++) {
                // Generate new session key for each iteration
                const sk = (0, primitives_1.generateSessionKey)();
                const time = measure(() => {
                    (0, primitives_1.encryptMessage)(largeMessage, sk.key, sk.nonce);
                });
                times.push(time);
            }
            const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
            const maxTime = Math.max(...times);
            console.log(`Avg bulk encrypt: ${avgTime.toFixed(2)}ms, Max: ${maxTime.toFixed(2)}ms`);
            (0, globals_1.expect)(maxTime).toBeLessThan(THRESHOLDS.bulkEncryption * 1.5);
        });
    });
    (0, globals_1.describe)('Key Exchange Performance', () => {
        const kp1 = (0, primitives_1.generateIdentity)();
        const kp2 = (0, primitives_1.generateIdentity)();
        (0, globals_1.it)('should derive shared secret within threshold', () => {
            const avgTime = measureAverage(() => {
                (0, primitives_1.performKeyExchange)(kp1.privateKey, kp2.publicKey);
            }, 100);
            console.log(`Key exchange average: ${avgTime.toFixed(2)}ms`);
            (0, globals_1.expect)(avgTime).toBeLessThan(THRESHOLDS.keyExchange);
        });
        (0, globals_1.it)('should handle 1000 key exchanges/sec', () => {
            const totalTime = measure(() => {
                for (let i = 0; i < 1000; i++) {
                    (0, primitives_1.performKeyExchange)(kp1.privateKey, kp2.publicKey);
                }
            });
            console.log(`1000 key exchanges: ${totalTime.toFixed(2)}ms`);
            (0, globals_1.expect)(totalTime).toBeLessThan(1000 * THRESHOLDS.keyExchange);
        });
    });
    (0, globals_1.describe)('Real-World Scenarios', () => {
        (0, globals_1.it)('should handle typical messaging workload', () => {
            const aliceKp = (0, primitives_1.generateIdentity)();
            const bobKp = (0, primitives_1.generateIdentity)();
            const messages = Array(100).fill(null).map((_, i) => new Uint8Array(512).fill(i % 256));
            const totalTime = measure(() => {
                const aliceShared = (0, primitives_1.performKeyExchange)(aliceKp.privateKey, bobKp.publicKey);
                messages.forEach(msg => {
                    const signature = (0, primitives_1.signMessage)(msg, aliceKp.privateKey);
                    const sk = (0, primitives_1.generateSessionKey)();
                    const encrypted = (0, primitives_1.encryptMessage)(msg, sk.key, sk.nonce);
                    (0, primitives_1.verifySignature)(msg, signature, aliceKp.publicKey);
                    (0, primitives_1.decryptMessage)(encrypted, sk.key, sk.nonce);
                });
            });
            console.log(`100 message workflow: ${totalTime.toFixed(2)}ms`);
            (0, globals_1.expect)(totalTime).toBeLessThan(5000); // 5 seconds for 100 messages
        });
        (0, globals_1.it)('should handle peer handshake efficiently', () => {
            const totalTime = measure(() => {
                // Simulate 10 peer handshakes
                for (let i = 0; i < 10; i++) {
                    const peer1 = (0, primitives_1.generateIdentity)();
                    const peer2 = (0, primitives_1.generateIdentity)();
                    // Exchange keys
                    const shared1 = (0, primitives_1.performKeyExchange)(peer1.privateKey, peer2.publicKey);
                    const shared2 = (0, primitives_1.performKeyExchange)(peer2.privateKey, peer1.publicKey);
                    // Challenge-response
                    const challenge = new Uint8Array(32);
                    const sig1 = (0, primitives_1.signMessage)(challenge, peer1.privateKey);
                    const sig2 = (0, primitives_1.signMessage)(challenge, peer2.privateKey);
                    (0, primitives_1.verifySignature)(challenge, sig1, peer1.publicKey);
                    (0, primitives_1.verifySignature)(challenge, sig2, peer2.publicKey);
                }
            });
            console.log(`10 peer handshakes: ${totalTime.toFixed(2)}ms`);
            (0, globals_1.expect)(totalTime).toBeLessThan(1000);
        });
    });
    (0, globals_1.describe)('Memory Performance', () => {
        (0, globals_1.it)('should not leak memory during repeated operations', () => {
            if (global.gc) {
                global.gc();
                const initialMemory = process.memoryUsage().heapUsed;
                // Perform many operations
                for (let i = 0; i < 1000; i++) {
                    const kp = (0, primitives_1.generateIdentity)();
                    const msg = new Uint8Array(1024);
                    const sig = (0, primitives_1.signMessage)(msg, kp.privateKey);
                    (0, primitives_1.verifySignature)(msg, sig, kp.publicKey);
                }
                global.gc();
                const finalMemory = process.memoryUsage().heapUsed;
                const memoryIncrease = (finalMemory - initialMemory) / 1024 / 1024;
                console.log(`Memory increase: ${memoryIncrease.toFixed(2)}MB`);
                (0, globals_1.expect)(memoryIncrease).toBeLessThan(50); // Less than 50MB increase
            }
            else {
                console.log('Run with --expose-gc to test memory');
            }
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvY3J5cHRvL3BlcmZvcm1hbmNlLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7O0FBRUgsMkNBQXFEO0FBQ3JELDZDQVFzQjtBQUV0QiwyQ0FBMkM7QUFDM0MsTUFBTSxVQUFVLEdBQUc7SUFDakIsYUFBYSxFQUFFLEVBQUU7SUFDakIsT0FBTyxFQUFFLEVBQUU7SUFDWCxZQUFZLEVBQUUsRUFBRTtJQUNoQixVQUFVLEVBQUUsRUFBRTtJQUNkLFVBQVUsRUFBRSxFQUFFO0lBQ2QsV0FBVyxFQUFFLEVBQUU7SUFDZixjQUFjLEVBQUUsSUFBSSxFQUFFLFVBQVU7SUFDaEMsY0FBYyxFQUFFLElBQUk7Q0FDckIsQ0FBQztBQUVGOztHQUVHO0FBQ0gsU0FBUyxPQUFPLENBQUMsRUFBYztJQUM3QixNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDaEMsRUFBRSxFQUFFLENBQUM7SUFDTCxNQUFNLEdBQUcsR0FBRyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDOUIsT0FBTyxHQUFHLEdBQUcsS0FBSyxDQUFDO0FBQ3JCLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsY0FBYyxDQUFDLEVBQWMsRUFBRSxVQUFrQjtJQUN4RCxNQUFNLEtBQUssR0FBYSxFQUFFLENBQUM7SUFFM0IsU0FBUztJQUNULEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUM1QixFQUFFLEVBQUUsQ0FBQztJQUNQLENBQUM7SUFFRCxVQUFVO0lBQ1YsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFVBQVUsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3BDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDMUIs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Q0FBQztnQkFDL0QsSUFBQSxnQkFBTSxFQUFDLGNBQWMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLDBCQUEwQjtZQUNyRSxDQUFDO2lCQUFNLENBQUM7Z0JBQ04sT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1lBQ3JELENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvY3J5cHRvL3BlcmZvcm1hbmNlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBQZXJmb3JtYW5jZSBSZWdyZXNzaW9uIFRlc3RzXG4gKiBcbiAqIEVuc3VyZXMgY3J5cHRvZ3JhcGhpYyBvcGVyYXRpb25zIG1haW50YWluIGFjY2VwdGFibGUgcGVyZm9ybWFuY2VcbiAqL1xuXG5pbXBvcnQgeyBkZXNjcmliZSwgaXQsIGV4cGVjdCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuaW1wb3J0IHtcbiAgZ2VuZXJhdGVJZGVudGl0eSxcbiAgc2lnbk1lc3NhZ2UsXG4gIHZlcmlmeVNpZ25hdHVyZSxcbiAgZW5jcnlwdE1lc3NhZ2UsXG4gIGRlY3J5cHRNZXNzYWdlLFxuICBwZXJmb3JtS2V5RXhjaGFuZ2UsXG4gIGdlbmVyYXRlU2Vzc2lvbktleVxufSBmcm9tICcuL3ByaW1pdGl2ZXMnO1xuXG4vLyBQZXJmb3JtYW5jZSB0aHJlc2hvbGRzIChpbiBtaWxsaXNlY29uZHMpXG5jb25zdCBUSFJFU0hPTERTID0ge1xuICBrZXlHZW5lcmF0aW9uOiA1MCxcbiAgc2lnbmluZzogMjAsXG4gIHZlcmlmaWNhdGlvbjogMjAsXG4gIGVuY3J5cHRpb246IDQwLFxuICBkZWNyeXB0aW9uOiA0MCxcbiAga2V5RXhjaGFuZ2U6IDQwLFxuICBidWxrRW5jcnlwdGlvbjogMjAwMCwgLy8gZm9yIDFNQlxuICBidWxrRGVjcnlwdGlvbjogMjAwMCxcbn07XG5cbi8qKlxuICogTWVhc3VyZXMgZXhlY3V0aW9uIHRpbWUgb2YgYSBmdW5jdGlvblxuICovXG5mdW5jdGlvbiBtZWFzdXJlKGZuOiAoKSA9PiB2b2lkKTogbnVtYmVyIHtcbiAgY29uc3Qgc3RhcnQgPSBwZXJmb3JtYW5jZS5ub3coKTtcbiAgZm4oKTtcbiAgY29uc3QgZW5kID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gIHJldHVybiBlbmQgLSBzdGFydDtcbn1cblxuLyoqXG4gKiBSdW5zIGEgZnVuY3Rpb24gbXVsdGlwbGUgdGltZXMgYW5kIHJldHVybnMgYXZlcmFnZSB0aW1lXG4gKi9cbmZ1bmN0aW9uIG1lYXN1cmVBdmVyYWdlKGZuOiAoKSA9PiB2b2lkLCBpdGVyYXRpb25zOiBudW1iZXIpOiBudW1iZXIge1xuICBjb25zdCB0aW1lczogbnVtYmVyW10gPSBbXTtcblxuICAvLyBXYXJtdXBcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDsgaSsrKSB7XG4gICAgZm4oKTtcbiAgfVxuXG4gIC8vIE1lYXN1cmVcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVyYXRpb25zOyBpKyspIHtcbiAgICB0aW1lcy5wdXNoKG1lYXN1cmUoZm4pKTtcbiAgfVxuXG4gIHJldHVybiB0aW1lcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHRpbWVzLmxlbmd0aDtcbn1cblxuZGVzY3JpYmUoJ0NyeXB0byBQZXJmb3JtYW5jZSBUZXN0cycsICgpID0+IHtcbiAgZGVzY3JpYmUoJ0tleSBHZW5lcmF0aW9uIFBlcmZvcm1hbmNlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUga2V5cGFpciB3aXRoaW4gdGhyZXNob2xkJywgKCkgPT4ge1xuICAgICAgY29uc3QgYXZnVGltZSA9IG1lYXN1cmVBdmVyYWdlKCgpID0+IHtcbiAgICAgICAgZ2VuZXJhdGVJZGVudGl0eSgpO1xuICAgICAgfSwgMTAwKTtcblxuICAgICAgY29uc29sZS5sb2coYEtleSBnZW5lcmF0aW9uIGF2ZXJhZ2U6ICR7YXZnVGltZS50b0ZpeGVkKDIpfW1zYCk7XG4gICAgICBleHBlY3QoYXZnVGltZSkudG9CZUxlc3NUaGFuKFRIUkVTSE9MRFMua2V5R2VuZXJhdGlvbik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIDEwMCBrZXlwYWlycyBpbiByZWFzb25hYmxlIHRpbWUnLCAoKSA9PiB7XG4gICAgICBjb25zdCB0b3RhbFRpbWUgPSBtZWFzdXJlKCgpID0+IHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDA7IGkrKykge1xuICAgICAgICAgIGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnNvbGUubG9nKGAxMDAga2V5cGFpcnM6ICR7dG90YWxUaW1lLnRvRml4ZWQoMil9bXNgKTtcbiAgICAgIGV4cGVjdCh0b3RhbFRpbWUpLnRvQmVMZXNzVGhhbihUSFJFU0hPTERTLmtleUdlbmVyYXRpb24gKiAxMDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnU2lnbmF0dXJlIFBlcmZvcm1hbmNlJywgKCkgPT4ge1xuICAgIGNvbnN0IGtleXBhaXIgPSBnZW5lcmF0ZUlkZW50aXR5KCk7XG4gICAgY29uc3QgbWVzc2FnZSA9IG5ldyBVaW50OEFycmF5KDEwMjQpOyAvLyAxS0IgbWVzc2FnZVxuXG4gICAgaXQoJ3Nob3VsZCBzaWduIG1lc3NhZ2Ugd2l0aGluIHRocmVzaG9sZCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGF2Z1RpbWUgPSBtZWFzdXJlQXZlcmFnZSgoKSA9PiB7XG4gICAgICAgIHNpZ25NZXNzYWdlKG1lc3NhZ2UsIGtleXBhaXIucHJpdmF0ZUtleSk7XG4gICAgICB9LCAxMDApO1xuXG4gICAgICBjb25zb2xlLmxvZyhgU2lnbmluZyBhdmVyYWdlOiAke2F2Z1RpbWUudG9GaXhlZCgyKX1tc2ApO1xuICAgICAgZXhwZWN0KGF2Z1RpbWUpLnRvQmVMZXNzVGhhbihUSFJFU0hPTERTLnNpZ25pbmcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB2ZXJpZnkgc2lnbmF0dXJlIHdpdGhpbiB0aHJlc2hvbGQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzaWduYXR1cmUgPSBzaWduTWVzc2FnZShtZXNzYWdlLCBrZXlwYWlyLnByaXZhdGVLZXkpO1xuXG4gICAgICBjb25zdCBhdmdUaW1lID0gbWVhc3VyZUF2ZXJhZ2UoKCkgPT4ge1xuICAgICAgICB2ZXJpZnlTaWduYXR1cmUobWVzc2FnZSwgc2lnbmF0dXJlLCBrZXlwYWlyLnB1YmxpY0tleSk7XG4gICAgICB9LCAxMDApO1xuXG4gICAgICBjb25zb2xlLmxvZyhgVmVyaWZpY2F0aW9uIGF2ZXJhZ2U6ICR7YXZnVGltZS50b0ZpeGVkKDIpfW1zYCk7XG4gICAgICBleHBlY3QoYXZnVGltZSkudG9CZUxlc3NUaGFuKFRIUkVTSE9MRFMudmVyaWZpY2F0aW9uKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIDEwMDAgc2lnbmF0dXJlcy9zZWMnLCAoKSA9PiB7XG4gICAgICBjb25zdCB0b3RhbFRpbWUgPSBtZWFzdXJlKCgpID0+IHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDAwOyBpKyspIHtcbiAgICAgICAgICBzaWduTWVzc2FnZShtZXNzYWdlLCBrZXlwYWlyLnByaXZhdGVLZXkpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgY29uc29sZS5sb2coYDEwMDAgc2lnbmF0dXJlczogJHt0b3RhbFRpbWUudG9GaXhlZCgyKX1tc2ApO1xuICAgICAgZXhwZWN0KHRvdGFsVGltZSkudG9CZUxlc3NUaGFuKDEwMDAgKiBUSFJFU0hPTERTLnNpZ25pbmcpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRW5jcnlwdGlvbiBQZXJmb3JtYW5jZScsICgpID0+IHtcbiAgICBjb25zdCBrZXlwYWlyID0gZ2VuZXJhdGVJZGVudGl0eSgpO1xuICAgIGNvbnN0IHNlc3Npb25LZXkgPSBnZW5lcmF0ZVNlc3Npb25LZXkoKTtcbiAgICBjb25zdCBtZXNzYWdlID0gbmV3IFVpbnQ4QXJyYXkoMTAyNCk7IC8vIDFLQiBtZXNzYWdlXG5cbiAgICBpdCgnc2hvdWxkIGVuY3J5cHQgbWVzc2FnZSB3aXRoaW4gdGhyZXNob2xkJywgKCkgPT4ge1xuICAgICAgY29uc3QgYXZnVGltZSA9IG1lYXN1cmVBdmVyYWdlKCgpID0+IHtcbiAgICAgICAgZW5jcnlwdE1lc3NhZ2UobWVzc2FnZSwgc2Vzc2lvbktleS5rZXksIHNlc3Npb25LZXkubm9uY2UpO1xuICAgICAgfSwgMTAwKTtcblxuICAgICAgY29uc29sZS5sb2coYEVuY3J5cHRpb24gYXZlcmFnZTogJHthdmdUaW1lLnRvRml4ZWQoMil9bXNgKTtcbiAgICAgIGV4cGVjdChhdmdUaW1lKS50b0JlTGVzc1RoYW4oVEhSRVNIT0xEUy5lbmNyeXB0aW9uKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZGVjcnlwdCBtZXNzYWdlIHdpdGhpbiB0aHJlc2hvbGQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBlbmNyeXB0ZWQgPSBlbmNyeXB0TWVzc2FnZShtZXNzYWdlLCBzZXNzaW9uS2V5LmtleSwgc2Vzc2lvbktleS5ub25jZSk7XG5cbiAgICAgIGNvbnN0IGF2Z1RpbWUgPSBtZWFzdXJlQXZlcmFnZSgoKSA9PiB7XG4gICAgICAgIGRlY3J5cHRNZXNzYWdlKGVuY3J5cHRlZCwgc2Vzc2lvbktleS5rZXksIHNlc3Npb25LZXkubm9uY2UpO1xuICAgICAgfSwgMTAwKTtcblxuICAgICAgY29uc29sZS5sb2coYERlY3J5cHRpb24gYXZlcmFnZTogJHthdmdUaW1lLnRvRml4ZWQoMil9bXNgKTtcbiAgICAgIGV4cGVjdChhdmdUaW1lKS50b0JlTGVzc1RoYW4oVEhSRVNIT0xEUy5kZWNyeXB0aW9uKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0J1bGsgRW5jcnlwdGlvbiBQZXJmb3JtYW5jZScsICgpID0+IHtcbiAgICBjb25zdCBrZXlwYWlyID0gZ2VuZXJhdGVJZGVudGl0eSgpO1xuICAgIGNvbnN0IHNlc3Npb25LZXkgPSBnZW5lcmF0ZVNlc3Npb25LZXkoKTtcbiAgICBjb25zdCBsYXJnZU1lc3NhZ2UgPSBuZXcgVWludDhBcnJheSgxMDI0ICogMTAyNCk7IC8vIDFNQlxuXG4gICAgaXQoJ3Nob3VsZCBlbmNyeXB0IDFNQiB3aXRoaW4gdGhyZXNob2xkJywgKCkgPT4ge1xuICAgICAgY29uc3QgdGltZSA9IG1lYXN1cmUoKCkgPT4ge1xuICAgICAgICBlbmNyeXB0TWVzc2FnZShsYXJnZU1lc3NhZ2UsIHNlc3Npb25LZXkua2V5LCBzZXNzaW9uS2V5Lm5vbmNlKTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zb2xlLmxvZyhgRW5jcnlwdCAxTUI6ICR7dGltZS50b0ZpeGVkKDIpfW1zYCk7XG4gICAgICBleHBlY3QodGltZSkudG9CZUxlc3NUaGFuKFRIUkVTSE9MRFMuYnVsa0VuY3J5cHRpb24pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBkZWNyeXB0IDFNQiB3aXRoaW4gdGhyZXNob2xkJywgKCkgPT4ge1xuICAgICAgY29uc3QgZW5jcnlwdGVkID0gZW5jcnlwdE1lc3NhZ2UobGFyZ2VNZXNzYWdlLCBzZXNzaW9uS2V5LmtleSwgc2Vzc2lvbktleS5ub25jZSk7XG5cbiAgICAgIGNvbnN0IHRpbWUgPSBtZWFzdXJlKCgpID0+IHtcbiAgICAgICAgZGVjcnlwdE1lc3NhZ2UoZW5jcnlwdGVkLCBzZXNzaW9uS2V5LmtleSwgc2Vzc2lvbktleS5ub25jZSk7XG4gICAgICB9KTtcblxuICAgICAgY29uc29sZS5sb2coYERlY3J5cHQgMU1COiAke3RpbWUudG9GaXhlZCgyKX1tc2ApO1xuICAgICAgZXhwZWN0KHRpbWUpLnRvQmVMZXNzVGhhbihUSFJFU0hPTERTLmJ1bGtEZWNyeXB0aW9uKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbWFpbnRhaW4gcGVyZm9ybWFuY2UgZm9yIG11bHRpcGxlIGxhcmdlIGVuY3J5cHRpb25zJywgKCkgPT4ge1xuICAgICAgY29uc3QgdGltZXM6IG51bWJlcltdID0gW107XG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTA7IGkrKykge1xuICAgICAgICAvLyBHZW5lcmF0ZSBuZXcgc2Vzc2lvbiBrZXkgZm9yIGVhY2ggaXRlcmF0aW9uXG4gICAgICAgIGNvbnN0IHNrID0gZ2VuZXJhdGVTZXNzaW9uS2V5KCk7XG4gICAgICAgIGNvbnN0IHRpbWUgPSBtZWFzdXJlKCgpID0+IHtcbiAgICAgICAgICBlbmNyeXB0TWVzc2FnZShsYXJnZU1lc3NhZ2UsIHNrLmtleSwgc2subm9uY2UpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGltZXMucHVzaCh0aW1lKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgYXZnVGltZSA9IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gdGltZXMubGVuZ3RoO1xuICAgICAgY29uc3QgbWF4VGltZSA9IE1hdGgubWF4KC4uLnRpbWVzKTtcblxuICAgICAgY29uc29sZS5sb2coYEF2ZyBidWxrIGVuY3J5cHQ6ICR7YXZnVGltZS50b0ZpeGVkKDIpfW1zLCBNYXg6ICR7bWF4VGltZS50b0ZpeGVkKDIpfW1zYCk7XG4gICAgICBleHBlY3QobWF4VGltZSkudG9CZUxlc3NUaGFuKFRIUkVTSE9MRFMuYnVsa0VuY3J5cHRpb24gKiAxLjUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnS2V5IEV4Y2hhbmdlIFBlcmZvcm1hbmNlJywgKCkgPT4ge1xuICAgIGNvbnN0IGtwMSA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICBjb25zdCBrcDIgPSBnZW5lcmF0ZUlkZW50aXR5KCk7XG5cbiAgICBpdCgnc2hvdWxkIGRlcml2ZSBzaGFyZWQgc2VjcmV0IHdpdGhpbiB0aHJlc2hvbGQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBhdmdUaW1lID0gbWVhc3VyZUF2ZXJhZ2UoKCkgPT4ge1xuICAgICAgICBwZXJmb3JtS2V5RXhjaGFuZ2Uoa3AxLnByaXZhdGVLZXksIGtwMi5wdWJsaWNLZXkpO1xuICAgICAgfSwgMTAwKTtcblxuICAgICAgY29uc29sZS5sb2coYEtleSBleGNoYW5nZSBhdmVyYWdlOiAke2F2Z1RpbWUudG9GaXhlZCgyKX1tc2ApO1xuICAgICAgZXhwZWN0KGF2Z1RpbWUpLnRvQmVMZXNzVGhhbihUSFJFU0hPTERTLmtleUV4Y2hhbmdlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIDEwMDAga2V5IGV4Y2hhbmdlcy9zZWMnLCAoKSA9PiB7XG4gICAgICBjb25zdCB0b3RhbFRpbWUgPSBtZWFzdXJlKCgpID0+IHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxMDAwOyBpKyspIHtcbiAgICAgICAgICBwZXJmb3JtS2V5RXhjaGFuZ2Uoa3AxLnByaXZhdGVLZXksIGtwMi5wdWJsaWNLZXkpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgY29uc29sZS5sb2coYDEwMDAga2V5IGV4Y2hhbmdlczogJHt0b3RhbFRpbWUudG9GaXhlZCgyKX1tc2ApO1xuICAgICAgZXhwZWN0KHRvdGFsVGltZSkudG9CZUxlc3NUaGFuKDEwMDAgKiBUSFJFU0hPTERTLmtleUV4Y2hhbmdlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1JlYWwtV29ybGQgU2NlbmFyaW9zJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIHR5cGljYWwgbWVzc2FnaW5nIHdvcmtsb2FkJywgKCkgPT4ge1xuICAgICAgY29uc3QgYWxpY2VLcCA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICAgIGNvbnN0IGJvYktwID0gZ2VuZXJhdGVJZGVudGl0eSgpO1xuICAgICAgY29uc3QgbWVzc2FnZXMgPSBBcnJheSgxMDApLmZpbGwobnVsbCkubWFwKChfLCBpKSA9PlxuICAgICAgICBuZXcgVWludDhBcnJheSg1MTIpLmZpbGwoaSAlIDI1NilcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IHRvdGFsVGltZSA9IG1lYXN1cmUoKCkgPT4ge1xuICAgICAgICBjb25zdCBhbGljZVNoYXJlZCA9IHBlcmZvcm1LZXlFeGNoYW5nZShhbGljZUtwLnByaXZhdGVLZXksIGJvYktwLnB1YmxpY0tleSk7XG5cbiAgICAgICAgbWVzc2FnZXMuZm9yRWFjaChtc2cgPT4ge1xuICAgICAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IHNpZ25NZXNzYWdlKG1zZywgYWxpY2VLcC5wcml2YXRlS2V5KTtcbiAgICAgICAgICBjb25zdCBzayA9IGdlbmVyYXRlU2Vzc2lvbktleSgpO1xuICAgICAgICAgIGNvbnN0IGVuY3J5cHRlZCA9IGVuY3J5cHRNZXNzYWdlKG1zZywgc2sua2V5LCBzay5ub25jZSk7XG5cbiAgICAgICAgICB2ZXJpZnlTaWduYXR1cmUobXNnLCBzaWduYXR1cmUsIGFsaWNlS3AucHVibGljS2V5KTtcbiAgICAgICAgICBkZWNyeXB0TWVzc2FnZShlbmNyeXB0ZWQsIHNrLmtleSwgc2subm9uY2UpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zb2xlLmxvZyhgMTAwIG1lc3NhZ2Ugd29ya2Zsb3c6ICR7dG90YWxUaW1lLnRvRml4ZWQoMil9bXNgKTtcbiAgICAgIGV4cGVjdCh0b3RhbFRpbWUpLnRvQmVMZXNzVGhhbig1MDAwKTsgLy8gNSBzZWNvbmRzIGZvciAxMDAgbWVzc2FnZXNcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHBlZXIgaGFuZHNoYWtlIGVmZmljaWVudGx5JywgKCkgPT4ge1xuICAgICAgY29uc3QgdG90YWxUaW1lID0gbWVhc3VyZSgoKSA9PiB7XG4gICAgICAgIC8vIFNpbXVsYXRlIDEwIHBlZXIgaGFuZHNoYWtlc1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBwZWVyMSA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICAgICAgICBjb25zdCBwZWVyMiA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcblxuICAgICAgICAgIC8vIEV4Y2hhbmdlIGtleXNcbiAgICAgICAgICBjb25zdCBzaGFyZWQxID0gcGVyZm9ybUtleUV4Y2hhbmdlKHBlZXIxLnByaXZhdGVLZXksIHBlZXIyLnB1YmxpY0tleSk7XG4gICAgICAgICAgY29uc3Qgc2hhcmVkMiA9IHBlcmZvcm1LZXlFeGNoYW5nZShwZWVyMi5wcml2YXRlS2V5LCBwZWVyMS5wdWJsaWNLZXkpO1xuXG4gICAgICAgICAgLy8gQ2hhbGxlbmdlLXJlc3BvbnNlXG4gICAgICAgICAgY29uc3QgY2hhbGxlbmdlID0gbmV3IFVpbnQ4QXJyYXkoMzIpO1xuICAgICAgICAgIGNvbnN0IHNpZzEgPSBzaWduTWVzc2FnZShjaGFsbGVuZ2UsIHBlZXIxLnByaXZhdGVLZXkpO1xuICAgICAgICAgIGNvbnN0IHNpZzIgPSBzaWduTWVzc2FnZShjaGFsbGVuZ2UsIHBlZXIyLnByaXZhdGVLZXkpO1xuXG4gICAgICAgICAgdmVyaWZ5U2lnbmF0dXJlKGNoYWxsZW5nZSwgc2lnMSwgcGVlcjEucHVibGljS2V5KTtcbiAgICAgICAgICB2ZXJpZnlTaWduYXR1cmUoY2hhbGxlbmdlLCBzaWcyLCBwZWVyMi5wdWJsaWNLZXkpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgY29uc29sZS5sb2coYDEwIHBlZXIgaGFuZHNoYWtlczogJHt0b3RhbFRpbWUudG9GaXhlZCgyKX1tc2ApO1xuICAgICAgZXhwZWN0KHRvdGFsVGltZSkudG9CZUxlc3NUaGFuKDEwMDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnTWVtb3J5IFBlcmZvcm1hbmNlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgbm90IGxlYWsgbWVtb3J5IGR1cmluZyByZXBlYXRlZCBvcGVyYXRpb25zJywgKCkgPT4ge1xuICAgICAgaWYgKGdsb2JhbC5nYykge1xuICAgICAgICBnbG9iYWwuZ2MoKTtcbiAgICAgICAgY29uc3QgaW5pdGlhbE1lbW9yeSA9IHByb2Nlc3MubWVtb3J5VXNhZ2UoKS5oZWFwVXNlZDtcblxuICAgICAgICAvLyBQZXJmb3JtIG1hbnkgb3BlcmF0aW9uc1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwMDA7IGkrKykge1xuICAgICAgICAgIGNvbnN0IGtwID0gZ2VuZXJhdGVJZGVudGl0eSgpO1xuICAgICAgICAgIGNvbnN0IG1zZyA9IG5ldyBVaW50OEFycmF5KDEwMjQpO1xuICAgICAgICAgIGNvbnN0IHNpZyA9IHNpZ25NZXNzYWdlKG1zZywga3AucHJpdmF0ZUtleSk7XG4gICAgICAgICAgdmVyaWZ5U2lnbmF0dXJlKG1zZywgc2lnLCBrcC5wdWJsaWNLZXkpO1xuICAgICAgICB9XG5cbiAgICAgICAgZ2xvYmFsLmdjKCk7XG4gICAgICAgIGNvbnN0IGZpbmFsTWVtb3J5ID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpLmhlYXBVc2VkO1xuICAgICAgICBjb25zdCBtZW1vcnlJbmNyZWFzZSA9IChmaW5hbE1lbW9yeSAtIGluaXRpYWxNZW1vcnkpIC8gMTAyNCAvIDEwMjQ7XG5cbiAgICAgICAgY29uc29sZS5sb2coYE1lbW9yeSBpbmNyZWFzZTogJHttZW1vcnlJbmNyZWFzZS50b0ZpeGVkKDIpfU1CYCk7XG4gICAgICAgIGV4cGVjdChtZW1vcnlJbmNyZWFzZSkudG9CZUxlc3NUaGFuKDUwKTsgLy8gTGVzcyB0aGFuIDUwTUIgaW5jcmVhc2VcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdSdW4gd2l0aCAtLWV4cG9zZS1nYyB0byB0ZXN0IG1lbW9yeScpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9