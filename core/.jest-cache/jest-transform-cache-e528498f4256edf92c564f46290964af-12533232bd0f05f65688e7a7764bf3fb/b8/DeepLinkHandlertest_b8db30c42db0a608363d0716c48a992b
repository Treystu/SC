2babcbccbead131e86f2be71890642e0
"use strict";
/**
 * Tests for DeepLinkHandler
 */
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const DeepLinkHandler_js_1 = require("./DeepLinkHandler.js");
// Mock storage implementation
class MockStorage {
    constructor() {
        this.store = new Map();
    }
    async get(key) {
        return this.store.get(key) || null;
    }
    async set(key, value) {
        this.store.set(key, value);
    }
    async remove(key) {
        this.store.delete(key);
    }
    clear() {
        this.store.clear();
    }
}
(0, globals_1.describe)('DeepLinkManager', () => {
    let manager;
    let storage;
    (0, globals_1.beforeEach)(() => {
        storage = new MockStorage();
        manager = new DeepLinkHandler_js_1.DeepLinkManager(storage);
    });
    (0, globals_1.describe)('parseURL', () => {
        (0, globals_1.it)('should parse custom scheme join URL', () => {
            const result = manager.parseURL('sc://join/ABC123');
            (0, globals_1.expect)(result).toEqual({
                action: 'join',
                params: { code: 'ABC123' },
            });
        });
        (0, globals_1.it)('should parse custom scheme connect URL', () => {
            const result = manager.parseURL('sc://connect/peer123');
            (0, globals_1.expect)(result).toEqual({
                action: 'connect',
                params: { peer: 'peer123' },
            });
        });
        (0, globals_1.it)('should parse HTTPS URL with hash', () => {
            const result = manager.parseURL('https://sc.app/join#ABC123');
            (0, globals_1.expect)(result).toEqual({
                action: 'join',
                params: { code: 'ABC123' },
            });
        });
        (0, globals_1.it)('should parse HTTPS URL with query params', () => {
            const result = manager.parseURL('https://sc.app/join?code=ABC123&inviterName=Alice');
            (0, globals_1.expect)(result).toEqual({
                action: 'join',
                params: { code: 'ABC123', inviterName: 'Alice' },
            });
        });
        (0, globals_1.it)('should parse hash-only format', () => {
            const result = manager.parseURL('#join=ABC123');
            (0, globals_1.expect)(result).toEqual({
                action: 'join',
                params: { code: 'ABC123' },
            });
        });
        (0, globals_1.it)('should parse path with hash', () => {
            const result = manager.parseURL('/join#ABC123');
            (0, globals_1.expect)(result).toEqual({
                action: 'join',
                params: { code: 'ABC123' },
            });
        });
        (0, globals_1.it)('should return empty result for invalid URL', () => {
            const result = manager.parseURL('invalid');
            (0, globals_1.expect)(result).toEqual({
                action: '',
                params: {},
            });
        });
        (0, globals_1.it)('should reject hash-based URLs from non-sc.app hosts', () => {
            const result = manager.parseURL('https://evil.com/join#ABC123');
            (0, globals_1.expect)(result).toEqual({
                action: 'join',
                params: {},
            });
        });
        (0, globals_1.it)('should accept hash-based URLs from sc.app host', () => {
            const result = manager.parseURL('https://sc.app/join#ABC123');
            (0, globals_1.expect)(result).toEqual({
                action: 'join',
                params: { code: 'ABC123' },
            });
        });
    });
    (0, globals_1.describe)('handleURL', () => {
        (0, globals_1.it)('should handle join URL and store invite code', async () => {
            // First set onboarding as complete
            await storage.set('onboarding_complete', 'true');
            const handled = await manager.handleURL('sc://join/ABC123');
            (0, globals_1.expect)(handled).toBe(true);
            (0, globals_1.expect)(await storage.get('pendingInvite')).toBe('ABC123');
        });
        (0, globals_1.it)('should return false for unhandled action', async () => {
            const handled = await manager.handleURL('sc://unknown/value');
            (0, globals_1.expect)(handled).toBe(false);
        });
        (0, globals_1.it)('should return false for empty action', async () => {
            const handled = await manager.handleURL('invalid-url');
            (0, globals_1.expect)(handled).toBe(false);
        });
    });
    (0, globals_1.describe)('registerHandler', () => {
        (0, globals_1.it)('should allow registering custom handlers', async () => {
            let handledParams = null;
            manager.registerHandler('custom', async (params) => {
                handledParams = params;
            });
            await manager.handleURL('sc://custom/test');
            (0, globals_1.expect)(handledParams).toEqual({ value: 'test' });
        });
    });
    (0, globals_1.describe)('registerDefaultHandlers - join handler', () => {
        (0, globals_1.it)('should store invite code and inviter name when user is onboarded', async () => {
            // Set user as onboarded
            await storage.set('onboarding_complete', 'true');
            const handled = await manager.handleURL('https://sc.app/join?code=ABC123&inviterName=Alice');
            (0, globals_1.expect)(handled).toBe(true);
            (0, globals_1.expect)(await storage.get('pendingInvite')).toBe('ABC123');
            (0, globals_1.expect)(await storage.get('pendingInviterName')).toBe('Alice');
        });
        (0, globals_1.it)('should store invite code when user is not onboarded (deferred processing)', async () => {
            // User is not onboarded
            const handled = await manager.handleURL('sc://join/ABC123');
            (0, globals_1.expect)(handled).toBe(true);
            (0, globals_1.expect)(await storage.get('pendingInvite')).toBe('ABC123');
        });
        (0, globals_1.it)('should handle join URL without inviter name', async () => {
            await storage.set('onboarding_complete', 'true');
            const handled = await manager.handleURL('sc://join/ABC123');
            (0, globals_1.expect)(handled).toBe(true);
            (0, globals_1.expect)(await storage.get('pendingInvite')).toBe('ABC123');
            (0, globals_1.expect)(await storage.get('pendingInviterName')).toBeNull();
        });
        (0, globals_1.it)('should return false if no code provided in join action', async () => {
            const handled = await manager.handleURL('sc://join/');
            // Handler returns false because URL parsing fails with empty code
            (0, globals_1.expect)(handled).toBe(false);
        });
    });
    (0, globals_1.describe)('registerDefaultHandlers - connect handler', () => {
        (0, globals_1.it)('should store peer connection when connect action is triggered', async () => {
            const handled = await manager.handleURL('sc://connect/peer123');
            (0, globals_1.expect)(handled).toBe(true);
            (0, globals_1.expect)(await storage.get('pendingPeerConnection')).toBe('peer123');
        });
        (0, globals_1.it)('should handle connect with peer in params', async () => {
            const handled = await manager.handleURL('https://sc.app/connect?peer=peer456');
            (0, globals_1.expect)(handled).toBe(true);
            (0, globals_1.expect)(await storage.get('pendingPeerConnection')).toBe('peer456');
        });
        (0, globals_1.it)('should return false if no peer provided in connect action', async () => {
            const handled = await manager.handleURL('sc://connect/');
            // Connect handler checks for peer value
            (0, globals_1.expect)(await storage.get('pendingPeerConnection')).toBeNull();
        });
    });
    (0, globals_1.describe)('pending invite management', () => {
        (0, globals_1.it)('should get and clear pending invite', async () => {
            await storage.set('pendingInvite', 'ABC123');
            await storage.set('pendingInviterName', 'Alice');
            const invite = await manager.getPendingInvite();
            (0, globals_1.expect)(invite).toEqual({ code: 'ABC123', inviterName: 'Alice' });
            await manager.clearPendingInvite();
            const clearedInvite = await manager.getPendingInvite();
            (0, globals_1.expect)(clearedInvite).toBeNull();
        });
        (0, globals_1.it)('should return null when no pending invite', async () => {
            const invite = await manager.getPendingInvite();
            (0, globals_1.expect)(invite).toBeNull();
        });
        (0, globals_1.it)('should handle empty inviter name correctly with nullish coalescing', async () => {
            await storage.set('pendingInvite', 'ABC123');
            await storage.set('pendingInviterName', '');
            const invite = await manager.getPendingInvite();
            // Empty string should become undefined due to ?? operator
            (0, globals_1.expect)(invite).toEqual({ code: 'ABC123', inviterName: undefined });
        });
    });
    (0, globals_1.describe)('pending peer connection management', () => {
        (0, globals_1.it)('should get and clear pending peer connection', async () => {
            await storage.set('pendingPeerConnection', 'peer123');
            const peerId = await manager.getPendingPeerConnection();
            (0, globals_1.expect)(peerId).toBe('peer123');
            await manager.clearPendingPeerConnection();
            const clearedPeerId = await manager.getPendingPeerConnection();
            (0, globals_1.expect)(clearedPeerId).toBeNull();
        });
    });
    (0, globals_1.describe)('static URL generators', () => {
        (0, globals_1.it)('should generate invite URL', () => {
            const url = DeepLinkHandler_js_1.DeepLinkManager.generateInviteURL('https://sc.app', 'ABC123', 'Alice');
            (0, globals_1.expect)(url).toBe('https://sc.app/join?code=ABC123&inviterName=Alice');
        });
        (0, globals_1.it)('should generate invite URL without inviter name', () => {
            const url = DeepLinkHandler_js_1.DeepLinkManager.generateInviteURL('https://sc.app', 'ABC123');
            (0, globals_1.expect)(url).toBe('https://sc.app/join?code=ABC123');
        });
        (0, globals_1.it)('should generate custom scheme URL', () => {
            const url = DeepLinkHandler_js_1.DeepLinkManager.generateCustomSchemeURL('ABC123');
            (0, globals_1.expect)(url).toBe('sc://join/ABC123');
        });
    });
    (0, globals_1.describe)('onboarding check', () => {
        (0, globals_1.it)('should return true when onboarding is complete', async () => {
            await storage.set('onboarding_complete', 'true');
            const isOnboarded = await manager.isUserOnboarded();
            (0, globals_1.expect)(isOnboarded).toBe(true);
        });
        (0, globals_1.it)('should return false when onboarding is not complete', async () => {
            const isOnboarded = await manager.isUserOnboarded();
            (0, globals_1.expect)(isOnboarded).toBe(false);
        });
        (0, globals_1.it)('should return false when onboarding flag is false', async () => {
            await storage.set('onboarding_complete', 'false');
            const isOnboarded = await manager.isUserOnboarded();
            (0, globals_1.expect)(isOnboarded).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvc2hhcmluZy9EZWVwTGlua0hhbmRsZXIudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsMkNBQWlFO0FBQ2pFLDZEQUc4QjtBQUU5Qiw4QkFBOEI7QUFDOUIsTUFBTSxXQUFXO0lBQWpCO1FBQ1UsVUFBSyxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO0lBaUI1QyxDQUFDO0lBZkMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFXO1FBQ25CLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDO0lBQ3JDLENBQUM7SUFFRCxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQVcsRUFBRSxLQUFhO1FBQ2xDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFXO1FBQ3RCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxLQUFLO1FBQ0gsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNyQixDQUFDO0NBQ0Y7QUFFRCxJQUFBLGtCQUFRLEVBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBQy9CLElBQUksT0FBd0IsQ0FBQztJQUM3QixJQUFJLE9BQW9CLENBQUM7SUFFekIsSUFBQSxvQkFBVSxFQUFDLEdBQUcsRUFBRTtRQUNkLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQzVCLE9BQU8sR0FBRyxJQUFJLG9DQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDekMsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFBLGtCQUFRLEVBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRTtRQUN4QixJQUFBLFlBQUUsRUFBQyxxQ0FB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QUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztRQUVILElBQUEsWUFBRSxFQUFDLHFEQUFxRCxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ25FLE1BQU0sV0FBVyxHQUFHLE1BQU0sT0FBTyxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3BELElBQUEsZ0JBQU0sRUFBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFBLFlBQUUsRUFBQyxtREFBbUQsRUFBRSxLQUFLLElBQUksRUFBRTtZQUNqRSxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDbEQsTUFBTSxXQUFXLEdBQUcsTUFBTSxPQUFPLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDcEQsSUFBQSxnQkFBTSxFQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvc2hhcmluZy9EZWVwTGlua0hhbmRsZXIudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRlc3RzIGZvciBEZWVwTGlua0hhbmRsZXJcbiAqL1xuXG5pbXBvcnQgeyBkZXNjcmliZSwgaXQsIGV4cGVjdCwgYmVmb3JlRWFjaCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuaW1wb3J0IHtcbiAgRGVlcExpbmtNYW5hZ2VyLFxuICBEZWVwTGlua1N0b3JhZ2UsXG59IGZyb20gJy4vRGVlcExpbmtIYW5kbGVyLmpzJztcblxuLy8gTW9jayBzdG9yYWdlIGltcGxlbWVudGF0aW9uXG5jbGFzcyBNb2NrU3RvcmFnZSBpbXBsZW1lbnRzIERlZXBMaW5rU3RvcmFnZSB7XG4gIHByaXZhdGUgc3RvcmUgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuXG4gIGFzeW5jIGdldChrZXk6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLmdldChrZXkpIHx8IG51bGw7XG4gIH1cblxuICBhc3luYyBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLnN0b3JlLnNldChrZXksIHZhbHVlKTtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZShrZXk6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuc3RvcmUuZGVsZXRlKGtleSk7XG4gIH1cblxuICBjbGVhcigpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3JlLmNsZWFyKCk7XG4gIH1cbn1cblxuZGVzY3JpYmUoJ0RlZXBMaW5rTWFuYWdlcicsICgpID0+IHtcbiAgbGV0IG1hbmFnZXI6IERlZXBMaW5rTWFuYWdlcjtcbiAgbGV0IHN0b3JhZ2U6IE1vY2tTdG9yYWdlO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHN0b3JhZ2UgPSBuZXcgTW9ja1N0b3JhZ2UoKTtcbiAgICBtYW5hZ2VyID0gbmV3IERlZXBMaW5rTWFuYWdlcihzdG9yYWdlKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3BhcnNlVVJMJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcGFyc2UgY3VzdG9tIHNjaGVtZSBqb2luIFVSTCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IG1hbmFnZXIucGFyc2VVUkwoJ3NjOi8vam9pbi9BQkMxMjMnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoe1xuICAgICAgICBhY3Rpb246ICdqb2luJyxcbiAgICAgICAgcGFyYW1zOiB7IGNvZGU6ICdBQkMxMjMnIH0sXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcGFyc2UgY3VzdG9tIHNjaGVtZSBjb25uZWN0IFVSTCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IG1hbmFnZXIucGFyc2VVUkwoJ3NjOi8vY29ubmVjdC9wZWVyMTIzJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKHtcbiAgICAgICAgYWN0aW9uOiAnY29ubmVjdCcsXG4gICAgICAgIHBhcmFtczogeyBwZWVyOiAncGVlcjEyMycgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwYXJzZSBIVFRQUyBVUkwgd2l0aCBoYXNoJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gbWFuYWdlci5wYXJzZVVSTCgnaHR0cHM6Ly9zYy5hcHAvam9pbiNBQkMxMjMnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoe1xuICAgICAgICBhY3Rpb246ICdqb2luJyxcbiAgICAgICAgcGFyYW1zOiB7IGNvZGU6ICdBQkMxMjMnIH0sXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcGFyc2UgSFRUUFMgVVJMIHdpdGggcXVlcnkgcGFyYW1zJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gbWFuYWdlci5wYXJzZVVSTChcbiAgICAgICAgJ2h0dHBzOi8vc2MuYXBwL2pvaW4/Y29kZT1BQkMxMjMmaW52aXRlck5hbWU9QWxpY2UnXG4gICAgICApO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7XG4gICAgICAgIGFjdGlvbjogJ2pvaW4nLFxuICAgICAgICBwYXJhbXM6IHsgY29kZTogJ0FCQzEyMycsIGludml0ZXJOYW1lOiAnQWxpY2UnIH0sXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcGFyc2UgaGFzaC1vbmx5IGZvcm1hdCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IG1hbmFnZXIucGFyc2VVUkwoJyNqb2luPUFCQzEyMycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7XG4gICAgICAgIGFjdGlvbjogJ2pvaW4nLFxuICAgICAgICBwYXJhbXM6IHsgY29kZTogJ0FCQzEyMycgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwYXJzZSBwYXRoIHdpdGggaGFzaCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IG1hbmFnZXIucGFyc2VVUkwoJy9qb2luI0FCQzEyMycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7XG4gICAgICAgIGFjdGlvbjogJ2pvaW4nLFxuICAgICAgICBwYXJhbXM6IHsgY29kZTogJ0FCQzEyMycgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZW1wdHkgcmVzdWx0IGZvciBpbnZhbGlkIFVSTCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IG1hbmFnZXIucGFyc2VVUkwoJ2ludmFsaWQnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoe1xuICAgICAgICBhY3Rpb246ICcnLFxuICAgICAgICBwYXJhbXM6IHt9LFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCBoYXNoLWJhc2VkIFVSTHMgZnJvbSBub24tc2MuYXBwIGhvc3RzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gbWFuYWdlci5wYXJzZVVSTCgnaHR0cHM6Ly9ldmlsLmNvbS9qb2luI0FCQzEyMycpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7XG4gICAgICAgIGFjdGlvbjogJ2pvaW4nLFxuICAgICAgICBwYXJhbXM6IHt9LFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGFjY2VwdCBoYXNoLWJhc2VkIFVSTHMgZnJvbSBzYy5hcHAgaG9zdCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IG1hbmFnZXIucGFyc2VVUkwoJ2h0dHBzOi8vc2MuYXBwL2pvaW4jQUJDMTIzJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKHtcbiAgICAgICAgYWN0aW9uOiAnam9pbicsXG4gICAgICAgIHBhcmFtczogeyBjb2RlOiAnQUJDMTIzJyB9LFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdoYW5kbGVVUkwnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgam9pbiBVUkwgYW5kIHN0b3JlIGludml0ZSBjb2RlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gRmlyc3Qgc2V0IG9uYm9hcmRpbmcgYXMgY29tcGxldGVcbiAgICAgIGF3YWl0IHN0b3JhZ2Uuc2V0KCdvbmJvYXJkaW5nX2NvbXBsZXRlJywgJ3RydWUnKTtcblxuICAgICAgY29uc3QgaGFuZGxlZCA9IGF3YWl0IG1hbmFnZXIuaGFuZGxlVVJMKCdzYzovL2pvaW4vQUJDMTIzJyk7XG5cbiAgICAgIGV4cGVjdChoYW5kbGVkKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KGF3YWl0IHN0b3JhZ2UuZ2V0KCdwZW5kaW5nSW52aXRlJykpLnRvQmUoJ0FCQzEyMycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2UgZm9yIHVuaGFuZGxlZCBhY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBoYW5kbGVkID0gYXdhaXQgbWFuYWdlci5oYW5kbGVVUkwoJ3NjOi8vdW5rbm93bi92YWx1ZScpO1xuICAgICAgZXhwZWN0KGhhbmRsZWQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2UgZm9yIGVtcHR5IGFjdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGhhbmRsZWQgPSBhd2FpdCBtYW5hZ2VyLmhhbmRsZVVSTCgnaW52YWxpZC11cmwnKTtcbiAgICAgIGV4cGVjdChoYW5kbGVkKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3JlZ2lzdGVySGFuZGxlcicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGFsbG93IHJlZ2lzdGVyaW5nIGN1c3RvbSBoYW5kbGVycycsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBoYW5kbGVkUGFyYW1zOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCB1bmRlZmluZWQ+IHwgbnVsbCA9IG51bGw7XG5cbiAgICAgIG1hbmFnZXIucmVnaXN0ZXJIYW5kbGVyKCdjdXN0b20nLCBhc3luYyAocGFyYW1zKSA9PiB7XG4gICAgICAgIGhhbmRsZWRQYXJhbXMgPSBwYXJhbXM7XG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgbWFuYWdlci5oYW5kbGVVUkwoJ3NjOi8vY3VzdG9tL3Rlc3QnKTtcblxuICAgICAgZXhwZWN0KGhhbmRsZWRQYXJhbXMpLnRvRXF1YWwoeyB2YWx1ZTogJ3Rlc3QnIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVnaXN0ZXJEZWZhdWx0SGFuZGxlcnMgLSBqb2luIGhhbmRsZXInLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzdG9yZSBpbnZpdGUgY29kZSBhbmQgaW52aXRlciBuYW1lIHdoZW4gdXNlciBpcyBvbmJvYXJkZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBTZXQgdXNlciBhcyBvbmJvYXJkZWRcbiAgICAgIGF3YWl0IHN0b3JhZ2Uuc2V0KCdvbmJvYXJkaW5nX2NvbXBsZXRlJywgJ3RydWUnKTtcblxuICAgICAgY29uc3QgaGFuZGxlZCA9IGF3YWl0IG1hbmFnZXIuaGFuZGxlVVJMKCdodHRwczovL3NjLmFwcC9qb2luP2NvZGU9QUJDMTIzJmludml0ZXJOYW1lPUFsaWNlJyk7XG5cbiAgICAgIGV4cGVjdChoYW5kbGVkKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KGF3YWl0IHN0b3JhZ2UuZ2V0KCdwZW5kaW5nSW52aXRlJykpLnRvQmUoJ0FCQzEyMycpO1xuICAgICAgZXhwZWN0KGF3YWl0IHN0b3JhZ2UuZ2V0KCdwZW5kaW5nSW52aXRlck5hbWUnKSkudG9CZSgnQWxpY2UnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc3RvcmUgaW52aXRlIGNvZGUgd2hlbiB1c2VyIGlzIG5vdCBvbmJvYXJkZWQgKGRlZmVycmVkIHByb2Nlc3NpbmcpJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gVXNlciBpcyBub3Qgb25ib2FyZGVkXG4gICAgICBjb25zdCBoYW5kbGVkID0gYXdhaXQgbWFuYWdlci5oYW5kbGVVUkwoJ3NjOi8vam9pbi9BQkMxMjMnKTtcblxuICAgICAgZXhwZWN0KGhhbmRsZWQpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoYXdhaXQgc3RvcmFnZS5nZXQoJ3BlbmRpbmdJbnZpdGUnKSkudG9CZSgnQUJDMTIzJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBqb2luIFVSTCB3aXRob3V0IGludml0ZXIgbmFtZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHN0b3JhZ2Uuc2V0KCdvbmJvYXJkaW5nX2NvbXBsZXRlJywgJ3RydWUnKTtcblxuICAgICAgY29uc3QgaGFuZGxlZCA9IGF3YWl0IG1hbmFnZXIuaGFuZGxlVVJMKCdzYzovL2pvaW4vQUJDMTIzJyk7XG5cbiAgICAgIGV4cGVjdChoYW5kbGVkKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KGF3YWl0IHN0b3JhZ2UuZ2V0KCdwZW5kaW5nSW52aXRlJykpLnRvQmUoJ0FCQzEyMycpO1xuICAgICAgZXhwZWN0KGF3YWl0IHN0b3JhZ2UuZ2V0KCdwZW5kaW5nSW52aXRlck5hbWUnKSkudG9CZU51bGwoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGlmIG5vIGNvZGUgcHJvdmlkZWQgaW4gam9pbiBhY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBoYW5kbGVkID0gYXdhaXQgbWFuYWdlci5oYW5kbGVVUkwoJ3NjOi8vam9pbi8nKTtcbiAgICAgIC8vIEhhbmRsZXIgcmV0dXJucyBmYWxzZSBiZWNhdXNlIFVSTCBwYXJzaW5nIGZhaWxzIHdpdGggZW1wdHkgY29kZVxuICAgICAgZXhwZWN0KGhhbmRsZWQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVnaXN0ZXJEZWZhdWx0SGFuZGxlcnMgLSBjb25uZWN0IGhhbmRsZXInLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzdG9yZSBwZWVyIGNvbm5lY3Rpb24gd2hlbiBjb25uZWN0IGFjdGlvbiBpcyB0cmlnZ2VyZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBoYW5kbGVkID0gYXdhaXQgbWFuYWdlci5oYW5kbGVVUkwoJ3NjOi8vY29ubmVjdC9wZWVyMTIzJyk7XG5cbiAgICAgIGV4cGVjdChoYW5kbGVkKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KGF3YWl0IHN0b3JhZ2UuZ2V0KCdwZW5kaW5nUGVlckNvbm5lY3Rpb24nKSkudG9CZSgncGVlcjEyMycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgY29ubmVjdCB3aXRoIHBlZXIgaW4gcGFyYW1zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaGFuZGxlZCA9IGF3YWl0IG1hbmFnZXIuaGFuZGxlVVJMKCdodHRwczovL3NjLmFwcC9jb25uZWN0P3BlZXI9cGVlcjQ1NicpO1xuXG4gICAgICBleHBlY3QoaGFuZGxlZCkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChhd2FpdCBzdG9yYWdlLmdldCgncGVuZGluZ1BlZXJDb25uZWN0aW9uJykpLnRvQmUoJ3BlZXI0NTYnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGlmIG5vIHBlZXIgcHJvdmlkZWQgaW4gY29ubmVjdCBhY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBoYW5kbGVkID0gYXdhaXQgbWFuYWdlci5oYW5kbGVVUkwoJ3NjOi8vY29ubmVjdC8nKTtcbiAgICAgIC8vIENvbm5lY3QgaGFuZGxlciBjaGVja3MgZm9yIHBlZXIgdmFsdWVcbiAgICAgIGV4cGVjdChhd2FpdCBzdG9yYWdlLmdldCgncGVuZGluZ1BlZXJDb25uZWN0aW9uJykpLnRvQmVOdWxsKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdwZW5kaW5nIGludml0ZSBtYW5hZ2VtZW50JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZ2V0IGFuZCBjbGVhciBwZW5kaW5nIGludml0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHN0b3JhZ2Uuc2V0KCdwZW5kaW5nSW52aXRlJywgJ0FCQzEyMycpO1xuICAgICAgYXdhaXQgc3RvcmFnZS5zZXQoJ3BlbmRpbmdJbnZpdGVyTmFtZScsICdBbGljZScpO1xuXG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBtYW5hZ2VyLmdldFBlbmRpbmdJbnZpdGUoKTtcbiAgICAgIGV4cGVjdChpbnZpdGUpLnRvRXF1YWwoeyBjb2RlOiAnQUJDMTIzJywgaW52aXRlck5hbWU6ICdBbGljZScgfSk7XG5cbiAgICAgIGF3YWl0IG1hbmFnZXIuY2xlYXJQZW5kaW5nSW52aXRlKCk7XG4gICAgICBjb25zdCBjbGVhcmVkSW52aXRlID0gYXdhaXQgbWFuYWdlci5nZXRQZW5kaW5nSW52aXRlKCk7XG4gICAgICBleHBlY3QoY2xlYXJlZEludml0ZSkudG9CZU51bGwoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgd2hlbiBubyBwZW5kaW5nIGludml0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IG1hbmFnZXIuZ2V0UGVuZGluZ0ludml0ZSgpO1xuICAgICAgZXhwZWN0KGludml0ZSkudG9CZU51bGwoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVtcHR5IGludml0ZXIgbmFtZSBjb3JyZWN0bHkgd2l0aCBudWxsaXNoIGNvYWxlc2NpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzdG9yYWdlLnNldCgncGVuZGluZ0ludml0ZScsICdBQkMxMjMnKTtcbiAgICAgIGF3YWl0IHN0b3JhZ2Uuc2V0KCdwZW5kaW5nSW52aXRlck5hbWUnLCAnJyk7XG5cbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IG1hbmFnZXIuZ2V0UGVuZGluZ0ludml0ZSgpO1xuICAgICAgLy8gRW1wdHkgc3RyaW5nIHNob3VsZCBiZWNvbWUgdW5kZWZpbmVkIGR1ZSB0byA/PyBvcGVyYXRvclxuICAgICAgZXhwZWN0KGludml0ZSkudG9FcXVhbCh7IGNvZGU6ICdBQkMxMjMnLCBpbnZpdGVyTmFtZTogdW5kZWZpbmVkIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncGVuZGluZyBwZWVyIGNvbm5lY3Rpb24gbWFuYWdlbWVudCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGdldCBhbmQgY2xlYXIgcGVuZGluZyBwZWVyIGNvbm5lY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzdG9yYWdlLnNldCgncGVuZGluZ1BlZXJDb25uZWN0aW9uJywgJ3BlZXIxMjMnKTtcblxuICAgICAgY29uc3QgcGVlcklkID0gYXdhaXQgbWFuYWdlci5nZXRQZW5kaW5nUGVlckNvbm5lY3Rpb24oKTtcbiAgICAgIGV4cGVjdChwZWVySWQpLnRvQmUoJ3BlZXIxMjMnKTtcblxuICAgICAgYXdhaXQgbWFuYWdlci5jbGVhclBlbmRpbmdQZWVyQ29ubmVjdGlvbigpO1xuICAgICAgY29uc3QgY2xlYXJlZFBlZXJJZCA9IGF3YWl0IG1hbmFnZXIuZ2V0UGVuZGluZ1BlZXJDb25uZWN0aW9uKCk7XG4gICAgICBleHBlY3QoY2xlYXJlZFBlZXJJZCkudG9CZU51bGwoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3N0YXRpYyBVUkwgZ2VuZXJhdG9ycycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGdlbmVyYXRlIGludml0ZSBVUkwnLCAoKSA9PiB7XG4gICAgICBjb25zdCB1cmwgPSBEZWVwTGlua01hbmFnZXIuZ2VuZXJhdGVJbnZpdGVVUkwoXG4gICAgICAgICdodHRwczovL3NjLmFwcCcsXG4gICAgICAgICdBQkMxMjMnLFxuICAgICAgICAnQWxpY2UnXG4gICAgICApO1xuICAgICAgZXhwZWN0KHVybCkudG9CZSgnaHR0cHM6Ly9zYy5hcHAvam9pbj9jb2RlPUFCQzEyMyZpbnZpdGVyTmFtZT1BbGljZScpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSBpbnZpdGUgVVJMIHdpdGhvdXQgaW52aXRlciBuYW1lJywgKCkgPT4ge1xuICAgICAgY29uc3QgdXJsID0gRGVlcExpbmtNYW5hZ2VyLmdlbmVyYXRlSW52aXRlVVJMKCdodHRwczovL3NjLmFwcCcsICdBQkMxMjMnKTtcbiAgICAgIGV4cGVjdCh1cmwpLnRvQmUoJ2h0dHBzOi8vc2MuYXBwL2pvaW4/Y29kZT1BQkMxMjMnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgY3VzdG9tIHNjaGVtZSBVUkwnLCAoKSA9PiB7XG4gICAgICBjb25zdCB1cmwgPSBEZWVwTGlua01hbmFnZXIuZ2VuZXJhdGVDdXN0b21TY2hlbWVVUkwoJ0FCQzEyMycpO1xuICAgICAgZXhwZWN0KHVybCkudG9CZSgnc2M6Ly9qb2luL0FCQzEyMycpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnb25ib2FyZGluZyBjaGVjaycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiB0cnVlIHdoZW4gb25ib2FyZGluZyBpcyBjb21wbGV0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHN0b3JhZ2Uuc2V0KCdvbmJvYXJkaW5nX2NvbXBsZXRlJywgJ3RydWUnKTtcbiAgICAgIGNvbnN0IGlzT25ib2FyZGVkID0gYXdhaXQgbWFuYWdlci5pc1VzZXJPbmJvYXJkZWQoKTtcbiAgICAgIGV4cGVjdChpc09uYm9hcmRlZCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIHdoZW4gb25ib2FyZGluZyBpcyBub3QgY29tcGxldGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpc09uYm9hcmRlZCA9IGF3YWl0IG1hbmFnZXIuaXNVc2VyT25ib2FyZGVkKCk7XG4gICAgICBleHBlY3QoaXNPbmJvYXJkZWQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2Ugd2hlbiBvbmJvYXJkaW5nIGZsYWcgaXMgZmFsc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzdG9yYWdlLnNldCgnb25ib2FyZGluZ19jb21wbGV0ZScsICdmYWxzZScpO1xuICAgICAgY29uc3QgaXNPbmJvYXJkZWQgPSBhd2FpdCBtYW5hZ2VyLmlzVXNlck9uYm9hcmRlZCgpO1xuICAgICAgZXhwZWN0KGlzT25ib2FyZGVkKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==