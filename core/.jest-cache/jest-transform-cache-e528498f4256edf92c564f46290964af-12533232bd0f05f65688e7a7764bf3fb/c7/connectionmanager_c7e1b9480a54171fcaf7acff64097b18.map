{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/connection-manager.ts","mappings":"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","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/connection-manager.ts"],"sourcesContent":["// Connection Manager - Handles all peer connections and their lifecycle\n// Task 216: Connection lifecycle management\n\nexport interface ConnectionConfig {\n  maxPeers: number;\n  reconnectInterval: number;\n  connectionTimeout: number;\n  keepAliveInterval: number;\n}\n\nexport interface PeerConnection {\n  id: string;\n  type: \"webrtc\" | \"ble\" | \"local\";\n  status: \"connecting\" | \"connected\" | \"disconnected\" | \"failed\";\n  quality: number;\n  latency: number;\n  lastSeen: number;\n  bandwidth: { upload: number; download: number };\n}\n\nexport class ConnectionManager {\n  private connections: Map<string, PeerConnection> = new Map();\n  private config: ConnectionConfig;\n  private keepAliveTimers: Map<string, ReturnType<typeof setInterval>> =\n    new Map();\n  private reconnectTimers: Map<string, ReturnType<typeof setTimeout>> =\n    new Map();\n\n  constructor(config: Partial<ConnectionConfig> = {}) {\n    this.config = {\n      maxPeers: config.maxPeers || 50,\n      reconnectInterval: config.reconnectInterval || 5000,\n      connectionTimeout: config.connectionTimeout || 30000,\n      keepAliveInterval: config.keepAliveInterval || 10000,\n    };\n  }\n\n  addConnection(peerId: string, type: PeerConnection[\"type\"]): void {\n    const connection: PeerConnection = {\n      id: peerId,\n      type,\n      status: \"connecting\",\n      quality: 0,\n      latency: 0,\n      lastSeen: Date.now(),\n      bandwidth: { upload: 0, download: 0 },\n    };\n\n    this.connections.set(peerId, connection);\n    this.startKeepAlive(peerId);\n  }\n\n  updateConnectionStatus(\n    peerId: string,\n    status: PeerConnection[\"status\"],\n  ): void {\n    const conn = this.connections.get(peerId);\n    if (conn) {\n      conn.status = status;\n      conn.lastSeen = Date.now();\n\n      if (status === \"connected\") {\n        this.clearReconnectTimer(peerId);\n      } else if (status === \"failed\" || status === \"disconnected\") {\n        this.scheduleReconnect(peerId);\n      }\n    }\n  }\n\n  updateConnectionMetrics(\n    peerId: string,\n    metrics: {\n      quality?: number;\n      latency?: number;\n      bandwidth?: { upload: number; download: number };\n    },\n  ): void {\n    const conn = this.connections.get(peerId);\n    if (conn) {\n      if (metrics.quality !== undefined) conn.quality = metrics.quality;\n      if (metrics.latency !== undefined) conn.latency = metrics.latency;\n      if (metrics.bandwidth) conn.bandwidth = metrics.bandwidth;\n      conn.lastSeen = Date.now();\n    }\n  }\n\n  removeConnection(peerId: string): void {\n    this.clearKeepAlive(peerId);\n    this.clearReconnectTimer(peerId);\n    this.connections.delete(peerId);\n  }\n\n  getConnection(peerId: string): PeerConnection | undefined {\n    return this.connections.get(peerId);\n  }\n\n  getAllConnections(): PeerConnection[] {\n    return Array.from(this.connections.values());\n  }\n\n  getConnectedPeers(): PeerConnection[] {\n    return this.getAllConnections().filter(\n      (conn) => conn.status === \"connected\",\n    );\n  }\n\n  getBestConnection(): PeerConnection | null {\n    const connected = this.getConnectedPeers();\n    if (connected.length === 0) return null;\n\n    // Prioritize quality first, then latency as tiebreaker\n    return connected.reduce((best, conn) =>\n      conn.quality > best.quality\n        ? conn\n        : conn.quality === best.quality && conn.latency < best.latency\n          ? conn\n          : best,\n    );\n  }\n\n  private startKeepAlive(peerId: string): void {\n    const timer = setInterval(() => {\n      const conn = this.connections.get(peerId);\n      if (!conn) {\n        this.clearKeepAlive(peerId);\n        return;\n      }\n\n      const timeSinceLastSeen = Date.now() - conn.lastSeen;\n      if (timeSinceLastSeen > this.config.connectionTimeout) {\n        this.updateConnectionStatus(peerId, \"disconnected\");\n      }\n    }, this.config.keepAliveInterval);\n\n    this.keepAliveTimers.set(peerId, timer);\n    try {\n      if (timer && typeof (timer as any).unref === \"function\") {\n        (timer as any).unref();\n      }\n    } catch (e) {\n      // ignore\n    }\n  }\n\n  private clearKeepAlive(peerId: string): void {\n    const timer = this.keepAliveTimers.get(peerId);\n    if (timer) {\n      clearInterval(timer);\n      this.keepAliveTimers.delete(peerId);\n    }\n  }\n\n  private scheduleReconnect(peerId: string): void {\n    if (this.reconnectTimers.has(peerId)) return;\n\n    const timer = setTimeout(() => {\n      const conn = this.connections.get(peerId);\n      if (conn && conn.status !== \"connected\") {\n        this.updateConnectionStatus(peerId, \"connecting\");\n        // Emit reconnect event that other systems can listen to\n      }\n      this.reconnectTimers.delete(peerId);\n    }, this.config.reconnectInterval);\n\n    this.reconnectTimers.set(peerId, timer);\n  }\n\n  private clearReconnectTimer(peerId: string): void {\n    const timer = this.reconnectTimers.get(peerId);\n    if (timer) {\n      clearTimeout(timer);\n      this.reconnectTimers.delete(peerId);\n    }\n  }\n\n  getStatistics() {\n    const connections = this.getAllConnections();\n    const connected = this.getConnectedPeers();\n\n    return {\n      total: connections.length,\n      connected: connected.length,\n      connecting: connections.filter((c) => c.status === \"connecting\").length,\n      disconnected: connections.filter((c) => c.status === \"disconnected\")\n        .length,\n      failed: connections.filter((c) => c.status === \"failed\").length,\n      avgQuality:\n        connected.reduce((sum, c) => sum + c.quality, 0) /\n        (connected.length || 1),\n      avgLatency:\n        connected.reduce((sum, c) => sum + c.latency, 0) /\n        (connected.length || 1),\n      totalBandwidth: {\n        upload: connected.reduce((sum, c) => sum + c.bandwidth.upload, 0),\n        download: connected.reduce((sum, c) => sum + c.bandwidth.download, 0),\n      },\n    };\n  }\n\n  cleanup(): void {\n    this.keepAliveTimers.forEach((timer) => clearInterval(timer));\n    this.reconnectTimers.forEach((timer) => clearTimeout(timer));\n    this.keepAliveTimers.clear();\n    this.reconnectTimers.clear();\n    this.connections.clear();\n  }\n}\n"],"version":3}