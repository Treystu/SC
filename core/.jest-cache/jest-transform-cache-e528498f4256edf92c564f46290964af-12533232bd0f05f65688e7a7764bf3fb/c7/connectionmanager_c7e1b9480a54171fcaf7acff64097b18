649a0d6cc1be246fd6ef8a1906ecb208
"use strict";
// Connection Manager - Handles all peer connections and their lifecycle
// Task 216: Connection lifecycle management
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConnectionManager = void 0;
class ConnectionManager {
    constructor(config = {}) {
        this.connections = new Map();
        this.keepAliveTimers = new Map();
        this.reconnectTimers = new Map();
        this.config = {
            maxPeers: config.maxPeers || 50,
            reconnectInterval: config.reconnectInterval || 5000,
            connectionTimeout: config.connectionTimeout || 30000,
            keepAliveInterval: config.keepAliveInterval || 10000,
        };
    }
    addConnection(peerId, type) {
        const connection = {
            id: peerId,
            type,
            status: "connecting",
            quality: 0,
            latency: 0,
            lastSeen: Date.now(),
            bandwidth: { upload: 0, download: 0 },
        };
        this.connections.set(peerId, connection);
        this.startKeepAlive(peerId);
    }
    updateConnectionStatus(peerId, status) {
        const conn = this.connections.get(peerId);
        if (conn) {
            conn.status = status;
            conn.lastSeen = Date.now();
            if (status === "connected") {
                this.clearReconnectTimer(peerId);
            }
            else if (status === "failed" || status === "disconnected") {
                this.scheduleReconnect(peerId);
            }
        }
    }
    updateConnectionMetrics(peerId, metrics) {
        const conn = this.connections.get(peerId);
        if (conn) {
            if (metrics.quality !== undefined)
                conn.quality = metrics.quality;
            if (metrics.latency !== undefined)
                conn.latency = metrics.latency;
            if (metrics.bandwidth)
                conn.bandwidth = metrics.bandwidth;
            conn.lastSeen = Date.now();
        }
    }
    removeConnection(peerId) {
        this.clearKeepAlive(peerId);
        this.clearReconnectTimer(peerId);
        this.connections.delete(peerId);
    }
    getConnection(peerId) {
        return this.connections.get(peerId);
    }
    getAllConnections() {
        return Array.from(this.connections.values());
    }
    getConnectedPeers() {
        return this.getAllConnections().filter((conn) => conn.status === "connected");
    }
    getBestConnection() {
        const connected = this.getConnectedPeers();
        if (connected.length === 0)
            return null;
        // Prioritize quality first, then latency as tiebreaker
        return connected.reduce((best, conn) => conn.quality > best.quality
            ? conn
            : conn.quality === best.quality && conn.latency < best.latency
                ? conn
                : best);
    }
    startKeepAlive(peerId) {
        const timer = setInterval(() => {
            const conn = this.connections.get(peerId);
            if (!conn) {
                this.clearKeepAlive(peerId);
                return;
            }
            const timeSinceLastSeen = Date.now() - conn.lastSeen;
            if (timeSinceLastSeen > this.config.connectionTimeout) {
                this.updateConnectionStatus(peerId, "disconnected");
            }
        }, this.config.keepAliveInterval);
        this.keepAliveTimers.set(peerId, timer);
        try {
            if (timer && typeof timer.unref === "function") {
                timer.unref();
            }
        }
        catch (e) {
            // ignore
        }
    }
    clearKeepAlive(peerId) {
        const timer = this.keepAliveTimers.get(peerId);
        if (timer) {
            clearInterval(timer);
            this.keepAliveTimers.delete(peerId);
        }
    }
    scheduleReconnect(peerId) {
        if (this.reconnectTimers.has(peerId))
            return;
        const timer = setTimeout(() => {
            const conn = this.connections.get(peerId);
            if (conn && conn.status !== "connected") {
                this.updateConnectionStatus(peerId, "connecting");
                // Emit reconnect event that other systems can listen to
            }
            this.reconnectTimers.delete(peerId);
        }, this.config.reconnectInterval);
        this.reconnectTimers.set(peerId, timer);
    }
    clearReconnectTimer(peerId) {
        const timer = this.reconnectTimers.get(peerId);
        if (timer) {
            clearTimeout(timer);
            this.reconnectTimers.delete(peerId);
        }
    }
    getStatistics() {
        const connections = this.getAllConnections();
        const connected = this.getConnectedPeers();
        return {
            total: connections.length,
            connected: connected.length,
            connecting: connections.filter((c) => c.status === "connecting").length,
            disconnected: connections.filter((c) => c.status === "disconnected")
                .length,
            failed: connections.filter((c) => c.status === "failed").length,
            avgQuality: connected.reduce((sum, c) => sum + c.quality, 0) /
                (connected.length || 1),
            avgLatency: connected.reduce((sum, c) => sum + c.latency, 0) /
                (connected.length || 1),
            totalBandwidth: {
                upload: connected.reduce((sum, c) => sum + c.bandwidth.upload, 0),
                download: connected.reduce((sum, c) => sum + c.bandwidth.download, 0),
            },
        };
    }
    cleanup() {
        this.keepAliveTimers.forEach((timer) => clearInterval(timer));
        this.reconnectTimers.forEach((timer) => clearTimeout(timer));
        this.keepAliveTimers.clear();
        this.reconnectTimers.clear();
        this.connections.clear();
    }
}
exports.ConnectionManager = ConnectionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvY29ubmVjdGlvbi1tYW5hZ2VyLnRzIiwibWFwcGluZ3MiOiI7QUFBQSx3RUFBd0U7QUFDeEUsNENBQTRDOzs7QUFtQjVDLE1BQWEsaUJBQWlCO0lBUTVCLFlBQVksU0FBb0MsRUFBRTtRQVAxQyxnQkFBVyxHQUFnQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRXJELG9CQUFlLEdBQ3JCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDSixvQkFBZSxHQUNyQixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBR1YsSUFBSSxDQUFDLE1BQU0sR0FBRztZQUNaLFFBQVEsRUFBRSxNQUFNLENBQUMsUUFBUSxJQUFJLEVBQUU7WUFDL0IsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLGlCQUFpQixJQUFJLElBQUk7WUFDbkQsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLGlCQUFpQixJQUFJLEtBQUs7WUFDcEQsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLGlCQUFpQixJQUFJLEtBQUs7U0FDckQsQ0FBQztJQUNKLENBQUM7SUFFRCxhQUFhLENBQUMsTUFBYyxFQUFFLElBQTRCO1FBQ3hELE1BQU0sVUFBVSxHQUFtQjtZQUNqQyxFQUFFLEVBQUUsTUFBTTtZQUNWLElBQUk7WUFDSixNQUFNLEVBQUUsWUFBWTtZQUNwQixPQUFPLEVBQUUsQ0FBQztZQUNWLE9BQU8sRUFBRSxDQUFDO1lBQ1YsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDcEIsU0FBUyxFQUFFLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFO1NBQ3RDLENBQUM7UUFFRixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRUQsc0JBQXNCLENBQ3BCLE1BQWMsRUFDZCxN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LGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUMzQixDQUFDO0NBQ0Y7QUExTEQsOENBMExDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jaHJpc3R5bWF4d2VsbC9EZXNrdG9wL0x1a2VfU3R1ZmYvR2l0SHViL1NDL2NvcmUvc3JjL2Nvbm5lY3Rpb24tbWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb25uZWN0aW9uIE1hbmFnZXIgLSBIYW5kbGVzIGFsbCBwZWVyIGNvbm5lY3Rpb25zIGFuZCB0aGVpciBsaWZlY3ljbGVcbi8vIFRhc2sgMjE2OiBDb25uZWN0aW9uIGxpZmVjeWNsZSBtYW5hZ2VtZW50XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29ubmVjdGlvbkNvbmZpZyB7XG4gIG1heFBlZXJzOiBudW1iZXI7XG4gIHJlY29ubmVjdEludGVydmFsOiBudW1iZXI7XG4gIGNvbm5lY3Rpb25UaW1lb3V0OiBudW1iZXI7XG4gIGtlZXBBbGl2ZUludGVydmFsOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGVlckNvbm5lY3Rpb24ge1xuICBpZDogc3RyaW5nO1xuICB0eXBlOiBcIndlYnJ0Y1wiIHwgXCJibGVcIiB8IFwibG9jYWxcIjtcbiAgc3RhdHVzOiBcImNvbm5lY3RpbmdcIiB8IFwiY29ubmVjdGVkXCIgfCBcImRpc2Nvbm5lY3RlZFwiIHwgXCJmYWlsZWRcIjtcbiAgcXVhbGl0eTogbnVtYmVyO1xuICBsYXRlbmN5OiBudW1iZXI7XG4gIGxhc3RTZWVuOiBudW1iZXI7XG4gIGJhbmR3aWR0aDogeyB1cGxvYWQ6IG51bWJlcjsgZG93bmxvYWQ6IG51bWJlciB9O1xufVxuXG5leHBvcnQgY2xhc3MgQ29ubmVjdGlvbk1hbmFnZXIge1xuICBwcml2YXRlIGNvbm5lY3Rpb25zOiBNYXA8c3RyaW5nLCBQZWVyQ29ubmVjdGlvbj4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgY29uZmlnOiBDb25uZWN0aW9uQ29uZmlnO1xuICBwcml2YXRlIGtlZXBBbGl2ZVRpbWVyczogTWFwPHN0cmluZywgUmV0dXJuVHlwZTx0eXBlb2Ygc2V0SW50ZXJ2YWw+PiA9XG4gICAgbmV3IE1hcCgpO1xuICBwcml2YXRlIHJlY29ubmVjdFRpbWVyczogTWFwPHN0cmluZywgUmV0dXJuVHlwZTx0eXBlb2Ygc2V0VGltZW91dD4+ID1cbiAgICBuZXcgTWFwKCk7XG5cbiAgY29uc3RydWN0b3IoY29uZmlnOiBQYXJ0aWFsPENvbm5lY3Rpb25Db25maWc+ID0ge30pIHtcbiAgICB0aGlzLmNvbmZpZyA9IHtcbiAgICAgIG1heFBlZXJzOiBjb25maWcubWF4UGVlcnMgfHwgNTAsXG4gICAgICByZWNvbm5lY3RJbnRlcnZhbDogY29uZmlnLnJlY29ubmVjdEludGVydmFsIHx8IDUwMDAsXG4gICAgICBjb25uZWN0aW9uVGltZW91dDogY29uZmlnLmNvbm5lY3Rpb25UaW1lb3V0IHx8IDMwMDAwLFxuICAgICAga2VlcEFsaXZlSW50ZXJ2YWw6IGNvbmZpZy5rZWVwQWxpdmVJbnRlcnZhbCB8fCAxMDAwMCxcbiAgICB9O1xuICB9XG5cbiAgYWRkQ29ubmVjdGlvbihwZWVySWQ6IHN0cmluZywgdHlwZTogUGVlckNvbm5lY3Rpb25bXCJ0eXBlXCJdKTogdm9pZCB7XG4gICAgY29uc3QgY29ubmVjdGlvbjogUGVlckNvbm5lY3Rpb24gPSB7XG4gICAgICBpZDogcGVlcklkLFxuICAgICAgdHlwZSxcbiAgICAgIHN0YXR1czogXCJjb25uZWN0aW5nXCIsXG4gICAgICBxdWFsaXR5OiAwLFxuICAgICAgbGF0ZW5jeTogMCxcbiAgICAgIGxhc3RTZWVuOiBEYXRlLm5vdygpLFxuICAgICAgYmFuZHdpZHRoOiB7IHVwbG9hZDogMCwgZG93bmxvYWQ6IDAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5jb25uZWN0aW9ucy5zZXQocGVlcklkLCBjb25uZWN0aW9uKTtcbiAgICB0aGlzLnN0YXJ0S2VlcEFsaXZlKHBlZXJJZCk7XG4gIH1cblxuICB1cGRhdGVDb25uZWN0aW9uU3RhdHVzKFxuICAgIHBlZXJJZDogc3RyaW5nLFxuICAgIHN0YXR1czogUGVlckNvbm5lY3Rpb25bXCJzdGF0dXNcIl0sXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGNvbm4gPSB0aGlzLmNvbm5lY3Rpb25zLmdldChwZWVySWQpO1xuICAgIGlmIChjb25uKSB7XG4gICAgICBjb25uLnN0YXR1cyA9IHN0YXR1cztcbiAgICAgIGNvbm4ubGFzdFNlZW4gPSBEYXRlLm5vdygpO1xuXG4gICAgICBpZiAoc3RhdHVzID09PSBcImNvbm5lY3RlZFwiKSB7XG4gICAgICAgIHRoaXMuY2xlYXJSZWNvbm5lY3RUaW1lcihwZWVySWQpO1xuICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IFwiZmFpbGVkXCIgfHwgc3RhdHVzID09PSBcImRpc2Nvbm5lY3RlZFwiKSB7XG4gICAgICAgIHRoaXMuc2NoZWR1bGVSZWNvbm5lY3QocGVlcklkKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICB1cGRhdGVDb25uZWN0aW9uTWV0cmljcyhcbiAgICBwZWVySWQ6IHN0cmluZyxcbiAgICBtZXRyaWNzOiB7XG4gICAgICBxdWFsaXR5PzogbnVtYmVyO1xuICAgICAgbGF0ZW5jeT86IG51bWJlcjtcbiAgICAgIGJhbmR3aWR0aD86IHsgdXBsb2FkOiBudW1iZXI7IGRvd25sb2FkOiBudW1iZXIgfTtcbiAgICB9LFxuICApOiB2b2lkIHtcbiAgICBjb25zdCBjb25uID0gdGhpcy5jb25uZWN0aW9ucy5nZXQocGVlcklkKTtcbiAgICBpZiAoY29ubikge1xuICAgICAgaWYgKG1ldHJpY3MucXVhbGl0eSAhPT0gdW5kZWZpbmVkKSBjb25uLnF1YWxpdHkgPSBtZXRyaWNzLnF1YWxpdHk7XG4gICAgICBpZiAobWV0cmljcy5sYXRlbmN5ICE9PSB1bmRlZmluZWQpIGNvbm4ubGF0ZW5jeSA9IG1ldHJpY3MubGF0ZW5jeTtcbiAgICAgIGlmIChtZXRyaWNzLmJhbmR3aWR0aCkgY29ubi5iYW5kd2lkdGggPSBtZXRyaWNzLmJhbmR3aWR0aDtcbiAgICAgIGNvbm4ubGFzdFNlZW4gPSBEYXRlLm5vdygpO1xuICAgIH1cbiAgfVxuXG4gIHJlbW92ZUNvbm5lY3Rpb24ocGVlcklkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmNsZWFyS2VlcEFsaXZlKHBlZXJJZCk7XG4gICAgdGhpcy5jbGVhclJlY29ubmVjdFRpbWVyKHBlZXJJZCk7XG4gICAgdGhpcy5jb25uZWN0aW9ucy5kZWxldGUocGVlcklkKTtcbiAgfVxuXG4gIGdldENvbm5lY3Rpb24ocGVlcklkOiBzdHJpbmcpOiBQZWVyQ29ubmVjdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvbnMuZ2V0KHBlZXJJZCk7XG4gIH1cblxuICBnZXRBbGxDb25uZWN0aW9ucygpOiBQZWVyQ29ubmVjdGlvbltdIHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmNvbm5lY3Rpb25zLnZhbHVlcygpKTtcbiAgfVxuXG4gIGdldENvbm5lY3RlZFBlZXJzKCk6IFBlZXJDb25uZWN0aW9uW10ge1xuICAgIHJldHVybiB0aGlzLmdldEFsbENvbm5lY3Rpb25zKCkuZmlsdGVyKFxuICAgICAgKGNvbm4pID0+IGNvbm4uc3RhdHVzID09PSBcImNvbm5lY3RlZFwiLFxuICAgICk7XG4gIH1cblxuICBnZXRCZXN0Q29ubmVjdGlvbigpOiBQZWVyQ29ubmVjdGlvbiB8IG51bGwge1xuICAgIGNvbnN0IGNvbm5lY3RlZCA9IHRoaXMuZ2V0Q29ubmVjdGVkUGVlcnMoKTtcbiAgICBpZiAoY29ubmVjdGVkLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7XG5cbiAgICAvLyBQcmlvcml0aXplIHF1YWxpdHkgZmlyc3QsIHRoZW4gbGF0ZW5jeSBhcyB0aWVicmVha2VyXG4gICAgcmV0dXJuIGNvbm5lY3RlZC5yZWR1Y2UoKGJlc3QsIGNvbm4pID0+XG4gICAgICBjb25uLnF1YWxpdHkgPiBiZXN0LnF1YWxpdHlcbiAgICAgICAgPyBjb25uXG4gICAgICAgIDogY29ubi5xdWFsaXR5ID09PSBiZXN0LnF1YWxpdHkgJiYgY29ubi5sYXRlbmN5IDwgYmVzdC5sYXRlbmN5XG4gICAgICAgICAgPyBjb25uXG4gICAgICAgICAgOiBiZXN0LFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHN0YXJ0S2VlcEFsaXZlKHBlZXJJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgdGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICBjb25zdCBjb25uID0gdGhpcy5jb25uZWN0aW9ucy5nZXQocGVlcklkKTtcbiAgICAgIGlmICghY29ubikge1xuICAgICAgICB0aGlzLmNsZWFyS2VlcEFsaXZlKHBlZXJJZCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdGltZVNpbmNlTGFzdFNlZW4gPSBEYXRlLm5vdygpIC0gY29ubi5sYXN0U2VlbjtcbiAgICAgIGlmICh0aW1lU2luY2VMYXN0U2VlbiA+IHRoaXMuY29uZmlnLmNvbm5lY3Rpb25UaW1lb3V0KSB7XG4gICAgICAgIHRoaXMudXBkYXRlQ29ubmVjdGlvblN0YXR1cyhwZWVySWQsIFwiZGlzY29ubmVjdGVkXCIpO1xuICAgICAgfVxuICAgIH0sIHRoaXMuY29uZmlnLmtlZXBBbGl2ZUludGVydmFsKTtcblxuICAgIHRoaXMua2VlcEFsaXZlVGltZXJzLnNldChwZWVySWQsIHRpbWVyKTtcbiAgICB0cnkge1xuICAgICAgaWYgKHRpbWVyICYmIHR5cGVvZiAodGltZXIgYXMgYW55KS51bnJlZiA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICh0aW1lciBhcyBhbnkpLnVucmVmKCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gaWdub3JlXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjbGVhcktlZXBBbGl2ZShwZWVySWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHRpbWVyID0gdGhpcy5rZWVwQWxpdmVUaW1lcnMuZ2V0KHBlZXJJZCk7XG4gICAgaWYgKHRpbWVyKSB7XG4gICAgICBjbGVhckludGVydmFsKHRpbWVyKTtcbiAgICAgIHRoaXMua2VlcEFsaXZlVGltZXJzLmRlbGV0ZShwZWVySWQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2NoZWR1bGVSZWNvbm5lY3QocGVlcklkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5yZWNvbm5lY3RUaW1lcnMuaGFzKHBlZXJJZCkpIHJldHVybjtcblxuICAgIGNvbnN0IHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBjb25zdCBjb25uID0gdGhpcy5jb25uZWN0aW9ucy5nZXQocGVlcklkKTtcbiAgICAgIGlmIChjb25uICYmIGNvbm4uc3RhdHVzICE9PSBcImNvbm5lY3RlZFwiKSB7XG4gICAgICAgIHRoaXMudXBkYXRlQ29ubmVjdGlvblN0YXR1cyhwZWVySWQsIFwiY29ubmVjdGluZ1wiKTtcbiAgICAgICAgLy8gRW1pdCByZWNvbm5lY3QgZXZlbnQgdGhhdCBvdGhlciBzeXN0ZW1zIGNhbiBsaXN0ZW4gdG9cbiAgICAgIH1cbiAgICAgIHRoaXMucmVjb25uZWN0VGltZXJzLmRlbGV0ZShwZWVySWQpO1xuICAgIH0sIHRoaXMuY29uZmlnLnJlY29ubmVjdEludGVydmFsKTtcblxuICAgIHRoaXMucmVjb25uZWN0VGltZXJzLnNldChwZWVySWQsIHRpbWVyKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xlYXJSZWNvbm5lY3RUaW1lcihwZWVySWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHRpbWVyID0gdGhpcy5yZWNvbm5lY3RUaW1lcnMuZ2V0KHBlZXJJZCk7XG4gICAgaWYgKHRpbWVyKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgdGhpcy5yZWNvbm5lY3RUaW1lcnMuZGVsZXRlKHBlZXJJZCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0U3RhdGlzdGljcygpIHtcbiAgICBjb25zdCBjb25uZWN0aW9ucyA9IHRoaXMuZ2V0QWxsQ29ubmVjdGlvbnMoKTtcbiAgICBjb25zdCBjb25uZWN0ZWQgPSB0aGlzLmdldENvbm5lY3RlZFBlZXJzKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdG90YWw6IGNvbm5lY3Rpb25zLmxlbmd0aCxcbiAgICAgIGNvbm5lY3RlZDogY29ubmVjdGVkLmxlbmd0aCxcbiAgICAgIGNvbm5lY3Rpbmc6IGNvbm5lY3Rpb25zLmZpbHRlcigoYykgPT4gYy5zdGF0dXMgPT09IFwiY29ubmVjdGluZ1wiKS5sZW5ndGgsXG4gICAgICBkaXNjb25uZWN0ZWQ6IGNvbm5lY3Rpb25zLmZpbHRlcigoYykgPT4gYy5zdGF0dXMgPT09IFwiZGlzY29ubmVjdGVkXCIpXG4gICAgICAgIC5sZW5ndGgsXG4gICAgICBmYWlsZWQ6IGNvbm5lY3Rpb25zLmZpbHRlcigoYykgPT4gYy5zdGF0dXMgPT09IFwiZmFpbGVkXCIpLmxlbmd0aCxcbiAgICAgIGF2Z1F1YWxpdHk6XG4gICAgICAgIGNvbm5lY3RlZC5yZWR1Y2UoKHN1bSwgYykgPT4gc3VtICsgYy5xdWFsaXR5LCAwKSAvXG4gICAgICAgIChjb25uZWN0ZWQubGVuZ3RoIHx8IDEpLFxuICAgICAgYXZnTGF0ZW5jeTpcbiAgICAgICAgY29ubmVjdGVkLnJlZHVjZSgoc3VtLCBjKSA9PiBzdW0gKyBjLmxhdGVuY3ksIDApIC9cbiAgICAgICAgKGNvbm5lY3RlZC5sZW5ndGggfHwgMSksXG4gICAgICB0b3RhbEJhbmR3aWR0aDoge1xuICAgICAgICB1cGxvYWQ6IGNvbm5lY3RlZC5yZWR1Y2UoKHN1bSwgYykgPT4gc3VtICsgYy5iYW5kd2lkdGgudXBsb2FkLCAwKSxcbiAgICAgICAgZG93bmxvYWQ6IGNvbm5lY3RlZC5yZWR1Y2UoKHN1bSwgYykgPT4gc3VtICsgYy5iYW5kd2lkdGguZG93bmxvYWQsIDApLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgY2xlYW51cCgpOiB2b2lkIHtcbiAgICB0aGlzLmtlZXBBbGl2ZVRpbWVycy5mb3JFYWNoKCh0aW1lcikgPT4gY2xlYXJJbnRlcnZhbCh0aW1lcikpO1xuICAgIHRoaXMucmVjb25uZWN0VGltZXJzLmZvckVhY2goKHRpbWVyKSA9PiBjbGVhclRpbWVvdXQodGltZXIpKTtcbiAgICB0aGlzLmtlZXBBbGl2ZVRpbWVycy5jbGVhcigpO1xuICAgIHRoaXMucmVjb25uZWN0VGltZXJzLmNsZWFyKCk7XG4gICAgdGhpcy5jb25uZWN0aW9ucy5jbGVhcigpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=