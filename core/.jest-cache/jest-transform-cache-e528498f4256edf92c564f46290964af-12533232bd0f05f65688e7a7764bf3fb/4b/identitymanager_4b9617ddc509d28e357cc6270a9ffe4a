ab8c1d01c50bc40dec665f5b64dc8b64
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.IdentityManager = exports.LocalStorageAdapter = void 0;
class LocalStorageAdapter {
    async save(key, value) {
        if (typeof localStorage !== "undefined") {
            localStorage.setItem(key, value);
        }
    }
    async load(key) {
        if (typeof localStorage !== "undefined") {
            return localStorage.getItem(key);
        }
        return null;
    }
    async remove(key) {
        if (typeof localStorage !== "undefined") {
            localStorage.removeItem(key);
        }
    }
}
exports.LocalStorageAdapter = LocalStorageAdapter;
class IdentityManager {
    constructor(storage) {
        this.identity = null;
        this.storageKey = "sovereign-identity";
        this.storage = storage || new LocalStorageAdapter();
    }
    // Use the global crypto.subtle which should always be available
    get subtle() {
        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
        // @ts-ignore
        if (typeof globalThis !== 'undefined' && globalThis.crypto && globalThis.crypto.subtle) {
            // eslint-disable-next-line @typescript-eslint/ban-ts-comment
            // @ts-ignore
            return globalThis.crypto.subtle;
        }
        throw new Error('crypto.subtle is not available in this environment');
    }
    // Generate new identity
    async generateIdentity(displayName) {
        // Generate Ed25519 keypair for signing
        const keyPair = await this.subtle.generateKey({
            name: "Ed25519",
            namedCurve: "Ed25519",
        }, true, ["sign", "verify"]);
        // Generate unique ID from public key
        const publicKeyExport = await this.subtle.exportKey("raw", keyPair.publicKey);
        const publicKeyHash = await this.subtle.digest("SHA-256", publicKeyExport);
        const id = this.arrayBufferToHex(publicKeyHash)
            .substring(0, 16)
            .toUpperCase();
        this.identity = {
            id,
            publicKey: keyPair.publicKey,
            privateKey: keyPair.privateKey,
            created: new Date(),
            displayName,
        };
        await this.saveIdentity();
        return this.identity;
    }
    // Load existing identity from storage
    async loadIdentity() {
        try {
            const stored = await this.storage.load(this.storageKey);
            if (!stored)
                return null;
            const data = JSON.parse(stored);
            // Import keys
            const publicKey = await this.subtle.importKey("jwk", data.publicKeyJwk, { name: "Ed25519", namedCurve: "Ed25519" }, true, ["verify"]);
            const privateKey = await this.subtle.importKey("jwk", data.privateKeyJwk, { name: "Ed25519", namedCurve: "Ed25519" }, true, ["sign"]);
            this.identity = {
                id: data.id,
                publicKey,
                privateKey,
                created: new Date(data.created),
                displayName: data.displayName,
            };
            return this.identity;
        }
        catch (error) {
            console.error("Failed to load identity:", error);
            return null;
        }
    }
    // Save identity to storage
    async saveIdentity() {
        if (!this.identity)
            return;
        const exported = await this.exportIdentity();
        await this.storage.save(this.storageKey, JSON.stringify(exported));
    }
    // Export identity (for backup)
    async exportIdentity() {
        if (!this.identity)
            throw new Error("No identity to export");
        const publicKeyJwk = await this.subtle.exportKey("jwk", this.identity.publicKey);
        const privateKeyJwk = await this.subtle.exportKey("jwk", this.identity.privateKey);
        return {
            id: this.identity.id,
            publicKeyJwk,
            privateKeyJwk,
            created: this.identity.created.toISOString(),
            displayName: this.identity.displayName,
        };
    }
    // Import identity (from backup)
    async importIdentity(data) {
        const publicKey = await this.subtle.importKey("jwk", data.publicKeyJwk, { name: "Ed25519", namedCurve: "Ed25519" }, true, ["verify"]);
        const privateKey = await this.subtle.importKey("jwk", data.privateKeyJwk, { name: "Ed25519", namedCurve: "Ed25519" }, true, ["sign"]);
        this.identity = {
            id: data.id,
            publicKey,
            privateKey,
            created: new Date(data.created),
            displayName: data.displayName,
        };
        await this.saveIdentity();
        return this.identity;
    }
    // Get current identity
    getIdentity() {
        return this.identity;
    }
    // Get current identity (alias for getIdentity)
    getCurrentIdentity() {
        return this.identity;
    }
    // Check if identity exists
    hasIdentity() {
        return this.identity !== null;
    }
    // Get public key
    async getPublicKey() {
        if (!this.identity)
            throw new Error("No identity loaded");
        return this.identity.publicKey;
    }
    // Get public key as bytes
    async getPublicKeyBytes() {
        if (!this.identity)
            throw new Error("No identity loaded");
        const exported = await this.subtle.exportKey("raw", this.identity.publicKey);
        return new Uint8Array(exported);
    }
    // Get public key as hex string
    async getPublicKeyHex() {
        if (!this.identity)
            throw new Error("No identity loaded");
        const exported = await this.subtle.exportKey("raw", this.identity.publicKey);
        return this.arrayBufferToHex(exported);
    }
    // Sign data
    async sign(data) {
        if (!this.identity)
            throw new Error("No identity loaded");
        const signature = await this.subtle.sign({ name: "Ed25519" }, this.identity.privateKey, data.buffer);
        return new Uint8Array(signature);
    }
    // Verify signature (overloaded - can use current identity's public key or provided key)
    async verify(data, signature, publicKey) {
        const keyToUse = publicKey || this.identity?.publicKey;
        if (!keyToUse)
            throw new Error("No public key available");
        try {
            return await crypto.subtle.verify({ name: "Ed25519" }, keyToUse, signature.buffer, data.buffer);
        }
        catch {
            return false;
        }
    }
    // Get public key as string
    async getPublicKeyString() {
        if (!this.identity)
            throw new Error("No identity loaded");
        const exported = await crypto.subtle.exportKey("raw", this.identity.publicKey);
        return this.arrayBufferToHex(exported);
    }
    // Delete identity
    async deleteIdentity() {
        await this.storage.remove(this.storageKey);
        this.identity = null;
    }
    // Helper: ArrayBuffer to hex string
    arrayBufferToHex(buffer) {
        return Array.from(new Uint8Array(buffer))
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");
    }
}
exports.IdentityManager = IdentityManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvaWRlbnRpdHktbWFuYWdlci50cyIsIm1hcHBpbmdzIjoiOzs7QUF1QkEsTUFBYSxtQkFBbUI7SUFDOUIsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFXLEVBQUUsS0FBYTtRQUNuQyxJQUFJLE9BQU8sWUFBWSxLQUFLLFdBQVcsRUFBRSxDQUFDO1lBQ3hDLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ25DLENBQUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFXO1FBQ3BCLElBQUksT0FBTyxZQUFZLEtBQUssV0FBVyxFQUFFLENBQUM7WUFDeEMsT0FBTyxZQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ25DLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQVc7UUFDdEIsSUFBSSxPQUFPLFlBQVksS0FBSyxXQUFXLEVBQUUsQ0FBQztZQUN4QyxZQUFZLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9CLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFuQkQsa0RBbUJDO0FBRUQsTUFBYSxlQUFlO0lBSzFCLFlBQVksT0FBZ0M7UUFKcEMsYUFBUSxHQUFvQixJQUFJLENBQUM7UUFFakMsZUFBVSxHQUFHLG9CQUFvQixDQUFDO1FBR3hDLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxJQUFJLElBQUksbUJBQW1CLEVBQUUsQ0FBQztJQUN0RCxDQUFDO0lBRUQsZ0VBQWdFO0lBQ2hFLElBQVksTUFBTTtRQUNoQiw2REFBNkQ7UUFDN0QsYUFBYTtRQUNiLElBQUksT0FBTyxVQUFVLEtBQUssV0FBVyxJQUFJLFVBQVUsQ0FBQyxNQUFNLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUN2Riw2REFBNkQ7WUFD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QUNkLENBQUM7Q0FDRjtBQWhRRCwwQ0FnUUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvaWRlbnRpdHktbWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBJZGVudGl0eSBhbmQga2V5cGFpciBtYW5hZ2VtZW50XG5leHBvcnQgaW50ZXJmYWNlIElkZW50aXR5IHtcbiAgaWQ6IHN0cmluZztcbiAgcHVibGljS2V5OiBDcnlwdG9LZXk7XG4gIHByaXZhdGVLZXk6IENyeXB0b0tleTtcbiAgY3JlYXRlZDogRGF0ZTtcbiAgZGlzcGxheU5hbWU/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSWRlbnRpdHlFeHBvcnQge1xuICBpZDogc3RyaW5nO1xuICBwdWJsaWNLZXlKd2s6IEpzb25XZWJLZXk7XG4gIHByaXZhdGVLZXlKd2s6IEpzb25XZWJLZXk7XG4gIGNyZWF0ZWQ6IHN0cmluZztcbiAgZGlzcGxheU5hbWU/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSWRlbnRpdHlTdG9yYWdlQWRhcHRlciB7XG4gIHNhdmUoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+O1xuICBsb2FkKGtleTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPjtcbiAgcmVtb3ZlKGtleTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPjtcbn1cblxuZXhwb3J0IGNsYXNzIExvY2FsU3RvcmFnZUFkYXB0ZXIgaW1wbGVtZW50cyBJZGVudGl0eVN0b3JhZ2VBZGFwdGVyIHtcbiAgYXN5bmMgc2F2ZShrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0eXBlb2YgbG9jYWxTdG9yYWdlICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBsb2FkKGtleTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XG4gICAgaWYgKHR5cGVvZiBsb2NhbFN0b3JhZ2UgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIHJldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZShrZXk6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0eXBlb2YgbG9jYWxTdG9yYWdlICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSWRlbnRpdHlNYW5hZ2VyIHtcbiAgcHJpdmF0ZSBpZGVudGl0eTogSWRlbnRpdHkgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBzdG9yYWdlOiBJZGVudGl0eVN0b3JhZ2VBZGFwdGVyO1xuICBwcml2YXRlIHN0b3JhZ2VLZXkgPSBcInNvdmVyZWlnbi1pZGVudGl0eVwiO1xuXG4gIGNvbnN0cnVjdG9yKHN0b3JhZ2U/OiBJZGVudGl0eVN0b3JhZ2VBZGFwdGVyKSB7XG4gICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZSB8fCBuZXcgTG9jYWxTdG9yYWdlQWRhcHRlcigpO1xuICB9XG5cbiAgLy8gVXNlIHRoZSBnbG9iYWwgY3J5cHRvLnN1YnRsZSB3aGljaCBzaG91bGQgYWx3YXlzIGJlIGF2YWlsYWJsZVxuICBwcml2YXRlIGdldCBzdWJ0bGUoKSB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudFxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBpZiAodHlwZW9mIGdsb2JhbFRoaXMgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbFRoaXMuY3J5cHRvICYmIGdsb2JhbFRoaXMuY3J5cHRvLnN1YnRsZSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9iYW4tdHMtY29tbWVudFxuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgcmV0dXJuIGdsb2JhbFRoaXMuY3J5cHRvLnN1YnRsZTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKCdjcnlwdG8uc3VidGxlIGlzIG5vdCBhdmFpbGFibGUgaW4gdGhpcyBlbnZpcm9ubWVudCcpO1xuICB9XG5cbiAgLy8gR2VuZXJhdGUgbmV3IGlkZW50aXR5XG4gIGFzeW5jIGdlbmVyYXRlSWRlbnRpdHkoZGlzcGxheU5hbWU/OiBzdHJpbmcpOiBQcm9taXNlPElkZW50aXR5PiB7XG4gICAgLy8gR2VuZXJhdGUgRWQyNTUxOSBrZXlwYWlyIGZvciBzaWduaW5nXG4gICAgY29uc3Qga2V5UGFpciA9IGF3YWl0IHRoaXMuc3VidGxlLmdlbmVyYXRlS2V5KFxuICAgICAge1xuICAgICAgICBuYW1lOiBcIkVkMjU1MTlcIixcbiAgICAgICAgbmFtZWRDdXJ2ZTogXCJFZDI1NTE5XCIsXG4gICAgICB9IGFzIGFueSxcbiAgICAgIHRydWUsXG4gICAgICBbXCJzaWduXCIsIFwidmVyaWZ5XCJdLFxuICAgICk7XG5cbiAgICAvLyBHZW5lcmF0ZSB1bmlxdWUgSUQgZnJvbSBwdWJsaWMga2V5XG4gICAgY29uc3QgcHVibGljS2V5RXhwb3J0ID0gYXdhaXQgdGhpcy5zdWJ0bGUuZXhwb3J0S2V5KFxuICAgICAgXCJyYXdcIixcbiAgICAgIGtleVBhaXIucHVibGljS2V5LFxuICAgICk7XG4gICAgY29uc3QgcHVibGljS2V5SGFzaCA9IGF3YWl0IHRoaXMuc3VidGxlLmRpZ2VzdChcbiAgICAgIFwiU0hBLTI1NlwiLFxuICAgICAgcHVibGljS2V5RXhwb3J0LFxuICAgICk7XG4gICAgY29uc3QgaWQgPSB0aGlzLmFycmF5QnVmZmVyVG9IZXgocHVibGljS2V5SGFzaClcbiAgICAgIC5zdWJzdHJpbmcoMCwgMTYpXG4gICAgICAudG9VcHBlckNhc2UoKTtcblxuICAgIHRoaXMuaWRlbnRpdHkgPSB7XG4gICAgICBpZCxcbiAgICAgIHB1YmxpY0tleToga2V5UGFpci5wdWJsaWNLZXksXG4gICAgICBwcml2YXRlS2V5OiBrZXlQYWlyLnByaXZhdGVLZXksXG4gICAgICBjcmVhdGVkOiBuZXcgRGF0ZSgpLFxuICAgICAgZGlzcGxheU5hbWUsXG4gICAgfTtcblxuICAgIGF3YWl0IHRoaXMuc2F2ZUlkZW50aXR5KCk7XG4gICAgcmV0dXJuIHRoaXMuaWRlbnRpdHk7XG4gIH1cblxuICAvLyBMb2FkIGV4aXN0aW5nIGlkZW50aXR5IGZyb20gc3RvcmFnZVxuICBhc3luYyBsb2FkSWRlbnRpdHkoKTogUHJvbWlzZTxJZGVudGl0eSB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3RvcmVkID0gYXdhaXQgdGhpcy5zdG9yYWdlLmxvYWQodGhpcy5zdG9yYWdlS2V5KTtcbiAgICAgIGlmICghc3RvcmVkKSByZXR1cm4gbnVsbDtcblxuICAgICAgY29uc3QgZGF0YTogSWRlbnRpdHlFeHBvcnQgPSBKU09OLnBhcnNlKHN0b3JlZCk7XG5cbiAgICAgIC8vIEltcG9ydCBrZXlzXG4gICAgICBjb25zdCBwdWJsaWNLZXkgPSBhd2FpdCB0aGlzLnN1YnRsZS5pbXBvcnRLZXkoXG4gICAgICAgIFwiandrXCIsXG4gICAgICAgIGRhdGEucHVibGljS2V5SndrLFxuICAgICAgICB7IG5hbWU6IFwiRWQyNTUxOVwiLCBuYW1lZEN1cnZlOiBcIkVkMjU1MTlcIiB9IGFzIGFueSxcbiAgICAgICAgdHJ1ZSxcbiAgICAgICAgW1widmVyaWZ5XCJdLFxuICAgICAgKTtcblxuICAgICAgY29uc3QgcHJpdmF0ZUtleSA9IGF3YWl0IHRoaXMuc3VidGxlLmltcG9ydEtleShcbiAgICAgICAgXCJqd2tcIixcbiAgICAgICAgZGF0YS5wcml2YXRlS2V5SndrLFxuICAgICAgICB7IG5hbWU6IFwiRWQyNTUxOVwiLCBuYW1lZEN1cnZlOiBcIkVkMjU1MTlcIiB9IGFzIGFueSxcbiAgICAgICAgdHJ1ZSxcbiAgICAgICAgW1wic2lnblwiXSxcbiAgICAgICk7XG5cbiAgICAgIHRoaXMuaWRlbnRpdHkgPSB7XG4gICAgICAgIGlkOiBkYXRhLmlkLFxuICAgICAgICBwdWJsaWNLZXksXG4gICAgICAgIHByaXZhdGVLZXksXG4gICAgICAgIGNyZWF0ZWQ6IG5ldyBEYXRlKGRhdGEuY3JlYXRlZCksXG4gICAgICAgIGRpc3BsYXlOYW1lOiBkYXRhLmRpc3BsYXlOYW1lLFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIHRoaXMuaWRlbnRpdHk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJGYWlsZWQgdG8gbG9hZCBpZGVudGl0eTpcIiwgZXJyb3IpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLy8gU2F2ZSBpZGVudGl0eSB0byBzdG9yYWdlXG4gIHByaXZhdGUgYXN5bmMgc2F2ZUlkZW50aXR5KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5pZGVudGl0eSkgcmV0dXJuO1xuXG4gICAgY29uc3QgZXhwb3J0ZWQgPSBhd2FpdCB0aGlzLmV4cG9ydElkZW50aXR5KCk7XG4gICAgYXdhaXQgdGhpcy5zdG9yYWdlLnNhdmUodGhpcy5zdG9yYWdlS2V5LCBKU09OLnN0cmluZ2lmeShleHBvcnRlZCkpO1xuICB9XG5cbiAgLy8gRXhwb3J0IGlkZW50aXR5IChmb3IgYmFja3VwKVxuICBhc3luYyBleHBvcnRJZGVudGl0eSgpOiBQcm9taXNlPElkZW50aXR5RXhwb3J0PiB7XG4gICAgaWYgKCF0aGlzLmlkZW50aXR5KSB0aHJvdyBuZXcgRXJyb3IoXCJObyBpZGVudGl0eSB0byBleHBvcnRcIik7XG5cbiAgICBjb25zdCBwdWJsaWNLZXlKd2sgPSBhd2FpdCB0aGlzLnN1YnRsZS5leHBvcnRLZXkoXG4gICAgICBcImp3a1wiLFxuICAgICAgdGhpcy5pZGVudGl0eS5wdWJsaWNLZXksXG4gICAgKTtcbiAgICBjb25zdCBwcml2YXRlS2V5SndrID0gYXdhaXQgdGhpcy5zdWJ0bGUuZXhwb3J0S2V5KFxuICAgICAgXCJqd2tcIixcbiAgICAgIHRoaXMuaWRlbnRpdHkucHJpdmF0ZUtleSxcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiB0aGlzLmlkZW50aXR5LmlkLFxuICAgICAgcHVibGljS2V5SndrLFxuICAgICAgcHJpdmF0ZUtleUp3ayxcbiAgICAgIGNyZWF0ZWQ6IHRoaXMuaWRlbnRpdHkuY3JlYXRlZC50b0lTT1N0cmluZygpLFxuICAgICAgZGlzcGxheU5hbWU6IHRoaXMuaWRlbnRpdHkuZGlzcGxheU5hbWUsXG4gICAgfTtcbiAgfVxuXG4gIC8vIEltcG9ydCBpZGVudGl0eSAoZnJvbSBiYWNrdXApXG4gIGFzeW5jIGltcG9ydElkZW50aXR5KGRhdGE6IElkZW50aXR5RXhwb3J0KTogUHJvbWlzZTxJZGVudGl0eT4ge1xuICAgIGNvbnN0IHB1YmxpY0tleSA9IGF3YWl0IHRoaXMuc3VidGxlLmltcG9ydEtleShcbiAgICAgIFwiandrXCIsXG4gICAgICBkYXRhLnB1YmxpY0tleUp3ayxcbiAgICAgIHsgbmFtZTogXCJFZDI1NTE5XCIsIG5hbWVkQ3VydmU6IFwiRWQyNTUxOVwiIH0gYXMgYW55LFxuICAgICAgdHJ1ZSxcbiAgICAgIFtcInZlcmlmeVwiXSxcbiAgICApO1xuXG4gICAgY29uc3QgcHJpdmF0ZUtleSA9IGF3YWl0IHRoaXMuc3VidGxlLmltcG9ydEtleShcbiAgICAgIFwiandrXCIsXG4gICAgICBkYXRhLnByaXZhdGVLZXlKd2ssXG4gICAgICB7IG5hbWU6IFwiRWQyNTUxOVwiLCBuYW1lZEN1cnZlOiBcIkVkMjU1MTlcIiB9IGFzIGFueSxcbiAgICAgIHRydWUsXG4gICAgICBbXCJzaWduXCJdLFxuICAgICk7XG5cbiAgICB0aGlzLmlkZW50aXR5ID0ge1xuICAgICAgaWQ6IGRhdGEuaWQsXG4gICAgICBwdWJsaWNLZXksXG4gICAgICBwcml2YXRlS2V5LFxuICAgICAgY3JlYXRlZDogbmV3IERhdGUoZGF0YS5jcmVhdGVkKSxcbiAgICAgIGRpc3BsYXlOYW1lOiBkYXRhLmRpc3BsYXlOYW1lLFxuICAgIH07XG5cbiAgICBhd2FpdCB0aGlzLnNhdmVJZGVudGl0eSgpO1xuICAgIHJldHVybiB0aGlzLmlkZW50aXR5O1xuICB9XG5cbiAgLy8gR2V0IGN1cnJlbnQgaWRlbnRpdHlcbiAgZ2V0SWRlbnRpdHkoKTogSWRlbnRpdHkgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5pZGVudGl0eTtcbiAgfVxuXG4gIC8vIEdldCBjdXJyZW50IGlkZW50aXR5IChhbGlhcyBmb3IgZ2V0SWRlbnRpdHkpXG4gIGdldEN1cnJlbnRJZGVudGl0eSgpOiBJZGVudGl0eSB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLmlkZW50aXR5O1xuICB9XG5cbiAgLy8gQ2hlY2sgaWYgaWRlbnRpdHkgZXhpc3RzXG4gIGhhc0lkZW50aXR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlkZW50aXR5ICE9PSBudWxsO1xuICB9XG5cbiAgLy8gR2V0IHB1YmxpYyBrZXlcbiAgYXN5bmMgZ2V0UHVibGljS2V5KCk6IFByb21pc2U8Q3J5cHRvS2V5PiB7XG4gICAgaWYgKCF0aGlzLmlkZW50aXR5KSB0aHJvdyBuZXcgRXJyb3IoXCJObyBpZGVudGl0eSBsb2FkZWRcIik7XG4gICAgcmV0dXJuIHRoaXMuaWRlbnRpdHkucHVibGljS2V5O1xuICB9XG5cbiAgLy8gR2V0IHB1YmxpYyBrZXkgYXMgYnl0ZXNcbiAgYXN5bmMgZ2V0UHVibGljS2V5Qnl0ZXMoKTogUHJvbWlzZTxVaW50OEFycmF5PiB7XG4gICAgaWYgKCF0aGlzLmlkZW50aXR5KSB0aHJvdyBuZXcgRXJyb3IoXCJObyBpZGVudGl0eSBsb2FkZWRcIik7XG4gICAgY29uc3QgZXhwb3J0ZWQgPSBhd2FpdCB0aGlzLnN1YnRsZS5leHBvcnRLZXkoXG4gICAgICBcInJhd1wiLFxuICAgICAgdGhpcy5pZGVudGl0eS5wdWJsaWNLZXksXG4gICAgKTtcbiAgICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoZXhwb3J0ZWQpO1xuICB9XG5cbiAgLy8gR2V0IHB1YmxpYyBrZXkgYXMgaGV4IHN0cmluZ1xuICBhc3luYyBnZXRQdWJsaWNLZXlIZXgoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBpZiAoIXRoaXMuaWRlbnRpdHkpIHRocm93IG5ldyBFcnJvcihcIk5vIGlkZW50aXR5IGxvYWRlZFwiKTtcbiAgICBjb25zdCBleHBvcnRlZCA9IGF3YWl0IHRoaXMuc3VidGxlLmV4cG9ydEtleShcbiAgICAgIFwicmF3XCIsXG4gICAgICB0aGlzLmlkZW50aXR5LnB1YmxpY0tleSxcbiAgICApO1xuICAgIHJldHVybiB0aGlzLmFycmF5QnVmZmVyVG9IZXgoZXhwb3J0ZWQpO1xuICB9XG5cbiAgLy8gU2lnbiBkYXRhXG4gIGFzeW5jIHNpZ24oZGF0YTogVWludDhBcnJheSk6IFByb21pc2U8VWludDhBcnJheT4ge1xuICAgIGlmICghdGhpcy5pZGVudGl0eSkgdGhyb3cgbmV3IEVycm9yKFwiTm8gaWRlbnRpdHkgbG9hZGVkXCIpO1xuXG4gICAgY29uc3Qgc2lnbmF0dXJlID0gYXdhaXQgdGhpcy5zdWJ0bGUuc2lnbihcbiAgICAgIHsgbmFtZTogXCJFZDI1NTE5XCIgfSBhcyBhbnksXG4gICAgICB0aGlzLmlkZW50aXR5LnByaXZhdGVLZXksXG4gICAgICBkYXRhLmJ1ZmZlciBhcyBBcnJheUJ1ZmZlcixcbiAgICApO1xuXG4gICAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHNpZ25hdHVyZSk7XG4gIH1cblxuICAvLyBWZXJpZnkgc2lnbmF0dXJlIChvdmVybG9hZGVkIC0gY2FuIHVzZSBjdXJyZW50IGlkZW50aXR5J3MgcHVibGljIGtleSBvciBwcm92aWRlZCBrZXkpXG4gIGFzeW5jIHZlcmlmeShcbiAgICBkYXRhOiBVaW50OEFycmF5LFxuICAgIHNpZ25hdHVyZTogVWludDhBcnJheSxcbiAgICBwdWJsaWNLZXk/OiBDcnlwdG9LZXksXG4gICk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGtleVRvVXNlID0gcHVibGljS2V5IHx8IHRoaXMuaWRlbnRpdHk/LnB1YmxpY0tleTtcbiAgICBpZiAoIWtleVRvVXNlKSB0aHJvdyBuZXcgRXJyb3IoXCJObyBwdWJsaWMga2V5IGF2YWlsYWJsZVwiKTtcblxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgY3J5cHRvLnN1YnRsZS52ZXJpZnkoXG4gICAgICAgIHsgbmFtZTogXCJFZDI1NTE5XCIgfSBhcyBhbnksXG4gICAgICAgIGtleVRvVXNlLFxuICAgICAgICBzaWduYXR1cmUuYnVmZmVyIGFzIEFycmF5QnVmZmVyLFxuICAgICAgICBkYXRhLmJ1ZmZlciBhcyBBcnJheUJ1ZmZlcixcbiAgICAgICk7XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLy8gR2V0IHB1YmxpYyBrZXkgYXMgc3RyaW5nXG4gIGFzeW5jIGdldFB1YmxpY0tleVN0cmluZygpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICghdGhpcy5pZGVudGl0eSkgdGhyb3cgbmV3IEVycm9yKFwiTm8gaWRlbnRpdHkgbG9hZGVkXCIpO1xuXG4gICAgY29uc3QgZXhwb3J0ZWQgPSBhd2FpdCBjcnlwdG8uc3VidGxlLmV4cG9ydEtleShcbiAgICAgIFwicmF3XCIsXG4gICAgICB0aGlzLmlkZW50aXR5LnB1YmxpY0tleSxcbiAgICApO1xuICAgIHJldHVybiB0aGlzLmFycmF5QnVmZmVyVG9IZXgoZXhwb3J0ZWQpO1xuICB9XG5cbiAgLy8gRGVsZXRlIGlkZW50aXR5XG4gIGFzeW5jIGRlbGV0ZUlkZW50aXR5KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuc3RvcmFnZS5yZW1vdmUodGhpcy5zdG9yYWdlS2V5KTtcbiAgICB0aGlzLmlkZW50aXR5ID0gbnVsbDtcbiAgfVxuXG4gIC8vIEhlbHBlcjogQXJyYXlCdWZmZXIgdG8gaGV4IHN0cmluZ1xuICBwcml2YXRlIGFycmF5QnVmZmVyVG9IZXgoYnVmZmVyOiBBcnJheUJ1ZmZlcik6IHN0cmluZyB7XG4gICAgcmV0dXJuIEFycmF5LmZyb20obmV3IFVpbnQ4QXJyYXkoYnVmZmVyKSlcbiAgICAgIC5tYXAoKGIpID0+IGIudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsIFwiMFwiKSlcbiAgICAgIC5qb2luKFwiXCIpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=