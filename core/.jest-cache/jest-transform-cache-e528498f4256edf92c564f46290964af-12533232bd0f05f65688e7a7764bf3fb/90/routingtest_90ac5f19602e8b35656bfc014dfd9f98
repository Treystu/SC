b75cbe01948b29986cc19399969327e1
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const routing_1 = require("../mesh/routing");
const message_1 = require("../protocol/message");
describe('Routing Table', () => {
    let routingTable;
    beforeEach(() => {
        routingTable = new routing_1.RoutingTable('local-peer');
    });
    describe('Peer Management', () => {
        it('should add and retrieve peers', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            const retrieved = routingTable.getPeer('peer1');
            expect(retrieved?.id).toEqual(peer.id);
            expect(retrieved?.publicKey).toEqual(peer.publicKey);
        });
        it('should remove peers', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            routingTable.removePeer('peer1');
            const retrieved = routingTable.getPeer('peer1');
            expect(retrieved).toBeUndefined();
        });
        it('should list all peers', () => {
            const peer1 = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            const peer2 = (0, routing_1.createPeer)('peer2', new Uint8Array(32), 'bluetooth');
            routingTable.addPeer(peer1);
            routingTable.addPeer(peer2);
            const peers = routingTable.getAllPeers();
            expect(peers).toHaveLength(2);
            expect(peers.map(p => p.id)).toContain('peer1');
            expect(peers.map(p => p.id)).toContain('peer2');
        });
        it('should update peer last seen', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            peer.lastSeen = 1000;
            routingTable.addPeer(peer);
            routingTable.updatePeerLastSeen('peer1');
            const updated = routingTable.getPeer('peer1');
            expect(updated.lastSeen).toBeGreaterThan(1000);
        });
        it('should remove stale peers', async () => {
            const stalePeer = (0, routing_1.createPeer)('stale', new Uint8Array(32), 'webrtc');
            stalePeer.lastSeen = Date.now() - 120000; // 2 minutes ago
            const freshPeer = (0, routing_1.createPeer)('fresh', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(stalePeer);
            routingTable.addPeer(freshPeer);
            const removed = routingTable.removeStalepeers(60000); // 60 second timeout
            expect(removed).toContain('stale');
            expect(removed).not.toContain('fresh');
            expect(routingTable.getPeer('stale')).toBeUndefined();
            expect(routingTable.getPeer('fresh')).toBeDefined();
        });
    });
    describe('Message Deduplication', () => {
        it('should detect duplicate messages', () => {
            const hash = 'message-hash-123';
            expect(routingTable.hasSeenMessage(hash)).toBe(false);
            routingTable.markMessageSeen(hash);
            expect(routingTable.hasSeenMessage(hash)).toBe(true);
        });
        it('should track multiple messages', () => {
            const hashes = ['hash1', 'hash2', 'hash3'];
            hashes.forEach(hash => routingTable.markMessageSeen(hash));
            hashes.forEach(hash => {
                expect(routingTable.hasSeenMessage(hash)).toBe(true);
            });
        });
    });
    describe('Routing', () => {
        it('should create direct routes for connected peers', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            const nextHop = routingTable.getNextHop('peer1');
            expect(nextHop).toBe('peer1');
        });
        it('should return undefined for unknown destinations', () => {
            const nextHop = routingTable.getNextHop('unknown');
            expect(nextHop).toBeUndefined();
        });
    });
    describe('Statistics', () => {
        it('should return correct stats', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            routingTable.markMessageSeen('hash1');
            const stats = routingTable.getStats();
            expect(stats.peerCount).toBe(1);
            expect(stats.routeCount).toBe(1);
            expect(stats.cacheSize).toBe(1);
        });
    });
});
describe('Message Queue', () => {
    let queue;
    beforeEach(() => {
        queue = new routing_1.MessageQueue();
    });
    it('should enqueue and dequeue messages', () => {
        const message = { data: 'test' };
        queue.enqueue(message_1.MessageType.TEXT, message);
        const dequeued = queue.dequeue();
        expect(dequeued).toEqual(message);
    });
    it('should prioritize control messages over text', () => {
        const textMsg = { type: 'text' };
        const controlMsg = { type: 'control' };
        queue.enqueue(message_1.MessageType.TEXT, textMsg);
        queue.enqueue(message_1.MessageType.CONTROL_PING, controlMsg);
        const first = queue.dequeue();
        expect(first).toEqual(controlMsg);
    });
    it('should prioritize voice over text', () => {
        const textMsg = { type: 'text' };
        const voiceMsg = { type: 'voice' };
        queue.enqueue(message_1.MessageType.TEXT, textMsg);
        queue.enqueue(message_1.MessageType.VOICE, voiceMsg);
        const first = queue.dequeue();
        expect(first).toEqual(voiceMsg);
    });
    it('should return null when queue is empty', () => {
        const message = queue.dequeue();
        expect(message).toBeNull();
    });
    it('should track queue size', () => {
        expect(queue.size()).toBe(0);
        queue.enqueue(message_1.MessageType.TEXT, { data: '1' });
        queue.enqueue(message_1.MessageType.TEXT, { data: '2' });
        expect(queue.size()).toBe(2);
        queue.dequeue();
        expect(queue.size()).toBe(1);
    });
    it('should clear all messages', () => {
        queue.enqueue(message_1.MessageType.TEXT, { data: '1' });
        queue.enqueue(message_1.MessageType.VOICE, { data: '2' });
        queue.clear();
        expect(queue.size()).toBe(0);
        expect(queue.dequeue()).toBeNull();
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvbWVzaC9yb3V0aW5nLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFDQSw2Q0FBeUU7QUFDekUsaURBQWtEO0FBRWxELFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO0lBQzdCLElBQUksWUFBMEIsQ0FBQztJQUUvQixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsWUFBWSxHQUFHLElBQUksc0JBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNoRCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7UUFDL0IsRUFBRSxDQUFDLCtCQUErQixFQUFFLEdBQUcsRUFBRTtZQUN2QyxNQUFNLElBQUksR0FBRyxJQUFBLG9CQUFVLEVBQUMsT0FBTyxFQUFFLElBQUksVUFBVSxDQUFDLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBRS9ELFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0IsTUFBTSxTQUFTLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUVoRCxNQUFNLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdkMsTUFBTSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtZQUM3QixNQUFNLElBQUksR0FBRyxJQUFBLG9CQUFVLEVBQUMsT0FBTyxFQUFFLElBQUksVUFBVSxDQUFDLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBRS9ELFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0IsWUFBWSxD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N0IsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2hCLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxFQUFFO1FBQ25DLEtBQUssQ0FBQyxPQUFPLENBQUMscUJBQVcsQ0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUMvQyxLQUFLLENBQUMsT0FBTyxDQUFDLHFCQUFXLENBQUMsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFFaEQsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2QsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM3QixNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDckMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvY2hyaXN0eW1heHdlbGwvRGVza3RvcC9MdWtlX1N0dWZmL0dpdEh1Yi9TQy9jb3JlL3NyYy9tZXNoL3JvdXRpbmcudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFBlZXIgfSBmcm9tICcuLi9tZXNoL3JvdXRpbmcnO1xuaW1wb3J0IHsgUm91dGluZ1RhYmxlLCBNZXNzYWdlUXVldWUsIGNyZWF0ZVBlZXIgfSBmcm9tICcuLi9tZXNoL3JvdXRpbmcnO1xuaW1wb3J0IHsgTWVzc2FnZVR5cGUgfSBmcm9tICcuLi9wcm90b2NvbC9tZXNzYWdlJztcblxuZGVzY3JpYmUoJ1JvdXRpbmcgVGFibGUnLCAoKSA9PiB7XG4gIGxldCByb3V0aW5nVGFibGU6IFJvdXRpbmdUYWJsZTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICByb3V0aW5nVGFibGUgPSBuZXcgUm91dGluZ1RhYmxlKCdsb2NhbC1wZWVyJyk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdQZWVyIE1hbmFnZW1lbnQnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBhZGQgYW5kIHJldHJpZXZlIHBlZXJzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlciA9IGNyZWF0ZVBlZXIoJ3BlZXIxJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG5cbiAgICAgIHJvdXRpbmdUYWJsZS5hZGRQZWVyKHBlZXIpO1xuICAgICAgY29uc3QgcmV0cmlldmVkID0gcm91dGluZ1RhYmxlLmdldFBlZXIoJ3BlZXIxJyk7XG5cbiAgICAgIGV4cGVjdChyZXRyaWV2ZWQ/LmlkKS50b0VxdWFsKHBlZXIuaWQpO1xuICAgICAgZXhwZWN0KHJldHJpZXZlZD8ucHVibGljS2V5KS50b0VxdWFsKHBlZXIucHVibGljS2V5KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVtb3ZlIHBlZXJzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlciA9IGNyZWF0ZVBlZXIoJ3BlZXIxJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG5cbiAgICAgIHJvdXRpbmdUYWJsZS5hZGRQZWVyKHBlZXIpO1xuICAgICAgcm91dGluZ1RhYmxlLnJlbW92ZVBlZXIoJ3BlZXIxJyk7XG4gICAgICBjb25zdCByZXRyaWV2ZWQgPSByb3V0aW5nVGFibGUuZ2V0UGVlcigncGVlcjEnKTtcblxuICAgICAgZXhwZWN0KHJldHJpZXZlZCkudG9CZVVuZGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBsaXN0IGFsbCBwZWVycycsICgpID0+IHtcbiAgICAgIGNvbnN0IHBlZXIxID0gY3JlYXRlUGVlcigncGVlcjEnLCBuZXcgVWludDhBcnJheSgzMiksICd3ZWJydGMnKTtcbiAgICAgIGNvbnN0IHBlZXIyID0gY3JlYXRlUGVlcigncGVlcjInLCBuZXcgVWludDhBcnJheSgzMiksICdibHVldG9vdGgnKTtcblxuICAgICAgcm91dGluZ1RhYmxlLmFkZFBlZXIocGVlcjEpO1xuICAgICAgcm91dGluZ1RhYmxlLmFkZFBlZXIocGVlcjIpO1xuXG4gICAgICBjb25zdCBwZWVycyA9IHJvdXRpbmdUYWJsZS5nZXRBbGxQZWVycygpO1xuICAgICAgZXhwZWN0KHBlZXJzKS50b0hhdmVMZW5ndGgoMik7XG4gICAgICBleHBlY3QocGVlcnMubWFwKHAgPT4gcC5pZCkpLnRvQ29udGFpbigncGVlcjEnKTtcbiAgICAgIGV4cGVjdChwZWVycy5tYXAocCA9PiBwLmlkKSkudG9Db250YWluKCdwZWVyMicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB1cGRhdGUgcGVlciBsYXN0IHNlZW4nLCAoKSA9PiB7XG4gICAgICBjb25zdCBwZWVyID0gY3JlYXRlUGVlcigncGVlcjEnLCBuZXcgVWludDhBcnJheSgzMiksICd3ZWJydGMnKTtcbiAgICAgIHBlZXIubGFzdFNlZW4gPSAxMDAwO1xuXG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyKTtcbiAgICAgIHJvdXRpbmdUYWJsZS51cGRhdGVQZWVyTGFzdFNlZW4oJ3BlZXIxJyk7XG5cbiAgICAgIGNvbnN0IHVwZGF0ZWQgPSByb3V0aW5nVGFibGUuZ2V0UGVlcigncGVlcjEnKTtcbiAgICAgIGV4cGVjdCh1cGRhdGVkIS5sYXN0U2VlbikudG9CZUdyZWF0ZXJUaGFuKDEwMDApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZW1vdmUgc3RhbGUgcGVlcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBzdGFsZVBlZXIgPSBjcmVhdGVQZWVyKCdzdGFsZScsIG5ldyBVaW50OEFycmF5KDMyKSwgJ3dlYnJ0YycpO1xuICAgICAgc3RhbGVQZWVyLmxhc3RTZWVuID0gRGF0ZS5ub3coKSAtIDEyMDAwMDsgLy8gMiBtaW51dGVzIGFnb1xuXG4gICAgICBjb25zdCBmcmVzaFBlZXIgPSBjcmVhdGVQZWVyKCdmcmVzaCcsIG5ldyBVaW50OEFycmF5KDMyKSwgJ3dlYnJ0YycpO1xuXG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihzdGFsZVBlZXIpO1xuICAgICAgcm91dGluZ1RhYmxlLmFkZFBlZXIoZnJlc2hQZWVyKTtcblxuICAgICAgY29uc3QgcmVtb3ZlZCA9IHJvdXRpbmdUYWJsZS5yZW1vdmVTdGFsZXBlZXJzKDYwMDAwKTsgLy8gNjAgc2Vjb25kIHRpbWVvdXRcblxuICAgICAgZXhwZWN0KHJlbW92ZWQpLnRvQ29udGFpbignc3RhbGUnKTtcbiAgICAgIGV4cGVjdChyZW1vdmVkKS5ub3QudG9Db250YWluKCdmcmVzaCcpO1xuICAgICAgZXhwZWN0KHJvdXRpbmdUYWJsZS5nZXRQZWVyKCdzdGFsZScpKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICBleHBlY3Qocm91dGluZ1RhYmxlLmdldFBlZXIoJ2ZyZXNoJykpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdNZXNzYWdlIERlZHVwbGljYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBkZXRlY3QgZHVwbGljYXRlIG1lc3NhZ2VzJywgKCkgPT4ge1xuICAgICAgY29uc3QgaGFzaCA9ICdtZXNzYWdlLWhhc2gtMTIzJztcblxuICAgICAgZXhwZWN0KHJvdXRpbmdUYWJsZS5oYXNTZWVuTWVzc2FnZShoYXNoKSkudG9CZShmYWxzZSk7XG4gICAgICByb3V0aW5nVGFibGUubWFya01lc3NhZ2VTZWVuKGhhc2gpO1xuICAgICAgZXhwZWN0KHJvdXRpbmdUYWJsZS5oYXNTZWVuTWVzc2FnZShoYXNoKSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdHJhY2sgbXVsdGlwbGUgbWVzc2FnZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBoYXNoZXMgPSBbJ2hhc2gxJywgJ2hhc2gyJywgJ2hhc2gzJ107XG5cbiAgICAgIGhhc2hlcy5mb3JFYWNoKGhhc2ggPT4gcm91dGluZ1RhYmxlLm1hcmtNZXNzYWdlU2VlbihoYXNoKSk7XG4gICAgICBoYXNoZXMuZm9yRWFjaChoYXNoID0+IHtcbiAgICAgICAgZXhwZWN0KHJvdXRpbmdUYWJsZS5oYXNTZWVuTWVzc2FnZShoYXNoKSkudG9CZSh0cnVlKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUm91dGluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBkaXJlY3Qgcm91dGVzIGZvciBjb25uZWN0ZWQgcGVlcnMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBwZWVyID0gY3JlYXRlUGVlcigncGVlcjEnLCBuZXcgVWludDhBcnJheSgzMiksICd3ZWJydGMnKTtcblxuICAgICAgcm91dGluZ1RhYmxlLmFkZFBlZXIocGVlcik7XG4gICAgICBjb25zdCBuZXh0SG9wID0gcm91dGluZ1RhYmxlLmdldE5leHRIb3AoJ3BlZXIxJyk7XG5cbiAgICAgIGV4cGVjdChuZXh0SG9wKS50b0JlKCdwZWVyMScpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdW5kZWZpbmVkIGZvciB1bmtub3duIGRlc3RpbmF0aW9ucycsICgpID0+IHtcbiAgICAgIGNvbnN0IG5leHRIb3AgPSByb3V0aW5nVGFibGUuZ2V0TmV4dEhvcCgndW5rbm93bicpO1xuICAgICAgZXhwZWN0KG5leHRIb3ApLnRvQmVVbmRlZmluZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1N0YXRpc3RpY3MnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gY29ycmVjdCBzdGF0cycsICgpID0+IHtcbiAgICAgIGNvbnN0IHBlZXIgPSBjcmVhdGVQZWVyKCdwZWVyMScsIG5ldyBVaW50OEFycmF5KDMyKSwgJ3dlYnJ0YycpO1xuXG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyKTtcbiAgICAgIHJvdXRpbmdUYWJsZS5tYXJrTWVzc2FnZVNlZW4oJ2hhc2gxJyk7XG5cbiAgICAgIGNvbnN0IHN0YXRzID0gcm91dGluZ1RhYmxlLmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMucGVlckNvdW50KS50b0JlKDEpO1xuICAgICAgZXhwZWN0KHN0YXRzLnJvdXRlQ291bnQpLnRvQmUoMSk7XG4gICAgICBleHBlY3Qoc3RhdHMuY2FjaGVTaXplKS50b0JlKDEpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnTWVzc2FnZSBRdWV1ZScsICgpID0+IHtcbiAgbGV0IHF1ZXVlOiBNZXNzYWdlUXVldWU7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgcXVldWUgPSBuZXcgTWVzc2FnZVF1ZXVlKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgZW5xdWV1ZSBhbmQgZGVxdWV1ZSBtZXNzYWdlcycsICgpID0+IHtcbiAgICBjb25zdCBtZXNzYWdlID0geyBkYXRhOiAndGVzdCcgfTtcbiAgICBxdWV1ZS5lbnF1ZXVlKE1lc3NhZ2VUeXBlLlRFWFQsIG1lc3NhZ2UpO1xuXG4gICAgY29uc3QgZGVxdWV1ZWQgPSBxdWV1ZS5kZXF1ZXVlKCk7XG4gICAgZXhwZWN0KGRlcXVldWVkKS50b0VxdWFsKG1lc3NhZ2UpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHByaW9yaXRpemUgY29udHJvbCBtZXNzYWdlcyBvdmVyIHRleHQnLCAoKSA9PiB7XG4gICAgY29uc3QgdGV4dE1zZyA9IHsgdHlwZTogJ3RleHQnIH07XG4gICAgY29uc3QgY29udHJvbE1zZyA9IHsgdHlwZTogJ2NvbnRyb2wnIH07XG5cbiAgICBxdWV1ZS5lbnF1ZXVlKE1lc3NhZ2VUeXBlLlRFWFQsIHRleHRNc2cpO1xuICAgIHF1ZXVlLmVucXVldWUoTWVzc2FnZVR5cGUuQ09OVFJPTF9QSU5HLCBjb250cm9sTXNnKTtcblxuICAgIGNvbnN0IGZpcnN0ID0gcXVldWUuZGVxdWV1ZSgpO1xuICAgIGV4cGVjdChmaXJzdCkudG9FcXVhbChjb250cm9sTXNnKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBwcmlvcml0aXplIHZvaWNlIG92ZXIgdGV4dCcsICgpID0+IHtcbiAgICBjb25zdCB0ZXh0TXNnID0geyB0eXBlOiAndGV4dCcgfTtcbiAgICBjb25zdCB2b2ljZU1zZyA9IHsgdHlwZTogJ3ZvaWNlJyB9O1xuXG4gICAgcXVldWUuZW5xdWV1ZShNZXNzYWdlVHlwZS5URVhULCB0ZXh0TXNnKTtcbiAgICBxdWV1ZS5lbnF1ZXVlKE1lc3NhZ2VUeXBlLlZPSUNFLCB2b2ljZU1zZyk7XG5cbiAgICBjb25zdCBmaXJzdCA9IHF1ZXVlLmRlcXVldWUoKTtcbiAgICBleHBlY3QoZmlyc3QpLnRvRXF1YWwodm9pY2VNc2cpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiBudWxsIHdoZW4gcXVldWUgaXMgZW1wdHknLCAoKSA9PiB7XG4gICAgY29uc3QgbWVzc2FnZSA9IHF1ZXVlLmRlcXVldWUoKTtcbiAgICBleHBlY3QobWVzc2FnZSkudG9CZU51bGwoKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCB0cmFjayBxdWV1ZSBzaXplJywgKCkgPT4ge1xuICAgIGV4cGVjdChxdWV1ZS5zaXplKCkpLnRvQmUoMCk7XG5cbiAgICBxdWV1ZS5lbnF1ZXVlKE1lc3NhZ2VUeXBlLlRFWFQsIHsgZGF0YTogJzEnIH0pO1xuICAgIHF1ZXVlLmVucXVldWUoTWVzc2FnZVR5cGUuVEVYVCwgeyBkYXRhOiAnMicgfSk7XG4gICAgZXhwZWN0KHF1ZXVlLnNpemUoKSkudG9CZSgyKTtcblxuICAgIHF1ZXVlLmRlcXVldWUoKTtcbiAgICBleHBlY3QocXVldWUuc2l6ZSgpKS50b0JlKDEpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGNsZWFyIGFsbCBtZXNzYWdlcycsICgpID0+IHtcbiAgICBxdWV1ZS5lbnF1ZXVlKE1lc3NhZ2VUeXBlLlRFWFQsIHsgZGF0YTogJzEnIH0pO1xuICAgIHF1ZXVlLmVucXVldWUoTWVzc2FnZVR5cGUuVk9JQ0UsIHsgZGF0YTogJzInIH0pO1xuXG4gICAgcXVldWUuY2xlYXIoKTtcbiAgICBleHBlY3QocXVldWUuc2l6ZSgpKS50b0JlKDApO1xuICAgIGV4cGVjdChxdWV1ZS5kZXF1ZXVlKCkpLnRvQmVOdWxsKCk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=