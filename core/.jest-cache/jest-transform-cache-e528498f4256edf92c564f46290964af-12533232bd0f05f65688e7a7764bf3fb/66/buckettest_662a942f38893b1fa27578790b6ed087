73cbddd1900c2ee6d2e0a26317071f3a
"use strict";
/**
 * K-Bucket Tests
 */
Object.defineProperty(exports, "__esModule", { value: true });
const bucket_1 = require("./bucket");
const node_id_1 = require("./node-id");
describe('KBucket', () => {
    let bucket;
    beforeEach(() => {
        bucket = new bucket_1.KBucket(0, { k: 3 });
    });
    function createContact(id) {
        return {
            nodeId: id || (0, node_id_1.generateNodeId)(),
            peerId: 'test-peer',
            lastSeen: Date.now(),
            failureCount: 0,
        };
    }
    describe('Basic Operations', () => {
        it('should start empty', () => {
            expect(bucket.size).toBe(0);
            expect(bucket.isFull).toBe(false);
        });
        it('should add contacts', () => {
            const contact = createContact();
            const result = bucket.addContact(contact);
            expect(result.added).toBe(true);
            expect(result.updated).toBe(false);
            expect(bucket.size).toBe(1);
        });
        it('should update existing contacts', () => {
            const contact = createContact();
            bucket.addContact(contact);
            const result = bucket.addContact({ ...contact, peerId: 'updated' });
            expect(result.added).toBe(false);
            expect(result.updated).toBe(true);
            expect(bucket.size).toBe(1);
        });
        it('should get contact by node ID', () => {
            const contact = createContact();
            bucket.addContact(contact);
            const retrieved = bucket.getContact(contact.nodeId);
            expect(retrieved).toBeDefined();
            expect((0, node_id_1.nodeIdsEqual)(retrieved.nodeId, contact.nodeId)).toBe(true);
        });
        it('should return undefined for unknown contact', () => {
            const retrieved = bucket.getContact((0, node_id_1.generateNodeId)());
            expect(retrieved).toBeUndefined();
        });
        it('should check if contact exists', () => {
            const contact = createContact();
            bucket.addContact(contact);
            expect(bucket.hasContact(contact.nodeId)).toBe(true);
            expect(bucket.hasContact((0, node_id_1.generateNodeId)())).toBe(false);
        });
        it('should remove contacts', () => {
            const contact = createContact();
            bucket.addContact(contact);
            const removed = bucket.removeContact(contact.nodeId);
            expect(removed).toBeDefined();
            expect(bucket.size).toBe(0);
        });
        it('should return undefined when removing non-existent contact', () => {
            const removed = bucket.removeContact((0, node_id_1.generateNodeId)());
            expect(removed).toBeUndefined();
        });
    });
    describe('LRU Behavior', () => {
        it('should move updated contacts to front', () => {
            const contact1 = createContact();
            const contact2 = createContact();
            const contact3 = createContact();
            bucket.addContact(contact1);
            bucket.addContact(contact2);
            bucket.addContact(contact3);
            // Update contact1 (should move to front)
            bucket.addContact(contact1);
            const contacts = bucket.getContacts();
            expect((0, node_id_1.nodeIdsEqual)(contacts[0].nodeId, contact1.nodeId)).toBe(true);
        });
        it('should update lastSeen when adding existing contact', () => {
            const contact = createContact();
            contact.lastSeen = 1000;
            bucket.addContact(contact);
            // Wait a bit and re-add
            bucket.addContact(contact);
            const retrieved = bucket.getContact(contact.nodeId);
            expect(retrieved.lastSeen).toBeGreaterThan(1000);
        });
    });
    describe('Full Bucket Behavior', () => {
        it('should return needsPing when bucket is full', () => {
            // Fill the bucket
            for (let i = 0; i < 3; i++) {
                bucket.addContact(createContact());
            }
            expect(bucket.isFull).toBe(true);
            // Try to add another contact
            const newContact = createContact();
            const result = bucket.addContact(newContact);
            expect(result.added).toBe(false);
            expect(result.needsPing).toBeDefined();
        });
        it('should return least recently seen contact for ping', () => {
            const contact1 = createContact();
            contact1.lastSeen = 1000;
            const contact2 = createContact();
            contact2.lastSeen = 2000;
            const contact3 = createContact();
            contact3.lastSeen = 3000;
            bucket.addContact(contact3);
            bucket.addContact(contact2);
            bucket.addContact(contact1);
            const result = bucket.addContact(createContact());
            // Should ping the contact that was added last (least recently seen position)
            expect(result.needsPing).toBeDefined();
        });
    });
    describe('Replacement Cache', () => {
        it('should add to replacement cache when full', () => {
            // Fill bucket
            for (let i = 0; i < 3; i++) {
                bucket.addContact(createContact());
            }
            // Add another (goes to replacement cache)
            bucket.addContact(createContact());
            const cache = bucket.getReplacementCache();
            expect(cache.length).toBe(1);
        });
        it('should promote from replacement cache when contact removed', () => {
            // Fill bucket
            const contacts = [];
            for (let i = 0; i < 3; i++) {
                const c = createContact();
                contacts.push(c);
                bucket.addContact(c);
            }
            // Add to replacement cache
            const replacement = createContact();
            bucket.addContact(replacement);
            // Remove a contact
            bucket.removeContact(contacts[0].nodeId);
            // Check that replacement was promoted
            expect(bucket.size).toBe(3);
            expect(bucket.hasContact(replacement.nodeId)).toBe(true);
        });
    });
    describe('Failure Tracking', () => {
        it('should record failures', () => {
            const contact = createContact();
            bucket.addContact(contact);
            bucket.recordFailure(contact.nodeId);
            bucket.recordFailure(contact.nodeId);
            const retrieved = bucket.getContact(contact.nodeId);
            expect(retrieved.failureCount).toBe(2);
        });
        it('should reset failures', () => {
            const contact = createContact();
            contact.failureCount = 5;
            bucket.addContact(contact);
            bucket.resetFailures(contact.nodeId);
            const retrieved = bucket.getContact(contact.nodeId);
            expect(retrieved.failureCount).toBe(0);
        });
    });
    describe('Staleness', () => {
        it('should identify stale contacts', () => {
            const staleContact = createContact();
            bucket.addContact(staleContact);
            // Manually set the contact as stale after it's been added
            const storedStale = bucket.getContact(staleContact.nodeId);
            storedStale.lastSeen = Date.now() - 120000; // 2 minutes ago
            const freshContact = createContact();
            bucket.addContact(freshContact);
            const stale = bucket.getStaleContacts(60000); // 1 minute threshold
            expect(stale.length).toBe(1);
            expect((0, node_id_1.nodeIdsEqual)(stale[0].nodeId, staleContact.nodeId)).toBe(true);
        });
        it('should update last seen time', () => {
            const contact = createContact();
            contact.lastSeen = 1000;
            bucket.addContact(contact);
            bucket.updateLastSeen(contact.nodeId);
            const retrieved = bucket.getContact(contact.nodeId);
            expect(retrieved.lastSeen).toBeGreaterThan(1000);
        });
    });
    describe('Refresh', () => {
        it('should track refresh time', () => {
            const initialRefresh = bucket.getLastRefreshed();
            bucket.markRefreshed();
            const newRefresh = bucket.getLastRefreshed();
            expect(newRefresh).toBeGreaterThanOrEqual(initialRefresh);
        });
        it('should indicate when refresh is needed', () => {
            // Mark as refreshed long ago
            bucket['lastRefreshed'] = Date.now() - 7200000; // 2 hours ago
            expect(bucket.needsRefresh(3600000)).toBe(true); // 1 hour interval
        });
    });
    describe('Statistics', () => {
        it('should return correct stats', () => {
            const contact = createContact();
            bucket.addContact(contact);
            const stats = bucket.getStats();
            expect(stats.contacts).toBe(1);
            expect(stats.replacementCache).toBe(0);
            expect(stats.avgFailures).toBe(0);
        });
    });
});
describe('KBucketManager', () => {
    let manager;
    let localNodeId;
    beforeEach(() => {
        localNodeId = (0, node_id_1.generateNodeId)();
        manager = new bucket_1.KBucketManager(localNodeId, { k: 20 });
    });
    it('should create 160 buckets', () => {
        const buckets = manager.getAllBuckets();
        expect(buckets.length).toBe(160);
    });
    it('should get bucket by index', () => {
        const bucket = manager.getBucket(0);
        expect(bucket).toBeDefined();
        expect(bucket.index).toBe(0);
    });
    it('should return undefined for invalid index', () => {
        expect(manager.getBucket(-1)).toBeUndefined();
        expect(manager.getBucket(160)).toBeUndefined();
    });
    it('should track total contacts', () => {
        expect(manager.getTotalContacts()).toBe(0);
    });
    it('should track active bucket count', () => {
        expect(manager.getActiveBucketCount()).toBe(0);
    });
    it('should return stats', () => {
        const stats = manager.getStats();
        expect(stats.totalContacts).toBe(0);
        expect(stats.activeBuckets).toBe(0);
        expect(stats.bucketDistribution.length).toBe(160);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvbWVzaC9kaHQvYnVja2V0LnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILHFDQUFtRDtBQUVuRCx1Q0FBeUQ7QUFFekQsUUFBUSxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUU7SUFDdkIsSUFBSSxNQUFlLENBQUM7SUFFcEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLE1BQU0sR0FBRyxJQUFJLGdCQUFPLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLGFBQWEsQ0FBQyxFQUFlO1FBQ3BDLE9BQU87WUFDTCxNQUFNLEVBQUUsRUFBRSxJQUFJLElBQUEsd0JBQWMsR0FBRTtZQUM5QixNQUFNLEVBQUUsV0FBVztZQUNuQixRQUFRLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNwQixZQUFZLEVBQUUsQ0FBQztTQUNoQixDQUFDO0lBQ0osQ0FBQztJQUVELFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7UUFDaEMsRUFBRSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRTtZQUM1QixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM1QixNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLEVBQUU7WUFDN0IsTUFBTSxPQUFPLEdBQUcsYUFBYSxFQUFFLENBQUM7WUFDaEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUUxQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElB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RyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDcEQsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvY2hyaXN0eW1heHdlbGwvRGVza3RvcC9MdWtlX1N0dWZmL0dpdEh1Yi9TQy9jb3JlL3NyYy9tZXNoL2RodC9idWNrZXQudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEstQnVja2V0IFRlc3RzXG4gKi9cblxuaW1wb3J0IHsgS0J1Y2tldCwgS0J1Y2tldE1hbmFnZXIgfSBmcm9tICcuL2J1Y2tldCc7XG5pbXBvcnQgdHlwZSB7IERIVENvbnRhY3QgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IGdlbmVyYXRlTm9kZUlkLCBub2RlSWRzRXF1YWwgfSBmcm9tICcuL25vZGUtaWQnO1xuXG5kZXNjcmliZSgnS0J1Y2tldCcsICgpID0+IHtcbiAgbGV0IGJ1Y2tldDogS0J1Y2tldDtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBidWNrZXQgPSBuZXcgS0J1Y2tldCgwLCB7IGs6IDMgfSk7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIGNyZWF0ZUNvbnRhY3QoaWQ/OiBVaW50OEFycmF5KTogREhUQ29udGFjdCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5vZGVJZDogaWQgfHwgZ2VuZXJhdGVOb2RlSWQoKSxcbiAgICAgIHBlZXJJZDogJ3Rlc3QtcGVlcicsXG4gICAgICBsYXN0U2VlbjogRGF0ZS5ub3coKSxcbiAgICAgIGZhaWx1cmVDb3VudDogMCxcbiAgICB9O1xuICB9XG5cbiAgZGVzY3JpYmUoJ0Jhc2ljIE9wZXJhdGlvbnMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzdGFydCBlbXB0eScsICgpID0+IHtcbiAgICAgIGV4cGVjdChidWNrZXQuc2l6ZSkudG9CZSgwKTtcbiAgICAgIGV4cGVjdChidWNrZXQuaXNGdWxsKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgYWRkIGNvbnRhY3RzJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29udGFjdCA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmFkZGVkKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC51cGRhdGVkKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChidWNrZXQuc2l6ZSkudG9CZSgxKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXBkYXRlIGV4aXN0aW5nIGNvbnRhY3RzJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29udGFjdCA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBidWNrZXQuYWRkQ29udGFjdCh7IC4uLmNvbnRhY3QsIHBlZXJJZDogJ3VwZGF0ZWQnIH0pO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmFkZGVkKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQudXBkYXRlZCkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChidWNrZXQuc2l6ZSkudG9CZSgxKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZ2V0IGNvbnRhY3QgYnkgbm9kZSBJRCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbnRhY3QgPSBjcmVhdGVDb250YWN0KCk7XG4gICAgICBidWNrZXQuYWRkQ29udGFjdChjb250YWN0KTtcblxuICAgICAgY29uc3QgcmV0cmlldmVkID0gYnVja2V0LmdldENvbnRhY3QoY29udGFjdC5ub2RlSWQpO1xuICAgICAgZXhwZWN0KHJldHJpZXZlZCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChub2RlSWRzRXF1YWwocmV0cmlldmVkIS5ub2RlSWQsIGNvbnRhY3Qubm9kZUlkKSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHVuZGVmaW5lZCBmb3IgdW5rbm93biBjb250YWN0JywgKCkgPT4ge1xuICAgICAgY29uc3QgcmV0cmlldmVkID0gYnVja2V0LmdldENvbnRhY3QoZ2VuZXJhdGVOb2RlSWQoKSk7XG4gICAgICBleHBlY3QocmV0cmlldmVkKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNoZWNrIGlmIGNvbnRhY3QgZXhpc3RzJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29udGFjdCA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QpO1xuXG4gICAgICBleHBlY3QoYnVja2V0Lmhhc0NvbnRhY3QoY29udGFjdC5ub2RlSWQpKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KGJ1Y2tldC5oYXNDb250YWN0KGdlbmVyYXRlTm9kZUlkKCkpKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVtb3ZlIGNvbnRhY3RzJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29udGFjdCA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QpO1xuXG4gICAgICBjb25zdCByZW1vdmVkID0gYnVja2V0LnJlbW92ZUNvbnRhY3QoY29udGFjdC5ub2RlSWQpO1xuICAgICAgZXhwZWN0KHJlbW92ZWQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoYnVja2V0LnNpemUpLnRvQmUoMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiB1bmRlZmluZWQgd2hlbiByZW1vdmluZyBub24tZXhpc3RlbnQgY29udGFjdCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlbW92ZWQgPSBidWNrZXQucmVtb3ZlQ29udGFjdChnZW5lcmF0ZU5vZGVJZCgpKTtcbiAgICAgIGV4cGVjdChyZW1vdmVkKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdMUlUgQmVoYXZpb3InLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBtb3ZlIHVwZGF0ZWQgY29udGFjdHMgdG8gZnJvbnQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBjb250YWN0MSA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGNvbnN0IGNvbnRhY3QyID0gY3JlYXRlQ29udGFjdCgpO1xuICAgICAgY29uc3QgY29udGFjdDMgPSBjcmVhdGVDb250YWN0KCk7XG5cbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QxKTtcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QyKTtcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QzKTtcblxuICAgICAgLy8gVXBkYXRlIGNvbnRhY3QxIChzaG91bGQgbW92ZSB0byBmcm9udClcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QxKTtcblxuICAgICAgY29uc3QgY29udGFjdHMgPSBidWNrZXQuZ2V0Q29udGFjdHMoKTtcbiAgICAgIGV4cGVjdChub2RlSWRzRXF1YWwoY29udGFjdHNbMF0ubm9kZUlkLCBjb250YWN0MS5ub2RlSWQpKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB1cGRhdGUgbGFzdFNlZW4gd2hlbiBhZGRpbmcgZXhpc3RpbmcgY29udGFjdCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbnRhY3QgPSBjcmVhdGVDb250YWN0KCk7XG4gICAgICBjb250YWN0Lmxhc3RTZWVuID0gMTAwMDtcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QpO1xuXG4gICAgICAvLyBXYWl0IGEgYml0IGFuZCByZS1hZGRcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QpO1xuXG4gICAgICBjb25zdCByZXRyaWV2ZWQgPSBidWNrZXQuZ2V0Q29udGFjdChjb250YWN0Lm5vZGVJZCk7XG4gICAgICBleHBlY3QocmV0cmlldmVkIS5sYXN0U2VlbikudG9CZUdyZWF0ZXJUaGFuKDEwMDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRnVsbCBCdWNrZXQgQmVoYXZpb3InLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gbmVlZHNQaW5nIHdoZW4gYnVja2V0IGlzIGZ1bGwnLCAoKSA9PiB7XG4gICAgICAvLyBGaWxsIHRoZSBidWNrZXRcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgaSsrKSB7XG4gICAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNyZWF0ZUNvbnRhY3QoKSk7XG4gICAgICB9XG5cbiAgICAgIGV4cGVjdChidWNrZXQuaXNGdWxsKS50b0JlKHRydWUpO1xuXG4gICAgICAvLyBUcnkgdG8gYWRkIGFub3RoZXIgY29udGFjdFxuICAgICAgY29uc3QgbmV3Q29udGFjdCA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGJ1Y2tldC5hZGRDb250YWN0KG5ld0NvbnRhY3QpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmFkZGVkKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQubmVlZHNQaW5nKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gbGVhc3QgcmVjZW50bHkgc2VlbiBjb250YWN0IGZvciBwaW5nJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29udGFjdDEgPSBjcmVhdGVDb250YWN0KCk7XG4gICAgICBjb250YWN0MS5sYXN0U2VlbiA9IDEwMDA7XG4gICAgICBjb25zdCBjb250YWN0MiA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGNvbnRhY3QyLmxhc3RTZWVuID0gMjAwMDtcbiAgICAgIGNvbnN0IGNvbnRhY3QzID0gY3JlYXRlQ29udGFjdCgpO1xuICAgICAgY29udGFjdDMubGFzdFNlZW4gPSAzMDAwO1xuXG4gICAgICBidWNrZXQuYWRkQ29udGFjdChjb250YWN0Myk7XG4gICAgICBidWNrZXQuYWRkQ29udGFjdChjb250YWN0Mik7XG4gICAgICBidWNrZXQuYWRkQ29udGFjdChjb250YWN0MSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGJ1Y2tldC5hZGRDb250YWN0KGNyZWF0ZUNvbnRhY3QoKSk7XG5cbiAgICAgIC8vIFNob3VsZCBwaW5nIHRoZSBjb250YWN0IHRoYXQgd2FzIGFkZGVkIGxhc3QgKGxlYXN0IHJlY2VudGx5IHNlZW4gcG9zaXRpb24pXG4gICAgICBleHBlY3QocmVzdWx0Lm5lZWRzUGluZykudG9CZURlZmluZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1JlcGxhY2VtZW50IENhY2hlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYWRkIHRvIHJlcGxhY2VtZW50IGNhY2hlIHdoZW4gZnVsbCcsICgpID0+IHtcbiAgICAgIC8vIEZpbGwgYnVja2V0XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDM7IGkrKykge1xuICAgICAgICBidWNrZXQuYWRkQ29udGFjdChjcmVhdGVDb250YWN0KCkpO1xuICAgICAgfVxuXG4gICAgICAvLyBBZGQgYW5vdGhlciAoZ29lcyB0byByZXBsYWNlbWVudCBjYWNoZSlcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNyZWF0ZUNvbnRhY3QoKSk7XG5cbiAgICAgIGNvbnN0IGNhY2hlID0gYnVja2V0LmdldFJlcGxhY2VtZW50Q2FjaGUoKTtcbiAgICAgIGV4cGVjdChjYWNoZS5sZW5ndGgpLnRvQmUoMSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHByb21vdGUgZnJvbSByZXBsYWNlbWVudCBjYWNoZSB3aGVuIGNvbnRhY3QgcmVtb3ZlZCcsICgpID0+IHtcbiAgICAgIC8vIEZpbGwgYnVja2V0XG4gICAgICBjb25zdCBjb250YWN0czogREhUQ29udGFjdFtdID0gW107XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDM7IGkrKykge1xuICAgICAgICBjb25zdCBjID0gY3JlYXRlQ29udGFjdCgpO1xuICAgICAgICBjb250YWN0cy5wdXNoKGMpO1xuICAgICAgICBidWNrZXQuYWRkQ29udGFjdChjKTtcbiAgICAgIH1cblxuICAgICAgLy8gQWRkIHRvIHJlcGxhY2VtZW50IGNhY2hlXG4gICAgICBjb25zdCByZXBsYWNlbWVudCA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KHJlcGxhY2VtZW50KTtcblxuICAgICAgLy8gUmVtb3ZlIGEgY29udGFjdFxuICAgICAgYnVja2V0LnJlbW92ZUNvbnRhY3QoY29udGFjdHNbMF0ubm9kZUlkKTtcblxuICAgICAgLy8gQ2hlY2sgdGhhdCByZXBsYWNlbWVudCB3YXMgcHJvbW90ZWRcbiAgICAgIGV4cGVjdChidWNrZXQuc2l6ZSkudG9CZSgzKTtcbiAgICAgIGV4cGVjdChidWNrZXQuaGFzQ29udGFjdChyZXBsYWNlbWVudC5ub2RlSWQpKS50b0JlKHRydWUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRmFpbHVyZSBUcmFja2luZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJlY29yZCBmYWlsdXJlcycsICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbnRhY3QgPSBjcmVhdGVDb250YWN0KCk7XG4gICAgICBidWNrZXQuYWRkQ29udGFjdChjb250YWN0KTtcblxuICAgICAgYnVja2V0LnJlY29yZEZhaWx1cmUoY29udGFjdC5ub2RlSWQpO1xuICAgICAgYnVja2V0LnJlY29yZEZhaWx1cmUoY29udGFjdC5ub2RlSWQpO1xuXG4gICAgICBjb25zdCByZXRyaWV2ZWQgPSBidWNrZXQuZ2V0Q29udGFjdChjb250YWN0Lm5vZGVJZCk7XG4gICAgICBleHBlY3QocmV0cmlldmVkIS5mYWlsdXJlQ291bnQpLnRvQmUoMik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlc2V0IGZhaWx1cmVzJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29udGFjdCA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGNvbnRhY3QuZmFpbHVyZUNvdW50ID0gNTtcbiAgICAgIGJ1Y2tldC5hZGRDb250YWN0KGNvbnRhY3QpO1xuXG4gICAgICBidWNrZXQucmVzZXRGYWlsdXJlcyhjb250YWN0Lm5vZGVJZCk7XG5cbiAgICAgIGNvbnN0IHJldHJpZXZlZCA9IGJ1Y2tldC5nZXRDb250YWN0KGNvbnRhY3Qubm9kZUlkKTtcbiAgICAgIGV4cGVjdChyZXRyaWV2ZWQhLmZhaWx1cmVDb3VudCkudG9CZSgwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1N0YWxlbmVzcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGlkZW50aWZ5IHN0YWxlIGNvbnRhY3RzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc3RhbGVDb250YWN0ID0gY3JlYXRlQ29udGFjdCgpO1xuICAgICAgYnVja2V0LmFkZENvbnRhY3Qoc3RhbGVDb250YWN0KTtcbiAgICAgIFxuICAgICAgLy8gTWFudWFsbHkgc2V0IHRoZSBjb250YWN0IGFzIHN0YWxlIGFmdGVyIGl0J3MgYmVlbiBhZGRlZFxuICAgICAgY29uc3Qgc3RvcmVkU3RhbGUgPSBidWNrZXQuZ2V0Q29udGFjdChzdGFsZUNvbnRhY3Qubm9kZUlkKTtcbiAgICAgIHN0b3JlZFN0YWxlIS5sYXN0U2VlbiA9IERhdGUubm93KCkgLSAxMjAwMDA7IC8vIDIgbWludXRlcyBhZ29cblxuICAgICAgY29uc3QgZnJlc2hDb250YWN0ID0gY3JlYXRlQ29udGFjdCgpO1xuICAgICAgYnVja2V0LmFkZENvbnRhY3QoZnJlc2hDb250YWN0KTtcblxuICAgICAgY29uc3Qgc3RhbGUgPSBidWNrZXQuZ2V0U3RhbGVDb250YWN0cyg2MDAwMCk7IC8vIDEgbWludXRlIHRocmVzaG9sZFxuICAgICAgZXhwZWN0KHN0YWxlLmxlbmd0aCkudG9CZSgxKTtcbiAgICAgIGV4cGVjdChub2RlSWRzRXF1YWwoc3RhbGVbMF0ubm9kZUlkLCBzdGFsZUNvbnRhY3Qubm9kZUlkKSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXBkYXRlIGxhc3Qgc2VlbiB0aW1lJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29udGFjdCA9IGNyZWF0ZUNvbnRhY3QoKTtcbiAgICAgIGNvbnRhY3QubGFzdFNlZW4gPSAxMDAwO1xuICAgICAgYnVja2V0LmFkZENvbnRhY3QoY29udGFjdCk7XG5cbiAgICAgIGJ1Y2tldC51cGRhdGVMYXN0U2Vlbihjb250YWN0Lm5vZGVJZCk7XG5cbiAgICAgIGNvbnN0IHJldHJpZXZlZCA9IGJ1Y2tldC5nZXRDb250YWN0KGNvbnRhY3Qubm9kZUlkKTtcbiAgICAgIGV4cGVjdChyZXRyaWV2ZWQhLmxhc3RTZWVuKS50b0JlR3JlYXRlclRoYW4oMTAwMCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdSZWZyZXNoJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdHJhY2sgcmVmcmVzaCB0aW1lJywgKCkgPT4ge1xuICAgICAgY29uc3QgaW5pdGlhbFJlZnJlc2ggPSBidWNrZXQuZ2V0TGFzdFJlZnJlc2hlZCgpO1xuICAgICAgXG4gICAgICBidWNrZXQubWFya1JlZnJlc2hlZCgpO1xuICAgICAgXG4gICAgICBjb25zdCBuZXdSZWZyZXNoID0gYnVja2V0LmdldExhc3RSZWZyZXNoZWQoKTtcbiAgICAgIGV4cGVjdChuZXdSZWZyZXNoKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKGluaXRpYWxSZWZyZXNoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaW5kaWNhdGUgd2hlbiByZWZyZXNoIGlzIG5lZWRlZCcsICgpID0+IHtcbiAgICAgIC8vIE1hcmsgYXMgcmVmcmVzaGVkIGxvbmcgYWdvXG4gICAgICBidWNrZXRbJ2xhc3RSZWZyZXNoZWQnXSA9IERhdGUubm93KCkgLSA3MjAwMDAwOyAvLyAyIGhvdXJzIGFnb1xuICAgICAgXG4gICAgICBleHBlY3QoYnVja2V0Lm5lZWRzUmVmcmVzaCgzNjAwMDAwKSkudG9CZSh0cnVlKTsgLy8gMSBob3VyIGludGVydmFsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdTdGF0aXN0aWNzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNvcnJlY3Qgc3RhdHMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBjb250YWN0ID0gY3JlYXRlQ29udGFjdCgpO1xuICAgICAgYnVja2V0LmFkZENvbnRhY3QoY29udGFjdCk7XG5cbiAgICAgIGNvbnN0IHN0YXRzID0gYnVja2V0LmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMuY29udGFjdHMpLnRvQmUoMSk7XG4gICAgICBleHBlY3Qoc3RhdHMucmVwbGFjZW1lbnRDYWNoZSkudG9CZSgwKTtcbiAgICAgIGV4cGVjdChzdGF0cy5hdmdGYWlsdXJlcykudG9CZSgwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ0tCdWNrZXRNYW5hZ2VyJywgKCkgPT4ge1xuICBsZXQgbWFuYWdlcjogS0J1Y2tldE1hbmFnZXI7XG4gIGxldCBsb2NhbE5vZGVJZDogVWludDhBcnJheTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBsb2NhbE5vZGVJZCA9IGdlbmVyYXRlTm9kZUlkKCk7XG4gICAgbWFuYWdlciA9IG5ldyBLQnVja2V0TWFuYWdlcihsb2NhbE5vZGVJZCwgeyBrOiAyMCB9KTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBjcmVhdGUgMTYwIGJ1Y2tldHMnLCAoKSA9PiB7XG4gICAgY29uc3QgYnVja2V0cyA9IG1hbmFnZXIuZ2V0QWxsQnVja2V0cygpO1xuICAgIGV4cGVjdChidWNrZXRzLmxlbmd0aCkudG9CZSgxNjApO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGdldCBidWNrZXQgYnkgaW5kZXgnLCAoKSA9PiB7XG4gICAgY29uc3QgYnVja2V0ID0gbWFuYWdlci5nZXRCdWNrZXQoMCk7XG4gICAgZXhwZWN0KGJ1Y2tldCkudG9CZURlZmluZWQoKTtcbiAgICBleHBlY3QoYnVja2V0IS5pbmRleCkudG9CZSgwKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXR1cm4gdW5kZWZpbmVkIGZvciBpbnZhbGlkIGluZGV4JywgKCkgPT4ge1xuICAgIGV4cGVjdChtYW5hZ2VyLmdldEJ1Y2tldCgtMSkpLnRvQmVVbmRlZmluZWQoKTtcbiAgICBleHBlY3QobWFuYWdlci5nZXRCdWNrZXQoMTYwKSkudG9CZVVuZGVmaW5lZCgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHRyYWNrIHRvdGFsIGNvbnRhY3RzJywgKCkgPT4ge1xuICAgIGV4cGVjdChtYW5hZ2VyLmdldFRvdGFsQ29udGFjdHMoKSkudG9CZSgwKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCB0cmFjayBhY3RpdmUgYnVja2V0IGNvdW50JywgKCkgPT4ge1xuICAgIGV4cGVjdChtYW5hZ2VyLmdldEFjdGl2ZUJ1Y2tldENvdW50KCkpLnRvQmUoMCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIHN0YXRzJywgKCkgPT4ge1xuICAgIGNvbnN0IHN0YXRzID0gbWFuYWdlci5nZXRTdGF0cygpO1xuICAgIGV4cGVjdChzdGF0cy50b3RhbENvbnRhY3RzKS50b0JlKDApO1xuICAgIGV4cGVjdChzdGF0cy5hY3RpdmVCdWNrZXRzKS50b0JlKDApO1xuICAgIGV4cGVjdChzdGF0cy5idWNrZXREaXN0cmlidXRpb24ubGVuZ3RoKS50b0JlKDE2MCk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=