65e628901b68c0f4d4c364f5115706bb
"use strict";
/**
 * Tests for SharePayloadGenerator
 */
Object.defineProperty(exports, "__esModule", { value: true });
const SharePayload_1 = require("./SharePayload");
const InviteManager_1 = require("./InviteManager");
const primitives_1 = require("../crypto/primitives");
describe('SharePayloadGenerator', () => {
    let generator;
    let inviteManager;
    let identity;
    beforeEach(() => {
        generator = new SharePayload_1.SharePayloadGenerator();
        identity = (0, primitives_1.generateIdentity)();
        inviteManager = new InviteManager_1.InviteManager('test-peer-id', identity.publicKey, identity.privateKey, 'Test User');
    });
    describe('Payload Creation', () => {
        it('should create a valid payload from an invite', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            expect(payload.version).toBe('0.1.0');
            expect(payload.inviteCode).toBe(invite.code);
            expect(payload.inviterPeerId).toBe(invite.inviterPeerId);
            expect(payload.signature).toEqual(invite.signature);
            expect(payload.bootstrapPeers).toEqual(invite.bootstrapPeers);
            expect(payload.timestamp).toBeDefined();
            expect(payload.timestamp).toBeGreaterThan(0);
        });
        it('should include current timestamp', async () => {
            const invite = await inviteManager.createInvite();
            const beforeTime = Date.now();
            const payload = await generator.createPayload(invite);
            const afterTime = Date.now();
            expect(payload.timestamp).toBeGreaterThanOrEqual(beforeTime);
            expect(payload.timestamp).toBeLessThanOrEqual(afterTime);
        });
    });
    describe('Payload Verification', () => {
        it('should verify a valid payload', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            const result = await generator.verifyPayload(payload);
            expect(result.valid).toBe(true);
            expect(result.error).toBeUndefined();
        });
        it('should reject incompatible version', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            payload.version = '99.0.0'; // Future incompatible version
            const result = await generator.verifyPayload(payload);
            expect(result.valid).toBe(false);
            expect(result.error).toBe('Incompatible version');
        });
        it('should accept compatible versions with same major', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            payload.version = '0.2.5'; // Same major version
            const result = await generator.verifyPayload(payload);
            expect(result.valid).toBe(true);
        });
        it('should reject old timestamps', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            payload.timestamp = Date.now() - (10 * 60 * 1000); // 10 minutes ago
            const result = await generator.verifyPayload(payload);
            expect(result.valid).toBe(false);
            expect(result.error).toBe('Payload timestamp too old or from future');
        });
        it('should reject future timestamps', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            payload.timestamp = Date.now() + (10 * 60 * 1000); // 10 minutes in future
            const result = await generator.verifyPayload(payload);
            expect(result.valid).toBe(false);
            expect(result.error).toBe('Payload timestamp too old or from future');
        });
        it('should accept recent timestamps', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            payload.timestamp = Date.now() - (2 * 60 * 1000); // 2 minutes ago
            const result = await generator.verifyPayload(payload);
            expect(result.valid).toBe(true);
        });
        it('should reject invalid signature format', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            payload.signature = new Uint8Array(32); // Wrong size
            const result = await generator.verifyPayload(payload);
            expect(result.valid).toBe(false);
            expect(result.error).toBe('Invalid signature format');
        });
        it('should reject invalid bootstrap peers format', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            payload.bootstrapPeers = 'not-an-array';
            const result = await generator.verifyPayload(payload);
            expect(result.valid).toBe(false);
            expect(result.error).toBe('Invalid bootstrap peers format');
        });
    });
    describe('Payload Serialization', () => {
        it('should serialize and deserialize payload correctly', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            const serialized = generator.serializePayload(payload);
            const deserialized = generator.deserializePayload(serialized);
            expect(deserialized).not.toBeNull();
            expect(deserialized?.version).toBe(payload.version);
            expect(deserialized?.inviteCode).toBe(payload.inviteCode);
            expect(deserialized?.inviterPeerId).toBe(payload.inviterPeerId);
            expect(deserialized?.signature).toEqual(payload.signature);
            expect(deserialized?.bootstrapPeers).toEqual(payload.bootstrapPeers);
            expect(deserialized?.timestamp).toBe(payload.timestamp);
        });
        it('should handle serialization with bootstrap peers', async () => {
            const invite = await inviteManager.createInvite();
            // Manually add bootstrap peers for testing
            invite.bootstrapPeers = ['peer1', 'peer2', 'peer3'];
            const payload = await generator.createPayload(invite);
            const serialized = generator.serializePayload(payload);
            const deserialized = generator.deserializePayload(serialized);
            expect(deserialized?.bootstrapPeers).toEqual(['peer1', 'peer2', 'peer3']);
        });
        it('should return null for invalid JSON', () => {
            const result = generator.deserializePayload('invalid json{');
            expect(result).toBeNull();
        });
        it('should return null for empty string', () => {
            const result = generator.deserializePayload('');
            expect(result).toBeNull();
        });
        it('should handle complex metadata in serialization', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            const serialized = generator.serializePayload(payload);
            expect(serialized).toBeTruthy();
            expect(typeof serialized).toBe('string');
        });
    });
    describe('Edge Cases', () => {
        it('should handle payload with empty bootstrap peers', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            const result = await generator.verifyPayload(payload);
            expect(result.valid).toBe(true);
        });
        it('should serialize compact format', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            const serialized = generator.serializePayload(payload);
            const parsed = JSON.parse(serialized);
            // Check compact keys are used
            expect(parsed.v).toBeDefined();
            expect(parsed.c).toBeDefined();
            expect(parsed.p).toBeDefined();
            expect(parsed.s).toBeDefined();
            expect(parsed.b).toBeDefined();
            expect(parsed.t).toBeDefined();
        });
        it('should preserve signature bytes through serialization', async () => {
            const invite = await inviteManager.createInvite();
            const payload = await generator.createPayload(invite);
            const serialized = generator.serializePayload(payload);
            const deserialized = generator.deserializePayload(serialized);
            expect(deserialized?.signature).toEqual(payload.signature);
            expect(Array.from(deserialized.signature)).toEqual(Array.from(payload.signature));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvc2hhcmluZy9TaGFyZVBheWxvYWQudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsaURBQXVEO0FBQ3ZELG1EQUFnRDtBQUNoRCxxREFBd0Q7QUFFeEQsUUFBUSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtJQUNyQyxJQUFJLFNBQWdDLENBQUM7SUFDckMsSUFBSSxhQUE0QixDQUFDO0lBQ2pDLElBQUksUUFBNkMsQ0FBQztJQUVsRCxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsU0FBUyxHQUFHLElBQUksb0NBQXFCLEVBQUUsQ0FBQztRQUN4QyxRQUFRLEdBQUcsSUFBQSw2QkFBZ0IsR0FBRSxDQUFDO1FBQzlCLGFBQWEsR0FBRyxJQUFJLDZCQUFhLENBQy9CLGNBQWMsRUFDZCxRQUFRLENBQUMsU0FBUyxFQUNsQixRQUFRLENBQUMsVUFBVSxFQUNuQixXQUFXLENBQ1osQ0FBQztJQUNKLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtRQUNoQyxFQUFFLENBQUMsOENBQThDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDNUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxhQUFhLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDbEQsTUFBTSxPQUFPLEdBQUcsTUFBTSxTQUFTLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXRELE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3RDLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3QyxNQUFNLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7WUFD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QU0sQ0FBQyxDQUFDO1lBRXRELE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN2RCxNQUFNLFlBQVksR0FBRyxTQUFTLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLENBQUM7WUFFOUQsTUFBTSxDQUFDLFlBQVksRUFBRSxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzNELE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvY2hyaXN0eW1heHdlbGwvRGVza3RvcC9MdWtlX1N0dWZmL0dpdEh1Yi9TQy9jb3JlL3NyYy9zaGFyaW5nL1NoYXJlUGF5bG9hZC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGVzdHMgZm9yIFNoYXJlUGF5bG9hZEdlbmVyYXRvclxuICovXG5cbmltcG9ydCB7IFNoYXJlUGF5bG9hZEdlbmVyYXRvciB9IGZyb20gJy4vU2hhcmVQYXlsb2FkJztcbmltcG9ydCB7IEludml0ZU1hbmFnZXIgfSBmcm9tICcuL0ludml0ZU1hbmFnZXInO1xuaW1wb3J0IHsgZ2VuZXJhdGVJZGVudGl0eSB9IGZyb20gJy4uL2NyeXB0by9wcmltaXRpdmVzJztcblxuZGVzY3JpYmUoJ1NoYXJlUGF5bG9hZEdlbmVyYXRvcicsICgpID0+IHtcbiAgbGV0IGdlbmVyYXRvcjogU2hhcmVQYXlsb2FkR2VuZXJhdG9yO1xuICBsZXQgaW52aXRlTWFuYWdlcjogSW52aXRlTWFuYWdlcjtcbiAgbGV0IGlkZW50aXR5OiBSZXR1cm5UeXBlPHR5cGVvZiBnZW5lcmF0ZUlkZW50aXR5PjtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBnZW5lcmF0b3IgPSBuZXcgU2hhcmVQYXlsb2FkR2VuZXJhdG9yKCk7XG4gICAgaWRlbnRpdHkgPSBnZW5lcmF0ZUlkZW50aXR5KCk7XG4gICAgaW52aXRlTWFuYWdlciA9IG5ldyBJbnZpdGVNYW5hZ2VyKFxuICAgICAgJ3Rlc3QtcGVlci1pZCcsXG4gICAgICBpZGVudGl0eS5wdWJsaWNLZXksXG4gICAgICBpZGVudGl0eS5wcml2YXRlS2V5LFxuICAgICAgJ1Rlc3QgVXNlcidcbiAgICApO1xuICB9KTtcblxuICBkZXNjcmliZSgnUGF5bG9hZCBDcmVhdGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBhIHZhbGlkIHBheWxvYWQgZnJvbSBhbiBpbnZpdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IGdlbmVyYXRvci5jcmVhdGVQYXlsb2FkKGludml0ZSk7XG5cbiAgICAgIGV4cGVjdChwYXlsb2FkLnZlcnNpb24pLnRvQmUoJzAuMS4wJyk7XG4gICAgICBleHBlY3QocGF5bG9hZC5pbnZpdGVDb2RlKS50b0JlKGludml0ZS5jb2RlKTtcbiAgICAgIGV4cGVjdChwYXlsb2FkLmludml0ZXJQZWVySWQpLnRvQmUoaW52aXRlLmludml0ZXJQZWVySWQpO1xuICAgICAgZXhwZWN0KHBheWxvYWQuc2lnbmF0dXJlKS50b0VxdWFsKGludml0ZS5zaWduYXR1cmUpO1xuICAgICAgZXhwZWN0KHBheWxvYWQuYm9vdHN0cmFwUGVlcnMpLnRvRXF1YWwoaW52aXRlLmJvb3RzdHJhcFBlZXJzKTtcbiAgICAgIGV4cGVjdChwYXlsb2FkLnRpbWVzdGFtcCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChwYXlsb2FkLnRpbWVzdGFtcCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBpbmNsdWRlIGN1cnJlbnQgdGltZXN0YW1wJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGNvbnN0IGJlZm9yZVRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IGdlbmVyYXRvci5jcmVhdGVQYXlsb2FkKGludml0ZSk7XG4gICAgICBjb25zdCBhZnRlclRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgICBleHBlY3QocGF5bG9hZC50aW1lc3RhbXApLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoYmVmb3JlVGltZSk7XG4gICAgICBleHBlY3QocGF5bG9hZC50aW1lc3RhbXApLnRvQmVMZXNzVGhhbk9yRXF1YWwoYWZ0ZXJUaW1lKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1BheWxvYWQgVmVyaWZpY2F0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdmVyaWZ5IGEgdmFsaWQgcGF5bG9hZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZ2VuZXJhdG9yLmNyZWF0ZVBheWxvYWQoaW52aXRlKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdlbmVyYXRvci52ZXJpZnlQYXlsb2FkKHBheWxvYWQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnZhbGlkKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcikudG9CZVVuZGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgaW5jb21wYXRpYmxlIHZlcnNpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IGdlbmVyYXRvci5jcmVhdGVQYXlsb2FkKGludml0ZSk7XG4gICAgICBwYXlsb2FkLnZlcnNpb24gPSAnOTkuMC4wJzsgLy8gRnV0dXJlIGluY29tcGF0aWJsZSB2ZXJzaW9uXG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdlbmVyYXRvci52ZXJpZnlQYXlsb2FkKHBheWxvYWQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnZhbGlkKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLnRvQmUoJ0luY29tcGF0aWJsZSB2ZXJzaW9uJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGFjY2VwdCBjb21wYXRpYmxlIHZlcnNpb25zIHdpdGggc2FtZSBtYWpvcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZ2VuZXJhdG9yLmNyZWF0ZVBheWxvYWQoaW52aXRlKTtcbiAgICAgIHBheWxvYWQudmVyc2lvbiA9ICcwLjIuNSc7IC8vIFNhbWUgbWFqb3IgdmVyc2lvblxuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZW5lcmF0b3IudmVyaWZ5UGF5bG9hZChwYXlsb2FkKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC52YWxpZCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVqZWN0IG9sZCB0aW1lc3RhbXBzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCBnZW5lcmF0b3IuY3JlYXRlUGF5bG9hZChpbnZpdGUpO1xuICAgICAgcGF5bG9hZC50aW1lc3RhbXAgPSBEYXRlLm5vdygpIC0gKDEwICogNjAgKiAxMDAwKTsgLy8gMTAgbWludXRlcyBhZ29cblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2VuZXJhdG9yLnZlcmlmeVBheWxvYWQocGF5bG9hZCk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQudmFsaWQpLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcikudG9CZSgnUGF5bG9hZCB0aW1lc3RhbXAgdG9vIG9sZCBvciBmcm9tIGZ1dHVyZScpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgZnV0dXJlIHRpbWVzdGFtcHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IGdlbmVyYXRvci5jcmVhdGVQYXlsb2FkKGludml0ZSk7XG4gICAgICBwYXlsb2FkLnRpbWVzdGFtcCA9IERhdGUubm93KCkgKyAoMTAgKiA2MCAqIDEwMDApOyAvLyAxMCBtaW51dGVzIGluIGZ1dHVyZVxuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZW5lcmF0b3IudmVyaWZ5UGF5bG9hZChwYXlsb2FkKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC52YWxpZCkudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0JlKCdQYXlsb2FkIHRpbWVzdGFtcCB0b28gb2xkIG9yIGZyb20gZnV0dXJlJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGFjY2VwdCByZWNlbnQgdGltZXN0YW1wcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZ2VuZXJhdG9yLmNyZWF0ZVBheWxvYWQoaW52aXRlKTtcbiAgICAgIHBheWxvYWQudGltZXN0YW1wID0gRGF0ZS5ub3coKSAtICgyICogNjAgKiAxMDAwKTsgLy8gMiBtaW51dGVzIGFnb1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZW5lcmF0b3IudmVyaWZ5UGF5bG9hZChwYXlsb2FkKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC52YWxpZCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVqZWN0IGludmFsaWQgc2lnbmF0dXJlIGZvcm1hdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZ2VuZXJhdG9yLmNyZWF0ZVBheWxvYWQoaW52aXRlKTtcbiAgICAgIHBheWxvYWQuc2lnbmF0dXJlID0gbmV3IFVpbnQ4QXJyYXkoMzIpOyAvLyBXcm9uZyBzaXplXG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdlbmVyYXRvci52ZXJpZnlQYXlsb2FkKHBheWxvYWQpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnZhbGlkKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLnRvQmUoJ0ludmFsaWQgc2lnbmF0dXJlIGZvcm1hdCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgaW52YWxpZCBib290c3RyYXAgcGVlcnMgZm9ybWF0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCBnZW5lcmF0b3IuY3JlYXRlUGF5bG9hZChpbnZpdGUpO1xuICAgICAgKHBheWxvYWQgYXMgYW55KS5ib290c3RyYXBQZWVycyA9ICdub3QtYW4tYXJyYXknO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZW5lcmF0b3IudmVyaWZ5UGF5bG9hZChwYXlsb2FkKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC52YWxpZCkudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0JlKCdJbnZhbGlkIGJvb3RzdHJhcCBwZWVycyBmb3JtYXQnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1BheWxvYWQgU2VyaWFsaXphdGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHNlcmlhbGl6ZSBhbmQgZGVzZXJpYWxpemUgcGF5bG9hZCBjb3JyZWN0bHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IGdlbmVyYXRvci5jcmVhdGVQYXlsb2FkKGludml0ZSk7XG4gICAgICBcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSBnZW5lcmF0b3Iuc2VyaWFsaXplUGF5bG9hZChwYXlsb2FkKTtcbiAgICAgIGNvbnN0IGRlc2VyaWFsaXplZCA9IGdlbmVyYXRvci5kZXNlcmlhbGl6ZVBheWxvYWQoc2VyaWFsaXplZCk7XG5cbiAgICAgIGV4cGVjdChkZXNlcmlhbGl6ZWQpLm5vdC50b0JlTnVsbCgpO1xuICAgICAgZXhwZWN0KGRlc2VyaWFsaXplZD8udmVyc2lvbikudG9CZShwYXlsb2FkLnZlcnNpb24pO1xuICAgICAgZXhwZWN0KGRlc2VyaWFsaXplZD8uaW52aXRlQ29kZSkudG9CZShwYXlsb2FkLmludml0ZUNvZGUpO1xuICAgICAgZXhwZWN0KGRlc2VyaWFsaXplZD8uaW52aXRlclBlZXJJZCkudG9CZShwYXlsb2FkLmludml0ZXJQZWVySWQpO1xuICAgICAgZXhwZWN0KGRlc2VyaWFsaXplZD8uc2lnbmF0dXJlKS50b0VxdWFsKHBheWxvYWQuc2lnbmF0dXJlKTtcbiAgICAgIGV4cGVjdChkZXNlcmlhbGl6ZWQ/LmJvb3RzdHJhcFBlZXJzKS50b0VxdWFsKHBheWxvYWQuYm9vdHN0cmFwUGVlcnMpO1xuICAgICAgZXhwZWN0KGRlc2VyaWFsaXplZD8udGltZXN0YW1wKS50b0JlKHBheWxvYWQudGltZXN0YW1wKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHNlcmlhbGl6YXRpb24gd2l0aCBib290c3RyYXAgcGVlcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgLy8gTWFudWFsbHkgYWRkIGJvb3RzdHJhcCBwZWVycyBmb3IgdGVzdGluZ1xuICAgICAgaW52aXRlLmJvb3RzdHJhcFBlZXJzID0gWydwZWVyMScsICdwZWVyMicsICdwZWVyMyddO1xuICAgICAgXG4gICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZ2VuZXJhdG9yLmNyZWF0ZVBheWxvYWQoaW52aXRlKTtcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSBnZW5lcmF0b3Iuc2VyaWFsaXplUGF5bG9hZChwYXlsb2FkKTtcbiAgICAgIGNvbnN0IGRlc2VyaWFsaXplZCA9IGdlbmVyYXRvci5kZXNlcmlhbGl6ZVBheWxvYWQoc2VyaWFsaXplZCk7XG5cbiAgICAgIGV4cGVjdChkZXNlcmlhbGl6ZWQ/LmJvb3RzdHJhcFBlZXJzKS50b0VxdWFsKFsncGVlcjEnLCAncGVlcjInLCAncGVlcjMnXSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIGZvciBpbnZhbGlkIEpTT04nLCAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBnZW5lcmF0b3IuZGVzZXJpYWxpemVQYXlsb2FkKCdpbnZhbGlkIGpzb257Jyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCBmb3IgZW1wdHkgc3RyaW5nJywgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gZ2VuZXJhdG9yLmRlc2VyaWFsaXplUGF5bG9hZCgnJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlTnVsbCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgY29tcGxleCBtZXRhZGF0YSBpbiBzZXJpYWxpemF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCBnZW5lcmF0b3IuY3JlYXRlUGF5bG9hZChpbnZpdGUpO1xuICAgICAgXG4gICAgICBjb25zdCBzZXJpYWxpemVkID0gZ2VuZXJhdG9yLnNlcmlhbGl6ZVBheWxvYWQocGF5bG9hZCk7XG4gICAgICBleHBlY3Qoc2VyaWFsaXplZCkudG9CZVRydXRoeSgpO1xuICAgICAgZXhwZWN0KHR5cGVvZiBzZXJpYWxpemVkKS50b0JlKCdzdHJpbmcnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0VkZ2UgQ2FzZXMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgcGF5bG9hZCB3aXRoIGVtcHR5IGJvb3RzdHJhcCBwZWVycycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZ2VuZXJhdG9yLmNyZWF0ZVBheWxvYWQoaW52aXRlKTtcbiAgICAgIFxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2VuZXJhdG9yLnZlcmlmeVBheWxvYWQocGF5bG9hZCk7XG4gICAgICBleHBlY3QocmVzdWx0LnZhbGlkKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzZXJpYWxpemUgY29tcGFjdCBmb3JtYXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IGdlbmVyYXRvci5jcmVhdGVQYXlsb2FkKGludml0ZSk7XG4gICAgICBcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSBnZW5lcmF0b3Iuc2VyaWFsaXplUGF5bG9hZChwYXlsb2FkKTtcbiAgICAgIGNvbnN0IHBhcnNlZCA9IEpTT04ucGFyc2Uoc2VyaWFsaXplZCk7XG5cbiAgICAgIC8vIENoZWNrIGNvbXBhY3Qga2V5cyBhcmUgdXNlZFxuICAgICAgZXhwZWN0KHBhcnNlZC52KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHBhcnNlZC5jKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHBhcnNlZC5wKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHBhcnNlZC5zKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHBhcnNlZC5iKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHBhcnNlZC50KS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwcmVzZXJ2ZSBzaWduYXR1cmUgYnl0ZXMgdGhyb3VnaCBzZXJpYWxpemF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCBnZW5lcmF0b3IuY3JlYXRlUGF5bG9hZChpbnZpdGUpO1xuICAgICAgXG4gICAgICBjb25zdCBzZXJpYWxpemVkID0gZ2VuZXJhdG9yLnNlcmlhbGl6ZVBheWxvYWQocGF5bG9hZCk7XG4gICAgICBjb25zdCBkZXNlcmlhbGl6ZWQgPSBnZW5lcmF0b3IuZGVzZXJpYWxpemVQYXlsb2FkKHNlcmlhbGl6ZWQpO1xuXG4gICAgICBleHBlY3QoZGVzZXJpYWxpemVkPy5zaWduYXR1cmUpLnRvRXF1YWwocGF5bG9hZC5zaWduYXR1cmUpO1xuICAgICAgZXhwZWN0KEFycmF5LmZyb20oZGVzZXJpYWxpemVkIS5zaWduYXR1cmUpKS50b0VxdWFsKEFycmF5LmZyb20ocGF5bG9hZC5zaWduYXR1cmUpKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==