4af73b2cdcc964953ce0d43d96e06c0d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("./index");
const ed25519_js_1 = require("@noble/curves/ed25519.js");
const primitives_1 = require("./primitives");
describe("CryptoManager", () => {
    let cryptoManager;
    beforeEach(() => {
        cryptoManager = new index_1.CryptoManager();
    });
    describe("generateKey", () => {
        it("should generate a 32-byte key", () => {
            const key = cryptoManager.generateKey();
            expect(key).toHaveLength(32);
            expect(key).toBeInstanceOf(Uint8Array);
        });
        it("should generate unique keys each time", () => {
            const key1 = cryptoManager.generateKey();
            const key2 = cryptoManager.generateKey();
            expect((0, primitives_1.timingSafeEqual)(key1, key2)).toBe(false);
        });
    });
    describe("encrypt/decrypt", () => {
        it("should encrypt and decrypt a string message", () => {
            const key = cryptoManager.generateKey();
            const message = "Hello, World!";
            const encrypted = cryptoManager.encrypt(message, key);
            const decrypted = cryptoManager.decrypt(encrypted, key);
            expect(decrypted).toBe(message);
        });
        it("should encrypt and decrypt a Uint8Array message", () => {
            const key = cryptoManager.generateKey();
            const message = new TextEncoder().encode("Binary data test");
            const encrypted = cryptoManager.encrypt(message, key);
            const decrypted = cryptoManager.decrypt(encrypted, key);
            expect(decrypted).toBe("Binary data test");
        });
        it("should produce different ciphertext each time (due to random nonce)", () => {
            const key = cryptoManager.generateKey();
            const message = "Same message";
            const encrypted1 = cryptoManager.encrypt(message, key);
            const encrypted2 = cryptoManager.encrypt(message, key);
            // Ciphertexts should be different due to different nonces
            expect((0, primitives_1.timingSafeEqual)(encrypted1, encrypted2)).toBe(false);
        });
        it("should throw error when decrypting data that is too short", () => {
            const key = cryptoManager.generateKey();
            const tooShort = new Uint8Array(20);
            expect(() => cryptoManager.decrypt(tooShort, key)).toThrow("Encrypted data too short");
        });
    });
    describe("decryptBytes", () => {
        it("should decrypt to Uint8Array", () => {
            const key = cryptoManager.generateKey();
            const originalData = new Uint8Array([1, 2, 3, 4, 5]);
            const encrypted = cryptoManager.encrypt(originalData, key);
            const decrypted = cryptoManager.decryptBytes(encrypted, key);
            expect(decrypted).toEqual(originalData);
            expect(decrypted).toBeInstanceOf(Uint8Array);
        });
        it("should throw error when decrypting data that is too short", () => {
            const key = cryptoManager.generateKey();
            const tooShort = new Uint8Array(20);
            expect(() => cryptoManager.decryptBytes(tooShort, key)).toThrow("Encrypted data too short");
        });
    });
    describe("sign/verify", () => {
        it("should sign and verify a string message", () => {
            const keyManager = new index_1.KeyManager();
            keyManager.generateIdentityKeyPair();
            const message = "Message to sign";
            const signature = cryptoManager.sign(message, keyManager.getPrivateKey());
            const isValid = cryptoManager.verify(message, signature, keyManager.getPublicKey());
            expect(signature).toHaveLength(64);
            expect(isValid).toBe(true);
        });
        it("should sign and verify a Uint8Array message", () => {
            const keyManager = new index_1.KeyManager();
            keyManager.generateIdentityKeyPair();
            const message = new Uint8Array([1, 2, 3, 4, 5]);
            const signature = cryptoManager.sign(message, keyManager.getPrivateKey());
            const isValid = cryptoManager.verify(message, signature, keyManager.getPublicKey());
            expect(isValid).toBe(true);
        });
        it("should reject invalid signature", () => {
            const keyManager = new index_1.KeyManager();
            keyManager.generateIdentityKeyPair();
            const message = "Original message";
            const signature = cryptoManager.sign(message, keyManager.getPrivateKey());
            const isValid = cryptoManager.verify("Tampered message", signature, keyManager.getPublicKey());
            expect(isValid).toBe(false);
        });
    });
    describe("deriveSecret", () => {
        it("should derive shared secret between two parties", () => {
            // Use identity keys for high-level secret derivation
            const keypair1 = (0, index_1.generateIdentity)();
            const keypair2 = (0, index_1.generateIdentity)();
            const secret1 = cryptoManager.deriveSecret(keypair1.privateKey, keypair2.publicKey);
            const secret2 = cryptoManager.deriveSecret(keypair2.privateKey, keypair1.publicKey);
            expect(secret1).toHaveLength(32);
            if (!(0, primitives_1.timingSafeEqual)(secret1, secret2)) {
                // eslint-disable-next-line no-console
                console.error("[TEST-DEBUG] CryptoManager deriveSecret mismatch:");
                // eslint-disable-next-line no-console
                console.error("secret1=", Buffer.from(secret1).toString("hex"));
                // eslint-disable-next-line no-console
                console.error("secret2=", Buffer.from(secret2).toString("hex"));
            }
            expect((0, primitives_1.timingSafeEqual)(secret1, secret2)).toBe(true);
        });
        it("should maintain key path consistency", () => {
            const priv = ed25519_js_1.ed25519.utils.randomSecretKey();
            const pub = ed25519_js_1.ed25519.getPublicKey(priv);
            const mont = ed25519_js_1.ed25519.utils.toMontgomery(pub);
            const xPriv = ed25519_js_1.ed25519.utils.toMontgomerySecret(priv);
            const xPubFromPriv = ed25519_js_1.x25519.getPublicKey(xPriv);
            if (Buffer.from(mont).toString("hex") !==
                Buffer.from(xPubFromPriv).toString("hex")) {
                console.error("[CONSISTENCY-TEST] Mismatch!");
                console.error("mont        :", Buffer.from(mont).toString("hex"));
                console.error("xPubFromPriv:", Buffer.from(xPubFromPriv).toString("hex"));
                throw new Error("Key path inconsistency in Jest environment");
            }
        });
        it("should perform correct ECDH", () => {
            const privA = ed25519_js_1.ed25519.utils.randomSecretKey();
            const pubA = ed25519_js_1.ed25519.getPublicKey(privA);
            const privB = ed25519_js_1.ed25519.utils.randomSecretKey();
            const pubB = ed25519_js_1.ed25519.getPublicKey(privB);
            const uA = ed25519_js_1.ed25519.utils.toMontgomery(pubA);
            const uB = ed25519_js_1.ed25519.utils.toMontgomery(pubB);
            const xPrivA = ed25519_js_1.ed25519.utils.toMontgomerySecret(privA);
            const xPrivB = ed25519_js_1.ed25519.utils.toMontgomerySecret(privB);
            const s1 = ed25519_js_1.x25519.getSharedSecret(xPrivA, uB);
            const s2 = ed25519_js_1.x25519.getSharedSecret(xPrivB, uA);
            if (Buffer.from(s1).toString("hex") !== Buffer.from(s2).toString("hex")) {
                console.error("[ECDH-TEST] Mismatch!");
                console.error("s1:", Buffer.from(s1).toString("hex"));
                console.error("s2:", Buffer.from(s2).toString("hex"));
                throw new Error("ECDH mismatch in Jest environment");
            }
        });
    });
});
describe("KeyManager", () => {
    let keyManager;
    beforeEach(() => {
        keyManager = new index_1.KeyManager();
    });
    describe("generateIdentityKeyPair", () => {
        it("should generate a keypair", () => {
            expect(keyManager.hasKeypair()).toBe(false);
            keyManager.generateIdentityKeyPair();
            expect(keyManager.hasKeypair()).toBe(true);
        });
    });
    describe("getPublicKey", () => {
        it("should throw if keypair not generated", () => {
            expect(() => keyManager.getPublicKey()).toThrow("Keypair not generated");
        });
        it("should return 32-byte public key", () => {
            keyManager.generateIdentityKeyPair();
            const publicKey = keyManager.getPublicKey();
            expect(publicKey).toHaveLength(32);
            expect(publicKey).toBeInstanceOf(Uint8Array);
        });
        it("should return a copy of the public key", () => {
            keyManager.generateIdentityKeyPair();
            const publicKey1 = keyManager.getPublicKey();
            const publicKey2 = keyManager.getPublicKey();
            // Should be equal in value
            expect((0, primitives_1.timingSafeEqual)(publicKey1, publicKey2)).toBe(true);
            // But should be different objects (copies)
            expect(publicKey1).not.toBe(publicKey2);
            // Modifying one should not affect the other
            publicKey1[0] = publicKey1[0] ^ 0xff;
            expect((0, primitives_1.timingSafeEqual)(publicKey1, publicKey2)).toBe(false);
        });
    });
    describe("getPrivateKey", () => {
        it("should throw if keypair not generated", () => {
            expect(() => keyManager.getPrivateKey()).toThrow("Keypair not generated");
        });
        it("should return 32-byte private key", () => {
            keyManager.generateIdentityKeyPair();
            const privateKey = keyManager.getPrivateKey();
            expect(privateKey).toHaveLength(32);
            expect(privateKey).toBeInstanceOf(Uint8Array);
        });
        it("should return a copy of the private key", () => {
            keyManager.generateIdentityKeyPair();
            const privateKey1 = keyManager.getPrivateKey();
            const privateKey2 = keyManager.getPrivateKey();
            // Should be equal in value
            expect((0, primitives_1.timingSafeEqual)(privateKey1, privateKey2)).toBe(true);
            // But should be different objects (copies)
            expect(privateKey1).not.toBe(privateKey2);
            // Modifying one should not affect the other
            privateKey1[0] = privateKey1[0] ^ 0xff;
            expect((0, primitives_1.timingSafeEqual)(privateKey1, privateKey2)).toBe(false);
        });
    });
    describe("hasKeypair", () => {
        it("should return false before generation", () => {
            expect(keyManager.hasKeypair()).toBe(false);
        });
        it("should return true after generation", () => {
            keyManager.generateIdentityKeyPair();
            expect(keyManager.hasKeypair()).toBe(true);
        });
        it("should return false after clear", () => {
            keyManager.generateIdentityKeyPair();
            keyManager.clear();
            expect(keyManager.hasKeypair()).toBe(false);
        });
    });
    describe("clear", () => {
        it("should clear the keypair", () => {
            keyManager.generateIdentityKeyPair();
            expect(keyManager.hasKeypair()).toBe(true);
            keyManager.clear();
            expect(keyManager.hasKeypair()).toBe(false);
            expect(() => keyManager.getPublicKey()).toThrow();
            expect(() => keyManager.getPrivateKey()).toThrow();
        });
        it("should be safe to call multiple times", () => {
            keyManager.generateIdentityKeyPair();
            keyManager.clear();
            keyManager.clear(); // Should not throw
            expect(keyManager.hasKeypair()).toBe(false);
        });
        it("should be safe to call without generating keypair", () => {
            keyManager.clear(); // Should not throw
            expect(keyManager.hasKeypair()).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvY3J5cHRvL2luZGV4LnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFDQSxtQ0FPaUI7QUFDakIseURBQTJEO0FBQzNELDZDQUErQztBQUUvQyxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUM3QixJQUFJLGFBQTRCLENBQUM7SUFFakMsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLGFBQWEsR0FBRyxJQUFJLHFCQUFhLEVBQUUsQ0FBQztJQUN0QyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO1FBQzNCLEVBQUUsQ0FBQywrQkFBK0IsRUFBRSxHQUFHLEVBQUU7WUFDdkMsTUFBTSxHQUFHLEdBQUcsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3hDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDN0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx1Q0FBdUMsRUFBRSxHQUFHLEVBQUU7WUFDL0MsTUFBTSxJQUFJLEdBQUcsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3pDLE1BQU0sSUFBSSxHQUFHLGFBQWEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUN6QyxNQUFNLENBQUMsSUFBQSw0QkFBZSxFQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGlCQUFpQixFQUFFLEdBQUcsRUFBRTtRQUMvQixFQUFFLENBQUMsNkNBQTZDLEVBQUUsR0FBRyxFQUFFO1lBQ3JELE1BQU0sR0FBRyxHQUFHLGFBQWEsQ0FBQyxX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RyxFQUFFO1lBQzNELFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLG1CQUFtQjtZQUN2QyxNQUFNLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvY2hyaXN0eW1heHdlbGwvRGVza3RvcC9MdWtlX1N0dWZmL0dpdEh1Yi9TQy9jb3JlL3NyYy9jcnlwdG8vaW5kZXgudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBqZXN0IH0gZnJvbSBcIkBqZXN0L2dsb2JhbHNcIjtcbmltcG9ydCB7XG4gIENyeXB0b01hbmFnZXIsXG4gIEtleU1hbmFnZXIsXG4gIGdlbmVyYXRlS2V5LFxuICBnZW5lcmF0ZU5vbmNlLFxuICBnZW5lcmF0ZUVwaGVtZXJhbEtleVBhaXIsXG4gIGdlbmVyYXRlSWRlbnRpdHksXG59IGZyb20gXCIuL2luZGV4XCI7XG5pbXBvcnQgeyBlZDI1NTE5LCB4MjU1MTkgfSBmcm9tIFwiQG5vYmxlL2N1cnZlcy9lZDI1NTE5LmpzXCI7XG5pbXBvcnQgeyB0aW1pbmdTYWZlRXF1YWwgfSBmcm9tIFwiLi9wcmltaXRpdmVzXCI7XG5cbmRlc2NyaWJlKFwiQ3J5cHRvTWFuYWdlclwiLCAoKSA9PiB7XG4gIGxldCBjcnlwdG9NYW5hZ2VyOiBDcnlwdG9NYW5hZ2VyO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGNyeXB0b01hbmFnZXIgPSBuZXcgQ3J5cHRvTWFuYWdlcigpO1xuICB9KTtcblxuICBkZXNjcmliZShcImdlbmVyYXRlS2V5XCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCBnZW5lcmF0ZSBhIDMyLWJ5dGUga2V5XCIsICgpID0+IHtcbiAgICAgIGNvbnN0IGtleSA9IGNyeXB0b01hbmFnZXIuZ2VuZXJhdGVLZXkoKTtcbiAgICAgIGV4cGVjdChrZXkpLnRvSGF2ZUxlbmd0aCgzMik7XG4gICAgICBleHBlY3Qoa2V5KS50b0JlSW5zdGFuY2VPZihVaW50OEFycmF5KTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIGdlbmVyYXRlIHVuaXF1ZSBrZXlzIGVhY2ggdGltZVwiLCAoKSA9PiB7XG4gICAgICBjb25zdCBrZXkxID0gY3J5cHRvTWFuYWdlci5nZW5lcmF0ZUtleSgpO1xuICAgICAgY29uc3Qga2V5MiA9IGNyeXB0b01hbmFnZXIuZ2VuZXJhdGVLZXkoKTtcbiAgICAgIGV4cGVjdCh0aW1pbmdTYWZlRXF1YWwoa2V5MSwga2V5MikpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZShcImVuY3J5cHQvZGVjcnlwdFwiLCAoKSA9PiB7XG4gICAgaXQoXCJzaG91bGQgZW5jcnlwdCBhbmQgZGVjcnlwdCBhIHN0cmluZyBtZXNzYWdlXCIsICgpID0+IHtcbiAgICAgIGNvbnN0IGtleSA9IGNyeXB0b01hbmFnZXIuZ2VuZXJhdGVLZXkoKTtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBcIkhlbGxvLCBXb3JsZCFcIjtcblxuICAgICAgY29uc3QgZW5jcnlwdGVkID0gY3J5cHRvTWFuYWdlci5lbmNyeXB0KG1lc3NhZ2UsIGtleSk7XG4gICAgICBjb25zdCBkZWNyeXB0ZWQgPSBjcnlwdG9NYW5hZ2VyLmRlY3J5cHQoZW5jcnlwdGVkLCBrZXkpO1xuXG4gICAgICBleHBlY3QoZGVjcnlwdGVkKS50b0JlKG1lc3NhZ2UpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgZW5jcnlwdCBhbmQgZGVjcnlwdCBhIFVpbnQ4QXJyYXkgbWVzc2FnZVwiLCAoKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBjcnlwdG9NYW5hZ2VyLmdlbmVyYXRlS2V5KCk7XG4gICAgICBjb25zdCBtZXNzYWdlID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKFwiQmluYXJ5IGRhdGEgdGVzdFwiKTtcblxuICAgICAgY29uc3QgZW5jcnlwdGVkID0gY3J5cHRvTWFuYWdlci5lbmNyeXB0KG1lc3NhZ2UsIGtleSk7XG4gICAgICBjb25zdCBkZWNyeXB0ZWQgPSBjcnlwdG9NYW5hZ2VyLmRlY3J5cHQoZW5jcnlwdGVkLCBrZXkpO1xuXG4gICAgICBleHBlY3QoZGVjcnlwdGVkKS50b0JlKFwiQmluYXJ5IGRhdGEgdGVzdFwiKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIHByb2R1Y2UgZGlmZmVyZW50IGNpcGhlcnRleHQgZWFjaCB0aW1lIChkdWUgdG8gcmFuZG9tIG5vbmNlKVwiLCAoKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBjcnlwdG9NYW5hZ2VyLmdlbmVyYXRlS2V5KCk7XG4gICAgICBjb25zdCBtZXNzYWdlID0gXCJTYW1lIG1lc3NhZ2VcIjtcblxuICAgICAgY29uc3QgZW5jcnlwdGVkMSA9IGNyeXB0b01hbmFnZXIuZW5jcnlwdChtZXNzYWdlLCBrZXkpO1xuICAgICAgY29uc3QgZW5jcnlwdGVkMiA9IGNyeXB0b01hbmFnZXIuZW5jcnlwdChtZXNzYWdlLCBrZXkpO1xuXG4gICAgICAvLyBDaXBoZXJ0ZXh0cyBzaG91bGQgYmUgZGlmZmVyZW50IGR1ZSB0byBkaWZmZXJlbnQgbm9uY2VzXG4gICAgICBleHBlY3QodGltaW5nU2FmZUVxdWFsKGVuY3J5cHRlZDEsIGVuY3J5cHRlZDIpKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIHRocm93IGVycm9yIHdoZW4gZGVjcnlwdGluZyBkYXRhIHRoYXQgaXMgdG9vIHNob3J0XCIsICgpID0+IHtcbiAgICAgIGNvbnN0IGtleSA9IGNyeXB0b01hbmFnZXIuZ2VuZXJhdGVLZXkoKTtcbiAgICAgIGNvbnN0IHRvb1Nob3J0ID0gbmV3IFVpbnQ4QXJyYXkoMjApO1xuXG4gICAgICBleHBlY3QoKCkgPT4gY3J5cHRvTWFuYWdlci5kZWNyeXB0KHRvb1Nob3J0LCBrZXkpKS50b1Rocm93KFxuICAgICAgICBcIkVuY3J5cHRlZCBkYXRhIHRvbyBzaG9ydFwiLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoXCJkZWNyeXB0Qnl0ZXNcIiwgKCkgPT4ge1xuICAgIGl0KFwic2hvdWxkIGRlY3J5cHQgdG8gVWludDhBcnJheVwiLCAoKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBjcnlwdG9NYW5hZ2VyLmdlbmVyYXRlS2V5KCk7XG4gICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSBuZXcgVWludDhBcnJheShbMSwgMiwgMywgNCwgNV0pO1xuXG4gICAgICBjb25zdCBlbmNyeXB0ZWQgPSBjcnlwdG9NYW5hZ2VyLmVuY3J5cHQob3JpZ2luYWxEYXRhLCBrZXkpO1xuICAgICAgY29uc3QgZGVjcnlwdGVkID0gY3J5cHRvTWFuYWdlci5kZWNyeXB0Qnl0ZXMoZW5jcnlwdGVkLCBrZXkpO1xuXG4gICAgICBleHBlY3QoZGVjcnlwdGVkKS50b0VxdWFsKG9yaWdpbmFsRGF0YSk7XG4gICAgICBleHBlY3QoZGVjcnlwdGVkKS50b0JlSW5zdGFuY2VPZihVaW50OEFycmF5KTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIHRocm93IGVycm9yIHdoZW4gZGVjcnlwdGluZyBkYXRhIHRoYXQgaXMgdG9vIHNob3J0XCIsICgpID0+IHtcbiAgICAgIGNvbnN0IGtleSA9IGNyeXB0b01hbmFnZXIuZ2VuZXJhdGVLZXkoKTtcbiAgICAgIGNvbnN0IHRvb1Nob3J0ID0gbmV3IFVpbnQ4QXJyYXkoMjApO1xuXG4gICAgICBleHBlY3QoKCkgPT4gY3J5cHRvTWFuYWdlci5kZWNyeXB0Qnl0ZXModG9vU2hvcnQsIGtleSkpLnRvVGhyb3coXG4gICAgICAgIFwiRW5jcnlwdGVkIGRhdGEgdG9vIHNob3J0XCIsXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZShcInNpZ24vdmVyaWZ5XCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCBzaWduIGFuZCB2ZXJpZnkgYSBzdHJpbmcgbWVzc2FnZVwiLCAoKSA9PiB7XG4gICAgICBjb25zdCBrZXlNYW5hZ2VyID0gbmV3IEtleU1hbmFnZXIoKTtcbiAgICAgIGtleU1hbmFnZXIuZ2VuZXJhdGVJZGVudGl0eUtleVBhaXIoKTtcblxuICAgICAgY29uc3QgbWVzc2FnZSA9IFwiTWVzc2FnZSB0byBzaWduXCI7XG4gICAgICBjb25zdCBzaWduYXR1cmUgPSBjcnlwdG9NYW5hZ2VyLnNpZ24obWVzc2FnZSwga2V5TWFuYWdlci5nZXRQcml2YXRlS2V5KCkpO1xuICAgICAgY29uc3QgaXNWYWxpZCA9IGNyeXB0b01hbmFnZXIudmVyaWZ5KFxuICAgICAgICBtZXNzYWdlLFxuICAgICAgICBzaWduYXR1cmUsXG4gICAgICAgIGtleU1hbmFnZXIuZ2V0UHVibGljS2V5KCksXG4gICAgICApO1xuXG4gICAgICBleHBlY3Qoc2lnbmF0dXJlKS50b0hhdmVMZW5ndGgoNjQpO1xuICAgICAgZXhwZWN0KGlzVmFsaWQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCBzaWduIGFuZCB2ZXJpZnkgYSBVaW50OEFycmF5IG1lc3NhZ2VcIiwgKCkgPT4ge1xuICAgICAgY29uc3Qga2V5TWFuYWdlciA9IG5ldyBLZXlNYW5hZ2VyKCk7XG4gICAgICBrZXlNYW5hZ2VyLmdlbmVyYXRlSWRlbnRpdHlLZXlQYWlyKCk7XG5cbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBuZXcgVWludDhBcnJheShbMSwgMiwgMywgNCwgNV0pO1xuICAgICAgY29uc3Qgc2lnbmF0dXJlID0gY3J5cHRvTWFuYWdlci5zaWduKG1lc3NhZ2UsIGtleU1hbmFnZXIuZ2V0UHJpdmF0ZUtleSgpKTtcbiAgICAgIGNvbnN0IGlzVmFsaWQgPSBjcnlwdG9NYW5hZ2VyLnZlcmlmeShcbiAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgc2lnbmF0dXJlLFxuICAgICAgICBrZXlNYW5hZ2VyLmdldFB1YmxpY0tleSgpLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KGlzVmFsaWQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCByZWplY3QgaW52YWxpZCBzaWduYXR1cmVcIiwgKCkgPT4ge1xuICAgICAgY29uc3Qga2V5TWFuYWdlciA9IG5ldyBLZXlNYW5hZ2VyKCk7XG4gICAgICBrZXlNYW5hZ2VyLmdlbmVyYXRlSWRlbnRpdHlLZXlQYWlyKCk7XG5cbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBcIk9yaWdpbmFsIG1lc3NhZ2VcIjtcbiAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IGNyeXB0b01hbmFnZXIuc2lnbihtZXNzYWdlLCBrZXlNYW5hZ2VyLmdldFByaXZhdGVLZXkoKSk7XG4gICAgICBjb25zdCBpc1ZhbGlkID0gY3J5cHRvTWFuYWdlci52ZXJpZnkoXG4gICAgICAgIFwiVGFtcGVyZWQgbWVzc2FnZVwiLFxuICAgICAgICBzaWduYXR1cmUsXG4gICAgICAgIGtleU1hbmFnZXIuZ2V0UHVibGljS2V5KCksXG4gICAgICApO1xuXG4gICAgICBleHBlY3QoaXNWYWxpZCkudG9CZShmYWxzZSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwiZGVyaXZlU2VjcmV0XCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCBkZXJpdmUgc2hhcmVkIHNlY3JldCBiZXR3ZWVuIHR3byBwYXJ0aWVzXCIsICgpID0+IHtcbiAgICAgIC8vIFVzZSBpZGVudGl0eSBrZXlzIGZvciBoaWdoLWxldmVsIHNlY3JldCBkZXJpdmF0aW9uXG4gICAgICBjb25zdCBrZXlwYWlyMSA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICAgIGNvbnN0IGtleXBhaXIyID0gZ2VuZXJhdGVJZGVudGl0eSgpO1xuXG4gICAgICBjb25zdCBzZWNyZXQxID0gY3J5cHRvTWFuYWdlci5kZXJpdmVTZWNyZXQoXG4gICAgICAgIGtleXBhaXIxLnByaXZhdGVLZXksXG4gICAgICAgIGtleXBhaXIyLnB1YmxpY0tleSxcbiAgICAgICk7XG4gICAgICBjb25zdCBzZWNyZXQyID0gY3J5cHRvTWFuYWdlci5kZXJpdmVTZWNyZXQoXG4gICAgICAgIGtleXBhaXIyLnByaXZhdGVLZXksXG4gICAgICAgIGtleXBhaXIxLnB1YmxpY0tleSxcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChzZWNyZXQxKS50b0hhdmVMZW5ndGgoMzIpO1xuICAgICAgaWYgKCF0aW1pbmdTYWZlRXF1YWwoc2VjcmV0MSwgc2VjcmV0MikpIHtcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgY29uc29sZS5lcnJvcihcIltURVNULURFQlVHXSBDcnlwdG9NYW5hZ2VyIGRlcml2ZVNlY3JldCBtaXNtYXRjaDpcIik7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJzZWNyZXQxPVwiLCBCdWZmZXIuZnJvbShzZWNyZXQxKS50b1N0cmluZyhcImhleFwiKSk7XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJzZWNyZXQyPVwiLCBCdWZmZXIuZnJvbShzZWNyZXQyKS50b1N0cmluZyhcImhleFwiKSk7XG4gICAgICB9XG5cbiAgICAgIGV4cGVjdCh0aW1pbmdTYWZlRXF1YWwoc2VjcmV0MSwgc2VjcmV0MikpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCBtYWludGFpbiBrZXkgcGF0aCBjb25zaXN0ZW5jeVwiLCAoKSA9PiB7XG4gICAgICBjb25zdCBwcml2ID0gZWQyNTUxOS51dGlscy5yYW5kb21TZWNyZXRLZXkoKTtcbiAgICAgIGNvbnN0IHB1YiA9IGVkMjU1MTkuZ2V0UHVibGljS2V5KHByaXYpO1xuXG4gICAgICBjb25zdCBtb250ID0gZWQyNTUxOS51dGlscy50b01vbnRnb21lcnkocHViKTtcbiAgICAgIGNvbnN0IHhQcml2ID0gZWQyNTUxOS51dGlscy50b01vbnRnb21lcnlTZWNyZXQocHJpdik7XG4gICAgICBjb25zdCB4UHViRnJvbVByaXYgPSB4MjU1MTkuZ2V0UHVibGljS2V5KHhQcml2KTtcblxuICAgICAgaWYgKFxuICAgICAgICBCdWZmZXIuZnJvbShtb250KS50b1N0cmluZyhcImhleFwiKSAhPT1cbiAgICAgICAgQnVmZmVyLmZyb20oeFB1YkZyb21Qcml2KS50b1N0cmluZyhcImhleFwiKVxuICAgICAgKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJbQ09OU0lTVEVOQ1ktVEVTVF0gTWlzbWF0Y2ghXCIpO1xuICAgICAgICBjb25zb2xlLmVycm9yKFwibW9udCAgICAgICAgOlwiLCBCdWZmZXIuZnJvbShtb250KS50b1N0cmluZyhcImhleFwiKSk7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXG4gICAgICAgICAgXCJ4UHViRnJvbVByaXY6XCIsXG4gICAgICAgICAgQnVmZmVyLmZyb20oeFB1YkZyb21Qcml2KS50b1N0cmluZyhcImhleFwiKSxcbiAgICAgICAgKTtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiS2V5IHBhdGggaW5jb25zaXN0ZW5jeSBpbiBKZXN0IGVudmlyb25tZW50XCIpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgcGVyZm9ybSBjb3JyZWN0IEVDREhcIiwgKCkgPT4ge1xuICAgICAgY29uc3QgcHJpdkEgPSBlZDI1NTE5LnV0aWxzLnJhbmRvbVNlY3JldEtleSgpO1xuICAgICAgY29uc3QgcHViQSA9IGVkMjU1MTkuZ2V0UHVibGljS2V5KHByaXZBKTtcbiAgICAgIGNvbnN0IHByaXZCID0gZWQyNTUxOS51dGlscy5yYW5kb21TZWNyZXRLZXkoKTtcbiAgICAgIGNvbnN0IHB1YkIgPSBlZDI1NTE5LmdldFB1YmxpY0tleShwcml2Qik7XG5cbiAgICAgIGNvbnN0IHVBID0gZWQyNTUxOS51dGlscy50b01vbnRnb21lcnkocHViQSk7XG4gICAgICBjb25zdCB1QiA9IGVkMjU1MTkudXRpbHMudG9Nb250Z29tZXJ5KHB1YkIpO1xuXG4gICAgICBjb25zdCB4UHJpdkEgPSBlZDI1NTE5LnV0aWxzLnRvTW9udGdvbWVyeVNlY3JldChwcml2QSk7XG4gICAgICBjb25zdCB4UHJpdkIgPSBlZDI1NTE5LnV0aWxzLnRvTW9udGdvbWVyeVNlY3JldChwcml2Qik7XG5cbiAgICAgIGNvbnN0IHMxID0geDI1NTE5LmdldFNoYXJlZFNlY3JldCh4UHJpdkEsIHVCKTtcbiAgICAgIGNvbnN0IHMyID0geDI1NTE5LmdldFNoYXJlZFNlY3JldCh4UHJpdkIsIHVBKTtcblxuICAgICAgaWYgKEJ1ZmZlci5mcm9tKHMxKS50b1N0cmluZyhcImhleFwiKSAhPT0gQnVmZmVyLmZyb20oczIpLnRvU3RyaW5nKFwiaGV4XCIpKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJbRUNESC1URVNUXSBNaXNtYXRjaCFcIik7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJzMTpcIiwgQnVmZmVyLmZyb20oczEpLnRvU3RyaW5nKFwiaGV4XCIpKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihcInMyOlwiLCBCdWZmZXIuZnJvbShzMikudG9TdHJpbmcoXCJoZXhcIikpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFQ0RIIG1pc21hdGNoIGluIEplc3QgZW52aXJvbm1lbnRcIik7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKFwiS2V5TWFuYWdlclwiLCAoKSA9PiB7XG4gIGxldCBrZXlNYW5hZ2VyOiBLZXlNYW5hZ2VyO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGtleU1hbmFnZXIgPSBuZXcgS2V5TWFuYWdlcigpO1xuICB9KTtcblxuICBkZXNjcmliZShcImdlbmVyYXRlSWRlbnRpdHlLZXlQYWlyXCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCBnZW5lcmF0ZSBhIGtleXBhaXJcIiwgKCkgPT4ge1xuICAgICAgZXhwZWN0KGtleU1hbmFnZXIuaGFzS2V5cGFpcigpKS50b0JlKGZhbHNlKTtcblxuICAgICAga2V5TWFuYWdlci5nZW5lcmF0ZUlkZW50aXR5S2V5UGFpcigpO1xuXG4gICAgICBleHBlY3Qoa2V5TWFuYWdlci5oYXNLZXlwYWlyKCkpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwiZ2V0UHVibGljS2V5XCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCB0aHJvdyBpZiBrZXlwYWlyIG5vdCBnZW5lcmF0ZWRcIiwgKCkgPT4ge1xuICAgICAgZXhwZWN0KCgpID0+IGtleU1hbmFnZXIuZ2V0UHVibGljS2V5KCkpLnRvVGhyb3coXCJLZXlwYWlyIG5vdCBnZW5lcmF0ZWRcIik7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCByZXR1cm4gMzItYnl0ZSBwdWJsaWMga2V5XCIsICgpID0+IHtcbiAgICAgIGtleU1hbmFnZXIuZ2VuZXJhdGVJZGVudGl0eUtleVBhaXIoKTtcbiAgICAgIGNvbnN0IHB1YmxpY0tleSA9IGtleU1hbmFnZXIuZ2V0UHVibGljS2V5KCk7XG5cbiAgICAgIGV4cGVjdChwdWJsaWNLZXkpLnRvSGF2ZUxlbmd0aCgzMik7XG4gICAgICBleHBlY3QocHVibGljS2V5KS50b0JlSW5zdGFuY2VPZihVaW50OEFycmF5KTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIHJldHVybiBhIGNvcHkgb2YgdGhlIHB1YmxpYyBrZXlcIiwgKCkgPT4ge1xuICAgICAga2V5TWFuYWdlci5nZW5lcmF0ZUlkZW50aXR5S2V5UGFpcigpO1xuICAgICAgY29uc3QgcHVibGljS2V5MSA9IGtleU1hbmFnZXIuZ2V0UHVibGljS2V5KCk7XG4gICAgICBjb25zdCBwdWJsaWNLZXkyID0ga2V5TWFuYWdlci5nZXRQdWJsaWNLZXkoKTtcblxuICAgICAgLy8gU2hvdWxkIGJlIGVxdWFsIGluIHZhbHVlXG4gICAgICBleHBlY3QodGltaW5nU2FmZUVxdWFsKHB1YmxpY0tleTEsIHB1YmxpY0tleTIpKS50b0JlKHRydWUpO1xuXG4gICAgICAvLyBCdXQgc2hvdWxkIGJlIGRpZmZlcmVudCBvYmplY3RzIChjb3BpZXMpXG4gICAgICBleHBlY3QocHVibGljS2V5MSkubm90LnRvQmUocHVibGljS2V5Mik7XG5cbiAgICAgIC8vIE1vZGlmeWluZyBvbmUgc2hvdWxkIG5vdCBhZmZlY3QgdGhlIG90aGVyXG4gICAgICBwdWJsaWNLZXkxWzBdID0gcHVibGljS2V5MVswXSBeIDB4ZmY7XG4gICAgICBleHBlY3QodGltaW5nU2FmZUVxdWFsKHB1YmxpY0tleTEsIHB1YmxpY0tleTIpKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoXCJnZXRQcml2YXRlS2V5XCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCB0aHJvdyBpZiBrZXlwYWlyIG5vdCBnZW5lcmF0ZWRcIiwgKCkgPT4ge1xuICAgICAgZXhwZWN0KCgpID0+IGtleU1hbmFnZXIuZ2V0UHJpdmF0ZUtleSgpKS50b1Rocm93KFwiS2V5cGFpciBub3QgZ2VuZXJhdGVkXCIpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgcmV0dXJuIDMyLWJ5dGUgcHJpdmF0ZSBrZXlcIiwgKCkgPT4ge1xuICAgICAga2V5TWFuYWdlci5nZW5lcmF0ZUlkZW50aXR5S2V5UGFpcigpO1xuICAgICAgY29uc3QgcHJpdmF0ZUtleSA9IGtleU1hbmFnZXIuZ2V0UHJpdmF0ZUtleSgpO1xuXG4gICAgICBleHBlY3QocHJpdmF0ZUtleSkudG9IYXZlTGVuZ3RoKDMyKTtcbiAgICAgIGV4cGVjdChwcml2YXRlS2V5KS50b0JlSW5zdGFuY2VPZihVaW50OEFycmF5KTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIHJldHVybiBhIGNvcHkgb2YgdGhlIHByaXZhdGUga2V5XCIsICgpID0+IHtcbiAgICAgIGtleU1hbmFnZXIuZ2VuZXJhdGVJZGVudGl0eUtleVBhaXIoKTtcbiAgICAgIGNvbnN0IHByaXZhdGVLZXkxID0ga2V5TWFuYWdlci5nZXRQcml2YXRlS2V5KCk7XG4gICAgICBjb25zdCBwcml2YXRlS2V5MiA9IGtleU1hbmFnZXIuZ2V0UHJpdmF0ZUtleSgpO1xuXG4gICAgICAvLyBTaG91bGQgYmUgZXF1YWwgaW4gdmFsdWVcbiAgICAgIGV4cGVjdCh0aW1pbmdTYWZlRXF1YWwocHJpdmF0ZUtleTEsIHByaXZhdGVLZXkyKSkudG9CZSh0cnVlKTtcblxuICAgICAgLy8gQnV0IHNob3VsZCBiZSBkaWZmZXJlbnQgb2JqZWN0cyAoY29waWVzKVxuICAgICAgZXhwZWN0KHByaXZhdGVLZXkxKS5ub3QudG9CZShwcml2YXRlS2V5Mik7XG5cbiAgICAgIC8vIE1vZGlmeWluZyBvbmUgc2hvdWxkIG5vdCBhZmZlY3QgdGhlIG90aGVyXG4gICAgICBwcml2YXRlS2V5MVswXSA9IHByaXZhdGVLZXkxWzBdIF4gMHhmZjtcbiAgICAgIGV4cGVjdCh0aW1pbmdTYWZlRXF1YWwocHJpdmF0ZUtleTEsIHByaXZhdGVLZXkyKSkudG9CZShmYWxzZSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwiaGFzS2V5cGFpclwiLCAoKSA9PiB7XG4gICAgaXQoXCJzaG91bGQgcmV0dXJuIGZhbHNlIGJlZm9yZSBnZW5lcmF0aW9uXCIsICgpID0+IHtcbiAgICAgIGV4cGVjdChrZXlNYW5hZ2VyLmhhc0tleXBhaXIoKSkudG9CZShmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCByZXR1cm4gdHJ1ZSBhZnRlciBnZW5lcmF0aW9uXCIsICgpID0+IHtcbiAgICAgIGtleU1hbmFnZXIuZ2VuZXJhdGVJZGVudGl0eUtleVBhaXIoKTtcbiAgICAgIGV4cGVjdChrZXlNYW5hZ2VyLmhhc0tleXBhaXIoKSkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIHJldHVybiBmYWxzZSBhZnRlciBjbGVhclwiLCAoKSA9PiB7XG4gICAgICBrZXlNYW5hZ2VyLmdlbmVyYXRlSWRlbnRpdHlLZXlQYWlyKCk7XG4gICAgICBrZXlNYW5hZ2VyLmNsZWFyKCk7XG4gICAgICBleHBlY3Qoa2V5TWFuYWdlci5oYXNLZXlwYWlyKCkpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZShcImNsZWFyXCIsICgpID0+IHtcbiAgICBpdChcInNob3VsZCBjbGVhciB0aGUga2V5cGFpclwiLCAoKSA9PiB7XG4gICAgICBrZXlNYW5hZ2VyLmdlbmVyYXRlSWRlbnRpdHlLZXlQYWlyKCk7XG4gICAgICBleHBlY3Qoa2V5TWFuYWdlci5oYXNLZXlwYWlyKCkpLnRvQmUodHJ1ZSk7XG5cbiAgICAgIGtleU1hbmFnZXIuY2xlYXIoKTtcblxuICAgICAgZXhwZWN0KGtleU1hbmFnZXIuaGFzS2V5cGFpcigpKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdCgoKSA9PiBrZXlNYW5hZ2VyLmdldFB1YmxpY0tleSgpKS50b1Rocm93KCk7XG4gICAgICBleHBlY3QoKCkgPT4ga2V5TWFuYWdlci5nZXRQcml2YXRlS2V5KCkpLnRvVGhyb3coKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIGJlIHNhZmUgdG8gY2FsbCBtdWx0aXBsZSB0aW1lc1wiLCAoKSA9PiB7XG4gICAgICBrZXlNYW5hZ2VyLmdlbmVyYXRlSWRlbnRpdHlLZXlQYWlyKCk7XG4gICAgICBrZXlNYW5hZ2VyLmNsZWFyKCk7XG4gICAgICBrZXlNYW5hZ2VyLmNsZWFyKCk7IC8vIFNob3VsZCBub3QgdGhyb3dcblxuICAgICAgZXhwZWN0KGtleU1hbmFnZXIuaGFzS2V5cGFpcigpKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIGJlIHNhZmUgdG8gY2FsbCB3aXRob3V0IGdlbmVyYXRpbmcga2V5cGFpclwiLCAoKSA9PiB7XG4gICAgICBrZXlNYW5hZ2VyLmNsZWFyKCk7IC8vIFNob3VsZCBub3QgdGhyb3dcbiAgICAgIGV4cGVjdChrZXlNYW5hZ2VyLmhhc0tleXBhaXIoKSkudG9CZShmYWxzZSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=