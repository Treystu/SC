d65f85f6ef0cfd370e62f7b25b274682
"use strict";
/**
 * Tests for Secure Key Storage
 */
Object.defineProperty(exports, "__esModule", { value: true });
const storage_1 = require("./storage");
describe('WebKeyStorage', () => {
    let storage;
    const testKeyId = 'test-key-123';
    const testKey = new Uint8Array([1, 2, 3, 4, 5, 6, 7, 8]);
    beforeEach(async () => {
        storage = new storage_1.WebKeyStorage();
        // Skip init for tests (would need IndexedDB mock)
    });
    describe('Memory Storage (for testing)', () => {
        let memStorage;
        beforeEach(() => {
            memStorage = new storage_1.MemoryKeyStorage();
        });
        it('should store and retrieve keys', async () => {
            await memStorage.storeKey(testKeyId, testKey);
            const retrieved = await memStorage.getKey(testKeyId);
            expect(retrieved).toEqual(testKey);
        });
        it('should return null for non-existent keys', async () => {
            const retrieved = await memStorage.getKey('non-existent');
            expect(retrieved).toBeNull();
        });
        it('should check if key exists', async () => {
            await memStorage.storeKey(testKeyId, testKey);
            const exists = await memStorage.hasKey(testKeyId);
            const notExists = await memStorage.hasKey('other-key');
            expect(exists).toBe(true);
            expect(notExists).toBe(false);
        });
        it('should delete keys securely', async () => {
            await memStorage.storeKey(testKeyId, testKey);
            await memStorage.deleteKey(testKeyId);
            const retrieved = await memStorage.getKey(testKeyId);
            expect(retrieved).toBeNull();
        });
        it('should list all keys', async () => {
            await memStorage.storeKey('key1', testKey);
            await memStorage.storeKey('key2', testKey);
            await memStorage.storeKey('key3', testKey);
            const keys = await memStorage.listKeys();
            expect(keys).toContain('key1');
            expect(keys).toContain('key2');
            expect(keys).toContain('key3');
            expect(keys).toHaveLength(3);
        });
        it('should store and retrieve key metadata', async () => {
            const metadata = {
                version: 1,
                createdAt: Date.now(),
                tags: ['signing', 'primary'],
            };
            await memStorage.storeKey(testKeyId, testKey, metadata);
            const retrieved = await memStorage.getKeyMetadata(testKeyId);
            expect(retrieved).toEqual(metadata);
        });
        it('should update metadata on access', async () => {
            const metadata = {
                version: 1,
                createdAt: Date.now(),
                accessCount: 0,
            };
            await memStorage.storeKey(testKeyId, testKey, metadata);
            await memStorage.getKey(testKeyId);
            await memStorage.getKey(testKeyId);
            const updated = await memStorage.getKeyMetadata(testKeyId);
            expect(updated?.accessCount).toBeGreaterThan(0);
        });
        it('should support key versioning', async () => {
            const metadata1 = {
                version: 1,
                createdAt: Date.now(),
            };
            const metadata2 = {
                version: 2,
                createdAt: Date.now(),
            };
            await memStorage.storeKey('key-v1', testKey, metadata1);
            await memStorage.storeKey('key-v2', new Uint8Array([9, 10, 11]), metadata2);
            const meta1 = await memStorage.getKeyMetadata('key-v1');
            const meta2 = await memStorage.getKeyMetadata('key-v2');
            expect(meta1?.version).toBe(1);
            expect(meta2?.version).toBe(2);
        });
        it('should support key tagging', async () => {
            const metadata = {
                version: 1,
                createdAt: Date.now(),
                tags: ['encryption', 'session', 'temporary'],
            };
            await memStorage.storeKey(testKeyId, testKey, metadata);
            const retrieved = await memStorage.getKeyMetadata(testKeyId);
            expect(retrieved?.tags).toContain('encryption');
            expect(retrieved?.tags).toContain('session');
            expect(retrieved?.tags).toContain('temporary');
        });
        it('should handle empty key list', async () => {
            const keys = await memStorage.listKeys();
            expect(keys).toEqual([]);
        });
        it('should overwrite existing keys', async () => {
            const key1 = new Uint8Array([1, 2, 3]);
            const key2 = new Uint8Array([4, 5, 6]);
            await memStorage.storeKey(testKeyId, key1);
            await memStorage.storeKey(testKeyId, key2);
            const retrieved = await memStorage.getKey(testKeyId);
            expect(retrieved).toEqual(key2);
        });
        it('should handle metadata for non-existent keys', async () => {
            const metadata = await memStorage.getKeyMetadata('non-existent');
            expect(metadata).toBeNull();
        });
        it('should delete non-existent keys without error', async () => {
            await expect(memStorage.deleteKey('non-existent')).resolves.not.toThrow();
        });
    });
    describe('Security Features', () => {
        let memStorage;
        beforeEach(() => {
            memStorage = new storage_1.MemoryKeyStorage();
        });
        it('should wipe keys from memory on delete', async () => {
            const sensitiveKey = new Uint8Array([1, 2, 3, 4, 5]);
            await memStorage.storeKey(testKeyId, sensitiveKey);
            await memStorage.deleteKey(testKeyId);
            // Key should be completely removed
            const retrieved = await memStorage.getKey(testKeyId);
            expect(retrieved).toBeNull();
        });
        it('should track key access count', async () => {
            const metadata = {
                version: 1,
                createdAt: Date.now(),
                accessCount: 0,
            };
            await memStorage.storeKey(testKeyId, testKey, metadata);
            // Access the key multiple times
            await memStorage.getKey(testKeyId);
            await memStorage.getKey(testKeyId);
            await memStorage.getKey(testKeyId);
            const updated = await memStorage.getKeyMetadata(testKeyId);
            expect(updated?.accessCount).toBeGreaterThanOrEqual(3);
        });
        it('should track last accessed time', async () => {
            const beforeTime = Date.now();
            const metadata = {
                version: 1,
                createdAt: beforeTime,
            };
            await memStorage.storeKey(testKeyId, testKey, metadata);
            // Wait a bit and access
            await new Promise(resolve => setTimeout(resolve, 10));
            await memStorage.getKey(testKeyId);
            const updated = await memStorage.getKeyMetadata(testKeyId);
            expect(updated?.lastAccessedAt).toBeGreaterThanOrEqual(beforeTime);
        });
    });
    describe('Edge Cases', () => {
        let memStorage;
        beforeEach(() => {
            memStorage = new storage_1.MemoryKeyStorage();
        });
        it('should handle empty key data', async () => {
            const emptyKey = new Uint8Array(0);
            await memStorage.storeKey(testKeyId, emptyKey);
            const retrieved = await memStorage.getKey(testKeyId);
            expect(retrieved).toEqual(emptyKey);
        });
        it('should handle large keys', async () => {
            const largeKey = new Uint8Array(10000);
            largeKey.fill(42);
            await memStorage.storeKey(testKeyId, largeKey);
            const retrieved = await memStorage.getKey(testKeyId);
            expect(retrieved).toEqual(largeKey);
        });
        it('should handle special characters in key IDs', async () => {
            const specialId = 'key-@#$%^&*()_+{}[]|\\:";\'<>?,./';
            await memStorage.storeKey(specialId, testKey);
            const retrieved = await memStorage.getKey(specialId);
            expect(retrieved).toEqual(testKey);
        });
        it('should handle many keys', async () => {
            for (let i = 0; i < 100; i++) {
                await memStorage.storeKey(`key-${i}`, new Uint8Array([i]));
            }
            const keys = await memStorage.listKeys();
            expect(keys).toHaveLength(100);
        });
        it('should handle metadata without optional fields', async () => {
            const minimalMetadata = {
                version: 1,
                createdAt: Date.now(),
            };
            await memStorage.storeKey(testKeyId, testKey, minimalMetadata);
            const retrieved = await memStorage.getKeyMetadata(testKeyId);
            expect(retrieved?.version).toBe(1);
            expect(retrieved?.createdAt).toBeDefined();
        });
    });
    describe('Migration Support', () => {
        it('should support key migration', async () => {
            const memStorage = new storage_1.MemoryKeyStorage();
            if (memStorage.migrateKeys) {
                await expect(memStorage.migrateKeys(1, 2)).resolves.not.toThrow();
            }
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvY3J5cHRvL3N0b3JhZ2UudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsdUNBQXlFO0FBRXpFLFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO0lBQzdCLElBQUksT0FBc0IsQ0FBQztJQUMzQixNQUFNLFNBQVMsR0FBRyxjQUFjLENBQUM7SUFDakMsTUFBTSxPQUFPLEdBQUcsSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUV6RCxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsT0FBTyxHQUFHLElBQUksdUJBQWEsRUFBRSxDQUFDO1FBQzlCLGtEQUFrRDtJQUNwRCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyw4QkFBOEIsRUFBRSxHQUFHLEVBQUU7UUFDNUMsSUFBSSxVQUE0QixDQUFDO1FBRWpDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxVQUFVLEdBQUcsSUFBSSwwQkFBZ0IsRUFBRSxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGdDQUFnQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzlDLE1BQU0sVUFBVSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDOUMsTUFBTSxTQUFTLEdBQUcsTUFBTSxVQUFVLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXJELE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDckMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsMENBQTBDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDeEQsTUFBTSxTQUFTLEdBQUcsTUFBTSxV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O1FBQ2pDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGdEQUFnRCxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzlELE1BQU0sZUFBZSxHQUFnQjtnQkFDbkMsT0FBTyxFQUFFLENBQUM7Z0JBQ1YsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7YUFDdEIsQ0FBQztZQUVGLE1BQU0sVUFBVSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLGVBQWUsQ0FBQyxDQUFDO1lBQy9ELE1BQU0sU0FBUyxHQUFHLE1BQU0sVUFBVSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUU3RCxNQUFNLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQyxNQUFNLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzdDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO1FBQ2pDLEVBQUUsQ0FBQyw4QkFBOEIsRUFBRSxLQUFLLElBQUksRUFBRTtZQUM1QyxNQUFNLFVBQVUsR0FBRyxJQUFJLDBCQUFnQixFQUFFLENBQUM7WUFFMUMsSUFBSSxVQUFVLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQzNCLE1BQU0sTUFBTSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNwRSxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jaHJpc3R5bWF4d2VsbC9EZXNrdG9wL0x1a2VfU3R1ZmYvR2l0SHViL1NDL2NvcmUvc3JjL2NyeXB0by9zdG9yYWdlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUZXN0cyBmb3IgU2VjdXJlIEtleSBTdG9yYWdlXG4gKi9cblxuaW1wb3J0IHsgV2ViS2V5U3RvcmFnZSwgTWVtb3J5S2V5U3RvcmFnZSwgS2V5TWV0YWRhdGEgfSBmcm9tICcuL3N0b3JhZ2UnO1xuXG5kZXNjcmliZSgnV2ViS2V5U3RvcmFnZScsICgpID0+IHtcbiAgbGV0IHN0b3JhZ2U6IFdlYktleVN0b3JhZ2U7XG4gIGNvbnN0IHRlc3RLZXlJZCA9ICd0ZXN0LWtleS0xMjMnO1xuICBjb25zdCB0ZXN0S2V5ID0gbmV3IFVpbnQ4QXJyYXkoWzEsIDIsIDMsIDQsIDUsIDYsIDcsIDhdKTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBzdG9yYWdlID0gbmV3IFdlYktleVN0b3JhZ2UoKTtcbiAgICAvLyBTa2lwIGluaXQgZm9yIHRlc3RzICh3b3VsZCBuZWVkIEluZGV4ZWREQiBtb2NrKVxuICB9KTtcblxuICBkZXNjcmliZSgnTWVtb3J5IFN0b3JhZ2UgKGZvciB0ZXN0aW5nKScsICgpID0+IHtcbiAgICBsZXQgbWVtU3RvcmFnZTogTWVtb3J5S2V5U3RvcmFnZTtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgbWVtU3RvcmFnZSA9IG5ldyBNZW1vcnlLZXlTdG9yYWdlKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHN0b3JlIGFuZCByZXRyaWV2ZSBrZXlzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5zdG9yZUtleSh0ZXN0S2V5SWQsIHRlc3RLZXkpO1xuICAgICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgbWVtU3RvcmFnZS5nZXRLZXkodGVzdEtleUlkKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHJldHJpZXZlZCkudG9FcXVhbCh0ZXN0S2V5KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgZm9yIG5vbi1leGlzdGVudCBrZXlzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgbWVtU3RvcmFnZS5nZXRLZXkoJ25vbi1leGlzdGVudCcpO1xuICAgICAgZXhwZWN0KHJldHJpZXZlZCkudG9CZU51bGwoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY2hlY2sgaWYga2V5IGV4aXN0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IG1lbVN0b3JhZ2Uuc3RvcmVLZXkodGVzdEtleUlkLCB0ZXN0S2V5KTtcbiAgICAgIFxuICAgICAgY29uc3QgZXhpc3RzID0gYXdhaXQgbWVtU3RvcmFnZS5oYXNLZXkodGVzdEtleUlkKTtcbiAgICAgIGNvbnN0IG5vdEV4aXN0cyA9IGF3YWl0IG1lbVN0b3JhZ2UuaGFzS2V5KCdvdGhlci1rZXknKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KGV4aXN0cykudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChub3RFeGlzdHMpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBkZWxldGUga2V5cyBzZWN1cmVseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IG1lbVN0b3JhZ2Uuc3RvcmVLZXkodGVzdEtleUlkLCB0ZXN0S2V5KTtcbiAgICAgIGF3YWl0IG1lbVN0b3JhZ2UuZGVsZXRlS2V5KHRlc3RLZXlJZCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHJldHJpZXZlZCA9IGF3YWl0IG1lbVN0b3JhZ2UuZ2V0S2V5KHRlc3RLZXlJZCk7XG4gICAgICBleHBlY3QocmV0cmlldmVkKS50b0JlTnVsbCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBsaXN0IGFsbCBrZXlzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5zdG9yZUtleSgna2V5MScsIHRlc3RLZXkpO1xuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5zdG9yZUtleSgna2V5MicsIHRlc3RLZXkpO1xuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5zdG9yZUtleSgna2V5MycsIHRlc3RLZXkpO1xuICAgICAgXG4gICAgICBjb25zdCBrZXlzID0gYXdhaXQgbWVtU3RvcmFnZS5saXN0S2V5cygpO1xuICAgICAgZXhwZWN0KGtleXMpLnRvQ29udGFpbigna2V5MScpO1xuICAgICAgZXhwZWN0KGtleXMpLnRvQ29udGFpbigna2V5MicpO1xuICAgICAgZXhwZWN0KGtleXMpLnRvQ29udGFpbigna2V5MycpO1xuICAgICAgZXhwZWN0KGtleXMpLnRvSGF2ZUxlbmd0aCgzKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc3RvcmUgYW5kIHJldHJpZXZlIGtleSBtZXRhZGF0YScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1ldGFkYXRhOiBLZXlNZXRhZGF0YSA9IHtcbiAgICAgICAgdmVyc2lvbjogMSxcbiAgICAgICAgY3JlYXRlZEF0OiBEYXRlLm5vdygpLFxuICAgICAgICB0YWdzOiBbJ3NpZ25pbmcnLCAncHJpbWFyeSddLFxuICAgICAgfTtcbiAgICAgIFxuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5zdG9yZUtleSh0ZXN0S2V5SWQsIHRlc3RLZXksIG1ldGFkYXRhKTtcbiAgICAgIGNvbnN0IHJldHJpZXZlZCA9IGF3YWl0IG1lbVN0b3JhZ2UuZ2V0S2V5TWV0YWRhdGEodGVzdEtleUlkKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHJldHJpZXZlZCkudG9FcXVhbChtZXRhZGF0YSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHVwZGF0ZSBtZXRhZGF0YSBvbiBhY2Nlc3MnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtZXRhZGF0YTogS2V5TWV0YWRhdGEgPSB7XG4gICAgICAgIHZlcnNpb246IDEsXG4gICAgICAgIGNyZWF0ZWRBdDogRGF0ZS5ub3coKSxcbiAgICAgICAgYWNjZXNzQ291bnQ6IDAsXG4gICAgICB9O1xuICAgICAgXG4gICAgICBhd2FpdCBtZW1TdG9yYWdlLnN0b3JlS2V5KHRlc3RLZXlJZCwgdGVzdEtleSwgbWV0YWRhdGEpO1xuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5nZXRLZXkodGVzdEtleUlkKTtcbiAgICAgIGF3YWl0IG1lbVN0b3JhZ2UuZ2V0S2V5KHRlc3RLZXlJZCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCBtZW1TdG9yYWdlLmdldEtleU1ldGFkYXRhKHRlc3RLZXlJZCk7XG4gICAgICBleHBlY3QodXBkYXRlZD8uYWNjZXNzQ291bnQpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc3VwcG9ydCBrZXkgdmVyc2lvbmluZycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1ldGFkYXRhMTogS2V5TWV0YWRhdGEgPSB7XG4gICAgICAgIHZlcnNpb246IDEsXG4gICAgICAgIGNyZWF0ZWRBdDogRGF0ZS5ub3coKSxcbiAgICAgIH07XG4gICAgICBcbiAgICAgIGNvbnN0IG1ldGFkYXRhMjogS2V5TWV0YWRhdGEgPSB7XG4gICAgICAgIHZlcnNpb246IDIsXG4gICAgICAgIGNyZWF0ZWRBdDogRGF0ZS5ub3coKSxcbiAgICAgIH07XG4gICAgICBcbiAgICAgIGF3YWl0IG1lbVN0b3JhZ2Uuc3RvcmVLZXkoJ2tleS12MScsIHRlc3RLZXksIG1ldGFkYXRhMSk7XG4gICAgICBhd2FpdCBtZW1TdG9yYWdlLnN0b3JlS2V5KCdrZXktdjInLCBuZXcgVWludDhBcnJheShbOSwgMTAsIDExXSksIG1ldGFkYXRhMik7XG4gICAgICBcbiAgICAgIGNvbnN0IG1ldGExID0gYXdhaXQgbWVtU3RvcmFnZS5nZXRLZXlNZXRhZGF0YSgna2V5LXYxJyk7XG4gICAgICBjb25zdCBtZXRhMiA9IGF3YWl0IG1lbVN0b3JhZ2UuZ2V0S2V5TWV0YWRhdGEoJ2tleS12MicpO1xuICAgICAgXG4gICAgICBleHBlY3QobWV0YTE/LnZlcnNpb24pLnRvQmUoMSk7XG4gICAgICBleHBlY3QobWV0YTI/LnZlcnNpb24pLnRvQmUoMik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHN1cHBvcnQga2V5IHRhZ2dpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtZXRhZGF0YTogS2V5TWV0YWRhdGEgPSB7XG4gICAgICAgIHZlcnNpb246IDEsXG4gICAgICAgIGNyZWF0ZWRBdDogRGF0ZS5ub3coKSxcbiAgICAgICAgdGFnczogWydlbmNyeXB0aW9uJywgJ3Nlc3Npb24nLCAndGVtcG9yYXJ5J10sXG4gICAgICB9O1xuICAgICAgXG4gICAgICBhd2FpdCBtZW1TdG9yYWdlLnN0b3JlS2V5KHRlc3RLZXlJZCwgdGVzdEtleSwgbWV0YWRhdGEpO1xuICAgICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgbWVtU3RvcmFnZS5nZXRLZXlNZXRhZGF0YSh0ZXN0S2V5SWQpO1xuICAgICAgXG4gICAgICBleHBlY3QocmV0cmlldmVkPy50YWdzKS50b0NvbnRhaW4oJ2VuY3J5cHRpb24nKTtcbiAgICAgIGV4cGVjdChyZXRyaWV2ZWQ/LnRhZ3MpLnRvQ29udGFpbignc2Vzc2lvbicpO1xuICAgICAgZXhwZWN0KHJldHJpZXZlZD8udGFncykudG9Db250YWluKCd0ZW1wb3JhcnknKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVtcHR5IGtleSBsaXN0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qga2V5cyA9IGF3YWl0IG1lbVN0b3JhZ2UubGlzdEtleXMoKTtcbiAgICAgIGV4cGVjdChrZXlzKS50b0VxdWFsKFtdKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgb3ZlcndyaXRlIGV4aXN0aW5nIGtleXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBrZXkxID0gbmV3IFVpbnQ4QXJyYXkoWzEsIDIsIDNdKTtcbiAgICAgIGNvbnN0IGtleTIgPSBuZXcgVWludDhBcnJheShbNCwgNSwgNl0pO1xuICAgICAgXG4gICAgICBhd2FpdCBtZW1TdG9yYWdlLnN0b3JlS2V5KHRlc3RLZXlJZCwga2V5MSk7XG4gICAgICBhd2FpdCBtZW1TdG9yYWdlLnN0b3JlS2V5KHRlc3RLZXlJZCwga2V5Mik7XG4gICAgICBcbiAgICAgIGNvbnN0IHJldHJpZXZlZCA9IGF3YWl0IG1lbVN0b3JhZ2UuZ2V0S2V5KHRlc3RLZXlJZCk7XG4gICAgICBleHBlY3QocmV0cmlldmVkKS50b0VxdWFsKGtleTIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbWV0YWRhdGEgZm9yIG5vbi1leGlzdGVudCBrZXlzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCBtZW1TdG9yYWdlLmdldEtleU1ldGFkYXRhKCdub24tZXhpc3RlbnQnKTtcbiAgICAgIGV4cGVjdChtZXRhZGF0YSkudG9CZU51bGwoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZGVsZXRlIG5vbi1leGlzdGVudCBrZXlzIHdpdGhvdXQgZXJyb3InLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBleHBlY3QobWVtU3RvcmFnZS5kZWxldGVLZXkoJ25vbi1leGlzdGVudCcpKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnU2VjdXJpdHkgRmVhdHVyZXMnLCAoKSA9PiB7XG4gICAgbGV0IG1lbVN0b3JhZ2U6IE1lbW9yeUtleVN0b3JhZ2U7XG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIG1lbVN0b3JhZ2UgPSBuZXcgTWVtb3J5S2V5U3RvcmFnZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB3aXBlIGtleXMgZnJvbSBtZW1vcnkgb24gZGVsZXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgc2Vuc2l0aXZlS2V5ID0gbmV3IFVpbnQ4QXJyYXkoWzEsIDIsIDMsIDQsIDVdKTtcbiAgICAgIGF3YWl0IG1lbVN0b3JhZ2Uuc3RvcmVLZXkodGVzdEtleUlkLCBzZW5zaXRpdmVLZXkpO1xuICAgICAgXG4gICAgICBhd2FpdCBtZW1TdG9yYWdlLmRlbGV0ZUtleSh0ZXN0S2V5SWQpO1xuICAgICAgXG4gICAgICAvLyBLZXkgc2hvdWxkIGJlIGNvbXBsZXRlbHkgcmVtb3ZlZFxuICAgICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgbWVtU3RvcmFnZS5nZXRLZXkodGVzdEtleUlkKTtcbiAgICAgIGV4cGVjdChyZXRyaWV2ZWQpLnRvQmVOdWxsKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRyYWNrIGtleSBhY2Nlc3MgY291bnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtZXRhZGF0YTogS2V5TWV0YWRhdGEgPSB7XG4gICAgICAgIHZlcnNpb246IDEsXG4gICAgICAgIGNyZWF0ZWRBdDogRGF0ZS5ub3coKSxcbiAgICAgICAgYWNjZXNzQ291bnQ6IDAsXG4gICAgICB9O1xuICAgICAgXG4gICAgICBhd2FpdCBtZW1TdG9yYWdlLnN0b3JlS2V5KHRlc3RLZXlJZCwgdGVzdEtleSwgbWV0YWRhdGEpO1xuICAgICAgXG4gICAgICAvLyBBY2Nlc3MgdGhlIGtleSBtdWx0aXBsZSB0aW1lc1xuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5nZXRLZXkodGVzdEtleUlkKTtcbiAgICAgIGF3YWl0IG1lbVN0b3JhZ2UuZ2V0S2V5KHRlc3RLZXlJZCk7XG4gICAgICBhd2FpdCBtZW1TdG9yYWdlLmdldEtleSh0ZXN0S2V5SWQpO1xuICAgICAgXG4gICAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgbWVtU3RvcmFnZS5nZXRLZXlNZXRhZGF0YSh0ZXN0S2V5SWQpO1xuICAgICAgZXhwZWN0KHVwZGF0ZWQ/LmFjY2Vzc0NvdW50KS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDMpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0cmFjayBsYXN0IGFjY2Vzc2VkIHRpbWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBiZWZvcmVUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgIFxuICAgICAgY29uc3QgbWV0YWRhdGE6IEtleU1ldGFkYXRhID0ge1xuICAgICAgICB2ZXJzaW9uOiAxLFxuICAgICAgICBjcmVhdGVkQXQ6IGJlZm9yZVRpbWUsXG4gICAgICB9O1xuICAgICAgXG4gICAgICBhd2FpdCBtZW1TdG9yYWdlLnN0b3JlS2V5KHRlc3RLZXlJZCwgdGVzdEtleSwgbWV0YWRhdGEpO1xuICAgICAgXG4gICAgICAvLyBXYWl0IGEgYml0IGFuZCBhY2Nlc3NcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMCkpO1xuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5nZXRLZXkodGVzdEtleUlkKTtcbiAgICAgIFxuICAgICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IG1lbVN0b3JhZ2UuZ2V0S2V5TWV0YWRhdGEodGVzdEtleUlkKTtcbiAgICAgIGV4cGVjdCh1cGRhdGVkPy5sYXN0QWNjZXNzZWRBdCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbChiZWZvcmVUaW1lKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0VkZ2UgQ2FzZXMnLCAoKSA9PiB7XG4gICAgbGV0IG1lbVN0b3JhZ2U6IE1lbW9yeUtleVN0b3JhZ2U7XG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIG1lbVN0b3JhZ2UgPSBuZXcgTWVtb3J5S2V5U3RvcmFnZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZW1wdHkga2V5IGRhdGEnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBlbXB0eUtleSA9IG5ldyBVaW50OEFycmF5KDApO1xuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5zdG9yZUtleSh0ZXN0S2V5SWQsIGVtcHR5S2V5KTtcbiAgICAgIFxuICAgICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgbWVtU3RvcmFnZS5nZXRLZXkodGVzdEtleUlkKTtcbiAgICAgIGV4cGVjdChyZXRyaWV2ZWQpLnRvRXF1YWwoZW1wdHlLZXkpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbGFyZ2Uga2V5cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGxhcmdlS2V5ID0gbmV3IFVpbnQ4QXJyYXkoMTAwMDApO1xuICAgICAgbGFyZ2VLZXkuZmlsbCg0Mik7XG4gICAgICBcbiAgICAgIGF3YWl0IG1lbVN0b3JhZ2Uuc3RvcmVLZXkodGVzdEtleUlkLCBsYXJnZUtleSk7XG4gICAgICBjb25zdCByZXRyaWV2ZWQgPSBhd2FpdCBtZW1TdG9yYWdlLmdldEtleSh0ZXN0S2V5SWQpO1xuICAgICAgXG4gICAgICBleHBlY3QocmV0cmlldmVkKS50b0VxdWFsKGxhcmdlS2V5KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHNwZWNpYWwgY2hhcmFjdGVycyBpbiBrZXkgSURzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3Qgc3BlY2lhbElkID0gJ2tleS1AIyQlXiYqKClfK3t9W118XFxcXDpcIjtcXCc8Pj8sLi8nO1xuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5zdG9yZUtleShzcGVjaWFsSWQsIHRlc3RLZXkpO1xuICAgICAgXG4gICAgICBjb25zdCByZXRyaWV2ZWQgPSBhd2FpdCBtZW1TdG9yYWdlLmdldEtleShzcGVjaWFsSWQpO1xuICAgICAgZXhwZWN0KHJldHJpZXZlZCkudG9FcXVhbCh0ZXN0S2V5KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG1hbnkga2V5cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTAwOyBpKyspIHtcbiAgICAgICAgYXdhaXQgbWVtU3RvcmFnZS5zdG9yZUtleShga2V5LSR7aX1gLCBuZXcgVWludDhBcnJheShbaV0pKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgY29uc3Qga2V5cyA9IGF3YWl0IG1lbVN0b3JhZ2UubGlzdEtleXMoKTtcbiAgICAgIGV4cGVjdChrZXlzKS50b0hhdmVMZW5ndGgoMTAwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG1ldGFkYXRhIHdpdGhvdXQgb3B0aW9uYWwgZmllbGRzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbWluaW1hbE1ldGFkYXRhOiBLZXlNZXRhZGF0YSA9IHtcbiAgICAgICAgdmVyc2lvbjogMSxcbiAgICAgICAgY3JlYXRlZEF0OiBEYXRlLm5vdygpLFxuICAgICAgfTtcbiAgICAgIFxuICAgICAgYXdhaXQgbWVtU3RvcmFnZS5zdG9yZUtleSh0ZXN0S2V5SWQsIHRlc3RLZXksIG1pbmltYWxNZXRhZGF0YSk7XG4gICAgICBjb25zdCByZXRyaWV2ZWQgPSBhd2FpdCBtZW1TdG9yYWdlLmdldEtleU1ldGFkYXRhKHRlc3RLZXlJZCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChyZXRyaWV2ZWQ/LnZlcnNpb24pLnRvQmUoMSk7XG4gICAgICBleHBlY3QocmV0cmlldmVkPy5jcmVhdGVkQXQpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdNaWdyYXRpb24gU3VwcG9ydCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHN1cHBvcnQga2V5IG1pZ3JhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1lbVN0b3JhZ2UgPSBuZXcgTWVtb3J5S2V5U3RvcmFnZSgpO1xuICAgICAgXG4gICAgICBpZiAobWVtU3RvcmFnZS5taWdyYXRlS2V5cykge1xuICAgICAgICBhd2FpdCBleHBlY3QobWVtU3RvcmFnZS5taWdyYXRlS2V5cygxLCAyKSkucmVzb2x2ZXMubm90LnRvVGhyb3coKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==