dfefffe048375619a5935449c1852d9b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const health_1 = require("./health");
const routing_1 = require("./routing");
describe('Advanced Peer Health Monitoring', () => {
    let healthMonitor;
    let routingTable;
    const localPeerId = 'local-peer';
    const privateKey = new Uint8Array(32);
    beforeEach(() => {
        routingTable = new routing_1.RoutingTable(localPeerId);
        healthMonitor = new health_1.PeerHealthMonitor(localPeerId, privateKey, routingTable, {
            interval: 1000, // 1 second for testing
            timeout: 3000,
            maxMissed: 2,
            adaptiveInterval: true,
            minInterval: 500,
            maxInterval: 2000,
        });
    });
    afterEach(() => {
        healthMonitor.shutdown();
    });
    describe('Adaptive Heartbeat Intervals', () => {
        it('should initialize with default interval', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            healthMonitor.startMonitoring('peer1');
            const health = healthMonitor.getPeerHealth('peer1');
            expect(health?.adaptiveInterval).toBe(1000);
        });
        it('should track RTT and latency history', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            healthMonitor.startMonitoring('peer1');
            const timestamp = Date.now() - 100;
            healthMonitor.processHeartbeatResponse('peer1', timestamp);
            const health = healthMonitor.getPeerHealth('peer1');
            expect(health?.rtt).toBeGreaterThan(0);
            expect(health?.latencyHistory.length).toBeGreaterThan(0);
        });
        it('should calculate health score based on metrics', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            healthMonitor.startMonitoring('peer1');
            // Simulate good response
            const timestamp = Date.now() - 50;
            healthMonitor.processHeartbeatResponse('peer1', timestamp);
            const health = healthMonitor.getPeerHealth('peer1');
            expect(health?.healthScore).toBeGreaterThan(80);
        });
        it('should update packet loss on missed heartbeats', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            healthMonitor.startMonitoring('peer1');
            // Force a check without response
            const health = healthMonitor.getPeerHealth('peer1');
            if (health) {
                health.lastHeartbeat = Date.now() - 5000; // Force timeout
            }
            // Packet loss should increase over time with missed heartbeats
            expect(health?.packetLoss).toBeDefined();
        });
    });
    describe('Health Score Calculation', () => {
        it('should penalize high latency', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            healthMonitor.startMonitoring('peer1');
            // Simulate high latency response
            const timestamp = Date.now() - 1500; // 1500ms latency
            healthMonitor.processHeartbeatResponse('peer1', timestamp);
            const health = healthMonitor.getPeerHealth('peer1');
            expect(health?.healthScore).toBeLessThan(80);
        });
        it('should maintain high score for good connection', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            healthMonitor.startMonitoring('peer1');
            // Simulate good responses
            for (let i = 0; i < 5; i++) {
                const timestamp = Date.now() - 50;
                healthMonitor.processHeartbeatResponse('peer1', timestamp);
            }
            const health = healthMonitor.getPeerHealth('peer1');
            expect(health?.healthScore).toBeGreaterThanOrEqual(90);
        });
    });
    describe('Peer Health State Transitions', () => {
        it('should track missed heartbeats', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            healthMonitor.startMonitoring('peer1');
            const health = healthMonitor.getPeerHealth('peer1');
            expect(health).toBeDefined();
            expect(health?.isHealthy).toBe(true);
            expect(health?.missedHeartbeats).toBe(0);
        });
        it('should transition back to healthy on successful response', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            healthMonitor.startMonitoring('peer1');
            const health = healthMonitor.getPeerHealth('peer1');
            if (health) {
                health.isHealthy = false;
                health.missedHeartbeats = 3;
            }
            const timestamp = Date.now() - 50;
            healthMonitor.processHeartbeatResponse('peer1', timestamp);
            const updatedHealth = healthMonitor.getPeerHealth('peer1');
            expect(updatedHealth?.isHealthy).toBe(true);
            expect(updatedHealth?.missedHeartbeats).toBe(0);
        });
    });
    describe('Statistics and Monitoring', () => {
        it('should provide health statistics', () => {
            const peer1 = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            const peer2 = (0, routing_1.createPeer)('peer2', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer1);
            routingTable.addPeer(peer2);
            healthMonitor.startMonitoring('peer1');
            healthMonitor.startMonitoring('peer2');
            const stats = healthMonitor.getStats();
            expect(stats.totalPeers).toBe(2);
            expect(stats.healthy).toBeGreaterThan(0);
        });
        it('should calculate average RTT', () => {
            const peer1 = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer1);
            healthMonitor.startMonitoring('peer1');
            const timestamp = Date.now() - 100;
            healthMonitor.processHeartbeatResponse('peer1', timestamp);
            const stats = healthMonitor.getStats();
            expect(stats.averageRtt).toBeGreaterThan(0);
        });
        it('should get all peer health statuses', () => {
            const peer1 = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            const peer2 = (0, routing_1.createPeer)('peer2', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer1);
            routingTable.addPeer(peer2);
            healthMonitor.startMonitoring('peer1');
            healthMonitor.startMonitoring('peer2');
            const allHealth = healthMonitor.getAllPeerHealth();
            expect(allHealth).toHaveLength(2);
            expect(allHealth.map(h => h.peerId)).toContain('peer1');
            expect(allHealth.map(h => h.peerId)).toContain('peer2');
        });
    });
    describe('Cleanup and Shutdown', () => {
        it('should stop monitoring a peer', () => {
            const peer = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer);
            healthMonitor.startMonitoring('peer1');
            expect(healthMonitor.getPeerHealth('peer1')).toBeDefined();
            healthMonitor.stopMonitoring('peer1');
            expect(healthMonitor.getPeerHealth('peer1')).toBeUndefined();
        });
        it('should shutdown all monitoring', () => {
            const peer1 = (0, routing_1.createPeer)('peer1', new Uint8Array(32), 'webrtc');
            const peer2 = (0, routing_1.createPeer)('peer2', new Uint8Array(32), 'webrtc');
            routingTable.addPeer(peer1);
            routingTable.addPeer(peer2);
            healthMonitor.startMonitoring('peer1');
            healthMonitor.startMonitoring('peer2');
            healthMonitor.shutdown();
            const allHealth = healthMonitor.getAllPeerHealth();
            expect(allHealth).toHaveLength(0);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvbWVzaC9oZWFsdGgtYWR2YW5jZWQudGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLHFDQUF5RDtBQUN6RCx1Q0FBcUQ7QUFFckQsUUFBUSxDQUFDLGlDQUFpQyxFQUFFLEdBQUcsRUFBRTtJQUMvQyxJQUFJLGFBQWdDLENBQUM7SUFDckMsSUFBSSxZQUEwQixDQUFDO0lBQy9CLE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQztJQUNqQyxNQUFNLFVBQVUsR0FBRyxJQUFJLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUV0QyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsWUFBWSxHQUFHLElBQUksc0JBQVksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM3QyxhQUFhLEdBQUcsSUFBSSwwQkFBaUIsQ0FDbkMsV0FBVyxFQUNYLFVBQVUsRUFDVixZQUFZLEVBQ1o7WUFDRSxRQUFRLEVBQUUsSUFBSSxFQUFFLHVCQUF1QjtZQUN2QyxPQUFPLEVBQUUsSUFBSTtZQUNiLFNBQVMsRUFBRSxDQUFDO1lBQ1osZ0JBQWdCLEVBQUUsSUFBSTtZQUN0QixXQUFXLEVBQUUsR0FBRztZQUNoQixXQUFXLEVBQUUsSUFBSTtTQUNsQixDQUNGLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztJQUVILFNBQVMsQ0FBQyxHQUFHLEVBQUU7UUFDYixhQUFhLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDM0IsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsOEJBQThCLEVBQUUsR0FBRyxFQUFFO1FBQzVDLEVBQUUsQ0FBQyx5Q0FBeUMsRUFBRSxHQUFHLEVBQUU7WUFDakQsTUFBTSxJQUFJLEdBQUcsSUFBQSxvQkFBVSxFQUFDLE9BQU8sRUFBRSxJQUFJLFVBQVUsQ0FBQyxFQUFFLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUMvRCxZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTNC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LENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxnQ0FBZ0MsRUFBRSxHQUFHLEVBQUU7WUFDeEMsTUFBTSxLQUFLLEdBQUcsSUFBQSxvQkFBVSxFQUFDLE9BQU8sRUFBRSxJQUFJLFVBQVUsQ0FBQyxFQUFFLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUNoRSxNQUFNLEtBQUssR0FBRyxJQUFBLG9CQUFVLEVBQUMsT0FBTyxFQUFFLElBQUksVUFBVSxDQUFDLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBRWhFLFlBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDNUIsWUFBWSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUU1QixhQUFhLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZDLGFBQWEsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFdkMsYUFBYSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBRXpCLE1BQU0sU0FBUyxHQUFHLGFBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ25ELE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jaHJpc3R5bWF4d2VsbC9EZXNrdG9wL0x1a2VfU3R1ZmYvR2l0SHViL1NDL2NvcmUvc3JjL21lc2gvaGVhbHRoLWFkdmFuY2VkLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGVlckhlYWx0aE1vbml0b3IsIFBlZXJIZWFsdGggfSBmcm9tICcuL2hlYWx0aCc7XG5pbXBvcnQgeyBSb3V0aW5nVGFibGUsIGNyZWF0ZVBlZXIgfSBmcm9tICcuL3JvdXRpbmcnO1xuXG5kZXNjcmliZSgnQWR2YW5jZWQgUGVlciBIZWFsdGggTW9uaXRvcmluZycsICgpID0+IHtcbiAgbGV0IGhlYWx0aE1vbml0b3I6IFBlZXJIZWFsdGhNb25pdG9yO1xuICBsZXQgcm91dGluZ1RhYmxlOiBSb3V0aW5nVGFibGU7XG4gIGNvbnN0IGxvY2FsUGVlcklkID0gJ2xvY2FsLXBlZXInO1xuICBjb25zdCBwcml2YXRlS2V5ID0gbmV3IFVpbnQ4QXJyYXkoMzIpO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHJvdXRpbmdUYWJsZSA9IG5ldyBSb3V0aW5nVGFibGUobG9jYWxQZWVySWQpO1xuICAgIGhlYWx0aE1vbml0b3IgPSBuZXcgUGVlckhlYWx0aE1vbml0b3IoXG4gICAgICBsb2NhbFBlZXJJZCxcbiAgICAgIHByaXZhdGVLZXksXG4gICAgICByb3V0aW5nVGFibGUsXG4gICAgICB7XG4gICAgICAgIGludGVydmFsOiAxMDAwLCAvLyAxIHNlY29uZCBmb3IgdGVzdGluZ1xuICAgICAgICB0aW1lb3V0OiAzMDAwLFxuICAgICAgICBtYXhNaXNzZWQ6IDIsXG4gICAgICAgIGFkYXB0aXZlSW50ZXJ2YWw6IHRydWUsXG4gICAgICAgIG1pbkludGVydmFsOiA1MDAsXG4gICAgICAgIG1heEludGVydmFsOiAyMDAwLFxuICAgICAgfVxuICAgICk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgaGVhbHRoTW9uaXRvci5zaHV0ZG93bigpO1xuICB9KTtcblxuICBkZXNjcmliZSgnQWRhcHRpdmUgSGVhcnRiZWF0IEludGVydmFscycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGluaXRpYWxpemUgd2l0aCBkZWZhdWx0IGludGVydmFsJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlciA9IGNyZWF0ZVBlZXIoJ3BlZXIxJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyKTtcbiAgICAgIFxuICAgICAgaGVhbHRoTW9uaXRvci5zdGFydE1vbml0b3JpbmcoJ3BlZXIxJyk7XG4gICAgICBjb25zdCBoZWFsdGggPSBoZWFsdGhNb25pdG9yLmdldFBlZXJIZWFsdGgoJ3BlZXIxJyk7XG4gICAgICBcbiAgICAgIGV4cGVjdChoZWFsdGg/LmFkYXB0aXZlSW50ZXJ2YWwpLnRvQmUoMTAwMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRyYWNrIFJUVCBhbmQgbGF0ZW5jeSBoaXN0b3J5JywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlciA9IGNyZWF0ZVBlZXIoJ3BlZXIxJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyKTtcbiAgICAgIGhlYWx0aE1vbml0b3Iuc3RhcnRNb25pdG9yaW5nKCdwZWVyMScpO1xuXG4gICAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpIC0gMTAwO1xuICAgICAgaGVhbHRoTW9uaXRvci5wcm9jZXNzSGVhcnRiZWF0UmVzcG9uc2UoJ3BlZXIxJywgdGltZXN0YW1wKTtcblxuICAgICAgY29uc3QgaGVhbHRoID0gaGVhbHRoTW9uaXRvci5nZXRQZWVySGVhbHRoKCdwZWVyMScpO1xuICAgICAgZXhwZWN0KGhlYWx0aD8ucnR0KS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICBleHBlY3QoaGVhbHRoPy5sYXRlbmN5SGlzdG9yeS5sZW5ndGgpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY2FsY3VsYXRlIGhlYWx0aCBzY29yZSBiYXNlZCBvbiBtZXRyaWNzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlciA9IGNyZWF0ZVBlZXIoJ3BlZXIxJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyKTtcbiAgICAgIGhlYWx0aE1vbml0b3Iuc3RhcnRNb25pdG9yaW5nKCdwZWVyMScpO1xuXG4gICAgICAvLyBTaW11bGF0ZSBnb29kIHJlc3BvbnNlXG4gICAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpIC0gNTA7XG4gICAgICBoZWFsdGhNb25pdG9yLnByb2Nlc3NIZWFydGJlYXRSZXNwb25zZSgncGVlcjEnLCB0aW1lc3RhbXApO1xuXG4gICAgICBjb25zdCBoZWFsdGggPSBoZWFsdGhNb25pdG9yLmdldFBlZXJIZWFsdGgoJ3BlZXIxJyk7XG4gICAgICBleHBlY3QoaGVhbHRoPy5oZWFsdGhTY29yZSkudG9CZUdyZWF0ZXJUaGFuKDgwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXBkYXRlIHBhY2tldCBsb3NzIG9uIG1pc3NlZCBoZWFydGJlYXRzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlciA9IGNyZWF0ZVBlZXIoJ3BlZXIxJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyKTtcbiAgICAgIGhlYWx0aE1vbml0b3Iuc3RhcnRNb25pdG9yaW5nKCdwZWVyMScpO1xuXG4gICAgICAvLyBGb3JjZSBhIGNoZWNrIHdpdGhvdXQgcmVzcG9uc2VcbiAgICAgIGNvbnN0IGhlYWx0aCA9IGhlYWx0aE1vbml0b3IuZ2V0UGVlckhlYWx0aCgncGVlcjEnKTtcbiAgICAgIGlmIChoZWFsdGgpIHtcbiAgICAgICAgaGVhbHRoLmxhc3RIZWFydGJlYXQgPSBEYXRlLm5vdygpIC0gNTAwMDsgLy8gRm9yY2UgdGltZW91dFxuICAgICAgfVxuXG4gICAgICAvLyBQYWNrZXQgbG9zcyBzaG91bGQgaW5jcmVhc2Ugb3ZlciB0aW1lIHdpdGggbWlzc2VkIGhlYXJ0YmVhdHNcbiAgICAgIGV4cGVjdChoZWFsdGg/LnBhY2tldExvc3MpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdIZWFsdGggU2NvcmUgQ2FsY3VsYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBwZW5hbGl6ZSBoaWdoIGxhdGVuY3knLCAoKSA9PiB7XG4gICAgICBjb25zdCBwZWVyID0gY3JlYXRlUGVlcigncGVlcjEnLCBuZXcgVWludDhBcnJheSgzMiksICd3ZWJydGMnKTtcbiAgICAgIHJvdXRpbmdUYWJsZS5hZGRQZWVyKHBlZXIpO1xuICAgICAgaGVhbHRoTW9uaXRvci5zdGFydE1vbml0b3JpbmcoJ3BlZXIxJyk7XG5cbiAgICAgIC8vIFNpbXVsYXRlIGhpZ2ggbGF0ZW5jeSByZXNwb25zZVxuICAgICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKSAtIDE1MDA7IC8vIDE1MDBtcyBsYXRlbmN5XG4gICAgICBoZWFsdGhNb25pdG9yLnByb2Nlc3NIZWFydGJlYXRSZXNwb25zZSgncGVlcjEnLCB0aW1lc3RhbXApO1xuXG4gICAgICBjb25zdCBoZWFsdGggPSBoZWFsdGhNb25pdG9yLmdldFBlZXJIZWFsdGgoJ3BlZXIxJyk7XG4gICAgICBleHBlY3QoaGVhbHRoPy5oZWFsdGhTY29yZSkudG9CZUxlc3NUaGFuKDgwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbWFpbnRhaW4gaGlnaCBzY29yZSBmb3IgZ29vZCBjb25uZWN0aW9uJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlciA9IGNyZWF0ZVBlZXIoJ3BlZXIxJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyKTtcbiAgICAgIGhlYWx0aE1vbml0b3Iuc3RhcnRNb25pdG9yaW5nKCdwZWVyMScpO1xuXG4gICAgICAvLyBTaW11bGF0ZSBnb29kIHJlc3BvbnNlc1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHtcbiAgICAgICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKSAtIDUwO1xuICAgICAgICBoZWFsdGhNb25pdG9yLnByb2Nlc3NIZWFydGJlYXRSZXNwb25zZSgncGVlcjEnLCB0aW1lc3RhbXApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBoZWFsdGggPSBoZWFsdGhNb25pdG9yLmdldFBlZXJIZWFsdGgoJ3BlZXIxJyk7XG4gICAgICBleHBlY3QoaGVhbHRoPy5oZWFsdGhTY29yZSkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCg5MCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdQZWVyIEhlYWx0aCBTdGF0ZSBUcmFuc2l0aW9ucycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHRyYWNrIG1pc3NlZCBoZWFydGJlYXRzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlciA9IGNyZWF0ZVBlZXIoJ3BlZXIxJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyKTtcblxuICAgICAgaGVhbHRoTW9uaXRvci5zdGFydE1vbml0b3JpbmcoJ3BlZXIxJyk7XG5cbiAgICAgIGNvbnN0IGhlYWx0aCA9IGhlYWx0aE1vbml0b3IuZ2V0UGVlckhlYWx0aCgncGVlcjEnKTtcbiAgICAgIGV4cGVjdChoZWFsdGgpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoaGVhbHRoPy5pc0hlYWx0aHkpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoaGVhbHRoPy5taXNzZWRIZWFydGJlYXRzKS50b0JlKDApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0cmFuc2l0aW9uIGJhY2sgdG8gaGVhbHRoeSBvbiBzdWNjZXNzZnVsIHJlc3BvbnNlJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlciA9IGNyZWF0ZVBlZXIoJ3BlZXIxJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyKTtcbiAgICAgIGhlYWx0aE1vbml0b3Iuc3RhcnRNb25pdG9yaW5nKCdwZWVyMScpO1xuXG4gICAgICBjb25zdCBoZWFsdGggPSBoZWFsdGhNb25pdG9yLmdldFBlZXJIZWFsdGgoJ3BlZXIxJyk7XG4gICAgICBpZiAoaGVhbHRoKSB7XG4gICAgICAgIGhlYWx0aC5pc0hlYWx0aHkgPSBmYWxzZTtcbiAgICAgICAgaGVhbHRoLm1pc3NlZEhlYXJ0YmVhdHMgPSAzO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpIC0gNTA7XG4gICAgICBoZWFsdGhNb25pdG9yLnByb2Nlc3NIZWFydGJlYXRSZXNwb25zZSgncGVlcjEnLCB0aW1lc3RhbXApO1xuXG4gICAgICBjb25zdCB1cGRhdGVkSGVhbHRoID0gaGVhbHRoTW9uaXRvci5nZXRQZWVySGVhbHRoKCdwZWVyMScpO1xuICAgICAgZXhwZWN0KHVwZGF0ZWRIZWFsdGg/LmlzSGVhbHRoeSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdCh1cGRhdGVkSGVhbHRoPy5taXNzZWRIZWFydGJlYXRzKS50b0JlKDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnU3RhdGlzdGljcyBhbmQgTW9uaXRvcmluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHByb3ZpZGUgaGVhbHRoIHN0YXRpc3RpY3MnLCAoKSA9PiB7XG4gICAgICBjb25zdCBwZWVyMSA9IGNyZWF0ZVBlZXIoJ3BlZXIxJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG4gICAgICBjb25zdCBwZWVyMiA9IGNyZWF0ZVBlZXIoJ3BlZXIyJywgbmV3IFVpbnQ4QXJyYXkoMzIpLCAnd2VicnRjJyk7XG4gICAgICBcbiAgICAgIHJvdXRpbmdUYWJsZS5hZGRQZWVyKHBlZXIxKTtcbiAgICAgIHJvdXRpbmdUYWJsZS5hZGRQZWVyKHBlZXIyKTtcbiAgICAgIFxuICAgICAgaGVhbHRoTW9uaXRvci5zdGFydE1vbml0b3JpbmcoJ3BlZXIxJyk7XG4gICAgICBoZWFsdGhNb25pdG9yLnN0YXJ0TW9uaXRvcmluZygncGVlcjInKTtcblxuICAgICAgY29uc3Qgc3RhdHMgPSBoZWFsdGhNb25pdG9yLmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMudG90YWxQZWVycykudG9CZSgyKTtcbiAgICAgIGV4cGVjdChzdGF0cy5oZWFsdGh5KS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNhbGN1bGF0ZSBhdmVyYWdlIFJUVCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHBlZXIxID0gY3JlYXRlUGVlcigncGVlcjEnLCBuZXcgVWludDhBcnJheSgzMiksICd3ZWJydGMnKTtcbiAgICAgIHJvdXRpbmdUYWJsZS5hZGRQZWVyKHBlZXIxKTtcbiAgICAgIGhlYWx0aE1vbml0b3Iuc3RhcnRNb25pdG9yaW5nKCdwZWVyMScpO1xuXG4gICAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpIC0gMTAwO1xuICAgICAgaGVhbHRoTW9uaXRvci5wcm9jZXNzSGVhcnRiZWF0UmVzcG9uc2UoJ3BlZXIxJywgdGltZXN0YW1wKTtcblxuICAgICAgY29uc3Qgc3RhdHMgPSBoZWFsdGhNb25pdG9yLmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMuYXZlcmFnZVJ0dCkudG9CZUdyZWF0ZXJUaGFuKDApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBnZXQgYWxsIHBlZXIgaGVhbHRoIHN0YXR1c2VzJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlcjEgPSBjcmVhdGVQZWVyKCdwZWVyMScsIG5ldyBVaW50OEFycmF5KDMyKSwgJ3dlYnJ0YycpO1xuICAgICAgY29uc3QgcGVlcjIgPSBjcmVhdGVQZWVyKCdwZWVyMicsIG5ldyBVaW50OEFycmF5KDMyKSwgJ3dlYnJ0YycpO1xuICAgICAgXG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyMSk7XG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyMik7XG4gICAgICBcbiAgICAgIGhlYWx0aE1vbml0b3Iuc3RhcnRNb25pdG9yaW5nKCdwZWVyMScpO1xuICAgICAgaGVhbHRoTW9uaXRvci5zdGFydE1vbml0b3JpbmcoJ3BlZXIyJyk7XG5cbiAgICAgIGNvbnN0IGFsbEhlYWx0aCA9IGhlYWx0aE1vbml0b3IuZ2V0QWxsUGVlckhlYWx0aCgpO1xuICAgICAgZXhwZWN0KGFsbEhlYWx0aCkudG9IYXZlTGVuZ3RoKDIpO1xuICAgICAgZXhwZWN0KGFsbEhlYWx0aC5tYXAoaCA9PiBoLnBlZXJJZCkpLnRvQ29udGFpbigncGVlcjEnKTtcbiAgICAgIGV4cGVjdChhbGxIZWFsdGgubWFwKGggPT4gaC5wZWVySWQpKS50b0NvbnRhaW4oJ3BlZXIyJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdDbGVhbnVwIGFuZCBTaHV0ZG93bicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHN0b3AgbW9uaXRvcmluZyBhIHBlZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBwZWVyID0gY3JlYXRlUGVlcigncGVlcjEnLCBuZXcgVWludDhBcnJheSgzMiksICd3ZWJydGMnKTtcbiAgICAgIHJvdXRpbmdUYWJsZS5hZGRQZWVyKHBlZXIpO1xuICAgICAgXG4gICAgICBoZWFsdGhNb25pdG9yLnN0YXJ0TW9uaXRvcmluZygncGVlcjEnKTtcbiAgICAgIGV4cGVjdChoZWFsdGhNb25pdG9yLmdldFBlZXJIZWFsdGgoJ3BlZXIxJykpLnRvQmVEZWZpbmVkKCk7XG5cbiAgICAgIGhlYWx0aE1vbml0b3Iuc3RvcE1vbml0b3JpbmcoJ3BlZXIxJyk7XG4gICAgICBleHBlY3QoaGVhbHRoTW9uaXRvci5nZXRQZWVySGVhbHRoKCdwZWVyMScpKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNodXRkb3duIGFsbCBtb25pdG9yaW5nJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGVlcjEgPSBjcmVhdGVQZWVyKCdwZWVyMScsIG5ldyBVaW50OEFycmF5KDMyKSwgJ3dlYnJ0YycpO1xuICAgICAgY29uc3QgcGVlcjIgPSBjcmVhdGVQZWVyKCdwZWVyMicsIG5ldyBVaW50OEFycmF5KDMyKSwgJ3dlYnJ0YycpO1xuICAgICAgXG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyMSk7XG4gICAgICByb3V0aW5nVGFibGUuYWRkUGVlcihwZWVyMik7XG4gICAgICBcbiAgICAgIGhlYWx0aE1vbml0b3Iuc3RhcnRNb25pdG9yaW5nKCdwZWVyMScpO1xuICAgICAgaGVhbHRoTW9uaXRvci5zdGFydE1vbml0b3JpbmcoJ3BlZXIyJyk7XG5cbiAgICAgIGhlYWx0aE1vbml0b3Iuc2h1dGRvd24oKTtcblxuICAgICAgY29uc3QgYWxsSGVhbHRoID0gaGVhbHRoTW9uaXRvci5nZXRBbGxQZWVySGVhbHRoKCk7XG4gICAgICBleHBlY3QoYWxsSGVhbHRoKS50b0hhdmVMZW5ndGgoMCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=