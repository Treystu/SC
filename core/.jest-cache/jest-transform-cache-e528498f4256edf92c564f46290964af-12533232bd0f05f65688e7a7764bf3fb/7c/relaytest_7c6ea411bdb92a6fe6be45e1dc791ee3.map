{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/relay.test.ts","mappings":"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","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/relay.test.ts"],"sourcesContent":["/**\n * Tests for Message Relay and Flood Routing\n */\n\nimport { MessageRelay, RelayConfig } from './relay';\nimport { RoutingTable } from './routing';\nimport type { Message } from '../protocol/message';\nimport { MessageType, encodeMessage } from '../protocol/message';\n\ndescribe('MessageRelay', () => {\n  let relay: MessageRelay;\n  let routingTable: RoutingTable;\n  const localPeerId = 'local-peer-123';\n\n  beforeEach(() => {\n    routingTable = new RoutingTable(localPeerId);\n    relay = new MessageRelay(localPeerId, routingTable);\n  });\n\n  describe('Configuration', () => {\n    it('should create relay with default config', () => {\n      expect(relay).toBeDefined();\n      const stats = relay.getStats();\n      expect(stats.messagesReceived).toBe(0);\n      expect(stats.messagesForwarded).toBe(0);\n    });\n\n    it('should create relay with custom config', () => {\n      const config: RelayConfig = {\n        maxStoredMessages: 500,\n        storeTimeout: 120000,\n        maxRetries: 5,\n      };\n      const customRelay = new MessageRelay(localPeerId, routingTable, config);\n      expect(customRelay).toBeDefined();\n    });\n\n    it('should use selective flooding by default', () => {\n      const config: RelayConfig = {};\n      const selectiveRelay = new MessageRelay(localPeerId, routingTable, config);\n      expect(selectiveRelay).toBeDefined();\n    });\n  });\n\n  describe('Message Processing', () => {\n    it('should process valid message', async () => {\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 10,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode('test message'),\n      };\n\n      const encoded = encodeMessage(message);\n      await relay.processMessage(encoded, 'peer-1');\n\n      const stats = relay.getStats();\n      expect(stats.messagesReceived).toBe(1);\n    });\n\n    it('should detect duplicate messages', async () => {\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 10,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode('duplicate test'),\n      };\n\n      const encoded = encodeMessage(message);\n\n      await relay.processMessage(encoded, 'peer-1');\n      await relay.processMessage(encoded, 'peer-2'); // Duplicate\n\n      const stats = relay.getStats();\n      expect(stats.messagesReceived).toBe(2);\n      expect(stats.messagesDuplicate).toBe(1);\n    });\n\n    it('should drop expired messages (TTL=0)', async () => {\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 0,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode('expired'),\n      };\n\n      const encoded = encodeMessage(message);\n      await relay.processMessage(encoded, 'peer-1');\n\n      const stats = relay.getStats();\n      expect(stats.messagesExpired).toBe(1);\n    });\n  });\n\n  describe('Statistics', () => {\n    it('should track message stats', () => {\n      const stats = relay.getStats();\n\n      expect(stats).toHaveProperty('messagesReceived');\n      expect(stats).toHaveProperty('messagesForwarded');\n      expect(stats).toHaveProperty('messagesDuplicate');\n      expect(stats).toHaveProperty('messagesExpired');\n      expect(stats).toHaveProperty('messagesForSelf');\n      expect(stats).toHaveProperty('messagesStored');\n      expect(stats).toHaveProperty('relayFailures');\n      expect(stats).toHaveProperty('loopsDetected');\n    });\n\n    it('should reset statistics', () => {\n      relay.resetStats();\n      const stats = relay.getStats();\n\n      expect(stats.messagesReceived).toBe(0);\n      expect(stats.messagesForwarded).toBe(0);\n      expect(stats.messagesDuplicate).toBe(0);\n      expect(stats.messagesExpired).toBe(0);\n    });\n  });\n\n  describe('Store and Forward', () => {\n    it('should store message for offline peer', async () => {\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 10,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode('stored message'),\n      };\n\n      await relay.storeMessage(message, 'offline-peer');\n\n      const stats = await relay.getStats();\n      expect(stats.messagesStored).toBe(1);\n    });\n\n    it('should track stored messages stats', async () => {\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 10,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode('retrieve test'),\n      };\n\n      await relay.storeMessage(message, 'offline-peer');\n      const storedStats = await relay.getStoredMessagesStats();\n\n      expect(storedStats.total).toBeGreaterThan(0);\n      expect(storedStats.byDestination).toHaveProperty('offline-peer');\n    });\n\n    it('should retry stored messages', async () => {\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 10,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode('clear test'),\n      };\n\n      await relay.storeMessage(message, 'peer-1');\n      await relay.retryStoredMessages();\n\n      expect(relay).toBeDefined();\n    });\n  });\n\n  describe('Callbacks', () => {\n    it('should register onMessageForSelf callback', () => {\n      let callbackCalled = false;\n\n      relay.onMessageForSelf(() => {\n        callbackCalled = true;\n      });\n\n      expect(relay).toBeDefined();\n    });\n\n    it('should register onForwardMessage callback', () => {\n      let callbackCalled = false;\n\n      relay.onForwardMessage(() => {\n        callbackCalled = true;\n      });\n\n      expect(relay).toBeDefined();\n    });\n  });\n\n  describe('Loop Detection', () => {\n    it('should detect message loops', async () => {\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 10,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode('loop test'),\n      };\n\n      const encoded = encodeMessage(message);\n\n      // Process from multiple peers to simulate potential loop\n      await relay.processMessage(encoded, 'peer-1');\n\n      const stats = relay.getStats();\n      expect(stats).toBeDefined();\n    });\n  });\n});\n"],"version":3}