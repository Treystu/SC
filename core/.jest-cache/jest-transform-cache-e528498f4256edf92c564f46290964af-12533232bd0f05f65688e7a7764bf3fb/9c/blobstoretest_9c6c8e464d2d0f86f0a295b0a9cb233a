ae4f34a007be72649705f40d672d5833
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const blob_store_1 = require("./blob-store");
describe("BlobStore", () => {
    let blobStore;
    beforeEach(() => {
        blobStore = new blob_store_1.BlobStore();
    });
    it("should store a blob and return its hash", async () => {
        const data = new Uint8Array([1, 2, 3, 4]);
        const hash = await blobStore.put(data);
        // sha256 of [1,2,3,4]
        // 9f64a747e1b97f131fabb6b447296c9b6f0201e79fb3c5356e6c77e89b6a806a
        expect(typeof hash).toBe("string");
        expect(hash.length).toBe(64);
        expect(await blobStore.has(hash)).toBe(true);
    });
    it("should retrieve a stored blob", async () => {
        const data = new Uint8Array([5, 6, 7, 8]);
        const hash = await blobStore.put(data);
        const retrieved = await blobStore.get(hash);
        expect(retrieved).toEqual(data);
    });
    it("should return null for non-existent blob", async () => {
        const retrieved = await blobStore.get("non-existent");
        expect(retrieved).toBeUndefined();
    });
    it("should return false for has() if blob does not exist", async () => {
        expect(await blobStore.has("non-existent")).toBe(false);
    });
    describe("with persistence adapter", () => {
        let blobStore;
        let mockAdapter;
        beforeEach(async () => {
            mockAdapter = {
                dbName: 'testDb',
                storeName: 'testStore',
                db: null,
                version: 1,
                init: jest.fn().mockResolvedValue(undefined),
                put: jest.fn().mockResolvedValue(undefined),
                get: jest.fn().mockResolvedValue(null),
                has: jest.fn().mockResolvedValue(false),
                delete: jest.fn().mockResolvedValue(undefined),
                clear: jest.fn().mockResolvedValue(undefined),
                getAll: jest.fn().mockResolvedValue(new Map()),
                getSize: jest.fn().mockResolvedValue(0),
                ensureInit: jest.fn().mockResolvedValue(undefined)
            };
            blobStore = new blob_store_1.BlobStore(mockAdapter);
        });
        it("should store data using persistence adapter", async () => {
            const data = new Uint8Array([1, 2, 3, 4]);
            const hash = await blobStore.put(data);
            expect(mockAdapter.put).toHaveBeenCalledWith(hash, data);
            expect(hash).toBe("9f64a747e1b97f131fabb6b447296c9b6f0201e79fb3c5356e6c77e89b6a806a");
        });
        it("should retrieve from persistence when not in memory", async () => {
            const data = new Uint8Array([5, 6, 7, 8]);
            const hash = "05060708";
            // Mock persistence hit
            mockAdapter.get.mockResolvedValue(data);
            const result = await blobStore.get(hash);
            expect(mockAdapter.get).toHaveBeenCalledWith(hash);
            expect(result).toEqual(data);
        });
        it("should check persistence for data existence", async () => {
            const hash = "testhash";
            // Mock persistence hit
            mockAdapter.has.mockResolvedValue(true);
            const exists = await blobStore.has(hash);
            expect(mockAdapter.has).toHaveBeenCalledWith(hash);
            expect(exists).toBe(true);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvc3RvcmFnZS9ibG9iLXN0b3JlLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7QUFBQSw2Q0FBK0Q7QUFFL0QsUUFBUSxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUU7SUFDekIsSUFBSSxTQUFvQixDQUFDO0lBRXpCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxTQUFTLEdBQUcsSUFBSSxzQkFBUyxFQUFFLENBQUM7SUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMseUNBQXlDLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDdkQsTUFBTSxJQUFJLEdBQUcsSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzFDLE1BQU0sSUFBSSxHQUFHLE1BQU0sU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUV2QyxzQkFBc0I7UUFDdEIsbUVBQW1FO1FBQ25FLE1BQU0sQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNuQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM3QixNQUFNLENBQUMsTUFBTSxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLCtCQUErQixFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzdDLE1BQU0sSUFBSSxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxQyxNQUFNLElBQUksR0FBRyxNQUFNLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFB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Q0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDMUMsTUFBTSxJQUFJLEdBQUcsVUFBVSxDQUFDO1lBRXhCLHVCQUF1QjtZQUN2QixXQUFXLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBRXhDLE1BQU0sTUFBTSxHQUFHLE1BQU0sU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUV6QyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25ELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsNkNBQTZDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDM0QsTUFBTSxJQUFJLEdBQUcsVUFBVSxDQUFDO1lBRXhCLHVCQUF1QjtZQUN2QixXQUFXLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBRXhDLE1BQU0sTUFBTSxHQUFHLE1BQU0sU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUV6QyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25ELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jaHJpc3R5bWF4d2VsbC9EZXNrdG9wL0x1a2VfU3R1ZmYvR2l0SHViL1NDL2NvcmUvc3JjL3N0b3JhZ2UvYmxvYi1zdG9yZS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJsb2JTdG9yZSwgSW5kZXhlZERCQmxvYkFkYXB0ZXIgfSBmcm9tIFwiLi9ibG9iLXN0b3JlXCI7XG5cbmRlc2NyaWJlKFwiQmxvYlN0b3JlXCIsICgpID0+IHtcbiAgbGV0IGJsb2JTdG9yZTogQmxvYlN0b3JlO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGJsb2JTdG9yZSA9IG5ldyBCbG9iU3RvcmUoKTtcbiAgfSk7XG5cbiAgaXQoXCJzaG91bGQgc3RvcmUgYSBibG9iIGFuZCByZXR1cm4gaXRzIGhhc2hcIiwgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGRhdGEgPSBuZXcgVWludDhBcnJheShbMSwgMiwgMywgNF0pO1xuICAgIGNvbnN0IGhhc2ggPSBhd2FpdCBibG9iU3RvcmUucHV0KGRhdGEpO1xuXG4gICAgLy8gc2hhMjU2IG9mIFsxLDIsMyw0XVxuICAgIC8vIDlmNjRhNzQ3ZTFiOTdmMTMxZmFiYjZiNDQ3Mjk2YzliNmYwMjAxZTc5ZmIzYzUzNTZlNmM3N2U4OWI2YTgwNmFcbiAgICBleHBlY3QodHlwZW9mIGhhc2gpLnRvQmUoXCJzdHJpbmdcIik7XG4gICAgZXhwZWN0KGhhc2gubGVuZ3RoKS50b0JlKDY0KTtcbiAgICBleHBlY3QoYXdhaXQgYmxvYlN0b3JlLmhhcyhoYXNoKSkudG9CZSh0cnVlKTtcbiAgfSk7XG5cbiAgaXQoXCJzaG91bGQgcmV0cmlldmUgYSBzdG9yZWQgYmxvYlwiLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgZGF0YSA9IG5ldyBVaW50OEFycmF5KFs1LCA2LCA3LCA4XSk7XG4gICAgY29uc3QgaGFzaCA9IGF3YWl0IGJsb2JTdG9yZS5wdXQoZGF0YSk7XG5cbiAgICBjb25zdCByZXRyaWV2ZWQgPSBhd2FpdCBibG9iU3RvcmUuZ2V0KGhhc2gpO1xuICAgIGV4cGVjdChyZXRyaWV2ZWQpLnRvRXF1YWwoZGF0YSk7XG4gIH0pO1xuXG4gIGl0KFwic2hvdWxkIHJldHVybiBudWxsIGZvciBub24tZXhpc3RlbnQgYmxvYlwiLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmV0cmlldmVkID0gYXdhaXQgYmxvYlN0b3JlLmdldChcIm5vbi1leGlzdGVudFwiKTtcbiAgICBleHBlY3QocmV0cmlldmVkKS50b0JlVW5kZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGl0KFwic2hvdWxkIHJldHVybiBmYWxzZSBmb3IgaGFzKCkgaWYgYmxvYiBkb2VzIG5vdCBleGlzdFwiLCBhc3luYyAoKSA9PiB7XG4gICAgZXhwZWN0KGF3YWl0IGJsb2JTdG9yZS5oYXMoXCJub24tZXhpc3RlbnRcIikpLnRvQmUoZmFsc2UpO1xuICB9KTtcblxuICBkZXNjcmliZShcIndpdGggcGVyc2lzdGVuY2UgYWRhcHRlclwiLCAoKSA9PiB7XG4gICAgbGV0IGJsb2JTdG9yZTogQmxvYlN0b3JlO1xuICAgIGxldCBtb2NrQWRhcHRlcjogamVzdC5Nb2NrZWQ8SW5kZXhlZERCQmxvYkFkYXB0ZXI+O1xuXG4gICAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrQWRhcHRlciA9IHtcbiAgICAgICAgZGJOYW1lOiAndGVzdERiJyxcbiAgICAgICAgc3RvcmVOYW1lOiAndGVzdFN0b3JlJyxcbiAgICAgICAgZGI6IG51bGwsXG4gICAgICAgIHZlcnNpb246IDEsXG4gICAgICAgIGluaXQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxuICAgICAgICBwdXQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxuICAgICAgICBnZXQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKSxcbiAgICAgICAgaGFzOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoZmFsc2UpLFxuICAgICAgICBkZWxldGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpLFxuICAgICAgICBjbGVhcjogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCksXG4gICAgICAgIGdldEFsbDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG5ldyBNYXAoKSksXG4gICAgICAgIGdldFNpemU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSgwKSxcbiAgICAgICAgZW5zdXJlSW5pdDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZClcbiAgICAgIH0gYXMgYW55O1xuICAgICAgXG4gICAgICBibG9iU3RvcmUgPSBuZXcgQmxvYlN0b3JlKG1vY2tBZGFwdGVyKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIHN0b3JlIGRhdGEgdXNpbmcgcGVyc2lzdGVuY2UgYWRhcHRlclwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBkYXRhID0gbmV3IFVpbnQ4QXJyYXkoWzEsIDIsIDMsIDRdKTtcbiAgICAgIFxuICAgICAgY29uc3QgaGFzaCA9IGF3YWl0IGJsb2JTdG9yZS5wdXQoZGF0YSk7XG4gICAgICBcbiAgICAgIGV4cGVjdChtb2NrQWRhcHRlci5wdXQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGhhc2gsIGRhdGEpO1xuICAgICAgZXhwZWN0KGhhc2gpLnRvQmUoXCI5ZjY0YTc0N2UxYjk3ZjEzMWZhYmI2YjQ0NzI5NmM5YjZmMDIwMWU3OWZiM2M1MzU2ZTZjNzdlODliNmE4MDZhXCIpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgcmV0cmlldmUgZnJvbSBwZXJzaXN0ZW5jZSB3aGVuIG5vdCBpbiBtZW1vcnlcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZGF0YSA9IG5ldyBVaW50OEFycmF5KFs1LCA2LCA3LCA4XSk7XG4gICAgICBjb25zdCBoYXNoID0gXCIwNTA2MDcwOFwiO1xuICAgICAgXG4gICAgICAvLyBNb2NrIHBlcnNpc3RlbmNlIGhpdFxuICAgICAgbW9ja0FkYXB0ZXIuZ2V0Lm1vY2tSZXNvbHZlZFZhbHVlKGRhdGEpO1xuICAgICAgXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBibG9iU3RvcmUuZ2V0KGhhc2gpO1xuICAgICAgXG4gICAgICBleHBlY3QobW9ja0FkYXB0ZXIuZ2V0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChoYXNoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoZGF0YSk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCBjaGVjayBwZXJzaXN0ZW5jZSBmb3IgZGF0YSBleGlzdGVuY2VcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaGFzaCA9IFwidGVzdGhhc2hcIjtcbiAgICAgIFxuICAgICAgLy8gTW9jayBwZXJzaXN0ZW5jZSBoaXRcbiAgICAgIG1vY2tBZGFwdGVyLmhhcy5tb2NrUmVzb2x2ZWRWYWx1ZSh0cnVlKTtcbiAgICAgIFxuICAgICAgY29uc3QgZXhpc3RzID0gYXdhaXQgYmxvYlN0b3JlLmhhcyhoYXNoKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KG1vY2tBZGFwdGVyLmhhcykudG9IYXZlQmVlbkNhbGxlZFdpdGgoaGFzaCk7XG4gICAgICBleHBlY3QoZXhpc3RzKS50b0JlKHRydWUpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9