bbfac942c5f0f399a1222170644864a1
"use strict";
/**
 * Tests for Gossip Protocol Implementation
 */
Object.defineProperty(exports, "__esModule", { value: true });
const gossip_js_1 = require("./gossip.js");
const message_js_1 = require("../protocol/message.js");
describe('GossipProtocol', () => {
    let gossip;
    beforeEach(() => {
        gossip = new gossip_js_1.GossipProtocol({
            fanout: 3,
            gossipInterval: 100, // Fast for testing
            maxMessageAge: 5000,
            pruneInterval: 1000,
        });
    });
    afterEach(() => {
        gossip.stop();
        gossip.clear();
    });
    describe('Peer Management', () => {
        it('should add peers', () => {
            gossip.addPeer('peer1');
            gossip.addPeer('peer2');
            const stats = gossip.getStats();
            expect(stats.peerCount).toBe(2);
        });
        it('should remove peers', () => {
            gossip.addPeer('peer1');
            gossip.addPeer('peer2');
            gossip.removePeer('peer1');
            const stats = gossip.getStats();
            expect(stats.peerCount).toBe(1);
        });
        it('should track active peers', () => {
            gossip.addPeer('peer1');
            const stats = gossip.getStats();
            expect(stats.activePeerCount).toBe(1);
        });
    });
    describe('Message Handling', () => {
        it('should receive new messages', () => {
            const message = createTestMessage('test message');
            const isNew = gossip.receiveMessage(message, 'peer1');
            expect(isNew).toBe(true);
            const stats = gossip.getStats();
            expect(stats.messageCount).toBe(1);
            expect(stats.seenCount).toBe(1);
        });
        it('should detect duplicate messages', () => {
            const message = createTestMessage('test message');
            const isNew1 = gossip.receiveMessage(message, 'peer1');
            const isNew2 = gossip.receiveMessage(message, 'peer2');
            expect(isNew1).toBe(true);
            expect(isNew2).toBe(false); // Duplicate
            const stats = gossip.getStats();
            expect(stats.messageCount).toBe(1); // Only one copy stored
        });
        it('should trigger onMessage callback for new messages', () => {
            const callback = jest.fn();
            gossip.onMessage(callback);
            const message = createTestMessage('test');
            gossip.receiveMessage(message, 'peer1');
            expect(callback).toHaveBeenCalledWith(message, 'peer1');
        });
        it('should not trigger callback for duplicate messages', () => {
            const callback = jest.fn();
            gossip.onMessage(callback);
            const message = createTestMessage('test');
            gossip.receiveMessage(message, 'peer1');
            gossip.receiveMessage(message, 'peer2');
            expect(callback).toHaveBeenCalledTimes(1); // Only once
        });
    });
    describe('Gossip Protocol', () => {
        it('should start and stop gossip rounds', () => {
            gossip.start();
            expect(gossip['gossipInterval']).not.toBeNull();
            gossip.stop();
            expect(gossip['gossipInterval']).toBeNull();
        });
        it('should not start multiple times', () => {
            gossip.start();
            const interval1 = gossip['gossipInterval'];
            gossip.start();
            const interval2 = gossip['gossipInterval'];
            expect(interval1).toBe(interval2);
            gossip.stop();
        });
        it('should prune old messages', () => {
            jest.useFakeTimers();
            const message = createTestMessage('old message');
            gossip.receiveMessage(message, 'peer1');
            expect(gossip.getStats().messageCount).toBe(1);
            // Advance time past maxMessageAge (5000ms from config)
            jest.advanceTimersByTime(6000);
            // Trigger prune manually
            gossip['pruneOldMessages']();
            expect(gossip.getStats().messageCount).toBe(0);
            jest.useRealTimers();
        });
    });
    describe('Statistics', () => {
        it('should provide accurate stats', () => {
            gossip.addPeer('peer1');
            gossip.addPeer('peer2');
            const msg1 = createTestMessage('msg1');
            const msg2 = createTestMessage('msg2');
            gossip.receiveMessage(msg1, 'peer1');
            gossip.receiveMessage(msg2, 'peer2');
            const stats = gossip.getStats();
            expect(stats.peerCount).toBe(2);
            expect(stats.messageCount).toBe(2);
            expect(stats.seenCount).toBe(2);
        });
    });
    describe('Clear', () => {
        it('should clear all state', () => {
            gossip.addPeer('peer1');
            const message = createTestMessage('test');
            gossip.receiveMessage(message, 'peer1');
            gossip.clear();
            const stats = gossip.getStats();
            expect(stats.peerCount).toBe(0);
            expect(stats.messageCount).toBe(0);
            expect(stats.seenCount).toBe(0);
        });
    });
});
/**
 * Helper to create a test message
 */
function createTestMessage(content) {
    return {
        header: {
            version: 1,
            type: message_js_1.MessageType.TEXT,
            ttl: 10,
            timestamp: Date.now(),
            senderId: new Uint8Array(32),
            signature: new Uint8Array(64),
        },
        payload: new TextEncoder().encode(content),
    };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvbWVzaC9nb3NzaXAudGVzdC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsMkNBQTZDO0FBRTdDLHVEQUFxRDtBQUVyRCxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQzlCLElBQUksTUFBc0IsQ0FBQztJQUUzQixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsTUFBTSxHQUFHLElBQUksMEJBQWMsQ0FBQztZQUMxQixNQUFNLEVBQUUsQ0FBQztZQUNULGNBQWMsRUFBRSxHQUFHLEVBQUUsbUJBQW1CO1lBQ3hDLGFBQWEsRUFBRSxJQUFJO1lBQ25CLGFBQWEsRUFBRSxJQUFJO1NBQ3BCLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNkLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNqQixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7UUFDL0IsRUFBRSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtZQUMxQixNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFeEIsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2hDLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtZQUM3QixNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDeEIsTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUUzQixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxFQUFFO1lBQ25DLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDeEIsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2hDLE1BQU0sQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsa0JBQWtCLEVBQUUsR0FBRyxFQUFFO1FBQ2hDLEVBQUUsQ0FBQyw2QkFBNkIsRUFBRSxHQUFHLEVBQUU7WUFDckMsTUFBTSxPQUFPLEdBQUcsaUJBQWlCLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDbEQsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFFdEQsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6QixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsa0NBQWtDLEVBQUUsR0FBRyxFQUFFO1lBQzFDLE1BQU0sT0FBTyxHQUFHLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBRWxELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBRXZELE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFlBQVk7WUFFeEMsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2hDLE1BQU0sQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsdUJBQXVCO1FBQzdELENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLG9EQUFvRCxFQUFFLEdBQUcsRUFBRTtZQUM1RCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDM0IsTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUUzQixNQUFNLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMxQyxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUV4QyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsb0JBQW9CLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzFELENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLG9EQUFvRCxFQUFFLEdBQUcsRUFBRTtZQUM1RCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDM0IsTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUUzQixNQUFNLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMxQyxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUN4QyxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUV4QyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZO1FBQ3pELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO1FBQy9CLEVBQUUsQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLEVBQUU7WUFDN0MsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBRWhELE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNkLE1BQU0sQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzlDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGlDQUFpQyxFQUFFLEdBQUcsRUFBRTtZQUN6QyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDZixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUUzQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDZixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUUzQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2xDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNoQixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQywyQkFBMkIsRUFBRSxHQUFHLEVBQUU7WUFDbkMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3JCLE1BQU0sT0FBTyxHQUFHLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ2pELE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBRXhDLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRS9DLHVEQUF1RDtZQUN2RCxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFL0IseUJBQXlCO1lBQ3pCLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLENBQUM7WUFFN0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0MsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsWUFBWSxFQUFFLEdBQUcsRUFBRTtRQUMxQixFQUFFLENBQUMsK0JBQStCLEVBQUUsR0FBRyxFQUFFO1lBQ3ZDLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDeEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUV4QixNQUFNLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN2QyxNQUFNLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV2QyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNyQyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztZQUVyQyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1FBQ3JCLEVBQUUsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUU7WUFDaEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN4QixNQUFNLE9BQU8sR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMxQyxNQUFNLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztZQUV4QyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7WUFFZixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDaEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUg7O0dBRUc7QUFDSCxTQUFTLGlCQUFpQixDQUFDLE9BQWU7SUFDeEMsT0FBTztRQUNMLE1BQU0sRUFBRTtZQUNOLE9BQU8sRUFBRSxDQUFDO1lBQ1YsSUFBSSxFQUFFLHdCQUFXLENBQUMsSUFBSTtZQUN0QixHQUFHLEVBQUUsRUFBRTtZQUNQLFNBQVMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ3JCLFFBQVEsRUFBRSxJQUFJLFVBQVUsQ0FBQyxFQUFFLENBQUM7WUFDNUIsU0FBUyxFQUFFLElBQUksVUFBVSxDQUFDLEVBQUUsQ0FBQztTQUM5QjtRQUNELE9BQU8sRUFBRSxJQUFJLFdBQVcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUM7S0FDM0MsQ0FBQztBQUNKLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvbWVzaC9nb3NzaXAudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRlc3RzIGZvciBHb3NzaXAgUHJvdG9jb2wgSW1wbGVtZW50YXRpb25cbiAqL1xuXG5pbXBvcnQgeyBHb3NzaXBQcm90b2NvbCB9IGZyb20gJy4vZ29zc2lwLmpzJztcbmltcG9ydCB0eXBlIHsgTWVzc2FnZSB9IGZyb20gJy4uL3Byb3RvY29sL21lc3NhZ2UuanMnO1xuaW1wb3J0IHsgTWVzc2FnZVR5cGUgfSBmcm9tICcuLi9wcm90b2NvbC9tZXNzYWdlLmpzJztcblxuZGVzY3JpYmUoJ0dvc3NpcFByb3RvY29sJywgKCkgPT4ge1xuICBsZXQgZ29zc2lwOiBHb3NzaXBQcm90b2NvbDtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBnb3NzaXAgPSBuZXcgR29zc2lwUHJvdG9jb2woe1xuICAgICAgZmFub3V0OiAzLFxuICAgICAgZ29zc2lwSW50ZXJ2YWw6IDEwMCwgLy8gRmFzdCBmb3IgdGVzdGluZ1xuICAgICAgbWF4TWVzc2FnZUFnZTogNTAwMCxcbiAgICAgIHBydW5lSW50ZXJ2YWw6IDEwMDAsXG4gICAgfSk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgZ29zc2lwLnN0b3AoKTtcbiAgICBnb3NzaXAuY2xlYXIoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1BlZXIgTWFuYWdlbWVudCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGFkZCBwZWVycycsICgpID0+IHtcbiAgICAgIGdvc3NpcC5hZGRQZWVyKCdwZWVyMScpO1xuICAgICAgZ29zc2lwLmFkZFBlZXIoJ3BlZXIyJyk7XG4gICAgICBcbiAgICAgIGNvbnN0IHN0YXRzID0gZ29zc2lwLmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMucGVlckNvdW50KS50b0JlKDIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZW1vdmUgcGVlcnMnLCAoKSA9PiB7XG4gICAgICBnb3NzaXAuYWRkUGVlcigncGVlcjEnKTtcbiAgICAgIGdvc3NpcC5hZGRQZWVyKCdwZWVyMicpO1xuICAgICAgZ29zc2lwLnJlbW92ZVBlZXIoJ3BlZXIxJyk7XG4gICAgICBcbiAgICAgIGNvbnN0IHN0YXRzID0gZ29zc2lwLmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMucGVlckNvdW50KS50b0JlKDEpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0cmFjayBhY3RpdmUgcGVlcnMnLCAoKSA9PiB7XG4gICAgICBnb3NzaXAuYWRkUGVlcigncGVlcjEnKTtcbiAgICAgIGNvbnN0IHN0YXRzID0gZ29zc2lwLmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMuYWN0aXZlUGVlckNvdW50KS50b0JlKDEpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnTWVzc2FnZSBIYW5kbGluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJlY2VpdmUgbmV3IG1lc3NhZ2VzJywgKCkgPT4ge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGNyZWF0ZVRlc3RNZXNzYWdlKCd0ZXN0IG1lc3NhZ2UnKTtcbiAgICAgIGNvbnN0IGlzTmV3ID0gZ29zc2lwLnJlY2VpdmVNZXNzYWdlKG1lc3NhZ2UsICdwZWVyMScpO1xuICAgICAgXG4gICAgICBleHBlY3QoaXNOZXcpLnRvQmUodHJ1ZSk7XG4gICAgICBjb25zdCBzdGF0cyA9IGdvc3NpcC5nZXRTdGF0cygpO1xuICAgICAgZXhwZWN0KHN0YXRzLm1lc3NhZ2VDb3VudCkudG9CZSgxKTtcbiAgICAgIGV4cGVjdChzdGF0cy5zZWVuQ291bnQpLnRvQmUoMSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGRldGVjdCBkdXBsaWNhdGUgbWVzc2FnZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gY3JlYXRlVGVzdE1lc3NhZ2UoJ3Rlc3QgbWVzc2FnZScpO1xuICAgICAgXG4gICAgICBjb25zdCBpc05ldzEgPSBnb3NzaXAucmVjZWl2ZU1lc3NhZ2UobWVzc2FnZSwgJ3BlZXIxJyk7XG4gICAgICBjb25zdCBpc05ldzIgPSBnb3NzaXAucmVjZWl2ZU1lc3NhZ2UobWVzc2FnZSwgJ3BlZXIyJyk7XG4gICAgICBcbiAgICAgIGV4cGVjdChpc05ldzEpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QoaXNOZXcyKS50b0JlKGZhbHNlKTsgLy8gRHVwbGljYXRlXG4gICAgICBcbiAgICAgIGNvbnN0IHN0YXRzID0gZ29zc2lwLmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMubWVzc2FnZUNvdW50KS50b0JlKDEpOyAvLyBPbmx5IG9uZSBjb3B5IHN0b3JlZFxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0cmlnZ2VyIG9uTWVzc2FnZSBjYWxsYmFjayBmb3IgbmV3IG1lc3NhZ2VzJywgKCkgPT4ge1xuICAgICAgY29uc3QgY2FsbGJhY2sgPSBqZXN0LmZuKCk7XG4gICAgICBnb3NzaXAub25NZXNzYWdlKGNhbGxiYWNrKTtcbiAgICAgIFxuICAgICAgY29uc3QgbWVzc2FnZSA9IGNyZWF0ZVRlc3RNZXNzYWdlKCd0ZXN0Jyk7XG4gICAgICBnb3NzaXAucmVjZWl2ZU1lc3NhZ2UobWVzc2FnZSwgJ3BlZXIxJyk7XG4gICAgICBcbiAgICAgIGV4cGVjdChjYWxsYmFjaykudG9IYXZlQmVlbkNhbGxlZFdpdGgobWVzc2FnZSwgJ3BlZXIxJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIG5vdCB0cmlnZ2VyIGNhbGxiYWNrIGZvciBkdXBsaWNhdGUgbWVzc2FnZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBjYWxsYmFjayA9IGplc3QuZm4oKTtcbiAgICAgIGdvc3NpcC5vbk1lc3NhZ2UoY2FsbGJhY2spO1xuICAgICAgXG4gICAgICBjb25zdCBtZXNzYWdlID0gY3JlYXRlVGVzdE1lc3NhZ2UoJ3Rlc3QnKTtcbiAgICAgIGdvc3NpcC5yZWNlaXZlTWVzc2FnZShtZXNzYWdlLCAncGVlcjEnKTtcbiAgICAgIGdvc3NpcC5yZWNlaXZlTWVzc2FnZShtZXNzYWdlLCAncGVlcjInKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KGNhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoMSk7IC8vIE9ubHkgb25jZVxuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnR29zc2lwIFByb3RvY29sJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgc3RhcnQgYW5kIHN0b3AgZ29zc2lwIHJvdW5kcycsICgpID0+IHtcbiAgICAgIGdvc3NpcC5zdGFydCgpO1xuICAgICAgZXhwZWN0KGdvc3NpcFsnZ29zc2lwSW50ZXJ2YWwnXSkubm90LnRvQmVOdWxsKCk7XG4gICAgICBcbiAgICAgIGdvc3NpcC5zdG9wKCk7XG4gICAgICBleHBlY3QoZ29zc2lwWydnb3NzaXBJbnRlcnZhbCddKS50b0JlTnVsbCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBub3Qgc3RhcnQgbXVsdGlwbGUgdGltZXMnLCAoKSA9PiB7XG4gICAgICBnb3NzaXAuc3RhcnQoKTtcbiAgICAgIGNvbnN0IGludGVydmFsMSA9IGdvc3NpcFsnZ29zc2lwSW50ZXJ2YWwnXTtcbiAgICAgIFxuICAgICAgZ29zc2lwLnN0YXJ0KCk7XG4gICAgICBjb25zdCBpbnRlcnZhbDIgPSBnb3NzaXBbJ2dvc3NpcEludGVydmFsJ107XG4gICAgICBcbiAgICAgIGV4cGVjdChpbnRlcnZhbDEpLnRvQmUoaW50ZXJ2YWwyKTtcbiAgICAgIGdvc3NpcC5zdG9wKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHBydW5lIG9sZCBtZXNzYWdlcycsICgpID0+IHtcbiAgICAgIGplc3QudXNlRmFrZVRpbWVycygpO1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGNyZWF0ZVRlc3RNZXNzYWdlKCdvbGQgbWVzc2FnZScpO1xuICAgICAgZ29zc2lwLnJlY2VpdmVNZXNzYWdlKG1lc3NhZ2UsICdwZWVyMScpO1xuICAgICAgXG4gICAgICBleHBlY3QoZ29zc2lwLmdldFN0YXRzKCkubWVzc2FnZUNvdW50KS50b0JlKDEpO1xuICAgICAgXG4gICAgICAvLyBBZHZhbmNlIHRpbWUgcGFzdCBtYXhNZXNzYWdlQWdlICg1MDAwbXMgZnJvbSBjb25maWcpXG4gICAgICBqZXN0LmFkdmFuY2VUaW1lcnNCeVRpbWUoNjAwMCk7XG4gICAgICBcbiAgICAgIC8vIFRyaWdnZXIgcHJ1bmUgbWFudWFsbHlcbiAgICAgIGdvc3NpcFsncHJ1bmVPbGRNZXNzYWdlcyddKCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChnb3NzaXAuZ2V0U3RhdHMoKS5tZXNzYWdlQ291bnQpLnRvQmUoMCk7XG4gICAgICBqZXN0LnVzZVJlYWxUaW1lcnMoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1N0YXRpc3RpY3MnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBwcm92aWRlIGFjY3VyYXRlIHN0YXRzJywgKCkgPT4ge1xuICAgICAgZ29zc2lwLmFkZFBlZXIoJ3BlZXIxJyk7XG4gICAgICBnb3NzaXAuYWRkUGVlcigncGVlcjInKTtcbiAgICAgIFxuICAgICAgY29uc3QgbXNnMSA9IGNyZWF0ZVRlc3RNZXNzYWdlKCdtc2cxJyk7XG4gICAgICBjb25zdCBtc2cyID0gY3JlYXRlVGVzdE1lc3NhZ2UoJ21zZzInKTtcbiAgICAgIFxuICAgICAgZ29zc2lwLnJlY2VpdmVNZXNzYWdlKG1zZzEsICdwZWVyMScpO1xuICAgICAgZ29zc2lwLnJlY2VpdmVNZXNzYWdlKG1zZzIsICdwZWVyMicpO1xuICAgICAgXG4gICAgICBjb25zdCBzdGF0cyA9IGdvc3NpcC5nZXRTdGF0cygpO1xuICAgICAgZXhwZWN0KHN0YXRzLnBlZXJDb3VudCkudG9CZSgyKTtcbiAgICAgIGV4cGVjdChzdGF0cy5tZXNzYWdlQ291bnQpLnRvQmUoMik7XG4gICAgICBleHBlY3Qoc3RhdHMuc2VlbkNvdW50KS50b0JlKDIpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQ2xlYXInLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjbGVhciBhbGwgc3RhdGUnLCAoKSA9PiB7XG4gICAgICBnb3NzaXAuYWRkUGVlcigncGVlcjEnKTtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBjcmVhdGVUZXN0TWVzc2FnZSgndGVzdCcpO1xuICAgICAgZ29zc2lwLnJlY2VpdmVNZXNzYWdlKG1lc3NhZ2UsICdwZWVyMScpO1xuICAgICAgXG4gICAgICBnb3NzaXAuY2xlYXIoKTtcbiAgICAgIFxuICAgICAgY29uc3Qgc3RhdHMgPSBnb3NzaXAuZ2V0U3RhdHMoKTtcbiAgICAgIGV4cGVjdChzdGF0cy5wZWVyQ291bnQpLnRvQmUoMCk7XG4gICAgICBleHBlY3Qoc3RhdHMubWVzc2FnZUNvdW50KS50b0JlKDApO1xuICAgICAgZXhwZWN0KHN0YXRzLnNlZW5Db3VudCkudG9CZSgwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuLyoqXG4gKiBIZWxwZXIgdG8gY3JlYXRlIGEgdGVzdCBtZXNzYWdlXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVRlc3RNZXNzYWdlKGNvbnRlbnQ6IHN0cmluZyk6IE1lc3NhZ2Uge1xuICByZXR1cm4ge1xuICAgIGhlYWRlcjoge1xuICAgICAgdmVyc2lvbjogMSxcbiAgICAgIHR5cGU6IE1lc3NhZ2VUeXBlLlRFWFQsXG4gICAgICB0dGw6IDEwLFxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgc2VuZGVySWQ6IG5ldyBVaW50OEFycmF5KDMyKSxcbiAgICAgIHNpZ25hdHVyZTogbmV3IFVpbnQ4QXJyYXkoNjQpLFxuICAgIH0sXG4gICAgcGF5bG9hZDogbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKGNvbnRlbnQpLFxuICB9O1xufVxuIl0sInZlcnNpb24iOjN9