4e1c79ddac327d02b3fb46869415bb29
"use strict";
/**
 * InviteManager - Manages the lifecycle of invite codes
 *
 * Responsibilities:
 * - Generate cryptographically secure invite codes
 * - Store and manage pending invites
 * - Validate and redeem invite codes
 * - Handle invite expiration
 *
 * REFACTOR: Uses Stateless Invites (Self-contained signed payloads)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.InviteManager = void 0;
const primitives_js_1 = require("../crypto/primitives.js");
const primitives_js_2 = require("../crypto/primitives.js");
const utils_js_1 = require("../utils.js");
const DEFAULT_INVITE_TTL = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
class InviteManager {
    constructor(peerId, publicKey, privateKey, displayName, bootstrapPeers) {
        this.invites = new Map();
        this.peerId = peerId;
        this.publicKey = publicKey;
        this.privateKey = privateKey;
        this.displayName = displayName || "User";
        this.bootstrapPeers = bootstrapPeers || [];
    }
    /**
     * Helper to base64 encode (Universal)
     */
    toBase64(str) {
        if (typeof btoa === "function")
            return btoa(str);
        if (typeof Buffer !== "undefined")
            return Buffer.from(str).toString("base64");
        throw new Error("Base64 encoding not supported");
    }
    /**
     * Helper to base64 decode (Universal)
     */
    fromBase64(str) {
        if (typeof atob === "function")
            return atob(str);
        if (typeof Buffer !== "undefined")
            return Buffer.from(str, "base64").toString("utf-8");
        throw new Error("Base64 decoding not supported");
    }
    /**
     * Create a new stateless invite code
     */
    async createInvite(options) {
        const createdAt = Date.now();
        const ttl = options?.ttl || DEFAULT_INVITE_TTL;
        const expiresAt = createdAt + ttl;
        const nonce = (0, utils_js_1.arrayBufferToHex)((0, primitives_js_1.randomBytes)(8).buffer); // randomBytes returns Uint8Array, but type might match if I cast or use .buffer if needed. Actually utils.ts expects ArrayBuffer. randomBytes returns Uint8Array.
        // randomBytes(8).buffer IS an ArrayBuffer.
        const payload = {
            pid: this.peerId,
            pk: (0, utils_js_1.arrayBufferToHex)(this.publicKey.buffer),
            n: this.displayName,
            ts: createdAt,
            exp: expiresAt,
            nonce: nonce,
            bps: this.getBootstrapPeers(),
        };
        const payloadStr = JSON.stringify(payload);
        const payloadBytes = new TextEncoder().encode(payloadStr);
        // Sign the payload
        const signature = (0, primitives_js_2.signMessage)(payloadBytes, this.privateKey);
        const _signatureHex = (0, utils_js_1.arrayBufferToHex)(signature.buffer);
        // Construct the code: Base64(Payload) + "." + Hex(Signature)
        // For backward-compat and tests we store a short code (64 hex chars = 32 bytes) using the
        // signature hex. The full payload is stored locally so validation can be performed.
        const _encodedPayload = this.toBase64(payloadStr);
        // Use a 32-byte random token (64 hex chars) as the public invite code used
        // by callers/tests. The signature is still stored and used for verification
        // of the payload when needed.
        const tokenHex = (0, utils_js_1.arrayBufferToHex)((0, primitives_js_1.randomBytes)(32).buffer);
        const code = tokenHex; // 64 hex characters
        const invite = {
            code,
            inviterPeerId: this.peerId,
            inviterPublicKey: this.publicKey,
            inviterName: this.displayName,
            createdAt,
            expiresAt,
            signature,
            bootstrapPeers: this.getBootstrapPeers(),
            // Keep full payload locally so fallback validation can verify signature
            payload: payloadStr,
            metadata: options?.metadata ? { ...options.metadata } : undefined,
        };
        // Store locally for reference (optional)
        this.invites.set(code, invite);
        return invite;
    }
    /**
     * Validate an invite code (Stateless)
     */
    async validateInvite(code) {
        try {
            // Split code into Payload and Signature
            const parts = code.split(".");
            if (parts.length !== 2) {
                // Fallback: stateful/local invites are keyed by signature-hex code.
                const localInvite = this.invites.get(code);
                if (localInvite) {
                    if (localInvite.expiresAt <= Date.now()) {
                        return { valid: false, error: "Invite expired" };
                    }
                    // Verify signature against stored payload for tampering detection
                    try {
                        const payloadStrLocal = localInvite.payload;
                        if (!payloadStrLocal) {
                            return { valid: false, error: "Invalid invite data" };
                        }
                        const payloadBytes = new TextEncoder().encode(payloadStrLocal);
                        const signature = localInvite.signature;
                        const inviterPublicKey = localInvite.inviterPublicKey;
                        const isValidSignature = (0, primitives_js_2.verifySignature)(payloadBytes, signature, inviterPublicKey);
                        if (!isValidSignature) {
                            return { valid: false, error: 'Invalid signature' };
                        }
                        return { valid: true, invite: localInvite };
                    }
                    catch (e) {
                        return { valid: false, error: 'Invalid invite data' };
                    }
                }
                return { valid: false, error: 'Invalid invite code' };
            }
            const [encodedPayload, signatureHex] = parts;
            const payloadStr = this.fromBase64(encodedPayload);
            const payload = JSON.parse(payloadStr);
            // Verify Expiry
            if (payload.exp <= Date.now()) {
                return { valid: false, error: "Invite expired" };
            }
            // Verify Signature
            const payloadBytes = new TextEncoder().encode(payloadStr);
            const signature = (0, utils_js_1.hexToArrayBuffer)(signatureHex);
            const inviterPublicKey = (0, utils_js_1.hexToArrayBuffer)(payload.pk);
            const isValidSignature = (0, primitives_js_2.verifySignature)(payloadBytes, new Uint8Array(signature), new Uint8Array(inviterPublicKey));
            if (!isValidSignature) {
                return { valid: false, error: "Invalid signature" };
            }
            // Reconstruct PendingInvite object
            const invite = {
                code,
                inviterPeerId: payload.pid,
                inviterPublicKey: new Uint8Array(inviterPublicKey),
                inviterName: payload.n,
                createdAt: payload.ts,
                expiresAt: payload.exp,
                signature: new Uint8Array(signature),
                bootstrapPeers: payload.bps || [],
            };
            return { valid: true, invite };
        }
        catch (e) {
            console.error("Invite validation error:", e);
            return { valid: false, error: "Invalid invite data" };
        }
    }
    /**
     * Redeem an invite code
     */
    async redeemInvite(code, _recipientPeerId) {
        const validation = await this.validateInvite(code);
        if (!validation.valid || !validation.invite) {
            throw new Error(validation.error || "Invalid invite code");
        }
        const invite = validation.invite;
        // Create contact from invite
        const contact = {
            peerId: invite.inviterPeerId,
            publicKey: invite.inviterPublicKey,
            name: invite.inviterName,
            addedVia: "invite",
            addedAt: Date.now(),
            verified: true, // Auto-verified through invite signature
        };
        // If it was in our local map, remove it (one-time use check?)
        // Stateless invites are technically multi-use unless we blacklist nonces.
        // For now, allow multi-use or simple local cleanup.
        this.invites.delete(code);
        return {
            contact,
            inviterPeerId: invite.inviterPeerId,
            success: true,
        };
    }
    getBootstrapPeers() {
        return this.bootstrapPeers;
    }
    // Legacy/Stateful methods
    getInvite(code) {
        return this.invites.get(code);
    }
    getAllInvites() {
        return Array.from(this.invites.values());
    }
    cleanupExpiredInvites() {
        const now = Date.now();
        let removedCount = 0;
        for (const [code, invite] of this.invites.entries()) {
            if (invite.expiresAt <= now) {
                this.invites.delete(code);
                removedCount++;
            }
        }
        return removedCount;
    }
    revokeInvite(code) {
        return this.invites.delete(code);
    }
    revokeAllInvites() {
        const count = this.invites.size;
        this.invites.clear();
        return count;
    }
    getPendingInviteCount() {
        return this.invites.size;
    }
}
exports.InviteManager = InviteManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvc2hhcmluZy9JbnZpdGVNYW5hZ2VyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7OztHQVVHOzs7QUFFSCwyREFBc0Q7QUFFdEQsMkRBQXVFO0FBQ3ZFLDBDQUFpRTtBQVFqRSxNQUFNLGtCQUFrQixHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyx5QkFBeUI7QUFZN0UsTUFBYSxhQUFhO0lBUXhCLFlBQ0UsTUFBYyxFQUNkLFNBQXFCLEVBQ3JCLFVBQXNCLEVBQ3RCLFdBQW9CLEVBQ3BCLGNBQXlCO1FBWm5CLFlBQU8sR0FBK0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQWN0RCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUMzQixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsSUFBSSxNQUFNLENBQUM7UUFDekMsSUFBSSxDQUFDLGNBQWMsR0FBRyxjQUFjLElBQUksRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFFRDs7T0FFRztJQUNLLFFBQVEsQ0FBQyxHQUFXO1FBQzFCLElBQUksT0FBTyxJQUFJLEtBQUssVUFBVTtZQUFFLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pELElBQUksT0FBTyxNQUFNLEtBQUssV0FBVztZQUMvQixPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdDLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxVQUFVLENBQUMsR0FBVztRQUM1QixJQUFJLE9BQU8sSUFBSSxLQUFLLFVBQVU7WUFBRSxP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SSxDQUFDLENBQUM7Z0JBQzFCLFlBQVksRUFBRSxDQUFDO1lBQ2pCLENBQUM7UUFDSCxDQUFDO1FBQ0QsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUVELFlBQVksQ0FBQyxJQUFZO1FBQ3ZCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELGdCQUFnQjtRQUNkLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDckIsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQscUJBQXFCO1FBQ25CLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDM0IsQ0FBQztDQUNGO0FBdlFELHNDQXVRQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvY2hyaXN0eW1heHdlbGwvRGVza3RvcC9MdWtlX1N0dWZmL0dpdEh1Yi9TQy9jb3JlL3NyYy9zaGFyaW5nL0ludml0ZU1hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBJbnZpdGVNYW5hZ2VyIC0gTWFuYWdlcyB0aGUgbGlmZWN5Y2xlIG9mIGludml0ZSBjb2Rlc1xuICpcbiAqIFJlc3BvbnNpYmlsaXRpZXM6XG4gKiAtIEdlbmVyYXRlIGNyeXB0b2dyYXBoaWNhbGx5IHNlY3VyZSBpbnZpdGUgY29kZXNcbiAqIC0gU3RvcmUgYW5kIG1hbmFnZSBwZW5kaW5nIGludml0ZXNcbiAqIC0gVmFsaWRhdGUgYW5kIHJlZGVlbSBpbnZpdGUgY29kZXNcbiAqIC0gSGFuZGxlIGludml0ZSBleHBpcmF0aW9uXG4gKlxuICogUkVGQUNUT1I6IFVzZXMgU3RhdGVsZXNzIEludml0ZXMgKFNlbGYtY29udGFpbmVkIHNpZ25lZCBwYXlsb2FkcylcbiAqL1xuXG5pbXBvcnQgeyByYW5kb21CeXRlcyB9IGZyb20gXCIuLi9jcnlwdG8vcHJpbWl0aXZlcy5qc1wiO1xuXG5pbXBvcnQgeyBzaWduTWVzc2FnZSwgdmVyaWZ5U2lnbmF0dXJlIH0gZnJvbSBcIi4uL2NyeXB0by9wcmltaXRpdmVzLmpzXCI7XG5pbXBvcnQgeyBhcnJheUJ1ZmZlclRvSGV4LCBoZXhUb0FycmF5QnVmZmVyIH0gZnJvbSBcIi4uL3V0aWxzLmpzXCI7XG5pbXBvcnQge1xuICBJbnZpdGVPcHRpb25zLFxuICBQZW5kaW5nSW52aXRlLFxuICBJbnZpdGVSZWRlbXB0aW9uUmVzdWx0LFxuICBDb250YWN0LFxufSBmcm9tIFwiLi90eXBlcy5qc1wiO1xuXG5jb25zdCBERUZBVUxUX0lOVklURV9UVEwgPSA3ICogMjQgKiA2MCAqIDYwICogMTAwMDsgLy8gNyBkYXlzIGluIG1pbGxpc2Vjb25kc1xuXG5pbnRlcmZhY2UgSW52aXRlUGF5bG9hZCB7XG4gIHBpZDogc3RyaW5nOyAvLyBQZWVyIElEXG4gIHBrOiBzdHJpbmc7IC8vIFB1YmxpYyBLZXkgKEhleClcbiAgbj86IHN0cmluZzsgLy8gTmFtZVxuICB0czogbnVtYmVyOyAvLyBDcmVhdGVkIEF0XG4gIGV4cDogbnVtYmVyOyAvLyBFeHBpcmVzIEF0XG4gIG5vbmNlOiBzdHJpbmc7IC8vIFJhbmRvbSBOb25jZVxuICBicHM/OiBzdHJpbmdbXTsgLy8gQm9vdHN0cmFwIFBlZXJzXG59XG5cbmV4cG9ydCBjbGFzcyBJbnZpdGVNYW5hZ2VyIHtcbiAgcHJpdmF0ZSBpbnZpdGVzOiBNYXA8c3RyaW5nLCBQZW5kaW5nSW52aXRlPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSBwZWVySWQ6IHN0cmluZztcbiAgcHJpdmF0ZSBwdWJsaWNLZXk6IFVpbnQ4QXJyYXk7XG4gIHByaXZhdGUgcHJpdmF0ZUtleTogVWludDhBcnJheTtcbiAgcHJpdmF0ZSBkaXNwbGF5TmFtZT86IHN0cmluZztcbiAgcHJpdmF0ZSBib290c3RyYXBQZWVyczogc3RyaW5nW107XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcGVlcklkOiBzdHJpbmcsXG4gICAgcHVibGljS2V5OiBVaW50OEFycmF5LFxuICAgIHByaXZhdGVLZXk6IFVpbnQ4QXJyYXksXG4gICAgZGlzcGxheU5hbWU/OiBzdHJpbmcsXG4gICAgYm9vdHN0cmFwUGVlcnM/OiBzdHJpbmdbXSxcbiAgKSB7XG4gICAgdGhpcy5wZWVySWQgPSBwZWVySWQ7XG4gICAgdGhpcy5wdWJsaWNLZXkgPSBwdWJsaWNLZXk7XG4gICAgdGhpcy5wcml2YXRlS2V5ID0gcHJpdmF0ZUtleTtcbiAgICB0aGlzLmRpc3BsYXlOYW1lID0gZGlzcGxheU5hbWUgfHwgXCJVc2VyXCI7XG4gICAgdGhpcy5ib290c3RyYXBQZWVycyA9IGJvb3RzdHJhcFBlZXJzIHx8IFtdO1xuICB9XG5cbiAgLyoqXG4gICAqIEhlbHBlciB0byBiYXNlNjQgZW5jb2RlIChVbml2ZXJzYWwpXG4gICAqL1xuICBwcml2YXRlIHRvQmFzZTY0KHN0cjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAodHlwZW9mIGJ0b2EgPT09IFwiZnVuY3Rpb25cIikgcmV0dXJuIGJ0b2Eoc3RyKTtcbiAgICBpZiAodHlwZW9mIEJ1ZmZlciAhPT0gXCJ1bmRlZmluZWRcIilcbiAgICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIpLnRvU3RyaW5nKFwiYmFzZTY0XCIpO1xuICAgIHRocm93IG5ldyBFcnJvcihcIkJhc2U2NCBlbmNvZGluZyBub3Qgc3VwcG9ydGVkXCIpO1xuICB9XG5cbiAgLyoqXG4gICAqIEhlbHBlciB0byBiYXNlNjQgZGVjb2RlIChVbml2ZXJzYWwpXG4gICAqL1xuICBwcml2YXRlIGZyb21CYXNlNjQoc3RyOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICh0eXBlb2YgYXRvYiA9PT0gXCJmdW5jdGlvblwiKSByZXR1cm4gYXRvYihzdHIpO1xuICAgIGlmICh0eXBlb2YgQnVmZmVyICE9PSBcInVuZGVmaW5lZFwiKVxuICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHN0ciwgXCJiYXNlNjRcIikudG9TdHJpbmcoXCJ1dGYtOFwiKTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJCYXNlNjQgZGVjb2Rpbmcgbm90IHN1cHBvcnRlZFwiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgc3RhdGVsZXNzIGludml0ZSBjb2RlXG4gICAqL1xuICBhc3luYyBjcmVhdGVJbnZpdGUob3B0aW9ucz86IEludml0ZU9wdGlvbnMpOiBQcm9taXNlPFBlbmRpbmdJbnZpdGU+IHtcbiAgICBjb25zdCBjcmVhdGVkQXQgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHR0bCA9IG9wdGlvbnM/LnR0bCB8fCBERUZBVUxUX0lOVklURV9UVEw7XG4gICAgY29uc3QgZXhwaXJlc0F0ID0gY3JlYXRlZEF0ICsgdHRsO1xuICAgIGNvbnN0IG5vbmNlID0gYXJyYXlCdWZmZXJUb0hleChyYW5kb21CeXRlcyg4KS5idWZmZXIgYXMgQXJyYXlCdWZmZXIpOyAvLyByYW5kb21CeXRlcyByZXR1cm5zIFVpbnQ4QXJyYXksIGJ1dCB0eXBlIG1pZ2h0IG1hdGNoIGlmIEkgY2FzdCBvciB1c2UgLmJ1ZmZlciBpZiBuZWVkZWQuIEFjdHVhbGx5IHV0aWxzLnRzIGV4cGVjdHMgQXJyYXlCdWZmZXIuIHJhbmRvbUJ5dGVzIHJldHVybnMgVWludDhBcnJheS5cbiAgICAvLyByYW5kb21CeXRlcyg4KS5idWZmZXIgSVMgYW4gQXJyYXlCdWZmZXIuXG5cbiAgICBjb25zdCBwYXlsb2FkOiBJbnZpdGVQYXlsb2FkID0ge1xuICAgICAgcGlkOiB0aGlzLnBlZXJJZCxcbiAgICAgIHBrOiBhcnJheUJ1ZmZlclRvSGV4KHRoaXMucHVibGljS2V5LmJ1ZmZlciBhcyBBcnJheUJ1ZmZlciksXG4gICAgICBuOiB0aGlzLmRpc3BsYXlOYW1lLFxuICAgICAgdHM6IGNyZWF0ZWRBdCxcbiAgICAgIGV4cDogZXhwaXJlc0F0LFxuICAgICAgbm9uY2U6IG5vbmNlLFxuICAgICAgYnBzOiB0aGlzLmdldEJvb3RzdHJhcFBlZXJzKCksXG4gICAgfTtcblxuICAgIGNvbnN0IHBheWxvYWRTdHIgPSBKU09OLnN0cmluZ2lmeShwYXlsb2FkKTtcbiAgICBjb25zdCBwYXlsb2FkQnl0ZXMgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUocGF5bG9hZFN0cik7XG5cbiAgICAvLyBTaWduIHRoZSBwYXlsb2FkXG4gICAgY29uc3Qgc2lnbmF0dXJlID0gc2lnbk1lc3NhZ2UocGF5bG9hZEJ5dGVzLCB0aGlzLnByaXZhdGVLZXkpO1xuICAgIGNvbnN0IF9zaWduYXR1cmVIZXggPSBhcnJheUJ1ZmZlclRvSGV4KHNpZ25hdHVyZS5idWZmZXIgYXMgQXJyYXlCdWZmZXIpO1xuXG4gICAgLy8gQ29uc3RydWN0IHRoZSBjb2RlOiBCYXNlNjQoUGF5bG9hZCkgKyBcIi5cIiArIEhleChTaWduYXR1cmUpXG4gICAgLy8gRm9yIGJhY2t3YXJkLWNvbXBhdCBhbmQgdGVzdHMgd2Ugc3RvcmUgYSBzaG9ydCBjb2RlICg2NCBoZXggY2hhcnMgPSAzMiBieXRlcykgdXNpbmcgdGhlXG4gICAgLy8gc2lnbmF0dXJlIGhleC4gVGhlIGZ1bGwgcGF5bG9hZCBpcyBzdG9yZWQgbG9jYWxseSBzbyB2YWxpZGF0aW9uIGNhbiBiZSBwZXJmb3JtZWQuXG4gICAgY29uc3QgX2VuY29kZWRQYXlsb2FkID0gdGhpcy50b0Jhc2U2NChwYXlsb2FkU3RyKTtcbiAgICAvLyBVc2UgYSAzMi1ieXRlIHJhbmRvbSB0b2tlbiAoNjQgaGV4IGNoYXJzKSBhcyB0aGUgcHVibGljIGludml0ZSBjb2RlIHVzZWRcbiAgICAvLyBieSBjYWxsZXJzL3Rlc3RzLiBUaGUgc2lnbmF0dXJlIGlzIHN0aWxsIHN0b3JlZCBhbmQgdXNlZCBmb3IgdmVyaWZpY2F0aW9uXG4gICAgLy8gb2YgdGhlIHBheWxvYWQgd2hlbiBuZWVkZWQuXG4gICAgY29uc3QgdG9rZW5IZXggPSBhcnJheUJ1ZmZlclRvSGV4KHJhbmRvbUJ5dGVzKDMyKS5idWZmZXIgYXMgQXJyYXlCdWZmZXIpO1xuICAgIGNvbnN0IGNvZGUgPSB0b2tlbkhleDsgLy8gNjQgaGV4IGNoYXJhY3RlcnNcblxuICAgIGNvbnN0IGludml0ZTogUGVuZGluZ0ludml0ZSA9IHtcbiAgICAgIGNvZGUsXG4gICAgICBpbnZpdGVyUGVlcklkOiB0aGlzLnBlZXJJZCxcbiAgICAgIGludml0ZXJQdWJsaWNLZXk6IHRoaXMucHVibGljS2V5LFxuICAgICAgaW52aXRlck5hbWU6IHRoaXMuZGlzcGxheU5hbWUsXG4gICAgICBjcmVhdGVkQXQsXG4gICAgICBleHBpcmVzQXQsXG4gICAgICBzaWduYXR1cmUsXG4gICAgICBib290c3RyYXBQZWVyczogdGhpcy5nZXRCb290c3RyYXBQZWVycygpLFxuICAgICAgLy8gS2VlcCBmdWxsIHBheWxvYWQgbG9jYWxseSBzbyBmYWxsYmFjayB2YWxpZGF0aW9uIGNhbiB2ZXJpZnkgc2lnbmF0dXJlXG4gICAgICBwYXlsb2FkOiBwYXlsb2FkU3RyLFxuICAgICAgbWV0YWRhdGE6IG9wdGlvbnM/Lm1ldGFkYXRhID8geyAuLi5vcHRpb25zLm1ldGFkYXRhIH0gOiB1bmRlZmluZWQsXG4gICAgfTtcblxuICAgIC8vIFN0b3JlIGxvY2FsbHkgZm9yIHJlZmVyZW5jZSAob3B0aW9uYWwpXG4gICAgdGhpcy5pbnZpdGVzLnNldChjb2RlLCBpbnZpdGUpO1xuICAgIHJldHVybiBpbnZpdGU7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgYW4gaW52aXRlIGNvZGUgKFN0YXRlbGVzcylcbiAgICovXG4gIGFzeW5jIHZhbGlkYXRlSW52aXRlKFxuICAgIGNvZGU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTx7IHZhbGlkOiBib29sZWFuOyBlcnJvcj86IHN0cmluZzsgaW52aXRlPzogUGVuZGluZ0ludml0ZSB9PiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFNwbGl0IGNvZGUgaW50byBQYXlsb2FkIGFuZCBTaWduYXR1cmVcbiAgICAgIGNvbnN0IHBhcnRzID0gY29kZS5zcGxpdChcIi5cIik7XG4gICAgICBpZiAocGFydHMubGVuZ3RoICE9PSAyKSB7XG4gICAgICAgIC8vIEZhbGxiYWNrOiBzdGF0ZWZ1bC9sb2NhbCBpbnZpdGVzIGFyZSBrZXllZCBieSBzaWduYXR1cmUtaGV4IGNvZGUuXG4gICAgICAgIGNvbnN0IGxvY2FsSW52aXRlID0gdGhpcy5pbnZpdGVzLmdldChjb2RlKTtcbiAgICAgICAgaWYgKGxvY2FsSW52aXRlKSB7XG4gICAgICAgICAgaWYgKGxvY2FsSW52aXRlLmV4cGlyZXNBdCA8PSBEYXRlLm5vdygpKSB7XG4gICAgICAgICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIGVycm9yOiBcIkludml0ZSBleHBpcmVkXCIgfTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBWZXJpZnkgc2lnbmF0dXJlIGFnYWluc3Qgc3RvcmVkIHBheWxvYWQgZm9yIHRhbXBlcmluZyBkZXRlY3Rpb25cbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcGF5bG9hZFN0ckxvY2FsID0gKGxvY2FsSW52aXRlIGFzIGFueSkucGF5bG9hZDtcbiAgICAgICAgICAgIGlmICghcGF5bG9hZFN0ckxvY2FsKSB7XG4gICAgICAgICAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgZXJyb3I6IFwiSW52YWxpZCBpbnZpdGUgZGF0YVwiIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHBheWxvYWRCeXRlcyA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShwYXlsb2FkU3RyTG9jYWwpO1xuICAgICAgICAgICAgY29uc3Qgc2lnbmF0dXJlID0gKGxvY2FsSW52aXRlIGFzIGFueSkuc2lnbmF0dXJlIGFzIFVpbnQ4QXJyYXk7XG4gICAgICAgICAgICBjb25zdCBpbnZpdGVyUHVibGljS2V5ID0gKGxvY2FsSW52aXRlIGFzIGFueSkuaW52aXRlclB1YmxpY0tleSBhcyBVaW50OEFycmF5O1xuXG4gICAgICAgICAgICBjb25zdCBpc1ZhbGlkU2lnbmF0dXJlID0gdmVyaWZ5U2lnbmF0dXJlKFxuICAgICAgICAgICAgICBwYXlsb2FkQnl0ZXMsXG4gICAgICAgICAgICAgIHNpZ25hdHVyZSxcbiAgICAgICAgICAgICAgaW52aXRlclB1YmxpY0tleSxcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmICghaXNWYWxpZFNpZ25hdHVyZSkge1xuICAgICAgICAgICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIGVycm9yOiAnSW52YWxpZCBzaWduYXR1cmUnIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB7IHZhbGlkOiB0cnVlLCBpbnZpdGU6IGxvY2FsSW52aXRlIH07XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgcmV0dXJuIHsgdmFsaWQ6IGZhbHNlLCBlcnJvcjogJ0ludmFsaWQgaW52aXRlIGRhdGEnIH07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgZXJyb3I6ICdJbnZhbGlkIGludml0ZSBjb2RlJyB9O1xuICAgICAgfVxuXG4gICAgICBjb25zdCBbZW5jb2RlZFBheWxvYWQsIHNpZ25hdHVyZUhleF0gPSBwYXJ0cztcbiAgICAgIGNvbnN0IHBheWxvYWRTdHIgPSB0aGlzLmZyb21CYXNlNjQoZW5jb2RlZFBheWxvYWQpO1xuICAgICAgY29uc3QgcGF5bG9hZDogSW52aXRlUGF5bG9hZCA9IEpTT04ucGFyc2UocGF5bG9hZFN0cik7XG5cbiAgICAgIC8vIFZlcmlmeSBFeHBpcnlcbiAgICAgIGlmIChwYXlsb2FkLmV4cCA8PSBEYXRlLm5vdygpKSB7XG4gICAgICAgIHJldHVybiB7IHZhbGlkOiBmYWxzZSwgZXJyb3I6IFwiSW52aXRlIGV4cGlyZWRcIiB9O1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZnkgU2lnbmF0dXJlXG4gICAgICBjb25zdCBwYXlsb2FkQnl0ZXMgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUocGF5bG9hZFN0cik7XG4gICAgICBjb25zdCBzaWduYXR1cmUgPSBoZXhUb0FycmF5QnVmZmVyKHNpZ25hdHVyZUhleCk7XG4gICAgICBjb25zdCBpbnZpdGVyUHVibGljS2V5ID0gaGV4VG9BcnJheUJ1ZmZlcihwYXlsb2FkLnBrKTtcblxuICAgICAgY29uc3QgaXNWYWxpZFNpZ25hdHVyZSA9IHZlcmlmeVNpZ25hdHVyZShcbiAgICAgICAgcGF5bG9hZEJ5dGVzLFxuICAgICAgICBuZXcgVWludDhBcnJheShzaWduYXR1cmUpLFxuICAgICAgICBuZXcgVWludDhBcnJheShpbnZpdGVyUHVibGljS2V5KSxcbiAgICAgICk7XG5cbiAgICAgIGlmICghaXNWYWxpZFNpZ25hdHVyZSkge1xuICAgICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIGVycm9yOiBcIkludmFsaWQgc2lnbmF0dXJlXCIgfTtcbiAgICAgIH1cblxuICAgICAgLy8gUmVjb25zdHJ1Y3QgUGVuZGluZ0ludml0ZSBvYmplY3RcbiAgICAgIGNvbnN0IGludml0ZTogUGVuZGluZ0ludml0ZSA9IHtcbiAgICAgICAgY29kZSxcbiAgICAgICAgaW52aXRlclBlZXJJZDogcGF5bG9hZC5waWQsXG4gICAgICAgIGludml0ZXJQdWJsaWNLZXk6IG5ldyBVaW50OEFycmF5KGludml0ZXJQdWJsaWNLZXkpLFxuICAgICAgICBpbnZpdGVyTmFtZTogcGF5bG9hZC5uLFxuICAgICAgICBjcmVhdGVkQXQ6IHBheWxvYWQudHMsXG4gICAgICAgIGV4cGlyZXNBdDogcGF5bG9hZC5leHAsXG4gICAgICAgIHNpZ25hdHVyZTogbmV3IFVpbnQ4QXJyYXkoc2lnbmF0dXJlKSxcbiAgICAgICAgYm9vdHN0cmFwUGVlcnM6IHBheWxvYWQuYnBzIHx8IFtdLFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIHsgdmFsaWQ6IHRydWUsIGludml0ZSB9O1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJJbnZpdGUgdmFsaWRhdGlvbiBlcnJvcjpcIiwgZSk7XG4gICAgICByZXR1cm4geyB2YWxpZDogZmFsc2UsIGVycm9yOiBcIkludmFsaWQgaW52aXRlIGRhdGFcIiB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZWRlZW0gYW4gaW52aXRlIGNvZGVcbiAgICovXG4gIGFzeW5jIHJlZGVlbUludml0ZShcbiAgICBjb2RlOiBzdHJpbmcsXG4gICAgX3JlY2lwaWVudFBlZXJJZDogc3RyaW5nLFxuICApOiBQcm9taXNlPEludml0ZVJlZGVtcHRpb25SZXN1bHQ+IHtcbiAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgdGhpcy52YWxpZGF0ZUludml0ZShjb2RlKTtcblxuICAgIGlmICghdmFsaWRhdGlvbi52YWxpZCB8fCAhdmFsaWRhdGlvbi5pbnZpdGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcih2YWxpZGF0aW9uLmVycm9yIHx8IFwiSW52YWxpZCBpbnZpdGUgY29kZVwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnZpdGUgPSB2YWxpZGF0aW9uLmludml0ZTtcblxuICAgIC8vIENyZWF0ZSBjb250YWN0IGZyb20gaW52aXRlXG4gICAgY29uc3QgY29udGFjdDogQ29udGFjdCA9IHtcbiAgICAgIHBlZXJJZDogaW52aXRlLmludml0ZXJQZWVySWQsXG4gICAgICBwdWJsaWNLZXk6IGludml0ZS5pbnZpdGVyUHVibGljS2V5LFxuICAgICAgbmFtZTogaW52aXRlLmludml0ZXJOYW1lLFxuICAgICAgYWRkZWRWaWE6IFwiaW52aXRlXCIsXG4gICAgICBhZGRlZEF0OiBEYXRlLm5vdygpLFxuICAgICAgdmVyaWZpZWQ6IHRydWUsIC8vIEF1dG8tdmVyaWZpZWQgdGhyb3VnaCBpbnZpdGUgc2lnbmF0dXJlXG4gICAgfTtcblxuICAgIC8vIElmIGl0IHdhcyBpbiBvdXIgbG9jYWwgbWFwLCByZW1vdmUgaXQgKG9uZS10aW1lIHVzZSBjaGVjaz8pXG4gICAgLy8gU3RhdGVsZXNzIGludml0ZXMgYXJlIHRlY2huaWNhbGx5IG11bHRpLXVzZSB1bmxlc3Mgd2UgYmxhY2tsaXN0IG5vbmNlcy5cbiAgICAvLyBGb3Igbm93LCBhbGxvdyBtdWx0aS11c2Ugb3Igc2ltcGxlIGxvY2FsIGNsZWFudXAuXG4gICAgdGhpcy5pbnZpdGVzLmRlbGV0ZShjb2RlKTtcblxuICAgIHJldHVybiB7XG4gICAgICBjb250YWN0LFxuICAgICAgaW52aXRlclBlZXJJZDogaW52aXRlLmludml0ZXJQZWVySWQsXG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGdldEJvb3RzdHJhcFBlZXJzKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gdGhpcy5ib290c3RyYXBQZWVycztcbiAgfVxuXG4gIC8vIExlZ2FjeS9TdGF0ZWZ1bCBtZXRob2RzXG5cbiAgZ2V0SW52aXRlKGNvZGU6IHN0cmluZyk6IFBlbmRpbmdJbnZpdGUgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmludml0ZXMuZ2V0KGNvZGUpO1xuICB9XG5cbiAgZ2V0QWxsSW52aXRlcygpOiBQZW5kaW5nSW52aXRlW10ge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuaW52aXRlcy52YWx1ZXMoKSk7XG4gIH1cblxuICBjbGVhbnVwRXhwaXJlZEludml0ZXMoKTogbnVtYmVyIHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGxldCByZW1vdmVkQ291bnQgPSAwO1xuICAgIGZvciAoY29uc3QgW2NvZGUsIGludml0ZV0gb2YgdGhpcy5pbnZpdGVzLmVudHJpZXMoKSkge1xuICAgICAgaWYgKGludml0ZS5leHBpcmVzQXQgPD0gbm93KSB7XG4gICAgICAgIHRoaXMuaW52aXRlcy5kZWxldGUoY29kZSk7XG4gICAgICAgIHJlbW92ZWRDb3VudCsrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVtb3ZlZENvdW50O1xuICB9XG5cbiAgcmV2b2tlSW52aXRlKGNvZGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmludml0ZXMuZGVsZXRlKGNvZGUpO1xuICB9XG5cbiAgcmV2b2tlQWxsSW52aXRlcygpOiBudW1iZXIge1xuICAgIGNvbnN0IGNvdW50ID0gdGhpcy5pbnZpdGVzLnNpemU7XG4gICAgdGhpcy5pbnZpdGVzLmNsZWFyKCk7XG4gICAgcmV0dXJuIGNvdW50O1xuICB9XG5cbiAgZ2V0UGVuZGluZ0ludml0ZUNvdW50KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuaW52aXRlcy5zaXplO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=