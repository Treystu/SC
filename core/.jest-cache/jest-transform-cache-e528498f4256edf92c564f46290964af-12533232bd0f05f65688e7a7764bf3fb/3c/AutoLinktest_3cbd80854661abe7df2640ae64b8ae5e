3d4f22c4c5da3b32b2a64724fcd214d5
"use strict";
/**
 * Tests for AutoLink
 */
Object.defineProperty(exports, "__esModule", { value: true });
const AutoLink_1 = require("./AutoLink");
const InviteManager_1 = require("./InviteManager");
const primitives_1 = require("../crypto/primitives");
// Mock ContactStore implementation
class MockContactStore {
    constructor() {
        this.contacts = new Map();
    }
    async add(contact) {
        this.contacts.set(contact.peerId, contact);
    }
    async get(peerId) {
        return this.contacts.get(peerId) || null;
    }
    async has(peerId) {
        return this.contacts.has(peerId);
    }
    getAll() {
        return Array.from(this.contacts.values());
    }
    clear() {
        this.contacts.clear();
    }
}
// Mock MessageSender implementation
class MockMessageSender {
    constructor() {
        this.sentMessages = [];
        this.shouldFail = false;
    }
    async sendToPeer(peerId, message) {
        if (this.shouldFail) {
            throw new Error('Failed to send message');
        }
        this.sentMessages.push({ peerId, message });
    }
    clear() {
        this.sentMessages = [];
    }
}
describe('AutoLink', () => {
    let autoLink;
    let contactStore;
    let messageSender;
    let inviteManager;
    let identity;
    beforeEach(() => {
        contactStore = new MockContactStore();
        messageSender = new MockMessageSender();
        autoLink = new AutoLink_1.AutoLink(contactStore, messageSender);
        identity = (0, primitives_1.generateIdentity)();
        inviteManager = new InviteManager_1.InviteManager('inviter-peer-id', identity.publicKey, identity.privateKey, 'Inviter User');
    });
    describe('Auto Connection Creation', () => {
        it('should add inviter to contacts', async () => {
            const invite = await inviteManager.createInvite();
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            await autoLink.createAutoConnection(invite, 'recipient-peer-id', recipientIdentity.publicKey, 'Recipient User');
            const contact = await contactStore.get('inviter-peer-id');
            expect(contact).not.toBeNull();
            expect(contact.peerId).toBe('inviter-peer-id');
            expect(contact.publicKey).toEqual(identity.publicKey);
            expect(contact.name).toBe('Inviter User');
            expect(contact.addedVia).toBe('invite');
            expect(contact.verified).toBe(true);
        });
        it('should send acceptance notification to inviter', async () => {
            const invite = await inviteManager.createInvite();
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            await autoLink.createAutoConnection(invite, 'recipient-peer-id', recipientIdentity.publicKey, 'Recipient User');
            expect(messageSender.sentMessages).toHaveLength(1);
            expect(messageSender.sentMessages[0].peerId).toBe('inviter-peer-id');
            expect(messageSender.sentMessages[0].message.type).toBe('INVITE_ACCEPTED');
            expect(messageSender.sentMessages[0].message.recipientPeerId).toBe('recipient-peer-id');
            expect(messageSender.sentMessages[0].message.recipientPublicKey).toEqual(recipientIdentity.publicKey);
            expect(messageSender.sentMessages[0].message.recipientName).toBe('Recipient User');
            expect(messageSender.sentMessages[0].message.inviteCode).toBe(invite.code);
        });
        it('should work without message sender', async () => {
            const autoLinkWithoutSender = new AutoLink_1.AutoLink(contactStore);
            const invite = await inviteManager.createInvite();
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            await autoLinkWithoutSender.createAutoConnection(invite, 'recipient-peer-id', recipientIdentity.publicKey, 'Recipient User');
            const contact = await contactStore.get('inviter-peer-id');
            expect(contact).not.toBeNull();
        });
        it('should handle message sending failures gracefully', async () => {
            messageSender.shouldFail = true;
            const invite = await inviteManager.createInvite();
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            // Should not throw
            await expect(autoLink.createAutoConnection(invite, 'recipient-peer-id', recipientIdentity.publicKey, 'Recipient User')).resolves.not.toThrow();
            // Contact should still be added
            const contact = await contactStore.get('inviter-peer-id');
            expect(contact).not.toBeNull();
        });
        it('should handle recipient without name', async () => {
            const invite = await inviteManager.createInvite();
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            await autoLink.createAutoConnection(invite, 'recipient-peer-id', recipientIdentity.publicKey);
            const message = messageSender.sentMessages[0]?.message;
            expect(message?.recipientName).toBeUndefined();
        });
        it('should set correct contact metadata', async () => {
            const invite = await inviteManager.createInvite();
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            await autoLink.createAutoConnection(invite, 'recipient-peer-id', recipientIdentity.publicKey, 'Recipient User');
            const contact = await contactStore.get('inviter-peer-id');
            expect(contact.addedAt).toBeGreaterThan(0);
            expect(contact.addedAt).toBeLessThanOrEqual(Date.now());
        });
    });
    describe('Invite Acceptance Handling', () => {
        it('should add recipient to contacts when handling acceptance', async () => {
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            const message = {
                type: 'INVITE_ACCEPTED',
                recipientPeerId: 'recipient-peer-id',
                recipientPublicKey: recipientIdentity.publicKey,
                recipientName: 'Recipient User',
                inviteCode: 'test-invite-code',
                timestamp: Date.now(),
            };
            await autoLink.handleInviteAcceptance(message);
            const contact = await contactStore.get('recipient-peer-id');
            expect(contact).not.toBeNull();
            expect(contact.peerId).toBe('recipient-peer-id');
            expect(contact.publicKey).toEqual(recipientIdentity.publicKey);
            expect(contact.name).toBe('Recipient User');
            expect(contact.addedVia).toBe('invite');
            expect(contact.verified).toBe(true);
        });
        it('should not duplicate existing contacts', async () => {
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            const existingContact = {
                peerId: 'recipient-peer-id',
                publicKey: recipientIdentity.publicKey,
                name: 'Old Name',
                addedVia: 'manual',
                addedAt: Date.now() - 1000,
                verified: false,
            };
            await contactStore.add(existingContact);
            const message = {
                type: 'INVITE_ACCEPTED',
                recipientPeerId: 'recipient-peer-id',
                recipientPublicKey: recipientIdentity.publicKey,
                recipientName: 'New Name',
                inviteCode: 'test-invite-code',
                timestamp: Date.now(),
            };
            await autoLink.handleInviteAcceptance(message);
            const contact = await contactStore.get('recipient-peer-id');
            expect(contact.name).toBe('Old Name'); // Should not change
        });
        it('should handle acceptance without recipient name', async () => {
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            const message = {
                type: 'INVITE_ACCEPTED',
                recipientPeerId: 'recipient-peer-id',
                recipientPublicKey: recipientIdentity.publicKey,
                inviteCode: 'test-invite-code',
                timestamp: Date.now(),
            };
            await autoLink.handleInviteAcceptance(message);
            const contact = await contactStore.get('recipient-peer-id');
            expect(contact).not.toBeNull();
            expect(contact.name).toBeUndefined();
        });
    });
    describe('Bidirectional Connection', () => {
        it('should create bidirectional link when both sides process', async () => {
            // Create two AutoLink instances for inviter and recipient
            const inviterContacts = new MockContactStore();
            const recipientContacts = new MockContactStore();
            const recipientSender = new MockMessageSender();
            const inviterAutoLink = new AutoLink_1.AutoLink(inviterContacts);
            const recipientAutoLink = new AutoLink_1.AutoLink(recipientContacts, recipientSender);
            // Create invite
            const invite = await inviteManager.createInvite();
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            // Recipient redeems invite
            await recipientAutoLink.createAutoConnection(invite, 'recipient-peer-id', recipientIdentity.publicKey, 'Recipient User');
            // Inviter processes acceptance
            const acceptanceMessage = recipientSender.sentMessages[0].message;
            await inviterAutoLink.handleInviteAcceptance(acceptanceMessage);
            // Both should have each other as contacts
            const inviterContact = await recipientContacts.get('inviter-peer-id');
            const recipientContact = await inviterContacts.get('recipient-peer-id');
            expect(inviterContact).not.toBeNull();
            expect(recipientContact).not.toBeNull();
            expect(inviterContact.peerId).toBe('inviter-peer-id');
            expect(recipientContact.peerId).toBe('recipient-peer-id');
        });
    });
    describe('Edge Cases', () => {
        it('should handle invite without inviter name', async () => {
            const anonymousManager = new InviteManager_1.InviteManager('inviter-peer-id', identity.publicKey, identity.privateKey);
            const invite = await anonymousManager.createInvite();
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            await autoLink.createAutoConnection(invite, 'recipient-peer-id', recipientIdentity.publicKey);
            const contact = await contactStore.get('inviter-peer-id');
            expect(contact.name).toBe('User'); // Default name when none provided
        });
        it('should include timestamp in acceptance message', async () => {
            const invite = await inviteManager.createInvite();
            const recipientIdentity = (0, primitives_1.generateIdentity)();
            const beforeTime = Date.now();
            await autoLink.createAutoConnection(invite, 'recipient-peer-id', recipientIdentity.publicKey);
            const afterTime = Date.now();
            const message = messageSender.sentMessages[0]?.message;
            expect(message?.timestamp).toBeGreaterThanOrEqual(beforeTime);
            expect(message?.timestamp).toBeLessThanOrEqual(afterTime);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvc2hhcmluZy9BdXRvTGluay50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFFSCx5Q0FBb0Y7QUFDcEYsbURBQWdEO0FBRWhELHFEQUF3RDtBQUV4RCxtQ0FBbUM7QUFDbkMsTUFBTSxnQkFBZ0I7SUFBdEI7UUFDVSxhQUFRLEdBQXlCLElBQUksR0FBRyxFQUFFLENBQUM7SUFxQnJELENBQUM7SUFuQkMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxPQUFnQjtRQUN4QixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQWM7UUFDdEIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxJQUFJLENBQUM7SUFDM0MsQ0FBQztJQUVELEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBYztRQUN0QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCxNQUFNO1FBQ0osT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsS0FBSztRQUNILElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDeEIsQ0FBQztDQUNGO0FBRUQsb0NBQW9DO0FBQ3BDLE1BQU0saUJBQWlCO0lBQXZCO1FBQ1MsaUJBQVksR0FBd0QsRUFBRSxDQUFDO1FBQ3ZFLGVBQVUsR0FBWSxLQUFLLENBQUM7SUFZckMsQ0FBQztJQVZDLEtBQUssQ0FBQyxVQUFVLENBQUMsTUFBYyxFQUFFLE9BQXdCO1FBQ3ZELElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3BC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QUU5QixNQUFNLFFBQVEsQ0FBQyxvQkFBb0IsQ0FDakMsTUFBTSxFQUNOLG1CQUFtQixFQUNuQixpQkFBaUIsQ0FBQyxTQUFTLENBQzVCLENBQUM7WUFFRixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDN0IsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUM7WUFFdkQsTUFBTSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUM5RCxNQUFNLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzVELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvY2hyaXN0eW1heHdlbGwvRGVza3RvcC9MdWtlX1N0dWZmL0dpdEh1Yi9TQy9jb3JlL3NyYy9zaGFyaW5nL0F1dG9MaW5rLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUZXN0cyBmb3IgQXV0b0xpbmtcbiAqL1xuXG5pbXBvcnQgeyBBdXRvTGluaywgQ29udGFjdFN0b3JlLCBNZXNzYWdlU2VuZGVyLCBBdXRvTGlua01lc3NhZ2UgfSBmcm9tICcuL0F1dG9MaW5rJztcbmltcG9ydCB7IEludml0ZU1hbmFnZXIgfSBmcm9tICcuL0ludml0ZU1hbmFnZXInO1xuaW1wb3J0IHsgQ29udGFjdCwgUGVuZGluZ0ludml0ZSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgZ2VuZXJhdGVJZGVudGl0eSB9IGZyb20gJy4uL2NyeXB0by9wcmltaXRpdmVzJztcblxuLy8gTW9jayBDb250YWN0U3RvcmUgaW1wbGVtZW50YXRpb25cbmNsYXNzIE1vY2tDb250YWN0U3RvcmUgaW1wbGVtZW50cyBDb250YWN0U3RvcmUge1xuICBwcml2YXRlIGNvbnRhY3RzOiBNYXA8c3RyaW5nLCBDb250YWN0PiA9IG5ldyBNYXAoKTtcblxuICBhc3luYyBhZGQoY29udGFjdDogQ29udGFjdCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuY29udGFjdHMuc2V0KGNvbnRhY3QucGVlcklkLCBjb250YWN0KTtcbiAgfVxuXG4gIGFzeW5jIGdldChwZWVySWQ6IHN0cmluZyk6IFByb21pc2U8Q29udGFjdCB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5jb250YWN0cy5nZXQocGVlcklkKSB8fCBudWxsO1xuICB9XG5cbiAgYXN5bmMgaGFzKHBlZXJJZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuY29udGFjdHMuaGFzKHBlZXJJZCk7XG4gIH1cblxuICBnZXRBbGwoKTogQ29udGFjdFtdIHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmNvbnRhY3RzLnZhbHVlcygpKTtcbiAgfVxuXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIHRoaXMuY29udGFjdHMuY2xlYXIoKTtcbiAgfVxufVxuXG4vLyBNb2NrIE1lc3NhZ2VTZW5kZXIgaW1wbGVtZW50YXRpb25cbmNsYXNzIE1vY2tNZXNzYWdlU2VuZGVyIGltcGxlbWVudHMgTWVzc2FnZVNlbmRlciB7XG4gIHB1YmxpYyBzZW50TWVzc2FnZXM6IEFycmF5PHsgcGVlcklkOiBzdHJpbmc7IG1lc3NhZ2U6IEF1dG9MaW5rTWVzc2FnZSB9PiA9IFtdO1xuICBwdWJsaWMgc2hvdWxkRmFpbDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIGFzeW5jIHNlbmRUb1BlZXIocGVlcklkOiBzdHJpbmcsIG1lc3NhZ2U6IEF1dG9MaW5rTWVzc2FnZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLnNob3VsZEZhaWwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHNlbmQgbWVzc2FnZScpO1xuICAgIH1cbiAgICB0aGlzLnNlbnRNZXNzYWdlcy5wdXNoKHsgcGVlcklkLCBtZXNzYWdlIH0pO1xuICB9XG5cbiAgY2xlYXIoKTogdm9pZCB7XG4gICAgdGhpcy5zZW50TWVzc2FnZXMgPSBbXTtcbiAgfVxufVxuXG5kZXNjcmliZSgnQXV0b0xpbmsnLCAoKSA9PiB7XG4gIGxldCBhdXRvTGluazogQXV0b0xpbms7XG4gIGxldCBjb250YWN0U3RvcmU6IE1vY2tDb250YWN0U3RvcmU7XG4gIGxldCBtZXNzYWdlU2VuZGVyOiBNb2NrTWVzc2FnZVNlbmRlcjtcbiAgbGV0IGludml0ZU1hbmFnZXI6IEludml0ZU1hbmFnZXI7XG4gIGxldCBpZGVudGl0eTogUmV0dXJuVHlwZTx0eXBlb2YgZ2VuZXJhdGVJZGVudGl0eT47XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgY29udGFjdFN0b3JlID0gbmV3IE1vY2tDb250YWN0U3RvcmUoKTtcbiAgICBtZXNzYWdlU2VuZGVyID0gbmV3IE1vY2tNZXNzYWdlU2VuZGVyKCk7XG4gICAgYXV0b0xpbmsgPSBuZXcgQXV0b0xpbmsoY29udGFjdFN0b3JlLCBtZXNzYWdlU2VuZGVyKTtcbiAgICBcbiAgICBpZGVudGl0eSA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICBpbnZpdGVNYW5hZ2VyID0gbmV3IEludml0ZU1hbmFnZXIoXG4gICAgICAnaW52aXRlci1wZWVyLWlkJyxcbiAgICAgIGlkZW50aXR5LnB1YmxpY0tleSxcbiAgICAgIGlkZW50aXR5LnByaXZhdGVLZXksXG4gICAgICAnSW52aXRlciBVc2VyJ1xuICAgICk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdBdXRvIENvbm5lY3Rpb24gQ3JlYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBhZGQgaW52aXRlciB0byBjb250YWN0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBjb25zdCByZWNpcGllbnRJZGVudGl0eSA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcblxuICAgICAgYXdhaXQgYXV0b0xpbmsuY3JlYXRlQXV0b0Nvbm5lY3Rpb24oXG4gICAgICAgIGludml0ZSxcbiAgICAgICAgJ3JlY2lwaWVudC1wZWVyLWlkJyxcbiAgICAgICAgcmVjaXBpZW50SWRlbnRpdHkucHVibGljS2V5LFxuICAgICAgICAnUmVjaXBpZW50IFVzZXInXG4gICAgICApO1xuXG4gICAgICBjb25zdCBjb250YWN0ID0gYXdhaXQgY29udGFjdFN0b3JlLmdldCgnaW52aXRlci1wZWVyLWlkJyk7XG4gICAgICBleHBlY3QoY29udGFjdCkubm90LnRvQmVOdWxsKCk7XG4gICAgICBleHBlY3QoY29udGFjdCEucGVlcklkKS50b0JlKCdpbnZpdGVyLXBlZXItaWQnKTtcbiAgICAgIGV4cGVjdChjb250YWN0IS5wdWJsaWNLZXkpLnRvRXF1YWwoaWRlbnRpdHkucHVibGljS2V5KTtcbiAgICAgIGV4cGVjdChjb250YWN0IS5uYW1lKS50b0JlKCdJbnZpdGVyIFVzZXInKTtcbiAgICAgIGV4cGVjdChjb250YWN0IS5hZGRlZFZpYSkudG9CZSgnaW52aXRlJyk7XG4gICAgICBleHBlY3QoY29udGFjdCEudmVyaWZpZWQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNlbmQgYWNjZXB0YW5jZSBub3RpZmljYXRpb24gdG8gaW52aXRlcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBjb25zdCByZWNpcGllbnRJZGVudGl0eSA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcblxuICAgICAgYXdhaXQgYXV0b0xpbmsuY3JlYXRlQXV0b0Nvbm5lY3Rpb24oXG4gICAgICAgIGludml0ZSxcbiAgICAgICAgJ3JlY2lwaWVudC1wZWVyLWlkJyxcbiAgICAgICAgcmVjaXBpZW50SWRlbnRpdHkucHVibGljS2V5LFxuICAgICAgICAnUmVjaXBpZW50IFVzZXInXG4gICAgICApO1xuXG4gICAgICBleHBlY3QobWVzc2FnZVNlbmRlci5zZW50TWVzc2FnZXMpLnRvSGF2ZUxlbmd0aCgxKTtcbiAgICAgIGV4cGVjdChtZXNzYWdlU2VuZGVyLnNlbnRNZXNzYWdlc1swXS5wZWVySWQpLnRvQmUoJ2ludml0ZXItcGVlci1pZCcpO1xuICAgICAgZXhwZWN0KG1lc3NhZ2VTZW5kZXIuc2VudE1lc3NhZ2VzWzBdLm1lc3NhZ2UudHlwZSkudG9CZSgnSU5WSVRFX0FDQ0VQVEVEJyk7XG4gICAgICBleHBlY3QobWVzc2FnZVNlbmRlci5zZW50TWVzc2FnZXNbMF0ubWVzc2FnZS5yZWNpcGllbnRQZWVySWQpLnRvQmUoJ3JlY2lwaWVudC1wZWVyLWlkJyk7XG4gICAgICBleHBlY3QobWVzc2FnZVNlbmRlci5zZW50TWVzc2FnZXNbMF0ubWVzc2FnZS5yZWNpcGllbnRQdWJsaWNLZXkpLnRvRXF1YWwocmVjaXBpZW50SWRlbnRpdHkucHVibGljS2V5KTtcbiAgICAgIGV4cGVjdChtZXNzYWdlU2VuZGVyLnNlbnRNZXNzYWdlc1swXS5tZXNzYWdlLnJlY2lwaWVudE5hbWUpLnRvQmUoJ1JlY2lwaWVudCBVc2VyJyk7XG4gICAgICBleHBlY3QobWVzc2FnZVNlbmRlci5zZW50TWVzc2FnZXNbMF0ubWVzc2FnZS5pbnZpdGVDb2RlKS50b0JlKGludml0ZS5jb2RlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgd29yayB3aXRob3V0IG1lc3NhZ2Ugc2VuZGVyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgYXV0b0xpbmtXaXRob3V0U2VuZGVyID0gbmV3IEF1dG9MaW5rKGNvbnRhY3RTdG9yZSk7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgY29uc3QgcmVjaXBpZW50SWRlbnRpdHkgPSBnZW5lcmF0ZUlkZW50aXR5KCk7XG5cbiAgICAgIGF3YWl0IGF1dG9MaW5rV2l0aG91dFNlbmRlci5jcmVhdGVBdXRvQ29ubmVjdGlvbihcbiAgICAgICAgaW52aXRlLFxuICAgICAgICAncmVjaXBpZW50LXBlZXItaWQnLFxuICAgICAgICByZWNpcGllbnRJZGVudGl0eS5wdWJsaWNLZXksXG4gICAgICAgICdSZWNpcGllbnQgVXNlcidcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGNvbnRhY3QgPSBhd2FpdCBjb250YWN0U3RvcmUuZ2V0KCdpbnZpdGVyLXBlZXItaWQnKTtcbiAgICAgIGV4cGVjdChjb250YWN0KS5ub3QudG9CZU51bGwoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIG1lc3NhZ2Ugc2VuZGluZyBmYWlsdXJlcyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbWVzc2FnZVNlbmRlci5zaG91bGRGYWlsID0gdHJ1ZTtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBjb25zdCByZWNpcGllbnRJZGVudGl0eSA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcblxuICAgICAgLy8gU2hvdWxkIG5vdCB0aHJvd1xuICAgICAgYXdhaXQgZXhwZWN0KFxuICAgICAgICBhdXRvTGluay5jcmVhdGVBdXRvQ29ubmVjdGlvbihcbiAgICAgICAgICBpbnZpdGUsXG4gICAgICAgICAgJ3JlY2lwaWVudC1wZWVyLWlkJyxcbiAgICAgICAgICByZWNpcGllbnRJZGVudGl0eS5wdWJsaWNLZXksXG4gICAgICAgICAgJ1JlY2lwaWVudCBVc2VyJ1xuICAgICAgICApXG4gICAgICApLnJlc29sdmVzLm5vdC50b1Rocm93KCk7XG5cbiAgICAgIC8vIENvbnRhY3Qgc2hvdWxkIHN0aWxsIGJlIGFkZGVkXG4gICAgICBjb25zdCBjb250YWN0ID0gYXdhaXQgY29udGFjdFN0b3JlLmdldCgnaW52aXRlci1wZWVyLWlkJyk7XG4gICAgICBleHBlY3QoY29udGFjdCkubm90LnRvQmVOdWxsKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSByZWNpcGllbnQgd2l0aG91dCBuYW1lJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGNvbnN0IHJlY2lwaWVudElkZW50aXR5ID0gZ2VuZXJhdGVJZGVudGl0eSgpO1xuXG4gICAgICBhd2FpdCBhdXRvTGluay5jcmVhdGVBdXRvQ29ubmVjdGlvbihcbiAgICAgICAgaW52aXRlLFxuICAgICAgICAncmVjaXBpZW50LXBlZXItaWQnLFxuICAgICAgICByZWNpcGllbnRJZGVudGl0eS5wdWJsaWNLZXlcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBtZXNzYWdlU2VuZGVyLnNlbnRNZXNzYWdlc1swXT8ubWVzc2FnZTtcbiAgICAgIGV4cGVjdChtZXNzYWdlPy5yZWNpcGllbnROYW1lKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNldCBjb3JyZWN0IGNvbnRhY3QgbWV0YWRhdGEnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgY29uc3QgcmVjaXBpZW50SWRlbnRpdHkgPSBnZW5lcmF0ZUlkZW50aXR5KCk7XG5cbiAgICAgIGF3YWl0IGF1dG9MaW5rLmNyZWF0ZUF1dG9Db25uZWN0aW9uKFxuICAgICAgICBpbnZpdGUsXG4gICAgICAgICdyZWNpcGllbnQtcGVlci1pZCcsXG4gICAgICAgIHJlY2lwaWVudElkZW50aXR5LnB1YmxpY0tleSxcbiAgICAgICAgJ1JlY2lwaWVudCBVc2VyJ1xuICAgICAgKTtcblxuICAgICAgY29uc3QgY29udGFjdCA9IGF3YWl0IGNvbnRhY3RTdG9yZS5nZXQoJ2ludml0ZXItcGVlci1pZCcpO1xuICAgICAgZXhwZWN0KGNvbnRhY3QhLmFkZGVkQXQpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgIGV4cGVjdChjb250YWN0IS5hZGRlZEF0KS50b0JlTGVzc1RoYW5PckVxdWFsKERhdGUubm93KCkpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnSW52aXRlIEFjY2VwdGFuY2UgSGFuZGxpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBhZGQgcmVjaXBpZW50IHRvIGNvbnRhY3RzIHdoZW4gaGFuZGxpbmcgYWNjZXB0YW5jZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlY2lwaWVudElkZW50aXR5ID0gZ2VuZXJhdGVJZGVudGl0eSgpO1xuICAgICAgY29uc3QgbWVzc2FnZTogQXV0b0xpbmtNZXNzYWdlID0ge1xuICAgICAgICB0eXBlOiAnSU5WSVRFX0FDQ0VQVEVEJyxcbiAgICAgICAgcmVjaXBpZW50UGVlcklkOiAncmVjaXBpZW50LXBlZXItaWQnLFxuICAgICAgICByZWNpcGllbnRQdWJsaWNLZXk6IHJlY2lwaWVudElkZW50aXR5LnB1YmxpY0tleSxcbiAgICAgICAgcmVjaXBpZW50TmFtZTogJ1JlY2lwaWVudCBVc2VyJyxcbiAgICAgICAgaW52aXRlQ29kZTogJ3Rlc3QtaW52aXRlLWNvZGUnLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICB9O1xuXG4gICAgICBhd2FpdCBhdXRvTGluay5oYW5kbGVJbnZpdGVBY2NlcHRhbmNlKG1lc3NhZ2UpO1xuXG4gICAgICBjb25zdCBjb250YWN0ID0gYXdhaXQgY29udGFjdFN0b3JlLmdldCgncmVjaXBpZW50LXBlZXItaWQnKTtcbiAgICAgIGV4cGVjdChjb250YWN0KS5ub3QudG9CZU51bGwoKTtcbiAgICAgIGV4cGVjdChjb250YWN0IS5wZWVySWQpLnRvQmUoJ3JlY2lwaWVudC1wZWVyLWlkJyk7XG4gICAgICBleHBlY3QoY29udGFjdCEucHVibGljS2V5KS50b0VxdWFsKHJlY2lwaWVudElkZW50aXR5LnB1YmxpY0tleSk7XG4gICAgICBleHBlY3QoY29udGFjdCEubmFtZSkudG9CZSgnUmVjaXBpZW50IFVzZXInKTtcbiAgICAgIGV4cGVjdChjb250YWN0IS5hZGRlZFZpYSkudG9CZSgnaW52aXRlJyk7XG4gICAgICBleHBlY3QoY29udGFjdCEudmVyaWZpZWQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIG5vdCBkdXBsaWNhdGUgZXhpc3RpbmcgY29udGFjdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZWNpcGllbnRJZGVudGl0eSA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICAgIGNvbnN0IGV4aXN0aW5nQ29udGFjdDogQ29udGFjdCA9IHtcbiAgICAgICAgcGVlcklkOiAncmVjaXBpZW50LXBlZXItaWQnLFxuICAgICAgICBwdWJsaWNLZXk6IHJlY2lwaWVudElkZW50aXR5LnB1YmxpY0tleSxcbiAgICAgICAgbmFtZTogJ09sZCBOYW1lJyxcbiAgICAgICAgYWRkZWRWaWE6ICdtYW51YWwnLFxuICAgICAgICBhZGRlZEF0OiBEYXRlLm5vdygpIC0gMTAwMCxcbiAgICAgICAgdmVyaWZpZWQ6IGZhbHNlLFxuICAgICAgfTtcblxuICAgICAgYXdhaXQgY29udGFjdFN0b3JlLmFkZChleGlzdGluZ0NvbnRhY3QpO1xuXG4gICAgICBjb25zdCBtZXNzYWdlOiBBdXRvTGlua01lc3NhZ2UgPSB7XG4gICAgICAgIHR5cGU6ICdJTlZJVEVfQUNDRVBURUQnLFxuICAgICAgICByZWNpcGllbnRQZWVySWQ6ICdyZWNpcGllbnQtcGVlci1pZCcsXG4gICAgICAgIHJlY2lwaWVudFB1YmxpY0tleTogcmVjaXBpZW50SWRlbnRpdHkucHVibGljS2V5LFxuICAgICAgICByZWNpcGllbnROYW1lOiAnTmV3IE5hbWUnLFxuICAgICAgICBpbnZpdGVDb2RlOiAndGVzdC1pbnZpdGUtY29kZScsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIH07XG5cbiAgICAgIGF3YWl0IGF1dG9MaW5rLmhhbmRsZUludml0ZUFjY2VwdGFuY2UobWVzc2FnZSk7XG5cbiAgICAgIGNvbnN0IGNvbnRhY3QgPSBhd2FpdCBjb250YWN0U3RvcmUuZ2V0KCdyZWNpcGllbnQtcGVlci1pZCcpO1xuICAgICAgZXhwZWN0KGNvbnRhY3QhLm5hbWUpLnRvQmUoJ09sZCBOYW1lJyk7IC8vIFNob3VsZCBub3QgY2hhbmdlXG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBhY2NlcHRhbmNlIHdpdGhvdXQgcmVjaXBpZW50IG5hbWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZWNpcGllbnRJZGVudGl0eSA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICAgIGNvbnN0IG1lc3NhZ2U6IEF1dG9MaW5rTWVzc2FnZSA9IHtcbiAgICAgICAgdHlwZTogJ0lOVklURV9BQ0NFUFRFRCcsXG4gICAgICAgIHJlY2lwaWVudFBlZXJJZDogJ3JlY2lwaWVudC1wZWVyLWlkJyxcbiAgICAgICAgcmVjaXBpZW50UHVibGljS2V5OiByZWNpcGllbnRJZGVudGl0eS5wdWJsaWNLZXksXG4gICAgICAgIGludml0ZUNvZGU6ICd0ZXN0LWludml0ZS1jb2RlJyxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgfTtcblxuICAgICAgYXdhaXQgYXV0b0xpbmsuaGFuZGxlSW52aXRlQWNjZXB0YW5jZShtZXNzYWdlKTtcblxuICAgICAgY29uc3QgY29udGFjdCA9IGF3YWl0IGNvbnRhY3RTdG9yZS5nZXQoJ3JlY2lwaWVudC1wZWVyLWlkJyk7XG4gICAgICBleHBlY3QoY29udGFjdCkubm90LnRvQmVOdWxsKCk7XG4gICAgICBleHBlY3QoY29udGFjdCEubmFtZSkudG9CZVVuZGVmaW5lZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnQmlkaXJlY3Rpb25hbCBDb25uZWN0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIGJpZGlyZWN0aW9uYWwgbGluayB3aGVuIGJvdGggc2lkZXMgcHJvY2VzcycsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIENyZWF0ZSB0d28gQXV0b0xpbmsgaW5zdGFuY2VzIGZvciBpbnZpdGVyIGFuZCByZWNpcGllbnRcbiAgICAgIGNvbnN0IGludml0ZXJDb250YWN0cyA9IG5ldyBNb2NrQ29udGFjdFN0b3JlKCk7XG4gICAgICBjb25zdCByZWNpcGllbnRDb250YWN0cyA9IG5ldyBNb2NrQ29udGFjdFN0b3JlKCk7XG4gICAgICBjb25zdCByZWNpcGllbnRTZW5kZXIgPSBuZXcgTW9ja01lc3NhZ2VTZW5kZXIoKTtcbiAgICAgIFxuICAgICAgY29uc3QgaW52aXRlckF1dG9MaW5rID0gbmV3IEF1dG9MaW5rKGludml0ZXJDb250YWN0cyk7XG4gICAgICBjb25zdCByZWNpcGllbnRBdXRvTGluayA9IG5ldyBBdXRvTGluayhyZWNpcGllbnRDb250YWN0cywgcmVjaXBpZW50U2VuZGVyKTtcblxuICAgICAgLy8gQ3JlYXRlIGludml0ZVxuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGNvbnN0IHJlY2lwaWVudElkZW50aXR5ID0gZ2VuZXJhdGVJZGVudGl0eSgpO1xuXG4gICAgICAvLyBSZWNpcGllbnQgcmVkZWVtcyBpbnZpdGVcbiAgICAgIGF3YWl0IHJlY2lwaWVudEF1dG9MaW5rLmNyZWF0ZUF1dG9Db25uZWN0aW9uKFxuICAgICAgICBpbnZpdGUsXG4gICAgICAgICdyZWNpcGllbnQtcGVlci1pZCcsXG4gICAgICAgIHJlY2lwaWVudElkZW50aXR5LnB1YmxpY0tleSxcbiAgICAgICAgJ1JlY2lwaWVudCBVc2VyJ1xuICAgICAgKTtcblxuICAgICAgLy8gSW52aXRlciBwcm9jZXNzZXMgYWNjZXB0YW5jZVxuICAgICAgY29uc3QgYWNjZXB0YW5jZU1lc3NhZ2UgPSByZWNpcGllbnRTZW5kZXIuc2VudE1lc3NhZ2VzWzBdLm1lc3NhZ2U7XG4gICAgICBhd2FpdCBpbnZpdGVyQXV0b0xpbmsuaGFuZGxlSW52aXRlQWNjZXB0YW5jZShhY2NlcHRhbmNlTWVzc2FnZSk7XG5cbiAgICAgIC8vIEJvdGggc2hvdWxkIGhhdmUgZWFjaCBvdGhlciBhcyBjb250YWN0c1xuICAgICAgY29uc3QgaW52aXRlckNvbnRhY3QgPSBhd2FpdCByZWNpcGllbnRDb250YWN0cy5nZXQoJ2ludml0ZXItcGVlci1pZCcpO1xuICAgICAgY29uc3QgcmVjaXBpZW50Q29udGFjdCA9IGF3YWl0IGludml0ZXJDb250YWN0cy5nZXQoJ3JlY2lwaWVudC1wZWVyLWlkJyk7XG5cbiAgICAgIGV4cGVjdChpbnZpdGVyQ29udGFjdCkubm90LnRvQmVOdWxsKCk7XG4gICAgICBleHBlY3QocmVjaXBpZW50Q29udGFjdCkubm90LnRvQmVOdWxsKCk7XG4gICAgICBleHBlY3QoaW52aXRlckNvbnRhY3QhLnBlZXJJZCkudG9CZSgnaW52aXRlci1wZWVyLWlkJyk7XG4gICAgICBleHBlY3QocmVjaXBpZW50Q29udGFjdCEucGVlcklkKS50b0JlKCdyZWNpcGllbnQtcGVlci1pZCcpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRWRnZSBDYXNlcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBpbnZpdGUgd2l0aG91dCBpbnZpdGVyIG5hbWUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhbm9ueW1vdXNNYW5hZ2VyID0gbmV3IEludml0ZU1hbmFnZXIoXG4gICAgICAgICdpbnZpdGVyLXBlZXItaWQnLFxuICAgICAgICBpZGVudGl0eS5wdWJsaWNLZXksXG4gICAgICAgIGlkZW50aXR5LnByaXZhdGVLZXlcbiAgICAgICk7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBhbm9ueW1vdXNNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgY29uc3QgcmVjaXBpZW50SWRlbnRpdHkgPSBnZW5lcmF0ZUlkZW50aXR5KCk7XG5cbiAgICAgIGF3YWl0IGF1dG9MaW5rLmNyZWF0ZUF1dG9Db25uZWN0aW9uKFxuICAgICAgICBpbnZpdGUsXG4gICAgICAgICdyZWNpcGllbnQtcGVlci1pZCcsXG4gICAgICAgIHJlY2lwaWVudElkZW50aXR5LnB1YmxpY0tleVxuICAgICAgKTtcblxuICAgICAgY29uc3QgY29udGFjdCA9IGF3YWl0IGNvbnRhY3RTdG9yZS5nZXQoJ2ludml0ZXItcGVlci1pZCcpO1xuICAgICAgZXhwZWN0KGNvbnRhY3QhLm5hbWUpLnRvQmUoJ1VzZXInKTsgLy8gRGVmYXVsdCBuYW1lIHdoZW4gbm9uZSBwcm92aWRlZFxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBpbmNsdWRlIHRpbWVzdGFtcCBpbiBhY2NlcHRhbmNlIG1lc3NhZ2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgY29uc3QgcmVjaXBpZW50SWRlbnRpdHkgPSBnZW5lcmF0ZUlkZW50aXR5KCk7XG4gICAgICBjb25zdCBiZWZvcmVUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgICAgYXdhaXQgYXV0b0xpbmsuY3JlYXRlQXV0b0Nvbm5lY3Rpb24oXG4gICAgICAgIGludml0ZSxcbiAgICAgICAgJ3JlY2lwaWVudC1wZWVyLWlkJyxcbiAgICAgICAgcmVjaXBpZW50SWRlbnRpdHkucHVibGljS2V5XG4gICAgICApO1xuXG4gICAgICBjb25zdCBhZnRlclRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgY29uc3QgbWVzc2FnZSA9IG1lc3NhZ2VTZW5kZXIuc2VudE1lc3NhZ2VzWzBdPy5tZXNzYWdlO1xuICAgICAgXG4gICAgICBleHBlY3QobWVzc2FnZT8udGltZXN0YW1wKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKGJlZm9yZVRpbWUpO1xuICAgICAgZXhwZWN0KG1lc3NhZ2U/LnRpbWVzdGFtcCkudG9CZUxlc3NUaGFuT3JFcXVhbChhZnRlclRpbWUpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9