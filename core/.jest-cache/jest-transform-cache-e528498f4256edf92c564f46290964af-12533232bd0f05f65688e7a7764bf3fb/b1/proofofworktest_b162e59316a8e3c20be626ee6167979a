dd24e2261d97c3a76213a006c90ac470
"use strict";
/**
 * Tests for Proof-of-Work implementation
 */
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const proof_of_work_1 = require("../mesh/proof-of-work");
(0, globals_1.describe)('ProofOfWork', () => {
    let pow;
    const testMessage = new Uint8Array([1, 2, 3, 4, 5]);
    (0, globals_1.beforeEach)(() => {
        pow = new proof_of_work_1.ProofOfWork({ enabled: true, maxComputeTime: 10000 });
    });
    (0, globals_1.it)('should compute valid PoW', async () => {
        const challenge = await pow.computePoW(testMessage, 8);
        (0, globals_1.expect)(challenge).not.toBeNull();
        (0, globals_1.expect)(challenge.difficulty).toBe(8);
        (0, globals_1.expect)(challenge.nonce).toBeGreaterThanOrEqual(0);
    });
    (0, globals_1.it)('should verify valid PoW', async () => {
        const challenge = await pow.computePoW(testMessage, 8);
        (0, globals_1.expect)(challenge).not.toBeNull();
        const isValid = pow.verifyPoW(testMessage, challenge, 8);
        (0, globals_1.expect)(isValid).toBe(true);
    });
    (0, globals_1.it)('should reject invalid PoW', async () => {
        const challenge = await pow.computePoW(testMessage, 8);
        (0, globals_1.expect)(challenge).not.toBeNull();
        // Modify nonce
        challenge.nonce += 1;
        const isValid = pow.verifyPoW(testMessage, challenge, 8);
        (0, globals_1.expect)(isValid).toBe(false);
    });
    (0, globals_1.it)('should handle difficulty levels', async () => {
        // Low difficulty should be fast
        const easy = await pow.computePoW(testMessage, 4);
        (0, globals_1.expect)(easy).not.toBeNull();
        // Higher difficulty should take longer
        const hard = await pow.computePoW(testMessage, 12);
        (0, globals_1.expect)(hard).not.toBeNull();
    });
    (0, globals_1.it)('should respect peer exemptions', () => {
        const peerId = 'trusted-peer-123';
        (0, globals_1.expect)(pow.isPeerExempt(peerId)).toBe(false);
        pow.exemptPeer(peerId);
        (0, globals_1.expect)(pow.isPeerExempt(peerId)).toBe(true);
        pow.unexemptPeer(peerId);
        (0, globals_1.expect)(pow.isPeerExempt(peerId)).toBe(false);
    });
    (0, globals_1.it)('should handle adaptive difficulty', () => {
        const initialDifficulty = pow.getConfig().defaultDifficulty;
        pow.increaseDifficulty(2);
        (0, globals_1.expect)(pow.getConfig().defaultDifficulty).toBe(initialDifficulty + 2);
        pow.decreaseDifficulty(1);
        (0, globals_1.expect)(pow.getConfig().defaultDifficulty).toBe(initialDifficulty + 1);
    });
    (0, globals_1.it)('should track statistics', async () => {
        await pow.computePoW(testMessage, 8);
        const stats = pow.getStats();
        (0, globals_1.expect)(stats.computeAttempts).toBeGreaterThan(0);
        (0, globals_1.expect)(stats.computeSuccesses).toBeGreaterThan(0);
    });
    (0, globals_1.it)('should handle disabled PoW', async () => {
        const disabledPoW = new proof_of_work_1.ProofOfWork({ enabled: false });
        const challenge = await disabledPoW.computePoW(testMessage, 8);
        (0, globals_1.expect)(challenge).not.toBeNull();
        (0, globals_1.expect)(challenge.difficulty).toBe(0);
        const isValid = disabledPoW.verifyPoW(testMessage, challenge, 8);
        (0, globals_1.expect)(isValid).toBe(true);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvbWVzaC9wcm9vZi1vZi13b3JrLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILDJDQUFpRTtBQUNqRSx5REFBc0Y7QUFFdEYsSUFBQSxrQkFBUSxFQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUU7SUFDM0IsSUFBSSxHQUFnQixDQUFDO0lBQ3JCLE1BQU0sV0FBVyxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFcEQsSUFBQSxvQkFBVSxFQUFDLEdBQUcsRUFBRTtRQUNkLEdBQUcsR0FBRyxJQUFJLDJCQUFXLENBQUMsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQ2xFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBQSxZQUFFLEVBQUMsMEJBQTBCLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDeEMsTUFBTSxTQUFTLEdBQUcsTUFBTSxHQUFHLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUV2RCxJQUFBLGdCQUFNLEVBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2pDLElBQUEsZ0JBQU0sRUFBQyxTQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLElBQUEsZ0JBQU0sRUFBQyxTQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckQsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFBLFlBQUUsRUFBQyx5QkFBeUIsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN2QyxNQUFNLFNBQVMsR0FBRyxNQUFNLEdBQUcsQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFF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a3RvcC9MdWtlX1N0dWZmL0dpdEh1Yi9TQy9jb3JlL3NyYy9tZXNoL3Byb29mLW9mLXdvcmsudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRlc3RzIGZvciBQcm9vZi1vZi1Xb3JrIGltcGxlbWVudGF0aW9uXG4gKi9cblxuaW1wb3J0IHsgZGVzY3JpYmUsIGl0LCBleHBlY3QsIGJlZm9yZUVhY2ggfSBmcm9tICdAamVzdC9nbG9iYWxzJztcbmltcG9ydCB7IFByb29mT2ZXb3JrLCBiZW5jaG1hcmtQb1csIERFRkFVTFRfUE9XX0NPTkZJRyB9IGZyb20gJy4uL21lc2gvcHJvb2Ytb2Ytd29yayc7XG5cbmRlc2NyaWJlKCdQcm9vZk9mV29yaycsICgpID0+IHtcbiAgbGV0IHBvdzogUHJvb2ZPZldvcms7XG4gIGNvbnN0IHRlc3RNZXNzYWdlID0gbmV3IFVpbnQ4QXJyYXkoWzEsIDIsIDMsIDQsIDVdKTtcbiAgXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHBvdyA9IG5ldyBQcm9vZk9mV29yayh7IGVuYWJsZWQ6IHRydWUsIG1heENvbXB1dGVUaW1lOiAxMDAwMCB9KTtcbiAgfSk7XG4gIFxuICBpdCgnc2hvdWxkIGNvbXB1dGUgdmFsaWQgUG9XJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGNoYWxsZW5nZSA9IGF3YWl0IHBvdy5jb21wdXRlUG9XKHRlc3RNZXNzYWdlLCA4KTtcbiAgICBcbiAgICBleHBlY3QoY2hhbGxlbmdlKS5ub3QudG9CZU51bGwoKTtcbiAgICBleHBlY3QoY2hhbGxlbmdlIS5kaWZmaWN1bHR5KS50b0JlKDgpO1xuICAgIGV4cGVjdChjaGFsbGVuZ2UhLm5vbmNlKS50b0JlR3JlYXRlclRoYW5PckVxdWFsKDApO1xuICB9KTtcbiAgXG4gIGl0KCdzaG91bGQgdmVyaWZ5IHZhbGlkIFBvVycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBjaGFsbGVuZ2UgPSBhd2FpdCBwb3cuY29tcHV0ZVBvVyh0ZXN0TWVzc2FnZSwgOCk7XG4gICAgZXhwZWN0KGNoYWxsZW5nZSkubm90LnRvQmVOdWxsKCk7XG4gICAgXG4gICAgY29uc3QgaXNWYWxpZCA9IHBvdy52ZXJpZnlQb1codGVzdE1lc3NhZ2UsIGNoYWxsZW5nZSEsIDgpO1xuICAgIGV4cGVjdChpc1ZhbGlkKS50b0JlKHRydWUpO1xuICB9KTtcbiAgXG4gIGl0KCdzaG91bGQgcmVqZWN0IGludmFsaWQgUG9XJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGNoYWxsZW5nZSA9IGF3YWl0IHBvdy5jb21wdXRlUG9XKHRlc3RNZXNzYWdlLCA4KTtcbiAgICBleHBlY3QoY2hhbGxlbmdlKS5ub3QudG9CZU51bGwoKTtcbiAgICBcbiAgICAvLyBNb2RpZnkgbm9uY2VcbiAgICBjaGFsbGVuZ2UhLm5vbmNlICs9IDE7XG4gICAgXG4gICAgY29uc3QgaXNWYWxpZCA9IHBvdy52ZXJpZnlQb1codGVzdE1lc3NhZ2UsIGNoYWxsZW5nZSEsIDgpO1xuICAgIGV4cGVjdChpc1ZhbGlkKS50b0JlKGZhbHNlKTtcbiAgfSk7XG4gIFxuICBpdCgnc2hvdWxkIGhhbmRsZSBkaWZmaWN1bHR5IGxldmVscycsIGFzeW5jICgpID0+IHtcbiAgICAvLyBMb3cgZGlmZmljdWx0eSBzaG91bGQgYmUgZmFzdFxuICAgIGNvbnN0IGVhc3kgPSBhd2FpdCBwb3cuY29tcHV0ZVBvVyh0ZXN0TWVzc2FnZSwgNCk7XG4gICAgZXhwZWN0KGVhc3kpLm5vdC50b0JlTnVsbCgpO1xuICAgIFxuICAgIC8vIEhpZ2hlciBkaWZmaWN1bHR5IHNob3VsZCB0YWtlIGxvbmdlclxuICAgIGNvbnN0IGhhcmQgPSBhd2FpdCBwb3cuY29tcHV0ZVBvVyh0ZXN0TWVzc2FnZSwgMTIpO1xuICAgIGV4cGVjdChoYXJkKS5ub3QudG9CZU51bGwoKTtcbiAgfSk7XG4gIFxuICBpdCgnc2hvdWxkIHJlc3BlY3QgcGVlciBleGVtcHRpb25zJywgKCkgPT4ge1xuICAgIGNvbnN0IHBlZXJJZCA9ICd0cnVzdGVkLXBlZXItMTIzJztcbiAgICBcbiAgICBleHBlY3QocG93LmlzUGVlckV4ZW1wdChwZWVySWQpKS50b0JlKGZhbHNlKTtcbiAgICBcbiAgICBwb3cuZXhlbXB0UGVlcihwZWVySWQpO1xuICAgIGV4cGVjdChwb3cuaXNQZWVyRXhlbXB0KHBlZXJJZCkpLnRvQmUodHJ1ZSk7XG4gICAgXG4gICAgcG93LnVuZXhlbXB0UGVlcihwZWVySWQpO1xuICAgIGV4cGVjdChwb3cuaXNQZWVyRXhlbXB0KHBlZXJJZCkpLnRvQmUoZmFsc2UpO1xuICB9KTtcbiAgXG4gIGl0KCdzaG91bGQgaGFuZGxlIGFkYXB0aXZlIGRpZmZpY3VsdHknLCAoKSA9PiB7XG4gICAgY29uc3QgaW5pdGlhbERpZmZpY3VsdHkgPSBwb3cuZ2V0Q29uZmlnKCkuZGVmYXVsdERpZmZpY3VsdHk7XG4gICAgXG4gICAgcG93LmluY3JlYXNlRGlmZmljdWx0eSgyKTtcbiAgICBleHBlY3QocG93LmdldENvbmZpZygpLmRlZmF1bHREaWZmaWN1bHR5KS50b0JlKGluaXRpYWxEaWZmaWN1bHR5ICsgMik7XG4gICAgXG4gICAgcG93LmRlY3JlYXNlRGlmZmljdWx0eSgxKTtcbiAgICBleHBlY3QocG93LmdldENvbmZpZygpLmRlZmF1bHREaWZmaWN1bHR5KS50b0JlKGluaXRpYWxEaWZmaWN1bHR5ICsgMSk7XG4gIH0pO1xuICBcbiAgaXQoJ3Nob3VsZCB0cmFjayBzdGF0aXN0aWNzJywgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IHBvdy5jb21wdXRlUG9XKHRlc3RNZXNzYWdlLCA4KTtcbiAgICBcbiAgICBjb25zdCBzdGF0cyA9IHBvdy5nZXRTdGF0cygpO1xuICAgIGV4cGVjdChzdGF0cy5jb21wdXRlQXR0ZW1wdHMpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICBleHBlY3Qoc3RhdHMuY29tcHV0ZVN1Y2Nlc3NlcykudG9CZUdyZWF0ZXJUaGFuKDApO1xuICB9KTtcbiAgXG4gIGl0KCdzaG91bGQgaGFuZGxlIGRpc2FibGVkIFBvVycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBkaXNhYmxlZFBvVyA9IG5ldyBQcm9vZk9mV29yayh7IGVuYWJsZWQ6IGZhbHNlIH0pO1xuICAgIFxuICAgIGNvbnN0IGNoYWxsZW5nZSA9IGF3YWl0IGRpc2FibGVkUG9XLmNvbXB1dGVQb1codGVzdE1lc3NhZ2UsIDgpO1xuICAgIGV4cGVjdChjaGFsbGVuZ2UpLm5vdC50b0JlTnVsbCgpO1xuICAgIGV4cGVjdChjaGFsbGVuZ2UhLmRpZmZpY3VsdHkpLnRvQmUoMCk7XG4gICAgXG4gICAgY29uc3QgaXNWYWxpZCA9IGRpc2FibGVkUG9XLnZlcmlmeVBvVyh0ZXN0TWVzc2FnZSwgY2hhbGxlbmdlISwgOCk7XG4gICAgZXhwZWN0KGlzVmFsaWQpLnRvQmUodHJ1ZSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=