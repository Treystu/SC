{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/integration.test.ts","mappings":"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","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/integration.test.ts"],"sourcesContent":["/**\n * Integration tests for mesh network components\n * Tests routing table, message relay, and network integration\n */\n\nimport { RoutingTable, PeerState, createPeer } from './routing.js';\nimport { MessageRelay } from './relay.js';\nimport { MeshNetwork } from './network.js';\nimport { MessageType, encodeMessage, type Message } from '../protocol/message.js';\nimport { generateIdentity } from '../crypto/primitives.js';\n\ndescribe('Mesh Network Integration', () => {\n  let routingTable: RoutingTable;\n  let relay: MessageRelay;\n  let network: MeshNetwork;\n  let identity: { publicKey: Uint8Array; privateKey: Uint8Array };\n  let localPeerId: string;\n\n  beforeEach(async () => {\n    identity = await generateIdentity();\n    localPeerId = Buffer.from(identity.publicKey).toString('hex');\n    routingTable = new RoutingTable(localPeerId);\n    relay = new MessageRelay(localPeerId, routingTable);\n    network = new MeshNetwork({\n      identity: {\n        publicKey: identity.publicKey,\n        privateKey: identity.privateKey,\n      },\n      transports: [],\n    });\n  });\n\n  describe('Routing Table Integration', () => {\n    it('should integrate routing table with message relay', async () => {\n      // Add a peer to routing table\n      const peerId = 'peer123';\n      const peer = createPeer(peerId, new Uint8Array(32), 'webrtc');\n      routingTable.addPeer(peer);\n\n      // Create a test message addressed to local peer\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 10,\n          timestamp: Date.now(),\n          senderId: identity.publicKey,\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode(JSON.stringify({\n          text: 'Hello, World!',\n          recipient: localPeerId\n        })),\n      };\n\n      // Process message through relay\n      let deliveredMessage: Message | undefined;\n      relay.onMessageForSelf((msg: Message) => {\n        deliveredMessage = msg;\n      });\n\n      await relay.processMessage(encodeMessage(message), 'test-peer');\n\n      // Verify message was processed\n      expect(deliveredMessage).toBeDefined();\n      expect(deliveredMessage?.payload).toEqual(message.payload);\n    });\n\n    it('should handle peer state changes in routing table', () => {\n      const peerId = 'peer456';\n      const peer = createPeer(peerId, new Uint8Array(32), 'webrtc');\n      \n      // Add peer\n      routingTable.addPeer(peer);\n      expect(peer.state).toBe(PeerState.CONNECTED);\n\n      // Update reputation to trigger state change\n      routingTable.updatePeerReputation(peerId, false);\n      routingTable.updatePeerReputation(peerId, false);\n      routingTable.updatePeerReputation(peerId, false);\n\n      // Check if state changed to degraded\n      const updatedPeer = routingTable.getPeer(peerId);\n      expect(updatedPeer?.metadata.reputation).toBeLessThan(50);\n    });\n\n    it('should handle route expiration', async () => {\n      const peerId = 'peer789';\n      \n      // Add peer with short TTL\n      const shortTTLConfig = { routeTTL: 100 }; // 100ms\n      const shortRoutingTable = new RoutingTable(localPeerId, shortTTLConfig);\n      const shortRelay = new MessageRelay(localPeerId, shortRoutingTable);\n      \n      const peer = createPeer(peerId, new Uint8Array(32), 'webrtc');\n      shortRoutingTable.addPeer(peer);\n\n      // Verify route exists initially\n      expect(shortRoutingTable.getNextHop(peerId)).toBe(peerId);\n\n      // Wait for expiration\n      await new Promise(resolve => setTimeout(resolve, 150));\n\n      // Verify route expired\n      expect(shortRoutingTable.getNextHop(peerId)).toBeUndefined();\n    });\n  });\n\n  describe('Message Relay Integration', () => {\n    it('should integrate with routing table for message forwarding', async () => {\n      // Create multiple peers\n      const peer1 = createPeer('peer1', new Uint8Array(32), 'webrtc');\n      const peer2 = createPeer('peer2', new Uint8Array(32), 'webrtc');\n      \n      routingTable.addPeer(peer1);\n      routingTable.addPeer(peer2);\n\n      // Create message from peer1 to peer2\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 10,\n          timestamp: Date.now(),\n          senderId: identity.publicKey,\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode(JSON.stringify({\n          text: 'Forwarded message',\n          recipient: 'peer2'\n        })),\n      };\n\n      let forwardedMessage: Message | undefined;\n      relay.onForwardMessage((msg: Message, excludePeerId: string) => {\n        forwardedMessage = msg;\n      });\n\n      // Process message\n      await relay.processMessage(encodeMessage(message), 'test-peer');\n\n      // Verify message was forwarded\n      expect(forwardedMessage).toBeDefined();\n      const payload = JSON.parse(new TextDecoder().decode(forwardedMessage!.payload));\n      expect(payload.recipient).toBe('peer2');\n    });\n\n    it('should handle message deduplication', async () => {\n      const peerId = 'peer123';\n      const peer = createPeer(peerId, new Uint8Array(32), 'webrtc');\n      routingTable.addPeer(peer);\n\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 10,\n          timestamp: Date.now(),\n          senderId: identity.publicKey,\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode(JSON.stringify({\n          text: 'Duplicate test',\n          recipient: localPeerId\n        })),\n      };\n\n      let messageCount = 0;\n      relay.onMessageForSelf(() => {\n        messageCount++;\n      });\n\n      // Process same message twice\n      await relay.processMessage(encodeMessage(message), 'test-peer');\n      await relay.processMessage(encodeMessage(message), 'test-peer');\n\n      // Should only be delivered once\n      expect(messageCount).toBe(1);\n    });\n  });\n\n  describe('Network Integration', () => {\n    it('should initialize network with routing table', async () => {\n      const network = new MeshNetwork({\n        identity: {\n          publicKey: identity.publicKey,\n          privateKey: identity.privateKey,\n        },\n        transports: [],\n      });\n\n      const stats = await network.getStats();\n      expect(stats.localPeerId).toBe(localPeerId);\n      expect(stats.routing).toBeDefined();\n      expect(stats.routing.peerCount).toBe(0);\n    });\n\n    it('should handle peer connections in network', async () => {\n      const network = new MeshNetwork({\n        identity: {\n          publicKey: identity.publicKey,\n          privateKey: identity.privateKey,\n        },\n        transports: [],\n      });\n\n      // Simulate peer connection\n      const peerId = 'connected-peer';\n      const peer = createPeer(peerId, new Uint8Array(32), 'webrtc');\n      \n      // Add peer through network's routing table\n      network['routingTable'].addPeer(peer);\n\n      const stats = await network.getStats();\n      expect(stats.routing.peerCount).toBe(1);\n    });\n\n    it('should handle message sending through network', async () => {\n      const network = new MeshNetwork({\n        identity: {\n          publicKey: identity.publicKey,\n          privateKey: identity.privateKey,\n        },\n        transports: [],\n      });\n\n      const peerId = 'message-peer';\n      const peer = createPeer(peerId, new Uint8Array(32), 'webrtc');\n      network['routingTable'].addPeer(peer);\n\n      let receivedMessage: any;\n      network.onMessage = (msg: any) => {\n        receivedMessage = msg;\n      };\n\n      // Send message\n      const message = 'Test message';\n      await network.sendMessage(peerId, message);\n\n      // Verify message was processed\n      expect(receivedMessage).toBeDefined();\n      expect(receivedMessage.payload).toEqual(new TextEncoder().encode(message));\n    });\n  });\n\n  describe('End-to-End Workflow', () => {\n    it('should handle complete message workflow', async () => {\n      // Setup network with multiple peers\n      const peer1 = createPeer('peer1', new Uint8Array(32), 'webrtc');\n      const peer2 = createPeer('peer2', new Uint8Array(32), 'webrtc');\n      \n      routingTable.addPeer(peer1);\n      routingTable.addPeer(peer2);\n\n      let messageFlow: string[] = [];\n      \n      relay.onMessageForSelf((msg: Message) => {\n        messageFlow.push('delivered');\n      });\n      \n      relay.onForwardMessage((msg: Message, excludePeerId: string) => {\n        messageFlow.push('forwarded');\n      });\n\n      // Send message from peer1 to peer2\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 10,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32), // peer1 public key\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode(JSON.stringify({\n          text: 'End-to-end test',\n          recipient: 'peer2'\n        })),\n      };\n\n      await relay.processMessage(encodeMessage(message), 'peer1');\n\n      // Verify message flow\n      expect(messageFlow).toContain('forwarded');\n    });\n\n    it('should handle peer reputation updates', async () => {\n      const peerId = 'reputation-peer';\n      const peer = createPeer(peerId, new Uint8Array(32), 'webrtc');\n      routingTable.addPeer(peer);\n\n      // Simulate successful interactions\n      routingTable.updatePeerReputation(peerId, true);\n      routingTable.updatePeerReputation(peerId, true);\n      routingTable.updatePeerReputation(peerId, true);\n\n      // Simulate failed interactions\n      routingTable.updatePeerReputation(peerId, false);\n      routingTable.updatePeerReputation(peerId, false);\n\n      const updatedPeer = routingTable.getPeer(peerId);\n      expect(updatedPeer?.metadata.successCount).toBe(3);\n      expect(updatedPeer?.metadata.failureCount).toBe(2);\n      expect(updatedPeer?.metadata.reputation).toBeGreaterThan(45);\n    });\n  });\n});\n"],"version":3}