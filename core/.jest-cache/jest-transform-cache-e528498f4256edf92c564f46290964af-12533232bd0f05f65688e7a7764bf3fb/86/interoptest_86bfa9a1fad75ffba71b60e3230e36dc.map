{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/interop.test.ts","mappings":"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","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/interop.test.ts"],"sourcesContent":["import { MeshNetwork } from \"./network.js\"; // Added .js\nimport type { Transport } from \"./transport/Transport.js\"; // Correct casing // Added .js\nimport type { Message } from \"../protocol/message.js\"; // Ensure Message is imported as type only\nimport { jest } from \"@jest/globals\";\n// Removed Transport import since we don't need the interface in JS\n\n// Mock Transport in JS\nclass MockTransport implements Transport {\n  name: string;\n  onMessage: (from: string, data: Uint8Array) => void = () => {};\n  onPeerConnect: (peerId: string) => void = () => {};\n  onPeerDisconnect: (peerId: string) => void = () => {};\n\n  constructor(name: string) {\n    this.name = name;\n  }\n\n  async start(options?: any) {\n    if (options) {\n      if (options.onPeerConnected) this.onPeerConnect = options.onPeerConnected;\n      if (options.onPeerDisconnected)\n        this.onPeerDisconnect = options.onPeerDisconnected;\n      if (options.onMessage) this.onMessage = options.onMessage;\n    }\n  }\n  async stop() {}\n\n  // State tracking\n  connectedPeers: Set<string> = new Set();\n\n  // Simulate finding a peer\n  simulateConnect(peerId: string) {\n    // Normalize peer ID for consistent storage (match TransportManager behavior)\n    const normalizedId = peerId.replace(/\\s/g, \"\").toUpperCase();\n    this.connectedPeers.add(normalizedId);\n    if (this.onPeerConnect) this.onPeerConnect(normalizedId);\n  }\n\n  // Simulate losing a peer\n  simulateDisconnect(peerId: string) {\n    // Normalize peer ID for consistent storage (match TransportManager behavior)\n    const normalizedId = peerId.replace(/\\s/g, \"\").toUpperCase();\n    this.connectedPeers.delete(normalizedId);\n    if (this.onPeerDisconnect) this.onPeerDisconnect(normalizedId);\n  }\n\n  // Simulate receiving data\n  simulateMessage(from: string, data: Uint8Array) {\n    if (this.onMessage) this.onMessage(from, data);\n  }\n\n  async send(peerId: string, data: Uint8Array) {\n    return Promise.resolve();\n  }\n\n  // Implement missing interface properties\n  localPeerId: string = \"mock-local-id\";\n  async connect(peerId: string, signalingData: any): Promise<void> {}\n  async disconnect(peerId: string): Promise<void> {}\n  async broadcast(data: Uint8Array): Promise<void> {}\n  async getMetrics() {\n    return [];\n  }\n  async getPeers() {\n    return [];\n  }\n\n  // Missing methods\n  getConnectedPeers() {\n    return Array.from(this.connectedPeers);\n  }\n  getPeerInfo(peerId: string) {\n    if (this.connectedPeers.has(peerId)) {\n      return { peerId, state: \"connected\" as const, transportType: this.name };\n    }\n    return undefined;\n  }\n  getConnectionState(peerId: string) {\n    // Normalize peer ID for consistent lookup (match TransportManager behavior)\n    const normalizedId = peerId.replace(/\\s/g, \"\").toUpperCase();\n    return this.connectedPeers.has(normalizedId) ? \"connected\" : \"disconnected\";\n  }\n}\n\ndescribe(\"Cross-Platform Interop & Roaming\", () => {\n  let desktopNode: MeshNetwork;\n  let transportLAN: MockTransport;\n  let transportBLE: MockTransport;\n\n  beforeEach(async () => {\n    // Setup \"Desktop\" node with multiple transports\n    desktopNode = new MeshNetwork();\n\n    // Manually inject transports since we can't easily access the internal map\n    // assuming MeshNetwork has a transportManager property\n    transportLAN = new MockTransport(\"lan\");\n    transportBLE = new MockTransport(\"ble\");\n\n    // We need to register these. If registerTransport isn't public, we inject.\n    if (\n      (desktopNode as any).transportManager &&\n      (desktopNode as any).transportManager.registerTransport\n    ) {\n      (desktopNode as any).transportManager.registerTransport(transportLAN);\n      (desktopNode as any).transportManager.registerTransport(transportBLE);\n    } else {\n      console.warn(\"Could not register transports on desktopNode\");\n    }\n\n    // Start the node to bind listeners\n    await desktopNode.start();\n  });\n\n  test(\"Scenario A: Desktop discovers Mobile via LAN\", () => {\n    const mobilePeerId = \"mobile-peer-123\";\n\n    // 1. Simulate discovery via mDNS/LAN\n    transportLAN.simulateConnect(mobilePeerId);\n\n    // 2. Verify peer is added to routing table\n    const peer = (desktopNode as any).routingTable.getPeer(mobilePeerId);\n    expect(peer).toBeDefined();\n  });\n\n  test(\"Scenario B: Seamless Roaming (LAN -> BLE)\", () => {\n    const mobilePeerId = \"mobile-peer-roaming\";\n\n    // 1. Connect via LAN\n    transportLAN.simulateConnect(mobilePeerId);\n    expect(\n      (desktopNode as any).routingTable.getPeer(mobilePeerId),\n    ).toBeDefined();\n\n    // 2. Connect via BLE (Dual stack)\n    transportBLE.simulateConnect(mobilePeerId);\n\n    // 3. Disconnect LAN (Walking away from WiFi)\n    transportLAN.simulateDisconnect(mobilePeerId);\n\n    // 4. Verify peer is STILL connected (via BLE)\n    // Note: usage might need to be checked in RoutingTable to ensure it didn't remove the peer entirely\n    const peer = (desktopNode as any).routingTable.getPeer(mobilePeerId);\n    expect(peer).toBeDefined();\n  });\n\n  test(\"Scenario C: Transport Redundancy\", async () => {\n    const mobilePeerId = \"mobile-peer-redundant\";\n\n    // Connect both\n    transportLAN.simulateConnect(mobilePeerId);\n    transportBLE.simulateConnect(mobilePeerId);\n\n    // Spy on send\n    const sendSpy = jest.spyOn((desktopNode as any).transportManager, \"send\");\n\n    // Send a message\n    // Send a message\n    // desktopNode might not expose send directly if it's strictly handling routing internally\n    await (desktopNode as any).transportManager.send(\n      mobilePeerId,\n      new Uint8Array([1, 2, 3]),\n    );\n\n    // Verify it tries to send.\n    expect(sendSpy).toHaveBeenCalled();\n  });\n});\n"],"version":3}