e9fd63083c371b81ef0ea33165747428
"use strict";
/**
 * Database Schema - IndexedDB schema definitions
 * Task 183: Database schema and migration system
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.STORE_CONFIGS = exports.DB_VERSION = exports.DB_NAME = void 0;
exports.initializeDatabase = initializeDatabase;
exports.clearDatabase = clearDatabase;
exports.getDatabaseSize = getDatabaseSize;
exports.DB_NAME = 'SovereignCommunications';
exports.DB_VERSION = 2; // Incremented for V1 persistence stores
exports.STORE_CONFIGS = {
    messages: {
        keyPath: 'id',
        indexes: [
            { name: 'conversationId', keyPath: 'conversationId', unique: false },
            { name: 'timestamp', keyPath: 'timestamp', unique: false },
            { name: 'senderId', keyPath: 'senderId', unique: false },
            { name: 'status', keyPath: 'status', unique: false }
        ]
    },
    contacts: {
        keyPath: 'id',
        indexes: [
            { name: 'publicKey', keyPath: 'publicKey', unique: true },
            { name: 'addedAt', keyPath: 'addedAt', unique: false }
        ]
    },
    conversations: {
        keyPath: 'id',
        indexes: [
            { name: 'lastMessageTime', keyPath: 'lastMessageTime', unique: false },
            { name: 'type', keyPath: 'type', unique: false }
        ]
    },
    peers: {
        keyPath: 'id',
        indexes: [
            { name: 'publicKey', keyPath: 'publicKey', unique: true },
            { name: 'lastSeen', keyPath: 'lastSeen', unique: false },
            { name: 'connected', keyPath: 'connected', unique: false }
        ]
    },
    files: {
        keyPath: 'id',
        indexes: [
            { name: 'messageId', keyPath: 'messageId', unique: false },
            { name: 'hash', keyPath: 'hash', unique: false }
        ]
    },
    settings: {
        keyPath: 'id'
    },
    keypair: {
        keyPath: 'id'
    },
    // New stores for V1 persistence
    identities: {
        keyPath: 'id',
        indexes: [
            { name: 'fingerprint', keyPath: 'fingerprint', unique: true },
            { name: 'isPrimary', keyPath: 'isPrimary', unique: false },
            { name: 'createdAt', keyPath: 'createdAt', unique: false }
        ]
    },
    persistedPeers: {
        keyPath: 'id',
        indexes: [
            { name: 'publicKey', keyPath: 'publicKey', unique: true },
            { name: 'lastSeen', keyPath: 'lastSeen', unique: false },
            { name: 'isBlacklisted', keyPath: 'isBlacklisted', unique: false },
            { name: 'transportType', keyPath: 'transportType', unique: false },
            { name: 'reputation', keyPath: 'reputation', unique: false }
        ]
    },
    routes: {
        keyPath: 'destinationId',
        indexes: [
            { name: 'nextHopId', keyPath: 'nextHopId', unique: false },
            { name: 'lastUpdated', keyPath: 'lastUpdated', unique: false },
            { name: 'cost', keyPath: 'cost', unique: false }
        ]
    },
    sessionKeys: {
        keyPath: 'peerId',
        indexes: [
            { name: 'expiresAt', keyPath: 'expiresAt', unique: false },
            { name: 'createdAt', keyPath: 'createdAt', unique: false }
        ]
    }
};
/**
 * Initialize database with schema
 */
function initializeDatabase() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(exports.DB_NAME, exports.DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            // Create object stores
            Object.entries(exports.STORE_CONFIGS).forEach(([storeName, config]) => {
                if (!db.objectStoreNames.contains(storeName)) {
                    const store = db.createObjectStore(storeName, {
                        keyPath: config.keyPath
                    });
                    // Create indexes
                    if ('indexes' in config && config.indexes) {
                        config.indexes.forEach(index => {
                            store.createIndex(index.name, index.keyPath, {
                                unique: index.unique || false
                            });
                        });
                    }
                }
            });
        };
    });
}
/**
 * Clear all data from database
 */
async function clearDatabase() {
    const db = await initializeDatabase();
    const transaction = db.transaction(Array.from(db.objectStoreNames), 'readwrite');
    Array.from(db.objectStoreNames).forEach(storeName => {
        transaction.objectStore(storeName).clear();
    });
    return new Promise((resolve, reject) => {
        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject(transaction.error);
    });
}
/**
 * Get database size estimate
 */
async function getDatabaseSize() {
    if ('storage' in navigator && 'estimate' in navigator.storage) {
        const estimate = await navigator.storage.estimate();
        const usage = estimate.usage || 0;
        const quota = estimate.quota || 0;
        const percentage = quota > 0 ? (usage / quota) * 100 : 0;
        return { usage, quota, percentage };
    }
    return { usage: 0, quota: 0, percentage: 0 };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvZGItc2NoZW1hLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQTJQSCxnREE2QkM7QUFLRCxzQ0FlQztBQUtELDBDQWVDO0FBOVRZLFFBQUEsT0FBTyxHQUFHLHlCQUF5QixDQUFDO0FBQ3BDLFFBQUEsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDLHdDQUF3QztBQW9LeEQsUUFBQSxhQUFhLEdBQUc7SUFDM0IsUUFBUSxFQUFFO1FBQ1IsT0FBTyxFQUFFLElBQUk7UUFDYixPQUFPLEVBQUU7WUFDUCxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRTtZQUNwRSxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFO1lBQzFELEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7WUFDeEQsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRTtTQUNyRDtLQUNGO0lBQ0QsUUFBUSxFQUFFO1FBQ1IsT0FBTyxFQUFFLElBQUk7UUFDYixPQUFPLEVBQUU7WUFDUCxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO1lBQ3pELEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7U0FDdkQ7S0FDRjtJQUNELGFBQWEsRUFBRTtRQUNiLE9BQU8sRUFBRSxJQUFJO1FBQ2IsT0FBTyxFQUFFO1lBQ1AsRUFBRSxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1B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QUssR0FBRyxRQUFRLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztRQUNsQyxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztRQUNsQyxNQUFNLFVBQVUsR0FBRyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV6RCxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRUQsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxVQUFVLEVBQUUsQ0FBQyxFQUFFLENBQUM7QUFDL0MsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvY2hyaXN0eW1heHdlbGwvRGVza3RvcC9MdWtlX1N0dWZmL0dpdEh1Yi9TQy9jb3JlL3NyYy9kYi1zY2hlbWEudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBEYXRhYmFzZSBTY2hlbWEgLSBJbmRleGVkREIgc2NoZW1hIGRlZmluaXRpb25zXG4gKiBUYXNrIDE4MzogRGF0YWJhc2Ugc2NoZW1hIGFuZCBtaWdyYXRpb24gc3lzdGVtXG4gKi9cblxuZXhwb3J0IGNvbnN0IERCX05BTUUgPSAnU292ZXJlaWduQ29tbXVuaWNhdGlvbnMnO1xuZXhwb3J0IGNvbnN0IERCX1ZFUlNJT04gPSAyOyAvLyBJbmNyZW1lbnRlZCBmb3IgVjEgcGVyc2lzdGVuY2Ugc3RvcmVzXG5cbmV4cG9ydCBpbnRlcmZhY2UgTWVzc2FnZSB7XG4gIGlkOiBzdHJpbmc7XG4gIGNvbnZlcnNhdGlvbklkOiBzdHJpbmc7XG4gIHNlbmRlcklkOiBzdHJpbmc7XG4gIHJlY2lwaWVudElkOiBzdHJpbmc7XG4gIGNvbnRlbnQ6IHN0cmluZztcbiAgdGltZXN0YW1wOiBudW1iZXI7XG4gIHR5cGU6ICd0ZXh0JyB8ICdmaWxlJyB8ICd2b2ljZScgfCAndmlkZW8nO1xuICBlbmNyeXB0ZWQ6IGJvb2xlYW47XG4gIHNpZ25hdHVyZT86IHN0cmluZztcbiAgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICBzdGF0dXM6ICdwZW5kaW5nJyB8ICdzZW50JyB8ICdkZWxpdmVyZWQnIHwgJ3JlYWQnIHwgJ2ZhaWxlZCc7XG4gIHJlcGx5VG9JZD86IHN0cmluZztcbiAgcmVhY3Rpb25zPzogQXJyYXk8eyB1c2VySWQ6IHN0cmluZzsgZW1vamk6IHN0cmluZyB9Pjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb250YWN0IHtcbiAgaWQ6IHN0cmluZztcbiAgcHVibGljS2V5OiBzdHJpbmc7XG4gIG5hbWU/OiBzdHJpbmc7XG4gIGF2YXRhcj86IHN0cmluZztcbiAgbGFzdFNlZW4/OiBudW1iZXI7XG4gIGFkZGVkQXQ6IG51bWJlcjtcbiAgdmVyaWZpZWQ6IGJvb2xlYW47XG4gIGJsb2NrZWQ6IGJvb2xlYW47XG4gIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55Pjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb252ZXJzYXRpb24ge1xuICBpZDogc3RyaW5nO1xuICB0eXBlOiAnZGlyZWN0JyB8ICdncm91cCc7XG4gIHBhcnRpY2lwYW50SWRzOiBzdHJpbmdbXTtcbiAgbmFtZT86IHN0cmluZztcbiAgYXZhdGFyPzogc3RyaW5nO1xuICBsYXN0TWVzc2FnZUlkPzogc3RyaW5nO1xuICBsYXN0TWVzc2FnZVRpbWU/OiBudW1iZXI7XG4gIHVucmVhZENvdW50OiBudW1iZXI7XG4gIG11dGVkOiBib29sZWFuO1xuICBhcmNoaXZlZDogYm9vbGVhbjtcbiAgY3JlYXRlZEF0OiBudW1iZXI7XG4gIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55Pjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQZWVyIHtcbiAgaWQ6IHN0cmluZztcbiAgcHVibGljS2V5OiBzdHJpbmc7XG4gIGxhc3RTZWVuOiBudW1iZXI7XG4gIGNvbm5lY3RlZDogYm9vbGVhbjtcbiAgY29ubmVjdGlvblR5cGU6ICd3ZWJydGMnIHwgJ2JsZScgfCAnd2lmaSc7XG4gIHNpZ25hbFN0cmVuZ3RoPzogbnVtYmVyO1xuICBsYXRlbmN5PzogbnVtYmVyO1xuICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmlsZU1ldGFkYXRhIHtcbiAgaWQ6IHN0cmluZztcbiAgbWVzc2FnZUlkOiBzdHJpbmc7XG4gIG5hbWU6IHN0cmluZztcbiAgc2l6ZTogbnVtYmVyO1xuICBtaW1lVHlwZTogc3RyaW5nO1xuICBoYXNoOiBzdHJpbmc7XG4gIGVuY3J5cHRpb25LZXk/OiBzdHJpbmc7XG4gIHRodW1ibmFpbD86IHN0cmluZztcbiAgdXBsb2FkZWRBdDogbnVtYmVyO1xuICBzdGF0dXM6ICd1cGxvYWRpbmcnIHwgJ3VwbG9hZGVkJyB8ICdkb3dubG9hZGluZycgfCAnZG93bmxvYWRlZCcgfCAnZmFpbGVkJztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTZXR0aW5ncyB7XG4gIGlkOiAndXNlcl9zZXR0aW5ncyc7XG4gIHRoZW1lOiAnbGlnaHQnIHwgJ2RhcmsnIHwgJ3N5c3RlbSc7XG4gIG5vdGlmaWNhdGlvbnM6IHtcbiAgICBlbmFibGVkOiBib29sZWFuO1xuICAgIHNvdW5kOiBib29sZWFuO1xuICAgIHZpYnJhdGU6IGJvb2xlYW47XG4gICAgc2hvd1ByZXZpZXdzOiBib29sZWFuO1xuICB9O1xuICBwcml2YWN5OiB7XG4gICAgcmVhZFJlY2VpcHRzOiBib29sZWFuO1xuICAgIHR5cGluZ0luZGljYXRvcnM6IGJvb2xlYW47XG4gICAgbGFzdFNlZW46IGJvb2xlYW47XG4gIH07XG4gIG1lZGlhOiB7XG4gICAgYXV0b0Rvd25sb2FkOiBib29sZWFuO1xuICAgIGRvd25sb2FkT25XaWZpOiBib29sZWFuO1xuICAgIG1heEZpbGVTaXplOiBudW1iZXI7XG4gIH07XG4gIG5ldHdvcms6IHtcbiAgICBlbmFibGVXZWJSVEM6IGJvb2xlYW47XG4gICAgZW5hYmxlQkxFOiBib29sZWFuO1xuICAgIG1heFBlZXJzOiBudW1iZXI7XG4gIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgS2V5UGFpciB7XG4gIGlkOiAnaWRlbnRpdHlfa2V5cGFpcic7XG4gIHB1YmxpY0tleTogc3RyaW5nO1xuICBwcml2YXRlS2V5OiBzdHJpbmc7XG4gIGNyZWF0ZWRBdDogbnVtYmVyO1xufVxuXG4vKipcbiAqIElkZW50aXR5IC0gVXNlcidzIGNyeXB0b2dyYXBoaWMgaWRlbnRpdHlcbiAqIEZvciBzb3ZlcmVpZ250eTogY2FuIGhhdmUgbXVsdGlwbGUgaWRlbnRpdGllcywgb25lIGlzIHByaW1hcnlcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJZGVudGl0eSB7XG4gIGlkOiBzdHJpbmc7XG4gIHB1YmxpY0tleTogVWludDhBcnJheTtcbiAgcHJpdmF0ZUtleTogVWludDhBcnJheTsgLy8gV2lsbCBiZSBlbmNyeXB0ZWQgYXQgcmVzdFxuICBmaW5nZXJwcmludDogc3RyaW5nOyAvLyBTSEEtMjU2IGhhc2ggb2YgcHVibGljIGtleVxuICBjcmVhdGVkQXQ6IG51bWJlcjtcbiAgbGFiZWw/OiBzdHJpbmc7IC8vIEh1bWFuLXJlYWRhYmxlIGxhYmVsXG4gIGlzUHJpbWFyeTogYm9vbGVhbjsgLy8gT25seSBvbmUgY2FuIGJlIHByaW1hcnlcbn1cblxuLyoqXG4gKiBQZXJzaXN0ZWRQZWVyIC0gRXh0ZW5kZWQgcGVlciBpbmZvIGZvciBwZXJzaXN0ZW5jZVxuICogSW5jbHVkZXMgcmVwdXRhdGlvbiBhbmQgbWVzaCByb3V0aW5nIG1ldGFkYXRhXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUGVyc2lzdGVkUGVlciB7XG4gIGlkOiBzdHJpbmc7XG4gIHB1YmxpY0tleTogc3RyaW5nO1xuICB0cmFuc3BvcnRUeXBlOiAnd2VicnRjJyB8ICdibGUnIHwgJ3dpZmknO1xuICBsYXN0U2VlbjogbnVtYmVyO1xuICBjb25uZWN0ZWRBdDogbnVtYmVyO1xuICBjb25uZWN0aW9uUXVhbGl0eTogbnVtYmVyOyAvLyAwLTEwMFxuICBieXRlc1NlbnQ6IG51bWJlcjtcbiAgYnl0ZXNSZWNlaXZlZDogbnVtYmVyO1xuICByZXB1dGF0aW9uOiBudW1iZXI7IC8vIDAtMTAwLCBhZmZlY3RzIHJvdXRpbmcgZGVjaXNpb25zXG4gIGlzQmxhY2tsaXN0ZWQ6IGJvb2xlYW47XG4gIGJsYWNrbGlzdGVkVW50aWw/OiBudW1iZXI7IC8vIFVuaXggdGltZXN0YW1wXG4gIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55Pjtcbn1cblxuLyoqXG4gKiBSb3V0ZSAtIE1lc2ggcm91dGluZyB0YWJsZSBlbnRyeVxuICogVXNlZCB0byB3YXJtLXN0YXJ0IHJvdXRpbmcgb24gYXBwIHJlbG9hZFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFJvdXRlIHtcbiAgZGVzdGluYXRpb25JZDogc3RyaW5nOyAvLyBQZWVyIElEIHdlJ3JlIHJvdXRpbmcgdG9cbiAgbmV4dEhvcElkOiBzdHJpbmc7IC8vIE5leHQgcGVlciBpbiB0aGUgcGF0aFxuICBjb3N0OiBudW1iZXI7IC8vIFJvdXRpbmcgY29zdCAobG93ZXIgaXMgYmV0dGVyKVxuICBsYXN0VXBkYXRlZDogbnVtYmVyOyAvLyBVbml4IHRpbWVzdGFtcFxuICB0dGw6IG51bWJlcjsgLy8gU2Vjb25kcyB1bnRpbCByb3V0ZSBleHBpcmVzXG4gIG1ldHJpY3M/OiB7XG4gICAgbGF0ZW5jeTogbnVtYmVyOyAvLyBBdmVyYWdlIGxhdGVuY3kgaW4gbXNcbiAgICBzdWNjZXNzUmF0ZTogbnVtYmVyOyAvLyAwLTEsIG1lc3NhZ2UgZGVsaXZlcnkgc3VjY2VzcyByYXRlXG4gIH07XG59XG5cbi8qKlxuICogU2Vzc2lvbktleSAtIEVuY3J5cHRlZCBzZXNzaW9uIGtleSBmb3IgYSBwZWVyXG4gKiBFbmFibGVzIFBlcmZlY3QgRm9yd2FyZCBTZWNyZWN5IC0gcm90YXRlcyByZWd1bGFybHlcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTZXNzaW9uS2V5IHtcbiAgcGVlcklkOiBzdHJpbmc7XG4gIGtleTogVWludDhBcnJheTsgLy8gRW5jcnlwdGVkIHdpdGggbWFzdGVyIGtleVxuICBub25jZTogVWludDhBcnJheTsgLy8gRm9yIFhDaGFDaGEyMC1Qb2x5MTMwNVxuICBjcmVhdGVkQXQ6IG51bWJlcjtcbiAgbWVzc2FnZUNvdW50OiBudW1iZXI7IC8vIE51bWJlciBvZiBtZXNzYWdlcyBzZW50IHdpdGggdGhpcyBrZXlcbiAgZXhwaXJlc0F0OiBudW1iZXI7IC8vIFVuaXggdGltZXN0YW1wIHdoZW4ga2V5IHNob3VsZCByb3RhdGVcbn1cblxuZXhwb3J0IGNvbnN0IFNUT1JFX0NPTkZJR1MgPSB7XG4gIG1lc3NhZ2VzOiB7XG4gICAga2V5UGF0aDogJ2lkJyxcbiAgICBpbmRleGVzOiBbXG4gICAgICB7IG5hbWU6ICdjb252ZXJzYXRpb25JZCcsIGtleVBhdGg6ICdjb252ZXJzYXRpb25JZCcsIHVuaXF1ZTogZmFsc2UgfSxcbiAgICAgIHsgbmFtZTogJ3RpbWVzdGFtcCcsIGtleVBhdGg6ICd0aW1lc3RhbXAnLCB1bmlxdWU6IGZhbHNlIH0sXG4gICAgICB7IG5hbWU6ICdzZW5kZXJJZCcsIGtleVBhdGg6ICdzZW5kZXJJZCcsIHVuaXF1ZTogZmFsc2UgfSxcbiAgICAgIHsgbmFtZTogJ3N0YXR1cycsIGtleVBhdGg6ICdzdGF0dXMnLCB1bmlxdWU6IGZhbHNlIH1cbiAgICBdXG4gIH0sXG4gIGNvbnRhY3RzOiB7XG4gICAga2V5UGF0aDogJ2lkJyxcbiAgICBpbmRleGVzOiBbXG4gICAgICB7IG5hbWU6ICdwdWJsaWNLZXknLCBrZXlQYXRoOiAncHVibGljS2V5JywgdW5pcXVlOiB0cnVlIH0sXG4gICAgICB7IG5hbWU6ICdhZGRlZEF0Jywga2V5UGF0aDogJ2FkZGVkQXQnLCB1bmlxdWU6IGZhbHNlIH1cbiAgICBdXG4gIH0sXG4gIGNvbnZlcnNhdGlvbnM6IHtcbiAgICBrZXlQYXRoOiAnaWQnLFxuICAgIGluZGV4ZXM6IFtcbiAgICAgIHsgbmFtZTogJ2xhc3RNZXNzYWdlVGltZScsIGtleVBhdGg6ICdsYXN0TWVzc2FnZVRpbWUnLCB1bmlxdWU6IGZhbHNlIH0sXG4gICAgICB7IG5hbWU6ICd0eXBlJywga2V5UGF0aDogJ3R5cGUnLCB1bmlxdWU6IGZhbHNlIH1cbiAgICBdXG4gIH0sXG4gIHBlZXJzOiB7XG4gICAga2V5UGF0aDogJ2lkJyxcbiAgICBpbmRleGVzOiBbXG4gICAgICB7IG5hbWU6ICdwdWJsaWNLZXknLCBrZXlQYXRoOiAncHVibGljS2V5JywgdW5pcXVlOiB0cnVlIH0sXG4gICAgICB7IG5hbWU6ICdsYXN0U2VlbicsIGtleVBhdGg6ICdsYXN0U2VlbicsIHVuaXF1ZTogZmFsc2UgfSxcbiAgICAgIHsgbmFtZTogJ2Nvbm5lY3RlZCcsIGtleVBhdGg6ICdjb25uZWN0ZWQnLCB1bmlxdWU6IGZhbHNlIH1cbiAgICBdXG4gIH0sXG4gIGZpbGVzOiB7XG4gICAga2V5UGF0aDogJ2lkJyxcbiAgICBpbmRleGVzOiBbXG4gICAgICB7IG5hbWU6ICdtZXNzYWdlSWQnLCBrZXlQYXRoOiAnbWVzc2FnZUlkJywgdW5pcXVlOiBmYWxzZSB9LFxuICAgICAgeyBuYW1lOiAnaGFzaCcsIGtleVBhdGg6ICdoYXNoJywgdW5pcXVlOiBmYWxzZSB9XG4gICAgXVxuICB9LFxuICBzZXR0aW5nczoge1xuICAgIGtleVBhdGg6ICdpZCdcbiAgfSxcbiAga2V5cGFpcjoge1xuICAgIGtleVBhdGg6ICdpZCdcbiAgfSxcbiAgLy8gTmV3IHN0b3JlcyBmb3IgVjEgcGVyc2lzdGVuY2VcbiAgaWRlbnRpdGllczoge1xuICAgIGtleVBhdGg6ICdpZCcsXG4gICAgaW5kZXhlczogW1xuICAgICAgeyBuYW1lOiAnZmluZ2VycHJpbnQnLCBrZXlQYXRoOiAnZmluZ2VycHJpbnQnLCB1bmlxdWU6IHRydWUgfSxcbiAgICAgIHsgbmFtZTogJ2lzUHJpbWFyeScsIGtleVBhdGg6ICdpc1ByaW1hcnknLCB1bmlxdWU6IGZhbHNlIH0sXG4gICAgICB7IG5hbWU6ICdjcmVhdGVkQXQnLCBrZXlQYXRoOiAnY3JlYXRlZEF0JywgdW5pcXVlOiBmYWxzZSB9XG4gICAgXVxuICB9LFxuICBwZXJzaXN0ZWRQZWVyczoge1xuICAgIGtleVBhdGg6ICdpZCcsXG4gICAgaW5kZXhlczogW1xuICAgICAgeyBuYW1lOiAncHVibGljS2V5Jywga2V5UGF0aDogJ3B1YmxpY0tleScsIHVuaXF1ZTogdHJ1ZSB9LFxuICAgICAgeyBuYW1lOiAnbGFzdFNlZW4nLCBrZXlQYXRoOiAnbGFzdFNlZW4nLCB1bmlxdWU6IGZhbHNlIH0sXG4gICAgICB7IG5hbWU6ICdpc0JsYWNrbGlzdGVkJywga2V5UGF0aDogJ2lzQmxhY2tsaXN0ZWQnLCB1bmlxdWU6IGZhbHNlIH0sXG4gICAgICB7IG5hbWU6ICd0cmFuc3BvcnRUeXBlJywga2V5UGF0aDogJ3RyYW5zcG9ydFR5cGUnLCB1bmlxdWU6IGZhbHNlIH0sXG4gICAgICB7IG5hbWU6ICdyZXB1dGF0aW9uJywga2V5UGF0aDogJ3JlcHV0YXRpb24nLCB1bmlxdWU6IGZhbHNlIH1cbiAgICBdXG4gIH0sXG4gIHJvdXRlczoge1xuICAgIGtleVBhdGg6ICdkZXN0aW5hdGlvbklkJyxcbiAgICBpbmRleGVzOiBbXG4gICAgICB7IG5hbWU6ICduZXh0SG9wSWQnLCBrZXlQYXRoOiAnbmV4dEhvcElkJywgdW5pcXVlOiBmYWxzZSB9LFxuICAgICAgeyBuYW1lOiAnbGFzdFVwZGF0ZWQnLCBrZXlQYXRoOiAnbGFzdFVwZGF0ZWQnLCB1bmlxdWU6IGZhbHNlIH0sXG4gICAgICB7IG5hbWU6ICdjb3N0Jywga2V5UGF0aDogJ2Nvc3QnLCB1bmlxdWU6IGZhbHNlIH1cbiAgICBdXG4gIH0sXG4gIHNlc3Npb25LZXlzOiB7XG4gICAga2V5UGF0aDogJ3BlZXJJZCcsXG4gICAgaW5kZXhlczogW1xuICAgICAgeyBuYW1lOiAnZXhwaXJlc0F0Jywga2V5UGF0aDogJ2V4cGlyZXNBdCcsIHVuaXF1ZTogZmFsc2UgfSxcbiAgICAgIHsgbmFtZTogJ2NyZWF0ZWRBdCcsIGtleVBhdGg6ICdjcmVhdGVkQXQnLCB1bmlxdWU6IGZhbHNlIH1cbiAgICBdXG4gIH1cbn07XG5cbi8qKlxuICogSW5pdGlhbGl6ZSBkYXRhYmFzZSB3aXRoIHNjaGVtYVxuICovXG5leHBvcnQgZnVuY3Rpb24gaW5pdGlhbGl6ZURhdGFiYXNlKCk6IFByb21pc2U8SURCRGF0YWJhc2U+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gaW5kZXhlZERCLm9wZW4oREJfTkFNRSwgREJfVkVSU0lPTik7XG5cbiAgICByZXF1ZXN0Lm9uZXJyb3IgPSAoKSA9PiByZWplY3QocmVxdWVzdC5lcnJvcik7XG4gICAgcmVxdWVzdC5vbnN1Y2Nlc3MgPSAoKSA9PiByZXNvbHZlKHJlcXVlc3QucmVzdWx0KTtcblxuICAgIHJlcXVlc3Qub251cGdyYWRlbmVlZGVkID0gKGV2ZW50KSA9PiB7XG4gICAgICBjb25zdCBkYiA9IChldmVudC50YXJnZXQgYXMgSURCT3BlbkRCUmVxdWVzdCkucmVzdWx0O1xuXG4gICAgICAvLyBDcmVhdGUgb2JqZWN0IHN0b3Jlc1xuICAgICAgT2JqZWN0LmVudHJpZXMoU1RPUkVfQ09ORklHUykuZm9yRWFjaCgoW3N0b3JlTmFtZSwgY29uZmlnXSkgPT4ge1xuICAgICAgICBpZiAoIWRiLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoc3RvcmVOYW1lKSkge1xuICAgICAgICAgIGNvbnN0IHN0b3JlID0gZGIuY3JlYXRlT2JqZWN0U3RvcmUoc3RvcmVOYW1lLCB7XG4gICAgICAgICAgICBrZXlQYXRoOiBjb25maWcua2V5UGF0aFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgLy8gQ3JlYXRlIGluZGV4ZXNcbiAgICAgICAgICBpZiAoJ2luZGV4ZXMnIGluIGNvbmZpZyAmJiBjb25maWcuaW5kZXhlcykge1xuICAgICAgICAgICAgY29uZmlnLmluZGV4ZXMuZm9yRWFjaChpbmRleCA9PiB7XG4gICAgICAgICAgICAgIHN0b3JlLmNyZWF0ZUluZGV4KGluZGV4Lm5hbWUsIGluZGV4LmtleVBhdGgsIHtcbiAgICAgICAgICAgICAgICB1bmlxdWU6IGluZGV4LnVuaXF1ZSB8fCBmYWxzZVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfTtcbiAgfSk7XG59XG5cbi8qKlxuICogQ2xlYXIgYWxsIGRhdGEgZnJvbSBkYXRhYmFzZVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY2xlYXJEYXRhYmFzZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgZGIgPSBhd2FpdCBpbml0aWFsaXplRGF0YWJhc2UoKTtcbiAgY29uc3QgdHJhbnNhY3Rpb24gPSBkYi50cmFuc2FjdGlvbihcbiAgICBBcnJheS5mcm9tKGRiLm9iamVjdFN0b3JlTmFtZXMpLFxuICAgICdyZWFkd3JpdGUnXG4gICk7XG5cbiAgQXJyYXkuZnJvbShkYi5vYmplY3RTdG9yZU5hbWVzKS5mb3JFYWNoKHN0b3JlTmFtZSA9PiB7XG4gICAgdHJhbnNhY3Rpb24ub2JqZWN0U3RvcmUoc3RvcmVOYW1lKS5jbGVhcigpO1xuICB9KTtcblxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHRyYW5zYWN0aW9uLm9uY29tcGxldGUgPSAoKSA9PiByZXNvbHZlKCk7XG4gICAgdHJhbnNhY3Rpb24ub25lcnJvciA9ICgpID0+IHJlamVjdCh0cmFuc2FjdGlvbi5lcnJvcik7XG4gIH0pO1xufVxuXG4vKipcbiAqIEdldCBkYXRhYmFzZSBzaXplIGVzdGltYXRlXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXREYXRhYmFzZVNpemUoKTogUHJvbWlzZTx7XG4gIHVzYWdlOiBudW1iZXI7XG4gIHF1b3RhOiBudW1iZXI7XG4gIHBlcmNlbnRhZ2U6IG51bWJlcjtcbn0+IHtcbiAgaWYgKCdzdG9yYWdlJyBpbiBuYXZpZ2F0b3IgJiYgJ2VzdGltYXRlJyBpbiBuYXZpZ2F0b3Iuc3RvcmFnZSkge1xuICAgIGNvbnN0IGVzdGltYXRlID0gYXdhaXQgbmF2aWdhdG9yLnN0b3JhZ2UuZXN0aW1hdGUoKTtcbiAgICBjb25zdCB1c2FnZSA9IGVzdGltYXRlLnVzYWdlIHx8IDA7XG4gICAgY29uc3QgcXVvdGEgPSBlc3RpbWF0ZS5xdW90YSB8fCAwO1xuICAgIGNvbnN0IHBlcmNlbnRhZ2UgPSBxdW90YSA+IDAgPyAodXNhZ2UgLyBxdW90YSkgKiAxMDAgOiAwO1xuXG4gICAgcmV0dXJuIHsgdXNhZ2UsIHF1b3RhLCBwZXJjZW50YWdlIH07XG4gIH1cblxuICByZXR1cm4geyB1c2FnZTogMCwgcXVvdGE6IDAsIHBlcmNlbnRhZ2U6IDAgfTtcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==