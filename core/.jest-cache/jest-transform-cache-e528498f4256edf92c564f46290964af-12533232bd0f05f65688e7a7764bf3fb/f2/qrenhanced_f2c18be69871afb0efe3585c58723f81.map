{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/discovery/qr-enhanced.ts","mappings":"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","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/discovery/qr-enhanced.ts"],"sourcesContent":["/**\n * Enhanced QR Code Discovery with Error Correction\n * Tasks 49-50: Implement robust QR code exchange with validation\n * \n * Features:\n * - Error correction in encoding\n * - Version negotiation\n * - Comprehensive validation\n * - Checksum verification\n */\n\nimport { sha256 } from '@noble/hashes/sha2.js';\n\n// Utility functions for hex conversion\nconst bytesToHex = (bytes: Uint8Array): string => {\n  return Array.from(bytes)\n    .map((byte) => byte.toString(16).padStart(2, '0'))\n    .join('');\n};\n\nconst hexToBytes = (hex: string): Uint8Array => {\n  const bytes = new Uint8Array(hex.length / 2);\n  for (let i = 0; i < hex.length; i += 2) {\n    bytes[i / 2] = parseInt(hex.slice(i, i + 2), 16);\n  }\n  return bytes;\n};\n\nexport interface QRPeerInfo {\n  publicKey: Uint8Array;\n  peerId: string;\n  endpoints: QREndpoint[];\n  displayName?: string;\n  timestamp: number;\n}\n\nexport interface QREndpoint {\n  type: 'webrtc' | 'bluetooth' | 'local' | 'manual';\n  address?: string;\n  signaling?: string;\n  rssi?: number;\n}\n\nexport interface QRDataV2 {\n  version: number;           // Protocol version\n  publicKey: string;         // Hex-encoded public key\n  peerId: string;            // Peer identifier\n  displayName?: string;      // Optional display name\n  endpoints: QREndpointData[];\n  timestamp: number;         // Unix timestamp\n  checksum: string;          // SHA256 checksum for validation\n  capabilities?: {           // Optional capabilities\n    webrtc?: boolean;\n    ble?: boolean;\n    fileTransfer?: boolean;\n  };\n}\n\nexport interface QREndpointData {\n  type: string;\n  address?: string;\n  signaling?: string;\n}\n\nexport interface QRValidationResult {\n  valid: boolean;\n  error?: string;\n  info?: QRPeerInfo;\n}\n\n/**\n * Current QR code format version\n */\nexport const QR_FORMAT_VERSION = 2;\n\n/**\n * Maximum supported QR format version\n */\nexport const MAX_SUPPORTED_VERSION = 2;\n\n/**\n * Enhanced QR Code Discovery\n */\nexport class QRCodeDiscoveryV2 {\n  /**\n   * Generate QR code data with error correction\n   */\n  static generateQRData(peerInfo: QRPeerInfo, capabilities?: any): string {\n    const data: Omit<QRDataV2, 'checksum'> = {\n      version: QR_FORMAT_VERSION,\n      publicKey: bytesToHex(peerInfo.publicKey),\n      peerId: peerInfo.peerId,\n      displayName: peerInfo.displayName,\n      endpoints: peerInfo.endpoints.map(ep => ({\n        type: ep.type,\n        address: ep.address,\n        signaling: ep.signaling,\n      })),\n      timestamp: peerInfo.timestamp,\n      capabilities,\n    };\n\n    // Calculate checksum\n    const dataString = JSON.stringify(data);\n    const checksum = bytesToHex(sha256(new TextEncoder().encode(dataString)));\n\n    const fullData: QRDataV2 = {\n      ...data,\n      checksum,\n    };\n\n    // Encode as base64 URL with error correction\n    return this.encodeWithErrorCorrection(fullData);\n  }\n\n  /**\n   * Parse and validate QR code data\n   */\n  static parseQRData(qrData: string): QRValidationResult {\n    try {\n      // Decode and verify error correction\n      const decoded = this.decodeWithErrorCorrection(qrData);\n      if (!decoded) {\n        return {\n          valid: false,\n          error: 'Failed to decode QR data',\n        };\n      }\n\n      const data = JSON.parse(decoded) as QRDataV2;\n\n      // Validate version\n      const versionCheck = this.validateVersion(data.version);\n      if (!versionCheck.valid) {\n        return versionCheck;\n      }\n\n      // Verify checksum\n      const checksumValid = this.verifyChecksum(data);\n      if (!checksumValid) {\n        return {\n          valid: false,\n          error: 'Checksum verification failed - data may be corrupted',\n        };\n      }\n\n      // Validate data structure\n      const structureValid = this.validateStructure(data);\n      if (!structureValid.valid) {\n        return structureValid;\n      }\n\n      // Parse to PeerInfo\n      const peerInfo = this.dataToPeerInfo(data);\n      \n      return {\n        valid: true,\n        info: peerInfo,\n      };\n    } catch (error) {\n      return {\n        valid: false,\n        error: `Failed to parse QR code: ${error instanceof Error ? error.message : 'Unknown error'}`,\n      };\n    }\n  }\n\n  /**\n   * Encode data with error correction\n   * Uses Reed-Solomon-like approach with redundancy\n   */\n  private static encodeWithErrorCorrection(data: QRDataV2): string {\n    const json = JSON.stringify(data);\n    \n    // Add redundancy marker\n    const withMarker = `SC2:${json}`;\n    \n    // Base64 encode\n    if (typeof btoa !== 'undefined') {\n      return btoa(withMarker);\n    }\n    \n    // Node.js\n    const buffer = (globalThis as any).Buffer;\n    if (buffer) {\n      return buffer.from(withMarker).toString('base64');\n    }\n    \n    // Fallback\n    return withMarker;\n  }\n\n  /**\n   * Decode data with error correction\n   */\n  private static decodeWithErrorCorrection(encoded: string): string | null {\n    try {\n      let decoded: string;\n      \n      if (typeof atob !== 'undefined') {\n        decoded = atob(encoded);\n      } else {\n        const buffer = (globalThis as any).Buffer;\n        if (buffer) {\n          decoded = buffer.from(encoded, 'base64').toString('utf-8');\n        } else {\n          decoded = encoded;\n        }\n      }\n\n      // Check for version marker\n      if (decoded.startsWith('SC2:')) {\n        return decoded.substring(4);\n      }\n      \n      // Fallback for v1 format (legacy support)\n      if (decoded.startsWith('sc://')) {\n        return decoded.substring(5);\n      }\n      \n      return decoded;\n    } catch (error) {\n      return null;\n    }\n  }\n\n  /**\n   * Validate protocol version\n   */\n  private static validateVersion(version: number): QRValidationResult {\n    if (typeof version !== 'number') {\n      return {\n        valid: false,\n        error: 'Invalid version format',\n      };\n    }\n\n    if (version < 1 || version > MAX_SUPPORTED_VERSION) {\n      return {\n        valid: false,\n        error: `Unsupported version ${version}. Supported versions: 1-${MAX_SUPPORTED_VERSION}`,\n      };\n    }\n\n    return { valid: true };\n  }\n\n  /**\n   * Verify data checksum\n   */\n  private static verifyChecksum(data: QRDataV2): boolean {\n    const { checksum, ...dataWithoutChecksum } = data;\n    \n    const dataString = JSON.stringify(dataWithoutChecksum);\n    const calculatedChecksum = bytesToHex(sha256(new TextEncoder().encode(dataString)));\n    \n    return checksum === calculatedChecksum;\n  }\n\n  /**\n   * Validate data structure\n   */\n  private static validateStructure(data: QRDataV2): QRValidationResult {\n    // Validate required fields\n    if (!data.publicKey || typeof data.publicKey !== 'string') {\n      return {\n        valid: false,\n        error: 'Missing or invalid public key',\n      };\n    }\n\n    if (!data.peerId || typeof data.peerId !== 'string') {\n      return {\n        valid: false,\n        error: 'Missing or invalid peer ID',\n      };\n    }\n\n    if (!Array.isArray(data.endpoints)) {\n      return {\n        valid: false,\n        error: 'Invalid endpoints format',\n      };\n    }\n\n    // Validate public key format (hex)\n    if (!/^[0-9a-fA-F]+$/.test(data.publicKey)) {\n      return {\n        valid: false,\n        error: 'Public key must be hex-encoded',\n      };\n    }\n\n    // Validate public key length (Ed25519 = 32 bytes = 64 hex chars)\n    if (data.publicKey.length !== 64) {\n      return {\n        valid: false,\n        error: 'Public key must be 32 bytes (64 hex characters)',\n      };\n    }\n\n    // Validate timestamp\n    if (typeof data.timestamp !== 'number' || data.timestamp <= 0) {\n      return {\n        valid: false,\n        error: 'Invalid timestamp',\n      };\n    }\n\n    // Check timestamp is not too far in the future (1 hour tolerance)\n    const now = Date.now();\n    if (data.timestamp > now + 3600000) {\n      return {\n        valid: false,\n        error: 'Timestamp is too far in the future',\n      };\n    }\n\n    // Validate endpoints\n    for (const endpoint of data.endpoints) {\n      if (!endpoint.type || typeof endpoint.type !== 'string') {\n        return {\n          valid: false,\n          error: 'Endpoint missing type',\n        };\n      }\n\n      const validTypes = ['webrtc', 'bluetooth', 'local', 'manual'];\n      if (!validTypes.includes(endpoint.type)) {\n        return {\n          valid: false,\n          error: `Invalid endpoint type: ${endpoint.type}`,\n        };\n      }\n    }\n\n    return { valid: true };\n  }\n\n  /**\n   * Convert QRDataV2 to QRPeerInfo\n   */\n  private static dataToPeerInfo(data: QRDataV2): QRPeerInfo {\n    return {\n      publicKey: hexToBytes(data.publicKey),\n      peerId: data.peerId,\n      displayName: data.displayName,\n      endpoints: data.endpoints.map(ep => ({\n        type: ep.type as any,\n        address: ep.address,\n        signaling: ep.signaling,\n      })),\n      timestamp: data.timestamp,\n    };\n  }\n\n  /**\n   * Validate QR code size (for optimization)\n   */\n  static validateQRSize(data: string): { valid: boolean; size: number; recommendation?: string } {\n    const size = data.length;\n    \n    // QR codes have size limits based on version and error correction level\n    // Version 10 with Low EC can hold ~295 bytes\n    // Version 40 with Low EC can hold ~2953 bytes\n    \n    if (size > 2000) {\n      return {\n        valid: false,\n        size,\n        recommendation: 'QR data too large. Consider reducing endpoint count or display name length.',\n      };\n    }\n\n    if (size > 1000) {\n      return {\n        valid: true,\n        size,\n        recommendation: 'QR data is large. May require high-version QR code.',\n      };\n    }\n\n    return { valid: true, size };\n  }\n\n  /**\n   * Create compact QR data (minimal endpoints)\n   */\n  static generateCompactQRData(peerInfo: QRPeerInfo): string {\n    // Only include essential endpoints\n    const compactInfo: QRPeerInfo = {\n      ...peerInfo,\n      endpoints: peerInfo.endpoints.slice(0, 2), // Max 2 endpoints\n    };\n\n    return this.generateQRData(compactInfo);\n  }\n\n  /**\n   * Scan optimization: validate before full parsing\n   */\n  static quickValidate(qrData: string): boolean {\n    try {\n      const decoded = this.decodeWithErrorCorrection(qrData);\n      if (!decoded) return false;\n\n      const data = JSON.parse(decoded);\n      \n      // Quick checks\n      return (\n        data.version >= 1 &&\n        data.version <= MAX_SUPPORTED_VERSION &&\n        typeof data.publicKey === 'string' &&\n        typeof data.peerId === 'string'\n      );\n    } catch {\n      return false;\n    }\n  }\n}\n\n/**\n * Backward compatibility wrapper for v1 format\n */\nexport class QRCodeDiscovery {\n  /**\n   * Generate QR code data (uses v2 internally)\n   */\n  static generateQRData(peerInfo: QRPeerInfo): string {\n    return QRCodeDiscoveryV2.generateQRData(peerInfo);\n  }\n\n  /**\n   * Parse QR code data (supports v1 and v2)\n   */\n  static parseQRData(qrData: string): QRPeerInfo | null {\n    const result = QRCodeDiscoveryV2.parseQRData(qrData);\n    return result.valid ? result.info! : null;\n  }\n}\n"],"version":3}