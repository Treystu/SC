934046cc1ad25e6dc89d2fcbd6656a7c
"use strict";
/**
 * Enhanced QR Code Discovery with Error Correction
 * Tasks 49-50: Implement robust QR code exchange with validation
 *
 * Features:
 * - Error correction in encoding
 * - Version negotiation
 * - Comprehensive validation
 * - Checksum verification
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.QRCodeDiscovery = exports.QRCodeDiscoveryV2 = exports.MAX_SUPPORTED_VERSION = exports.QR_FORMAT_VERSION = void 0;
const sha2_js_1 = require("@noble/hashes/sha2.js");
// Utility functions for hex conversion
const bytesToHex = (bytes) => {
    return Array.from(bytes)
        .map((byte) => byte.toString(16).padStart(2, '0'))
        .join('');
};
const hexToBytes = (hex) => {
    const bytes = new Uint8Array(hex.length / 2);
    for (let i = 0; i < hex.length; i += 2) {
        bytes[i / 2] = parseInt(hex.slice(i, i + 2), 16);
    }
    return bytes;
};
/**
 * Current QR code format version
 */
exports.QR_FORMAT_VERSION = 2;
/**
 * Maximum supported QR format version
 */
exports.MAX_SUPPORTED_VERSION = 2;
/**
 * Enhanced QR Code Discovery
 */
class QRCodeDiscoveryV2 {
    /**
     * Generate QR code data with error correction
     */
    static generateQRData(peerInfo, capabilities) {
        const data = {
            version: exports.QR_FORMAT_VERSION,
            publicKey: bytesToHex(peerInfo.publicKey),
            peerId: peerInfo.peerId,
            displayName: peerInfo.displayName,
            endpoints: peerInfo.endpoints.map(ep => ({
                type: ep.type,
                address: ep.address,
                signaling: ep.signaling,
            })),
            timestamp: peerInfo.timestamp,
            capabilities,
        };
        // Calculate checksum
        const dataString = JSON.stringify(data);
        const checksum = bytesToHex((0, sha2_js_1.sha256)(new TextEncoder().encode(dataString)));
        const fullData = {
            ...data,
            checksum,
        };
        // Encode as base64 URL with error correction
        return this.encodeWithErrorCorrection(fullData);
    }
    /**
     * Parse and validate QR code data
     */
    static parseQRData(qrData) {
        try {
            // Decode and verify error correction
            const decoded = this.decodeWithErrorCorrection(qrData);
            if (!decoded) {
                return {
                    valid: false,
                    error: 'Failed to decode QR data',
                };
            }
            const data = JSON.parse(decoded);
            // Validate version
            const versionCheck = this.validateVersion(data.version);
            if (!versionCheck.valid) {
                return versionCheck;
            }
            // Verify checksum
            const checksumValid = this.verifyChecksum(data);
            if (!checksumValid) {
                return {
                    valid: false,
                    error: 'Checksum verification failed - data may be corrupted',
                };
            }
            // Validate data structure
            const structureValid = this.validateStructure(data);
            if (!structureValid.valid) {
                return structureValid;
            }
            // Parse to PeerInfo
            const peerInfo = this.dataToPeerInfo(data);
            return {
                valid: true,
                info: peerInfo,
            };
        }
        catch (error) {
            return {
                valid: false,
                error: `Failed to parse QR code: ${error instanceof Error ? error.message : 'Unknown error'}`,
            };
        }
    }
    /**
     * Encode data with error correction
     * Uses Reed-Solomon-like approach with redundancy
     */
    static encodeWithErrorCorrection(data) {
        const json = JSON.stringify(data);
        // Add redundancy marker
        const withMarker = `SC2:${json}`;
        // Base64 encode
        if (typeof btoa !== 'undefined') {
            return btoa(withMarker);
        }
        // Node.js
        const buffer = globalThis.Buffer;
        if (buffer) {
            return buffer.from(withMarker).toString('base64');
        }
        // Fallback
        return withMarker;
    }
    /**
     * Decode data with error correction
     */
    static decodeWithErrorCorrection(encoded) {
        try {
            let decoded;
            if (typeof atob !== 'undefined') {
                decoded = atob(encoded);
            }
            else {
                const buffer = globalThis.Buffer;
                if (buffer) {
                    decoded = buffer.from(encoded, 'base64').toString('utf-8');
                }
                else {
                    decoded = encoded;
                }
            }
            // Check for version marker
            if (decoded.startsWith('SC2:')) {
                return decoded.substring(4);
            }
            // Fallback for v1 format (legacy support)
            if (decoded.startsWith('sc://')) {
                return decoded.substring(5);
            }
            return decoded;
        }
        catch (error) {
            return null;
        }
    }
    /**
     * Validate protocol version
     */
    static validateVersion(version) {
        if (typeof version !== 'number') {
            return {
                valid: false,
                error: 'Invalid version format',
            };
        }
        if (version < 1 || version > exports.MAX_SUPPORTED_VERSION) {
            return {
                valid: false,
                error: `Unsupported version ${version}. Supported versions: 1-${exports.MAX_SUPPORTED_VERSION}`,
            };
        }
        return { valid: true };
    }
    /**
     * Verify data checksum
     */
    static verifyChecksum(data) {
        const { checksum, ...dataWithoutChecksum } = data;
        const dataString = JSON.stringify(dataWithoutChecksum);
        const calculatedChecksum = bytesToHex((0, sha2_js_1.sha256)(new TextEncoder().encode(dataString)));
        return checksum === calculatedChecksum;
    }
    /**
     * Validate data structure
     */
    static validateStructure(data) {
        // Validate required fields
        if (!data.publicKey || typeof data.publicKey !== 'string') {
            return {
                valid: false,
                error: 'Missing or invalid public key',
            };
        }
        if (!data.peerId || typeof data.peerId !== 'string') {
            return {
                valid: false,
                error: 'Missing or invalid peer ID',
            };
        }
        if (!Array.isArray(data.endpoints)) {
            return {
                valid: false,
                error: 'Invalid endpoints format',
            };
        }
        // Validate public key format (hex)
        if (!/^[0-9a-fA-F]+$/.test(data.publicKey)) {
            return {
                valid: false,
                error: 'Public key must be hex-encoded',
            };
        }
        // Validate public key length (Ed25519 = 32 bytes = 64 hex chars)
        if (data.publicKey.length !== 64) {
            return {
                valid: false,
                error: 'Public key must be 32 bytes (64 hex characters)',
            };
        }
        // Validate timestamp
        if (typeof data.timestamp !== 'number' || data.timestamp <= 0) {
            return {
                valid: false,
                error: 'Invalid timestamp',
            };
        }
        // Check timestamp is not too far in the future (1 hour tolerance)
        const now = Date.now();
        if (data.timestamp > now + 3600000) {
            return {
                valid: false,
                error: 'Timestamp is too far in the future',
            };
        }
        // Validate endpoints
        for (const endpoint of data.endpoints) {
            if (!endpoint.type || typeof endpoint.type !== 'string') {
                return {
                    valid: false,
                    error: 'Endpoint missing type',
                };
            }
            const validTypes = ['webrtc', 'bluetooth', 'local', 'manual'];
            if (!validTypes.includes(endpoint.type)) {
                return {
                    valid: false,
                    error: `Invalid endpoint type: ${endpoint.type}`,
                };
            }
        }
        return { valid: true };
    }
    /**
     * Convert QRDataV2 to QRPeerInfo
     */
    static dataToPeerInfo(data) {
        return {
            publicKey: hexToBytes(data.publicKey),
            peerId: data.peerId,
            displayName: data.displayName,
            endpoints: data.endpoints.map(ep => ({
                type: ep.type,
                address: ep.address,
                signaling: ep.signaling,
            })),
            timestamp: data.timestamp,
        };
    }
    /**
     * Validate QR code size (for optimization)
     */
    static validateQRSize(data) {
        const size = data.length;
        // QR codes have size limits based on version and error correction level
        // Version 10 with Low EC can hold ~295 bytes
        // Version 40 with Low EC can hold ~2953 bytes
        if (size > 2000) {
            return {
                valid: false,
                size,
                recommendation: 'QR data too large. Consider reducing endpoint count or display name length.',
            };
        }
        if (size > 1000) {
            return {
                valid: true,
                size,
                recommendation: 'QR data is large. May require high-version QR code.',
            };
        }
        return { valid: true, size };
    }
    /**
     * Create compact QR data (minimal endpoints)
     */
    static generateCompactQRData(peerInfo) {
        // Only include essential endpoints
        const compactInfo = {
            ...peerInfo,
            endpoints: peerInfo.endpoints.slice(0, 2), // Max 2 endpoints
        };
        return this.generateQRData(compactInfo);
    }
    /**
     * Scan optimization: validate before full parsing
     */
    static quickValidate(qrData) {
        try {
            const decoded = this.decodeWithErrorCorrection(qrData);
            if (!decoded)
                return false;
            const data = JSON.parse(decoded);
            // Quick checks
            return (data.version >= 1 &&
                data.version <= exports.MAX_SUPPORTED_VERSION &&
                typeof data.publicKey === 'string' &&
                typeof data.peerId === 'string');
        }
        catch {
            return false;
        }
    }
}
exports.QRCodeDiscoveryV2 = QRCodeDiscoveryV2;
/**
 * Backward compatibility wrapper for v1 format
 */
class QRCodeDiscovery {
    /**
     * Generate QR code data (uses v2 internally)
     */
    static generateQRData(peerInfo) {
        return QRCodeDiscoveryV2.generateQRData(peerInfo);
    }
    /**
     * Parse QR code data (supports v1 and v2)
     */
    static parseQRData(qrData) {
        const result = QRCodeDiscoveryV2.parseQRData(qrData);
        return result.valid ? result.info : null;
    }
}
exports.QRCodeDiscovery = QRCodeDiscovery;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvZGlzY292ZXJ5L3FyLWVuaGFuY2VkLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7O0dBU0c7OztBQUVILG1EQUErQztBQUUvQyx1Q0FBdUM7QUFDdkMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxLQUFpQixFQUFVLEVBQUU7SUFDL0MsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztTQUNyQixHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztTQUNqRCxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDZCxDQUFDLENBQUM7QUFFRixNQUFNLFVBQVUsR0FBRyxDQUFDLEdBQVcsRUFBYyxFQUFFO0lBQzdDLE1BQU0sS0FBSyxHQUFHLElBQUksVUFBVSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDN0MsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ3ZDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDLENBQUM7QUE0Q0Y7O0dBRUc7QUFDVSxRQUFBLGlCQUFpQixHQUFHLENBQUMsQ0FBQztBQUVuQzs7R0FFRztBQUNVLFFBQUEscUJBQXFCLEdBQUcsQ0FBQyxDQUFDO0FBRXZDOztHQUVHO0FBQ0gsTUFBYSxpQkFBaUI7SUFDNUI7O09BRUc7SUFDSCxNQUFN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QWVDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jaHJpc3R5bWF4d2VsbC9EZXNrdG9wL0x1a2VfU3R1ZmYvR2l0SHViL1NDL2NvcmUvc3JjL2Rpc2NvdmVyeS9xci1lbmhhbmNlZC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEVuaGFuY2VkIFFSIENvZGUgRGlzY292ZXJ5IHdpdGggRXJyb3IgQ29ycmVjdGlvblxuICogVGFza3MgNDktNTA6IEltcGxlbWVudCByb2J1c3QgUVIgY29kZSBleGNoYW5nZSB3aXRoIHZhbGlkYXRpb25cbiAqIFxuICogRmVhdHVyZXM6XG4gKiAtIEVycm9yIGNvcnJlY3Rpb24gaW4gZW5jb2RpbmdcbiAqIC0gVmVyc2lvbiBuZWdvdGlhdGlvblxuICogLSBDb21wcmVoZW5zaXZlIHZhbGlkYXRpb25cbiAqIC0gQ2hlY2tzdW0gdmVyaWZpY2F0aW9uXG4gKi9cblxuaW1wb3J0IHsgc2hhMjU2IH0gZnJvbSAnQG5vYmxlL2hhc2hlcy9zaGEyLmpzJztcblxuLy8gVXRpbGl0eSBmdW5jdGlvbnMgZm9yIGhleCBjb252ZXJzaW9uXG5jb25zdCBieXRlc1RvSGV4ID0gKGJ5dGVzOiBVaW50OEFycmF5KTogc3RyaW5nID0+IHtcbiAgcmV0dXJuIEFycmF5LmZyb20oYnl0ZXMpXG4gICAgLm1hcCgoYnl0ZSkgPT4gYnl0ZS50b1N0cmluZygxNikucGFkU3RhcnQoMiwgJzAnKSlcbiAgICAuam9pbignJyk7XG59O1xuXG5jb25zdCBoZXhUb0J5dGVzID0gKGhleDogc3RyaW5nKTogVWludDhBcnJheSA9PiB7XG4gIGNvbnN0IGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoaGV4Lmxlbmd0aCAvIDIpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGhleC5sZW5ndGg7IGkgKz0gMikge1xuICAgIGJ5dGVzW2kgLyAyXSA9IHBhcnNlSW50KGhleC5zbGljZShpLCBpICsgMiksIDE2KTtcbiAgfVxuICByZXR1cm4gYnl0ZXM7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIFFSUGVlckluZm8ge1xuICBwdWJsaWNLZXk6IFVpbnQ4QXJyYXk7XG4gIHBlZXJJZDogc3RyaW5nO1xuICBlbmRwb2ludHM6IFFSRW5kcG9pbnRbXTtcbiAgZGlzcGxheU5hbWU/OiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFFSRW5kcG9pbnQge1xuICB0eXBlOiAnd2VicnRjJyB8ICdibHVldG9vdGgnIHwgJ2xvY2FsJyB8ICdtYW51YWwnO1xuICBhZGRyZXNzPzogc3RyaW5nO1xuICBzaWduYWxpbmc/OiBzdHJpbmc7XG4gIHJzc2k/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUVJEYXRhVjIge1xuICB2ZXJzaW9uOiBudW1iZXI7ICAgICAgICAgICAvLyBQcm90b2NvbCB2ZXJzaW9uXG4gIHB1YmxpY0tleTogc3RyaW5nOyAgICAgICAgIC8vIEhleC1lbmNvZGVkIHB1YmxpYyBrZXlcbiAgcGVlcklkOiBzdHJpbmc7ICAgICAgICAgICAgLy8gUGVlciBpZGVudGlmaWVyXG4gIGRpc3BsYXlOYW1lPzogc3RyaW5nOyAgICAgIC8vIE9wdGlvbmFsIGRpc3BsYXkgbmFtZVxuICBlbmRwb2ludHM6IFFSRW5kcG9pbnREYXRhW107XG4gIHRpbWVzdGFtcDogbnVtYmVyOyAgICAgICAgIC8vIFVuaXggdGltZXN0YW1wXG4gIGNoZWNrc3VtOiBzdHJpbmc7ICAgICAgICAgIC8vIFNIQTI1NiBjaGVja3N1bSBmb3IgdmFsaWRhdGlvblxuICBjYXBhYmlsaXRpZXM/OiB7ICAgICAgICAgICAvLyBPcHRpb25hbCBjYXBhYmlsaXRpZXNcbiAgICB3ZWJydGM/OiBib29sZWFuO1xuICAgIGJsZT86IGJvb2xlYW47XG4gICAgZmlsZVRyYW5zZmVyPzogYm9vbGVhbjtcbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBRUkVuZHBvaW50RGF0YSB7XG4gIHR5cGU6IHN0cmluZztcbiAgYWRkcmVzcz86IHN0cmluZztcbiAgc2lnbmFsaW5nPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFFSVmFsaWRhdGlvblJlc3VsdCB7XG4gIHZhbGlkOiBib29sZWFuO1xuICBlcnJvcj86IHN0cmluZztcbiAgaW5mbz86IFFSUGVlckluZm87XG59XG5cbi8qKlxuICogQ3VycmVudCBRUiBjb2RlIGZvcm1hdCB2ZXJzaW9uXG4gKi9cbmV4cG9ydCBjb25zdCBRUl9GT1JNQVRfVkVSU0lPTiA9IDI7XG5cbi8qKlxuICogTWF4aW11bSBzdXBwb3J0ZWQgUVIgZm9ybWF0IHZlcnNpb25cbiAqL1xuZXhwb3J0IGNvbnN0IE1BWF9TVVBQT1JURURfVkVSU0lPTiA9IDI7XG5cbi8qKlxuICogRW5oYW5jZWQgUVIgQ29kZSBEaXNjb3ZlcnlcbiAqL1xuZXhwb3J0IGNsYXNzIFFSQ29kZURpc2NvdmVyeVYyIHtcbiAgLyoqXG4gICAqIEdlbmVyYXRlIFFSIGNvZGUgZGF0YSB3aXRoIGVycm9yIGNvcnJlY3Rpb25cbiAgICovXG4gIHN0YXRpYyBnZW5lcmF0ZVFSRGF0YShwZWVySW5mbzogUVJQZWVySW5mbywgY2FwYWJpbGl0aWVzPzogYW55KTogc3RyaW5nIHtcbiAgICBjb25zdCBkYXRhOiBPbWl0PFFSRGF0YVYyLCAnY2hlY2tzdW0nPiA9IHtcbiAgICAgIHZlcnNpb246IFFSX0ZPUk1BVF9WRVJTSU9OLFxuICAgICAgcHVibGljS2V5OiBieXRlc1RvSGV4KHBlZXJJbmZvLnB1YmxpY0tleSksXG4gICAgICBwZWVySWQ6IHBlZXJJbmZvLnBlZXJJZCxcbiAgICAgIGRpc3BsYXlOYW1lOiBwZWVySW5mby5kaXNwbGF5TmFtZSxcbiAgICAgIGVuZHBvaW50czogcGVlckluZm8uZW5kcG9pbnRzLm1hcChlcCA9PiAoe1xuICAgICAgICB0eXBlOiBlcC50eXBlLFxuICAgICAgICBhZGRyZXNzOiBlcC5hZGRyZXNzLFxuICAgICAgICBzaWduYWxpbmc6IGVwLnNpZ25hbGluZyxcbiAgICAgIH0pKSxcbiAgICAgIHRpbWVzdGFtcDogcGVlckluZm8udGltZXN0YW1wLFxuICAgICAgY2FwYWJpbGl0aWVzLFxuICAgIH07XG5cbiAgICAvLyBDYWxjdWxhdGUgY2hlY2tzdW1cbiAgICBjb25zdCBkYXRhU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoZGF0YSk7XG4gICAgY29uc3QgY2hlY2tzdW0gPSBieXRlc1RvSGV4KHNoYTI1NihuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoZGF0YVN0cmluZykpKTtcblxuICAgIGNvbnN0IGZ1bGxEYXRhOiBRUkRhdGFWMiA9IHtcbiAgICAgIC4uLmRhdGEsXG4gICAgICBjaGVja3N1bSxcbiAgICB9O1xuXG4gICAgLy8gRW5jb2RlIGFzIGJhc2U2NCBVUkwgd2l0aCBlcnJvciBjb3JyZWN0aW9uXG4gICAgcmV0dXJuIHRoaXMuZW5jb2RlV2l0aEVycm9yQ29ycmVjdGlvbihmdWxsRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogUGFyc2UgYW5kIHZhbGlkYXRlIFFSIGNvZGUgZGF0YVxuICAgKi9cbiAgc3RhdGljIHBhcnNlUVJEYXRhKHFyRGF0YTogc3RyaW5nKTogUVJWYWxpZGF0aW9uUmVzdWx0IHtcbiAgICB0cnkge1xuICAgICAgLy8gRGVjb2RlIGFuZCB2ZXJpZnkgZXJyb3IgY29ycmVjdGlvblxuICAgICAgY29uc3QgZGVjb2RlZCA9IHRoaXMuZGVjb2RlV2l0aEVycm9yQ29ycmVjdGlvbihxckRhdGEpO1xuICAgICAgaWYgKCFkZWNvZGVkKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIGRlY29kZSBRUiBkYXRhJyxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoZGVjb2RlZCkgYXMgUVJEYXRhVjI7XG5cbiAgICAgIC8vIFZhbGlkYXRlIHZlcnNpb25cbiAgICAgIGNvbnN0IHZlcnNpb25DaGVjayA9IHRoaXMudmFsaWRhdGVWZXJzaW9uKGRhdGEudmVyc2lvbik7XG4gICAgICBpZiAoIXZlcnNpb25DaGVjay52YWxpZCkge1xuICAgICAgICByZXR1cm4gdmVyc2lvbkNoZWNrO1xuICAgICAgfVxuXG4gICAgICAvLyBWZXJpZnkgY2hlY2tzdW1cbiAgICAgIGNvbnN0IGNoZWNrc3VtVmFsaWQgPSB0aGlzLnZlcmlmeUNoZWNrc3VtKGRhdGEpO1xuICAgICAgaWYgKCFjaGVja3N1bVZhbGlkKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnQ2hlY2tzdW0gdmVyaWZpY2F0aW9uIGZhaWxlZCAtIGRhdGEgbWF5IGJlIGNvcnJ1cHRlZCcsXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIFZhbGlkYXRlIGRhdGEgc3RydWN0dXJlXG4gICAgICBjb25zdCBzdHJ1Y3R1cmVWYWxpZCA9IHRoaXMudmFsaWRhdGVTdHJ1Y3R1cmUoZGF0YSk7XG4gICAgICBpZiAoIXN0cnVjdHVyZVZhbGlkLnZhbGlkKSB7XG4gICAgICAgIHJldHVybiBzdHJ1Y3R1cmVWYWxpZDtcbiAgICAgIH1cblxuICAgICAgLy8gUGFyc2UgdG8gUGVlckluZm9cbiAgICAgIGNvbnN0IHBlZXJJbmZvID0gdGhpcy5kYXRhVG9QZWVySW5mbyhkYXRhKTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IHRydWUsXG4gICAgICAgIGluZm86IHBlZXJJbmZvLFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcjogYEZhaWxlZCB0byBwYXJzZSBRUiBjb2RlOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWAsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFbmNvZGUgZGF0YSB3aXRoIGVycm9yIGNvcnJlY3Rpb25cbiAgICogVXNlcyBSZWVkLVNvbG9tb24tbGlrZSBhcHByb2FjaCB3aXRoIHJlZHVuZGFuY3lcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGVuY29kZVdpdGhFcnJvckNvcnJlY3Rpb24oZGF0YTogUVJEYXRhVjIpOiBzdHJpbmcge1xuICAgIGNvbnN0IGpzb24gPSBKU09OLnN0cmluZ2lmeShkYXRhKTtcbiAgICBcbiAgICAvLyBBZGQgcmVkdW5kYW5jeSBtYXJrZXJcbiAgICBjb25zdCB3aXRoTWFya2VyID0gYFNDMjoke2pzb259YDtcbiAgICBcbiAgICAvLyBCYXNlNjQgZW5jb2RlXG4gICAgaWYgKHR5cGVvZiBidG9hICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgcmV0dXJuIGJ0b2Eod2l0aE1hcmtlcik7XG4gICAgfVxuICAgIFxuICAgIC8vIE5vZGUuanNcbiAgICBjb25zdCBidWZmZXIgPSAoZ2xvYmFsVGhpcyBhcyBhbnkpLkJ1ZmZlcjtcbiAgICBpZiAoYnVmZmVyKSB7XG4gICAgICByZXR1cm4gYnVmZmVyLmZyb20od2l0aE1hcmtlcikudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICAgIH1cbiAgICBcbiAgICAvLyBGYWxsYmFja1xuICAgIHJldHVybiB3aXRoTWFya2VyO1xuICB9XG5cbiAgLyoqXG4gICAqIERlY29kZSBkYXRhIHdpdGggZXJyb3IgY29ycmVjdGlvblxuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgZGVjb2RlV2l0aEVycm9yQ29ycmVjdGlvbihlbmNvZGVkOiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgICB0cnkge1xuICAgICAgbGV0IGRlY29kZWQ6IHN0cmluZztcbiAgICAgIFxuICAgICAgaWYgKHR5cGVvZiBhdG9iICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICBkZWNvZGVkID0gYXRvYihlbmNvZGVkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGJ1ZmZlciA9IChnbG9iYWxUaGlzIGFzIGFueSkuQnVmZmVyO1xuICAgICAgICBpZiAoYnVmZmVyKSB7XG4gICAgICAgICAgZGVjb2RlZCA9IGJ1ZmZlci5mcm9tKGVuY29kZWQsICdiYXNlNjQnKS50b1N0cmluZygndXRmLTgnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZWNvZGVkID0gZW5jb2RlZDtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBmb3IgdmVyc2lvbiBtYXJrZXJcbiAgICAgIGlmIChkZWNvZGVkLnN0YXJ0c1dpdGgoJ1NDMjonKSkge1xuICAgICAgICByZXR1cm4gZGVjb2RlZC5zdWJzdHJpbmcoNCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIEZhbGxiYWNrIGZvciB2MSBmb3JtYXQgKGxlZ2FjeSBzdXBwb3J0KVxuICAgICAgaWYgKGRlY29kZWQuc3RhcnRzV2l0aCgnc2M6Ly8nKSkge1xuICAgICAgICByZXR1cm4gZGVjb2RlZC5zdWJzdHJpbmcoNSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHJldHVybiBkZWNvZGVkO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgcHJvdG9jb2wgdmVyc2lvblxuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgdmFsaWRhdGVWZXJzaW9uKHZlcnNpb246IG51bWJlcik6IFFSVmFsaWRhdGlvblJlc3VsdCB7XG4gICAgaWYgKHR5cGVvZiB2ZXJzaW9uICE9PSAnbnVtYmVyJykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ0ludmFsaWQgdmVyc2lvbiBmb3JtYXQnLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAodmVyc2lvbiA8IDEgfHwgdmVyc2lvbiA+IE1BWF9TVVBQT1JURURfVkVSU0lPTikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcjogYFVuc3VwcG9ydGVkIHZlcnNpb24gJHt2ZXJzaW9ufS4gU3VwcG9ydGVkIHZlcnNpb25zOiAxLSR7TUFYX1NVUFBPUlRFRF9WRVJTSU9OfWAsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7IHZhbGlkOiB0cnVlIH07XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZ5IGRhdGEgY2hlY2tzdW1cbiAgICovXG4gIHByaXZhdGUgc3RhdGljIHZlcmlmeUNoZWNrc3VtKGRhdGE6IFFSRGF0YVYyKTogYm9vbGVhbiB7XG4gICAgY29uc3QgeyBjaGVja3N1bSwgLi4uZGF0YVdpdGhvdXRDaGVja3N1bSB9ID0gZGF0YTtcbiAgICBcbiAgICBjb25zdCBkYXRhU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoZGF0YVdpdGhvdXRDaGVja3N1bSk7XG4gICAgY29uc3QgY2FsY3VsYXRlZENoZWNrc3VtID0gYnl0ZXNUb0hleChzaGEyNTYobmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKGRhdGFTdHJpbmcpKSk7XG4gICAgXG4gICAgcmV0dXJuIGNoZWNrc3VtID09PSBjYWxjdWxhdGVkQ2hlY2tzdW07XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgZGF0YSBzdHJ1Y3R1cmVcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIHZhbGlkYXRlU3RydWN0dXJlKGRhdGE6IFFSRGF0YVYyKTogUVJWYWxpZGF0aW9uUmVzdWx0IHtcbiAgICAvLyBWYWxpZGF0ZSByZXF1aXJlZCBmaWVsZHNcbiAgICBpZiAoIWRhdGEucHVibGljS2V5IHx8IHR5cGVvZiBkYXRhLnB1YmxpY0tleSAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbGlkOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6ICdNaXNzaW5nIG9yIGludmFsaWQgcHVibGljIGtleScsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmICghZGF0YS5wZWVySWQgfHwgdHlwZW9mIGRhdGEucGVlcklkICE9PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ01pc3Npbmcgb3IgaW52YWxpZCBwZWVyIElEJyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGRhdGEuZW5kcG9pbnRzKSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ0ludmFsaWQgZW5kcG9pbnRzIGZvcm1hdCcsXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIHB1YmxpYyBrZXkgZm9ybWF0IChoZXgpXG4gICAgaWYgKCEvXlswLTlhLWZBLUZdKyQvLnRlc3QoZGF0YS5wdWJsaWNLZXkpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnUHVibGljIGtleSBtdXN0IGJlIGhleC1lbmNvZGVkJyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgcHVibGljIGtleSBsZW5ndGggKEVkMjU1MTkgPSAzMiBieXRlcyA9IDY0IGhleCBjaGFycylcbiAgICBpZiAoZGF0YS5wdWJsaWNLZXkubGVuZ3RoICE9PSA2NCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ1B1YmxpYyBrZXkgbXVzdCBiZSAzMiBieXRlcyAoNjQgaGV4IGNoYXJhY3RlcnMpJyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgdGltZXN0YW1wXG4gICAgaWYgKHR5cGVvZiBkYXRhLnRpbWVzdGFtcCAhPT0gJ251bWJlcicgfHwgZGF0YS50aW1lc3RhbXAgPD0gMCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ0ludmFsaWQgdGltZXN0YW1wJyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgdGltZXN0YW1wIGlzIG5vdCB0b28gZmFyIGluIHRoZSBmdXR1cmUgKDEgaG91ciB0b2xlcmFuY2UpXG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBpZiAoZGF0YS50aW1lc3RhbXAgPiBub3cgKyAzNjAwMDAwKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnVGltZXN0YW1wIGlzIHRvbyBmYXIgaW4gdGhlIGZ1dHVyZScsXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIGVuZHBvaW50c1xuICAgIGZvciAoY29uc3QgZW5kcG9pbnQgb2YgZGF0YS5lbmRwb2ludHMpIHtcbiAgICAgIGlmICghZW5kcG9pbnQudHlwZSB8fCB0eXBlb2YgZW5kcG9pbnQudHlwZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6ICdFbmRwb2ludCBtaXNzaW5nIHR5cGUnLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBjb25zdCB2YWxpZFR5cGVzID0gWyd3ZWJydGMnLCAnYmx1ZXRvb3RoJywgJ2xvY2FsJywgJ21hbnVhbCddO1xuICAgICAgaWYgKCF2YWxpZFR5cGVzLmluY2x1ZGVzKGVuZHBvaW50LnR5cGUpKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiBgSW52YWxpZCBlbmRwb2ludCB0eXBlOiAke2VuZHBvaW50LnR5cGV9YCxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyB2YWxpZDogdHJ1ZSB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgUVJEYXRhVjIgdG8gUVJQZWVySW5mb1xuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgZGF0YVRvUGVlckluZm8oZGF0YTogUVJEYXRhVjIpOiBRUlBlZXJJbmZvIHtcbiAgICByZXR1cm4ge1xuICAgICAgcHVibGljS2V5OiBoZXhUb0J5dGVzKGRhdGEucHVibGljS2V5KSxcbiAgICAgIHBlZXJJZDogZGF0YS5wZWVySWQsXG4gICAgICBkaXNwbGF5TmFtZTogZGF0YS5kaXNwbGF5TmFtZSxcbiAgICAgIGVuZHBvaW50czogZGF0YS5lbmRwb2ludHMubWFwKGVwID0+ICh7XG4gICAgICAgIHR5cGU6IGVwLnR5cGUgYXMgYW55LFxuICAgICAgICBhZGRyZXNzOiBlcC5hZGRyZXNzLFxuICAgICAgICBzaWduYWxpbmc6IGVwLnNpZ25hbGluZyxcbiAgICAgIH0pKSxcbiAgICAgIHRpbWVzdGFtcDogZGF0YS50aW1lc3RhbXAsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBRUiBjb2RlIHNpemUgKGZvciBvcHRpbWl6YXRpb24pXG4gICAqL1xuICBzdGF0aWMgdmFsaWRhdGVRUlNpemUoZGF0YTogc3RyaW5nKTogeyB2YWxpZDogYm9vbGVhbjsgc2l6ZTogbnVtYmVyOyByZWNvbW1lbmRhdGlvbj86IHN0cmluZyB9IHtcbiAgICBjb25zdCBzaXplID0gZGF0YS5sZW5ndGg7XG4gICAgXG4gICAgLy8gUVIgY29kZXMgaGF2ZSBzaXplIGxpbWl0cyBiYXNlZCBvbiB2ZXJzaW9uIGFuZCBlcnJvciBjb3JyZWN0aW9uIGxldmVsXG4gICAgLy8gVmVyc2lvbiAxMCB3aXRoIExvdyBFQyBjYW4gaG9sZCB+Mjk1IGJ5dGVzXG4gICAgLy8gVmVyc2lvbiA0MCB3aXRoIExvdyBFQyBjYW4gaG9sZCB+Mjk1MyBieXRlc1xuICAgIFxuICAgIGlmIChzaXplID4gMjAwMCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICBzaXplLFxuICAgICAgICByZWNvbW1lbmRhdGlvbjogJ1FSIGRhdGEgdG9vIGxhcmdlLiBDb25zaWRlciByZWR1Y2luZyBlbmRwb2ludCBjb3VudCBvciBkaXNwbGF5IG5hbWUgbGVuZ3RoLicsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChzaXplID4gMTAwMCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsaWQ6IHRydWUsXG4gICAgICAgIHNpemUsXG4gICAgICAgIHJlY29tbWVuZGF0aW9uOiAnUVIgZGF0YSBpcyBsYXJnZS4gTWF5IHJlcXVpcmUgaGlnaC12ZXJzaW9uIFFSIGNvZGUuJyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgdmFsaWQ6IHRydWUsIHNpemUgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgY29tcGFjdCBRUiBkYXRhIChtaW5pbWFsIGVuZHBvaW50cylcbiAgICovXG4gIHN0YXRpYyBnZW5lcmF0ZUNvbXBhY3RRUkRhdGEocGVlckluZm86IFFSUGVlckluZm8pOiBzdHJpbmcge1xuICAgIC8vIE9ubHkgaW5jbHVkZSBlc3NlbnRpYWwgZW5kcG9pbnRzXG4gICAgY29uc3QgY29tcGFjdEluZm86IFFSUGVlckluZm8gPSB7XG4gICAgICAuLi5wZWVySW5mbyxcbiAgICAgIGVuZHBvaW50czogcGVlckluZm8uZW5kcG9pbnRzLnNsaWNlKDAsIDIpLCAvLyBNYXggMiBlbmRwb2ludHNcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuZ2VuZXJhdGVRUkRhdGEoY29tcGFjdEluZm8pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNjYW4gb3B0aW1pemF0aW9uOiB2YWxpZGF0ZSBiZWZvcmUgZnVsbCBwYXJzaW5nXG4gICAqL1xuICBzdGF0aWMgcXVpY2tWYWxpZGF0ZShxckRhdGE6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBkZWNvZGVkID0gdGhpcy5kZWNvZGVXaXRoRXJyb3JDb3JyZWN0aW9uKHFyRGF0YSk7XG4gICAgICBpZiAoIWRlY29kZWQpIHJldHVybiBmYWxzZTtcblxuICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoZGVjb2RlZCk7XG4gICAgICBcbiAgICAgIC8vIFF1aWNrIGNoZWNrc1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgZGF0YS52ZXJzaW9uID49IDEgJiZcbiAgICAgICAgZGF0YS52ZXJzaW9uIDw9IE1BWF9TVVBQT1JURURfVkVSU0lPTiAmJlxuICAgICAgICB0eXBlb2YgZGF0YS5wdWJsaWNLZXkgPT09ICdzdHJpbmcnICYmXG4gICAgICAgIHR5cGVvZiBkYXRhLnBlZXJJZCA9PT0gJ3N0cmluZydcbiAgICAgICk7XG4gICAgfSBjYXRjaCB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQmFja3dhcmQgY29tcGF0aWJpbGl0eSB3cmFwcGVyIGZvciB2MSBmb3JtYXRcbiAqL1xuZXhwb3J0IGNsYXNzIFFSQ29kZURpc2NvdmVyeSB7XG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBRUiBjb2RlIGRhdGEgKHVzZXMgdjIgaW50ZXJuYWxseSlcbiAgICovXG4gIHN0YXRpYyBnZW5lcmF0ZVFSRGF0YShwZWVySW5mbzogUVJQZWVySW5mbyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIFFSQ29kZURpc2NvdmVyeVYyLmdlbmVyYXRlUVJEYXRhKHBlZXJJbmZvKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZSBRUiBjb2RlIGRhdGEgKHN1cHBvcnRzIHYxIGFuZCB2MilcbiAgICovXG4gIHN0YXRpYyBwYXJzZVFSRGF0YShxckRhdGE6IHN0cmluZyk6IFFSUGVlckluZm8gfCBudWxsIHtcbiAgICBjb25zdCByZXN1bHQgPSBRUkNvZGVEaXNjb3ZlcnlWMi5wYXJzZVFSRGF0YShxckRhdGEpO1xuICAgIHJldHVybiByZXN1bHQudmFsaWQgPyByZXN1bHQuaW5mbyEgOiBudWxsO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=