{"file":"/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/relay-advanced.test.ts","mappings":"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","names":[],"sources":["/Users/christymaxwell/Desktop/Luke_Stuff/GitHub/SC/core/src/mesh/relay-advanced.test.ts"],"sourcesContent":["import { MessageRelay, fragmentMessage, MessageReassembler, calculateFragmentSize, calculateFragmentationOverhead } from './relay';\nimport type { Peer } from './routing';\nimport { RoutingTable, createPeer } from './routing';\nimport type { Message } from '../protocol/message';\nimport { MessageType, encodeMessage } from '../protocol/message';\n\ndescribe('Advanced Message Relay Features', () => {\n  let relay: MessageRelay;\n  let routingTable: RoutingTable;\n  const localPeerId = 'local-peer';\n\n  beforeEach(() => {\n    routingTable = new RoutingTable(localPeerId);\n    relay = new MessageRelay(localPeerId, routingTable, {\n      maxStoredMessages: 10,\n      storeTimeout: 5000,\n      maxRetries: 3,\n      retryBackoff: 1000,\n      floodRateLimit: 10,\n      selectiveFlooding: true,\n    });\n  });\n\n  describe('Loop Detection', () => {\n    it('should detect routing loops', async () => {\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 5,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode('test'),\n      };\n\n      const messageData = encodeMessage(message);\n\n      // Process message from peer1\n      await relay.processMessage(messageData, 'peer1');\n\n      // Process same message from peer1 again would be caught by deduplication\n      // The loop detection tracks the path through different peers\n      const stats = relay.getStats();\n\n      // First message should be received\n      expect(stats.messagesReceived).toBe(1);\n    });\n  });\n\n  describe('Flood Rate Limiting', () => {\n    it('should limit flood rate per peer', async () => {\n      const peer = createPeer('peer1', new Uint8Array(32), 'webrtc');\n      routingTable.addPeer(peer);\n\n      let forwardCount = 0;\n      relay.onForwardMessage(() => {\n        forwardCount++;\n      });\n\n      // Try to flood with many messages quickly\n      for (let i = 0; i < 20; i++) {\n        const message: Message = {\n          header: {\n            version: 0x01,\n            type: MessageType.TEXT,\n            ttl: 5,\n            timestamp: Date.now(),\n            senderId: new Uint8Array(32),\n            signature: new Uint8Array(64),\n          },\n          payload: new TextEncoder().encode(`message${i}`),\n        };\n\n        const messageData = encodeMessage(message);\n        await relay.processMessage(messageData, 'peer1');\n      }\n\n      // Should have rate limited some messages\n      expect(forwardCount).toBeLessThan(20);\n    });\n  });\n\n  describe('Store-and-Forward', () => {\n    it('should store messages for offline peers', async () => {\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 5,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode('test'),\n      };\n\n      await relay.storeMessage(message, 'offline-peer');\n\n      const stats = relay.getStats();\n      expect(stats.messagesStored).toBe(1);\n\n      const storedStats = await relay.getStoredMessagesStats();\n      expect(storedStats.total).toBe(1);\n      expect(storedStats.byDestination['offline-peer']).toBe(1);\n    });\n\n    it('should retry stored messages when peer comes online', async () => {\n      const message: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.TEXT,\n          ttl: 5,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new TextEncoder().encode('test'),\n      };\n\n      await relay.storeMessage(message, 'peer1');\n\n      // Peer comes online\n      const peer = createPeer('peer1', new Uint8Array(32), 'webrtc');\n      routingTable.addPeer(peer);\n\n      const storedStatsBefore = await relay.getStoredMessagesStats();\n      expect(storedStatsBefore.total).toBe(1);\n\n      await relay.retryStoredMessages();\n\n      // Message should still be stored until successfully sent\n      const storedStatsAfter = await relay.getStoredMessagesStats();\n      expect(storedStatsAfter).toBeDefined();\n    });\n\n    it('should limit stored messages and remove oldest', async () => {\n      for (let i = 0; i < 15; i++) {\n        const message: Message = {\n          header: {\n            version: 0x01,\n            type: MessageType.TEXT,\n            ttl: 5,\n            timestamp: Date.now(),\n            senderId: new Uint8Array(32),\n            signature: new Uint8Array(64),\n          },\n          payload: new TextEncoder().encode(`message${i}`),\n        };\n\n        await relay.storeMessage(message, `peer${i}`);\n      }\n\n      const storedStats = await relay.getStoredMessagesStats();\n      expect(storedStats.total).toBeLessThanOrEqual(10);\n    });\n  });\n\n  describe('Selective Flooding', () => {\n    it('should always forward control messages', async () => {\n      const controlMessage: Message = {\n        header: {\n          version: 0x01,\n          type: MessageType.CONTROL_PING,\n          ttl: 5,\n          timestamp: Date.now(),\n          senderId: new Uint8Array(32),\n          signature: new Uint8Array(64),\n        },\n        payload: new Uint8Array(0),\n      };\n\n      relay.onMessageForSelf(() => {\n        // Control messages are delivered to self\n      });\n\n      const messageData = encodeMessage(controlMessage);\n      await relay.processMessage(messageData, 'peer1');\n\n      const stats = relay.getStats();\n      expect(stats.messagesReceived).toBe(1);\n    });\n  });\n});\n\ndescribe('Message Fragmentation Advanced Features', () => {\n  describe('Optimal Fragment Size', () => {\n    it('should calculate fragment size based on MTU', () => {\n      const size = calculateFragmentSize(1500, 100);\n      expect(size).toBe(1400);\n    });\n\n    it('should respect minimum fragment size', () => {\n      const size = calculateFragmentSize(200, 100);\n      expect(size).toBeGreaterThanOrEqual(512);\n    });\n\n    it('should respect maximum fragment size', () => {\n      const size = calculateFragmentSize(20000, 100);\n      expect(size).toBeLessThanOrEqual(16384);\n    });\n  });\n\n  describe('Fragmentation Overhead', () => {\n    it('should calculate overhead correctly', () => {\n      const messageSize = 100000;\n      const fragmentSize = 16384;\n\n      const overhead = calculateFragmentationOverhead(messageSize, fragmentSize);\n      const expectedFragments = Math.ceil(messageSize / fragmentSize);\n\n      expect(overhead).toBe(expectedFragments * 50);\n    });\n  });\n\n  describe('Fragment Timestamps', () => {\n    it('should include timestamp in fragments', () => {\n      const message = new Uint8Array(50000);\n      const fragments = fragmentMessage(message, 'msg1', 16384);\n\n      expect(fragments.length).toBeGreaterThan(1);\n      fragments.forEach(fragment => {\n        expect(fragment.timestamp).toBeDefined();\n        expect(fragment.timestamp).toBeGreaterThan(0);\n      });\n    });\n  });\n});\n\ndescribe('Message Reassembly Advanced Features', () => {\n  let reassembler: MessageReassembler;\n\n  beforeEach(() => {\n    reassembler = new MessageReassembler();\n  });\n\n  describe('Duplicate Fragment Detection', () => {\n    it('should detect duplicate fragments', () => {\n      const fragment = {\n        messageId: 'msg1',\n        fragmentIndex: 0,\n        totalFragments: 3,\n        data: new Uint8Array(100),\n        timestamp: Date.now(),\n      };\n\n      const result1 = reassembler.addFragment(fragment);\n      const result2 = reassembler.addFragment(fragment);\n\n      expect(result1).toBe(false); // Not complete\n      expect(result2).toBe(false); // Duplicate\n    });\n  });\n\n  describe('Out-of-Order Fragment Handling', () => {\n    it('should handle fragments arriving out of order', (done) => {\n      const data = new Uint8Array([1, 2, 3, 4, 5, 6]);\n      const fragments = [\n        {\n          messageId: 'msg1',\n          fragmentIndex: 2,\n          totalFragments: 3,\n          data: data.slice(4, 6),\n          timestamp: Date.now(),\n        },\n        {\n          messageId: 'msg1',\n          fragmentIndex: 0,\n          totalFragments: 3,\n          data: data.slice(0, 2),\n          timestamp: Date.now(),\n        },\n        {\n          messageId: 'msg1',\n          fragmentIndex: 1,\n          totalFragments: 3,\n          data: data.slice(2, 4),\n          timestamp: Date.now(),\n        },\n      ];\n\n      reassembler.onComplete((messageId, message) => {\n        expect(messageId).toBe('msg1');\n        expect(message).toEqual(data);\n        done();\n      });\n\n      fragments.forEach(fragment => {\n        reassembler.addFragment(fragment);\n      });\n    });\n  });\n\n  describe('Memory Limits and Cleanup', () => {\n    it('should track buffer usage', () => {\n      const fragment = {\n        messageId: 'msg1',\n        fragmentIndex: 0,\n        totalFragments: 3,\n        data: new Uint8Array(1000),\n        timestamp: Date.now(),\n      };\n\n      reassembler.addFragment(fragment);\n\n      const stats = reassembler.getStats();\n      expect(stats.bufferUsage).toBeGreaterThan(0);\n      expect(stats.bufferLimit).toBeDefined();\n    });\n\n    it('should cleanup expired messages', () => {\n      const fragment = {\n        messageId: 'msg1',\n        fragmentIndex: 0,\n        totalFragments: 3,\n        data: new Uint8Array(1000),\n        timestamp: Date.now(),\n      };\n\n      reassembler.addFragment(fragment);\n\n      const beforeStats = reassembler.getStats();\n      expect(beforeStats.incompleteMessages).toBe(1);\n\n      // Cleanup won't remove recent messages\n      const removed = reassembler.cleanup(100000); // Cleanup anything older than 100 seconds\n\n      // Should not have removed recent message\n      const afterStats = reassembler.getStats();\n      expect(afterStats.incompleteMessages).toBe(1);\n      expect(removed).toBe(0);\n    });\n\n    it('should include buffer limits in stats', () => {\n      const stats = reassembler.getStats();\n\n      expect(stats.bufferUsage).toBeDefined();\n      expect(stats.bufferLimit).toBe(100 * 1024 * 1024);\n    });\n  });\n});\n"],"version":3}