995f0bf5b5529897dd8d5626e9c5476a
"use strict";
/**
 * Comprehensive error handling framework for Sovereign Communications
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.createBLEError = exports.createStorageError = exports.createCryptoError = exports.createNetworkError = exports.errorManager = exports.ErrorManager = exports.SCError = exports.ErrorCategory = exports.ErrorSeverity = void 0;
var ErrorSeverity;
(function (ErrorSeverity) {
    ErrorSeverity["LOW"] = "low";
    ErrorSeverity["MEDIUM"] = "medium";
    ErrorSeverity["HIGH"] = "high";
    ErrorSeverity["CRITICAL"] = "critical";
})(ErrorSeverity || (exports.ErrorSeverity = ErrorSeverity = {}));
var ErrorCategory;
(function (ErrorCategory) {
    ErrorCategory["NETWORK"] = "network";
    ErrorCategory["CRYPTO"] = "crypto";
    ErrorCategory["STORAGE"] = "storage";
    ErrorCategory["PROTOCOL"] = "protocol";
    ErrorCategory["BLE"] = "ble";
    ErrorCategory["WEBRTC"] = "webrtc";
    ErrorCategory["UI"] = "ui";
    ErrorCategory["PERMISSION"] = "permission";
    ErrorCategory["UNKNOWN"] = "unknown";
})(ErrorCategory || (exports.ErrorCategory = ErrorCategory = {}));
class SCError extends Error {
    constructor(details) {
        super(details.message);
        this.name = 'SCError';
        this.code = details.code;
        this.category = details.category;
        this.severity = details.severity;
        this.timestamp = details.timestamp;
        this.context = details.context;
        this.recoverable = details.recoverable;
        if (details.stack) {
            this.stack = details.stack;
        }
    }
    toJSON() {
        return {
            code: this.code,
            message: this.message,
            category: this.category,
            severity: this.severity,
            timestamp: this.timestamp,
            context: this.context,
            stack: this.stack,
            recoverable: this.recoverable
        };
    }
}
exports.SCError = SCError;
class ErrorManager {
    constructor() {
        this.handlers = new Map();
        this.globalHandlers = [];
        this.errorLog = [];
        this.maxLogSize = 1000;
    }
    registerHandler(category, handler) {
        if (!this.handlers.has(category)) {
            this.handlers.set(category, []);
        }
        this.handlers.get(category).push(handler);
    }
    registerGlobalHandler(handler) {
        this.globalHandlers.push(handler);
    }
    async handle(error) {
        const scError = error instanceof SCError
            ? error
            : this.convertToSCError(error);
        // Log the error
        this.logError(scError);
        // Call category-specific handlers
        const categoryHandlers = this.handlers.get(scError.category) || [];
        for (const handler of categoryHandlers) {
            try {
                await handler(scError);
            }
            catch (handlerError) {
                console.error('Error handler failed:', handlerError);
            }
        }
        // Call global handlers
        for (const handler of this.globalHandlers) {
            try {
                await handler(scError);
            }
            catch (handlerError) {
                console.error('Global error handler failed:', handlerError);
            }
        }
    }
    convertToSCError(error) {
        return new SCError({
            code: 'UNKNOWN_ERROR',
            message: error.message,
            category: ErrorCategory.UNKNOWN,
            severity: ErrorSeverity.MEDIUM,
            timestamp: Date.now(),
            stack: error.stack,
            recoverable: false,
            context: { originalError: error.name }
        });
    }
    logError(error) {
        this.errorLog.push(error);
        if (this.errorLog.length > this.maxLogSize) {
            this.errorLog.shift();
        }
    }
    getErrors(options) {
        let filtered = this.errorLog;
        if (options?.category) {
            filtered = filtered.filter(e => e.category === options.category);
        }
        if (options?.severity) {
            filtered = filtered.filter(e => e.severity === options.severity);
        }
        if (options?.since) {
            filtered = filtered.filter(e => e.timestamp >= options.since);
        }
        if (options?.limit) {
            filtered = filtered.slice(-options.limit);
        }
        return filtered;
    }
    clearErrors() {
        this.errorLog = [];
    }
    getErrorStats() {
        const stats = {
            total: this.errorLog.length,
            byCategory: {},
            bySeverity: {}
        };
        for (const error of this.errorLog) {
            stats.byCategory[error.category] = (stats.byCategory[error.category] || 0) + 1;
            stats.bySeverity[error.severity] = (stats.bySeverity[error.severity] || 0) + 1;
        }
        return stats;
    }
}
exports.ErrorManager = ErrorManager;
// Singleton instance
exports.errorManager = new ErrorManager();
// Common error factories
const createNetworkError = (message, context) => new SCError({
    code: 'NETWORK_ERROR',
    message,
    category: ErrorCategory.NETWORK,
    severity: ErrorSeverity.MEDIUM,
    timestamp: Date.now(),
    context,
    recoverable: true
});
exports.createNetworkError = createNetworkError;
const createCryptoError = (message, context) => new SCError({
    code: 'CRYPTO_ERROR',
    message,
    category: ErrorCategory.CRYPTO,
    severity: ErrorSeverity.HIGH,
    timestamp: Date.now(),
    context,
    recoverable: false
});
exports.createCryptoError = createCryptoError;
const createStorageError = (message, context) => new SCError({
    code: 'STORAGE_ERROR',
    message,
    category: ErrorCategory.STORAGE,
    severity: ErrorSeverity.MEDIUM,
    timestamp: Date.now(),
    context,
    recoverable: true
});
exports.createStorageError = createStorageError;
const createBLEError = (message, context) => new SCError({
    code: 'BLE_ERROR',
    message,
    category: ErrorCategory.BLE,
    severity: ErrorSeverity.MEDIUM,
    timestamp: Date.now(),
    context,
    recoverable: true
});
exports.createBLEError = createBLEError;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvZXJyb3ItaGFuZGxpbmcudHMiLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOzs7QUFFSCxJQUFZLGFBS1g7QUFMRCxXQUFZLGFBQWE7SUFDdkIsNEJBQVcsQ0FBQTtJQUNYLGtDQUFpQixDQUFBO0lBQ2pCLDhCQUFhLENBQUE7SUFDYixzQ0FBcUIsQ0FBQTtBQUN2QixDQUFDLEVBTFcsYUFBYSw2QkFBYixhQUFhLFFBS3hCO0FBRUQsSUFBWSxhQVVYO0FBVkQsV0FBWSxhQUFhO0lBQ3ZCLG9DQUFtQixDQUFBO0lBQ25CLGtDQUFpQixDQUFBO0lBQ2pCLG9DQUFtQixDQUFBO0lBQ25CLHNDQUFxQixDQUFBO0lBQ3JCLDRCQUFXLENBQUE7SUFDWCxrQ0FBaUIsQ0FBQTtJQUNqQiwwQkFBUyxDQUFBO0lBQ1QsMENBQXlCLENBQUE7SUFDekIsb0NBQW1CLENBQUE7QUFDckIsQ0FBQyxFQVZXLGFBQWEsNkJBQWIsYUFBYSxRQVV4QjtBQWFELE1BQWEsT0FBUSxTQUFRLEtBQUs7SUFRaEMsWUFBWSxPQUFxQjtRQUMvQixLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQztRQUN6QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7UUFDakMsSUFBSSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQztRQUNuQyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7UUFDL0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDO1FBRXZDLElBQUksT0FBTyxDQUFDLEtBQUssRUFB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L2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvZXJyb3ItaGFuZGxpbmcudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb21wcmVoZW5zaXZlIGVycm9yIGhhbmRsaW5nIGZyYW1ld29yayBmb3IgU292ZXJlaWduIENvbW11bmljYXRpb25zXG4gKi9cblxuZXhwb3J0IGVudW0gRXJyb3JTZXZlcml0eSB7XG4gIExPVyA9ICdsb3cnLFxuICBNRURJVU0gPSAnbWVkaXVtJyxcbiAgSElHSCA9ICdoaWdoJyxcbiAgQ1JJVElDQUwgPSAnY3JpdGljYWwnXG59XG5cbmV4cG9ydCBlbnVtIEVycm9yQ2F0ZWdvcnkge1xuICBORVRXT1JLID0gJ25ldHdvcmsnLFxuICBDUllQVE8gPSAnY3J5cHRvJyxcbiAgU1RPUkFHRSA9ICdzdG9yYWdlJyxcbiAgUFJPVE9DT0wgPSAncHJvdG9jb2wnLFxuICBCTEUgPSAnYmxlJyxcbiAgV0VCUlRDID0gJ3dlYnJ0YycsXG4gIFVJID0gJ3VpJyxcbiAgUEVSTUlTU0lPTiA9ICdwZXJtaXNzaW9uJyxcbiAgVU5LTk9XTiA9ICd1bmtub3duJ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVycm9yRGV0YWlscyB7XG4gIGNvZGU6IHN0cmluZztcbiAgbWVzc2FnZTogc3RyaW5nO1xuICBjYXRlZ29yeTogRXJyb3JDYXRlZ29yeTtcbiAgc2V2ZXJpdHk6IEVycm9yU2V2ZXJpdHk7XG4gIHRpbWVzdGFtcDogbnVtYmVyO1xuICBjb250ZXh0PzogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgc3RhY2s/OiBzdHJpbmc7XG4gIHJlY292ZXJhYmxlOiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgU0NFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgcHVibGljIHJlYWRvbmx5IGNvZGU6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGNhdGVnb3J5OiBFcnJvckNhdGVnb3J5O1xuICBwdWJsaWMgcmVhZG9ubHkgc2V2ZXJpdHk6IEVycm9yU2V2ZXJpdHk7XG4gIHB1YmxpYyByZWFkb25seSB0aW1lc3RhbXA6IG51bWJlcjtcbiAgcHVibGljIHJlYWRvbmx5IGNvbnRleHQ/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICBwdWJsaWMgcmVhZG9ubHkgcmVjb3ZlcmFibGU6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoZGV0YWlsczogRXJyb3JEZXRhaWxzKSB7XG4gICAgc3VwZXIoZGV0YWlscy5tZXNzYWdlKTtcbiAgICB0aGlzLm5hbWUgPSAnU0NFcnJvcic7XG4gICAgdGhpcy5jb2RlID0gZGV0YWlscy5jb2RlO1xuICAgIHRoaXMuY2F0ZWdvcnkgPSBkZXRhaWxzLmNhdGVnb3J5O1xuICAgIHRoaXMuc2V2ZXJpdHkgPSBkZXRhaWxzLnNldmVyaXR5O1xuICAgIHRoaXMudGltZXN0YW1wID0gZGV0YWlscy50aW1lc3RhbXA7XG4gICAgdGhpcy5jb250ZXh0ID0gZGV0YWlscy5jb250ZXh0O1xuICAgIHRoaXMucmVjb3ZlcmFibGUgPSBkZXRhaWxzLnJlY292ZXJhYmxlO1xuXG4gICAgaWYgKGRldGFpbHMuc3RhY2spIHtcbiAgICAgIHRoaXMuc3RhY2sgPSBkZXRhaWxzLnN0YWNrO1xuICAgIH1cbiAgfVxuXG4gIHRvSlNPTigpOiBFcnJvckRldGFpbHMge1xuICAgIHJldHVybiB7XG4gICAgICBjb2RlOiB0aGlzLmNvZGUsXG4gICAgICBtZXNzYWdlOiB0aGlzLm1lc3NhZ2UsXG4gICAgICBjYXRlZ29yeTogdGhpcy5jYXRlZ29yeSxcbiAgICAgIHNldmVyaXR5OiB0aGlzLnNldmVyaXR5LFxuICAgICAgdGltZXN0YW1wOiB0aGlzLnRpbWVzdGFtcCxcbiAgICAgIGNvbnRleHQ6IHRoaXMuY29udGV4dCxcbiAgICAgIHN0YWNrOiB0aGlzLnN0YWNrLFxuICAgICAgcmVjb3ZlcmFibGU6IHRoaXMucmVjb3ZlcmFibGVcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCB0eXBlIEVycm9ySGFuZGxlciA9IChlcnJvcjogU0NFcnJvcikgPT4gdm9pZCB8IFByb21pc2U8dm9pZD47XG5cbmV4cG9ydCBjbGFzcyBFcnJvck1hbmFnZXIge1xuICBwcml2YXRlIGhhbmRsZXJzOiBNYXA8RXJyb3JDYXRlZ29yeSwgRXJyb3JIYW5kbGVyW10+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIGdsb2JhbEhhbmRsZXJzOiBFcnJvckhhbmRsZXJbXSA9IFtdO1xuICBwcml2YXRlIGVycm9yTG9nOiBTQ0Vycm9yW10gPSBbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBtYXhMb2dTaXplID0gMTAwMDtcblxuICByZWdpc3RlckhhbmRsZXIoY2F0ZWdvcnk6IEVycm9yQ2F0ZWdvcnksIGhhbmRsZXI6IEVycm9ySGFuZGxlcik6IHZvaWQge1xuICAgIGlmICghdGhpcy5oYW5kbGVycy5oYXMoY2F0ZWdvcnkpKSB7XG4gICAgICB0aGlzLmhhbmRsZXJzLnNldChjYXRlZ29yeSwgW10pO1xuICAgIH1cbiAgICB0aGlzLmhhbmRsZXJzLmdldChjYXRlZ29yeSkhLnB1c2goaGFuZGxlcik7XG4gIH1cblxuICByZWdpc3Rlckdsb2JhbEhhbmRsZXIoaGFuZGxlcjogRXJyb3JIYW5kbGVyKTogdm9pZCB7XG4gICAgdGhpcy5nbG9iYWxIYW5kbGVycy5wdXNoKGhhbmRsZXIpO1xuICB9XG5cbiAgYXN5bmMgaGFuZGxlKGVycm9yOiBFcnJvciB8IFNDRXJyb3IpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzY0Vycm9yID0gZXJyb3IgaW5zdGFuY2VvZiBTQ0Vycm9yIFxuICAgICAgPyBlcnJvciBcbiAgICAgIDogdGhpcy5jb252ZXJ0VG9TQ0Vycm9yKGVycm9yKTtcblxuICAgIC8vIExvZyB0aGUgZXJyb3JcbiAgICB0aGlzLmxvZ0Vycm9yKHNjRXJyb3IpO1xuXG4gICAgLy8gQ2FsbCBjYXRlZ29yeS1zcGVjaWZpYyBoYW5kbGVyc1xuICAgIGNvbnN0IGNhdGVnb3J5SGFuZGxlcnMgPSB0aGlzLmhhbmRsZXJzLmdldChzY0Vycm9yLmNhdGVnb3J5KSB8fCBbXTtcbiAgICBmb3IgKGNvbnN0IGhhbmRsZXIgb2YgY2F0ZWdvcnlIYW5kbGVycykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgaGFuZGxlcihzY0Vycm9yKTtcbiAgICAgIH0gY2F0Y2ggKGhhbmRsZXJFcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBoYW5kbGVyIGZhaWxlZDonLCBoYW5kbGVyRXJyb3IpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENhbGwgZ2xvYmFsIGhhbmRsZXJzXG4gICAgZm9yIChjb25zdCBoYW5kbGVyIG9mIHRoaXMuZ2xvYmFsSGFuZGxlcnMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGhhbmRsZXIoc2NFcnJvcik7XG4gICAgICB9IGNhdGNoIChoYW5kbGVyRXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignR2xvYmFsIGVycm9yIGhhbmRsZXIgZmFpbGVkOicsIGhhbmRsZXJFcnJvcik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0VG9TQ0Vycm9yKGVycm9yOiBFcnJvcik6IFNDRXJyb3Ige1xuICAgIHJldHVybiBuZXcgU0NFcnJvcih7XG4gICAgICBjb2RlOiAnVU5LTk9XTl9FUlJPUicsXG4gICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgY2F0ZWdvcnk6IEVycm9yQ2F0ZWdvcnkuVU5LTk9XTixcbiAgICAgIHNldmVyaXR5OiBFcnJvclNldmVyaXR5Lk1FRElVTSxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgIHJlY292ZXJhYmxlOiBmYWxzZSxcbiAgICAgIGNvbnRleHQ6IHsgb3JpZ2luYWxFcnJvcjogZXJyb3IubmFtZSB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGxvZ0Vycm9yKGVycm9yOiBTQ0Vycm9yKTogdm9pZCB7XG4gICAgdGhpcy5lcnJvckxvZy5wdXNoKGVycm9yKTtcbiAgICBpZiAodGhpcy5lcnJvckxvZy5sZW5ndGggPiB0aGlzLm1heExvZ1NpemUpIHtcbiAgICAgIHRoaXMuZXJyb3JMb2cuc2hpZnQoKTtcbiAgICB9XG4gIH1cblxuICBnZXRFcnJvcnMob3B0aW9ucz86IHtcbiAgICBjYXRlZ29yeT86IEVycm9yQ2F0ZWdvcnk7XG4gICAgc2V2ZXJpdHk/OiBFcnJvclNldmVyaXR5O1xuICAgIHNpbmNlPzogbnVtYmVyO1xuICAgIGxpbWl0PzogbnVtYmVyO1xuICB9KTogU0NFcnJvcltdIHtcbiAgICBsZXQgZmlsdGVyZWQgPSB0aGlzLmVycm9yTG9nO1xuXG4gICAgaWYgKG9wdGlvbnM/LmNhdGVnb3J5KSB7XG4gICAgICBmaWx0ZXJlZCA9IGZpbHRlcmVkLmZpbHRlcihlID0+IGUuY2F0ZWdvcnkgPT09IG9wdGlvbnMuY2F0ZWdvcnkpO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucz8uc2V2ZXJpdHkpIHtcbiAgICAgIGZpbHRlcmVkID0gZmlsdGVyZWQuZmlsdGVyKGUgPT4gZS5zZXZlcml0eSA9PT0gb3B0aW9ucy5zZXZlcml0eSk7XG4gICAgfVxuICAgIGlmIChvcHRpb25zPy5zaW5jZSkge1xuICAgICAgZmlsdGVyZWQgPSBmaWx0ZXJlZC5maWx0ZXIoZSA9PiBlLnRpbWVzdGFtcCA+PSBvcHRpb25zLnNpbmNlISk7XG4gICAgfVxuICAgIGlmIChvcHRpb25zPy5saW1pdCkge1xuICAgICAgZmlsdGVyZWQgPSBmaWx0ZXJlZC5zbGljZSgtb3B0aW9ucy5saW1pdCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpbHRlcmVkO1xuICB9XG5cbiAgY2xlYXJFcnJvcnMoKTogdm9pZCB7XG4gICAgdGhpcy5lcnJvckxvZyA9IFtdO1xuICB9XG5cbiAgZ2V0RXJyb3JTdGF0cygpOiB7XG4gICAgdG90YWw6IG51bWJlcjtcbiAgICBieUNhdGVnb3J5OiBSZWNvcmQ8RXJyb3JDYXRlZ29yeSwgbnVtYmVyPjtcbiAgICBieVNldmVyaXR5OiBSZWNvcmQ8RXJyb3JTZXZlcml0eSwgbnVtYmVyPjtcbiAgfSB7XG4gICAgY29uc3Qgc3RhdHMgPSB7XG4gICAgICB0b3RhbDogdGhpcy5lcnJvckxvZy5sZW5ndGgsXG4gICAgICBieUNhdGVnb3J5OiB7fSBhcyBSZWNvcmQ8RXJyb3JDYXRlZ29yeSwgbnVtYmVyPixcbiAgICAgIGJ5U2V2ZXJpdHk6IHt9IGFzIFJlY29yZDxFcnJvclNldmVyaXR5LCBudW1iZXI+XG4gICAgfTtcblxuICAgIGZvciAoY29uc3QgZXJyb3Igb2YgdGhpcy5lcnJvckxvZykge1xuICAgICAgc3RhdHMuYnlDYXRlZ29yeVtlcnJvci5jYXRlZ29yeV0gPSAoc3RhdHMuYnlDYXRlZ29yeVtlcnJvci5jYXRlZ29yeV0gfHwgMCkgKyAxO1xuICAgICAgc3RhdHMuYnlTZXZlcml0eVtlcnJvci5zZXZlcml0eV0gPSAoc3RhdHMuYnlTZXZlcml0eVtlcnJvci5zZXZlcml0eV0gfHwgMCkgKyAxO1xuICAgIH1cblxuICAgIHJldHVybiBzdGF0cztcbiAgfVxufVxuXG4vLyBTaW5nbGV0b24gaW5zdGFuY2VcbmV4cG9ydCBjb25zdCBlcnJvck1hbmFnZXIgPSBuZXcgRXJyb3JNYW5hZ2VyKCk7XG5cbi8vIENvbW1vbiBlcnJvciBmYWN0b3JpZXNcbmV4cG9ydCBjb25zdCBjcmVhdGVOZXR3b3JrRXJyb3IgPSAobWVzc2FnZTogc3RyaW5nLCBjb250ZXh0PzogYW55KTogU0NFcnJvciA9PiBcbiAgbmV3IFNDRXJyb3Ioe1xuICAgIGNvZGU6ICdORVRXT1JLX0VSUk9SJyxcbiAgICBtZXNzYWdlLFxuICAgIGNhdGVnb3J5OiBFcnJvckNhdGVnb3J5Lk5FVFdPUkssXG4gICAgc2V2ZXJpdHk6IEVycm9yU2V2ZXJpdHkuTUVESVVNLFxuICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICBjb250ZXh0LFxuICAgIHJlY292ZXJhYmxlOiB0cnVlXG4gIH0pO1xuXG5leHBvcnQgY29uc3QgY3JlYXRlQ3J5cHRvRXJyb3IgPSAobWVzc2FnZTogc3RyaW5nLCBjb250ZXh0PzogYW55KTogU0NFcnJvciA9PiBcbiAgbmV3IFNDRXJyb3Ioe1xuICAgIGNvZGU6ICdDUllQVE9fRVJST1InLFxuICAgIG1lc3NhZ2UsXG4gICAgY2F0ZWdvcnk6IEVycm9yQ2F0ZWdvcnkuQ1JZUFRPLFxuICAgIHNldmVyaXR5OiBFcnJvclNldmVyaXR5LkhJR0gsXG4gICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgIGNvbnRleHQsXG4gICAgcmVjb3ZlcmFibGU6IGZhbHNlXG4gIH0pO1xuXG5leHBvcnQgY29uc3QgY3JlYXRlU3RvcmFnZUVycm9yID0gKG1lc3NhZ2U6IHN0cmluZywgY29udGV4dD86IGFueSk6IFNDRXJyb3IgPT4gXG4gIG5ldyBTQ0Vycm9yKHtcbiAgICBjb2RlOiAnU1RPUkFHRV9FUlJPUicsXG4gICAgbWVzc2FnZSxcbiAgICBjYXRlZ29yeTogRXJyb3JDYXRlZ29yeS5TVE9SQUdFLFxuICAgIHNldmVyaXR5OiBFcnJvclNldmVyaXR5Lk1FRElVTSxcbiAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgY29udGV4dCxcbiAgICByZWNvdmVyYWJsZTogdHJ1ZVxuICB9KTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZUJMRUVycm9yID0gKG1lc3NhZ2U6IHN0cmluZywgY29udGV4dD86IGFueSk6IFNDRXJyb3IgPT4gXG4gIG5ldyBTQ0Vycm9yKHtcbiAgICBjb2RlOiAnQkxFX0VSUk9SJyxcbiAgICBtZXNzYWdlLFxuICAgIGNhdGVnb3J5OiBFcnJvckNhdGVnb3J5LkJMRSxcbiAgICBzZXZlcml0eTogRXJyb3JTZXZlcml0eS5NRURJVU0sXG4gICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgIGNvbnRleHQsXG4gICAgcmVjb3ZlcmFibGU6IHRydWVcbiAgfSk7XG4iXSwidmVyc2lvbiI6M30=