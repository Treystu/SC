28fabcae80be5aa7282d6dfa0dc78090
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.rateLimiter = exports.RateLimiter = exports.DEFAULT_RATE_LIMITS = void 0;
exports.DEFAULT_RATE_LIMITS = {
    messagesPerMinute: 60,
    messagesPerHour: 1000,
    filesPerHour: 100,
    maxMessageSize: 10000
};
class RateLimiter {
    constructor(config = exports.DEFAULT_RATE_LIMITS) {
        this.messageTimestamps = new Map();
        this.fileTimestamps = new Map();
        this.config = config;
    }
    canSendMessage(userId) {
        const now = Date.now();
        const userMessages = this.messageTimestamps.get(userId) || [];
        // Check per-minute limit
        const lastMinute = userMessages.filter(t => now - t < 60000);
        if (lastMinute.length >= this.config.messagesPerMinute) {
            return {
                allowed: false,
                reason: `Rate limit exceeded: ${this.config.messagesPerMinute} messages per minute`
            };
        }
        // Check per-hour limit
        const lastHour = userMessages.filter(t => now - t < 3600000);
        if (lastHour.length >= this.config.messagesPerHour) {
            return {
                allowed: false,
                reason: `Rate limit exceeded: ${this.config.messagesPerHour} messages per hour`
            };
        }
        // Record this message
        lastHour.push(now);
        this.messageTimestamps.set(userId, lastHour);
        return { allowed: true };
    }
    canSendFile(userId) {
        const now = Date.now();
        const userFiles = this.fileTimestamps.get(userId) || [];
        // Check per-hour limit
        const lastHour = userFiles.filter(t => now - t < 3600000);
        if (lastHour.length >= this.config.filesPerHour) {
            return {
                allowed: false,
                reason: `Rate limit exceeded: ${this.config.filesPerHour} files per hour`
            };
        }
        // Record this file
        lastHour.push(now);
        this.fileTimestamps.set(userId, lastHour);
        return { allowed: true };
    }
    cleanup() {
        const now = Date.now();
        const hourAgo = now - 3600000;
        // Clean up old timestamps
        for (const [userId, timestamps] of this.messageTimestamps.entries()) {
            const recent = timestamps.filter(t => t > hourAgo);
            if (recent.length === 0) {
                this.messageTimestamps.delete(userId);
            }
            else {
                this.messageTimestamps.set(userId, recent);
            }
        }
        for (const [userId, timestamps] of this.fileTimestamps.entries()) {
            const recent = timestamps.filter(t => t > hourAgo);
            if (recent.length === 0) {
                this.fileTimestamps.delete(userId);
            }
            else {
                this.fileTimestamps.set(userId, recent);
            }
        }
    }
}
exports.RateLimiter = RateLimiter;
// Global rate limiter instance
exports.rateLimiter = new RateLimiter();
// Cleanup every 5 minutes
const __rateLimiterCleanupTimer = setInterval(() => exports.rateLimiter.cleanup(), 5 * 60 * 1000);
try {
    if (__rateLimiterCleanupTimer && typeof __rateLimiterCleanupTimer.unref === 'function') {
        __rateLimiterCleanupTimer.unref();
    }
}
catch (e) { /* no-op */ }
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvcmF0ZS1saW1pdGVyLnRzIiwibWFwcGluZ3MiOiI7OztBQU9hLFFBQUEsbUJBQW1CLEdBQW9CO0lBQ2xELGlCQUFpQixFQUFFLEVBQUU7SUFDckIsZUFBZSxFQUFFLElBQUk7SUFDckIsWUFBWSxFQUFFLEdBQUc7SUFDakIsY0FBYyxFQUFFLEtBQUs7Q0FDdEIsQ0FBQztBQUVGLE1BQWEsV0FBVztJQUt0QixZQUFZLFNBQTBCLDJCQUFtQjtRQUpqRCxzQkFBaUIsR0FBRyxJQUFJLEdBQUcsRUFBb0IsQ0FBQztRQUNoRCxtQkFBYyxHQUFHLElBQUksR0FBRyxFQUFvQixDQUFDO1FBSW5ELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxjQUFjLENBQUMsTUFBYztRQUMzQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDdkIsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFOUQseUJBQXlCO1FBQ3pCLE1BQU0sVUFBVSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDO1FBQzdELElBQUksVUFBVSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDdkQsT0FBTztnQkFDTCxPQUFPLEVBQUUsS0FBSztnQkFDZCxNQUFNLEVBQUUsd0JBQXdCLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLHNCQUFzQjthQUNwRixDQUFDO1FBQ0osQ0FBQztRQUVELHVCQUF1QjtRQUN2QixNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENB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MUMsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFqRkQsa0NBaUZDO0FBRUQsK0JBQStCO0FBQ2xCLFFBQUEsV0FBVyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUFFN0MsMEJBQTBCO0FBQzFCLE1BQU0seUJBQXlCLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDLG1CQUFXLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztBQUMxRixJQUFJLENBQUM7SUFDSCxJQUFJLHlCQUF5QixJQUFJLE9BQVEseUJBQWlDLENBQUMsS0FBSyxLQUFLLFVBQVUsRUFBRSxDQUFDO1FBQy9GLHlCQUFpQyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzdDLENBQUM7QUFDRCxDQUFDO0FBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jaHJpc3R5bWF4d2VsbC9EZXNrdG9wL0x1a2VfU3R1ZmYvR2l0SHViL1NDL2NvcmUvc3JjL3JhdGUtbGltaXRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgaW50ZXJmYWNlIFJhdGVMaW1pdENvbmZpZyB7XG4gIG1lc3NhZ2VzUGVyTWludXRlOiBudW1iZXI7XG4gIG1lc3NhZ2VzUGVySG91cjogbnVtYmVyO1xuICBmaWxlc1BlckhvdXI6IG51bWJlcjtcbiAgbWF4TWVzc2FnZVNpemU6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfUkFURV9MSU1JVFM6IFJhdGVMaW1pdENvbmZpZyA9IHtcbiAgbWVzc2FnZXNQZXJNaW51dGU6IDYwLFxuICBtZXNzYWdlc1BlckhvdXI6IDEwMDAsXG4gIGZpbGVzUGVySG91cjogMTAwLFxuICBtYXhNZXNzYWdlU2l6ZTogMTAwMDBcbn07XG5cbmV4cG9ydCBjbGFzcyBSYXRlTGltaXRlciB7XG4gIHByaXZhdGUgbWVzc2FnZVRpbWVzdGFtcHMgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyW10+KCk7XG4gIHByaXZhdGUgZmlsZVRpbWVzdGFtcHMgPSBuZXcgTWFwPHN0cmluZywgbnVtYmVyW10+KCk7XG4gIHByaXZhdGUgY29uZmlnOiBSYXRlTGltaXRDb25maWc7XG4gIFxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFJhdGVMaW1pdENvbmZpZyA9IERFRkFVTFRfUkFURV9MSU1JVFMpIHtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgfVxuICBcbiAgY2FuU2VuZE1lc3NhZ2UodXNlcklkOiBzdHJpbmcpOiB7IGFsbG93ZWQ6IGJvb2xlYW47IHJlYXNvbj86IHN0cmluZyB9IHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHVzZXJNZXNzYWdlcyA9IHRoaXMubWVzc2FnZVRpbWVzdGFtcHMuZ2V0KHVzZXJJZCkgfHwgW107XG4gICAgXG4gICAgLy8gQ2hlY2sgcGVyLW1pbnV0ZSBsaW1pdFxuICAgIGNvbnN0IGxhc3RNaW51dGUgPSB1c2VyTWVzc2FnZXMuZmlsdGVyKHQgPT4gbm93IC0gdCA8IDYwMDAwKTtcbiAgICBpZiAobGFzdE1pbnV0ZS5sZW5ndGggPj0gdGhpcy5jb25maWcubWVzc2FnZXNQZXJNaW51dGUpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGFsbG93ZWQ6IGZhbHNlLFxuICAgICAgICByZWFzb246IGBSYXRlIGxpbWl0IGV4Y2VlZGVkOiAke3RoaXMuY29uZmlnLm1lc3NhZ2VzUGVyTWludXRlfSBtZXNzYWdlcyBwZXIgbWludXRlYFxuICAgICAgfTtcbiAgICB9XG4gICAgXG4gICAgLy8gQ2hlY2sgcGVyLWhvdXIgbGltaXRcbiAgICBjb25zdCBsYXN0SG91ciA9IHVzZXJNZXNzYWdlcy5maWx0ZXIodCA9PiBub3cgLSB0IDwgMzYwMDAwMCk7XG4gICAgaWYgKGxhc3RIb3VyLmxlbmd0aCA+PSB0aGlzLmNvbmZpZy5tZXNzYWdlc1BlckhvdXIpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGFsbG93ZWQ6IGZhbHNlLFxuICAgICAgICByZWFzb246IGBSYXRlIGxpbWl0IGV4Y2VlZGVkOiAke3RoaXMuY29uZmlnLm1lc3NhZ2VzUGVySG91cn0gbWVzc2FnZXMgcGVyIGhvdXJgXG4gICAgICB9O1xuICAgIH1cbiAgICBcbiAgICAvLyBSZWNvcmQgdGhpcyBtZXNzYWdlXG4gICAgbGFzdEhvdXIucHVzaChub3cpO1xuICAgIHRoaXMubWVzc2FnZVRpbWVzdGFtcHMuc2V0KHVzZXJJZCwgbGFzdEhvdXIpO1xuICAgIFxuICAgIHJldHVybiB7IGFsbG93ZWQ6IHRydWUgfTtcbiAgfVxuICBcbiAgY2FuU2VuZEZpbGUodXNlcklkOiBzdHJpbmcpOiB7IGFsbG93ZWQ6IGJvb2xlYW47IHJlYXNvbj86IHN0cmluZyB9IHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IHVzZXJGaWxlcyA9IHRoaXMuZmlsZVRpbWVzdGFtcHMuZ2V0KHVzZXJJZCkgfHwgW107XG4gICAgXG4gICAgLy8gQ2hlY2sgcGVyLWhvdXIgbGltaXRcbiAgICBjb25zdCBsYXN0SG91ciA9IHVzZXJGaWxlcy5maWx0ZXIodCA9PiBub3cgLSB0IDwgMzYwMDAwMCk7XG4gICAgaWYgKGxhc3RIb3VyLmxlbmd0aCA+PSB0aGlzLmNvbmZpZy5maWxlc1BlckhvdXIpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGFsbG93ZWQ6IGZhbHNlLFxuICAgICAgICByZWFzb246IGBSYXRlIGxpbWl0IGV4Y2VlZGVkOiAke3RoaXMuY29uZmlnLmZpbGVzUGVySG91cn0gZmlsZXMgcGVyIGhvdXJgXG4gICAgICB9O1xuICAgIH1cbiAgICBcbiAgICAvLyBSZWNvcmQgdGhpcyBmaWxlXG4gICAgbGFzdEhvdXIucHVzaChub3cpO1xuICAgIHRoaXMuZmlsZVRpbWVzdGFtcHMuc2V0KHVzZXJJZCwgbGFzdEhvdXIpO1xuICAgIFxuICAgIHJldHVybiB7IGFsbG93ZWQ6IHRydWUgfTtcbiAgfVxuICBcbiAgY2xlYW51cCgpIHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGhvdXJBZ28gPSBub3cgLSAzNjAwMDAwO1xuICAgIFxuICAgIC8vIENsZWFuIHVwIG9sZCB0aW1lc3RhbXBzXG4gICAgZm9yIChjb25zdCBbdXNlcklkLCB0aW1lc3RhbXBzXSBvZiB0aGlzLm1lc3NhZ2VUaW1lc3RhbXBzLmVudHJpZXMoKSkge1xuICAgICAgY29uc3QgcmVjZW50ID0gdGltZXN0YW1wcy5maWx0ZXIodCA9PiB0ID4gaG91ckFnbyk7XG4gICAgICBpZiAocmVjZW50Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLm1lc3NhZ2VUaW1lc3RhbXBzLmRlbGV0ZSh1c2VySWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5tZXNzYWdlVGltZXN0YW1wcy5zZXQodXNlcklkLCByZWNlbnQpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBmb3IgKGNvbnN0IFt1c2VySWQsIHRpbWVzdGFtcHNdIG9mIHRoaXMuZmlsZVRpbWVzdGFtcHMuZW50cmllcygpKSB7XG4gICAgICBjb25zdCByZWNlbnQgPSB0aW1lc3RhbXBzLmZpbHRlcih0ID0+IHQgPiBob3VyQWdvKTtcbiAgICAgIGlmIChyZWNlbnQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMuZmlsZVRpbWVzdGFtcHMuZGVsZXRlKHVzZXJJZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmZpbGVUaW1lc3RhbXBzLnNldCh1c2VySWQsIHJlY2VudCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8vIEdsb2JhbCByYXRlIGxpbWl0ZXIgaW5zdGFuY2VcbmV4cG9ydCBjb25zdCByYXRlTGltaXRlciA9IG5ldyBSYXRlTGltaXRlcigpO1xuXG4vLyBDbGVhbnVwIGV2ZXJ5IDUgbWludXRlc1xuY29uc3QgX19yYXRlTGltaXRlckNsZWFudXBUaW1lciA9IHNldEludGVydmFsKCgpID0+IHJhdGVMaW1pdGVyLmNsZWFudXAoKSwgNSAqIDYwICogMTAwMCk7XG50cnkge1xuICBpZiAoX19yYXRlTGltaXRlckNsZWFudXBUaW1lciAmJiB0eXBlb2YgKF9fcmF0ZUxpbWl0ZXJDbGVhbnVwVGltZXIgYXMgYW55KS51bnJlZiA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIChfX3JhdGVMaW1pdGVyQ2xlYW51cFRpbWVyIGFzIGFueSkudW5yZWYoKTtcbiAgfVxuICB9IGNhdGNoIChlKSB7IC8qIG5vLW9wICovIH0iXSwidmVyc2lvbiI6M30=