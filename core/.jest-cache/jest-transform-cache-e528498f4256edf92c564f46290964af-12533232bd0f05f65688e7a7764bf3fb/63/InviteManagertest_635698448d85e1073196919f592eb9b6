5ef65eb7525c8b5029b13a2d8a45dd2f
"use strict";
/**
 * Tests for InviteManager
 */
Object.defineProperty(exports, "__esModule", { value: true });
const InviteManager_1 = require("./InviteManager");
const primitives_1 = require("../crypto/primitives");
describe('InviteManager', () => {
    let inviteManager;
    let identity;
    beforeEach(() => {
        identity = (0, primitives_1.generateIdentity)();
        inviteManager = new InviteManager_1.InviteManager('test-peer-id', identity.publicKey, identity.privateKey, 'Test User');
    });
    describe('Invite Creation', () => {
        it('should create a valid invite with default TTL', async () => {
            const invite = await inviteManager.createInvite();
            expect(invite.code).toBeDefined();
            expect(invite.code).toHaveLength(64); // 32 bytes as hex
            expect(invite.inviterPeerId).toBe('test-peer-id');
            expect(invite.inviterPublicKey).toEqual(identity.publicKey);
            expect(invite.inviterName).toBe('Test User');
            expect(invite.signature).toHaveLength(64);
            expect(invite.expiresAt).toBeGreaterThan(invite.createdAt);
            expect(invite.bootstrapPeers).toEqual([]);
        });
        it('should create invites with custom TTL', async () => {
            const customTTL = 60 * 60 * 1000; // 1 hour
            const invite = await inviteManager.createInvite({ ttl: customTTL });
            expect(invite.expiresAt - invite.createdAt).toBe(customTTL);
        });
        it('should create invites with metadata', async () => {
            const metadata = { purpose: 'testing', priority: 'high' };
            const invite = await inviteManager.createInvite({ metadata });
            expect(invite.metadata).toEqual(metadata);
        });
        it('should generate unique invite codes', async () => {
            const invite1 = await inviteManager.createInvite();
            const invite2 = await inviteManager.createInvite();
            expect(invite1.code).not.toBe(invite2.code);
        });
        it('should store created invites', async () => {
            const invite = await inviteManager.createInvite();
            const retrieved = inviteManager.getInvite(invite.code);
            expect(retrieved).toEqual(invite);
        });
    });
    describe('Invite Validation', () => {
        it('should validate a valid invite', async () => {
            const invite = await inviteManager.createInvite();
            const validation = await inviteManager.validateInvite(invite.code);
            expect(validation.valid).toBe(true);
            expect(validation.error).toBeUndefined();
            expect(validation.invite).toEqual(invite);
        });
        it('should reject invalid invite codes', async () => {
            const validation = await inviteManager.validateInvite('invalid-code');
            expect(validation.valid).toBe(false);
            expect(validation.error).toBe('Invalid invite code');
        });
        it('should reject expired invites', async () => {
            const invite = await inviteManager.createInvite({ ttl: -1000 }); // Expired
            const validation = await inviteManager.validateInvite(invite.code);
            expect(validation.valid).toBe(false);
            expect(validation.error).toBe('Invite expired');
        });
        it('should reject invites with invalid signatures', async () => {
            const invite = await inviteManager.createInvite();
            // Tamper with the signature
            invite.signature = new Uint8Array(64);
            // Manually update the stored invite (simulating tampering)
            const allInvites = inviteManager.getAllInvites();
            const inviteIndex = allInvites.findIndex(i => i.code === invite.code);
            if (inviteIndex !== -1) {
                // Re-create manager to test with tampered data
                const tamperedManager = new InviteManager_1.InviteManager('test-peer-id', identity.publicKey, identity.privateKey);
                // Manually set the invite with tampered signature
                await tamperedManager.createInvite();
                const invites = tamperedManager.invites;
                const storedInvite = invites.get([...invites.keys()][0]);
                storedInvite.signature = new Uint8Array(64);
                const validation = await tamperedManager.validateInvite(storedInvite.code);
                expect(validation.valid).toBe(false);
                expect(validation.error).toBe('Invalid signature');
            }
        });
    });
    describe('Invite Redemption', () => {
        it('should successfully redeem a valid invite', async () => {
            const invite = await inviteManager.createInvite();
            const result = await inviteManager.redeemInvite(invite.code, 'recipient-peer-id');
            expect(result.success).toBe(true);
            expect(result.contact.peerId).toBe(invite.inviterPeerId);
            expect(result.contact.publicKey).toEqual(invite.inviterPublicKey);
            expect(result.contact.verified).toBe(true);
            expect(result.contact.addedVia).toBe('invite');
        });
        it('should remove invite after redemption', async () => {
            const invite = await inviteManager.createInvite();
            await inviteManager.redeemInvite(invite.code, 'recipient-peer-id');
            const retrieved = inviteManager.getInvite(invite.code);
            expect(retrieved).toBeUndefined();
        });
        it('should throw error for invalid invite code', async () => {
            await expect(inviteManager.redeemInvite('invalid-code', 'recipient-peer-id')).rejects.toThrow('Invalid invite code');
        });
        it('should throw error for expired invite', async () => {
            const invite = await inviteManager.createInvite({ ttl: -1000 });
            await expect(inviteManager.redeemInvite(invite.code, 'recipient-peer-id')).rejects.toThrow('Invite expired');
        });
        it('should include inviter name in contact', async () => {
            const invite = await inviteManager.createInvite();
            const result = await inviteManager.redeemInvite(invite.code, 'recipient-peer-id');
            expect(result.contact.name).toBe('Test User');
        });
    });
    describe('Invite Management', () => {
        it('should get all pending invites', async () => {
            await inviteManager.createInvite();
            await inviteManager.createInvite();
            await inviteManager.createInvite();
            const invites = inviteManager.getAllInvites();
            expect(invites).toHaveLength(3);
        });
        it('should clean up expired invites', async () => {
            // Create some invites with different expiration times
            await inviteManager.createInvite({ ttl: -1000 }); // Expired
            await inviteManager.createInvite({ ttl: -1000 }); // Expired
            await inviteManager.createInvite({ ttl: 60000 }); // Valid
            const removedCount = inviteManager.cleanupExpiredInvites();
            expect(removedCount).toBe(2);
            expect(inviteManager.getPendingInviteCount()).toBe(1);
        });
        it('should revoke a specific invite', async () => {
            const invite = await inviteManager.createInvite();
            const result = inviteManager.revokeInvite(invite.code);
            expect(result).toBe(true);
            expect(inviteManager.getInvite(invite.code)).toBeUndefined();
        });
        it('should return false when revoking non-existent invite', () => {
            const result = inviteManager.revokeInvite('non-existent');
            expect(result).toBe(false);
        });
        it('should revoke all invites', async () => {
            await inviteManager.createInvite();
            await inviteManager.createInvite();
            await inviteManager.createInvite();
            const revokedCount = inviteManager.revokeAllInvites();
            expect(revokedCount).toBe(3);
            expect(inviteManager.getPendingInviteCount()).toBe(0);
        });
        it('should track pending invite count', async () => {
            expect(inviteManager.getPendingInviteCount()).toBe(0);
            await inviteManager.createInvite();
            expect(inviteManager.getPendingInviteCount()).toBe(1);
            await inviteManager.createInvite();
            expect(inviteManager.getPendingInviteCount()).toBe(2);
        });
    });
    describe('Edge Cases', () => {
        it('should handle manager without display name', async () => {
            const manager = new InviteManager_1.InviteManager('test-peer-id', identity.publicKey, identity.privateKey);
            const invite = await manager.createInvite();
            expect(invite.inviterName).toBe('User'); // Default name when none provided
        });
        it('should handle zero TTL', async () => {
            const invite = await inviteManager.createInvite({ ttl: -100 });
            const validation = await inviteManager.validateInvite(invite.code);
            expect(validation.valid).toBe(false);
            expect(validation.error).toBe('Invite expired');
        });
        it('should handle very long TTL', async () => {
            const veryLongTTL = 365 * 24 * 60 * 60 * 1000; // 1 year
            const invite = await inviteManager.createInvite({ ttl: veryLongTTL });
            expect(invite.expiresAt - invite.createdAt).toBe(veryLongTTL);
        });
        it('should not mutate original metadata', async () => {
            const metadata = { key: 'value' };
            const invite = await inviteManager.createInvite({ metadata });
            metadata.key = 'changed';
            expect(invite.metadata?.key).toBe('value');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvc2hhcmluZy9JbnZpdGVNYW5hZ2VyLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILG1EQUFnRDtBQUNoRCxxREFBd0Q7QUFFeEQsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7SUFDN0IsSUFBSSxhQUE0QixDQUFDO0lBQ2pDLElBQUksUUFBNkMsQ0FBQztJQUVsRCxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsUUFBUSxHQUFHLElBQUEsNkJBQWdCLEdBQUUsQ0FBQztRQUM5QixhQUFhLEdBQUcsSUFBSSw2QkFBYSxDQUMvQixjQUFjLEVBQ2QsUUFBUSxDQUFDLFNBQVMsRUFDbEIsUUFBUSxDQUFDLFVBQVUsRUFDbkIsV0FBVyxDQUNaLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7UUFDL0IsRUFBRSxDQUFDLCtDQUErQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQzdELE1BQU0sTUFBTSxHQUFHLE1BQU0sYUFBYSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBRWxELE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxrQkFBa0I7WUFDeEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDbEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDNUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDN0MsTUFBTSxD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QUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUU5RCxRQUFRLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQztZQUN6QixNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0MsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jaHJpc3R5bWF4d2VsbC9EZXNrdG9wL0x1a2VfU3R1ZmYvR2l0SHViL1NDL2NvcmUvc3JjL3NoYXJpbmcvSW52aXRlTWFuYWdlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVGVzdHMgZm9yIEludml0ZU1hbmFnZXJcbiAqL1xuXG5pbXBvcnQgeyBJbnZpdGVNYW5hZ2VyIH0gZnJvbSAnLi9JbnZpdGVNYW5hZ2VyJztcbmltcG9ydCB7IGdlbmVyYXRlSWRlbnRpdHkgfSBmcm9tICcuLi9jcnlwdG8vcHJpbWl0aXZlcyc7XG5cbmRlc2NyaWJlKCdJbnZpdGVNYW5hZ2VyJywgKCkgPT4ge1xuICBsZXQgaW52aXRlTWFuYWdlcjogSW52aXRlTWFuYWdlcjtcbiAgbGV0IGlkZW50aXR5OiBSZXR1cm5UeXBlPHR5cGVvZiBnZW5lcmF0ZUlkZW50aXR5PjtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBpZGVudGl0eSA9IGdlbmVyYXRlSWRlbnRpdHkoKTtcbiAgICBpbnZpdGVNYW5hZ2VyID0gbmV3IEludml0ZU1hbmFnZXIoXG4gICAgICAndGVzdC1wZWVyLWlkJyxcbiAgICAgIGlkZW50aXR5LnB1YmxpY0tleSxcbiAgICAgIGlkZW50aXR5LnByaXZhdGVLZXksXG4gICAgICAnVGVzdCBVc2VyJ1xuICAgICk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdJbnZpdGUgQ3JlYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYSB2YWxpZCBpbnZpdGUgd2l0aCBkZWZhdWx0IFRUTCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG5cbiAgICAgIGV4cGVjdChpbnZpdGUuY29kZSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChpbnZpdGUuY29kZSkudG9IYXZlTGVuZ3RoKDY0KTsgLy8gMzIgYnl0ZXMgYXMgaGV4XG4gICAgICBleHBlY3QoaW52aXRlLmludml0ZXJQZWVySWQpLnRvQmUoJ3Rlc3QtcGVlci1pZCcpO1xuICAgICAgZXhwZWN0KGludml0ZS5pbnZpdGVyUHVibGljS2V5KS50b0VxdWFsKGlkZW50aXR5LnB1YmxpY0tleSk7XG4gICAgICBleHBlY3QoaW52aXRlLmludml0ZXJOYW1lKS50b0JlKCdUZXN0IFVzZXInKTtcbiAgICAgIGV4cGVjdChpbnZpdGUuc2lnbmF0dXJlKS50b0hhdmVMZW5ndGgoNjQpO1xuICAgICAgZXhwZWN0KGludml0ZS5leHBpcmVzQXQpLnRvQmVHcmVhdGVyVGhhbihpbnZpdGUuY3JlYXRlZEF0KTtcbiAgICAgIGV4cGVjdChpbnZpdGUuYm9vdHN0cmFwUGVlcnMpLnRvRXF1YWwoW10pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgaW52aXRlcyB3aXRoIGN1c3RvbSBUVEwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBjdXN0b21UVEwgPSA2MCAqIDYwICogMTAwMDsgLy8gMSBob3VyXG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSh7IHR0bDogY3VzdG9tVFRMIH0pO1xuXG4gICAgICBleHBlY3QoaW52aXRlLmV4cGlyZXNBdCAtIGludml0ZS5jcmVhdGVkQXQpLnRvQmUoY3VzdG9tVFRMKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY3JlYXRlIGludml0ZXMgd2l0aCBtZXRhZGF0YScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0geyBwdXJwb3NlOiAndGVzdGluZycsIHByaW9yaXR5OiAnaGlnaCcgfTtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKHsgbWV0YWRhdGEgfSk7XG5cbiAgICAgIGV4cGVjdChpbnZpdGUubWV0YWRhdGEpLnRvRXF1YWwobWV0YWRhdGEpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSB1bmlxdWUgaW52aXRlIGNvZGVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlMSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBjb25zdCBpbnZpdGUyID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcblxuICAgICAgZXhwZWN0KGludml0ZTEuY29kZSkubm90LnRvQmUoaW52aXRlMi5jb2RlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc3RvcmUgY3JlYXRlZCBpbnZpdGVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGNvbnN0IHJldHJpZXZlZCA9IGludml0ZU1hbmFnZXIuZ2V0SW52aXRlKGludml0ZS5jb2RlKTtcblxuICAgICAgZXhwZWN0KHJldHJpZXZlZCkudG9FcXVhbChpbnZpdGUpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnSW52aXRlIFZhbGlkYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSBhIHZhbGlkIGludml0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgaW52aXRlTWFuYWdlci52YWxpZGF0ZUludml0ZShpbnZpdGUuY29kZSk7XG5cbiAgICAgIGV4cGVjdCh2YWxpZGF0aW9uLnZhbGlkKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHZhbGlkYXRpb24uZXJyb3IpLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIGV4cGVjdCh2YWxpZGF0aW9uLmludml0ZSkudG9FcXVhbChpbnZpdGUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgaW52YWxpZCBpbnZpdGUgY29kZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB2YWxpZGF0aW9uID0gYXdhaXQgaW52aXRlTWFuYWdlci52YWxpZGF0ZUludml0ZSgnaW52YWxpZC1jb2RlJyk7XG5cbiAgICAgIGV4cGVjdCh2YWxpZGF0aW9uLnZhbGlkKS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdCh2YWxpZGF0aW9uLmVycm9yKS50b0JlKCdJbnZhbGlkIGludml0ZSBjb2RlJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCBleHBpcmVkIGludml0ZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSh7IHR0bDogLTEwMDAgfSk7IC8vIEV4cGlyZWRcbiAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLnZhbGlkYXRlSW52aXRlKGludml0ZS5jb2RlKTtcblxuICAgICAgZXhwZWN0KHZhbGlkYXRpb24udmFsaWQpLnRvQmUoZmFsc2UpO1xuICAgICAgZXhwZWN0KHZhbGlkYXRpb24uZXJyb3IpLnRvQmUoJ0ludml0ZSBleHBpcmVkJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCBpbnZpdGVzIHdpdGggaW52YWxpZCBzaWduYXR1cmVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIC8vIFRhbXBlciB3aXRoIHRoZSBzaWduYXR1cmVcbiAgICAgIGludml0ZS5zaWduYXR1cmUgPSBuZXcgVWludDhBcnJheSg2NCk7XG4gICAgICBcbiAgICAgIC8vIE1hbnVhbGx5IHVwZGF0ZSB0aGUgc3RvcmVkIGludml0ZSAoc2ltdWxhdGluZyB0YW1wZXJpbmcpXG4gICAgICBjb25zdCBhbGxJbnZpdGVzID0gaW52aXRlTWFuYWdlci5nZXRBbGxJbnZpdGVzKCk7XG4gICAgICBjb25zdCBpbnZpdGVJbmRleCA9IGFsbEludml0ZXMuZmluZEluZGV4KGkgPT4gaS5jb2RlID09PSBpbnZpdGUuY29kZSk7XG4gICAgICBpZiAoaW52aXRlSW5kZXggIT09IC0xKSB7XG4gICAgICAgIC8vIFJlLWNyZWF0ZSBtYW5hZ2VyIHRvIHRlc3Qgd2l0aCB0YW1wZXJlZCBkYXRhXG4gICAgICAgIGNvbnN0IHRhbXBlcmVkTWFuYWdlciA9IG5ldyBJbnZpdGVNYW5hZ2VyKFxuICAgICAgICAgICd0ZXN0LXBlZXItaWQnLFxuICAgICAgICAgIGlkZW50aXR5LnB1YmxpY0tleSxcbiAgICAgICAgICBpZGVudGl0eS5wcml2YXRlS2V5XG4gICAgICAgICk7XG4gICAgICAgIC8vIE1hbnVhbGx5IHNldCB0aGUgaW52aXRlIHdpdGggdGFtcGVyZWQgc2lnbmF0dXJlXG4gICAgICAgIGF3YWl0IHRhbXBlcmVkTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgICAgY29uc3QgaW52aXRlcyA9ICh0YW1wZXJlZE1hbmFnZXIgYXMgYW55KS5pbnZpdGVzIGFzIE1hcDxzdHJpbmcsIGFueT47XG4gICAgICAgIGNvbnN0IHN0b3JlZEludml0ZSA9IGludml0ZXMuZ2V0KFsuLi5pbnZpdGVzLmtleXMoKV1bMF0pO1xuICAgICAgICBzdG9yZWRJbnZpdGUuc2lnbmF0dXJlID0gbmV3IFVpbnQ4QXJyYXkoNjQpO1xuXG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSBhd2FpdCB0YW1wZXJlZE1hbmFnZXIudmFsaWRhdGVJbnZpdGUoc3RvcmVkSW52aXRlLmNvZGUpO1xuICAgICAgICBleHBlY3QodmFsaWRhdGlvbi52YWxpZCkudG9CZShmYWxzZSk7XG4gICAgICAgIGV4cGVjdCh2YWxpZGF0aW9uLmVycm9yKS50b0JlKCdJbnZhbGlkIHNpZ25hdHVyZScpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnSW52aXRlIFJlZGVtcHRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzdWNjZXNzZnVsbHkgcmVkZWVtIGEgdmFsaWQgaW52aXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGludml0ZU1hbmFnZXIucmVkZWVtSW52aXRlKGludml0ZS5jb2RlLCAncmVjaXBpZW50LXBlZXItaWQnKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5jb250YWN0LnBlZXJJZCkudG9CZShpbnZpdGUuaW52aXRlclBlZXJJZCk7XG4gICAgICBleHBlY3QocmVzdWx0LmNvbnRhY3QucHVibGljS2V5KS50b0VxdWFsKGludml0ZS5pbnZpdGVyUHVibGljS2V5KTtcbiAgICAgIGV4cGVjdChyZXN1bHQuY29udGFjdC52ZXJpZmllZCkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuY29udGFjdC5hZGRlZFZpYSkudG9CZSgnaW52aXRlJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlbW92ZSBpbnZpdGUgYWZ0ZXIgcmVkZW1wdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBhd2FpdCBpbnZpdGVNYW5hZ2VyLnJlZGVlbUludml0ZShpbnZpdGUuY29kZSwgJ3JlY2lwaWVudC1wZWVyLWlkJyk7XG5cbiAgICAgIGNvbnN0IHJldHJpZXZlZCA9IGludml0ZU1hbmFnZXIuZ2V0SW52aXRlKGludml0ZS5jb2RlKTtcbiAgICAgIGV4cGVjdChyZXRyaWV2ZWQpLnRvQmVVbmRlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3IgZm9yIGludmFsaWQgaW52aXRlIGNvZGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGludml0ZU1hbmFnZXIucmVkZWVtSW52aXRlKCdpbnZhbGlkLWNvZGUnLCAncmVjaXBpZW50LXBlZXItaWQnKVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coJ0ludmFsaWQgaW52aXRlIGNvZGUnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3IgZm9yIGV4cGlyZWQgaW52aXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoeyB0dGw6IC0xMDAwIH0pO1xuICAgICAgXG4gICAgICBhd2FpdCBleHBlY3QoXG4gICAgICAgIGludml0ZU1hbmFnZXIucmVkZWVtSW52aXRlKGludml0ZS5jb2RlLCAncmVjaXBpZW50LXBlZXItaWQnKVxuICAgICAgKS5yZWplY3RzLnRvVGhyb3coJ0ludml0ZSBleHBpcmVkJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGluY2x1ZGUgaW52aXRlciBuYW1lIGluIGNvbnRhY3QnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaW52aXRlTWFuYWdlci5yZWRlZW1JbnZpdGUoaW52aXRlLmNvZGUsICdyZWNpcGllbnQtcGVlci1pZCcpO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmNvbnRhY3QubmFtZSkudG9CZSgnVGVzdCBVc2VyJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdJbnZpdGUgTWFuYWdlbWVudCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGdldCBhbGwgcGVuZGluZyBpbnZpdGVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuXG4gICAgICBjb25zdCBpbnZpdGVzID0gaW52aXRlTWFuYWdlci5nZXRBbGxJbnZpdGVzKCk7XG4gICAgICBleHBlY3QoaW52aXRlcykudG9IYXZlTGVuZ3RoKDMpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjbGVhbiB1cCBleHBpcmVkIGludml0ZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDcmVhdGUgc29tZSBpbnZpdGVzIHdpdGggZGlmZmVyZW50IGV4cGlyYXRpb24gdGltZXNcbiAgICAgIGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKHsgdHRsOiAtMTAwMCB9KTsgLy8gRXhwaXJlZFxuICAgICAgYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoeyB0dGw6IC0xMDAwIH0pOyAvLyBFeHBpcmVkXG4gICAgICBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSh7IHR0bDogNjAwMDAgfSk7IC8vIFZhbGlkXG5cbiAgICAgIGNvbnN0IHJlbW92ZWRDb3VudCA9IGludml0ZU1hbmFnZXIuY2xlYW51cEV4cGlyZWRJbnZpdGVzKCk7XG5cbiAgICAgIGV4cGVjdChyZW1vdmVkQ291bnQpLnRvQmUoMik7XG4gICAgICBleHBlY3QoaW52aXRlTWFuYWdlci5nZXRQZW5kaW5nSW52aXRlQ291bnQoKSkudG9CZSgxKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV2b2tlIGEgc3BlY2lmaWMgaW52aXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGludml0ZU1hbmFnZXIucmV2b2tlSW52aXRlKGludml0ZS5jb2RlKTtcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChpbnZpdGVNYW5hZ2VyLmdldEludml0ZShpbnZpdGUuY29kZSkpLnRvQmVVbmRlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIHdoZW4gcmV2b2tpbmcgbm9uLWV4aXN0ZW50IGludml0ZScsICgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGludml0ZU1hbmFnZXIucmV2b2tlSW52aXRlKCdub24tZXhpc3RlbnQnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXZva2UgYWxsIGludml0ZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBpbnZpdGVNYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG5cbiAgICAgIGNvbnN0IHJldm9rZWRDb3VudCA9IGludml0ZU1hbmFnZXIucmV2b2tlQWxsSW52aXRlcygpO1xuXG4gICAgICBleHBlY3QocmV2b2tlZENvdW50KS50b0JlKDMpO1xuICAgICAgZXhwZWN0KGludml0ZU1hbmFnZXIuZ2V0UGVuZGluZ0ludml0ZUNvdW50KCkpLnRvQmUoMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRyYWNrIHBlbmRpbmcgaW52aXRlIGNvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgZXhwZWN0KGludml0ZU1hbmFnZXIuZ2V0UGVuZGluZ0ludml0ZUNvdW50KCkpLnRvQmUoMCk7XG5cbiAgICAgIGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKCk7XG4gICAgICBleHBlY3QoaW52aXRlTWFuYWdlci5nZXRQZW5kaW5nSW52aXRlQ291bnQoKSkudG9CZSgxKTtcblxuICAgICAgYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoKTtcbiAgICAgIGV4cGVjdChpbnZpdGVNYW5hZ2VyLmdldFBlbmRpbmdJbnZpdGVDb3VudCgpKS50b0JlKDIpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRWRnZSBDYXNlcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtYW5hZ2VyIHdpdGhvdXQgZGlzcGxheSBuYW1lJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbWFuYWdlciA9IG5ldyBJbnZpdGVNYW5hZ2VyKFxuICAgICAgICAndGVzdC1wZWVyLWlkJyxcbiAgICAgICAgaWRlbnRpdHkucHVibGljS2V5LFxuICAgICAgICBpZGVudGl0eS5wcml2YXRlS2V5XG4gICAgICApO1xuXG4gICAgICBjb25zdCBpbnZpdGUgPSBhd2FpdCBtYW5hZ2VyLmNyZWF0ZUludml0ZSgpO1xuICAgICAgZXhwZWN0KGludml0ZS5pbnZpdGVyTmFtZSkudG9CZSgnVXNlcicpOyAvLyBEZWZhdWx0IG5hbWUgd2hlbiBub25lIHByb3ZpZGVkXG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSB6ZXJvIFRUTCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGludml0ZSA9IGF3YWl0IGludml0ZU1hbmFnZXIuY3JlYXRlSW52aXRlKHsgdHRsOiAtMTAwIH0pO1xuICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IGF3YWl0IGludml0ZU1hbmFnZXIudmFsaWRhdGVJbnZpdGUoaW52aXRlLmNvZGUpO1xuXG4gICAgICBleHBlY3QodmFsaWRhdGlvbi52YWxpZCkudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QodmFsaWRhdGlvbi5lcnJvcikudG9CZSgnSW52aXRlIGV4cGlyZWQnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHZlcnkgbG9uZyBUVEwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB2ZXJ5TG9uZ1RUTCA9IDM2NSAqIDI0ICogNjAgKiA2MCAqIDEwMDA7IC8vIDEgeWVhclxuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoeyB0dGw6IHZlcnlMb25nVFRMIH0pO1xuXG4gICAgICBleHBlY3QoaW52aXRlLmV4cGlyZXNBdCAtIGludml0ZS5jcmVhdGVkQXQpLnRvQmUodmVyeUxvbmdUVEwpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBub3QgbXV0YXRlIG9yaWdpbmFsIG1ldGFkYXRhJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbWV0YWRhdGEgPSB7IGtleTogJ3ZhbHVlJyB9O1xuICAgICAgY29uc3QgaW52aXRlID0gYXdhaXQgaW52aXRlTWFuYWdlci5jcmVhdGVJbnZpdGUoeyBtZXRhZGF0YSB9KTtcblxuICAgICAgbWV0YWRhdGEua2V5ID0gJ2NoYW5nZWQnO1xuICAgICAgZXhwZWN0KGludml0ZS5tZXRhZGF0YT8ua2V5KS50b0JlKCd2YWx1ZScpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9