7e5196ce6a2a7a97aa20d660f879c23b
"use strict";
/**
 * Enhanced Reachability Verification
 * Task 56: Implement comprehensive peer reachability testing
 *
 * Features:
 * - Ping/pong protocol
 * - Latency measurement
 * - Reachability caching
 * - Event notifications
 * - Multi-method testing
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ReachabilityVerifier = void 0;
exports.testPeerReachability = testPeerReachability;
const DEFAULT_OPTIONS = {
    timeout: 5000, // 5 seconds
    maxAttempts: 3,
    methods: ['direct', 'webrtc', 'relay'],
    cacheTimeout: 60000, // 1 minute
};
class ReachabilityVerifier {
    constructor(options = {}) {
        this.cache = new Map();
        this.pendingPings = new Map();
        this.listeners = new Map();
        this.options = { ...DEFAULT_OPTIONS, ...options };
    }
    /**
     * Test peer reachability
     */
    async testReachability(peerId, onSendPing) {
        // Check cache first
        const cached = this.getCached(peerId);
        if (cached && this.isCacheValid(cached)) {
            return cached;
        }
        // Try each method until one succeeds
        let lastError;
        for (const method of this.options.methods) {
            try {
                const result = await this.testWithMethod(peerId, method, onSendPing);
                if (result.reachable) {
                    // Cache successful result
                    this.cache.set(peerId, result);
                    this.emit('reachable', result);
                    return result;
                }
                lastError = result.error;
            }
            catch (error) {
                lastError = error instanceof Error ? error.message : 'Unknown error';
            }
        }
        // All methods failed
        const failedResult = {
            peerId,
            reachable: false,
            timestamp: Date.now(),
            attempts: this.options.methods.length * this.options.maxAttempts,
            error: lastError,
        };
        this.cache.set(peerId, failedResult);
        this.emit('unreachable', failedResult);
        return failedResult;
    }
    /**
     * Test reachability with specific method
     */
    async testWithMethod(peerId, method, onSendPing) {
        let attempts = 0;
        let lastError;
        while (attempts < this.options.maxAttempts) {
            attempts++;
            try {
                const ping = {
                    type: 'ping',
                    id: this.generatePingId(),
                    timestamp: Date.now(),
                    method,
                };
                // Send ping
                const sendTime = Date.now();
                await onSendPing(peerId, ping);
                // Wait for pong
                const _pong = await this.waitForPong(ping.id, this.options.timeout);
                const receiveTime = Date.now();
                // Calculate latency
                const latency = receiveTime - sendTime;
                return {
                    peerId,
                    reachable: true,
                    latency,
                    method,
                    timestamp: Date.now(),
                    attempts,
                };
            }
            catch (error) {
                lastError = error instanceof Error ? error.message : 'Ping timeout';
                // Exponential backoff before retry
                if (attempts < this.options.maxAttempts) {
                    await this.delay(Math.min(1000 * attempts, 5000));
                }
            }
        }
        return {
            peerId,
            reachable: false,
            method,
            timestamp: Date.now(),
            attempts,
            error: lastError,
        };
    }
    /**
     * Handle incoming pong message
     */
    handlePong(pong) {
        const pending = this.pendingPings.get(pong.id);
        if (!pending) {
            // Unsolicited pong or already handled
            return;
        }
        clearTimeout(pending.timeout);
        this.pendingPings.delete(pong.id);
        // Resolve the waiting promise
        pending.resolve(pong);
    }
    /**
     * Wait for pong response
     */
    waitForPong(pingId, timeout) {
        return new Promise((resolve, reject) => {
            const timeoutHandle = setTimeout(() => {
                this.pendingPings.delete(pingId);
                reject(new Error('Ping timeout'));
            }, timeout);
            this.unrefTimeout(timeoutHandle);
            this.pendingPings.set(pingId, {
                resolve: (result) => {
                    // This is called from handlePong
                    resolve(result);
                },
                reject,
                timestamp: Date.now(),
                timeout: timeoutHandle,
            });
        });
    }
    /**
     * Create pong response
     */
    createPong(ping) {
        return {
            type: 'pong',
            id: ping.id,
            pingTimestamp: ping.timestamp,
            pongTimestamp: Date.now(),
        };
    }
    /**
     * Get cached reachability result
     */
    getCached(peerId) {
        const cached = this.cache.get(peerId);
        if (!cached) {
            return null;
        }
        if (!this.isCacheValid(cached)) {
            this.cache.delete(peerId);
            return null;
        }
        return cached;
    }
    /**
     * Check if cached result is still valid
     */
    isCacheValid(result) {
        const age = Date.now() - result.timestamp;
        return age < this.options.cacheTimeout;
    }
    /**
     * Get reachability status
     */
    getStatus(peerId) {
        const cached = this.getCached(peerId);
        if (!cached) {
            return 'unknown';
        }
        return cached.reachable ? 'reachable' : 'unreachable';
    }
    /**
     * Clear cache for peer
     */
    clearCache(peerId) {
        this.cache.delete(peerId);
    }
    /**
     * Clear all cached results
     */
    clearAllCache() {
        this.cache.clear();
    }
    /**
     * Get all cached results
     */
    getAllCached() {
        // Filter out expired entries
        for (const [peerId, result] of this.cache.entries()) {
            if (!this.isCacheValid(result)) {
                this.cache.delete(peerId);
            }
        }
        return new Map(this.cache);
    }
    /**
     * Measure latency to peer
     */
    async measureLatency(peerId, onSendPing, samples = 5) {
        const latencies = [];
        for (let i = 0; i < samples; i++) {
            const result = await this.testReachability(peerId, onSendPing);
            if (result.reachable && result.latency !== undefined) {
                latencies.push(result.latency);
            }
            // Small delay between pings
            if (i < samples - 1) {
                await this.delay(100);
            }
        }
        return latencies;
    }
    /**
     * Get average latency
     */
    static getAverageLatency(latencies) {
        if (latencies.length === 0)
            return 0;
        return latencies.reduce((sum, val) => sum + val, 0) / latencies.length;
    }
    /**
     * Get median latency (more robust than average)
     */
    static getMedianLatency(latencies) {
        if (latencies.length === 0)
            return 0;
        const sorted = [...latencies].sort((a, b) => a - b);
        const mid = Math.floor(sorted.length / 2);
        if (sorted.length % 2 === 0) {
            return (sorted[mid - 1] + sorted[mid]) / 2;
        }
        return sorted[mid];
    }
    /**
     * Get latency statistics
     */
    static getLatencyStats(latencies) {
        if (latencies.length === 0) {
            return { min: 0, max: 0, avg: 0, median: 0, jitter: 0 };
        }
        const min = Math.min(...latencies);
        const max = Math.max(...latencies);
        const avg = this.getAverageLatency(latencies);
        const median = this.getMedianLatency(latencies);
        // Calculate jitter (standard deviation)
        const variance = latencies.reduce((sum, val) => {
            return sum + Math.pow(val - avg, 2);
        }, 0) / latencies.length;
        const jitter = Math.sqrt(variance);
        return { min, max, avg, median, jitter };
    }
    /**
     * Register event listener
     */
    on(event, callback) {
        if (!this.listeners.has(event)) {
            this.listeners.set(event, new Set());
        }
        this.listeners.get(event).add(callback);
    }
    /**
     * Unregister event listener
     */
    off(event, callback) {
        const handlers = this.listeners.get(event);
        if (handlers) {
            handlers.delete(callback);
        }
    }
    /**
     * Emit event
     */
    emit(event, data) {
        const handlers = this.listeners.get(event);
        if (handlers) {
            handlers.forEach(handler => handler(data));
        }
    }
    /**
     * Generate unique ping ID
     */
    generatePingId() {
        return `ping-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
    }
    /**
     * Delay helper
     */
    delay(ms) {
        return new Promise(resolve => {
            // Used for simple backoff; no cancellation/rejection path is needed
            const handle = setTimeout(resolve, ms);
            this.unrefTimeout(handle);
        });
    }
    /**
     * Ensure timers don't keep the event loop alive in Node environments
     */
    unrefTimeout(handle) {
        // In browser runtimes this is a no-op; Node supports unref to avoid holding the event loop
        if (this.isUnrefable(handle)) {
            handle.unref();
        }
    }
    isUnrefable(handle) {
        if (!handle || typeof handle !== 'object') {
            return false;
        }
        const maybe = handle;
        return typeof maybe.unref === 'function';
    }
    /**
     * Cleanup resources
     */
    cleanup() {
        // Clear all pending pings
        for (const [_id, pending] of this.pendingPings.entries()) {
            clearTimeout(pending.timeout);
            pending.reject(new Error('Verifier cleanup'));
        }
        this.pendingPings.clear();
        this.cache.clear();
        this.listeners.clear();
    }
}
exports.ReachabilityVerifier = ReachabilityVerifier;
/**
 * Utility function to test reachability with default settings
 */
async function testPeerReachability(peerId, onSendPing) {
    const verifier = new ReachabilityVerifier();
    try {
        return await verifier.testReachability(peerId, onSendPing);
    }
    finally {
        verifier.cleanup();
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvZGlzY292ZXJ5L3JlYWNoYWJpbGl0eS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7R0FVRzs7O0FBcWNILG9EQVVDO0FBNWFELE1BQU0sZUFBZSxHQUF3QjtJQUMzQyxPQUFPLEVBQUUsSUFBSSxFQUFZLFlBQVk7SUFDckMsV0FBVyxFQUFFLENBQUM7SUFDZCxPQUFPLEVBQUUsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQztJQUN0QyxZQUFZLEVBQUUsS0FBSyxFQUFNLFdBQVc7Q0FDckMsQ0FBQztBQU1GLE1BQWEsb0JBQW9CO0lBVy9CLFlBQVksVUFBd0MsRUFBRTtRQVQ5QyxVQUFLLEdBQUcsSUFBSSxHQUFHLEVBQThCLENBQUM7UUFDOUMsaUJBQVksR0FBRyxJQUFJLEdBQUcsRUFLMUIsQ0FBQztRQUNHLGNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBd0MsQ0FBQztRQUdsRSxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsR0FBRyxlQUFlLEVBQUUsR0FBRyxPQUFPLEVBQUUsQ0FBQztJQUNwRCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsZ0JBQWdCLENBQ3BCLE1BQWMsRUFDZCxVQUFnRTtRQUVoRSxvQkFBb0I7UUFDcEIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN0QyxJQUFJLE1BQU0sSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDeEMsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQztRQUVELHFDQUFxQztRQUNyQyxJQUFJLFNBQTZCLENBQUM7UUFFbEMsS0FBSyxNQUFNLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzFDLElBQUksQ0FBQztnQkFDSCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxj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SyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN6QixDQUFDO0NBQ0Y7QUFsWkQsb0RBa1pDO0FBRUQ7O0dBRUc7QUFDSSxLQUFLLFVBQVUsb0JBQW9CLENBQ3hDLE1BQWMsRUFDZCxVQUFnRTtJQUVoRSxNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFvQixFQUFFLENBQUM7SUFDNUMsSUFBSSxDQUFDO1FBQ0gsT0FBTyxNQUFNLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDN0QsQ0FBQztZQUFTLENBQUM7UUFDVCxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDckIsQ0FBQztBQUNILENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2NocmlzdHltYXh3ZWxsL0Rlc2t0b3AvTHVrZV9TdHVmZi9HaXRIdWIvU0MvY29yZS9zcmMvZGlzY292ZXJ5L3JlYWNoYWJpbGl0eS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEVuaGFuY2VkIFJlYWNoYWJpbGl0eSBWZXJpZmljYXRpb25cbiAqIFRhc2sgNTY6IEltcGxlbWVudCBjb21wcmVoZW5zaXZlIHBlZXIgcmVhY2hhYmlsaXR5IHRlc3RpbmdcbiAqIFxuICogRmVhdHVyZXM6XG4gKiAtIFBpbmcvcG9uZyBwcm90b2NvbFxuICogLSBMYXRlbmN5IG1lYXN1cmVtZW50XG4gKiAtIFJlYWNoYWJpbGl0eSBjYWNoaW5nXG4gKiAtIEV2ZW50IG5vdGlmaWNhdGlvbnNcbiAqIC0gTXVsdGktbWV0aG9kIHRlc3RpbmdcbiAqL1xuXG5leHBvcnQgaW50ZXJmYWNlIFBpbmdNZXNzYWdlIHtcbiAgdHlwZTogJ3BpbmcnO1xuICBpZDogc3RyaW5nOyAgICAgICAgICAgICAgLy8gVW5pcXVlIHBpbmcgSURcbiAgdGltZXN0YW1wOiBudW1iZXI7ICAgICAgIC8vIFNlbmQgdGltZXN0YW1wXG4gIG1ldGhvZDogUmVhY2hhYmlsaXR5TWV0aG9kO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBvbmdNZXNzYWdlIHtcbiAgdHlwZTogJ3BvbmcnO1xuICBpZDogc3RyaW5nOyAgICAgICAgICAgICAgLy8gU2FtZSBJRCBhcyBwaW5nXG4gIHBpbmdUaW1lc3RhbXA6IG51bWJlcjsgICAvLyBPcmlnaW5hbCBwaW5nIHRpbWVzdGFtcFxuICBwb25nVGltZXN0YW1wOiBudW1iZXI7ICAgLy8gUG9uZyBzZW5kIHRpbWVzdGFtcFxufVxuXG5leHBvcnQgdHlwZSBSZWFjaGFiaWxpdHlNZXRob2QgPSAnZGlyZWN0JyB8ICd3ZWJydGMnIHwgJ3JlbGF5JyB8ICdibGUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlYWNoYWJpbGl0eVJlc3VsdCB7XG4gIHBlZXJJZDogc3RyaW5nO1xuICByZWFjaGFibGU6IGJvb2xlYW47XG4gIGxhdGVuY3k/OiBudW1iZXI7ICAgICAgICAvLyBSb3VuZC10cmlwIHRpbWUgaW4gbXNcbiAgbWV0aG9kPzogUmVhY2hhYmlsaXR5TWV0aG9kO1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbiAgYXR0ZW1wdHM6IG51bWJlcjtcbiAgZXJyb3I/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVhY2hhYmlsaXR5T3B0aW9ucyB7XG4gIHRpbWVvdXQ6IG51bWJlcjsgICAgICAgICAvLyBUaW1lb3V0IHBlciBhdHRlbXB0IChtcylcbiAgbWF4QXR0ZW1wdHM6IG51bWJlcjsgICAgIC8vIE1heCByZXRyeSBhdHRlbXB0c1xuICBtZXRob2RzOiBSZWFjaGFiaWxpdHlNZXRob2RbXTsgIC8vIE1ldGhvZHMgdG8gdHJ5XG4gIGNhY2hlVGltZW91dDogbnVtYmVyOyAgICAvLyBDYWNoZSB2YWxpZGl0eSAobXMpXG59XG5cbmNvbnN0IERFRkFVTFRfT1BUSU9OUzogUmVhY2hhYmlsaXR5T3B0aW9ucyA9IHtcbiAgdGltZW91dDogNTAwMCwgICAgICAgICAgIC8vIDUgc2Vjb25kc1xuICBtYXhBdHRlbXB0czogMyxcbiAgbWV0aG9kczogWydkaXJlY3QnLCAnd2VicnRjJywgJ3JlbGF5J10sXG4gIGNhY2hlVGltZW91dDogNjAwMDAsICAgICAvLyAxIG1pbnV0ZVxufTtcblxuaW50ZXJmYWNlIFVucmVmYWJsZSB7XG4gIHVucmVmOiAoKSA9PiB2b2lkO1xufVxuXG5leHBvcnQgY2xhc3MgUmVhY2hhYmlsaXR5VmVyaWZpZXIge1xuICBwcml2YXRlIG9wdGlvbnM6IFJlYWNoYWJpbGl0eU9wdGlvbnM7XG4gIHByaXZhdGUgY2FjaGUgPSBuZXcgTWFwPHN0cmluZywgUmVhY2hhYmlsaXR5UmVzdWx0PigpO1xuICBwcml2YXRlIHBlbmRpbmdQaW5ncyA9IG5ldyBNYXA8c3RyaW5nLCB7XG4gICAgcmVzb2x2ZTogKHJlc3VsdDogUmVhY2hhYmlsaXR5UmVzdWx0KSA9PiB2b2lkO1xuICAgIHJlamVjdDogKGVycm9yOiBFcnJvcikgPT4gdm9pZDtcbiAgICB0aW1lc3RhbXA6IG51bWJlcjtcbiAgICB0aW1lb3V0OiBOb2RlSlMuVGltZW91dDtcbiAgfT4oKTtcbiAgcHJpdmF0ZSBsaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgU2V0PCguLi5hcmdzOiBhbnlbXSkgPT4gYW55Pj4oKTtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBQYXJ0aWFsPFJlYWNoYWJpbGl0eU9wdGlvbnM+ID0ge30pIHtcbiAgICB0aGlzLm9wdGlvbnMgPSB7IC4uLkRFRkFVTFRfT1BUSU9OUywgLi4ub3B0aW9ucyB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFRlc3QgcGVlciByZWFjaGFiaWxpdHlcbiAgICovXG4gIGFzeW5jIHRlc3RSZWFjaGFiaWxpdHkoXG4gICAgcGVlcklkOiBzdHJpbmcsXG4gICAgb25TZW5kUGluZzogKHBlZXJJZDogc3RyaW5nLCBwaW5nOiBQaW5nTWVzc2FnZSkgPT4gUHJvbWlzZTx2b2lkPlxuICApOiBQcm9taXNlPFJlYWNoYWJpbGl0eVJlc3VsdD4ge1xuICAgIC8vIENoZWNrIGNhY2hlIGZpcnN0XG4gICAgY29uc3QgY2FjaGVkID0gdGhpcy5nZXRDYWNoZWQocGVlcklkKTtcbiAgICBpZiAoY2FjaGVkICYmIHRoaXMuaXNDYWNoZVZhbGlkKGNhY2hlZCkpIHtcbiAgICAgIHJldHVybiBjYWNoZWQ7XG4gICAgfVxuXG4gICAgLy8gVHJ5IGVhY2ggbWV0aG9kIHVudGlsIG9uZSBzdWNjZWVkc1xuICAgIGxldCBsYXN0RXJyb3I6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBcbiAgICBmb3IgKGNvbnN0IG1ldGhvZCBvZiB0aGlzLm9wdGlvbnMubWV0aG9kcykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy50ZXN0V2l0aE1ldGhvZChwZWVySWQsIG1ldGhvZCwgb25TZW5kUGluZyk7XG4gICAgICAgIFxuICAgICAgICBpZiAocmVzdWx0LnJlYWNoYWJsZSkge1xuICAgICAgICAgIC8vIENhY2hlIHN1Y2Nlc3NmdWwgcmVzdWx0XG4gICAgICAgICAgdGhpcy5jYWNoZS5zZXQocGVlcklkLCByZXN1bHQpO1xuICAgICAgICAgIHRoaXMuZW1pdCgncmVhY2hhYmxlJywgcmVzdWx0KTtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBsYXN0RXJyb3IgPSByZXN1bHQuZXJyb3I7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsYXN0RXJyb3IgPSBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBbGwgbWV0aG9kcyBmYWlsZWRcbiAgICBjb25zdCBmYWlsZWRSZXN1bHQ6IFJlYWNoYWJpbGl0eVJlc3VsdCA9IHtcbiAgICAgIHBlZXJJZCxcbiAgICAgIHJlYWNoYWJsZTogZmFsc2UsXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICBhdHRlbXB0czogdGhpcy5vcHRpb25zLm1ldGhvZHMubGVuZ3RoICogdGhpcy5vcHRpb25zLm1heEF0dGVtcHRzLFxuICAgICAgZXJyb3I6IGxhc3RFcnJvcixcbiAgICB9O1xuXG4gICAgdGhpcy5jYWNoZS5zZXQocGVlcklkLCBmYWlsZWRSZXN1bHQpO1xuICAgIHRoaXMuZW1pdCgndW5yZWFjaGFibGUnLCBmYWlsZWRSZXN1bHQpO1xuICAgIFxuICAgIHJldHVybiBmYWlsZWRSZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICogVGVzdCByZWFjaGFiaWxpdHkgd2l0aCBzcGVjaWZpYyBtZXRob2RcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgdGVzdFdpdGhNZXRob2QoXG4gICAgcGVlcklkOiBzdHJpbmcsXG4gICAgbWV0aG9kOiBSZWFjaGFiaWxpdHlNZXRob2QsXG4gICAgb25TZW5kUGluZzogKHBlZXJJZDogc3RyaW5nLCBwaW5nOiBQaW5nTWVzc2FnZSkgPT4gUHJvbWlzZTx2b2lkPlxuICApOiBQcm9taXNlPFJlYWNoYWJpbGl0eVJlc3VsdD4ge1xuICAgIGxldCBhdHRlbXB0cyA9IDA7XG4gICAgbGV0IGxhc3RFcnJvcjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgd2hpbGUgKGF0dGVtcHRzIDwgdGhpcy5vcHRpb25zLm1heEF0dGVtcHRzKSB7XG4gICAgICBhdHRlbXB0cysrO1xuXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwaW5nOiBQaW5nTWVzc2FnZSA9IHtcbiAgICAgICAgICB0eXBlOiAncGluZycsXG4gICAgICAgICAgaWQ6IHRoaXMuZ2VuZXJhdGVQaW5nSWQoKSxcbiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgbWV0aG9kLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIFNlbmQgcGluZ1xuICAgICAgICBjb25zdCBzZW5kVGltZSA9IERhdGUubm93KCk7XG4gICAgICAgIGF3YWl0IG9uU2VuZFBpbmcocGVlcklkLCBwaW5nKTtcblxuICAgICAgICAvLyBXYWl0IGZvciBwb25nXG4gICAgICAgIGNvbnN0IF9wb25nID0gYXdhaXQgdGhpcy53YWl0Rm9yUG9uZyhwaW5nLmlkLCB0aGlzLm9wdGlvbnMudGltZW91dCk7XG4gICAgICAgIGNvbnN0IHJlY2VpdmVUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgICAgICAvLyBDYWxjdWxhdGUgbGF0ZW5jeVxuICAgICAgICBjb25zdCBsYXRlbmN5ID0gcmVjZWl2ZVRpbWUgLSBzZW5kVGltZTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHBlZXJJZCxcbiAgICAgICAgICByZWFjaGFibGU6IHRydWUsXG4gICAgICAgICAgbGF0ZW5jeSxcbiAgICAgICAgICBtZXRob2QsXG4gICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICAgIGF0dGVtcHRzLFxuICAgICAgICB9O1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbGFzdEVycm9yID0gZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnUGluZyB0aW1lb3V0JztcbiAgICAgICAgXG4gICAgICAgIC8vIEV4cG9uZW50aWFsIGJhY2tvZmYgYmVmb3JlIHJldHJ5XG4gICAgICAgIGlmIChhdHRlbXB0cyA8IHRoaXMub3B0aW9ucy5tYXhBdHRlbXB0cykge1xuICAgICAgICAgIGF3YWl0IHRoaXMuZGVsYXkoTWF0aC5taW4oMTAwMCAqIGF0dGVtcHRzLCA1MDAwKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgcGVlcklkLFxuICAgICAgcmVhY2hhYmxlOiBmYWxzZSxcbiAgICAgIG1ldGhvZCxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIGF0dGVtcHRzLFxuICAgICAgZXJyb3I6IGxhc3RFcnJvcixcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBpbmNvbWluZyBwb25nIG1lc3NhZ2VcbiAgICovXG4gIGhhbmRsZVBvbmcocG9uZzogUG9uZ01lc3NhZ2UpOiB2b2lkIHtcbiAgICBjb25zdCBwZW5kaW5nID0gdGhpcy5wZW5kaW5nUGluZ3MuZ2V0KHBvbmcuaWQpO1xuICAgIFxuICAgIGlmICghcGVuZGluZykge1xuICAgICAgLy8gVW5zb2xpY2l0ZWQgcG9uZyBvciBhbHJlYWR5IGhhbmRsZWRcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjbGVhclRpbWVvdXQocGVuZGluZy50aW1lb3V0KTtcbiAgICB0aGlzLnBlbmRpbmdQaW5ncy5kZWxldGUocG9uZy5pZCk7XG4gICAgXG4gICAgLy8gUmVzb2x2ZSB0aGUgd2FpdGluZyBwcm9taXNlXG4gICAgcGVuZGluZy5yZXNvbHZlKHBvbmcgYXMgYW55KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXYWl0IGZvciBwb25nIHJlc3BvbnNlXG4gICAqL1xuICBwcml2YXRlIHdhaXRGb3JQb25nKHBpbmdJZDogc3RyaW5nLCB0aW1lb3V0OiBudW1iZXIpOiBQcm9taXNlPFBvbmdNZXNzYWdlPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IHRpbWVvdXRIYW5kbGUgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5wZW5kaW5nUGluZ3MuZGVsZXRlKHBpbmdJZCk7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ1BpbmcgdGltZW91dCcpKTtcbiAgICAgIH0sIHRpbWVvdXQpO1xuICAgICAgdGhpcy51bnJlZlRpbWVvdXQodGltZW91dEhhbmRsZSk7XG5cbiAgICAgIHRoaXMucGVuZGluZ1BpbmdzLnNldChwaW5nSWQsIHtcbiAgICAgICAgcmVzb2x2ZTogKHJlc3VsdCkgPT4ge1xuICAgICAgICAgIC8vIFRoaXMgaXMgY2FsbGVkIGZyb20gaGFuZGxlUG9uZ1xuICAgICAgICAgIHJlc29sdmUocmVzdWx0IGFzIGFueSk7XG4gICAgICAgIH0sXG4gICAgICAgIHJlamVjdCxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICB0aW1lb3V0OiB0aW1lb3V0SGFuZGxlLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIHBvbmcgcmVzcG9uc2VcbiAgICovXG4gIGNyZWF0ZVBvbmcocGluZzogUGluZ01lc3NhZ2UpOiBQb25nTWVzc2FnZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6ICdwb25nJyxcbiAgICAgIGlkOiBwaW5nLmlkLFxuICAgICAgcGluZ1RpbWVzdGFtcDogcGluZy50aW1lc3RhbXAsXG4gICAgICBwb25nVGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNhY2hlZCByZWFjaGFiaWxpdHkgcmVzdWx0XG4gICAqL1xuICBnZXRDYWNoZWQocGVlcklkOiBzdHJpbmcpOiBSZWFjaGFiaWxpdHlSZXN1bHQgfCBudWxsIHtcbiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmNhY2hlLmdldChwZWVySWQpO1xuICAgIFxuICAgIGlmICghY2FjaGVkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaXNDYWNoZVZhbGlkKGNhY2hlZCkpIHtcbiAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKHBlZXJJZCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gY2FjaGVkO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGNhY2hlZCByZXN1bHQgaXMgc3RpbGwgdmFsaWRcbiAgICovXG4gIHByaXZhdGUgaXNDYWNoZVZhbGlkKHJlc3VsdDogUmVhY2hhYmlsaXR5UmVzdWx0KTogYm9vbGVhbiB7XG4gICAgY29uc3QgYWdlID0gRGF0ZS5ub3coKSAtIHJlc3VsdC50aW1lc3RhbXA7XG4gICAgcmV0dXJuIGFnZSA8IHRoaXMub3B0aW9ucy5jYWNoZVRpbWVvdXQ7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHJlYWNoYWJpbGl0eSBzdGF0dXNcbiAgICovXG4gIGdldFN0YXR1cyhwZWVySWQ6IHN0cmluZyk6ICdyZWFjaGFibGUnIHwgJ3VucmVhY2hhYmxlJyB8ICd1bmtub3duJyB7XG4gICAgY29uc3QgY2FjaGVkID0gdGhpcy5nZXRDYWNoZWQocGVlcklkKTtcbiAgICBcbiAgICBpZiAoIWNhY2hlZCkge1xuICAgICAgcmV0dXJuICd1bmtub3duJztcbiAgICB9XG5cbiAgICByZXR1cm4gY2FjaGVkLnJlYWNoYWJsZSA/ICdyZWFjaGFibGUnIDogJ3VucmVhY2hhYmxlJztcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciBjYWNoZSBmb3IgcGVlclxuICAgKi9cbiAgY2xlYXJDYWNoZShwZWVySWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuY2FjaGUuZGVsZXRlKHBlZXJJZCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgYWxsIGNhY2hlZCByZXN1bHRzXG4gICAqL1xuICBjbGVhckFsbENhY2hlKCk6IHZvaWQge1xuICAgIHRoaXMuY2FjaGUuY2xlYXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYWxsIGNhY2hlZCByZXN1bHRzXG4gICAqL1xuICBnZXRBbGxDYWNoZWQoKTogTWFwPHN0cmluZywgUmVhY2hhYmlsaXR5UmVzdWx0PiB7XG4gICAgLy8gRmlsdGVyIG91dCBleHBpcmVkIGVudHJpZXNcbiAgICBmb3IgKGNvbnN0IFtwZWVySWQsIHJlc3VsdF0gb2YgdGhpcy5jYWNoZS5lbnRyaWVzKCkpIHtcbiAgICAgIGlmICghdGhpcy5pc0NhY2hlVmFsaWQocmVzdWx0KSkge1xuICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZShwZWVySWQpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gbmV3IE1hcCh0aGlzLmNhY2hlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNZWFzdXJlIGxhdGVuY3kgdG8gcGVlclxuICAgKi9cbiAgYXN5bmMgbWVhc3VyZUxhdGVuY3koXG4gICAgcGVlcklkOiBzdHJpbmcsXG4gICAgb25TZW5kUGluZzogKHBlZXJJZDogc3RyaW5nLCBwaW5nOiBQaW5nTWVzc2FnZSkgPT4gUHJvbWlzZTx2b2lkPixcbiAgICBzYW1wbGVzOiBudW1iZXIgPSA1XG4gICk6IFByb21pc2U8bnVtYmVyW10+IHtcbiAgICBjb25zdCBsYXRlbmNpZXM6IG51bWJlcltdID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNhbXBsZXM7IGkrKykge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy50ZXN0UmVhY2hhYmlsaXR5KHBlZXJJZCwgb25TZW5kUGluZyk7XG4gICAgICBcbiAgICAgIGlmIChyZXN1bHQucmVhY2hhYmxlICYmIHJlc3VsdC5sYXRlbmN5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbGF0ZW5jaWVzLnB1c2gocmVzdWx0LmxhdGVuY3kpO1xuICAgICAgfVxuXG4gICAgICAvLyBTbWFsbCBkZWxheSBiZXR3ZWVuIHBpbmdzXG4gICAgICBpZiAoaSA8IHNhbXBsZXMgLSAxKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZGVsYXkoMTAwKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbGF0ZW5jaWVzO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhdmVyYWdlIGxhdGVuY3lcbiAgICovXG4gIHN0YXRpYyBnZXRBdmVyYWdlTGF0ZW5jeShsYXRlbmNpZXM6IG51bWJlcltdKTogbnVtYmVyIHtcbiAgICBpZiAobGF0ZW5jaWVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIDA7XG4gICAgcmV0dXJuIGxhdGVuY2llcy5yZWR1Y2UoKHN1bSwgdmFsKSA9PiBzdW0gKyB2YWwsIDApIC8gbGF0ZW5jaWVzLmxlbmd0aDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbWVkaWFuIGxhdGVuY3kgKG1vcmUgcm9idXN0IHRoYW4gYXZlcmFnZSlcbiAgICovXG4gIHN0YXRpYyBnZXRNZWRpYW5MYXRlbmN5KGxhdGVuY2llczogbnVtYmVyW10pOiBudW1iZXIge1xuICAgIGlmIChsYXRlbmNpZXMubGVuZ3RoID09PSAwKSByZXR1cm4gMDtcbiAgICBcbiAgICBjb25zdCBzb3J0ZWQgPSBbLi4ubGF0ZW5jaWVzXS5zb3J0KChhLCBiKSA9PiBhIC0gYik7XG4gICAgY29uc3QgbWlkID0gTWF0aC5mbG9vcihzb3J0ZWQubGVuZ3RoIC8gMik7XG4gICAgXG4gICAgaWYgKHNvcnRlZC5sZW5ndGggJSAyID09PSAwKSB7XG4gICAgICByZXR1cm4gKHNvcnRlZFttaWQgLSAxXSArIHNvcnRlZFttaWRdKSAvIDI7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBzb3J0ZWRbbWlkXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbGF0ZW5jeSBzdGF0aXN0aWNzXG4gICAqL1xuICBzdGF0aWMgZ2V0TGF0ZW5jeVN0YXRzKGxhdGVuY2llczogbnVtYmVyW10pOiB7XG4gICAgbWluOiBudW1iZXI7XG4gICAgbWF4OiBudW1iZXI7XG4gICAgYXZnOiBudW1iZXI7XG4gICAgbWVkaWFuOiBudW1iZXI7XG4gICAgaml0dGVyOiBudW1iZXI7ICAvLyBWYXJpYW5jZSBpbiBsYXRlbmN5XG4gIH0ge1xuICAgIGlmIChsYXRlbmNpZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4geyBtaW46IDAsIG1heDogMCwgYXZnOiAwLCBtZWRpYW46IDAsIGppdHRlcjogMCB9O1xuICAgIH1cblxuICAgIGNvbnN0IG1pbiA9IE1hdGgubWluKC4uLmxhdGVuY2llcyk7XG4gICAgY29uc3QgbWF4ID0gTWF0aC5tYXgoLi4ubGF0ZW5jaWVzKTtcbiAgICBjb25zdCBhdmcgPSB0aGlzLmdldEF2ZXJhZ2VMYXRlbmN5KGxhdGVuY2llcyk7XG4gICAgY29uc3QgbWVkaWFuID0gdGhpcy5nZXRNZWRpYW5MYXRlbmN5KGxhdGVuY2llcyk7XG4gICAgXG4gICAgLy8gQ2FsY3VsYXRlIGppdHRlciAoc3RhbmRhcmQgZGV2aWF0aW9uKVxuICAgIGNvbnN0IHZhcmlhbmNlID0gbGF0ZW5jaWVzLnJlZHVjZSgoc3VtLCB2YWwpID0+IHtcbiAgICAgIHJldHVybiBzdW0gKyBNYXRoLnBvdyh2YWwgLSBhdmcsIDIpO1xuICAgIH0sIDApIC8gbGF0ZW5jaWVzLmxlbmd0aDtcbiAgICBjb25zdCBqaXR0ZXIgPSBNYXRoLnNxcnQodmFyaWFuY2UpO1xuXG4gICAgcmV0dXJuIHsgbWluLCBtYXgsIGF2ZywgbWVkaWFuLCBqaXR0ZXIgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBldmVudCBsaXN0ZW5lclxuICAgKi9cbiAgb24oZXZlbnQ6ICdyZWFjaGFibGUnIHwgJ3VucmVhY2hhYmxlJyB8ICd0aW1lb3V0JywgY2FsbGJhY2s6IChyZXN1bHQ6IFJlYWNoYWJpbGl0eVJlc3VsdCkgPT4gdm9pZCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5saXN0ZW5lcnMuaGFzKGV2ZW50KSkge1xuICAgICAgdGhpcy5saXN0ZW5lcnMuc2V0KGV2ZW50LCBuZXcgU2V0KCkpO1xuICAgIH1cbiAgICB0aGlzLmxpc3RlbmVycy5nZXQoZXZlbnQpIS5hZGQoY2FsbGJhY2spO1xuICB9XG5cbiAgLyoqXG4gICAqIFVucmVnaXN0ZXIgZXZlbnQgbGlzdGVuZXJcbiAgICovXG4gIG9mZihldmVudDogc3RyaW5nLCBjYWxsYmFjazogKC4uLmFyZ3M6IGFueVtdKSA9PiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCBoYW5kbGVycyA9IHRoaXMubGlzdGVuZXJzLmdldChldmVudCk7XG4gICAgaWYgKGhhbmRsZXJzKSB7XG4gICAgICBoYW5kbGVycy5kZWxldGUoY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBFbWl0IGV2ZW50XG4gICAqL1xuICBwcml2YXRlIGVtaXQoZXZlbnQ6IHN0cmluZywgZGF0YTogYW55KTogdm9pZCB7XG4gICAgY29uc3QgaGFuZGxlcnMgPSB0aGlzLmxpc3RlbmVycy5nZXQoZXZlbnQpO1xuICAgIGlmIChoYW5kbGVycykge1xuICAgICAgaGFuZGxlcnMuZm9yRWFjaChoYW5kbGVyID0+IGhhbmRsZXIoZGF0YSkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSB1bmlxdWUgcGluZyBJRFxuICAgKi9cbiAgcHJpdmF0ZSBnZW5lcmF0ZVBpbmdJZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgcGluZy0ke0RhdGUubm93KCl9LSR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDkpfWA7XG4gIH1cblxuICAvKipcbiAgICogRGVsYXkgaGVscGVyXG4gICAqL1xuICBwcml2YXRlIGRlbGF5KG1zOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAvLyBVc2VkIGZvciBzaW1wbGUgYmFja29mZjsgbm8gY2FuY2VsbGF0aW9uL3JlamVjdGlvbiBwYXRoIGlzIG5lZWRlZFxuICAgICAgY29uc3QgaGFuZGxlID0gc2V0VGltZW91dChyZXNvbHZlLCBtcyk7XG4gICAgICB0aGlzLnVucmVmVGltZW91dChoYW5kbGUpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEVuc3VyZSB0aW1lcnMgZG9uJ3Qga2VlcCB0aGUgZXZlbnQgbG9vcCBhbGl2ZSBpbiBOb2RlIGVudmlyb25tZW50c1xuICAgKi9cbiAgcHJpdmF0ZSB1bnJlZlRpbWVvdXQoaGFuZGxlOiB1bmtub3duKTogdm9pZCB7XG4gICAgLy8gSW4gYnJvd3NlciBydW50aW1lcyB0aGlzIGlzIGEgbm8tb3A7IE5vZGUgc3VwcG9ydHMgdW5yZWYgdG8gYXZvaWQgaG9sZGluZyB0aGUgZXZlbnQgbG9vcFxuICAgIGlmICh0aGlzLmlzVW5yZWZhYmxlKGhhbmRsZSkpIHtcbiAgICAgIGhhbmRsZS51bnJlZigpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNVbnJlZmFibGUoaGFuZGxlOiB1bmtub3duKTogaGFuZGxlIGlzIFVucmVmYWJsZSB7XG4gICAgaWYgKCFoYW5kbGUgfHwgdHlwZW9mIGhhbmRsZSAhPT0gJ29iamVjdCcpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgbWF5YmUgPSBoYW5kbGUgYXMgUGFydGlhbDxVbnJlZmFibGU+O1xuICAgIHJldHVybiB0eXBlb2YgbWF5YmUudW5yZWYgPT09ICdmdW5jdGlvbic7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW51cCByZXNvdXJjZXNcbiAgICovXG4gIGNsZWFudXAoKTogdm9pZCB7XG4gICAgLy8gQ2xlYXIgYWxsIHBlbmRpbmcgcGluZ3NcbiAgICBmb3IgKGNvbnN0IFtfaWQsIHBlbmRpbmddIG9mIHRoaXMucGVuZGluZ1BpbmdzLmVudHJpZXMoKSkge1xuICAgICAgY2xlYXJUaW1lb3V0KHBlbmRpbmcudGltZW91dCk7XG4gICAgICBwZW5kaW5nLnJlamVjdChuZXcgRXJyb3IoJ1ZlcmlmaWVyIGNsZWFudXAnKSk7XG4gICAgfVxuICAgIFxuICAgIHRoaXMucGVuZGluZ1BpbmdzLmNsZWFyKCk7XG4gICAgdGhpcy5jYWNoZS5jbGVhcigpO1xuICAgIHRoaXMubGlzdGVuZXJzLmNsZWFyKCk7XG4gIH1cbn1cblxuLyoqXG4gKiBVdGlsaXR5IGZ1bmN0aW9uIHRvIHRlc3QgcmVhY2hhYmlsaXR5IHdpdGggZGVmYXVsdCBzZXR0aW5nc1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdGVzdFBlZXJSZWFjaGFiaWxpdHkoXG4gIHBlZXJJZDogc3RyaW5nLFxuICBvblNlbmRQaW5nOiAocGVlcklkOiBzdHJpbmcsIHBpbmc6IFBpbmdNZXNzYWdlKSA9PiBQcm9taXNlPHZvaWQ+XG4pOiBQcm9taXNlPFJlYWNoYWJpbGl0eVJlc3VsdD4ge1xuICBjb25zdCB2ZXJpZmllciA9IG5ldyBSZWFjaGFiaWxpdHlWZXJpZmllcigpO1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCB2ZXJpZmllci50ZXN0UmVhY2hhYmlsaXR5KHBlZXJJZCwgb25TZW5kUGluZyk7XG4gIH0gZmluYWxseSB7XG4gICAgdmVyaWZpZXIuY2xlYW51cCgpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=