name: Build and Release Android APK

on:
  push:
    tags:
      - 'v*'           # Production releases (e.g., v1.0.0)
      - 'staging-v*'   # Staging releases (e.g., staging-v1.0.0-beta.1)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (startsWith(github.ref, 'refs/tags/staging-') && 'staging' || 'production') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew
        
      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon
      
      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: android/app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.ANDROID_SIGNING_KEY }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"
      
      - name: Upload APK to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{steps.sign_app.outputs.signedReleaseFile}}
          name: Sovereign Communications ${{ github.ref_name }}
          body: |
            ## Sovereign Communications Release ${{ github.ref_name }}
            
            **Environment**: ${{ startsWith(github.ref, 'refs/tags/staging-') && 'ðŸ”¶ STAGING' || 'âœ… PRODUCTION' }}
            
            ### What's New
            - Full mesh networking implementation
            - Seamless webapp-to-mobile bootstrap
            - Auto-connect to discovered peers
            - End-to-end encryption with Ed25519
            
            ### Installation
            1. Download the APK below
            2. Enable "Install from Unknown Sources" in Android settings
            3. Install the APK
            4. Grant required permissions (Bluetooth, Location, Notifications)
            5. Join the mesh network!
            
            ### Requirements
            - Android 8.0 (API 26) or higher
            - Bluetooth LE support
            - 50MB free storage
          draft: false
          prerelease: ${{ startsWith(github.ref, 'refs/tags/staging-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload signed APK as artifact (for workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ github.event.inputs.environment || 'staging' }}
          path: ${{steps.sign_app.outputs.signedReleaseFile}}
          retention-days: 7
