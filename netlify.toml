# Netlify configuration for Sovereign Communications

[build]
# Base directory for the build (root of monorepo)
base = "."

# Build command (executed in the base directory)
# This runs "npm run build --workspaces" defined in root package.json
command = "npm run build"

# Publish directory (relative to the base directory)
publish = "web/dist"

# Set node version and default env vars
[build.environment]
NODE_VERSION = "20"
VITE_PUBLIC_HUB = "true"
# All web deployments are equal - no special "netlify" mode needed

# Functions directory
functions = "netlify/functions"

# Deep link redirect for Android app bootstrapping
# If user has Android app installed, this will trigger the deep link
[[redirects]]
from = "/join"
to = "/join.html"
status = 200
force = true

# Static assets should NOT redirect
[[redirects]]
from = "/assets/*"
to = "/assets/:splat"
status = 200

# Redirect all other requests to index.html for SPA routing
[[redirects]]
from = "/*"
to = "/index.html"
status = 200

# Security headers
[[headers]]
for = "/*"
[headers.values]
# Enable HTTPS only
Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

# Prevent clickjacking
X-Frame-Options = "DENY"

# Prevent MIME type sniffing
X-Content-Type-Options = "nosniff"

# Enable XSS protection
X-XSS-Protection = "1; mode=block"

# Certificate Pinning (HPKP) - High Priority Security Feature
# Note: HPKP is deprecated but still supported by browsers for legacy compatibility
# For production, generate actual certificate pins using the command in SECURITY_TODO.md
Public-Key-Pins = "pin-sha256=\"base64+primary==\"; pin-sha256=\"base64+backup==\"; max-age=5184000; includeSubDomains; report-uri=\"https://sovcom.netlify.app/.netlify/functions/report-pin-violation\""

# Content Security Policy
Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: blob:; connect-src 'self' wss: https:; worker-src 'self' blob:; report-uri https://sovcom.netlify.app/.netlify/functions/report-csp-violation"

# Referrer policy
Referrer-Policy = "strict-origin-when-cross-origin"

# Permissions policy
Permissions-Policy = "camera=(), microphone=(), geolocation=()"

# JavaScript files in assets directory (Vite build output)
[[headers]]
for = "/assets/*.js"
[headers.values]
Content-Type = "application/javascript; charset=utf-8"
Cache-Control = "public, max-age=31536000, immutable"

# CSS files in assets directory
[[headers]]
for = "/assets/*.css"
[headers.values]
Content-Type = "text/css; charset=utf-8"
Cache-Control = "public, max-age=31536000, immutable"

# Service worker at root
[[headers]]
for = "/service-worker.js"
[headers.values]
Content-Type = "application/javascript; charset=utf-8"
Cache-Control = "no-cache"

# Root level JS files
[[headers]]
for = "/*.js"
[headers.values]
Content-Type = "application/javascript; charset=utf-8"

# Root level CSS files
[[headers]]
for = "/*.css"
[headers.values]
Content-Type = "text/css; charset=utf-8"
