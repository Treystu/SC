# Netlify configuration for Sovereign Communications

[build]
# Base directory for the build (root of monorepo)
base = "."

# Build command (executed in the base directory)
# This runs "npm run build --workspaces" defined in root package.json
command = "npm run build"

# Publish directory (relative to the base directory)
publish = "web/dist"

# Set node version and default env vars
[build.environment]
NODE_VERSION = "20"
VITE_DEPLOYMENT_MODE = "netlify"
VITE_PUBLIC_HUB = "true"

# Functions directory
functions = "netlify/functions"

# Deep link redirect for Android app bootstrapping
# If user has Android app installed, this will trigger the deep link
[[redirects]]
from = "/join"
to = "/join.html"
status = 200
force = true

# Redirect all other requests to index.html for SPA routing
[[redirects]]
from = "/*"
to = "/index.html"
status = 200

# Security headers
[[headers]]
for = "/*"
[headers.values]
# Enable HTTPS only
Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

# Prevent clickjacking
X-Frame-Options = "DENY"

# Prevent MIME type sniffing
X-Content-Type-Options = "nosniff"

# Enable XSS protection
X-XSS-Protection = "1; mode=block"

# Content Security Policy
Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: blob:; connect-src 'self' wss: https:; worker-src 'self' blob:;"

# Referrer policy
Referrer-Policy = "strict-origin-when-cross-origin"

# Permissions policy
Permissions-Policy = "camera=(), microphone=(), geolocation=()"

# Cache static assets
[[headers]]
for = "/assets/*"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"
