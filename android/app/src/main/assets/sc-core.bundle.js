"use strict";var SCCore=(()=>{var Zt=Object.defineProperty;var Mr=Object.getOwnPropertyDescriptor;var Dr=Object.getOwnPropertyNames;var Hr=Object.prototype.hasOwnProperty;var Fr=(e,t,n)=>t in e?Zt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var qr=(e,t)=>{for(var n in t)Zt(e,n,{get:t[n],enumerable:!0})},kr=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Dr(t))!Hr.call(e,s)&&s!==n&&Zt(e,s,{get:()=>t[s],enumerable:!(r=Mr(t,s))||r.enumerable});return e};var Kr=e=>kr(Zt({},"__esModule",{value:!0}),e);var y=(e,t,n)=>Fr(e,typeof t!="symbol"?t+"":t,n);var Ks={};qr(Ks,{DefaultTransportRegistry:()=>zt,MOBILE_BUNDLE:()=>ks,MessageQueue:()=>de,MessageRelay:()=>ge,MessageType:()=>V,PeerState:()=>ft,RoutingTable:()=>he,VERSION:()=>qs,base64ToPublicKey:()=>vr,compareFingerprints:()=>Rr,createPeer:()=>mr,decodeMessage:()=>le,decryptEnvelope:()=>wr,decryptMessage:()=>ar,deriveSharedSecret:()=>lr,deserializeEncryptedEnvelope:()=>Sr,deserializeSignedEnvelope:()=>_r,encodeMessage:()=>Pe,encryptEnvelope:()=>br,encryptMessage:()=>cr,formatFingerprint:()=>Cr,generateFingerprint:()=>fr,generateFullFingerprint:()=>Or,generateIdentity:()=>rr,generateNonce:()=>ur,generateSessionKey:()=>ir,isValidPublicKey:()=>Ir,publicKeyToBase64:()=>Tr,serializeEncryptedEnvelope:()=>Ar,serializeSignedEnvelope:()=>Lr,signEnvelope:()=>Er,signMessage:()=>sr,verifyEnvelope:()=>Br,verifySignature:()=>or});function Gt(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function it(e,t=""){if(!Number.isSafeInteger(e)||e<0){let n=t&&`"${t}" `;throw new Error(`${n}expected integer >= 0, got ${e}`)}}function K(e,t,n=""){let r=Gt(e),s=e?.length,o=t!==void 0;if(!r||o&&s!==t){let c=n&&`"${n}" `,i=o?` of length ${t}`:"",a=r?`length=${s}`:`type=${typeof e}`;throw new Error(c+"expected Uint8Array"+i+", got "+a)}return e}function Dt(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash must wrapped by utils.createHasher");it(e.outputLen),it(e.blockLen)}function It(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Qe(e,t){K(e,void 0,"digestInto() output");let n=t.outputLen;if(e.length<n)throw new Error('"digestInto() output" expected to be of length >='+n)}function J(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function Xt(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function tt(e,t){return e<<32-t|e>>>t}var Je=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Pr=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function Tt(e){if(K(e),Je)return e.toHex();let t="";for(let n=0;n<e.length;n++)t+=Pr[e[n]];return t}var ht={_0:48,_9:57,A:65,F:70,a:97,f:102};function We(e){if(e>=ht._0&&e<=ht._9)return e-ht._0;if(e>=ht.A&&e<=ht.F)return e-(ht.A-10);if(e>=ht.a&&e<=ht.f)return e-(ht.a-10)}function Ht(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);if(Je)return Uint8Array.fromHex(e);let t=e.length,n=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);let r=new Uint8Array(n);for(let s=0,o=0;s<n;s++,o+=2){let c=We(e.charCodeAt(o)),i=We(e.charCodeAt(o+1));if(c===void 0||i===void 0){let a=e[o]+e[o+1];throw new Error('hex string expected, got non-hex character "'+a+'" at index '+o)}r[s]=c*16+i}return r}function Ft(...e){let t=0;for(let r=0;r<e.length;r++){let s=e[r];K(s),t+=s.length}let n=new Uint8Array(t);for(let r=0,s=0;r<e.length;r++){let o=e[r];n.set(o,s),s+=o.length}return n}function xe(e,t={}){let n=(s,o)=>e(o).update(s).digest(),r=e(void 0);return n.outputLen=r.outputLen,n.blockLen=r.blockLen,n.create=s=>e(s),Object.assign(n,t),Object.freeze(n)}function ct(e=32){let t=typeof globalThis=="object"?globalThis.crypto:null;if(typeof t?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return t.getRandomValues(new Uint8Array(e))}var me=e=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,e])});function tn(e,t,n){return e&t^~e&n}function en(e,t,n){return e&t^e&n^t&n}var qt=class{constructor(t,n,r,s){y(this,"blockLen");y(this,"outputLen");y(this,"padOffset");y(this,"isLE");y(this,"buffer");y(this,"view");y(this,"finished",!1);y(this,"length",0);y(this,"pos",0);y(this,"destroyed",!1);this.blockLen=t,this.outputLen=n,this.padOffset=r,this.isLE=s,this.buffer=new Uint8Array(t),this.view=Xt(this.buffer)}update(t){It(this),K(t);let{view:n,buffer:r,blockLen:s}=this,o=t.length;for(let c=0;c<o;){let i=Math.min(s-this.pos,o-c);if(i===s){let a=Xt(t);for(;s<=o-c;c+=s)this.process(a,c);continue}r.set(t.subarray(c,c+i),this.pos),this.pos+=i,c+=i,this.pos===s&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){It(this),Qe(t,this),this.finished=!0;let{buffer:n,view:r,blockLen:s,isLE:o}=this,{pos:c}=this;n[c++]=128,J(this.buffer.subarray(c)),this.padOffset>s-c&&(this.process(r,0),c=0);for(let l=c;l<s;l++)n[l]=0;r.setBigUint64(s-8,BigInt(this.length*8),o),this.process(r,0);let i=Xt(t),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let u=a/4,f=this.get();if(u>f.length)throw new Error("_sha2: outputLen bigger than state");for(let l=0;l<u;l++)i.setUint32(4*l,f[l],o)}digest(){let{buffer:t,outputLen:n}=this;this.digestInto(t);let r=t.slice(0,n);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());let{blockLen:n,buffer:r,length:s,finished:o,destroyed:c,pos:i}=this;return t.destroyed=c,t.finished=o,t.length=s,t.pos=i,s%n&&t.buffer.set(r),t}clone(){return this._cloneInto()}},dt=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]);var G=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]);var Yt=BigInt(4294967295),nn=BigInt(32);function Vr(e,t=!1){return t?{h:Number(e&Yt),l:Number(e>>nn&Yt)}:{h:Number(e>>nn&Yt)|0,l:Number(e&Yt)|0}}function rn(e,t=!1){let n=e.length,r=new Uint32Array(n),s=new Uint32Array(n);for(let o=0;o<n;o++){let{h:c,l:i}=Vr(e[o],t);[r[o],s[o]]=[c,i]}return[r,s]}var ye=(e,t,n)=>e>>>n,be=(e,t,n)=>e<<32-n|t>>>n,At=(e,t,n)=>e>>>n|t<<32-n,St=(e,t,n)=>e<<32-n|t>>>n,kt=(e,t,n)=>e<<64-n|t>>>n-32,Kt=(e,t,n)=>e>>>n-32|t<<64-n;function at(e,t,n,r){let s=(t>>>0)+(r>>>0);return{h:e+n+(s/2**32|0)|0,l:s|0}}var sn=(e,t,n)=>(e>>>0)+(t>>>0)+(n>>>0),on=(e,t,n,r)=>t+n+r+(e/2**32|0)|0,cn=(e,t,n,r)=>(e>>>0)+(t>>>0)+(n>>>0)+(r>>>0),an=(e,t,n,r,s)=>t+n+r+s+(e/2**32|0)|0,fn=(e,t,n,r,s)=>(e>>>0)+(t>>>0)+(n>>>0)+(r>>>0)+(s>>>0),un=(e,t,n,r,s,o)=>t+n+r+s+o+(e/2**32|0)|0;var Zr=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),mt=new Uint32Array(64),we=class extends qt{constructor(t){super(64,t,8,!1)}get(){let{A:t,B:n,C:r,D:s,E:o,F:c,G:i,H:a}=this;return[t,n,r,s,o,c,i,a]}set(t,n,r,s,o,c,i,a){this.A=t|0,this.B=n|0,this.C=r|0,this.D=s|0,this.E=o|0,this.F=c|0,this.G=i|0,this.H=a|0}process(t,n){for(let l=0;l<16;l++,n+=4)mt[l]=t.getUint32(n,!1);for(let l=16;l<64;l++){let x=mt[l-15],b=mt[l-2],w=tt(x,7)^tt(x,18)^x>>>3,E=tt(b,17)^tt(b,19)^b>>>10;mt[l]=E+mt[l-7]+w+mt[l-16]|0}let{A:r,B:s,C:o,D:c,E:i,F:a,G:u,H:f}=this;for(let l=0;l<64;l++){let x=tt(i,6)^tt(i,11)^tt(i,25),b=f+x+tn(i,a,u)+Zr[l]+mt[l]|0,E=(tt(r,2)^tt(r,13)^tt(r,22))+en(r,s,o)|0;f=u,u=a,a=i,i=c+b|0,c=o,o=s,s=r,r=b+E|0}r=r+this.A|0,s=s+this.B|0,o=o+this.C|0,c=c+this.D|0,i=i+this.E|0,a=a+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(r,s,o,c,i,a,u,f)}roundClean(){J(mt)}destroy(){this.set(0,0,0,0,0,0,0,0),J(this.buffer)}},Ee=class extends we{constructor(){super(32);y(this,"A",dt[0]|0);y(this,"B",dt[1]|0);y(this,"C",dt[2]|0);y(this,"D",dt[3]|0);y(this,"E",dt[4]|0);y(this,"F",dt[5]|0);y(this,"G",dt[6]|0);y(this,"H",dt[7]|0)}};var ln=rn(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(e=>BigInt(e))),Gr=ln[0],Xr=ln[1],yt=new Uint32Array(80),bt=new Uint32Array(80),Be=class extends qt{constructor(t){super(128,t,16,!1)}get(){let{Ah:t,Al:n,Bh:r,Bl:s,Ch:o,Cl:c,Dh:i,Dl:a,Eh:u,El:f,Fh:l,Fl:x,Gh:b,Gl:w,Hh:E,Hl:h}=this;return[t,n,r,s,o,c,i,a,u,f,l,x,b,w,E,h]}set(t,n,r,s,o,c,i,a,u,f,l,x,b,w,E,h){this.Ah=t|0,this.Al=n|0,this.Bh=r|0,this.Bl=s|0,this.Ch=o|0,this.Cl=c|0,this.Dh=i|0,this.Dl=a|0,this.Eh=u|0,this.El=f|0,this.Fh=l|0,this.Fl=x|0,this.Gh=b|0,this.Gl=w|0,this.Hh=E|0,this.Hl=h|0}process(t,n){for(let d=0;d<16;d++,n+=4)yt[d]=t.getUint32(n),bt[d]=t.getUint32(n+=4);for(let d=16;d<80;d++){let S=yt[d-15]|0,N=bt[d-15]|0,M=At(S,N,1)^At(S,N,8)^ye(S,N,7),H=St(S,N,1)^St(S,N,8)^be(S,N,7),m=yt[d-2]|0,g=bt[d-2]|0,A=At(m,g,19)^kt(m,g,61)^ye(m,g,6),I=St(m,g,19)^Kt(m,g,61)^be(m,g,6),T=cn(H,I,bt[d-7],bt[d-16]),v=an(T,M,A,yt[d-7],yt[d-16]);yt[d]=v|0,bt[d]=T|0}let{Ah:r,Al:s,Bh:o,Bl:c,Ch:i,Cl:a,Dh:u,Dl:f,Eh:l,El:x,Fh:b,Fl:w,Gh:E,Gl:h,Hh:O,Hl:p}=this;for(let d=0;d<80;d++){let S=At(l,x,14)^At(l,x,18)^kt(l,x,41),N=St(l,x,14)^St(l,x,18)^Kt(l,x,41),M=l&b^~l&E,H=x&w^~x&h,m=fn(p,N,H,Xr[d],bt[d]),g=un(m,O,S,M,Gr[d],yt[d]),A=m|0,I=At(r,s,28)^kt(r,s,34)^kt(r,s,39),T=St(r,s,28)^Kt(r,s,34)^Kt(r,s,39),v=r&o^r&i^o&i,_=s&c^s&a^c&a;O=E|0,p=h|0,E=b|0,h=w|0,b=l|0,w=x|0,{h:l,l:x}=at(u|0,f|0,g|0,A|0),u=i|0,f=a|0,i=o|0,a=c|0,o=r|0,c=s|0;let C=sn(A,T,_);r=on(C,g,I,v),s=C|0}({h:r,l:s}=at(this.Ah|0,this.Al|0,r|0,s|0)),{h:o,l:c}=at(this.Bh|0,this.Bl|0,o|0,c|0),{h:i,l:a}=at(this.Ch|0,this.Cl|0,i|0,a|0),{h:u,l:f}=at(this.Dh|0,this.Dl|0,u|0,f|0),{h:l,l:x}=at(this.Eh|0,this.El|0,l|0,x|0),{h:b,l:w}=at(this.Fh|0,this.Fl|0,b|0,w|0),{h:E,l:h}=at(this.Gh|0,this.Gl|0,E|0,h|0),{h:O,l:p}=at(this.Hh|0,this.Hl|0,O|0,p|0),this.set(r,s,o,c,i,a,u,f,l,x,b,w,E,h,O,p)}roundClean(){J(yt,bt)}destroy(){J(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},Ae=class extends Be{constructor(){super(64);y(this,"Ah",G[0]|0);y(this,"Al",G[1]|0);y(this,"Bh",G[2]|0);y(this,"Bl",G[3]|0);y(this,"Ch",G[4]|0);y(this,"Cl",G[5]|0);y(this,"Dh",G[6]|0);y(this,"Dl",G[7]|0);y(this,"Eh",G[8]|0);y(this,"El",G[9]|0);y(this,"Fh",G[10]|0);y(this,"Fl",G[11]|0);y(this,"Gh",G[12]|0);y(this,"Gl",G[13]|0);y(this,"Hh",G[14]|0);y(this,"Hl",G[15]|0)}};var wt=xe(()=>new Ee,me(1));var hn=xe(()=>new Ae,me(3));var pn=BigInt(0),dn=BigInt(1);function $t(e,t=""){if(typeof e!="boolean"){let n=t&&`"${t}" `;throw new Error(n+"expected boolean, got type="+typeof e)}return e}function Yr(e){if(typeof e=="bigint"){if(!jt(e))throw new Error("positive bigint expected, got "+e)}else it(e);return e}function gn(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);return e===""?pn:BigInt("0x"+e)}function xn(e){return gn(Tt(e))}function pt(e){return gn(Tt(Lt(K(e)).reverse()))}function Se(e,t){it(t),e=Yr(e);let n=Ht(e.toString(16).padStart(t*2,"0"));if(n.length!==t)throw new Error("number too large");return n}function Wt(e,t){return Se(e,t).reverse()}function Lt(e){return Uint8Array.from(e)}var jt=e=>typeof e=="bigint"&&pn<=e;function jr(e,t,n){return jt(e)&&jt(t)&&jt(n)&&t<=e&&e<n}function vt(e,t,n,r){if(!jr(t,n,r))throw new Error("expected valid "+e+": "+n+" <= n < "+r+", got "+t)}var mn=e=>(dn<<BigInt(e))-dn;function _t(e,t={},n={}){if(!e||typeof e!="object")throw new Error("expected valid options object");function r(o,c,i){let a=e[o];if(i&&a===void 0)return;let u=typeof a;if(u!==c||a===null)throw new Error(`param "${o}" is invalid: expected ${c}, got ${u}`)}let s=(o,c)=>Object.entries(o).forEach(([i,a])=>r(i,a,c));s(t,!1),s(n,!0)}function Le(e){let t=new WeakMap;return(n,...r)=>{let s=t.get(n);if(s!==void 0)return s;let o=e(n,...r);return t.set(n,o),o}}var j=BigInt(0),Y=BigInt(1),Ot=BigInt(2),wn=BigInt(3),En=BigInt(4),Bn=BigInt(5),$r=BigInt(7),An=BigInt(8),Wr=BigInt(9),Sn=BigInt(16);function P(e,t){let n=e%t;return n>=j?n:t+n}function Q(e,t,n){let r=e;for(;t-- >j;)r*=r,r%=n;return r}function yn(e,t){if(e===j)throw new Error("invert: expected non-zero number");if(t<=j)throw new Error("invert: expected positive modulus, got "+t);let n=P(e,t),r=t,s=j,o=Y,c=Y,i=j;for(;n!==j;){let u=r/n,f=r%n,l=s-c*u,x=o-i*u;r=n,n=f,s=c,o=i,c=l,i=x}if(r!==Y)throw new Error("invert: does not exist");return P(s,t)}function Oe(e,t,n){if(!e.eql(e.sqr(t),n))throw new Error("Cannot find square root")}function Ln(e,t){let n=(e.ORDER+Y)/En,r=e.pow(t,n);return Oe(e,r,t),r}function Qr(e,t){let n=(e.ORDER-Bn)/An,r=e.mul(t,Ot),s=e.pow(r,n),o=e.mul(t,s),c=e.mul(e.mul(o,Ot),s),i=e.mul(o,e.sub(c,e.ONE));return Oe(e,i,t),i}function Jr(e){let t=Jt(e),n=_n(e),r=n(t,t.neg(t.ONE)),s=n(t,r),o=n(t,t.neg(r)),c=(e+$r)/Sn;return(i,a)=>{let u=i.pow(a,c),f=i.mul(u,r),l=i.mul(u,s),x=i.mul(u,o),b=i.eql(i.sqr(f),a),w=i.eql(i.sqr(l),a);u=i.cmov(u,f,b),f=i.cmov(x,l,w);let E=i.eql(i.sqr(f),a),h=i.cmov(u,f,E);return Oe(i,h,a),h}}function _n(e){if(e<wn)throw new Error("sqrt is not defined for small field");let t=e-Y,n=0;for(;t%Ot===j;)t/=Ot,n++;let r=Ot,s=Jt(e);for(;bn(s,r)===1;)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(n===1)return Ln;let o=s.pow(r,t),c=(t+Y)/Ot;return function(a,u){if(a.is0(u))return u;if(bn(a,u)!==1)throw new Error("Cannot find square root");let f=n,l=a.mul(a.ONE,o),x=a.pow(u,t),b=a.pow(u,c);for(;!a.eql(x,a.ONE);){if(a.is0(x))return a.ZERO;let w=1,E=a.sqr(x);for(;!a.eql(E,a.ONE);)if(w++,E=a.sqr(E),w===f)throw new Error("Cannot find square root");let h=Y<<BigInt(f-w-1),O=a.pow(l,h);f=w,l=a.sqr(O),x=a.mul(x,l),b=a.mul(b,O)}return b}}function ts(e){return e%En===wn?Ln:e%An===Bn?Qr:e%Sn===Wr?Jr(e):_n(e)}var On=(e,t)=>(P(e,t)&Y)===Y,es=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Cn(e){let t={ORDER:"bigint",BYTES:"number",BITS:"number"},n=es.reduce((r,s)=>(r[s]="function",r),t);return _t(e,n),e}function ns(e,t,n){if(n<j)throw new Error("invalid exponent, negatives unsupported");if(n===j)return e.ONE;if(n===Y)return t;let r=e.ONE,s=t;for(;n>j;)n&Y&&(r=e.mul(r,s)),s=e.sqr(s),n>>=Y;return r}function Qt(e,t,n=!1){let r=new Array(t.length).fill(n?e.ZERO:void 0),s=t.reduce((c,i,a)=>e.is0(i)?c:(r[a]=c,e.mul(c,i)),e.ONE),o=e.inv(s);return t.reduceRight((c,i,a)=>e.is0(i)?c:(r[a]=e.mul(c,r[a]),e.mul(c,i)),o),r}function bn(e,t){let n=(e.ORDER-Y)/Ot,r=e.pow(t,n),s=e.eql(r,e.ONE),o=e.eql(r,e.ZERO),c=e.eql(r,e.neg(e.ONE));if(!s&&!o&&!c)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function rs(e,t){t!==void 0&&it(t);let n=t!==void 0?t:e.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}var _e=class{constructor(t,n={}){y(this,"ORDER");y(this,"BITS");y(this,"BYTES");y(this,"isLE");y(this,"ZERO",j);y(this,"ONE",Y);y(this,"_lengths");y(this,"_sqrt");y(this,"_mod");if(t<=j)throw new Error("invalid field: expected ORDER > 0, got "+t);let r;this.isLE=!1,n!=null&&typeof n=="object"&&(typeof n.BITS=="number"&&(r=n.BITS),typeof n.sqrt=="function"&&(this.sqrt=n.sqrt),typeof n.isLE=="boolean"&&(this.isLE=n.isLE),n.allowedLengths&&(this._lengths=n.allowedLengths?.slice()),typeof n.modFromBytes=="boolean"&&(this._mod=n.modFromBytes));let{nBitLength:s,nByteLength:o}=rs(t,r);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=t,this.BITS=s,this.BYTES=o,this._sqrt=void 0,Object.preventExtensions(this)}create(t){return P(t,this.ORDER)}isValid(t){if(typeof t!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof t);return j<=t&&t<this.ORDER}is0(t){return t===j}isValidNot0(t){return!this.is0(t)&&this.isValid(t)}isOdd(t){return(t&Y)===Y}neg(t){return P(-t,this.ORDER)}eql(t,n){return t===n}sqr(t){return P(t*t,this.ORDER)}add(t,n){return P(t+n,this.ORDER)}sub(t,n){return P(t-n,this.ORDER)}mul(t,n){return P(t*n,this.ORDER)}pow(t,n){return ns(this,t,n)}div(t,n){return P(t*yn(n,this.ORDER),this.ORDER)}sqrN(t){return t*t}addN(t,n){return t+n}subN(t,n){return t-n}mulN(t,n){return t*n}inv(t){return yn(t,this.ORDER)}sqrt(t){return this._sqrt||(this._sqrt=ts(this.ORDER)),this._sqrt(this,t)}toBytes(t){return this.isLE?Wt(t,this.BYTES):Se(t,this.BYTES)}fromBytes(t,n=!1){K(t);let{_lengths:r,BYTES:s,isLE:o,ORDER:c,_mod:i}=this;if(r){if(!r.includes(t.length)||t.length>s)throw new Error("Field.fromBytes: expected "+r+" bytes, got "+t.length);let u=new Uint8Array(s);u.set(t,o?0:u.length-t.length),t=u}if(t.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+t.length);let a=o?pt(t):xn(t);if(i&&(a=P(a,c)),!n&&!this.isValid(a))throw new Error("invalid field element: outside of range 0..ORDER");return a}invertBatch(t){return Qt(this,t)}cmov(t,n,r){return r?n:t}};function Jt(e,t={}){return new _e(e,t)}var te=BigInt(0),ve=BigInt(1);function In(e,t){let n=t.negate();return e?n:t}function ne(e,t){let n=Qt(e.Fp,t.map(r=>r.Z));return t.map((r,s)=>e.fromAffine(r.toAffine(n[s])))}function Nn(e,t){if(!Number.isSafeInteger(e)||e<=0||e>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+e)}function Ce(e,t){Nn(e,t);let n=Math.ceil(t/e)+1,r=2**(e-1),s=2**e,o=mn(e),c=BigInt(e);return{windows:n,windowSize:r,mask:o,maxNumber:s,shiftBy:c}}function Tn(e,t,n){let{windowSize:r,mask:s,maxNumber:o,shiftBy:c}=n,i=Number(e&s),a=e>>c;i>r&&(i-=o,a+=ve);let u=t*r,f=u+Math.abs(i)-1,l=i===0,x=i<0,b=t%2!==0;return{nextN:a,offset:f,isZero:l,isNeg:x,isNegF:b,offsetF:u}}var Ie=new WeakMap,Un=new WeakMap;function Te(e){return Un.get(e)||1}function vn(e){if(e!==te)throw new Error("invalid wNAF")}var ee=class{constructor(t,n){y(this,"BASE");y(this,"ZERO");y(this,"Fn");y(this,"bits");this.BASE=t.BASE,this.ZERO=t.ZERO,this.Fn=t.Fn,this.bits=n}_unsafeLadder(t,n,r=this.ZERO){let s=t;for(;n>te;)n&ve&&(r=r.add(s)),s=s.double(),n>>=ve;return r}precomputeWindow(t,n){let{windows:r,windowSize:s}=Ce(n,this.bits),o=[],c=t,i=c;for(let a=0;a<r;a++){i=c,o.push(i);for(let u=1;u<s;u++)i=i.add(c),o.push(i);c=i.double()}return o}wNAF(t,n,r){if(!this.Fn.isValid(r))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE,c=Ce(t,this.bits);for(let i=0;i<c.windows;i++){let{nextN:a,offset:u,isZero:f,isNeg:l,isNegF:x,offsetF:b}=Tn(r,i,c);r=a,f?o=o.add(In(x,n[b])):s=s.add(In(l,n[u]))}return vn(r),{p:s,f:o}}wNAFUnsafe(t,n,r,s=this.ZERO){let o=Ce(t,this.bits);for(let c=0;c<o.windows&&r!==te;c++){let{nextN:i,offset:a,isZero:u,isNeg:f}=Tn(r,c,o);if(r=i,!u){let l=n[a];s=s.add(f?l.negate():l)}}return vn(r),s}getPrecomputes(t,n,r){let s=Ie.get(n);return s||(s=this.precomputeWindow(n,t),t!==1&&(typeof r=="function"&&(s=r(s)),Ie.set(n,s))),s}cached(t,n,r){let s=Te(t);return this.wNAF(s,this.getPrecomputes(s,t,r),n)}unsafe(t,n,r,s){let o=Te(t);return o===1?this._unsafeLadder(t,n,s):this.wNAFUnsafe(o,this.getPrecomputes(o,t,r),n,s)}createCache(t,n){Nn(n,this.bits),Un.set(t,n),Ie.delete(t)}hasCache(t){return Te(t)!==1}};function Rn(e,t,n){if(t){if(t.ORDER!==e)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Cn(t),t}else return Jt(e,{isLE:n})}function Mn(e,t,n={},r){if(r===void 0&&(r=e==="edwards"),!t||typeof t!="object")throw new Error(`expected valid ${e} CURVE object`);for(let a of["p","n","h"]){let u=t[a];if(!(typeof u=="bigint"&&u>te))throw new Error(`CURVE.${a} must be positive bigint`)}let s=Rn(t.p,n.Fp,r),o=Rn(t.n,n.Fn,r),i=["Gx","Gy","a",e==="weierstrass"?"b":"d"];for(let a of i)if(!s.isValid(t[a]))throw new Error(`CURVE.${a} must be valid field element of CURVE.Fp`);return t=Object.freeze(Object.assign({},t)),{CURVE:t,Fp:s,Fn:o}}function re(e,t){return function(r){let s=e(r);return{secretKey:s,publicKey:t(s)}}}var Et=BigInt(0),z=BigInt(1),Re=BigInt(2),ss=BigInt(8);function os(e,t,n,r){let s=e.sqr(n),o=e.sqr(r),c=e.add(e.mul(t.a,s),o),i=e.add(e.ONE,e.mul(t.d,e.mul(s,o)));return e.eql(c,i)}function Dn(e,t={}){let n=Mn("edwards",e,t,t.FpFnLE),{Fp:r,Fn:s}=n,o=n.CURVE,{h:c}=o;_t(t,{},{uvRatio:"function"});let i=Re<<BigInt(s.BYTES*8)-z,a=O=>r.create(O),u=t.uvRatio||((O,p)=>{try{return{isValid:!0,value:r.sqrt(r.div(O,p))}}catch{return{isValid:!1,value:Et}}});if(!os(r,o,o.Gx,o.Gy))throw new Error("bad curve params: generator point");function f(O,p,d=!1){let S=d?z:Et;return vt("coordinate "+O,p,S,i),p}function l(O){if(!(O instanceof w))throw new Error("EdwardsPoint expected")}let x=Le((O,p)=>{let{X:d,Y:S,Z:N}=O,M=O.is0();p==null&&(p=M?ss:r.inv(N));let H=a(d*p),m=a(S*p),g=r.mul(N,p);if(M)return{x:Et,y:z};if(g!==z)throw new Error("invZ was invalid");return{x:H,y:m}}),b=Le(O=>{let{a:p,d}=o;if(O.is0())throw new Error("bad point: ZERO");let{X:S,Y:N,Z:M,T:H}=O,m=a(S*S),g=a(N*N),A=a(M*M),I=a(A*A),T=a(m*p),v=a(A*a(T+g)),_=a(I+a(d*a(m*g)));if(v!==_)throw new Error("bad point: equation left != right (1)");let C=a(S*N),R=a(M*H);if(C!==R)throw new Error("bad point: equation left != right (2)");return!0}),h=class h{constructor(p,d,S,N){y(this,"X");y(this,"Y");y(this,"Z");y(this,"T");this.X=f("x",p),this.Y=f("y",d),this.Z=f("z",S,!0),this.T=f("t",N),Object.freeze(this)}static CURVE(){return o}static fromAffine(p){if(p instanceof h)throw new Error("extended point not allowed");let{x:d,y:S}=p||{};return f("x",d),f("y",S),new h(d,S,z,a(d*S))}static fromBytes(p,d=!1){let S=r.BYTES,{a:N,d:M}=o;p=Lt(K(p,S,"point")),$t(d,"zip215");let H=Lt(p),m=p[S-1];H[S-1]=m&-129;let g=pt(H),A=d?i:r.ORDER;vt("point.y",g,Et,A);let I=a(g*g),T=a(I-z),v=a(M*I-N),{isValid:_,value:C}=u(T,v);if(!_)throw new Error("bad point: invalid y coordinate");let R=(C&z)===z,D=(m&128)!==0;if(!d&&C===Et&&D)throw new Error("bad point: x=0 and x_0=1");return D!==R&&(C=a(-C)),h.fromAffine({x:C,y:g})}static fromHex(p,d=!1){return h.fromBytes(Ht(p),d)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(p=8,d=!0){return E.createCache(this,p),d||this.multiply(Re),this}assertValidity(){b(this)}equals(p){l(p);let{X:d,Y:S,Z:N}=this,{X:M,Y:H,Z:m}=p,g=a(d*m),A=a(M*N),I=a(S*m),T=a(H*N);return g===A&&I===T}is0(){return this.equals(h.ZERO)}negate(){return new h(a(-this.X),this.Y,this.Z,a(-this.T))}double(){let{a:p}=o,{X:d,Y:S,Z:N}=this,M=a(d*d),H=a(S*S),m=a(Re*a(N*N)),g=a(p*M),A=d+S,I=a(a(A*A)-M-H),T=g+H,v=T-m,_=g-H,C=a(I*v),R=a(T*_),D=a(I*_),U=a(v*T);return new h(C,R,U,D)}add(p){l(p);let{a:d,d:S}=o,{X:N,Y:M,Z:H,T:m}=this,{X:g,Y:A,Z:I,T}=p,v=a(N*g),_=a(M*A),C=a(m*S*T),R=a(H*I),D=a((N+M)*(g+A)-v-_),U=R-C,B=R+C,F=a(_-d*v),q=a(D*U),k=a(B*F),$=a(D*F),W=a(U*B);return new h(q,k,W,$)}subtract(p){return this.add(p.negate())}multiply(p){if(!s.isValidNot0(p))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p:d,f:S}=E.cached(this,p,N=>ne(h,N));return ne(h,[d,S])[0]}multiplyUnsafe(p,d=h.ZERO){if(!s.isValid(p))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return p===Et?h.ZERO:this.is0()||p===z?this:E.unsafe(this,p,S=>ne(h,S),d)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return E.unsafe(this,o.n).is0()}toAffine(p){return x(this,p)}clearCofactor(){return c===z?this:this.multiplyUnsafe(c)}toBytes(){let{x:p,y:d}=this.toAffine(),S=r.toBytes(d);return S[S.length-1]|=p&z?128:0,S}toHex(){return Tt(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}};y(h,"BASE",new h(o.Gx,o.Gy,z,a(o.Gx*o.Gy))),y(h,"ZERO",new h(Et,z,z,Et)),y(h,"Fp",r),y(h,"Fn",s);let w=h,E=new ee(w,s.BITS);return w.BASE.precompute(8),w}function Hn(e,t,n={}){if(typeof t!="function")throw new Error('"hash" function param is required');_t(n,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:r}=n,{BASE:s,Fp:o,Fn:c}=e,i=n.randomBytes||ct,a=n.adjustScalarBytes||(m=>m),u=n.domain||((m,g,A)=>{if($t(A,"phflag"),g.length||A)throw new Error("Contexts/pre-hash are not supported");return m});function f(m){return c.create(pt(m))}function l(m){let g=d.secretKey;K(m,d.secretKey,"secretKey");let A=K(t(m),2*g,"hashedSecretKey"),I=a(A.slice(0,g)),T=A.slice(g,2*g),v=f(I);return{head:I,prefix:T,scalar:v}}function x(m){let{head:g,prefix:A,scalar:I}=l(m),T=s.multiply(I),v=T.toBytes();return{head:g,prefix:A,scalar:I,point:T,pointBytes:v}}function b(m){return x(m).pointBytes}function w(m=Uint8Array.of(),...g){let A=Ft(...g);return f(t(u(A,K(m,void 0,"context"),!!r)))}function E(m,g,A={}){m=K(m,void 0,"message"),r&&(m=r(m));let{prefix:I,scalar:T,pointBytes:v}=x(g),_=w(A.context,I,m),C=s.multiply(_).toBytes(),R=w(A.context,C,v,m),D=c.create(_+R*T);if(!c.isValid(D))throw new Error("sign failed: invalid s");let U=Ft(C,c.toBytes(D));return K(U,d.signature,"result")}let h={zip215:!0};function O(m,g,A,I=h){let{context:T,zip215:v}=I,_=d.signature;m=K(m,_,"signature"),g=K(g,void 0,"message"),A=K(A,d.publicKey,"publicKey"),v!==void 0&&$t(v,"zip215"),r&&(g=r(g));let C=_/2,R=m.subarray(0,C),D=pt(m.subarray(C,_)),U,B,F;try{U=e.fromBytes(A,v),B=e.fromBytes(R,v),F=s.multiplyUnsafe(D)}catch{return!1}if(!v&&U.isSmallOrder())return!1;let q=w(T,B.toBytes(),U.toBytes(),g);return B.add(U.multiplyUnsafe(q)).subtract(F).clearCofactor().is0()}let p=o.BYTES,d={secretKey:p,publicKey:p,signature:2*p,seed:p};function S(m=i(d.seed)){return K(m,d.seed,"seed")}function N(m){return Gt(m)&&m.length===c.BYTES}function M(m,g){try{return!!e.fromBytes(m,g)}catch{return!1}}let H={getExtendedPublicKey:x,randomSecretKey:S,isValidSecretKey:N,isValidPublicKey:M,toMontgomery(m){let{y:g}=e.fromBytes(m),A=d.publicKey,I=A===32;if(!I&&A!==57)throw new Error("only defined for 25519 and 448");let T=I?o.div(z+g,z-g):o.div(g-z,g+z);return o.toBytes(T)},toMontgomerySecret(m){let g=d.secretKey;K(m,g);let A=t(m.subarray(0,g));return a(A).subarray(0,g)}};return Object.freeze({keygen:re(S,b),getPublicKey:b,sign:E,verify:O,utils:H,Point:e,lengths:d})}var Pt=BigInt(0),Rt=BigInt(1),se=BigInt(2);function is(e){return _t(e,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...e})}function Fn(e){let t=is(e),{P:n,type:r,adjustScalarBytes:s,powPminus2:o,randomBytes:c}=t,i=r==="x25519";if(!i&&r!=="x448")throw new Error("invalid type");let a=c||ct,u=i?255:448,f=i?32:56,l=BigInt(i?9:5),x=BigInt(i?121665:39081),b=i?se**BigInt(254):se**BigInt(447),w=i?BigInt(8)*se**BigInt(251)-Rt:BigInt(4)*se**BigInt(445)-Rt,E=b+w+Rt,h=_=>P(_,n),O=p(l);function p(_){return Wt(h(_),f)}function d(_){let C=Lt(K(_,f,"uCoordinate"));return i&&(C[31]&=127),h(pt(C))}function S(_){return pt(s(Lt(K(_,f,"scalar"))))}function N(_,C){let R=A(d(C),S(_));if(R===Pt)throw new Error("invalid private or public key received");return p(R)}function M(_){return N(_,O)}let H=M,m=N;function g(_,C,R){let D=h(_*(C-R));return C=h(C-D),R=h(R+D),{x_2:C,x_3:R}}function A(_,C){vt("u",_,Pt,n),vt("scalar",C,b,E);let R=C,D=_,U=Rt,B=Pt,F=_,q=Rt,k=Pt;for(let W=BigInt(u-1);W>=Pt;W--){let ut=R>>W&Rt;k^=ut,{x_2:U,x_3:F}=g(k,U,F),{x_2:B,x_3:q}=g(k,B,q),k=ut;let rt=U+B,st=h(rt*rt),ot=U-B,lt=h(ot*ot),Ge=st-lt,Nr=F+q,Ur=F-q,Xe=h(Ur*rt),Ye=h(Nr*ot),je=Xe+Ye,$e=Xe-Ye;F=h(je*je),q=h(D*h($e*$e)),U=h(st*lt),B=h(Ge*(st+h(x*Ge)))}({x_2:U,x_3:F}=g(k,U,F)),{x_2:B,x_3:q}=g(k,B,q);let $=o(B);return h(U*$)}let I={secretKey:f,publicKey:f,seed:f},T=(_=a(f))=>(K(_,I.seed,"seed"),_),v={randomSecretKey:T};return Object.freeze({keygen:re(T,H),getSharedSecret:m,getPublicKey:H,scalarMult:N,scalarMultBase:M,utils:v,GuBytes:O.slice(),lengths:I})}var cs=BigInt(1),qn=BigInt(2),as=BigInt(3),fs=BigInt(5),us=BigInt(8),oe=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),ls={p:oe,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:us,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function Kn(e){let t=BigInt(10),n=BigInt(20),r=BigInt(40),s=BigInt(80),o=oe,i=e*e%o*e%o,a=Q(i,qn,o)*i%o,u=Q(a,cs,o)*e%o,f=Q(u,fs,o)*u%o,l=Q(f,t,o)*f%o,x=Q(l,n,o)*l%o,b=Q(x,r,o)*x%o,w=Q(b,s,o)*b%o,E=Q(w,s,o)*b%o,h=Q(E,t,o)*f%o;return{pow_p_5_8:Q(h,qn,o)*e%o,b2:i}}function Pn(e){return e[0]&=248,e[31]&=127,e[31]|=64,e}var kn=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function hs(e,t){let n=oe,r=P(t*t*t,n),s=P(r*r*t,n),o=Kn(e*s).pow_p_5_8,c=P(e*r*o,n),i=P(t*c*c,n),a=c,u=P(c*kn,n),f=i===e,l=i===P(-e,n),x=i===P(-e*kn,n);return f&&(c=a),(l||x)&&(c=u),On(c,n)&&(c=P(-c,n)),{isValid:f||l,value:c}}var ds=Dn(ls,{uvRatio:hs});function ps(e){return Hn(ds,hn,Object.assign({adjustScalarBytes:Pn},e))}var et=ps({});var Nt=(()=>{let e=oe;return Fn({P:e,type:"x25519",powPminus2:t=>{let{pow_p_5_8:n,b2:r}=Kn(t);return P(Q(n,as,e)*r,e)},adjustScalarBytes:Pn})})();function gs(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function ie(e){if(typeof e!="boolean")throw new Error(`boolean expected, not ${e}`)}function ce(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function Z(e,t,n=""){let r=gs(e),s=e?.length,o=t!==void 0;if(!r||o&&s!==t){let c=n&&`"${n}" `,i=o?` of length ${t}`:"",a=r?`length=${s}`:`type=${typeof e}`;throw new Error(c+"expected Uint8Array"+i+", got "+a)}return e}function Ne(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Vn(e,t){Z(e,void 0,"output");let n=t.outputLen;if(e.length<n)throw new Error("digestInto() expects output buffer of length at least "+n)}function gt(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function xt(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function xs(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}var ms=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function zn(e,t){if(t==null||typeof t!="object")throw new Error("options must be defined");return Object.assign(e,t)}function Zn(e,t){if(e.length!==t.length)return!1;let n=0;for(let r=0;r<e.length;r++)n|=e[r]^t[r];return n===0}var Ue=(e,t)=>{function n(r,...s){if(Z(r,void 0,"key"),!ms)throw new Error("Non little-endian hardware is not yet supported");if(e.nonceLength!==void 0){let f=s[0];Z(f,e.varSizeNonce?void 0:e.nonceLength,"nonce")}let o=e.tagLength;o&&s[1]!==void 0&&Z(s[1],void 0,"AAD");let c=t(r,...s),i=(f,l)=>{if(l!==void 0){if(f!==2)throw new Error("cipher output not supported");Z(l,void 0,"output")}},a=!1;return{encrypt(f,l){if(a)throw new Error("cannot encrypt() twice with same key + nonce");return a=!0,Z(f),i(c.encrypt.length,l),c.encrypt(f,l)},decrypt(f,l){if(Z(f),o&&f.length<o)throw new Error('"ciphertext" expected length bigger than tagLength='+o);return i(c.decrypt.length,l),c.decrypt(f,l)}}}return Object.assign(n,e),n};function Me(e,t,n=!0){if(t===void 0)return new Uint8Array(e);if(t.length!==e)throw new Error('"output" expected Uint8Array of length '+e+", got: "+t.length);if(n&&!ys(t))throw new Error("invalid output, must be aligned");return t}function Gn(e,t,n){ie(n);let r=new Uint8Array(16),s=xs(r);return s.setBigUint64(0,BigInt(t),n),s.setBigUint64(8,BigInt(e),n),r}function ys(e){return e.byteOffset%4===0}function Ut(e){return Uint8Array.from(e)}var Yn=e=>Uint8Array.from(e.split(""),t=>t.charCodeAt(0)),bs=Yn("expand 16-byte k"),ws=Yn("expand 32-byte k"),Es=gt(bs),Bs=gt(ws);function L(e,t){return e<<t|e>>>32-t}function De(e){return e.byteOffset%4===0}var ae=64,As=16,jn=2**32-1,Xn=Uint32Array.of();function Ss(e,t,n,r,s,o,c,i){let a=s.length,u=new Uint8Array(ae),f=gt(u),l=De(s)&&De(o),x=l?gt(s):Xn,b=l?gt(o):Xn;for(let w=0;w<a;c++){if(e(t,n,r,f,c,i),c>=jn)throw new Error("arx: counter overflow");let E=Math.min(ae,a-w);if(l&&E===ae){let h=w/4;if(w%4!==0)throw new Error("arx: invalid block position");for(let O=0,p;O<As;O++)p=h+O,b[p]=x[p]^f[O];w+=ae;continue}for(let h=0,O;h<E;h++)O=w+h,o[O]=s[O]^u[h];w+=E}}function He(e,t){let{allowShortKeys:n,extendNonceFn:r,counterLength:s,counterRight:o,rounds:c}=zn({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if(typeof e!="function")throw new Error("core must be a function");return ce(s),ce(c),ie(o),ie(n),(i,a,u,f,l=0)=>{Z(i,void 0,"key"),Z(a,void 0,"nonce"),Z(u,void 0,"data");let x=u.length;if(f===void 0&&(f=new Uint8Array(x)),Z(f,void 0,"output"),ce(l),l<0||l>=jn)throw new Error("arx: counter overflow");if(f.length<x)throw new Error(`arx: output (${f.length}) is shorter than data (${x})`);let b=[],w=i.length,E,h;if(w===32)b.push(E=Ut(i)),h=Bs;else if(w===16&&n)E=new Uint8Array(32),E.set(i),E.set(i,16),h=Es,b.push(E);else throw Z(i,32,"arx key"),new Error("invalid key size");De(a)||b.push(a=Ut(a));let O=gt(E);if(r){if(a.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(h,O,gt(a.subarray(0,16)),O),a=a.subarray(16)}let p=16-s;if(p!==a.length)throw new Error(`arx: nonce must be ${p} or 16 bytes`);if(p!==12){let S=new Uint8Array(12);S.set(a,o?0:12-a.length),a=S,b.push(a)}let d=gt(a);return Ss(e,h,O,d,u,f,l,c),xt(...b),f}}function X(e,t){return e[t++]&255|(e[t++]&255)<<8}var Fe=class{constructor(t){y(this,"blockLen",16);y(this,"outputLen",16);y(this,"buffer",new Uint8Array(16));y(this,"r",new Uint16Array(10));y(this,"h",new Uint16Array(10));y(this,"pad",new Uint16Array(8));y(this,"pos",0);y(this,"finished",!1);t=Ut(Z(t,32,"key"));let n=X(t,0),r=X(t,2),s=X(t,4),o=X(t,6),c=X(t,8),i=X(t,10),a=X(t,12),u=X(t,14);this.r[0]=n&8191,this.r[1]=(n>>>13|r<<3)&8191,this.r[2]=(r>>>10|s<<6)&7939,this.r[3]=(s>>>7|o<<9)&8191,this.r[4]=(o>>>4|c<<12)&255,this.r[5]=c>>>1&8190,this.r[6]=(c>>>14|i<<2)&8191,this.r[7]=(i>>>11|a<<5)&8065,this.r[8]=(a>>>8|u<<8)&8191,this.r[9]=u>>>5&127;for(let f=0;f<8;f++)this.pad[f]=X(t,16+2*f)}process(t,n,r=!1){let s=r?0:2048,{h:o,r:c}=this,i=c[0],a=c[1],u=c[2],f=c[3],l=c[4],x=c[5],b=c[6],w=c[7],E=c[8],h=c[9],O=X(t,n+0),p=X(t,n+2),d=X(t,n+4),S=X(t,n+6),N=X(t,n+8),M=X(t,n+10),H=X(t,n+12),m=X(t,n+14),g=o[0]+(O&8191),A=o[1]+((O>>>13|p<<3)&8191),I=o[2]+((p>>>10|d<<6)&8191),T=o[3]+((d>>>7|S<<9)&8191),v=o[4]+((S>>>4|N<<12)&8191),_=o[5]+(N>>>1&8191),C=o[6]+((N>>>14|M<<2)&8191),R=o[7]+((M>>>11|H<<5)&8191),D=o[8]+((H>>>8|m<<8)&8191),U=o[9]+(m>>>5|s),B=0,F=B+g*i+A*(5*h)+I*(5*E)+T*(5*w)+v*(5*b);B=F>>>13,F&=8191,F+=_*(5*x)+C*(5*l)+R*(5*f)+D*(5*u)+U*(5*a),B+=F>>>13,F&=8191;let q=B+g*a+A*i+I*(5*h)+T*(5*E)+v*(5*w);B=q>>>13,q&=8191,q+=_*(5*b)+C*(5*x)+R*(5*l)+D*(5*f)+U*(5*u),B+=q>>>13,q&=8191;let k=B+g*u+A*a+I*i+T*(5*h)+v*(5*E);B=k>>>13,k&=8191,k+=_*(5*w)+C*(5*b)+R*(5*x)+D*(5*l)+U*(5*f),B+=k>>>13,k&=8191;let $=B+g*f+A*u+I*a+T*i+v*(5*h);B=$>>>13,$&=8191,$+=_*(5*E)+C*(5*w)+R*(5*b)+D*(5*x)+U*(5*l),B+=$>>>13,$&=8191;let W=B+g*l+A*f+I*u+T*a+v*i;B=W>>>13,W&=8191,W+=_*(5*h)+C*(5*E)+R*(5*w)+D*(5*b)+U*(5*x),B+=W>>>13,W&=8191;let ut=B+g*x+A*l+I*f+T*u+v*a;B=ut>>>13,ut&=8191,ut+=_*i+C*(5*h)+R*(5*E)+D*(5*w)+U*(5*b),B+=ut>>>13,ut&=8191;let rt=B+g*b+A*x+I*l+T*f+v*u;B=rt>>>13,rt&=8191,rt+=_*a+C*i+R*(5*h)+D*(5*E)+U*(5*w),B+=rt>>>13,rt&=8191;let st=B+g*w+A*b+I*x+T*l+v*f;B=st>>>13,st&=8191,st+=_*u+C*a+R*i+D*(5*h)+U*(5*E),B+=st>>>13,st&=8191;let ot=B+g*E+A*w+I*b+T*x+v*l;B=ot>>>13,ot&=8191,ot+=_*f+C*u+R*a+D*i+U*(5*h),B+=ot>>>13,ot&=8191;let lt=B+g*h+A*E+I*w+T*b+v*x;B=lt>>>13,lt&=8191,lt+=_*l+C*f+R*u+D*a+U*i,B+=lt>>>13,lt&=8191,B=(B<<2)+B|0,B=B+F|0,F=B&8191,B=B>>>13,q+=B,o[0]=F,o[1]=q,o[2]=k,o[3]=$,o[4]=W,o[5]=ut,o[6]=rt,o[7]=st,o[8]=ot,o[9]=lt}finalize(){let{h:t,pad:n}=this,r=new Uint16Array(10),s=t[1]>>>13;t[1]&=8191;for(let i=2;i<10;i++)t[i]+=s,s=t[i]>>>13,t[i]&=8191;t[0]+=s*5,s=t[0]>>>13,t[0]&=8191,t[1]+=s,s=t[1]>>>13,t[1]&=8191,t[2]+=s,r[0]=t[0]+5,s=r[0]>>>13,r[0]&=8191;for(let i=1;i<10;i++)r[i]=t[i]+s,s=r[i]>>>13,r[i]&=8191;r[9]-=8192;let o=(s^1)-1;for(let i=0;i<10;i++)r[i]&=o;o=~o;for(let i=0;i<10;i++)t[i]=t[i]&o|r[i];t[0]=(t[0]|t[1]<<13)&65535,t[1]=(t[1]>>>3|t[2]<<10)&65535,t[2]=(t[2]>>>6|t[3]<<7)&65535,t[3]=(t[3]>>>9|t[4]<<4)&65535,t[4]=(t[4]>>>12|t[5]<<1|t[6]<<14)&65535,t[5]=(t[6]>>>2|t[7]<<11)&65535,t[6]=(t[7]>>>5|t[8]<<8)&65535,t[7]=(t[8]>>>8|t[9]<<5)&65535;let c=t[0]+n[0];t[0]=c&65535;for(let i=1;i<8;i++)c=(t[i]+n[i]|0)+(c>>>16)|0,t[i]=c&65535;xt(r)}update(t){Ne(this),Z(t),t=Ut(t);let{buffer:n,blockLen:r}=this,s=t.length;for(let o=0;o<s;){let c=Math.min(r-this.pos,s-o);if(c===r){for(;r<=s-o;o+=r)this.process(t,o);continue}n.set(t.subarray(o,o+c),this.pos),this.pos+=c,o+=c,this.pos===r&&(this.process(n,0,!1),this.pos=0)}return this}destroy(){xt(this.h,this.r,this.buffer,this.pad)}digestInto(t){Ne(this),Vn(t,this),this.finished=!0;let{buffer:n,h:r}=this,{pos:s}=this;if(s){for(n[s++]=1;s<16;s++)n[s]=0;this.process(n,0,!0)}this.finalize();let o=0;for(let c=0;c<8;c++)t[o++]=r[c]>>>0,t[o++]=r[c]>>>8;return t}digest(){let{buffer:t,outputLen:n}=this;this.digestInto(t);let r=t.slice(0,n);return this.destroy(),r}};function Ls(e){let t=(r,s)=>e(s).update(r).digest(),n=e(new Uint8Array(32));return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=r=>e(r),t}var $n=Ls(e=>new Fe(e));function Jn(e,t,n,r,s,o=20){let c=e[0],i=e[1],a=e[2],u=e[3],f=t[0],l=t[1],x=t[2],b=t[3],w=t[4],E=t[5],h=t[6],O=t[7],p=s,d=n[0],S=n[1],N=n[2],M=c,H=i,m=a,g=u,A=f,I=l,T=x,v=b,_=w,C=E,R=h,D=O,U=p,B=d,F=S,q=N;for(let $=0;$<o;$+=2)M=M+A|0,U=L(U^M,16),_=_+U|0,A=L(A^_,12),M=M+A|0,U=L(U^M,8),_=_+U|0,A=L(A^_,7),H=H+I|0,B=L(B^H,16),C=C+B|0,I=L(I^C,12),H=H+I|0,B=L(B^H,8),C=C+B|0,I=L(I^C,7),m=m+T|0,F=L(F^m,16),R=R+F|0,T=L(T^R,12),m=m+T|0,F=L(F^m,8),R=R+F|0,T=L(T^R,7),g=g+v|0,q=L(q^g,16),D=D+q|0,v=L(v^D,12),g=g+v|0,q=L(q^g,8),D=D+q|0,v=L(v^D,7),M=M+I|0,q=L(q^M,16),R=R+q|0,I=L(I^R,12),M=M+I|0,q=L(q^M,8),R=R+q|0,I=L(I^R,7),H=H+T|0,U=L(U^H,16),D=D+U|0,T=L(T^D,12),H=H+T|0,U=L(U^H,8),D=D+U|0,T=L(T^D,7),m=m+v|0,B=L(B^m,16),_=_+B|0,v=L(v^_,12),m=m+v|0,B=L(B^m,8),_=_+B|0,v=L(v^_,7),g=g+A|0,F=L(F^g,16),C=C+F|0,A=L(A^C,12),g=g+A|0,F=L(F^g,8),C=C+F|0,A=L(A^C,7);let k=0;r[k++]=c+M|0,r[k++]=i+H|0,r[k++]=a+m|0,r[k++]=u+g|0,r[k++]=f+A|0,r[k++]=l+I|0,r[k++]=x+T|0,r[k++]=b+v|0,r[k++]=w+_|0,r[k++]=E+C|0,r[k++]=h+R|0,r[k++]=O+D|0,r[k++]=p+U|0,r[k++]=d+B|0,r[k++]=S+F|0,r[k++]=N+q|0}function _s(e,t,n,r){let s=e[0],o=e[1],c=e[2],i=e[3],a=t[0],u=t[1],f=t[2],l=t[3],x=t[4],b=t[5],w=t[6],E=t[7],h=n[0],O=n[1],p=n[2],d=n[3];for(let N=0;N<20;N+=2)s=s+a|0,h=L(h^s,16),x=x+h|0,a=L(a^x,12),s=s+a|0,h=L(h^s,8),x=x+h|0,a=L(a^x,7),o=o+u|0,O=L(O^o,16),b=b+O|0,u=L(u^b,12),o=o+u|0,O=L(O^o,8),b=b+O|0,u=L(u^b,7),c=c+f|0,p=L(p^c,16),w=w+p|0,f=L(f^w,12),c=c+f|0,p=L(p^c,8),w=w+p|0,f=L(f^w,7),i=i+l|0,d=L(d^i,16),E=E+d|0,l=L(l^E,12),i=i+l|0,d=L(d^i,8),E=E+d|0,l=L(l^E,7),s=s+u|0,d=L(d^s,16),w=w+d|0,u=L(u^w,12),s=s+u|0,d=L(d^s,8),w=w+d|0,u=L(u^w,7),o=o+f|0,h=L(h^o,16),E=E+h|0,f=L(f^E,12),o=o+f|0,h=L(h^o,8),E=E+h|0,f=L(f^E,7),c=c+l|0,O=L(O^c,16),x=x+O|0,l=L(l^x,12),c=c+l|0,O=L(O^c,8),x=x+O|0,l=L(l^x,7),i=i+a|0,p=L(p^i,16),b=b+p|0,a=L(a^b,12),i=i+a|0,p=L(p^i,8),b=b+p|0,a=L(a^b,7);let S=0;r[S++]=s,r[S++]=o,r[S++]=c,r[S++]=i,r[S++]=h,r[S++]=O,r[S++]=p,r[S++]=d}var Os=He(Jn,{counterRight:!1,counterLength:4,allowShortKeys:!1}),Cs=He(Jn,{counterRight:!1,counterLength:8,extendNonceFn:_s,allowShortKeys:!1});var Is=new Uint8Array(16),Wn=(e,t)=>{e.update(t);let n=t.length%16;n&&e.update(Is.subarray(n))},Ts=new Uint8Array(32);function Qn(e,t,n,r,s){s!==void 0&&Z(s,void 0,"AAD");let o=e(t,n,Ts),c=Gn(r.length,s?s.length:0,!0),i=$n.create(o);s&&Wn(i,s),Wn(i,r),i.update(c);let a=i.digest();return xt(o,c),a}var tr=e=>(t,n,r)=>({encrypt(o,c){let i=o.length;c=Me(i+16,c,!1),c.set(o);let a=c.subarray(0,-16);e(t,n,a,a,1);let u=Qn(e,t,n,a,r);return c.set(u,i),xt(u),c},decrypt(o,c){c=Me(o.length-16,c,!1);let i=o.subarray(0,-16),a=o.subarray(-16),u=Qn(e,t,n,i,r);if(!Zn(a,u))throw new Error("invalid tag");return c.set(o.subarray(0,-16)),e(t,n,c,c,1),xt(u),c}}),zo=Ue({blockSize:64,nonceLength:12,tagLength:16},tr(Os)),Mt=Ue({blockSize:64,nonceLength:24,tagLength:16},tr(Cs));var fe=class{constructor(t,n){y(this,"oHash");y(this,"iHash");y(this,"blockLen");y(this,"outputLen");y(this,"finished",!1);y(this,"destroyed",!1);if(Dt(t),K(n,void 0,"key"),this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let r=this.blockLen,s=new Uint8Array(r);s.set(n.length>r?t.create().update(n).digest():n);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=t.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),J(s)}update(t){return It(this),this.iHash.update(t),this}digestInto(t){It(this),K(t,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){let t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));let{oHash:n,iHash:r,finished:s,destroyed:o,blockLen:c,outputLen:i}=this;return t=t,t.finished=s,t.destroyed=o,t.blockLen=c,t.outputLen=i,t.oHash=n._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},ue=(e,t,n)=>new fe(e,t).update(n).digest();ue.create=(e,t)=>new fe(e,t);function vs(e,t,n){return Dt(e),n===void 0&&(n=new Uint8Array(e.outputLen)),ue(e,n,t)}var qe=Uint8Array.of(0),er=Uint8Array.of();function Rs(e,t,n,r=32){Dt(e),it(r,"length");let s=e.outputLen;if(r>255*s)throw new Error("Length must be <= 255*HashLen");let o=Math.ceil(r/s);n===void 0?n=er:K(n,void 0,"info");let c=new Uint8Array(o*s),i=ue.create(e,t),a=i._cloneInto(),u=new Uint8Array(i.outputLen);for(let f=0;f<o;f++)qe[0]=f+1,a.update(f===0?er:u).update(n).update(qe).digestInto(u),c.set(u,s*f),i._cloneInto(a);return i.destroy(),a.destroy(),J(u,qe),c.slice(0,r)}var Vt=(e,t,n,r,s)=>Rs(e,vs(e,t,n),r,s);var ke=ct;function Ns(e){e.fill(0)}function nr(e){if(e.length<32||e.every(r=>r===0))return!1;let t=e[0];if(e.every(r=>r===t))return!1;let n=0;for(let r=1;r<e.length;r++)e[r]===e[r-1]&&n++;return!(n>e.length*.8)}function rr(){let e=et.utils.randomSecretKey();if(!nr(e))throw new Error("Insufficient entropy for key generation");return{publicKey:et.getPublicKey(e),privateKey:e}}function sr(e,t){if(t.length!==32)throw new Error("Private key must be 32 bytes");return et.sign(e,t)}function or(e,t,n){try{return n.length!==32||t.length!==64?!1:et.verify(t,e,n)}catch{return!1}}function Us(e,t,n,r){if(e.length!==32)throw new Error("Private key must be 32 bytes");if(t.length!==32)throw new Error("Peer public key must be 32 bytes");let s=Nt.getSharedSecret(e,t),o=Vt(wt,s,n||new Uint8Array(32),r||new Uint8Array(0),32);return Ns(s),o}function ir(e){let t=ke(32);if(!nr(t))throw new Error("Insufficient entropy for session key generation");return{key:t,nonce:ke(24),timestamp:Date.now(),messageCount:0,counter:e||0}}function cr(e,t,n,r){if(t.length!==32)throw new Error("Encryption key must be 32 bytes");if(n.length!==24)throw new Error("Nonce must be 24 bytes for XChaCha20-Poly1305");return Mt(t,n).encrypt(e,r)}function ar(e,t,n,r){if(t.length!==32)throw new Error("Decryption key must be 32 bytes");if(n.length!==24)throw new Error("Nonce must be 24 bytes for XChaCha20-Poly1305");if(e.length<16)throw new Error("Ciphertext too short (must include 16-byte auth tag)");try{return Mt(t,n).decrypt(e,r)}catch{throw new Error("Decryption failed: authentication tag mismatch or corrupted data")}}function fr(e){let t=wt(e),n=Array.from(t).map(r=>r.toString(16).padStart(2,"0")).join("");return n.match(/.{1,4}/g)?.join(" ")||n}function ur(){return ke(24)}function lr(e,t,n,r){return Us(e,t,n,r)}var V;(function(e){e[e.TEXT=1]="TEXT",e[e.FILE_METADATA=2]="FILE_METADATA",e[e.FILE_CHUNK=3]="FILE_CHUNK",e[e.VOICE=4]="VOICE",e[e.CONTROL_ACK=16]="CONTROL_ACK",e[e.CONTROL_PING=17]="CONTROL_PING",e[e.CONTROL_PONG=18]="CONTROL_PONG",e[e.PEER_DISCOVERY=32]="PEER_DISCOVERY",e[e.PEER_INTRODUCTION=33]="PEER_INTRODUCTION",e[e.KEY_EXCHANGE=48]="KEY_EXCHANGE",e[e.SESSION_KEY=49]="SESSION_KEY"})(V||(V={}));var hr=1,dr=1,Ct=108,pr=1024*1024,gr=255,nt=class extends Error{constructor(t,n,r){super(t),this.field=n,this.value=r,this.name="MessageValidationError"}};function Ke(e){if(e.version<hr||e.version>dr)throw new nt(`Unsupported protocol version: ${e.version}. Supported: ${hr}-${dr}`,"version",e.version);if(!Object.values(V).filter(n=>typeof n=="number").includes(e.type))throw new nt(`Invalid message type: 0x${e.type.toString(16).padStart(2,"0")}`,"type",e.type);if(e.ttl<0||e.ttl>gr)throw new nt(`Invalid TTL: ${e.ttl}. Must be 0-${gr}`,"ttl",e.ttl);if(!Number.isSafeInteger(e.timestamp)||e.timestamp<0)throw new nt(`Invalid timestamp: ${e.timestamp}`,"timestamp",e.timestamp);if(e.senderId.length!==32)throw new nt(`Invalid sender ID length: ${e.senderId.length}. Expected: 32`,"senderId",e.senderId.length);if(e.signature.length!==64&&e.signature.length!==65)throw new nt(`Invalid signature length: ${e.signature.length}. Expected: 64 or 65`,"signature",e.signature.length)}function xr(e){if(Ke(e.header),e.payload.length>pr)throw new nt(`Payload too large: ${e.payload.length} bytes. Max: ${pr}`,"payload",e.payload.length)}function Ms(e){Ke(e);let t=new Uint8Array(Ct),n=0;t[n++]=e.version,t[n++]=e.type,t[n++]=e.ttl,t[n++]=0;let r=BigInt(e.timestamp);for(let s=7;s>=0;s--)t[n++]=Number(r>>BigInt(s*8)&BigInt(255));return t.set(e.senderId,n),n+=32,t.set(e.signature,n),t}function Ds(e){if(e.length<Ct)throw new nt(`Invalid header size: ${e.length} bytes. Expected: ${Ct} bytes`,"buffer",e.length);let t=0,n=e[t++],r=e[t++],s=e[t++];t++;let o=0;for(let u=0;u<8;u++)o=o*256+e[t++];let c=e.slice(t,t+32);t+=32;let i=e.slice(t,t+64),a={version:n,type:r,ttl:s,timestamp:o,senderId:c,signature:i};return Ke(a),a}function Pe(e){xr(e);let t=Ms(e.header),n=new Uint8Array(t.length+e.payload.length);return n.set(t,0),n.set(e.payload,t.length),n}function le(e){if(e.length<Ct)throw new nt(`Buffer too small: ${e.length} bytes. Minimum: ${Ct} bytes`,"buffer",e.length);let t=Ds(e.slice(0,Ct)),n=e.slice(Ct),r={header:t,payload:n};return xr(r),r}function Ve(e){let t=Pe(e),n=wt(t);return Array.from(n).map(r=>r.toString(16).padStart(2,"0")).join("")}var ft;(function(e){e.CONNECTING="connecting",e.CONNECTED="connected",e.DEGRADED="degraded",e.DISCONNECTED="disconnected"})(ft||(ft={}));function mr(e,t,n="webrtc"){return{id:e,publicKey:t,lastSeen:Date.now(),connectedAt:Date.now(),transportType:n,connectionQuality:100,bytesSent:0,bytesReceived:0,state:ft.CONNECTED,metadata:{capabilities:{supportedTransports:[n],protocolVersion:1,features:[]},reputation:50,blacklisted:!1,failureCount:0,successCount:0}}}var he=class{constructor(t={}){this.routes=new Map,this.peers=new Map,this.messageCache=new Map,this.bloomFilter=new Set,this.MAX_CACHE_SIZE=t.maxCacheSize||1e4,this.CACHE_TTL=t.cacheTTL||6e4,this.ROUTE_TTL=t.routeTTL||3e5,this.MAX_ROUTES=t.maxRoutes||1e4,this.ENABLE_BLOOM=t.enableBloomFilter!==!1}addPeer(t){t.state||(t.state=ft.CONNECTED),t.metadata||(t.metadata={capabilities:{supportedTransports:[t.transportType],protocolVersion:1,features:[]},reputation:50,blacklisted:!1,failureCount:0,successCount:0}),this.peers.set(t.id,t),this.routes.set(t.id,{destination:t.id,nextHop:t.id,hopCount:0,timestamp:Date.now(),metrics:{hopCount:0,latency:0,reliability:1,bandwidth:0,lastUsed:Date.now()},expiresAt:Date.now()+this.ROUTE_TTL})}removePeer(t){this.peers.delete(t),this.routes.delete(t);for(let[n,r]of this.routes.entries())r.nextHop===t&&this.routes.delete(n)}getPeer(t){return this.peers.get(t)}getAllPeers(){return Array.from(this.peers.values())}updatePeerLastSeen(t){let n=this.peers.get(t);n&&(n.lastSeen=Date.now())}addRoute(t){let n=this.routes.get(t.destination);(!n||this.shouldReplaceRoute(n,t))&&(t.expiresAt||(t.expiresAt=Date.now()+this.ROUTE_TTL),this.routes.set(t.destination,t),this.cleanupExpiredRoutes())}shouldReplaceRoute(t,n){if(t.expiresAt<Date.now()||n.metrics.hopCount<t.metrics.hopCount)return!0;if(n.metrics.hopCount===t.metrics.hopCount){if(n.metrics.latency<t.metrics.latency)return!0;if(n.metrics.latency===t.metrics.latency){if(n.metrics.reliability>t.metrics.reliability)return!0;let r=n.metrics.bandwidth||0,s=t.metrics.bandwidth||0;if(n.metrics.reliability===t.metrics.reliability&&r>s)return!0}if(n.metrics.latency===t.metrics.latency&&n.metrics.reliability===t.metrics.reliability&&(n.metrics.bandwidth||0)===(t.metrics.bandwidth||0)&&n.timestamp>t.timestamp)return!0}return!1}cleanupExpiredRoutes(){if(this.routes.size<this.MAX_ROUTES)return;let t=Date.now(),n=[];for(let[r,s]of this.routes.entries())s.expiresAt<t&&n.push(r);if(n.forEach(r=>this.routes.delete(r)),this.routes.size>=this.MAX_ROUTES){let r=Array.from(this.routes.entries()).sort((o,c)=>o[1].metrics.lastUsed-c[1].metrics.lastUsed),s=this.routes.size-this.MAX_ROUTES+100;for(let o=0;o<s&&o<r.length;o++)this.routes.delete(r[o][0])}}updateRouteMetrics(t,n,r,s){let o=this.routes.get(t);if(o){o.metrics.latency=n,o.metrics.lastUsed=Date.now();let c=.3;o.metrics.reliability=c*(r?1:0)+(1-c)*o.metrics.reliability,s!==void 0&&(o.metrics.bandwidth=s)}}getNextHop(t){return this.routes.get(t)?.nextHop}hasSeenMessage(t){return this.ENABLE_BLOOM&&!this.bloomFilter.has(t)?!1:this.messageCache.has(t)}markMessageSeen(t){this.messageCache.set(t,Date.now()),this.ENABLE_BLOOM&&this.bloomFilter.add(t),this.cleanupMessageCache()}cleanupMessageCache(){let t=Date.now();if(this.messageCache.size<this.MAX_CACHE_SIZE){let s=[];for(let[o,c]of this.messageCache.entries())t-c>this.CACHE_TTL&&s.push(o);s.forEach(o=>{this.messageCache.delete(o),this.ENABLE_BLOOM&&this.bloomFilter.delete(o)});return}let n=Array.from(this.messageCache.entries()).sort((s,o)=>s[1]-o[1]),r=this.messageCache.size-this.MAX_CACHE_SIZE+100;for(let s=0;s<r&&s<n.length;s++)this.messageCache.delete(n[s][0]),this.ENABLE_BLOOM&&this.bloomFilter.delete(n[s][0])}updatePeerReputation(t,n){let r=this.peers.get(t);r&&(n?(r.metadata.successCount++,r.metadata.reputation=Math.min(100,r.metadata.reputation+1)):(r.metadata.failureCount++,r.metadata.reputation=Math.max(0,r.metadata.reputation-2)),r.metadata.reputation<20?r.state=ft.DEGRADED:r.state===ft.DEGRADED&&r.metadata.reputation>40&&(r.state=ft.CONNECTED))}blacklistPeer(t,n){let r=this.peers.get(t);r&&(r.metadata.blacklisted=!0,n&&(r.metadata.blacklistExpiry=Date.now()+n),r.state=ft.DISCONNECTED)}unblacklistPeer(t){let n=this.peers.get(t);n&&(n.metadata.blacklisted=!1,n.metadata.blacklistExpiry=void 0)}cleanupBlacklists(){let t=Date.now();for(let n of this.peers.values())n.metadata.blacklisted&&n.metadata.blacklistExpiry&&n.metadata.blacklistExpiry<t&&this.unblacklistPeer(n.id)}isPeerBlacklisted(t){let n=this.peers.get(t);return n?n.metadata.blacklisted&&n.metadata.blacklistExpiry&&n.metadata.blacklistExpiry<Date.now()?(this.unblacklistPeer(t),!1):n.metadata.blacklisted:!1}removeStalepeers(t=6e4){let n=Date.now(),r=[];for(let[s,o]of this.peers.entries())n-o.lastSeen>t&&r.push(s);return r.forEach(s=>this.removePeer(s)),r}getMemoryUsage(){let t={routes:this.routes.size*100,peers:this.peers.size*200,messageCache:this.messageCache.size*50,bloomFilter:this.bloomFilter.size*50};return{bytes:Object.values(t).reduce((r,s)=>r+s,0),breakdown:t}}getStats(){return{peerCount:this.peers.size,routeCount:this.routes.size,cacheSize:this.messageCache.size,memoryUsage:this.getMemoryUsage().bytes}}},de=class{constructor(){this.queues=new Map,this.priorities=[V.CONTROL_PING,V.CONTROL_PONG,V.CONTROL_ACK,V.VOICE,V.TEXT,V.FILE_CHUNK,V.FILE_METADATA],this.ESCALATION_THRESHOLD=3e4,this.STARVATION_CHECK_INTERVAL=5e3,this.lastStarvationCheck=Date.now()}enqueue(t,n){this.queues.has(t)||this.queues.set(t,[]),this.queues.get(t).push({message:n,timestamp:Date.now(),originalPriority:t})}dequeue(){let t=Date.now();t-this.lastStarvationCheck>this.STARVATION_CHECK_INTERVAL&&(this.preventStarvation(),this.lastStarvationCheck=t);for(let n of this.priorities){let r=this.queues.get(n);if(r&&r.length>0)return r.shift()?.message||null}return null}preventStarvation(){let t=Date.now();for(let n=this.priorities.length-1;n>0;n--){let r=this.priorities[n],s=this.queues.get(r);if(!s||s.length===0)continue;let o=[],c=[];for(let i of s)t-i.timestamp>this.ESCALATION_THRESHOLD?o.push(i):c.push(i);if(this.queues.set(r,c),o.length>0){let i=this.priorities[n-1];this.queues.has(i)||this.queues.set(i,[]),this.queues.get(i).push(...o)}}}size(){let t=0;for(let n of this.queues.values())t+=n.length;return t}getSizeByPriority(){let t=new Map;for(let[n,r]of this.queues.entries())t.set(n,r.length);return t}getOldestMessageAge(){let t=Date.now(),n=0;for(let r of this.queues.values())for(let s of r){let o=t-s.timestamp;o>n&&(n=o)}return n}clear(){this.queues.clear()}};var ze=1,yr=new TextEncoder().encode("SC-Envelope-v1");function br(e,t,n){if(t.length!==32)throw new Error("Sender private key must be 32 bytes");if(n.length!==32)throw new Error("Recipient public key must be 32 bytes");let r=ct(32),s=Nt.getPublicKey(r),o=Nt.getSharedSecret(r,n),c=Vt(wt,o,s,yr,32),i=ct(24),u=Mt(c,i).encrypt(e),f=Date.now(),l=new Uint8Array([...s,...i,...u,...Bt(f),ze]),x=et.sign(l,t);return r.fill(0),o.fill(0),c.fill(0),{ephemeralPublicKey:s,nonce:i,ciphertext:u,signature:x,timestamp:f,version:ze}}function wr(e,t,n){if(t.length!==32)throw new Error("Recipient private key must be 32 bytes");if(n.length!==32)throw new Error("Sender public key must be 32 bytes");if(e.version!==ze)throw new Error(`Unsupported envelope version: ${e.version}`);let r=new Uint8Array([...e.ephemeralPublicKey,...e.nonce,...e.ciphertext,...Bt(e.timestamp),e.version]);if(!et.verify(e.signature,r,n))throw new Error("Envelope signature verification failed");let o=Nt.getSharedSecret(t,e.ephemeralPublicKey),c=Vt(wt,o,e.ephemeralPublicKey,yr,32);try{let a=Mt(c,e.nonce).decrypt(e.ciphertext);return o.fill(0),c.fill(0),a}catch{throw o.fill(0),c.fill(0),new Error("Envelope decryption failed: authentication tag mismatch")}}function Er(e,t){if(t.length!==32)throw new Error("Private key must be 32 bytes");let n=et.getPublicKey(t),r=Date.now(),s=new Uint8Array([...e,...Bt(r)]),o=et.sign(s,t);return{data:e,signature:o,senderPublicKey:n,timestamp:r}}function Br(e,t){if(t){if(e.senderPublicKey.length!==t.length)return!1;for(let r=0;r<t.length;r++)if(e.senderPublicKey[r]!==t[r])return!1}let n=new Uint8Array([...e.data,...Bt(e.timestamp)]);try{return et.verify(e.signature,n,e.senderPublicKey)}catch{return!1}}function Ar(e){let t=Bt(e.timestamp),n=Bt(e.ciphertext.length);return new Uint8Array([e.version,...e.ephemeralPublicKey,...e.nonce,...n,...e.ciphertext,...e.signature,...t])}function Sr(e){if(e.length<137)throw new Error("Invalid envelope: too short");let t=0,n=e[t++],r=e.slice(t,t+32);t+=32;let s=e.slice(t,t+24);t+=24;let o=pe(e.slice(t,t+8));t+=8;let c=e.slice(t,t+o);t+=o;let i=e.slice(t,t+64);t+=64;let a=pe(e.slice(t,t+8));return{version:n,ephemeralPublicKey:r,nonce:s,ciphertext:c,signature:i,timestamp:a}}function Lr(e){let t=Bt(e.timestamp),n=Bt(e.data.length);return new Uint8Array([...e.senderPublicKey,...n,...e.data,...e.signature,...t])}function _r(e){if(e.length<112)throw new Error("Invalid envelope: too short");let t=0,n=e.slice(t,t+32);t+=32;let r=pe(e.slice(t,t+8));t+=8;let s=e.slice(t,t+r);t+=r;let o=e.slice(t,t+64);t+=64;let c=pe(e.slice(t,t+8));return{senderPublicKey:n,data:s,signature:o,timestamp:c}}function Bt(e){let t=new Uint8Array(8),n=e;for(let r=7;r>=0;r--)t[r]=n&255,n=Math.floor(n/256);return t}function pe(e){let t=0;for(let n=0;n<8;n++)t=t*256+e[n];return t}var zt=class{constructor(){this.factories=new Map}register(t,n){this.factories.set(t,n)}get(t){return this.factories.get(t)}getTypes(){return Array.from(this.factories.keys())}},xi=new zt;async function Or(e){let t;typeof e=="string"?e.match(/^[0-9a-fA-F]+$/)?t=Hs(e):t=Fs(e):t=e;let n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(s=>s.toString(16).padStart(2,"0")).join("").toUpperCase()}function Cr(e){return e.match(/.{1,4}/g)?.join(" ")||e}function Ir(e){if(typeof e=="string"){if(e.match(/^[0-9a-fA-F]{64}$/))return!0;try{return atob(e).length===32}catch{return!1}}else return e.length===32}function Tr(e){return btoa(String.fromCharCode(...e))}function vr(e){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n}function Hs(e){let t=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2)t[n/2]=parseInt(e.substr(n,2),16);return t}function Fs(e){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n}function Rr(e,t){return e.toUpperCase().replace(/\s/g,"")===t.toUpperCase().replace(/\s/g,"")}var Ze=class{constructor(){this.storage=new Map}async saveMessage(t,n){this.storage.set(t,n)}async getMessage(t){return this.storage.get(t)||null}async removeMessage(t){this.storage.delete(t)}async getAllMessages(){return new Map(this.storage)}async pruneExpired(t){for(let[n,r]of this.storage.entries())r.expiresAt<t&&this.storage.delete(n)}async size(){return this.storage.size}},ge=class{constructor(t,n,r={},s){this.stats={messagesReceived:0,messagesForwarded:0,messagesDuplicate:0,messagesExpired:0,messagesForSelf:0,messagesStored:0,relayFailures:0,loopsDetected:0},this.messageRoutes=new Map,this.peerFloodCounter=new Map,this.localPeerId=t,this.routingTable=n,this.config={maxStoredMessages:r.maxStoredMessages||1e3,storeTimeout:r.storeTimeout||3e5,maxRetries:r.maxRetries||3,retryBackoff:r.retryBackoff||5e3,floodRateLimit:r.floodRateLimit||100,selectiveFlooding:r.selectiveFlooding!==!1},this.persistence=s||new Ze}async processMessage(t,n){this.stats.messagesReceived++;let r;try{r=le(t)}catch(c){console.error("Failed to decode message:",c);return}let s=Ve(r);if(this.routingTable.hasSeenMessage(s)){this.stats.messagesDuplicate++;return}if(this.detectLoop(s,n)){this.stats.loopsDetected++;return}if(this.routingTable.markMessageSeen(s),r.header.ttl===0){this.stats.messagesExpired++;return}if(!this.checkFloodRateLimit(n))return;if(this.isMessageForSelf(r)){this.stats.messagesForSelf++,this.onMessageForSelfCallback?.(r);return}let o={header:{...r.header,ttl:r.header.ttl-1},payload:r.payload};o.header.ttl>0&&this.shouldForwardMessage(o)&&(this.stats.messagesForwarded++,this.onForwardMessageCallback?.(o,n))}detectLoop(t,n){this.messageRoutes.has(t)||this.messageRoutes.set(t,[]);let r=this.messageRoutes.get(t);if(r.includes(n))return!0;if(r.push(n),this.messageRoutes.size>1e4){let s=Array.from(this.messageRoutes.keys());for(let o=0;o<1e3;o++)this.messageRoutes.delete(s[o])}return!1}checkFloodRateLimit(t){let n=Date.now();this.peerFloodCounter.has(t)||this.peerFloodCounter.set(t,[]);let s=this.peerFloodCounter.get(t).filter(o=>n-o<1e3);return s.length>=this.config.floodRateLimit?!1:(s.push(n),this.peerFloodCounter.set(t,s),!0)}shouldForwardMessage(t){return!this.config.selectiveFlooding||this.isControlMessage(t.header.type),!0}isControlMessage(t){return t===V.CONTROL_PING||t===V.CONTROL_PONG||t===V.CONTROL_ACK}isMessageForSelf(t){return!!this.isBroadcastMessage(t.header.type)}isBroadcastMessage(t){return t===V.PEER_DISCOVERY||t===V.PEER_INTRODUCTION||t===V.CONTROL_PING||t===V.CONTROL_PONG}async storeMessage(t,n){if(await this.persistence.size()>=this.config.maxStoredMessages){let o=await this.persistence.getAllMessages(),c=Array.from(o.entries()).sort((i,a)=>i[1].lastAttempt-a[1].lastAttempt)[0];c&&await this.persistence.removeMessage(c[0])}let s=Ve(t);await this.persistence.saveMessage(s,{message:t,destinationPeerId:n,attempts:0,lastAttempt:Date.now(),expiresAt:Date.now()+this.config.storeTimeout}),this.stats.messagesStored++}async retryStoredMessages(){let t=Date.now(),n=[],r=await this.persistence.getAllMessages();for(let[s,o]of r.entries()){if(o.expiresAt<t){n.push(s);continue}if(!this.routingTable.getPeer(o.destinationPeerId))continue;let i=t-o.lastAttempt,a=this.config.retryBackoff*Math.pow(2,o.attempts);i<a||(o.attempts++,o.lastAttempt=t,o.attempts>this.config.maxRetries?(n.push(s),this.stats.relayFailures++):(this.onForwardMessageCallback?.(o.message,""),await this.persistence.saveMessage(s,o)))}for(let s of n)await this.persistence.removeMessage(s)}async getStoredMessagesStats(){let t=await this.persistence.getAllMessages();return{total:t.size,byDestination:Array.from(t.values()).reduce((n,r)=>(n[r.destinationPeerId]=(n[r.destinationPeerId]||0)+1,n),{})}}onMessageForSelf(t){this.onMessageForSelfCallback=t}onForwardMessage(t){this.onForwardMessageCallback=t}getStats(){return{...this.stats}}resetStats(){this.stats={messagesReceived:0,messagesForwarded:0,messagesDuplicate:0,messagesExpired:0,messagesForSelf:0,messagesStored:0,relayFailures:0,loopsDetected:0}}};var qs="0.1.0",ks=!0;return Kr(Ks);})();
/*! Bundled license information:

@noble/hashes/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/edwards.js:
@noble/curves/abstract/montgomery.js:
@noble/curves/ed25519.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/ciphers/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)
*/
//# sourceMappingURL=sc-core.bundle.js.map
