"use strict";var SCCore=(()=>{var re=Object.defineProperty;var ur=Object.getOwnPropertyDescriptor;var pr=Object.getOwnPropertyNames;var gr=Object.prototype.hasOwnProperty;var mr=(e,t,n)=>t in e?re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var At=(e,t)=>()=>(e&&(t=e(e=0)),t);var yr=(e,t)=>{for(var n in t)re(e,n,{get:t[n],enumerable:!0})},xr=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of pr(t))!gr.call(e,r)&&r!==n&&re(e,r,{get:()=>t[r],enumerable:!(s=ur(t,r))||s.enumerable});return e};var br=e=>xr(re({},"__esModule",{value:!0}),e);var w=(e,t,n)=>mr(e,typeof t!="symbol"?t+"":t,n);function oe(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function lt(e,t=""){if(!Number.isSafeInteger(e)||e<0){let n=t&&`"${t}" `;throw new Error(`${n}expected integer >= 0, got ${e}`)}}function q(e,t,n=""){let s=oe(e),r=e?.length,o=t!==void 0;if(!s||o&&r!==t){let i=n&&`"${n}" `,a=o?` of length ${t}`:"",c=s?`length=${r}`:`type=${typeof e}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return e}function $t(e){if(typeof e!="function"||typeof e.create!="function")throw new Error("Hash must wrapped by utils.createHasher");lt(e.outputLen),lt(e.blockLen)}function Mt(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Nn(e,t){q(e,void 0,"digestInto() output");let n=t.outputLen;if(e.length<n)throw new Error('"digestInto() output" expected to be of length >='+n)}function nt(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function ie(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function st(e,t){return e<<32-t|e>>>t}function Ht(e){if(q(e),Dn)return e.toHex();let t="";for(let n=0;n<e.length;n++)t+=wr[e[n]];return t}function Cn(e){if(e>=gt._0&&e<=gt._9)return e-gt._0;if(e>=gt.A&&e<=gt.F)return e-(gt.A-10);if(e>=gt.a&&e<=gt.f)return e-(gt.a-10)}function Zt(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);if(Dn)return Uint8Array.fromHex(e);let t=e.length,n=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);let s=new Uint8Array(n);for(let r=0,o=0;r<n;r++,o+=2){let i=Cn(e.charCodeAt(o)),a=Cn(e.charCodeAt(o+1));if(i===void 0||a===void 0){let c=e[o]+e[o+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+o)}s[r]=i*16+a}return s}function jt(...e){let t=0;for(let s=0;s<e.length;s++){let r=e[s];q(r),t+=r.length}let n=new Uint8Array(t);for(let s=0,r=0;s<e.length;s++){let o=e[s];n.set(o,r),r+=o.length}return n}function ke(e,t={}){let n=(r,o)=>e(o).update(r).digest(),s=e(void 0);return n.outputLen=s.outputLen,n.blockLen=s.blockLen,n.create=r=>e(r),Object.assign(n,t),Object.freeze(n)}function ft(e=32){let t=typeof globalThis=="object"?globalThis.crypto:null;if(typeof t?.getRandomValues!="function")throw new Error("crypto.getRandomValues must be defined");return t.getRandomValues(new Uint8Array(e))}var Dn,wr,gt,Re,mt=At(()=>{Dn=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",wr=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));gt={_0:48,_9:57,A:65,F:70,a:97,f:102};Re=e=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,e])})});function An(e,t,n){return e&t^~e&n}function Bn(e,t,n){return e&t^e&n^t&n}var Yt,yt,Z,vn=At(()=>{mt();Yt=class{constructor(t,n,s,r){w(this,"blockLen");w(this,"outputLen");w(this,"padOffset");w(this,"isLE");w(this,"buffer");w(this,"view");w(this,"finished",!1);w(this,"length",0);w(this,"pos",0);w(this,"destroyed",!1);this.blockLen=t,this.outputLen=n,this.padOffset=s,this.isLE=r,this.buffer=new Uint8Array(t),this.view=ie(this.buffer)}update(t){Mt(this),q(t);let{view:n,buffer:s,blockLen:r}=this,o=t.length;for(let i=0;i<o;){let a=Math.min(r-this.pos,o-i);if(a===r){let c=ie(t);for(;r<=o-i;i+=r)this.process(c,i);continue}s.set(t.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===r&&(this.process(n,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){Mt(this),Nn(t,this),this.finished=!0;let{buffer:n,view:s,blockLen:r,isLE:o}=this,{pos:i}=this;n[i++]=128,nt(this.buffer.subarray(i)),this.padOffset>r-i&&(this.process(s,0),i=0);for(let l=i;l<r;l++)n[l]=0;s.setBigUint64(r-8,BigInt(this.length*8),o),this.process(s,0);let a=ie(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen must be aligned to 32bit");let f=c/4,h=this.get();if(f>h.length)throw new Error("_sha2: outputLen bigger than state");for(let l=0;l<f;l++)a.setUint32(4*l,h[l],o)}digest(){let{buffer:t,outputLen:n}=this;this.digestInto(t);let s=t.slice(0,n);return this.destroy(),s}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());let{blockLen:n,buffer:s,length:r,finished:o,destroyed:i,pos:a}=this;return t.destroyed=i,t.finished=o,t.length=r,t.pos=a,r%n&&t.buffer.set(s),t}clone(){return this._cloneInto()}},yt=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Z=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209])});function Er(e,t=!1){return t?{h:Number(e&ae),l:Number(e>>_n&ae)}:{h:Number(e>>_n&ae)|0,l:Number(e&ae)|0}}function On(e,t=!1){let n=e.length,s=new Uint32Array(n),r=new Uint32Array(n);for(let o=0;o<n;o++){let{h:i,l:a}=Er(e[o],t);[s[o],r[o]]=[i,a]}return[s,r]}function ht(e,t,n,s){let r=(t>>>0)+(s>>>0);return{h:e+n+(r/2**32|0)|0,l:r|0}}var ae,_n,Pe,Me,Bt,vt,Xt,Wt,Ln,kn,Rn,Pn,Mn,Hn,Un=At(()=>{ae=BigInt(4294967295),_n=BigInt(32);Pe=(e,t,n)=>e>>>n,Me=(e,t,n)=>e<<32-n|t>>>n,Bt=(e,t,n)=>e>>>n|t<<32-n,vt=(e,t,n)=>e<<32-n|t>>>n,Xt=(e,t,n)=>e<<64-n|t>>>n-32,Wt=(e,t,n)=>e>>>n-32|t<<64-n;Ln=(e,t,n)=>(e>>>0)+(t>>>0)+(n>>>0),kn=(e,t,n,s)=>t+n+s+(e/2**32|0)|0,Rn=(e,t,n,s)=>(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0),Pn=(e,t,n,s,r)=>t+n+s+r+(e/2**32|0)|0,Mn=(e,t,n,s,r)=>(e>>>0)+(t>>>0)+(n>>>0)+(s>>>0)+(r>>>0),Hn=(e,t,n,s,r,o)=>t+n+s+r+o+(e/2**32|0)|0});var Ir,St,He,Ue,Fn,Tr,Cr,It,Tt,Fe,Ke,Q,Kn,_t=At(()=>{vn();Un();mt();Ir=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),St=new Uint32Array(64),He=class extends Yt{constructor(t){super(64,t,8,!1)}get(){let{A:t,B:n,C:s,D:r,E:o,F:i,G:a,H:c}=this;return[t,n,s,r,o,i,a,c]}set(t,n,s,r,o,i,a,c){this.A=t|0,this.B=n|0,this.C=s|0,this.D=r|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(t,n){for(let l=0;l<16;l++,n+=4)St[l]=t.getUint32(n,!1);for(let l=16;l<64;l++){let d=St[l-15],b=St[l-2],x=st(d,7)^st(d,18)^d>>>3,E=st(b,17)^st(b,19)^b>>>10;St[l]=E+St[l-7]+x+St[l-16]|0}let{A:s,B:r,C:o,D:i,E:a,F:c,G:f,H:h}=this;for(let l=0;l<64;l++){let d=st(a,6)^st(a,11)^st(a,25),b=h+d+An(a,c,f)+Ir[l]+St[l]|0,E=(st(s,2)^st(s,13)^st(s,22))+Bn(s,r,o)|0;h=f,f=c,c=a,a=i+b|0,i=o,o=r,r=s,s=b+E|0}s=s+this.A|0,r=r+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,f=f+this.G|0,h=h+this.H|0,this.set(s,r,o,i,a,c,f,h)}roundClean(){nt(St)}destroy(){this.set(0,0,0,0,0,0,0,0),nt(this.buffer)}},Ue=class extends He{constructor(){super(32);w(this,"A",yt[0]|0);w(this,"B",yt[1]|0);w(this,"C",yt[2]|0);w(this,"D",yt[3]|0);w(this,"E",yt[4]|0);w(this,"F",yt[5]|0);w(this,"G",yt[6]|0);w(this,"H",yt[7]|0)}},Fn=On(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(e=>BigInt(e))),Tr=Fn[0],Cr=Fn[1],It=new Uint32Array(80),Tt=new Uint32Array(80),Fe=class extends Yt{constructor(t){super(128,t,16,!1)}get(){let{Ah:t,Al:n,Bh:s,Bl:r,Ch:o,Cl:i,Dh:a,Dl:c,Eh:f,El:h,Fh:l,Fl:d,Gh:b,Gl:x,Hh:E,Hl:u}=this;return[t,n,s,r,o,i,a,c,f,h,l,d,b,x,E,u]}set(t,n,s,r,o,i,a,c,f,h,l,d,b,x,E,u){this.Ah=t|0,this.Al=n|0,this.Bh=s|0,this.Bl=r|0,this.Ch=o|0,this.Cl=i|0,this.Dh=a|0,this.Dl=c|0,this.Eh=f|0,this.El=h|0,this.Fh=l|0,this.Fl=d|0,this.Gh=b|0,this.Gl=x|0,this.Hh=E|0,this.Hl=u|0}process(t,n){for(let p=0;p<16;p++,n+=4)It[p]=t.getUint32(n),Tt[p]=t.getUint32(n+=4);for(let p=16;p<80;p++){let T=It[p-15]|0,L=Tt[p-15]|0,R=Bt(T,L,1)^Bt(T,L,8)^Pe(T,L,7),H=vt(T,L,1)^vt(T,L,8)^Me(T,L,7),y=It[p-2]|0,m=Tt[p-2]|0,I=Bt(y,m,19)^Xt(y,m,61)^Pe(y,m,6),B=vt(y,m,19)^Wt(y,m,61)^Me(y,m,6),v=Rn(H,B,Tt[p-7],Tt[p-16]),_=Pn(v,R,I,It[p-7],It[p-16]);It[p]=_|0,Tt[p]=v|0}let{Ah:s,Al:r,Bh:o,Bl:i,Ch:a,Cl:c,Dh:f,Dl:h,Eh:l,El:d,Fh:b,Fl:x,Gh:E,Gl:u,Hh:D,Hl:g}=this;for(let p=0;p<80;p++){let T=Bt(l,d,14)^Bt(l,d,18)^Xt(l,d,41),L=vt(l,d,14)^vt(l,d,18)^Wt(l,d,41),R=l&b^~l&E,H=d&x^~d&u,y=Mn(g,L,H,Cr[p],Tt[p]),m=Hn(y,D,T,R,Tr[p],It[p]),I=y|0,B=Bt(s,r,28)^Xt(s,r,34)^Xt(s,r,39),v=vt(s,r,28)^Wt(s,r,34)^Wt(s,r,39),_=s&o^s&a^o&a,N=r&i^r&c^i&c;D=E|0,g=u|0,E=b|0,u=x|0,b=l|0,x=d|0,{h:l,l:d}=ht(f|0,h|0,m|0,I|0),f=a|0,h=c|0,a=o|0,c=i|0,o=s|0,i=r|0;let A=Ln(I,v,N);s=kn(A,m,B,_),r=A|0}({h:s,l:r}=ht(this.Ah|0,this.Al|0,s|0,r|0)),{h:o,l:i}=ht(this.Bh|0,this.Bl|0,o|0,i|0),{h:a,l:c}=ht(this.Ch|0,this.Cl|0,a|0,c|0),{h:f,l:h}=ht(this.Dh|0,this.Dl|0,f|0,h|0),{h:l,l:d}=ht(this.Eh|0,this.El|0,l|0,d|0),{h:b,l:x}=ht(this.Fh|0,this.Fl|0,b|0,x|0),{h:E,l:u}=ht(this.Gh|0,this.Gl|0,E|0,u|0),{h:D,l:g}=ht(this.Hh|0,this.Hl|0,D|0,g|0),this.set(s,r,o,i,a,c,f,h,l,d,b,x,E,u,D,g)}roundClean(){nt(It,Tt)}destroy(){nt(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}},Ke=class extends Fe{constructor(){super(64);w(this,"Ah",Z[0]|0);w(this,"Al",Z[1]|0);w(this,"Bh",Z[2]|0);w(this,"Bl",Z[3]|0);w(this,"Ch",Z[4]|0);w(this,"Cl",Z[5]|0);w(this,"Dh",Z[6]|0);w(this,"Dl",Z[7]|0);w(this,"Eh",Z[8]|0);w(this,"El",Z[9]|0);w(this,"Fh",Z[10]|0);w(this,"Fl",Z[11]|0);w(this,"Gh",Z[12]|0);w(this,"Gl",Z[13]|0);w(this,"Hh",Z[14]|0);w(this,"Hl",Z[15]|0)}},Q=ke(()=>new Ue,Re(1)),Kn=ke(()=>new Ke,Re(3))});var zs,cn,te=At(()=>{"use strict";(function(e){e.FIND_NODE="FIND_NODE",e.FIND_NODE_RESPONSE="FIND_NODE_RESPONSE",e.FIND_VALUE="FIND_VALUE",e.FIND_VALUE_RESPONSE="FIND_VALUE_RESPONSE",e.FIND_VALUE_NODES="FIND_VALUE_NODES",e.STORE="STORE",e.STORE_RESPONSE="STORE_RESPONSE",e.PING="PING",e.PONG="PONG"})(zs||(zs={}));(function(e){e.DISCONNECTED="DISCONNECTED",e.BOOTSTRAPPING="BOOTSTRAPPING",e.DEGRADED="DEGRADED",e.CONNECTED="CONNECTED"})(cn||(cn={}))});function ee(e){return Q(e).slice(0,Ne)}function ln(e){let t=typeof e=="string"?new TextEncoder().encode(e):e;return Q(t).slice(0,Ne)}var Ne,Gs,Pt=At(()=>{"use strict";_t();Ne=20,Gs=Ne*8});var dn=At(()=>{"use strict";te();Pt()});var Ao={};yr(Ao,{DefaultTransportRegistry:()=>se,MOBILE_BUNDLE:()=>Do,MeshNetwork:()=>Oe,MessageRelay:()=>Gt,MessageType:()=>M,PeerState:()=>W,RoutingTable:()=>zt,VERSION:()=>No,base64ToPublicKey:()=>tr,compareFingerprints:()=>er,createPeer:()=>De,decodeMessage:()=>Ce,decryptEnvelope:()=>rr,decryptMessage:()=>Rs,deriveSharedSecret:()=>Hs,deserializeEncryptedEnvelope:()=>cr,deserializeSignedEnvelope:()=>fr,encodeMessage:()=>z,encryptEnvelope:()=>sr,encryptMessage:()=>ks,formatFingerprint:()=>Ws,generateFingerprint:()=>Ps,generateFullFingerprint:()=>Xs,generateIdentity:()=>Te,generateNonce:()=>Ms,generateSessionKey:()=>Ls,isValidPublicKey:()=>Js,publicKeyToBase64:()=>Qs,serializeEncryptedEnvelope:()=>ar,serializeSignedEnvelope:()=>lr,signEnvelope:()=>or,signMessage:()=>dt,verifyEnvelope:()=>ir,verifySignature:()=>Os});_t();mt();mt();var Vn=BigInt(0),qn=BigInt(1);function le(e,t=""){if(typeof e!="boolean"){let n=t&&`"${t}" `;throw new Error(n+"expected boolean, got type="+typeof e)}return e}function Nr(e){if(typeof e=="bigint"){if(!ce(e))throw new Error("positive bigint expected, got "+e)}else lt(e);return e}function zn(e){if(typeof e!="string")throw new Error("hex string expected, got "+typeof e);return e===""?Vn:BigInt("0x"+e)}function Gn(e){return zn(Ht(e))}function xt(e){return zn(Ht(Ot(q(e)).reverse()))}function qe(e,t){lt(t),e=Nr(e);let n=Zt(e.toString(16).padStart(t*2,"0"));if(n.length!==t)throw new Error("number too large");return n}function fe(e,t){return qe(e,t).reverse()}function Ot(e){return Uint8Array.from(e)}var ce=e=>typeof e=="bigint"&&Vn<=e;function Dr(e,t,n){return ce(e)&&ce(t)&&ce(n)&&t<=e&&e<n}function Ut(e,t,n,s){if(!Dr(t,n,s))throw new Error("expected valid "+e+": "+n+" <= n < "+s+", got "+t)}var $n=e=>(qn<<BigInt(e))-qn;function Lt(e,t={},n={}){if(!e||typeof e!="object")throw new Error("expected valid options object");function s(o,i,a){let c=e[o];if(a&&c===void 0)return;let f=typeof c;if(f!==i||c===null)throw new Error(`param "${o}" is invalid: expected ${i}, got ${f}`)}let r=(o,i)=>Object.entries(o).forEach(([a,c])=>s(a,c,i));r(t,!1),r(n,!0)}function Ve(e){let t=new WeakMap;return(n,...s)=>{let r=t.get(n);if(r!==void 0)return r;let o=e(n,...s);return t.set(n,o),o}}var X=BigInt(0),Y=BigInt(1),kt=BigInt(2),Yn=BigInt(3),Xn=BigInt(4),Wn=BigInt(5),Ar=BigInt(7),Jn=BigInt(8),Br=BigInt(9),Qn=BigInt(16);function V(e,t){let n=e%t;return n>=X?n:t+n}function et(e,t,n){let s=e;for(;t-- >X;)s*=s,s%=n;return s}function Zn(e,t){if(e===X)throw new Error("invert: expected non-zero number");if(t<=X)throw new Error("invert: expected positive modulus, got "+t);let n=V(e,t),s=t,r=X,o=Y,i=Y,a=X;for(;n!==X;){let f=s/n,h=s%n,l=r-i*f,d=o-a*f;s=n,n=h,r=i,o=a,i=l,a=d}if(s!==Y)throw new Error("invert: does not exist");return V(r,t)}function Ge(e,t,n){if(!e.eql(e.sqr(t),n))throw new Error("Cannot find square root")}function ts(e,t){let n=(e.ORDER+Y)/Xn,s=e.pow(t,n);return Ge(e,s,t),s}function vr(e,t){let n=(e.ORDER-Wn)/Jn,s=e.mul(t,kt),r=e.pow(s,n),o=e.mul(t,r),i=e.mul(e.mul(o,kt),r),a=e.mul(o,e.sub(i,e.ONE));return Ge(e,a,t),a}function _r(e){let t=de(e),n=es(e),s=n(t,t.neg(t.ONE)),r=n(t,s),o=n(t,t.neg(s)),i=(e+Ar)/Qn;return(a,c)=>{let f=a.pow(c,i),h=a.mul(f,s),l=a.mul(f,r),d=a.mul(f,o),b=a.eql(a.sqr(h),c),x=a.eql(a.sqr(l),c);f=a.cmov(f,h,b),h=a.cmov(d,l,x);let E=a.eql(a.sqr(h),c),u=a.cmov(f,h,E);return Ge(a,u,c),u}}function es(e){if(e<Yn)throw new Error("sqrt is not defined for small field");let t=e-Y,n=0;for(;t%kt===X;)t/=kt,n++;let s=kt,r=de(e);for(;jn(r,s)===1;)if(s++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(n===1)return ts;let o=r.pow(s,t),i=(t+Y)/kt;return function(c,f){if(c.is0(f))return f;if(jn(c,f)!==1)throw new Error("Cannot find square root");let h=n,l=c.mul(c.ONE,o),d=c.pow(f,t),b=c.pow(f,i);for(;!c.eql(d,c.ONE);){if(c.is0(d))return c.ZERO;let x=1,E=c.sqr(d);for(;!c.eql(E,c.ONE);)if(x++,E=c.sqr(E),x===h)throw new Error("Cannot find square root");let u=Y<<BigInt(h-x-1),D=c.pow(l,u);h=x,l=c.sqr(D),d=c.mul(d,l),b=c.mul(b,D)}return b}}function Or(e){return e%Xn===Yn?ts:e%Jn===Wn?vr:e%Qn===Br?_r(e):es(e)}var ns=(e,t)=>(V(e,t)&Y)===Y,Lr=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function ss(e){let t={ORDER:"bigint",BYTES:"number",BITS:"number"},n=Lr.reduce((s,r)=>(s[r]="function",s),t);return Lt(e,n),e}function kr(e,t,n){if(n<X)throw new Error("invalid exponent, negatives unsupported");if(n===X)return e.ONE;if(n===Y)return t;let s=e.ONE,r=t;for(;n>X;)n&Y&&(s=e.mul(s,r)),r=e.sqr(r),n>>=Y;return s}function he(e,t,n=!1){let s=new Array(t.length).fill(n?e.ZERO:void 0),r=t.reduce((i,a,c)=>e.is0(a)?i:(s[c]=i,e.mul(i,a)),e.ONE),o=e.inv(r);return t.reduceRight((i,a,c)=>e.is0(a)?i:(s[c]=e.mul(i,s[c]),e.mul(i,a)),o),s}function jn(e,t){let n=(e.ORDER-Y)/kt,s=e.pow(t,n),r=e.eql(s,e.ONE),o=e.eql(s,e.ZERO),i=e.eql(s,e.neg(e.ONE));if(!r&&!o&&!i)throw new Error("invalid Legendre symbol result");return r?1:o?0:-1}function Rr(e,t){t!==void 0&&lt(t);let n=t!==void 0?t:e.toString(2).length,s=Math.ceil(n/8);return{nBitLength:n,nByteLength:s}}var ze=class{constructor(t,n={}){w(this,"ORDER");w(this,"BITS");w(this,"BYTES");w(this,"isLE");w(this,"ZERO",X);w(this,"ONE",Y);w(this,"_lengths");w(this,"_sqrt");w(this,"_mod");if(t<=X)throw new Error("invalid field: expected ORDER > 0, got "+t);let s;this.isLE=!1,n!=null&&typeof n=="object"&&(typeof n.BITS=="number"&&(s=n.BITS),typeof n.sqrt=="function"&&(this.sqrt=n.sqrt),typeof n.isLE=="boolean"&&(this.isLE=n.isLE),n.allowedLengths&&(this._lengths=n.allowedLengths?.slice()),typeof n.modFromBytes=="boolean"&&(this._mod=n.modFromBytes));let{nBitLength:r,nByteLength:o}=Rr(t,s);if(o>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=t,this.BITS=r,this.BYTES=o,this._sqrt=void 0,Object.preventExtensions(this)}create(t){return V(t,this.ORDER)}isValid(t){if(typeof t!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof t);return X<=t&&t<this.ORDER}is0(t){return t===X}isValidNot0(t){return!this.is0(t)&&this.isValid(t)}isOdd(t){return(t&Y)===Y}neg(t){return V(-t,this.ORDER)}eql(t,n){return t===n}sqr(t){return V(t*t,this.ORDER)}add(t,n){return V(t+n,this.ORDER)}sub(t,n){return V(t-n,this.ORDER)}mul(t,n){return V(t*n,this.ORDER)}pow(t,n){return kr(this,t,n)}div(t,n){return V(t*Zn(n,this.ORDER),this.ORDER)}sqrN(t){return t*t}addN(t,n){return t+n}subN(t,n){return t-n}mulN(t,n){return t*n}inv(t){return Zn(t,this.ORDER)}sqrt(t){return this._sqrt||(this._sqrt=Or(this.ORDER)),this._sqrt(this,t)}toBytes(t){return this.isLE?fe(t,this.BYTES):qe(t,this.BYTES)}fromBytes(t,n=!1){q(t);let{_lengths:s,BYTES:r,isLE:o,ORDER:i,_mod:a}=this;if(s){if(!s.includes(t.length)||t.length>r)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+t.length);let f=new Uint8Array(r);f.set(t,o?0:f.length-t.length),t=f}if(t.length!==r)throw new Error("Field.fromBytes: expected "+r+" bytes, got "+t.length);let c=o?xt(t):Gn(t);if(a&&(c=V(c,i)),!n&&!this.isValid(c))throw new Error("invalid field element: outside of range 0..ORDER");return c}invertBatch(t){return he(this,t)}cmov(t,n,s){return s?n:t}};function de(e,t={}){return new ze(e,t)}var ue=BigInt(0),Ye=BigInt(1);function rs(e,t){let n=t.negate();return e?n:t}function ge(e,t){let n=he(e.Fp,t.map(s=>s.Z));return t.map((s,r)=>e.fromAffine(s.toAffine(n[r])))}function cs(e,t){if(!Number.isSafeInteger(e)||e<=0||e>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+e)}function $e(e,t){cs(e,t);let n=Math.ceil(t/e)+1,s=2**(e-1),r=2**e,o=$n(e),i=BigInt(e);return{windows:n,windowSize:s,mask:o,maxNumber:r,shiftBy:i}}function os(e,t,n){let{windowSize:s,mask:r,maxNumber:o,shiftBy:i}=n,a=Number(e&r),c=e>>i;a>s&&(a-=o,c+=Ye);let f=t*s,h=f+Math.abs(a)-1,l=a===0,d=a<0,b=t%2!==0;return{nextN:c,offset:h,isZero:l,isNeg:d,isNegF:b,offsetF:f}}var Ze=new WeakMap,ls=new WeakMap;function je(e){return ls.get(e)||1}function is(e){if(e!==ue)throw new Error("invalid wNAF")}var pe=class{constructor(t,n){w(this,"BASE");w(this,"ZERO");w(this,"Fn");w(this,"bits");this.BASE=t.BASE,this.ZERO=t.ZERO,this.Fn=t.Fn,this.bits=n}_unsafeLadder(t,n,s=this.ZERO){let r=t;for(;n>ue;)n&Ye&&(s=s.add(r)),r=r.double(),n>>=Ye;return s}precomputeWindow(t,n){let{windows:s,windowSize:r}=$e(n,this.bits),o=[],i=t,a=i;for(let c=0;c<s;c++){a=i,o.push(a);for(let f=1;f<r;f++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(t,n,s){if(!this.Fn.isValid(s))throw new Error("invalid scalar");let r=this.ZERO,o=this.BASE,i=$e(t,this.bits);for(let a=0;a<i.windows;a++){let{nextN:c,offset:f,isZero:h,isNeg:l,isNegF:d,offsetF:b}=os(s,a,i);s=c,h?o=o.add(rs(d,n[b])):r=r.add(rs(l,n[f]))}return is(s),{p:r,f:o}}wNAFUnsafe(t,n,s,r=this.ZERO){let o=$e(t,this.bits);for(let i=0;i<o.windows&&s!==ue;i++){let{nextN:a,offset:c,isZero:f,isNeg:h}=os(s,i,o);if(s=a,!f){let l=n[c];r=r.add(h?l.negate():l)}}return is(s),r}getPrecomputes(t,n,s){let r=Ze.get(n);return r||(r=this.precomputeWindow(n,t),t!==1&&(typeof s=="function"&&(r=s(r)),Ze.set(n,r))),r}cached(t,n,s){let r=je(t);return this.wNAF(r,this.getPrecomputes(r,t,s),n)}unsafe(t,n,s,r){let o=je(t);return o===1?this._unsafeLadder(t,n,r):this.wNAFUnsafe(o,this.getPrecomputes(o,t,s),n,r)}createCache(t,n){cs(n,this.bits),ls.set(t,n),Ze.delete(t)}hasCache(t){return je(t)!==1}};function as(e,t,n){if(t){if(t.ORDER!==e)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return ss(t),t}else return de(e,{isLE:n})}function fs(e,t,n={},s){if(s===void 0&&(s=e==="edwards"),!t||typeof t!="object")throw new Error(`expected valid ${e} CURVE object`);for(let c of["p","n","h"]){let f=t[c];if(!(typeof f=="bigint"&&f>ue))throw new Error(`CURVE.${c} must be positive bigint`)}let r=as(t.p,n.Fp,s),o=as(t.n,n.Fn,s),a=["Gx","Gy","a",e==="weierstrass"?"b":"d"];for(let c of a)if(!r.isValid(t[c]))throw new Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return t=Object.freeze(Object.assign({},t)),{CURVE:t,Fp:r,Fn:o}}function me(e,t){return function(s){let r=e(s);return{secretKey:r,publicKey:t(r)}}}var Ct=BigInt(0),G=BigInt(1),Xe=BigInt(2),Pr=BigInt(8);function Mr(e,t,n,s){let r=e.sqr(n),o=e.sqr(s),i=e.add(e.mul(t.a,r),o),a=e.add(e.ONE,e.mul(t.d,e.mul(r,o)));return e.eql(i,a)}function hs(e,t={}){let n=fs("edwards",e,t,t.FpFnLE),{Fp:s,Fn:r}=n,o=n.CURVE,{h:i}=o;Lt(t,{},{uvRatio:"function"});let a=Xe<<BigInt(r.BYTES*8)-G,c=D=>s.create(D),f=t.uvRatio||((D,g)=>{try{return{isValid:!0,value:s.sqrt(s.div(D,g))}}catch{return{isValid:!1,value:Ct}}});if(!Mr(s,o,o.Gx,o.Gy))throw new Error("bad curve params: generator point");function h(D,g,p=!1){let T=p?G:Ct;return Ut("coordinate "+D,g,T,a),g}function l(D){if(!(D instanceof x))throw new Error("EdwardsPoint expected")}let d=Ve((D,g)=>{let{X:p,Y:T,Z:L}=D,R=D.is0();g==null&&(g=R?Pr:s.inv(L));let H=c(p*g),y=c(T*g),m=s.mul(L,g);if(R)return{x:Ct,y:G};if(m!==G)throw new Error("invZ was invalid");return{x:H,y}}),b=Ve(D=>{let{a:g,d:p}=o;if(D.is0())throw new Error("bad point: ZERO");let{X:T,Y:L,Z:R,T:H}=D,y=c(T*T),m=c(L*L),I=c(R*R),B=c(I*I),v=c(y*g),_=c(I*c(v+m)),N=c(B+c(p*c(y*m)));if(_!==N)throw new Error("bad point: equation left != right (1)");let A=c(T*L),O=c(R*H);if(A!==O)throw new Error("bad point: equation left != right (2)");return!0}),u=class u{constructor(g,p,T,L){w(this,"X");w(this,"Y");w(this,"Z");w(this,"T");this.X=h("x",g),this.Y=h("y",p),this.Z=h("z",T,!0),this.T=h("t",L),Object.freeze(this)}static CURVE(){return o}static fromAffine(g){if(g instanceof u)throw new Error("extended point not allowed");let{x:p,y:T}=g||{};return h("x",p),h("y",T),new u(p,T,G,c(p*T))}static fromBytes(g,p=!1){let T=s.BYTES,{a:L,d:R}=o;g=Ot(q(g,T,"point")),le(p,"zip215");let H=Ot(g),y=g[T-1];H[T-1]=y&-129;let m=xt(H),I=p?a:s.ORDER;Ut("point.y",m,Ct,I);let B=c(m*m),v=c(B-G),_=c(R*B-L),{isValid:N,value:A}=f(v,_);if(!N)throw new Error("bad point: invalid y coordinate");let O=(A&G)===G,P=(y&128)!==0;if(!p&&A===Ct&&P)throw new Error("bad point: x=0 and x_0=1");return P!==O&&(A=c(-A)),u.fromAffine({x:A,y:m})}static fromHex(g,p=!1){return u.fromBytes(Zt(g),p)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(g=8,p=!0){return E.createCache(this,g),p||this.multiply(Xe),this}assertValidity(){b(this)}equals(g){l(g);let{X:p,Y:T,Z:L}=this,{X:R,Y:H,Z:y}=g,m=c(p*y),I=c(R*L),B=c(T*y),v=c(H*L);return m===I&&B===v}is0(){return this.equals(u.ZERO)}negate(){return new u(c(-this.X),this.Y,this.Z,c(-this.T))}double(){let{a:g}=o,{X:p,Y:T,Z:L}=this,R=c(p*p),H=c(T*T),y=c(Xe*c(L*L)),m=c(g*R),I=p+T,B=c(c(I*I)-R-H),v=m+H,_=v-y,N=m-H,A=c(B*_),O=c(v*N),P=c(B*N),k=c(_*v);return new u(A,O,k,P)}add(g){l(g);let{a:p,d:T}=o,{X:L,Y:R,Z:H,T:y}=this,{X:m,Y:I,Z:B,T:v}=g,_=c(L*m),N=c(R*I),A=c(y*T*v),O=c(H*B),P=c((L+R)*(m+I)-_-N),k=O-A,S=O+A,U=c(N-p*_),F=c(P*k),K=c(S*U),J=c(P*U),tt=c(k*S);return new u(F,K,tt,J)}subtract(g){return this.add(g.negate())}multiply(g){if(!r.isValidNot0(g))throw new Error("invalid scalar: expected 1 <= sc < curve.n");let{p,f:T}=E.cached(this,g,L=>ge(u,L));return ge(u,[p,T])[0]}multiplyUnsafe(g,p=u.ZERO){if(!r.isValid(g))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return g===Ct?u.ZERO:this.is0()||g===G?this:E.unsafe(this,g,T=>ge(u,T),p)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}isTorsionFree(){return E.unsafe(this,o.n).is0()}toAffine(g){return d(this,g)}clearCofactor(){return i===G?this:this.multiplyUnsafe(i)}toBytes(){let{x:g,y:p}=this.toAffine(),T=s.toBytes(p);return T[T.length-1]|=g&G?128:0,T}toHex(){return Ht(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}};w(u,"BASE",new u(o.Gx,o.Gy,G,c(o.Gx*o.Gy))),w(u,"ZERO",new u(Ct,G,G,Ct)),w(u,"Fp",s),w(u,"Fn",r);let x=u,E=new pe(x,r.BITS);return x.BASE.precompute(8),x}function ds(e,t,n={}){if(typeof t!="function")throw new Error('"hash" function param is required');Lt(n,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});let{prehash:s}=n,{BASE:r,Fp:o,Fn:i}=e,a=n.randomBytes||ft,c=n.adjustScalarBytes||(y=>y),f=n.domain||((y,m,I)=>{if(le(I,"phflag"),m.length||I)throw new Error("Contexts/pre-hash are not supported");return y});function h(y){return i.create(xt(y))}function l(y){let m=p.secretKey;q(y,p.secretKey,"secretKey");let I=q(t(y),2*m,"hashedSecretKey"),B=c(I.slice(0,m)),v=I.slice(m,2*m),_=h(B);return{head:B,prefix:v,scalar:_}}function d(y){let{head:m,prefix:I,scalar:B}=l(y),v=r.multiply(B),_=v.toBytes();return{head:m,prefix:I,scalar:B,point:v,pointBytes:_}}function b(y){return d(y).pointBytes}function x(y=Uint8Array.of(),...m){let I=jt(...m);return h(t(f(I,q(y,void 0,"context"),!!s)))}function E(y,m,I={}){y=q(y,void 0,"message"),s&&(y=s(y));let{prefix:B,scalar:v,pointBytes:_}=d(m),N=x(I.context,B,y),A=r.multiply(N).toBytes(),O=x(I.context,A,_,y),P=i.create(N+O*v);if(!i.isValid(P))throw new Error("sign failed: invalid s");let k=jt(A,i.toBytes(P));return q(k,p.signature,"result")}let u={zip215:!0};function D(y,m,I,B=u){let{context:v,zip215:_}=B,N=p.signature;y=q(y,N,"signature"),m=q(m,void 0,"message"),I=q(I,p.publicKey,"publicKey"),_!==void 0&&le(_,"zip215"),s&&(m=s(m));let A=N/2,O=y.subarray(0,A),P=xt(y.subarray(A,N)),k,S,U;try{k=e.fromBytes(I,_),S=e.fromBytes(O,_),U=r.multiplyUnsafe(P)}catch{return!1}if(!_&&k.isSmallOrder())return!1;let F=x(v,S.toBytes(),k.toBytes(),m);return S.add(k.multiplyUnsafe(F)).subtract(U).clearCofactor().is0()}let g=o.BYTES,p={secretKey:g,publicKey:g,signature:2*g,seed:g};function T(y=a(p.seed)){return q(y,p.seed,"seed")}function L(y){return oe(y)&&y.length===i.BYTES}function R(y,m){try{return!!e.fromBytes(y,m)}catch{return!1}}let H={getExtendedPublicKey:d,randomSecretKey:T,isValidSecretKey:L,isValidPublicKey:R,toMontgomery(y){let{y:m}=e.fromBytes(y),I=p.publicKey,B=I===32;if(!B&&I!==57)throw new Error("only defined for 25519 and 448");let v=B?o.div(G+m,G-m):o.div(m-G,m+G);return o.toBytes(v)},toMontgomerySecret(y){let m=p.secretKey;q(y,m);let I=t(y.subarray(0,m));return c(I).subarray(0,m)}};return Object.freeze({keygen:me(T,b),getPublicKey:b,sign:E,verify:D,utils:H,Point:e,lengths:p})}var Jt=BigInt(0),Ft=BigInt(1),ye=BigInt(2);function Hr(e){return Lt(e,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...e})}function us(e){let t=Hr(e),{P:n,type:s,adjustScalarBytes:r,powPminus2:o,randomBytes:i}=t,a=s==="x25519";if(!a&&s!=="x448")throw new Error("invalid type");let c=i||ft,f=a?255:448,h=a?32:56,l=BigInt(a?9:5),d=BigInt(a?121665:39081),b=a?ye**BigInt(254):ye**BigInt(447),x=a?BigInt(8)*ye**BigInt(251)-Ft:BigInt(4)*ye**BigInt(445)-Ft,E=b+x+Ft,u=N=>V(N,n),D=g(l);function g(N){return fe(u(N),h)}function p(N){let A=Ot(q(N,h,"uCoordinate"));return a&&(A[31]&=127),u(xt(A))}function T(N){return xt(r(Ot(q(N,h,"scalar"))))}function L(N,A){let O=I(p(A),T(N));if(O===Jt)throw new Error("invalid private or public key received");return g(O)}function R(N){return L(N,D)}let H=R,y=L;function m(N,A,O){let P=u(N*(A-O));return A=u(A-P),O=u(O+P),{x_2:A,x_3:O}}function I(N,A){Ut("u",N,Jt,n),Ut("scalar",A,b,E);let O=A,P=N,k=Ft,S=Jt,U=N,F=Ft,K=Jt;for(let tt=BigInt(f-1);tt>=Jt;tt--){let ut=O>>tt&Ft;K^=ut,{x_2:k,x_3:U}=m(K,k,U),{x_2:S,x_3:F}=m(K,S,F),K=ut;let it=k+S,at=u(it*it),ct=k-S,pt=u(ct*ct),wn=at-pt,hr=U+F,dr=U-F,En=u(dr*it),Sn=u(hr*ct),In=En+Sn,Tn=En-Sn;U=u(In*In),F=u(P*u(Tn*Tn)),k=u(at*pt),S=u(wn*(at+u(d*wn)))}({x_2:k,x_3:U}=m(K,k,U)),{x_2:S,x_3:F}=m(K,S,F);let J=o(S);return u(k*J)}let B={secretKey:h,publicKey:h,seed:h},v=(N=c(h))=>(q(N,B.seed,"seed"),N),_={randomSecretKey:v};return Object.freeze({keygen:me(v,H),getSharedSecret:y,getPublicKey:H,scalarMult:L,scalarMultBase:R,utils:_,GuBytes:D.slice(),lengths:B})}var Ur=BigInt(1),ps=BigInt(2),Fr=BigInt(3),Kr=BigInt(5),qr=BigInt(8),xe=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),Vr={p:xe,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:qr,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function ms(e){let t=BigInt(10),n=BigInt(20),s=BigInt(40),r=BigInt(80),o=xe,a=e*e%o*e%o,c=et(a,ps,o)*a%o,f=et(c,Ur,o)*e%o,h=et(f,Kr,o)*f%o,l=et(h,t,o)*h%o,d=et(l,n,o)*l%o,b=et(d,s,o)*d%o,x=et(b,r,o)*b%o,E=et(x,r,o)*b%o,u=et(E,t,o)*h%o;return{pow_p_5_8:et(u,ps,o)*e%o,b2:a}}function ys(e){return e[0]&=248,e[31]&=127,e[31]|=64,e}var gs=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function zr(e,t){let n=xe,s=V(t*t*t,n),r=V(s*s*t,n),o=ms(e*r).pow_p_5_8,i=V(e*s*o,n),a=V(t*i*i,n),c=i,f=V(i*gs,n),h=a===e,l=a===V(-e,n),d=a===V(-e*gs,n);return h&&(i=c),(l||d)&&(i=f),ns(i,n)&&(i=V(-i,n)),{isValid:h||l,value:i}}var Gr=hs(Vr,{uvRatio:zr});function $r(e){return ds(Gr,Kn,Object.assign({adjustScalarBytes:ys},e))}var rt=$r({});var Kt=(()=>{let e=xe;return us({P:e,type:"x25519",powPminus2:t=>{let{pow_p_5_8:n,b2:s}=ms(t);return V(et(n,Fr,e)*s,e)},adjustScalarBytes:ys})})();_t();mt();function Zr(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array"}function be(e){if(typeof e!="boolean")throw new Error(`boolean expected, not ${e}`)}function we(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function $(e,t,n=""){let s=Zr(e),r=e?.length,o=t!==void 0;if(!s||o&&r!==t){let i=n&&`"${n}" `,a=o?` of length ${t}`:"",c=s?`length=${r}`:`type=${typeof e}`;throw new Error(i+"expected Uint8Array"+a+", got "+c)}return e}function We(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function xs(e,t){$(e,void 0,"output");let n=t.outputLen;if(e.length<n)throw new Error("digestInto() expects output buffer of length at least "+n)}function bt(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function wt(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function jr(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}var Yr=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function bs(e,t){if(t==null||typeof t!="object")throw new Error("options must be defined");return Object.assign(e,t)}function ws(e,t){if(e.length!==t.length)return!1;let n=0;for(let s=0;s<e.length;s++)n|=e[s]^t[s];return n===0}var Je=(e,t)=>{function n(s,...r){if($(s,void 0,"key"),!Yr)throw new Error("Non little-endian hardware is not yet supported");if(e.nonceLength!==void 0){let h=r[0];$(h,e.varSizeNonce?void 0:e.nonceLength,"nonce")}let o=e.tagLength;o&&r[1]!==void 0&&$(r[1],void 0,"AAD");let i=t(s,...r),a=(h,l)=>{if(l!==void 0){if(h!==2)throw new Error("cipher output not supported");$(l,void 0,"output")}},c=!1;return{encrypt(h,l){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,$(h),a(i.encrypt.length,l),i.encrypt(h,l)},decrypt(h,l){if($(h),o&&h.length<o)throw new Error('"ciphertext" expected length bigger than tagLength='+o);return a(i.decrypt.length,l),i.decrypt(h,l)}}}return Object.assign(n,e),n};function Qe(e,t,n=!0){if(t===void 0)return new Uint8Array(e);if(t.length!==e)throw new Error('"output" expected Uint8Array of length '+e+", got: "+t.length);if(n&&!Xr(t))throw new Error("invalid output, must be aligned");return t}function Es(e,t,n){be(n);let s=new Uint8Array(16),r=jr(s);return r.setBigUint64(0,BigInt(t),n),r.setBigUint64(8,BigInt(e),n),s}function Xr(e){return e.byteOffset%4===0}function qt(e){return Uint8Array.from(e)}var Is=e=>Uint8Array.from(e.split(""),t=>t.charCodeAt(0)),Wr=Is("expand 16-byte k"),Jr=Is("expand 32-byte k"),Qr=bt(Wr),to=bt(Jr);function C(e,t){return e<<t|e>>>32-t}function tn(e){return e.byteOffset%4===0}var Ee=64,eo=16,Ts=2**32-1,Ss=Uint32Array.of();function no(e,t,n,s,r,o,i,a){let c=r.length,f=new Uint8Array(Ee),h=bt(f),l=tn(r)&&tn(o),d=l?bt(r):Ss,b=l?bt(o):Ss;for(let x=0;x<c;i++){if(e(t,n,s,h,i,a),i>=Ts)throw new Error("arx: counter overflow");let E=Math.min(Ee,c-x);if(l&&E===Ee){let u=x/4;if(x%4!==0)throw new Error("arx: invalid block position");for(let D=0,g;D<eo;D++)g=u+D,b[g]=d[g]^h[D];x+=Ee;continue}for(let u=0,D;u<E;u++)D=x+u,o[D]=r[D]^f[u];x+=E}}function en(e,t){let{allowShortKeys:n,extendNonceFn:s,counterLength:r,counterRight:o,rounds:i}=bs({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if(typeof e!="function")throw new Error("core must be a function");return we(r),we(i),be(o),be(n),(a,c,f,h,l=0)=>{$(a,void 0,"key"),$(c,void 0,"nonce"),$(f,void 0,"data");let d=f.length;if(h===void 0&&(h=new Uint8Array(d)),$(h,void 0,"output"),we(l),l<0||l>=Ts)throw new Error("arx: counter overflow");if(h.length<d)throw new Error(`arx: output (${h.length}) is shorter than data (${d})`);let b=[],x=a.length,E,u;if(x===32)b.push(E=qt(a)),u=to;else if(x===16&&n)E=new Uint8Array(32),E.set(a),E.set(a,16),u=Qr,b.push(E);else throw $(a,32,"arx key"),new Error("invalid key size");tn(c)||b.push(c=qt(c));let D=bt(E);if(s){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");s(u,D,bt(c.subarray(0,16)),D),c=c.subarray(16)}let g=16-r;if(g!==c.length)throw new Error(`arx: nonce must be ${g} or 16 bytes`);if(g!==12){let T=new Uint8Array(12);T.set(c,o?0:12-c.length),c=T,b.push(c)}let p=bt(c);return no(e,u,D,p,f,h,l,i),wt(...b),h}}function j(e,t){return e[t++]&255|(e[t++]&255)<<8}var nn=class{constructor(t){w(this,"blockLen",16);w(this,"outputLen",16);w(this,"buffer",new Uint8Array(16));w(this,"r",new Uint16Array(10));w(this,"h",new Uint16Array(10));w(this,"pad",new Uint16Array(8));w(this,"pos",0);w(this,"finished",!1);t=qt($(t,32,"key"));let n=j(t,0),s=j(t,2),r=j(t,4),o=j(t,6),i=j(t,8),a=j(t,10),c=j(t,12),f=j(t,14);this.r[0]=n&8191,this.r[1]=(n>>>13|s<<3)&8191,this.r[2]=(s>>>10|r<<6)&7939,this.r[3]=(r>>>7|o<<9)&8191,this.r[4]=(o>>>4|i<<12)&255,this.r[5]=i>>>1&8190,this.r[6]=(i>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|f<<8)&8191,this.r[9]=f>>>5&127;for(let h=0;h<8;h++)this.pad[h]=j(t,16+2*h)}process(t,n,s=!1){let r=s?0:2048,{h:o,r:i}=this,a=i[0],c=i[1],f=i[2],h=i[3],l=i[4],d=i[5],b=i[6],x=i[7],E=i[8],u=i[9],D=j(t,n+0),g=j(t,n+2),p=j(t,n+4),T=j(t,n+6),L=j(t,n+8),R=j(t,n+10),H=j(t,n+12),y=j(t,n+14),m=o[0]+(D&8191),I=o[1]+((D>>>13|g<<3)&8191),B=o[2]+((g>>>10|p<<6)&8191),v=o[3]+((p>>>7|T<<9)&8191),_=o[4]+((T>>>4|L<<12)&8191),N=o[5]+(L>>>1&8191),A=o[6]+((L>>>14|R<<2)&8191),O=o[7]+((R>>>11|H<<5)&8191),P=o[8]+((H>>>8|y<<8)&8191),k=o[9]+(y>>>5|r),S=0,U=S+m*a+I*(5*u)+B*(5*E)+v*(5*x)+_*(5*b);S=U>>>13,U&=8191,U+=N*(5*d)+A*(5*l)+O*(5*h)+P*(5*f)+k*(5*c),S+=U>>>13,U&=8191;let F=S+m*c+I*a+B*(5*u)+v*(5*E)+_*(5*x);S=F>>>13,F&=8191,F+=N*(5*b)+A*(5*d)+O*(5*l)+P*(5*h)+k*(5*f),S+=F>>>13,F&=8191;let K=S+m*f+I*c+B*a+v*(5*u)+_*(5*E);S=K>>>13,K&=8191,K+=N*(5*x)+A*(5*b)+O*(5*d)+P*(5*l)+k*(5*h),S+=K>>>13,K&=8191;let J=S+m*h+I*f+B*c+v*a+_*(5*u);S=J>>>13,J&=8191,J+=N*(5*E)+A*(5*x)+O*(5*b)+P*(5*d)+k*(5*l),S+=J>>>13,J&=8191;let tt=S+m*l+I*h+B*f+v*c+_*a;S=tt>>>13,tt&=8191,tt+=N*(5*u)+A*(5*E)+O*(5*x)+P*(5*b)+k*(5*d),S+=tt>>>13,tt&=8191;let ut=S+m*d+I*l+B*h+v*f+_*c;S=ut>>>13,ut&=8191,ut+=N*a+A*(5*u)+O*(5*E)+P*(5*x)+k*(5*b),S+=ut>>>13,ut&=8191;let it=S+m*b+I*d+B*l+v*h+_*f;S=it>>>13,it&=8191,it+=N*c+A*a+O*(5*u)+P*(5*E)+k*(5*x),S+=it>>>13,it&=8191;let at=S+m*x+I*b+B*d+v*l+_*h;S=at>>>13,at&=8191,at+=N*f+A*c+O*a+P*(5*u)+k*(5*E),S+=at>>>13,at&=8191;let ct=S+m*E+I*x+B*b+v*d+_*l;S=ct>>>13,ct&=8191,ct+=N*h+A*f+O*c+P*a+k*(5*u),S+=ct>>>13,ct&=8191;let pt=S+m*u+I*E+B*x+v*b+_*d;S=pt>>>13,pt&=8191,pt+=N*l+A*h+O*f+P*c+k*a,S+=pt>>>13,pt&=8191,S=(S<<2)+S|0,S=S+U|0,U=S&8191,S=S>>>13,F+=S,o[0]=U,o[1]=F,o[2]=K,o[3]=J,o[4]=tt,o[5]=ut,o[6]=it,o[7]=at,o[8]=ct,o[9]=pt}finalize(){let{h:t,pad:n}=this,s=new Uint16Array(10),r=t[1]>>>13;t[1]&=8191;for(let a=2;a<10;a++)t[a]+=r,r=t[a]>>>13,t[a]&=8191;t[0]+=r*5,r=t[0]>>>13,t[0]&=8191,t[1]+=r,r=t[1]>>>13,t[1]&=8191,t[2]+=r,s[0]=t[0]+5,r=s[0]>>>13,s[0]&=8191;for(let a=1;a<10;a++)s[a]=t[a]+r,r=s[a]>>>13,s[a]&=8191;s[9]-=8192;let o=(r^1)-1;for(let a=0;a<10;a++)s[a]&=o;o=~o;for(let a=0;a<10;a++)t[a]=t[a]&o|s[a];t[0]=(t[0]|t[1]<<13)&65535,t[1]=(t[1]>>>3|t[2]<<10)&65535,t[2]=(t[2]>>>6|t[3]<<7)&65535,t[3]=(t[3]>>>9|t[4]<<4)&65535,t[4]=(t[4]>>>12|t[5]<<1|t[6]<<14)&65535,t[5]=(t[6]>>>2|t[7]<<11)&65535,t[6]=(t[7]>>>5|t[8]<<8)&65535,t[7]=(t[8]>>>8|t[9]<<5)&65535;let i=t[0]+n[0];t[0]=i&65535;for(let a=1;a<8;a++)i=(t[a]+n[a]|0)+(i>>>16)|0,t[a]=i&65535;wt(s)}update(t){We(this),$(t),t=qt(t);let{buffer:n,blockLen:s}=this,r=t.length;for(let o=0;o<r;){let i=Math.min(s-this.pos,r-o);if(i===s){for(;s<=r-o;o+=s)this.process(t,o);continue}n.set(t.subarray(o,o+i),this.pos),this.pos+=i,o+=i,this.pos===s&&(this.process(n,0,!1),this.pos=0)}return this}destroy(){wt(this.h,this.r,this.buffer,this.pad)}digestInto(t){We(this),xs(t,this),this.finished=!0;let{buffer:n,h:s}=this,{pos:r}=this;if(r){for(n[r++]=1;r<16;r++)n[r]=0;this.process(n,0,!0)}this.finalize();let o=0;for(let i=0;i<8;i++)t[o++]=s[i]>>>0,t[o++]=s[i]>>>8;return t}digest(){let{buffer:t,outputLen:n}=this;this.digestInto(t);let s=t.slice(0,n);return this.destroy(),s}};function so(e){let t=(s,r)=>e(r).update(s).digest(),n=e(new Uint8Array(32));return t.outputLen=n.outputLen,t.blockLen=n.blockLen,t.create=s=>e(s),t}var Cs=so(e=>new nn(e));function As(e,t,n,s,r,o=20){let i=e[0],a=e[1],c=e[2],f=e[3],h=t[0],l=t[1],d=t[2],b=t[3],x=t[4],E=t[5],u=t[6],D=t[7],g=r,p=n[0],T=n[1],L=n[2],R=i,H=a,y=c,m=f,I=h,B=l,v=d,_=b,N=x,A=E,O=u,P=D,k=g,S=p,U=T,F=L;for(let J=0;J<o;J+=2)R=R+I|0,k=C(k^R,16),N=N+k|0,I=C(I^N,12),R=R+I|0,k=C(k^R,8),N=N+k|0,I=C(I^N,7),H=H+B|0,S=C(S^H,16),A=A+S|0,B=C(B^A,12),H=H+B|0,S=C(S^H,8),A=A+S|0,B=C(B^A,7),y=y+v|0,U=C(U^y,16),O=O+U|0,v=C(v^O,12),y=y+v|0,U=C(U^y,8),O=O+U|0,v=C(v^O,7),m=m+_|0,F=C(F^m,16),P=P+F|0,_=C(_^P,12),m=m+_|0,F=C(F^m,8),P=P+F|0,_=C(_^P,7),R=R+B|0,F=C(F^R,16),O=O+F|0,B=C(B^O,12),R=R+B|0,F=C(F^R,8),O=O+F|0,B=C(B^O,7),H=H+v|0,k=C(k^H,16),P=P+k|0,v=C(v^P,12),H=H+v|0,k=C(k^H,8),P=P+k|0,v=C(v^P,7),y=y+_|0,S=C(S^y,16),N=N+S|0,_=C(_^N,12),y=y+_|0,S=C(S^y,8),N=N+S|0,_=C(_^N,7),m=m+I|0,U=C(U^m,16),A=A+U|0,I=C(I^A,12),m=m+I|0,U=C(U^m,8),A=A+U|0,I=C(I^A,7);let K=0;s[K++]=i+R|0,s[K++]=a+H|0,s[K++]=c+y|0,s[K++]=f+m|0,s[K++]=h+I|0,s[K++]=l+B|0,s[K++]=d+v|0,s[K++]=b+_|0,s[K++]=x+N|0,s[K++]=E+A|0,s[K++]=u+O|0,s[K++]=D+P|0,s[K++]=g+k|0,s[K++]=p+S|0,s[K++]=T+U|0,s[K++]=L+F|0}function ro(e,t,n,s){let r=e[0],o=e[1],i=e[2],a=e[3],c=t[0],f=t[1],h=t[2],l=t[3],d=t[4],b=t[5],x=t[6],E=t[7],u=n[0],D=n[1],g=n[2],p=n[3];for(let L=0;L<20;L+=2)r=r+c|0,u=C(u^r,16),d=d+u|0,c=C(c^d,12),r=r+c|0,u=C(u^r,8),d=d+u|0,c=C(c^d,7),o=o+f|0,D=C(D^o,16),b=b+D|0,f=C(f^b,12),o=o+f|0,D=C(D^o,8),b=b+D|0,f=C(f^b,7),i=i+h|0,g=C(g^i,16),x=x+g|0,h=C(h^x,12),i=i+h|0,g=C(g^i,8),x=x+g|0,h=C(h^x,7),a=a+l|0,p=C(p^a,16),E=E+p|0,l=C(l^E,12),a=a+l|0,p=C(p^a,8),E=E+p|0,l=C(l^E,7),r=r+f|0,p=C(p^r,16),x=x+p|0,f=C(f^x,12),r=r+f|0,p=C(p^r,8),x=x+p|0,f=C(f^x,7),o=o+h|0,u=C(u^o,16),E=E+u|0,h=C(h^E,12),o=o+h|0,u=C(u^o,8),E=E+u|0,h=C(h^E,7),i=i+l|0,D=C(D^i,16),d=d+D|0,l=C(l^d,12),i=i+l|0,D=C(D^i,8),d=d+D|0,l=C(l^d,7),a=a+c|0,g=C(g^a,16),b=b+g|0,c=C(c^b,12),a=a+c|0,g=C(g^a,8),b=b+g|0,c=C(c^b,7);let T=0;s[T++]=r,s[T++]=o,s[T++]=i,s[T++]=a,s[T++]=u,s[T++]=D,s[T++]=g,s[T++]=p}var oo=en(As,{counterRight:!1,counterLength:4,allowShortKeys:!1}),io=en(As,{counterRight:!1,counterLength:8,extendNonceFn:ro,allowShortKeys:!1});var ao=new Uint8Array(16),Ns=(e,t)=>{e.update(t);let n=t.length%16;n&&e.update(ao.subarray(n))},co=new Uint8Array(32);function Ds(e,t,n,s,r){r!==void 0&&$(r,void 0,"AAD");let o=e(t,n,co),i=Es(s.length,r?r.length:0,!0),a=Cs.create(o);r&&Ns(a,r),Ns(a,s),a.update(i);let c=a.digest();return wt(o,i),c}var Bs=e=>(t,n,s)=>({encrypt(o,i){let a=o.length;i=Qe(a+16,i,!1),i.set(o);let c=i.subarray(0,-16);e(t,n,c,c,1);let f=Ds(e,t,n,c,s);return i.set(f,a),wt(f),i},decrypt(o,i){i=Qe(o.length-16,i,!1);let a=o.subarray(0,-16),c=o.subarray(-16),f=Ds(e,t,n,a,s);if(!ws(c,f))throw new Error("invalid tag");return i.set(o.subarray(0,-16)),e(t,n,i,i,1),wt(f),i}}),vi=Je({blockSize:64,nonceLength:12,tagLength:16},Bs(oo)),Vt=Je({blockSize:64,nonceLength:24,tagLength:16},Bs(io));mt();var Se=class{constructor(t,n){w(this,"oHash");w(this,"iHash");w(this,"blockLen");w(this,"outputLen");w(this,"finished",!1);w(this,"destroyed",!1);if($t(t),q(n,void 0,"key"),this.iHash=t.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let s=this.blockLen,r=new Uint8Array(s);r.set(n.length>s?t.create().update(n).digest():n);for(let o=0;o<r.length;o++)r[o]^=54;this.iHash.update(r),this.oHash=t.create();for(let o=0;o<r.length;o++)r[o]^=106;this.oHash.update(r),nt(r)}update(t){return Mt(this),this.iHash.update(t),this}digestInto(t){Mt(this),q(t,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){let t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));let{oHash:n,iHash:s,finished:r,destroyed:o,blockLen:i,outputLen:a}=this;return t=t,t.finished=r,t.destroyed=o,t.blockLen=i,t.outputLen=a,t.oHash=n._cloneInto(t.oHash),t.iHash=s._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Ie=(e,t,n)=>new Se(e,t).update(n).digest();Ie.create=(e,t)=>new Se(e,t);mt();function lo(e,t,n){return $t(e),n===void 0&&(n=new Uint8Array(e.outputLen)),Ie(e,n,t)}var sn=Uint8Array.of(0),vs=Uint8Array.of();function fo(e,t,n,s=32){$t(e),lt(s,"length");let r=e.outputLen;if(s>255*r)throw new Error("Length must be <= 255*HashLen");let o=Math.ceil(s/r);n===void 0?n=vs:q(n,void 0,"info");let i=new Uint8Array(o*r),a=Ie.create(e,t),c=a._cloneInto(),f=new Uint8Array(a.outputLen);for(let h=0;h<o;h++)sn[0]=h+1,c.update(h===0?vs:f).update(n).update(sn).digestInto(f),i.set(f,r*h),a._cloneInto(c);return a.destroy(),c.destroy(),nt(f,sn),i.slice(0,s)}var Qt=(e,t,n,s,r)=>fo(e,lo(e,t,n),s,r);var rn=ft;function ho(e){e.fill(0)}function _s(e){if(e.length<32||e.every(s=>s===0))return!1;let t=e[0];if(e.every(s=>s===t))return!1;let n=0;for(let s=1;s<e.length;s++)e[s]===e[s-1]&&n++;return!(n>e.length*.8)}function Te(){let e=rt.utils.randomSecretKey();if(!_s(e))throw new Error("Insufficient entropy for key generation");return{publicKey:rt.getPublicKey(e),privateKey:e}}function dt(e,t){if(t.length!==32)throw new Error("Private key must be 32 bytes");return rt.sign(e,t)}function Os(e,t,n){try{return n.length!==32||t.length!==64?!1:rt.verify(t,e,n)}catch{return!1}}function uo(e,t,n,s){if(e.length!==32)throw new Error("Private key must be 32 bytes");if(t.length!==32)throw new Error("Peer public key must be 32 bytes");let r=Kt.getSharedSecret(e,t),o=Qt(Q,r,n||new Uint8Array(32),s||new Uint8Array(0),32);return ho(r),o}function Ls(e){let t=rn(32);if(!_s(t))throw new Error("Insufficient entropy for session key generation");return{key:t,nonce:rn(24),timestamp:Date.now(),messageCount:0,counter:e||0}}function ks(e,t,n,s){if(t.length!==32)throw new Error("Encryption key must be 32 bytes");if(n.length!==24)throw new Error("Nonce must be 24 bytes for XChaCha20-Poly1305");return Vt(t,n).encrypt(e,s)}function Rs(e,t,n,s){if(t.length!==32)throw new Error("Decryption key must be 32 bytes");if(n.length!==24)throw new Error("Nonce must be 24 bytes for XChaCha20-Poly1305");if(e.length<16)throw new Error("Ciphertext too short (must include 16-byte auth tag)");try{return Vt(t,n).decrypt(e,s)}catch{throw new Error("Decryption failed: authentication tag mismatch or corrupted data")}}function Ps(e){let t=Q(e),n=Array.from(t).map(s=>s.toString(16).padStart(2,"0")).join("");return n.match(/.{1,4}/g)?.join(" ")||n}function Ms(){return rn(24)}function Hs(e,t,n,s){return uo(e,t,n,s)}_t();var M;(function(e){e[e.TEXT=1]="TEXT",e[e.FILE_METADATA=2]="FILE_METADATA",e[e.FILE_CHUNK=3]="FILE_CHUNK",e[e.VOICE=4]="VOICE",e[e.CONTROL_ACK=16]="CONTROL_ACK",e[e.CONTROL_PING=17]="CONTROL_PING",e[e.CONTROL_PONG=18]="CONTROL_PONG",e[e.PEER_DISCOVERY=32]="PEER_DISCOVERY",e[e.PEER_INTRODUCTION=33]="PEER_INTRODUCTION",e[e.KEY_EXCHANGE=48]="KEY_EXCHANGE",e[e.SESSION_KEY=49]="SESSION_KEY",e[e.DHT_FIND_NODE=64]="DHT_FIND_NODE",e[e.DHT_FOUND_NODES=65]="DHT_FOUND_NODES",e[e.DHT_FIND_VALUE=66]="DHT_FIND_VALUE",e[e.DHT_STORE=67]="DHT_STORE",e[e.DHT_STORE_ACK=68]="DHT_STORE_ACK",e[e.DHT_FOUND_VALUE=69]="DHT_FOUND_VALUE",e[e.UPDATE_MANIFEST=80]="UPDATE_MANIFEST"})(M||(M={}));var Us=1,Fs=1,Rt=108,Ks=1024*1024,qs=255,ot=class extends Error{constructor(t,n,s){super(t),this.field=n,this.value=s,this.name="MessageValidationError"}};function on(e){if(e.version<Us||e.version>Fs)throw new ot(`Unsupported protocol version: ${e.version}. Supported: ${Us}-${Fs}`,"version",e.version);if(!Object.values(M).filter(n=>typeof n=="number").includes(e.type))throw new ot(`Invalid message type: 0x${e.type.toString(16).padStart(2,"0")}`,"type",e.type);if(e.ttl<0||e.ttl>qs)throw new ot(`Invalid TTL: ${e.ttl}. Must be 0-${qs}`,"ttl",e.ttl);if(!Number.isSafeInteger(e.timestamp)||e.timestamp<0)throw new ot(`Invalid timestamp: ${e.timestamp}`,"timestamp",e.timestamp);if(e.senderId.length!==32)throw new ot(`Invalid sender ID length: ${e.senderId.length}. Expected: 32`,"senderId",e.senderId.length);if(e.signature.length!==64&&e.signature.length!==65)throw new ot(`Invalid signature length: ${e.signature.length}. Expected: 64 or 65`,"signature",e.signature.length)}function Vs(e){if(on(e.header),e.payload.length>Ks)throw new ot(`Payload too large: ${e.payload.length} bytes. Max: ${Ks}`,"payload",e.payload.length)}function po(e){on(e);let t=new Uint8Array(Rt),n=0;t[n++]=e.version,t[n++]=e.type,t[n++]=e.ttl,t[n++]=0;let s=BigInt(e.timestamp);for(let r=7;r>=0;r--)t[n++]=Number(s>>BigInt(r*8)&BigInt(255));return t.set(e.senderId,n),n+=32,t.set(e.signature,n),t}function go(e){if(e.length<Rt)throw new ot(`Invalid header size: ${e.length} bytes. Expected: ${Rt} bytes`,"buffer",e.length);let t=0,n=e[t++],s=e[t++],r=e[t++];t++;let o=0;for(let f=0;f<8;f++)o=o*256+e[t++];let i=e.slice(t,t+32);t+=32;let a=e.slice(t,t+64),c={version:n,type:s,ttl:r,timestamp:o,senderId:i,signature:a};return on(c),c}function z(e){Vs(e);let t=po(e.header),n=new Uint8Array(t.length+e.payload.length);return n.set(t,0),n.set(e.payload,t.length),n}function Ce(e){if(e.length<Rt)throw new ot(`Buffer too small: ${e.length} bytes. Minimum: ${Rt} bytes`,"buffer",e.length);let t=go(e.slice(0,Rt)),n=e.slice(Rt),s={header:t,payload:n};return Vs(s),s}function an(e){let t=z(e),n=Q(t);return Array.from(n).map(s=>s.toString(16).padStart(2,"0")).join("")}te();Pt();Pt();te();Pt();dn();te();Pt();function un(e){let t=ee(e.publicKey),n;(e.transportType==="bluetooth"||e.transportType==="local")&&"address"in e&&typeof e.address=="string"&&(n=e.address);let s=[{type:e.transportType,address:n}];return{nodeId:t,peerId:e.id,lastSeen:e.lastSeen,failureCount:e.metadata.failureCount,endpoints:s,rtt:void 0}}function pn(e){return ln(e)}function gn(e){return e.publicKey instanceof Uint8Array&&e.publicKey.length===32&&typeof e.id=="string"&&e.id.length>0}dn();Pt();function Nt(e,t){let n=Buffer.from(e,"hex"),s=Buffer.from(t,"hex"),r=Buffer.alloc(n.length);for(let o=0;o<n.length;o++)r[o]=n[o]^s[o];return BigInt("0x"+r.toString("hex"))}var W;(function(e){e.CONNECTING="connecting",e.CONNECTED="connected",e.DEGRADED="degraded",e.DISCONNECTED="disconnected"})(W||(W={}));function De(e,t,n="webrtc"){return{id:e,publicKey:t,lastSeen:Date.now(),connectedAt:Date.now(),transportType:n,connectionQuality:100,bytesSent:0,bytesReceived:0,state:W.CONNECTED,metadata:{capabilities:{supportedTransports:[n],protocolVersion:1,features:[]},reputation:50,blacklisted:!1,failureCount:0,successCount:0}}}var Et;(function(e){e.FLOOD="flood",e.DHT="dht",e.HYBRID="hybrid"})(Et||(Et={}));var zt=class{constructor(t,n={}){if(this.routes=new Map,this.peers=new Map,this.messageCache=new Map,this.bloomFilter=new Set,this.localNodeId=t,this.MAX_CACHE_SIZE=n.maxCacheSize||1e4,this.CACHE_TTL=n.cacheTTL||6e4,this.ROUTE_TTL=n.routeTTL||3e5,this.MAX_ROUTES=n.maxRoutes||1e4,this.ENABLE_BLOOM=n.enableBloomFilter!==!1,this.mode=n.mode||Et.FLOOD,this.dhtRoutingTable=n.dhtRoutingTable,(this.mode===Et.DHT||this.mode===Et.HYBRID)&&!this.dhtRoutingTable)throw new Error(`DHT routing table required for ${this.mode} mode`)}addPeer(t){if(t.state||(t.state=W.CONNECTED),t.metadata||(t.metadata={capabilities:{supportedTransports:[t.transportType],protocolVersion:1,features:[]},reputation:50,blacklisted:!1,failureCount:0,successCount:0}),this.peers.set(t.id,t),this.routes.set(t.id,{destination:t.id,nextHop:t.id,hopCount:0,timestamp:Date.now(),metrics:{hopCount:0,latency:0,reliability:1,bandwidth:0,lastUsed:Date.now()},expiresAt:Date.now()+this.ROUTE_TTL}),this.dhtRoutingTable&&(this.mode===Et.DHT||this.mode===Et.HYBRID)&&gn(t)){let n=un(t);this.dhtRoutingTable.addContact(n)}}removePeer(t){this.peers.delete(t),this.routes.delete(t);for(let[n,s]of this.routes.entries())s.nextHop===t&&this.routes.delete(n)}getPeer(t){return this.peers.get(t)}getAllPeers(){return Array.from(this.peers.values())}updatePeerLastSeen(t){let n=this.peers.get(t);n&&(n.lastSeen=Date.now())}addRoute(t){let n=this.routes.get(t.destination);(!n||this.shouldReplaceRoute(n,t))&&(t.expiresAt||(t.expiresAt=Date.now()+this.ROUTE_TTL),this.routes.set(t.destination,t),this.cleanupExpiredRoutes())}shouldReplaceRoute(t,n){if(t.expiresAt<Date.now()||n.metrics.hopCount<t.metrics.hopCount)return!0;if(n.metrics.hopCount===t.metrics.hopCount){if(n.metrics.latency<t.metrics.latency)return!0;if(n.metrics.latency===t.metrics.latency){if(n.metrics.reliability>t.metrics.reliability)return!0;let s=n.metrics.bandwidth||0,r=t.metrics.bandwidth||0;if(n.metrics.reliability===t.metrics.reliability&&s>r)return!0}if(n.metrics.latency===t.metrics.latency&&n.metrics.reliability===t.metrics.reliability&&(n.metrics.bandwidth||0)===(t.metrics.bandwidth||0)&&n.timestamp>t.timestamp)return!0}return!1}cleanupExpiredRoutes(){if(this.routes.size<this.MAX_ROUTES)return;let t=Date.now(),n=[];for(let[s,r]of this.routes.entries())r.expiresAt<t&&n.push(s);if(n.forEach(s=>this.routes.delete(s)),this.routes.size>=this.MAX_ROUTES){let s=Array.from(this.routes.entries()).sort((o,i)=>o[1].metrics.lastUsed-i[1].metrics.lastUsed),r=this.routes.size-this.MAX_ROUTES+100;for(let o=0;o<r&&o<s.length;o++)this.routes.delete(s[o][0])}}updateRouteMetrics(t,n,s,r){let o=this.routes.get(t);if(o){o.metrics.latency=n,o.metrics.lastUsed=Date.now();let i=.3;o.metrics.reliability=i*(s?1:0)+(1-i)*o.metrics.reliability,r!==void 0&&(o.metrics.bandwidth=r)}}getNextHop(t){return this.routes.get(t)?.nextHop}hasSeenMessage(t){return this.ENABLE_BLOOM&&!this.bloomFilter.has(t)?!1:this.messageCache.has(t)}markMessageSeen(t){this.messageCache.set(t,Date.now()),this.ENABLE_BLOOM&&this.bloomFilter.add(t),this.cleanupMessageCache()}cleanupMessageCache(){let t=Date.now();if(this.messageCache.size<this.MAX_CACHE_SIZE){let r=[];for(let[o,i]of this.messageCache.entries())t-i>this.CACHE_TTL&&r.push(o);r.forEach(o=>{this.messageCache.delete(o),this.ENABLE_BLOOM&&this.bloomFilter.delete(o)});return}let n=Array.from(this.messageCache.entries()).sort((r,o)=>r[1]-o[1]),s=this.messageCache.size-this.MAX_CACHE_SIZE+100;for(let r=0;r<s&&r<n.length;r++)this.messageCache.delete(n[r][0]),this.ENABLE_BLOOM&&this.bloomFilter.delete(n[r][0])}updatePeerReputation(t,n){let s=this.peers.get(t);s&&(n?(s.metadata.successCount++,s.metadata.reputation=Math.min(100,s.metadata.reputation+1)):(s.metadata.failureCount++,s.metadata.reputation=Math.max(0,s.metadata.reputation-2)),s.metadata.reputation<20?s.state=W.DEGRADED:s.state===W.DEGRADED&&s.metadata.reputation>40&&(s.state=W.CONNECTED))}blacklistPeer(t,n){let s=this.peers.get(t);s&&(s.metadata.blacklisted=!0,n&&(s.metadata.blacklistExpiry=Date.now()+n),s.state=W.DISCONNECTED)}unblacklistPeer(t){let n=this.peers.get(t);n&&(n.metadata.blacklisted=!1,n.metadata.blacklistExpiry=void 0)}cleanupBlacklists(){let t=Date.now();for(let n of this.peers.values())n.metadata.blacklisted&&n.metadata.blacklistExpiry&&n.metadata.blacklistExpiry<t&&this.unblacklistPeer(n.id)}isPeerBlacklisted(t){let n=this.peers.get(t);return n?n.metadata.blacklisted&&n.metadata.blacklistExpiry&&n.metadata.blacklistExpiry<Date.now()?(this.unblacklistPeer(t),!1):n.metadata.blacklisted:!1}removeStalepeers(t=6e4){let n=Date.now(),s=[];for(let[r,o]of this.peers.entries())n-o.lastSeen>t&&s.push(r);return s.forEach(r=>this.removePeer(r)),s}getMemoryUsage(){let t={routes:this.routes.size*100,peers:this.peers.size*200,messageCache:this.messageCache.size*50,bloomFilter:this.bloomFilter.size*50};return{bytes:Object.values(t).reduce((s,r)=>s+r,0),breakdown:t}}getStats(){return{peerCount:this.peers.size,routeCount:this.routes.size,cacheSize:this.messageCache.size,memoryUsage:this.getMemoryUsage().bytes}}getRoutingMode(){return this.mode}getDHTRoutingTable(){return this.dhtRoutingTable}async findPeerViaDHT(t){if(!this.dhtRoutingTable)throw new Error("DHT routing table not configured");let n=pn(t);return(await this.dhtRoutingTable.findNode(n)).closestNodes}isDHTEnabled(){return this.mode===Et.DHT||this.mode===Et.HYBRID}findClosestPeers(t,n){return Array.from(this.peers.values()).sort((s,r)=>{let o=Nt(t,s.id),i=Nt(t,r.id);return o<i?-1:1}).slice(0,n)}};var mn=class{constructor(){this.storage=new Map}async saveMessage(t,n){this.storage.set(t,n)}async getMessage(t){return this.storage.get(t)||null}async removeMessage(t){this.storage.delete(t)}async getAllMessages(){return new Map(this.storage)}async pruneExpired(t){for(let[n,s]of this.storage.entries())s.expiresAt<t&&this.storage.delete(n)}async size(){return this.storage.size}},Gt=class{constructor(t,n,s={},r){this.stats={messagesReceived:0,messagesForwarded:0,messagesDuplicate:0,messagesExpired:0,messagesForSelf:0,messagesStored:0,relayFailures:0,loopsDetected:0},this.messageRoutes=new Map,this.peerFloodCounter=new Map,this.localPeerId=t,this.routingTable=n,this.config={maxStoredMessages:s.maxStoredMessages||1e3,storeTimeout:s.storeTimeout||3e5,maxRetries:s.maxRetries||3,retryBackoff:s.retryBackoff||5e3,floodRateLimit:s.floodRateLimit||100,selectiveFlooding:s.selectiveFlooding!==!1},this.persistence=r||new mn}async processMessage(t,n){this.stats.messagesReceived++;let s;try{s=Ce(t)}catch(i){console.error("Failed to decode message:",i);return}let r=an(s);if(this.routingTable.hasSeenMessage(r)){this.stats.messagesDuplicate++;return}if(this.detectLoop(r,n)){this.stats.loopsDetected++;return}if(this.routingTable.markMessageSeen(r),s.header.ttl===0){this.stats.messagesExpired++;return}if(!this.checkFloodRateLimit(n))return;if(this.isMessageForSelf(s)){this.stats.messagesForSelf++,this.onMessageForSelfCallback?.(s);return}let o={header:{...s.header,ttl:s.header.ttl-1},payload:s.payload};o.header.ttl>0&&this.shouldForwardMessage(o)&&(this.stats.messagesForwarded++,this.onForwardMessageCallback?.(o,n))}detectLoop(t,n){this.messageRoutes.has(t)||this.messageRoutes.set(t,[]);let s=this.messageRoutes.get(t);if(s.includes(n))return!0;if(s.push(n),this.messageRoutes.size>1e4){let r=Array.from(this.messageRoutes.keys());for(let o=0;o<1e3;o++)this.messageRoutes.delete(r[o])}return!1}checkFloodRateLimit(t){let n=Date.now();this.peerFloodCounter.has(t)||this.peerFloodCounter.set(t,[]);let r=this.peerFloodCounter.get(t).filter(o=>n-o<1e3);return r.length>=this.config.floodRateLimit?!1:(r.push(n),this.peerFloodCounter.set(t,r),!0)}shouldForwardMessage(t){return!this.config.selectiveFlooding||this.isControlMessage(t.header.type),!0}isControlMessage(t){return t===M.CONTROL_PING||t===M.CONTROL_PONG||t===M.CONTROL_ACK}isMessageForSelf(t){return!!(this.isBroadcastMessage(t.header.type)||t.header.type>=M.DHT_FIND_NODE&&t.header.type<=M.DHT_FOUND_VALUE)}isBroadcastMessage(t){return t===M.PEER_DISCOVERY||t===M.PEER_INTRODUCTION||t===M.CONTROL_PING||t===M.CONTROL_PONG}async storeMessage(t,n){if(await this.persistence.size()>=this.config.maxStoredMessages){let o=await this.persistence.getAllMessages(),i=Array.from(o.entries()).sort((a,c)=>a[1].lastAttempt-c[1].lastAttempt)[0];i&&await this.persistence.removeMessage(i[0])}let r=an(t);await this.persistence.saveMessage(r,{message:t,destinationPeerId:n,attempts:0,lastAttempt:Date.now(),expiresAt:Date.now()+this.config.storeTimeout}),this.stats.messagesStored++}async retryStoredMessages(){let t=Date.now(),n=[],s=await this.persistence.getAllMessages();for(let[r,o]of s.entries()){if(o.expiresAt<t){n.push(r);continue}if(!this.routingTable.getPeer(o.destinationPeerId))continue;let a=t-o.lastAttempt,c=this.config.retryBackoff*Math.pow(2,o.attempts);a<c||(o.attempts++,o.lastAttempt=t,o.attempts>this.config.maxRetries?(n.push(r),this.stats.relayFailures++):(this.onForwardMessageCallback?.(o.message,""),await this.persistence.saveMessage(r,o)))}for(let r of n)await this.persistence.removeMessage(r)}async getStoredMessagesStats(){let t=await this.persistence.getAllMessages();return{total:t.size,byDestination:Array.from(t.values()).reduce((n,s)=>(n[s.destinationPeerId]=(n[s.destinationPeerId]||0)+1,n),{})}}onMessageForSelf(t){this.onMessageForSelfCallback=t}onForwardMessage(t){this.onForwardMessageCallback=t}getStats(){return{...this.stats}}resetStats(){this.stats={messagesReceived:0,messagesForwarded:0,messagesDuplicate:0,messagesExpired:0,messagesForSelf:0,messagesStored:0,relayFailures:0,loopsDetected:0}}};var yn=class{constructor(t){this.peerConnection=null,this.dataChannels=new Map,this.peerId=t.peerId,this.initializePeerConnection(t.iceServers)}initializePeerConnection(t){let n={iceServers:t||[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478"}],iceCandidatePoolSize:10};this.peerConnection=new RTCPeerConnection(n),this.peerConnection.onconnectionstatechange=()=>{let s=this.peerConnection?.connectionState;this.onStateChangeCallback?.(s),s==="failed"&&this.handleConnectionFailure()},this.peerConnection.onicecandidate=s=>{s.candidate&&this.handleIceCandidate(s.candidate)},this.peerConnection.ondatachannel=s=>{this.setupDataChannel(s.channel)},this.peerConnection.ontrack=s=>{s.streams&&s.streams[0]&&this.onTrackCallback?.(s.track,s.streams[0])}}createDataChannel(t){if(!this.peerConnection)throw new Error("Peer connection not initialized");let n={ordered:t.ordered,maxRetransmits:t.maxRetransmits},s=this.peerConnection.createDataChannel(t.label,n);return this.setupDataChannel(s),s}setupDataChannel(t){this.dataChannels.set(t.label,t),t.onopen=()=>{console.log(`Data channel ${t.label} opened`)},t.onclose=()=>{console.log(`Data channel ${t.label} closed`),this.dataChannels.delete(t.label)},t.onerror=n=>{console.error(`Data channel ${t.label} error:`,n)},t.onmessage=n=>{if(n.data instanceof ArrayBuffer)this.onMessageCallback?.(new Uint8Array(n.data));else if(typeof n.data=="string"){let s=new TextEncoder;this.onMessageCallback?.(s.encode(n.data))}}}async createOffer(){if(!this.peerConnection)throw new Error("Peer connection not initialized");let t=await this.peerConnection.createOffer();return await this.peerConnection.setLocalDescription(t),t}async createAnswer(t){if(!this.peerConnection)throw new Error("Peer connection not initialized");await this.peerConnection.setRemoteDescription(t);let n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),n}async setRemoteAnswer(t){if(!this.peerConnection)throw new Error("Peer connection not initialized");await this.peerConnection.setRemoteDescription(t)}async addIceCandidate(t){if(!this.peerConnection)throw new Error("Peer connection not initialized");await this.peerConnection.addIceCandidate(t)}handleIceCandidate(t){this.onSignalCallback?this.onSignalCallback({type:"candidate",candidate:t.toJSON()}):console.log("ICE candidate generated but no signal handler:",t.toJSON())}async handleConnectionFailure(){console.log("Connection failed, attempting reconnection..."),this.close(),this.initializePeerConnection()}send(t,n="reliable"){let s=this.dataChannels.get(n);if(!s||s.readyState!=="open")throw new Error(`Data channel ${n} not ready`);s.send(t)}onMessage(t){this.onMessageCallback=t}onStateChange(t){this.onStateChangeCallback=t}onSignal(t){this.onSignalCallback=t}onTrack(t){this.onTrackCallback=t}addTrack(t,n){if(!this.peerConnection)throw new Error("Peer connection not initialized");this.peerConnection.addTrack(t,n)}getState(){return this.peerConnection?.connectionState||"new"}getPeerId(){return this.peerId}async getStats(){return this.peerConnection?this.peerConnection.getStats():null}async waitForIceGathering(t=2e3){if(!this.peerConnection)throw new Error("Peer connection not initialized");if(this.peerConnection.iceGatheringState!=="complete")return new Promise(n=>{let s,r=()=>{this.peerConnection?.iceGatheringState==="complete"&&(clearTimeout(s),this.peerConnection?.removeEventListener("icegatheringstatechange",r),n())};this.peerConnection?.addEventListener("icegatheringstatechange",r),s=setTimeout(()=>{this.peerConnection?.removeEventListener("icegatheringstatechange",r),n()},t)})}async getLocalDescription(){return this.peerConnection?.localDescription||null}close(){this.dataChannels.forEach(t=>t.close()),this.dataChannels.clear(),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null)}},Ae=class{constructor(){this.peers=new Map}getOrCreatePeer(t,n){let s=this.peers.get(t);return s||(s=new yn(n||{peerId:t}),s.onMessage(r=>{this.onMessageCallback?.(t,r)}),s.onStateChange(r=>{(r==="closed"||r==="failed")&&this.peers.delete(t)}),s.onSignal(r=>{this.onSignalCallback?.(t,r)}),s.onTrack((r,o)=>{this.onTrackCallback?.(t,r,o)}),this.peers.set(t,s)),s}getPeer(t){return this.peers.get(t)}removePeer(t){let n=this.peers.get(t);n&&(n.close(),this.peers.delete(t))}getConnectedPeers(){return Array.from(this.peers.entries()).filter(([t,n])=>n.getState()==="connected").map(([t])=>t)}broadcast(t,n){this.peers.forEach((s,r)=>{if(r!==n&&s.getState()==="connected")try{s.send(t)}catch(o){console.error(`Failed to send to peer ${r}:`,o)}})}onMessage(t){this.onMessageCallback=t}onSignal(t){this.onSignalCallback=t}closeAll(){this.peers.forEach(t=>t.close()),this.peers.clear()}async getStats(){let t=await Promise.all(Array.from(this.peers.entries()).map(async([n,s])=>{let r=await s.getStats();return{peerId:n,state:s.getState(),stats:r}}));return{totalPeers:this.peers.size,connectedPeers:this.getConnectedPeers().length,peers:t}}onTrack(t){this.onTrackCallback=t,this.peers.forEach((n,s)=>{n.onTrack((r,o)=>{t(s,r,o)})})}};function js(e){if(typeof btoa=="function"){let t=Array.from(e).map(n=>String.fromCharCode(n)).join("");return btoa(t)}else{if(typeof Buffer<"u")return Buffer.from(e).toString("base64");throw new Error("Environment does not support Base64 encoding")}}function ne(e){if(typeof atob=="function"){let t=atob(e),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n}else{if(typeof Buffer<"u")return new Uint8Array(Buffer.from(e,"base64"));throw new Error("Environment does not support Base64 decoding")}}function xn(e){let t=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2)t[n/2]=parseInt(e.substring(n,n+2),16);return t}_t();function Ys(e){let t;typeof e=="string"?e.match(/^[0-9a-fA-F]+$/)?t=xn(e):t=ne(e):t=e;let n=Q(t);return Array.from(n).map(r=>r.toString(16).padStart(2,"0")).join("").substring(0,16).toUpperCase()}async function Xs(e){let t;typeof e=="string"?e.match(/^[0-9a-fA-F]+$/)?t=xn(e):t=ne(e):t=e;let n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(r=>r.toString(16).padStart(2,"0")).join("").toUpperCase()}function Ws(e){return e.match(/.{1,4}/g)?.join(" ")||e}function Js(e){if(typeof e=="string"){if(e.match(/^[0-9a-fA-F]{64}$/))return!0;try{return ne(e).length===32}catch{return!1}}else return e.length===32}function Qs(e){return js(e)}function tr(e){return ne(e)}function er(e,t){return e.toUpperCase().replace(/\s/g,"")===t.toUpperCase().replace(/\s/g,"")}function Co(e){return e.latency===1/0?"offline":e.latency<50&&e.packetLoss<1?"excellent":e.latency<100&&e.packetLoss<5?"good":e.latency<200&&e.packetLoss<10?"fair":"poor"}var Be=class{constructor(){this.metrics={latency:1/0,packetLoss:0,bandwidth:0,jitter:0},this.latencyHistory=[],this.HISTORY_SIZE=10}updateLatency(t){if(this.latencyHistory.push(t),this.latencyHistory.length>this.HISTORY_SIZE&&this.latencyHistory.shift(),this.metrics.latency=this.latencyHistory.reduce((n,s)=>n+s,0)/this.latencyHistory.length,this.latencyHistory.length>1){let n=[];for(let s=1;s<this.latencyHistory.length;s++)n.push(Math.abs(this.latencyHistory[s]-this.latencyHistory[s-1]));this.metrics.jitter=n.reduce((s,r)=>s+r,0)/n.length}}updatePacketLoss(t,n){this.metrics.packetLoss=(t-n)/t*100}updateBandwidth(t,n){this.metrics.bandwidth=t/n*1e3}getMetrics(){return{...this.metrics}}getQuality(){return Co(this.metrics)}};var ve=class{constructor(t,n,s={}){this.pendingLookups=new Map,this.storage=new Map,this.routingTable=t,this.sendRequest=n,this.alpha=s.alpha||3,this.k=s.k||20,this.lookupTimeout=s.lookupTimeout||5e3}async handleMessage(t){let n=Buffer.from(t.header.senderId).toString("hex");switch(t.header.type){case M.DHT_FIND_NODE:await this.handleFindNode(n,t.payload);break;case M.DHT_FOUND_NODES:this.handleFoundNodes(n,t.payload);break;case M.DHT_FIND_VALUE:await this.handleFindValue(n,t.payload);break;case M.DHT_FOUND_VALUE:this.handleFoundValue(n,t.payload);break;case M.DHT_STORE:this.handleStore(n,t.payload);break}}async handleFindNode(t,n){try{let s=JSON.parse(new TextDecoder().decode(n)),r=s.targetId,i=this.routingTable.findClosestPeers(r,this.k).map(c=>({id:c.id,publicKey:Array.from(c.publicKey),transportType:c.transportType})),a=new TextEncoder().encode(JSON.stringify({nodes:i,requestId:s.requestId}));await this.sendRequest(t,M.DHT_FOUND_NODES,a)}catch(s){console.error("Error handling FIND_NODE:",s)}}handleFoundNodes(t,n){try{let s=JSON.parse(new TextDecoder().decode(n)),{nodes:r,requestId:o}=s,i=this.pendingLookups.get(o);i&&i.resolve({senderId:t,nodes:r})}catch(s){console.error("Error handling FOUND_NODES:",s)}}async handleFindValue(t,n){try{let s=JSON.parse(new TextDecoder().decode(n)),r=s.key;if(this.storage.has(r)){let o=this.storage.get(r),i=new TextEncoder().encode(JSON.stringify({key:r,value:Array.from(o),requestId:s.requestId}));await this.sendRequest(t,M.DHT_FOUND_VALUE,i)}else{let i=this.routingTable.findClosestPeers(r,this.k).map(c=>({id:c.id,publicKey:Array.from(c.publicKey),transportType:c.transportType})),a=new TextEncoder().encode(JSON.stringify({nodes:i,requestId:s.requestId}));await this.sendRequest(t,M.DHT_FOUND_NODES,a)}}catch(s){console.error("Error handling FIND_VALUE:",s)}}handleFoundValue(t,n){try{let s=JSON.parse(new TextDecoder().decode(n)),{value:r,requestId:o}=s,i=this.pendingLookups.get(o);i&&i.resolve({senderId:t,value:new Uint8Array(r)})}catch(s){console.error("Error handling FOUND_VALUE:",s)}}handleStore(t,n){try{let s=JSON.parse(new TextDecoder().decode(n)),{key:r,value:o}=s;this.storage.set(r,new Uint8Array(o))}catch(s){console.error("Error handling STORE:",s)}}async findNode(t){let n=Math.random().toString(36).substring(7),s=this.routingTable.findClosestPeers(t,this.k).map(i=>({peer:i,distance:Nt(t,i.id),queried:!1}));if(s.length===0)return[];let r=0,o=i=>{let a=!1;for(let c of i)if(!o.seen.has(c.id)&&c.id!==this.routingTable.localNodeId){let f={id:c.id,publicKey:new Uint8Array(c.publicKey),lastSeen:Date.now(),connectedAt:0,transportType:c.transportType,connectionQuality:0,bytesSent:0,bytesReceived:0,state:"disconnected",metadata:{capabilities:{supportedTransports:[],protocolVersion:1,features:[]},reputation:50,blacklisted:!1,failureCount:0,successCount:0}};s.push({peer:f,distance:Nt(t,f.id),queried:!1}),o.seen.add(c.id),a=!0}return a};o.seen=new Set(s.map(i=>i.peer.id));for(let i=0;i<10;i++){s.sort((l,d)=>l.distance<d.distance?-1:1);let a=s.filter(l=>!l.queried).slice(0,this.alpha);if(a.length===0&&r===0)break;let c=a.map(async l=>{l.queried=!0,r++;try{let d=`${n}-${l.peer.id}`,b=new TextEncoder().encode(JSON.stringify({targetId:t,requestId:d}));return await new Promise(x=>{let E=setTimeout(()=>{this.pendingLookups.delete(d),x(null)},this.lookupTimeout);this.pendingLookups.set(d,{resolve:u=>{clearTimeout(E),this.pendingLookups.delete(d),x(u)},reject:()=>{}}),this.sendRequest(l.peer.id,M.DHT_FIND_NODE,b).catch(()=>{clearTimeout(E),this.pendingLookups.delete(d),x(null)})})}catch{return null}finally{r--}}),f=await Promise.all(c),h=!1;for(let l of f)l&&l.nodes&&o(l.nodes)&&(h=!0);if(s.sort((l,d)=>l.distance<d.distance?-1:1),s.length>this.k&&(s=s.slice(0,this.k)),!h&&r===0)break}return s.map(i=>i.peer)}async findValue(t){let n=Math.random().toString(36).substring(7);if(this.storage.has(t))return this.storage.get(t);let s=this.routingTable.findClosestPeers(t,this.k).map(a=>({peer:a,distance:Nt(t,a.id),queried:!1}));if(s.length===0)return null;let r=0,o=null,i=a=>{if(a.value)return o=a.value,!0;if(a.nodes){for(let c of a.nodes)if(!i.seen.has(c.id)&&c.id!==this.routingTable.localNodeId){let f={id:c.id,publicKey:new Uint8Array(c.publicKey),lastSeen:Date.now(),connectedAt:0,transportType:c.transportType,connectionQuality:0,bytesSent:0,bytesReceived:0,state:"disconnected",metadata:{capabilities:{supportedTransports:[],protocolVersion:1,features:[]},reputation:50,blacklisted:!1,failureCount:0,successCount:0}};s.push({peer:f,distance:Nt(t,f.id),queried:!1}),i.seen.add(c.id)}}return!1};i.seen=new Set(s.map(a=>a.peer.id));for(let a=0;a<10&&!o;a++){s.sort((l,d)=>l.distance<d.distance?-1:1);let c=s.filter(l=>!l.queried).slice(0,this.alpha);if(c.length===0&&r===0)break;let f=c.map(async l=>{l.queried=!0,r++;try{let d=`${n}-${l.peer.id}`,b=new TextEncoder().encode(JSON.stringify({key:t,requestId:d}));return await new Promise(E=>{let u=setTimeout(()=>{this.pendingLookups.delete(d),E(null)},this.lookupTimeout);this.pendingLookups.set(d,{resolve:D=>{clearTimeout(u),this.pendingLookups.delete(d),E(D)},reject:()=>{}}),this.sendRequest(l.peer.id,M.DHT_FIND_VALUE,b).catch(()=>{clearTimeout(u),this.pendingLookups.delete(d),E(null)})})}catch{return null}finally{r--}}),h=await Promise.all(f);for(let l of h)if(l&&i(l))break}return o}async store(t,n){let s=await this.findNode(t),r=new TextEncoder().encode(JSON.stringify({key:t,value:Array.from(n)})),o=s.map(i=>this.sendRequest(i.id,M.DHT_STORE,r));await Promise.allSettled(o),this.storage.set(t,n)}};var _e=class{constructor(){this.providers=new Map,this.discoveredPeers=new Map,this.isRunning=!1}registerProvider(t){this.providers.set(t.name,t),t.onPeerFound(n=>{this.handlePeerFound(n)}),this.isRunning&&t.start().catch(n=>{console.error(`Failed to start provider ${t.name}:`,n)})}async start(){if(this.isRunning)return;this.isRunning=!0;let t=Array.from(this.providers.values()).map(async n=>{try{await n.start()}catch(s){console.error(`Error starting discovery provider ${n.name}:`,s)}});await Promise.all(t)}async stop(){if(!this.isRunning)return;this.isRunning=!1;let t=Array.from(this.providers.values()).map(n=>n.stop());await Promise.all(t)}handlePeerFound(t){this.discoveredPeers.set(t.id,t),this.onPeerDiscoveredCallback&&this.onPeerDiscoveredCallback(t)}reportDiscovery(t){this.handlePeerFound(t)}onPeerDiscovered(t){this.onPeerDiscoveredCallback=t}getDiscoveredPeers(){return Array.from(this.discoveredPeers.values())}clear(){this.discoveredPeers.clear()}};var Oe=class{constructor(t={}){this.messageListeners=new Set,this.discoveredPeers=new Set,this.peerMonitors=new Map,this.messagesSent=0,this.messagesReceived=0,this.bytesTransferred=0,this.peerFailureCounts=new Map,this.identity=t.identity||Te(),this.localPeerId=t.peerId||Ys(this.identity.publicKey),this.defaultTTL=t.defaultTTL||10,this.maxPeers=t.maxPeers||50,this.routingTable=new zt(this.localPeerId),this.messageRelay=new Gt(this.localPeerId,this.routingTable,{},t.persistence),this.peerPool=new Ae,this.dht=new ve(this.routingTable,async(n,s,r)=>{let o={header:{version:1,type:s,ttl:this.defaultTTL,timestamp:Date.now(),senderId:this.identity.publicKey,signature:new Uint8Array(64)},payload:r},i=z(o);o.header.signature=dt(i,this.identity.privateKey);let a=z(o),c=this.peerPool.getPeer(n);c&&c.getState()==="connected"?c.send(a):this.outboundTransportCallback&&await this.outboundTransportCallback(n,a)}),this.discovery=new _e,this.discovery.onPeerDiscovered(this.handleDiscoveredPeer.bind(this)),this.setupMessageHandlers()}setupMessageHandlers(){this.messageRelay.onMessageForSelf(t=>{this.messagesReceived++,this.bytesTransferred+=t.payload.byteLength;let n=Array.from(t.header.senderId).map(s=>s.toString(16).padStart(2,"0")).join("");if(t.header.type===M.CONTROL_PING){this.sendPong(t.header.senderId,t.header.timestamp);return}if(t.header.type===M.DHT_FIND_NODE||t.header.type===M.DHT_FOUND_NODES||t.header.type===M.DHT_FIND_VALUE||t.header.type===M.DHT_STORE){this.dht.handleMessage(t);return}if(t.header.type===M.CONTROL_PONG){try{let s=new TextDecoder().decode(t.payload),r=JSON.parse(s);if(r.pingTimestamp){let o=Date.now()-r.pingTimestamp,i=this.peerMonitors.get(n);i&&(i.updateLatency(o),this.routingTable.updatePeerLastSeen(n))}}catch{}return}this.messageListeners.forEach(s=>{try{s(t)}catch(r){console.error("Error in message listener:",r)}})}),this.messageRelay.onForwardMessage((t,n)=>{let s=z(t);this.messagesSent++,this.bytesTransferred+=s.byteLength,this.peerPool.broadcast(s,n),this.outboundTransportCallback&&this.routingTable.getAllPeers().forEach(r=>{r.id!==n&&r.id!==this.localPeerId&&(this.peerPool.getPeer(r.id)||this.outboundTransportCallback(r.id,s))})}),this.peerPool.onMessage((t,n)=>{this.messageRelay.processMessage(n,t);let s=this.peerMonitors.get(t);s&&s.updateBandwidth(n.length,1e3)}),this.peerPool.onSignal((t,n)=>{this.sendMessage(t,JSON.stringify({type:"SIGNAL",signal:n})).catch(s=>console.error("Failed to send signal:",s))}),this.peerPool.onTrack((t,n,s)=>{this.onPeerTrackCallback?.(t,n,s)})}startHeartbeat(t=3e4){this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.heartbeatInterval=setInterval(()=>{this.broadcastPing()},t),this.healthCheckInterval&&clearInterval(this.healthCheckInterval),this.healthCheckInterval=setInterval(()=>{this.monitorConnectionHealth()},5e3)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=void 0),this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=void 0)}async broadcastPing(){let t={header:{version:1,type:M.CONTROL_PING,ttl:1,timestamp:Date.now(),senderId:this.identity.publicKey,signature:new Uint8Array(64)},payload:new Uint8Array(0)},n=z(t);t.header.signature=dt(n,this.identity.privateKey);let s=z(t);this.peerPool.broadcast(s)}async sendPong(t,n){let s=Array.from(t).map(f=>f.toString(16).padStart(2,"0")).join(""),r=new TextEncoder().encode(JSON.stringify({pingTimestamp:n})),o={header:{version:1,type:M.CONTROL_PONG,ttl:1,timestamp:Date.now(),senderId:this.identity.publicKey,signature:new Uint8Array(64)},payload:r},i=z(o);o.header.signature=dt(i,this.identity.privateKey);let a=z(o),c=this.peerPool.getPeer(s);c&&c.getState()==="connected"&&c.send(a)}monitorConnectionHealth(){this.peerMonitors.forEach((t,n)=>{let s=t.getQuality(),r=this.routingTable.getPeer(n);if(!r){this.peerMonitors.delete(n),this.peerFailureCounts.delete(n);return}let o=Date.now()-r.lastSeen;if(o>3e4?s="offline":o>1e4&&s!=="offline"&&(s="poor"),s==="poor"&&r.state===W.CONNECTED)console.warn(`Connection to peer ${n} is poor (Last seen: ${o}ms ago). Marking as degraded.`),r.state=W.DEGRADED;else if((s==="good"||s==="excellent")&&r.state===W.DEGRADED)console.log(`Connection to peer ${n} recovered.`),r.state=W.CONNECTED,this.peerFailureCounts.set(n,0);else if(s==="offline"){let i=(this.peerFailureCounts.get(n)||0)+1;this.peerFailureCounts.set(n,i),console.warn(`Peer ${n} is offline (Last seen: ${o}ms ago, Check ${i}/6)`),i>=6&&(console.error(`Peer ${n} has been offline for too long. Disconnecting to trigger reconnection.`),this.disconnectFromPeer(n).catch(a=>console.error(`Error disconnecting peer ${n}:`,a)),this.peerFailureCounts.delete(n))}else this.peerFailureCounts.set(n,0)})}async connectToPeer(t){if(this.routingTable.getAllPeers().length>=this.maxPeers)throw new Error("Maximum number of peers reached");let n=this.peerPool.getOrCreatePeer(t);n.createDataChannel({label:"reliable",ordered:!0}),n.createDataChannel({label:"unreliable",ordered:!1,maxRetransmits:0});let s=await n.createOffer();console.log(`Sending offer to ${t} via Mesh Signaling`),this.sendMessage(t,JSON.stringify({type:"SIGNAL",signal:{type:"offer",sdp:s}})).catch(r=>console.error("Failed to send offer:",r)),n.onStateChange(r=>{r==="connected"?this.handlePeerConnected(t):(r==="disconnected"||r==="failed"||r==="closed")&&this.handlePeerDisconnected(t)})}handlePeerConnected(t){let n=De(t,new Uint8Array(32),"webrtc");this.routingTable.addPeer(n),this.peerMonitors.set(t,new Be),this.onPeerConnectedCallback?.(t),this.sendPeerAnnouncement()}handlePeerDisconnected(t){this.routingTable.removePeer(t),this.peerMonitors.delete(t),this.onPeerDisconnectedCallback?.(t)}async sendMessage(t,n){let s=new TextEncoder().encode(JSON.stringify({text:n,timestamp:Date.now(),recipient:t})),r={header:{version:1,type:M.TEXT,ttl:this.defaultTTL,timestamp:Date.now(),senderId:this.identity.publicKey,signature:new Uint8Array(64)},payload:s},o=z(r);r.header.signature=dt(o,this.identity.privateKey);let i=z(r),a=this.routingTable.getNextHop(t);if(a){let c=this.peerPool.getPeer(a);c&&c.getState()==="connected"?c.send(i):this.outboundTransportCallback&&this.outboundTransportCallback(a,i).catch(f=>console.error(`Failed to send via external transport to ${a}:`,f))}else this.peerPool.broadcast(i),this.outboundTransportCallback&&this.routingTable.getAllPeers().forEach(c=>{c.id!==this.localPeerId&&!this.peerPool.getPeer(c.id)&&this.outboundTransportCallback(c.id,i)})}sendPeerAnnouncement(){let t=new TextEncoder().encode(JSON.stringify({publicKey:Array.from(this.identity.publicKey).map(o=>o.toString(16).padStart(2,"0")).join(""),endpoints:[{type:"webrtc",signaling:this.localPeerId}],capabilities:{supportedTransports:["webrtc"],protocolVersion:1},timestamp:Date.now()})),n={header:{version:1,type:M.PEER_DISCOVERY,ttl:this.defaultTTL,timestamp:Date.now(),senderId:this.identity.publicKey,signature:new Uint8Array(64)},payload:t},s=z(n);n.header.signature=dt(s,this.identity.privateKey);let r=z(n);this.peerPool.broadcast(r)}onMessage(t){this.messageListeners.add(t)}offMessage(t){this.messageListeners.delete(t)}registerDiscoveryProvider(t){this.discovery.registerProvider(t)}async handleDiscoveredPeer(t){if(this.routingTable.getPeer(t.id)){this.routingTable.updatePeerLastSeen(t.id);return}if(this.routingTable.getAllPeers().length<this.maxPeers){console.log(`Discovered new peer ${t.id} via ${t.source}. Attempting connection...`);try{t.transportType==="ble"?console.log(`[MeshNetwork] BLE peer discovered. Native bridge required to connect to ${t.id}`):await this.connectToPeer(t.id)}catch(n){console.error(`Failed to connect to discovered peer ${t.id}:`,n)}}}onPeerConnected(t){this.onPeerConnectedCallback=t}onPeerDisconnected(t){this.onPeerDisconnectedCallback=t}onPeerTrack(t){this.onPeerTrackCallback=t}onDiscoveryUpdate(t){this.onDiscoveryUpdateCallback=t}async addStreamToPeer(t,n){let s=this.peerPool.getPeer(t);if(!s)throw new Error(`Peer ${t} not found`);if(n.getTracks().forEach(r=>{s.addTrack(r,n)}),s.getState()==="connected"){let r=await s.createOffer();await this.sendMessage(t,JSON.stringify({type:"SIGNAL",signal:{type:"offer",sdp:r}}))}}getConnectedPeers(){return this.routingTable.getAllPeers()}getPeer(t){return this.routingTable.getPeer(t)}async getStats(){return{localPeerId:this.localPeerId,routing:this.routingTable.getStats(),relay:this.messageRelay.getStats(),peers:await this.peerPool.getStats()}}shutdown(){this.peerPool.closeAll(),this.routingTable.getAllPeers().forEach(t=>{this.routingTable.removePeer(t.id)}),this.stopHeartbeat()}getIdentity(){return this.identity}getLocalPeerId(){return this.localPeerId}getPublicKey(){return this.identity.publicKey}getPeerCount(){return this.routingTable.getAllPeers().length}async sendTextMessage(t,n){return this.sendMessage(t,n)}async sendBinaryMessage(t,n){let s={header:{version:1,type:M.FILE_CHUNK,ttl:this.defaultTTL,timestamp:Date.now(),senderId:this.identity.publicKey,signature:new Uint8Array(65)},payload:n},r=z(s);s.header.signature=dt(r,this.identity.privateKey);let o=z(s),i=this.routingTable.getNextHop(t);if(i){let a=this.peerPool.getPeer(i);a&&a.getState()==="connected"&&a.send(o)}else this.peerPool.broadcast(o)}async broadcastMessage(t){let n=new TextEncoder().encode(t),s={header:{version:1,type:M.TEXT,ttl:this.defaultTTL,timestamp:Date.now(),senderId:this.identity.publicKey,signature:new Uint8Array(65)},payload:n},r=z(s);s.header.signature=dt(r,this.identity.privateKey);let o=z(s);this.peerPool.broadcast(o)}async disconnectFromPeer(t){let n=this.peerPool.getPeer(t);n&&n.close(),this.routingTable.removePeer(t)}async disconnectAll(){this.shutdown()}isConnectedToPeer(t){return this.routingTable.getPeer(t)!==null}getStatistics(){return{peerCount:this.getPeerCount(),messagesSent:this.messagesSent,messagesReceived:this.messagesReceived,bytesTransferred:this.bytesTransferred}}async start(){}async stop(){this.shutdown()}async createManualConnection(t){if(this.routingTable.getAllPeers().length>=this.maxPeers)throw new Error("Maximum number of peers reached");let n=this.peerPool.getOrCreatePeer(t);n.createDataChannel({label:"reliable",ordered:!0}),n.createDataChannel({label:"unreliable",ordered:!1,maxRetransmits:0}),await n.createOffer(),n.onStateChange(r=>{r==="connected"?this.handlePeerConnected(t):(r==="disconnected"||r==="failed"||r==="closed")&&this.handlePeerDisconnected(t)}),await n.waitForIceGathering();let s=await n.getLocalDescription();return JSON.stringify({type:"offer",peerId:this.localPeerId,sdp:s})}registerOutboundTransport(t){this.outboundTransportCallback=t}async handleIncomingPacket(t,n){await this.messageRelay.processMessage(n,t),this.routingTable.getPeer(t)}async acceptManualConnection(t){let n=JSON.parse(t),{peerId:s,sdp:r}=n;if(!s||!r||r.type!=="offer")throw new Error("Invalid manual offer data");let o=this.peerPool.getOrCreatePeer(s);await o.createAnswer(r),o.onStateChange(a=>{a==="connected"?this.handlePeerConnected(s):(a==="disconnected"||a==="failed"||a==="closed")&&this.handlePeerDisconnected(s)}),await o.waitForIceGathering();let i=await o.getLocalDescription();return JSON.stringify({type:"answer",peerId:this.localPeerId,sdp:i})}async finalizeManualConnection(t){let n=JSON.parse(t),{peerId:s,sdp:r}=n;if(!s||!r||r.type!=="answer")throw new Error("Invalid manual answer data");let o=this.peerPool.getPeer(s);if(!o)throw new Error(`Peer ${s} not found (connection not initiated?)`);await o.setRemoteAnswer(r)}async dhtStore(t,n){await this.dht.store(t,n)}async dhtFindValue(t){return this.dht.findValue(t)}async dhtFindNode(t){return(await this.dht.findNode(t)).find(s=>s.id===t)}};_t();mt();var bn=1,nr=new TextEncoder().encode("SC-Envelope-v1");function sr(e,t,n){if(t.length!==32)throw new Error("Sender private key must be 32 bytes");if(n.length!==32)throw new Error("Recipient public key must be 32 bytes");let s=ft(32),r=Kt.getPublicKey(s),o=Kt.getSharedSecret(s,n),i=Qt(Q,o,r,nr,32),a=ft(24),f=Vt(i,a).encrypt(e),h=Date.now(),l=new Uint8Array([...r,...a,...f,...Dt(h),bn]),d=rt.sign(l,t);return s.fill(0),o.fill(0),i.fill(0),{ephemeralPublicKey:r,nonce:a,ciphertext:f,signature:d,timestamp:h,version:bn}}function rr(e,t,n){if(t.length!==32)throw new Error("Recipient private key must be 32 bytes");if(n.length!==32)throw new Error("Sender public key must be 32 bytes");if(e.version!==bn)throw new Error(`Unsupported envelope version: ${e.version}`);let s=new Uint8Array([...e.ephemeralPublicKey,...e.nonce,...e.ciphertext,...Dt(e.timestamp),e.version]);if(!rt.verify(e.signature,s,n))throw new Error("Envelope signature verification failed");let o=Kt.getSharedSecret(t,e.ephemeralPublicKey),i=Qt(Q,o,e.ephemeralPublicKey,nr,32);try{let c=Vt(i,e.nonce).decrypt(e.ciphertext);return o.fill(0),i.fill(0),c}catch{throw o.fill(0),i.fill(0),new Error("Envelope decryption failed: authentication tag mismatch")}}function or(e,t){if(t.length!==32)throw new Error("Private key must be 32 bytes");let n=rt.getPublicKey(t),s=Date.now(),r=new Uint8Array([...e,...Dt(s)]),o=rt.sign(r,t);return{data:e,signature:o,senderPublicKey:n,timestamp:s}}function ir(e,t){if(t){if(e.senderPublicKey.length!==t.length)return!1;for(let s=0;s<t.length;s++)if(e.senderPublicKey[s]!==t[s])return!1}let n=new Uint8Array([...e.data,...Dt(e.timestamp)]);try{return rt.verify(e.signature,n,e.senderPublicKey)}catch{return!1}}function ar(e){let t=Dt(e.timestamp),n=Dt(e.ciphertext.length);return new Uint8Array([e.version,...e.ephemeralPublicKey,...e.nonce,...n,...e.ciphertext,...e.signature,...t])}function cr(e){if(e.length<137)throw new Error("Invalid envelope: too short");let t=0,n=e[t++],s=e.slice(t,t+32);t+=32;let r=e.slice(t,t+24);t+=24;let o=Le(e.slice(t,t+8));t+=8;let i=e.slice(t,t+o);t+=o;let a=e.slice(t,t+64);t+=64;let c=Le(e.slice(t,t+8));return{version:n,ephemeralPublicKey:s,nonce:r,ciphertext:i,signature:a,timestamp:c}}function lr(e){let t=Dt(e.timestamp),n=Dt(e.data.length);return new Uint8Array([...e.senderPublicKey,...n,...e.data,...e.signature,...t])}function fr(e){if(e.length<112)throw new Error("Invalid envelope: too short");let t=0,n=e.slice(t,t+32);t+=32;let s=Le(e.slice(t,t+8));t+=8;let r=e.slice(t,t+s);t+=s;let o=e.slice(t,t+64);t+=64;let i=Le(e.slice(t,t+8));return{senderPublicKey:n,data:r,signature:o,timestamp:i}}function Dt(e){let t=new Uint8Array(8),n=e;for(let s=7;s>=0;s--)t[s]=n&255,n=Math.floor(n/256);return t}function Le(e){let t=0;for(let n=0;n<8;n++)t=t*256+e[n];return t}var se=class{constructor(){this.factories=new Map}register(t,n){this.factories.set(t,n)}get(t){return this.factories.get(t)}getTypes(){return Array.from(this.factories.keys())}},Nc=new se;var No="0.1.0",Do=!0;return br(Ao);})();
/*! Bundled license information:

@noble/hashes/utils.js:
  (*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/curves/utils.js:
@noble/curves/abstract/modular.js:
@noble/curves/abstract/curve.js:
@noble/curves/abstract/edwards.js:
@noble/curves/abstract/montgomery.js:
@noble/curves/ed25519.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)

@noble/ciphers/utils.js:
  (*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) *)
*/
//# sourceMappingURL=sc-core.bundle.js.map
